"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[32],{13464:(x,O,Q)=>{Q.r(O),Q.d(O,{_KTXTextureLoader:()=>N});var X=Q(10905);class Z{constructor(x,O){if(this.data=x,this.isInvalid=!1,!Z.IsValid(x))return this.isInvalid=!0,void X.e.Error("texture missing KTX identifier");const Q=Uint32Array.BYTES_PER_ELEMENT,n=new DataView(this.data.buffer,this.data.byteOffset+12,13*Q),V=67305985===n.getUint32(0,!0);return this.glType=n.getUint32(1*Q,V),this.glTypeSize=n.getUint32(2*Q,V),this.glFormat=n.getUint32(3*Q,V),this.glInternalFormat=n.getUint32(4*Q,V),this.glBaseInternalFormat=n.getUint32(5*Q,V),this.pixelWidth=n.getUint32(6*Q,V),this.pixelHeight=n.getUint32(7*Q,V),this.pixelDepth=n.getUint32(8*Q,V),this.numberOfArrayElements=n.getUint32(9*Q,V),this.numberOfFaces=n.getUint32(10*Q,V),this.numberOfMipmapLevels=n.getUint32(11*Q,V),this.bytesOfKeyValueData=n.getUint32(12*Q,V),0!==this.glType?(X.e.Error("only compressed formats currently supported"),void(this.isInvalid=!0)):(this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels),0===this.pixelHeight||0!==this.pixelDepth?(X.e.Error("only 2D textures currently supported"),void(this.isInvalid=!0)):0!==this.numberOfArrayElements?(X.e.Error("texture arrays not currently supported"),void(this.isInvalid=!0)):this.numberOfFaces!==O?(X.e.Error("number of faces expected"+O+", but found "+this.numberOfFaces),void(this.isInvalid=!0)):void(this.loadType=Z.COMPRESSED_2D))}uploadLevels(x,O){switch(this.loadType){case Z.COMPRESSED_2D:this._upload2DCompressedLevels(x,O);case Z.TEX_2D:case Z.COMPRESSED_3D:case Z.TEX_3D:}}_upload2DCompressedLevels(x,O){let Q=Z.HEADER_LEN+this.bytesOfKeyValueData,X=this.pixelWidth,n=this.pixelHeight;const V=O?this.numberOfMipmapLevels:1;for(let Z=0;Z<V;Z++){const O=new Int32Array(this.data.buffer,this.data.byteOffset+Q,1)[0];Q+=4;for(let V=0;V<this.numberOfFaces;V++){const o=new Uint8Array(this.data.buffer,this.data.byteOffset+Q,O);x.getEngine()._uploadCompressedDataToTextureDirectly(x,x.format,X,n,o,V,Z),Q+=O,Q+=3-(O+3)%4}X=Math.max(1,.5*X),n=Math.max(1,.5*n)}}static IsValid(x){if(x.byteLength>=12){const O=new Uint8Array(x.buffer,x.byteOffset,12);if(171===O[0]&&75===O[1]&&84===O[2]&&88===O[3]&&32===O[4]&&49===O[5]&&49===O[6]&&187===O[7]&&13===O[8]&&10===O[9]&&26===O[10]&&10===O[11])return!0}return!1}}Z.HEADER_LEN=64,Z.COMPRESSED_2D=0,Z.COMPRESSED_3D=1,Z.TEX_2D=2,Z.TEX_3D=3;var n,V,o,l=Q(11605),C=Q(10894);function U(x,O){const Q=(null===O||void 0===O?void 0:O.jsDecoderModule)||KTX2DECODER;x&&(x.wasmUASTCToASTC&&(Q.LiteTranscoder_UASTC_ASTC.WasmModuleURL=x.wasmUASTCToASTC),x.wasmUASTCToBC7&&(Q.LiteTranscoder_UASTC_BC7.WasmModuleURL=x.wasmUASTCToBC7),x.wasmUASTCToRGBA_UNORM&&(Q.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=x.wasmUASTCToRGBA_UNORM),x.wasmUASTCToRGBA_SRGB&&(Q.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=x.wasmUASTCToRGBA_SRGB),x.wasmUASTCToR8_UNORM&&(Q.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=x.wasmUASTCToR8_UNORM),x.wasmUASTCToRG8_UNORM&&(Q.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=x.wasmUASTCToRG8_UNORM),x.jsMSCTranscoder&&(Q.MSCTranscoder.JSModuleURL=x.jsMSCTranscoder),x.wasmMSCTranscoder&&(Q.MSCTranscoder.WasmModuleURL=x.wasmMSCTranscoder),x.wasmZSTDDecoder&&(Q.ZSTDDecoder.WasmModuleURL=x.wasmZSTDDecoder)),O&&(O.wasmUASTCToASTC&&(Q.LiteTranscoder_UASTC_ASTC.WasmBinary=O.wasmUASTCToASTC),O.wasmUASTCToBC7&&(Q.LiteTranscoder_UASTC_BC7.WasmBinary=O.wasmUASTCToBC7),O.wasmUASTCToRGBA_UNORM&&(Q.LiteTranscoder_UASTC_RGBA_UNORM.WasmBinary=O.wasmUASTCToRGBA_UNORM),O.wasmUASTCToRGBA_SRGB&&(Q.LiteTranscoder_UASTC_RGBA_SRGB.WasmBinary=O.wasmUASTCToRGBA_SRGB),O.wasmUASTCToR8_UNORM&&(Q.LiteTranscoder_UASTC_R8_UNORM.WasmBinary=O.wasmUASTCToR8_UNORM),O.wasmUASTCToRG8_UNORM&&(Q.LiteTranscoder_UASTC_RG8_UNORM.WasmBinary=O.wasmUASTCToRG8_UNORM),O.jsMSCTranscoder&&(Q.MSCTranscoder.JSModule=O.jsMSCTranscoder),O.wasmMSCTranscoder&&(Q.MSCTranscoder.WasmBinary=O.wasmMSCTranscoder),O.wasmZSTDDecoder&&(Q.ZSTDDecoder.WasmBinary=O.wasmZSTDDecoder))}function L(x){let O;"undefined"===typeof x&&"undefined"!==typeof KTX2DECODER&&(x=KTX2DECODER),onmessage=Q=>{if(Q.data)switch(Q.data.action){case"init":{const X=Q.data.urls;X&&(X.jsDecoderModule&&"undefined"===typeof x&&(importScripts(X.jsDecoderModule),x=KTX2DECODER),U(X)),Q.data.wasmBinaries&&U(void 0,{...Q.data.wasmBinaries,jsDecoderModule:x}),O=new x.KTX2Decoder,postMessage({action:"init"});break}case"setDefaultDecoderOptions":x.KTX2Decoder.DefaultDecoderOptions=Q.data.options;break;case"decode":O.decode(Q.data.data,Q.data.caps,Q.data.options).then((x=>{const O=[];for(let Q=0;Q<x.mipmaps.length;++Q){const X=x.mipmaps[Q];X&&X.data&&O.push(X.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:x},O)})).catch((x=>{postMessage({action:"decoded",success:!1,aO:x})}))}}}!function(x){x[x.ETC1S=0]="ETC1S",x[x.UASTC4x4=1]="UASTC4x4"}(n||(n={})),function(x){x[x.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",x[x.BC7_RGBA=1]="BC7_RGBA",x[x.BC3_RGBA=2]="BC3_RGBA",x[x.BC1_RGB=3]="BC1_RGB",x[x.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",x[x.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",x[x.ETC2_RGBA=6]="ETC2_RGBA",x[x.ETC1_RGB=7]="ETC1_RGB",x[x.RGBA32=8]="RGBA32",x[x.R8=9]="R8",x[x.RG8=10]="RG8"}(V||(V={})),function(x){x[x.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",x[x.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",x[x.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",x[x.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",x[x.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",x[x.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",x[x.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",x[x.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",x[x.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",x[x.RGBA8Format=32856]="RGBA8Format",x[x.R8Format=33321]="R8Format",x[x.RG8Format=33323]="RG8Format"}(o||(o={}));class h{static GetDefaultNumWorkers(){return"object"===typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static _Initialize(x){if(h._WorkerPoolPromise||h._DecoderModulePromise)return;const O={jsDecoderModule:C.g.GetBabylonScriptURL(this.URLConfig.jsDecoderModule,!0),wasmUASTCToASTC:C.g.GetBabylonScriptURL(this.URLConfig.wasmUASTCToASTC,!0),wasmUASTCToBC7:C.g.GetBabylonScriptURL(this.URLConfig.wasmUASTCToBC7,!0),wasmUASTCToRGBA_UNORM:C.g.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_UNORM,!0),wasmUASTCToRGBA_SRGB:C.g.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_SRGB,!0),wasmUASTCToR8_UNORM:C.g.GetBabylonScriptURL(this.URLConfig.wasmUASTCToR8_UNORM,!0),wasmUASTCToRG8_UNORM:C.g.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRG8_UNORM,!0),jsMSCTranscoder:C.g.GetBabylonScriptURL(this.URLConfig.jsMSCTranscoder,!0),wasmMSCTranscoder:C.g.GetBabylonScriptURL(this.URLConfig.wasmMSCTranscoder,!0),wasmZSTDDecoder:C.g.GetBabylonScriptURL(this.URLConfig.wasmZSTDDecoder,!0)};x&&"function"===typeof Worker&&"undefined"!==typeof URL?h._WorkerPoolPromise=new Promise((Q=>{const X=`${U}(${L})()`,Z=URL.createObjectURL(new Blob([X],{type:"application/javascript"}));Q(new l.e(x,(async()=>await async function(x,O,Q){return await new Promise(((X,Z)=>{const n=O=>{x.removeEventListener("error",n),x.removeEventListener("message",V),Z(O)},V=O=>{"init"===O.data.action&&(x.removeEventListener("error",n),x.removeEventListener("message",V),X(x))};x.addEventListener("error",n),x.addEventListener("message",V),x.postMessage({action:"init",urls:Q,wasmBinaries:O})}))}(new Worker(Z),void 0,O))))})):"undefined"===typeof h._KTX2DecoderModule?h._DecoderModulePromise=C.g.LoadBabylonScriptAsync(O.jsDecoderModule).then((()=>(h._KTX2DecoderModule=KTX2DECODER,h._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,h._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,U(O,h._KTX2DecoderModule),new h._KTX2DecoderModule.KTX2Decoder))):(h._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,h._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,h._DecoderModulePromise=Promise.resolve(new h._KTX2DecoderModule.KTX2Decoder))}constructor(x){let O=arguments.length>1&&void 0!==arguments[1]?arguments[1]:h.DefaultNumWorkers;this._engine=x;const Q="object"===typeof O&&O.workerPool||h.WorkerPool;if(Q)h._WorkerPoolPromise=Promise.resolve(Q);else{var X;if("object"===typeof O)h._KTX2DecoderModule=null===O||void 0===O||null===(X=O.binariesAndModulesContainer)||void 0===X?void 0:X.jsDecoderModule;else"undefined"!==typeof KTX2DECODER&&(h._KTX2DecoderModule=KTX2DECODER);const x="number"===typeof O?O:O.numWorkers??h.DefaultNumWorkers;h._Initialize(x)}}async _uploadAsync(x,O,Q){const X=this._engine.getCaps(),Z={astc:!!X.astc,bptc:!!X.bptc,s3tc:!!X.s3tc,pvrtc:!!X.pvrtc,etc2:!!X.etc2,etc1:!!X.etc1};if(h._WorkerPoolPromise){const X=await h._WorkerPoolPromise;return await new Promise(((n,V)=>{X.push(((X,o)=>{const l=x=>{X.removeEventListener("error",l),X.removeEventListener("message",C),V(x),o()},C=x=>{if("decoded"===x.data.action){if(X.removeEventListener("error",l),X.removeEventListener("message",C),x.data.success)try{this._createTexture(x.data.decodedData,O,Q),n()}catch(Z){V({message:Z})}else V({message:x.data.aO});o()}};X.addEventListener("error",l),X.addEventListener("message",C),X.postMessage({action:"setDefaultDecoderOptions",options:h.DefaultDecoderOptions._getKTX2DecoderOptions()});const U=new Uint8Array(x.byteLength);U.set(new Uint8Array(x.buffer,x.byteOffset,x.byteLength)),X.postMessage({action:"decode",data:U,caps:Z,options:Q},[U.buffer])}))}))}if(h._DecoderModulePromise){const Q=await h._DecoderModulePromise;return h.DefaultDecoderOptions.isDirty&&(h._KTX2DecoderModule.KTX2Decoder.DefaultDecoderOptions=h.DefaultDecoderOptions._getKTX2DecoderOptions()),await new Promise(((Z,n)=>{Q.decode(x,X).then((x=>{this._createTexture(x,O),Z()})).catch((x=>{n({message:x})}))}))}throw new Error("KTX2 decoder module is not available")}_createTexture(x,O,Q){this._engine._bindTextureDirectly(3553,O),Q&&(Q.transcodedFormat=x.transcodedFormat,Q.isInGammaSpace=x.isInGammaSpace,Q.wV=x.wV,Q.transcoderName=x.transcoderName);let X=!0;switch(x.transcodedFormat){case 32856:O.type=0,O.format=5;break;case 33321:O.type=0,O.format=6;break;case 33323:O.type=0,O.format=7;break;default:O.format=x.transcodedFormat,X=!1}if(O._gammaSpace=x.isInGammaSpace,O.generateMipMaps=x.mipmaps.length>1,x.errors)throw new Error("KTX2 container - could not transcode the data. "+x.errors);for(let Z=0;Z<x.mipmaps.length;++Z){const Q=x.mipmaps[Z];if(!Q||!Q.data)throw new Error("KTX2 container - could not transcode one of the image");X?(O.width=Q.width,O.height=Q.height,this._engine._uploadDataToTextureDirectly(O,Q.data,0,Z,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(O,x.transcodedFormat,Q.width,Q.height,Q.data,0,Z)}O._extension=".ktx2",O.width=x.mipmaps[0].width,O.height=x.mipmaps[0].height,O.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static IsValid(x){if(x.byteLength>=12){const O=new Uint8Array(x.buffer,x.byteOffset,12);if(171===O[0]&&75===O[1]&&84===O[2]&&88===O[3]&&32===O[4]&&50===O[5]&&48===O[6]&&187===O[7]&&13===O[8]&&10===O[9]&&26===O[10]&&10===O[11])return!0}return!1}}h.URLConfig={jsDecoderModule:"https://cdn.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null},h.DefaultNumWorkers=h.GetDefaultNumWorkers(),h.DefaultDecoderOptions=new class{constructor(){this._isDirty=!0,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=!0,this._ktx2DecoderOptions={}}get isDirty(){return this._isDirty}get useRGBAIfASTCBC7NotAvailableWhenUASTC(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set useRGBAIfASTCBC7NotAvailableWhenUASTC(x){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==x&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=x,this._isDirty=!0)}get useRGBAIfOnlyBC1BC3AvailableWhenUASTC(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set useRGBAIfOnlyBC1BC3AvailableWhenUASTC(x){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==x&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=x,this._isDirty=!0)}get forceRGBA(){return this._forceRGBA}set forceRGBA(x){this._forceRGBA!==x&&(this._forceRGBA=x,this._isDirty=!0)}get forceR8(){return this._forceR8}set forceR8(x){this._forceR8!==x&&(this._forceR8=x,this._isDirty=!0)}get forceRG8(){return this._forceRG8}set forceRG8(x){this._forceRG8!==x&&(this._forceRG8=x,this._isDirty=!0)}get bypassTranscoders(){return this._bypassTranscoders}set bypassTranscoders(x){this._bypassTranscoders!==x&&(this._bypassTranscoders=x,this._isDirty=!0)}_getKTX2DecoderOptions(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=!1;const x={useRGBAIfASTCBC7NotAvailableWhenUASTC:this._useRGBAIfASTCBC7NotAvailableWhenUASTC,forceRGBA:this._forceRGBA,forceR8:this._forceR8,forceRG8:this._forceRG8,bypassTranscoders:this._bypassTranscoders};return this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(x.transcodeFormatDecisionTree={UASTC:{transcodeFormat:[V.BC1_RGB,V.BC3_RGBA],yes:{transcodeFormat:V.RGBA32,engineFormat:32856,roundToMultiple4:!1}}}),this._ktx2DecoderOptions=x,x}};class N{constructor(){this.supportCascades=!1}loadCubeData(x,O,Q,X){if(Array.isArray(x))return;O._invertVScale=!O.invertY;const n=O.getEngine(),V=new Z(x,6),o=V.numberOfMipmapLevels>1&&O.generateMipMaps;n._unpackFlipY(!0),V.uploadLevels(O,O.generateMipMaps),O.width=V.pixelWidth,O.height=V.pixelHeight,n._setCubeMapTextureParams(O,o,V.numberOfMipmapLevels-1),O.isReady=!0,O.onLoadedObservable.notifyObservers(O),O.onLoadedObservable.clear(),X&&X()}loadData(x,O,Q,n){if(Z.IsValid(x)){O._invertVScale=!O.invertY;const X=new Z(x,1),n=function(x){switch(x){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}(X.glInternalFormat);n?(O.format=n,O._useSRGBBuffer=O.getEngine()._getUseSRGBBuffer(!0,O.generateMipMaps),O._gammaSpace=!0):O.format=X.glInternalFormat,Q(X.pixelWidth,X.pixelHeight,O.generateMipMaps,!0,(()=>{X.uploadLevels(O,O.generateMipMaps)}),X.isInvalid)}else if(h.IsValid(x)){new h(O.getEngine())._uploadAsync(x,O,n).then((()=>{Q(O.width,O.height,O.generateMipMaps,!0,(()=>{}),!1)}),(x=>{X.e.Warn(`Failed to load KTX2 texture data: ${x.message}`),Q(0,0,!1,!1,(()=>{}),!0)}))}else X.e.Error("texture missing KTX identifier"),Q(0,0,!1,!1,(()=>{}),!0)}}}}]);