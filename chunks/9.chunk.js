"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[9],{10874:(Q,z,I)=>{I.r(z),I.d(z,{_KTXTextureLoader:()=>s});var P=I(1066);class w{constructor(Q,z){if(this.data=Q,this.isInvalid=!1,!w.IsValid(Q))return this.isInvalid=!0,void P.b.Error("texture missing KTX identifier");const I=Uint32Array.BYTES_PER_ELEMENT,T=new DataView(this.data.buffer,this.data.byteOffset+12,13*I),A=67305985===T.getUint32(0,!0);return this.glType=T.getUint32(1*I,A),this.glTypeSize=T.getUint32(2*I,A),this.glFormat=T.getUint32(3*I,A),this.glInternalFormat=T.getUint32(4*I,A),this.glBaseInternalFormat=T.getUint32(5*I,A),this.pixelWidth=T.getUint32(6*I,A),this.pixelHeight=T.getUint32(7*I,A),this.pixelDepth=T.getUint32(8*I,A),this.numberOfArrayElements=T.getUint32(9*I,A),this.numberOfFaces=T.getUint32(10*I,A),this.numberOfMipmapLevels=T.getUint32(11*I,A),this.bytesOfKeyValueData=T.getUint32(12*I,A),0!==this.glType?(P.b.Error("only compressed formats currently supported"),void(this.isInvalid=!0)):(this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels),0===this.pixelHeight||0!==this.pixelDepth?(P.b.Error("only 2D textures currently supported"),void(this.isInvalid=!0)):0!==this.numberOfArrayElements?(P.b.Error("texture arrays not currently supported"),void(this.isInvalid=!0)):this.numberOfFaces!==z?(P.b.Error("number of faces expected"+z+", but found "+this.numberOfFaces),void(this.isInvalid=!0)):void(this.loadType=w.COMPRESSED_2D))}uploadLevels(Q,z){switch(this.loadType){case w.COMPRESSED_2D:this._upload2DCompressedLevels(Q,z);case w.TEX_2D:case w.COMPRESSED_3D:case w.TEX_3D:}}_upload2DCompressedLevels(Q,z){let I=w.HEADER_LEN+this.bytesOfKeyValueData,P=this.pixelWidth,T=this.pixelHeight;const A=z?this.numberOfMipmapLevels:1;for(let w=0;w<A;w++){const z=new Int32Array(this.data.buffer,this.data.byteOffset+I,1)[0];I+=4;for(let A=0;A<this.numberOfFaces;A++){const e=new Uint8Array(this.data.buffer,this.data.byteOffset+I,z);Q.getEngine()._uploadCompressedDataToTextureDirectly(Q,Q.format,P,T,e,A,w),I+=z,I+=3-(z+3)%4}P=Math.max(1,.5*P),T=Math.max(1,.5*T)}}static IsValid(Q){if(Q.byteLength>=12){const z=new Uint8Array(Q.buffer,Q.byteOffset,12);if(171===z[0]&&75===z[1]&&84===z[2]&&88===z[3]&&32===z[4]&&49===z[5]&&49===z[6]&&187===z[7]&&13===z[8]&&10===z[9]&&26===z[10]&&10===z[11])return!0}return!1}}w.HEADER_LEN=64,w.COMPRESSED_2D=0,w.COMPRESSED_3D=1,w.TEX_2D=2,w.TEX_3D=3;var T,A,e,m=I(10876),f=I(1180);function j(Q,z){const I=(null===z||void 0===z?void 0:z.jsDecoderModule)||KTX2DECODER;Q&&(Q.wasmUASTCToASTC&&(I.LiteTranscoder_UASTC_ASTC.WasmModuleURL=Q.wasmUASTCToASTC),Q.wasmUASTCToBC7&&(I.LiteTranscoder_UASTC_BC7.WasmModuleURL=Q.wasmUASTCToBC7),Q.wasmUASTCToRGBA_UNORM&&(I.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=Q.wasmUASTCToRGBA_UNORM),Q.wasmUASTCToRGBA_SRGB&&(I.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=Q.wasmUASTCToRGBA_SRGB),Q.wasmUASTCToR8_UNORM&&(I.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=Q.wasmUASTCToR8_UNORM),Q.wasmUASTCToRG8_UNORM&&(I.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=Q.wasmUASTCToRG8_UNORM),Q.jsMSCTranscoder&&(I.MSCTranscoder.JSModuleURL=Q.jsMSCTranscoder),Q.wasmMSCTranscoder&&(I.MSCTranscoder.WasmModuleURL=Q.wasmMSCTranscoder),Q.wasmZSTDDecoder&&(I.ZSTDDecoder.WasmModuleURL=Q.wasmZSTDDecoder)),z&&(z.wasmUASTCToASTC&&(I.LiteTranscoder_UASTC_ASTC.WasmBinary=z.wasmUASTCToASTC),z.wasmUASTCToBC7&&(I.LiteTranscoder_UASTC_BC7.WasmBinary=z.wasmUASTCToBC7),z.wasmUASTCToRGBA_UNORM&&(I.LiteTranscoder_UASTC_RGBA_UNORM.WasmBinary=z.wasmUASTCToRGBA_UNORM),z.wasmUASTCToRGBA_SRGB&&(I.LiteTranscoder_UASTC_RGBA_SRGB.WasmBinary=z.wasmUASTCToRGBA_SRGB),z.wasmUASTCToR8_UNORM&&(I.LiteTranscoder_UASTC_R8_UNORM.WasmBinary=z.wasmUASTCToR8_UNORM),z.wasmUASTCToRG8_UNORM&&(I.LiteTranscoder_UASTC_RG8_UNORM.WasmBinary=z.wasmUASTCToRG8_UNORM),z.jsMSCTranscoder&&(I.MSCTranscoder.JSModule=z.jsMSCTranscoder),z.wasmMSCTranscoder&&(I.MSCTranscoder.WasmBinary=z.wasmMSCTranscoder),z.wasmZSTDDecoder&&(I.ZSTDDecoder.WasmBinary=z.wasmZSTDDecoder))}function D(Q){let z;"undefined"===typeof Q&&"undefined"!==typeof KTX2DECODER&&(Q=KTX2DECODER),onmessage=I=>{if(I.data)switch(I.data.action){case"init":{const P=I.data.urls;P&&(P.jsDecoderModule&&"undefined"===typeof Q&&(importScripts(P.jsDecoderModule),Q=KTX2DECODER),j(P)),I.data.wasmBinaries&&j(void 0,{...I.data.wasmBinaries,jsDecoderModule:Q}),z=new Q.KTX2Decoder,postMessage({action:"init"});break}case"setDefaultDecoderOptions":Q.KTX2Decoder.DefaultDecoderOptions=I.data.options;break;case"decode":z.decode(I.data.data,I.data.caps,I.data.options).then((Q=>{const z=[];for(let I=0;I<Q.mipmaps.length;++I){const P=Q.mipmaps[I];P&&P.data&&z.push(P.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:Q},z)})).catch((Q=>{postMessage({action:"decoded",success:!1,msg:Q})}))}}}!function(Q){Q[Q.ETC1S=0]="ETC1S",Q[Q.UASTC4x4=1]="UASTC4x4"}(T||(T={})),function(Q){Q[Q.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",Q[Q.BC7_RGBA=1]="BC7_RGBA",Q[Q.BC3_RGBA=2]="BC3_RGBA",Q[Q.BC1_RGB=3]="BC1_RGB",Q[Q.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",Q[Q.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",Q[Q.ETC2_RGBA=6]="ETC2_RGBA",Q[Q.ETC1_RGB=7]="ETC1_RGB",Q[Q.RGBA32=8]="RGBA32",Q[Q.R8=9]="R8",Q[Q.RG8=10]="RG8"}(A||(A={})),function(Q){Q[Q.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",Q[Q.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",Q[Q.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",Q[Q.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",Q[Q.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",Q[Q.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",Q[Q.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",Q[Q.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",Q[Q.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",Q[Q.RGBA8Format=32856]="RGBA8Format",Q[Q.R8Format=33321]="R8Format",Q[Q.RG8Format=33323]="RG8Format"}(e||(e={}));class k{static GetDefaultNumWorkers(){return"object"===typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static _Initialize(Q){if(k._WorkerPoolPromise||k._DecoderModulePromise)return;const z={jsDecoderModule:f.h.GetBabylonScriptURL(this.URLConfig.jsDecoderModule,!0),wasmUASTCToASTC:f.h.GetBabylonScriptURL(this.URLConfig.wasmUASTCToASTC,!0),wasmUASTCToBC7:f.h.GetBabylonScriptURL(this.URLConfig.wasmUASTCToBC7,!0),wasmUASTCToRGBA_UNORM:f.h.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_UNORM,!0),wasmUASTCToRGBA_SRGB:f.h.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_SRGB,!0),wasmUASTCToR8_UNORM:f.h.GetBabylonScriptURL(this.URLConfig.wasmUASTCToR8_UNORM,!0),wasmUASTCToRG8_UNORM:f.h.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRG8_UNORM,!0),jsMSCTranscoder:f.h.GetBabylonScriptURL(this.URLConfig.jsMSCTranscoder,!0),wasmMSCTranscoder:f.h.GetBabylonScriptURL(this.URLConfig.wasmMSCTranscoder,!0),wasmZSTDDecoder:f.h.GetBabylonScriptURL(this.URLConfig.wasmZSTDDecoder,!0)};Q&&"function"===typeof Worker&&"undefined"!==typeof URL?k._WorkerPoolPromise=new Promise((I=>{const P=`${j}(${D})()`,w=URL.createObjectURL(new Blob([P],{type:"application/javascript"}));I(new m.b(Q,(()=>function(Q,z,I){return new Promise(((P,w)=>{const T=z=>{Q.removeEventListener("error",T),Q.removeEventListener("message",A),w(z)},A=z=>{"init"===z.data.action&&(Q.removeEventListener("error",T),Q.removeEventListener("message",A),P(Q))};Q.addEventListener("error",T),Q.addEventListener("message",A),Q.postMessage({action:"init",urls:I,wasmBinaries:z})}))}(new Worker(w),void 0,z))))})):"undefined"===typeof k._KTX2DecoderModule?k._DecoderModulePromise=f.h.LoadBabylonScriptAsync(z.jsDecoderModule).then((()=>(k._KTX2DecoderModule=KTX2DECODER,k._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,k._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,j(z,k._KTX2DecoderModule),new k._KTX2DecoderModule.KTX2Decoder))):(k._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,k._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,k._DecoderModulePromise=Promise.resolve(new k._KTX2DecoderModule.KTX2Decoder))}constructor(Q){let z=arguments.length>1&&void 0!==arguments[1]?arguments[1]:k.DefaultNumWorkers;this._engine=Q;const I="object"===typeof z&&z.workerPool||k.WorkerPool;if(I)k._WorkerPoolPromise=Promise.resolve(I);else{var P;if("object"===typeof z)k._KTX2DecoderModule=null===z||void 0===z||null===(P=z.binariesAndModulesContainer)||void 0===P?void 0:P.jsDecoderModule;else"undefined"!==typeof KTX2DECODER&&(k._KTX2DecoderModule=KTX2DECODER);const Q="number"===typeof z?z:z.numWorkers??k.DefaultNumWorkers;k._Initialize(Q)}}_uploadAsync(Q,z,I){const P=this._engine.getCaps(),w={astc:!!P.astc,bptc:!!P.bptc,s3tc:!!P.s3tc,pvrtc:!!P.pvrtc,etc2:!!P.etc2,etc1:!!P.etc1};if(k._WorkerPoolPromise)return k._WorkerPoolPromise.then((P=>new Promise(((T,A)=>{P.push(((P,e)=>{const m=Q=>{P.removeEventListener("error",m),P.removeEventListener("message",f),A(Q),e()},f=Q=>{if("decoded"===Q.data.action){if(P.removeEventListener("error",m),P.removeEventListener("message",f),Q.data.success)try{this._createTexture(Q.data.decodedData,z,I),T()}catch(w){A({message:w})}else A({message:Q.data.msg});e()}};P.addEventListener("error",m),P.addEventListener("message",f),P.postMessage({action:"setDefaultDecoderOptions",options:k.DefaultDecoderOptions._getKTX2DecoderOptions()});const j=new Uint8Array(Q.byteLength);j.set(new Uint8Array(Q.buffer,Q.byteOffset,Q.byteLength)),P.postMessage({action:"decode",data:j,caps:w,options:I},[j.buffer])}))}))));if(k._DecoderModulePromise)return k._DecoderModulePromise.then((I=>(k.DefaultDecoderOptions.isDirty&&(k._KTX2DecoderModule.KTX2Decoder.DefaultDecoderOptions=k.DefaultDecoderOptions._getKTX2DecoderOptions()),new Promise(((w,T)=>{I.decode(Q,P).then((Q=>{this._createTexture(Q,z),w()})).catch((Q=>{T({message:Q})}))})))));throw new Error("KTX2 decoder module is not available")}_createTexture(Q,z,I){this._engine._bindTextureDirectly(3553,z),I&&(I.transcodedFormat=Q.transcodedFormat,I.isInGammaSpace=Q.isInGammaSpace,I.jd=Q.jd,I.transcoderName=Q.transcoderName);let P=!0;switch(Q.transcodedFormat){case 32856:z.type=0,z.format=5;break;case 33321:z.type=0,z.format=6;break;case 33323:z.type=0,z.format=7;break;default:z.format=Q.transcodedFormat,P=!1}if(z._gammaSpace=Q.isInGammaSpace,z.generateMipMaps=Q.mipmaps.length>1,Q.errors)throw new Error("KTX2 container - could not transcode the data. "+Q.errors);for(let w=0;w<Q.mipmaps.length;++w){const I=Q.mipmaps[w];if(!I||!I.data)throw new Error("KTX2 container - could not transcode one of the image");P?(z.width=I.width,z.height=I.height,this._engine._uploadDataToTextureDirectly(z,I.data,0,w,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(z,Q.transcodedFormat,I.width,I.height,I.data,0,w)}z._extension=".ktx2",z.width=Q.mipmaps[0].width,z.height=Q.mipmaps[0].height,z.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static IsValid(Q){if(Q.byteLength>=12){const z=new Uint8Array(Q.buffer,Q.byteOffset,12);if(171===z[0]&&75===z[1]&&84===z[2]&&88===z[3]&&32===z[4]&&50===z[5]&&48===z[6]&&187===z[7]&&13===z[8]&&10===z[9]&&26===z[10]&&10===z[11])return!0}return!1}}k.URLConfig={jsDecoderModule:"https://cdn.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null},k.DefaultNumWorkers=k.GetDefaultNumWorkers(),k.DefaultDecoderOptions=new class{constructor(){this._isDirty=!0,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=!0,this._ktx2DecoderOptions={}}get isDirty(){return this._isDirty}get useRGBAIfASTCBC7NotAvailableWhenUASTC(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set useRGBAIfASTCBC7NotAvailableWhenUASTC(Q){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==Q&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=Q,this._isDirty=!0)}get useRGBAIfOnlyBC1BC3AvailableWhenUASTC(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set useRGBAIfOnlyBC1BC3AvailableWhenUASTC(Q){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==Q&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=Q,this._isDirty=!0)}get forceRGBA(){return this._forceRGBA}set forceRGBA(Q){this._forceRGBA!==Q&&(this._forceRGBA=Q,this._isDirty=!0)}get forceR8(){return this._forceR8}set forceR8(Q){this._forceR8!==Q&&(this._forceR8=Q,this._isDirty=!0)}get forceRG8(){return this._forceRG8}set forceRG8(Q){this._forceRG8!==Q&&(this._forceRG8=Q,this._isDirty=!0)}get bypassTranscoders(){return this._bypassTranscoders}set bypassTranscoders(Q){this._bypassTranscoders!==Q&&(this._bypassTranscoders=Q,this._isDirty=!0)}_getKTX2DecoderOptions(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=!1;const Q={useRGBAIfASTCBC7NotAvailableWhenUASTC:this._useRGBAIfASTCBC7NotAvailableWhenUASTC,forceRGBA:this._forceRGBA,forceR8:this._forceR8,forceRG8:this._forceRG8,bypassTranscoders:this._bypassTranscoders};return this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(Q.transcodeFormatDecisionTree={UASTC:{transcodeFormat:[A.BC1_RGB,A.BC3_RGBA],yes:{transcodeFormat:A.RGBA32,engineFormat:32856,roundToMultiple4:!1}}}),this._ktx2DecoderOptions=Q,Q}};class s{constructor(){this.supportCascades=!1}loadCubeData(Q,z,I,P){if(Array.isArray(Q))return;z._invertVScale=!z.invertY;const T=z.getEngine(),A=new w(Q,6),e=A.numberOfMipmapLevels>1&&z.generateMipMaps;T._unpackFlipY(!0),A.uploadLevels(z,z.generateMipMaps),z.width=A.pixelWidth,z.height=A.pixelHeight,T._setCubeMapTextureParams(z,e,A.numberOfMipmapLevels-1),z.isReady=!0,z.onLoadedObservable.notifyObservers(z),z.onLoadedObservable.clear(),P&&P()}loadData(Q,z,I,T){if(w.IsValid(Q)){z._invertVScale=!z.invertY;const P=new w(Q,1),T=function(Q){switch(Q){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}(P.glInternalFormat);T?(z.format=T,z._useSRGBBuffer=z.getEngine()._getUseSRGBBuffer(!0,z.generateMipMaps),z._gammaSpace=!0):z.format=P.glInternalFormat,I(P.pixelWidth,P.pixelHeight,z.generateMipMaps,!0,(()=>{P.uploadLevels(z,z.generateMipMaps)}),P.isInvalid)}else if(k.IsValid(Q)){new k(z.getEngine())._uploadAsync(Q,z,T).then((()=>{I(z.width,z.height,z.generateMipMaps,!0,(()=>{}),!1)}),(Q=>{P.b.Warn(`Failed to load KTX2 texture data: ${Q.message}`),I(0,0,!1,!1,(()=>{}),!0)}))}else P.b.Error("texture missing KTX identifier"),I(0,0,!1,!1,(()=>{}),!0)}}},10876:(Q,z,I)=>{I.d(z,{b:()=>w});class P{constructor(Q){this._pendingActions=new Array,this._workerInfos=Q.map((Q=>({workerPromise:Promise.resolve(Q),idle:!0})))}dispose(){for(const Q of this._workerInfos)Q.workerPromise.then((Q=>{Q.terminate()}));this._workerInfos.length=0,this._pendingActions.length=0}push(Q){this._executeOnIdleWorker(Q)||this._pendingActions.push(Q)}_executeOnIdleWorker(Q){for(const z of this._workerInfos)if(z.idle)return this._execute(z,Q),!0;return!1}_execute(Q,z){Q.idle=!1,Q.workerPromise.then((I=>{z(I,(()=>{const z=this._pendingActions.shift();z?this._execute(Q,z):Q.idle=!0}))}))}}class w extends P{constructor(Q,z){let I=arguments.length>2&&void 0!==arguments[2]?arguments[2]:w.DefaultOptions;super([]),this._maxWorkers=Q,this._createWorkerAsync=z,this._options=I}push(Q){if(!this._executeOnIdleWorker(Q))if(this._workerInfos.length<this._maxWorkers){const z={workerPromise:this._createWorkerAsync(),idle:!1};this._workerInfos.push(z),this._execute(z,Q)}else this._pendingActions.push(Q)}_execute(Q,z){Q.timeoutId&&(clearTimeout(Q.timeoutId),delete Q.timeoutId),super._execute(Q,((I,P)=>{z(I,(()=>{P(),Q.idle&&(Q.timeoutId=setTimeout((()=>{Q.workerPromise.then((Q=>{Q.terminate()}));const z=this._workerInfos.indexOf(Q);-1!==z&&this._workerInfos.splice(z,1)}),this._options.idleTimeElapsedBeforeRelease))}))}))}}w.DefaultOptions={idleTimeElapsedBeforeRelease:1e3}}}]);