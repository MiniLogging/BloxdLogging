"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[9],{10871:(v,T,X)=>{X.r(T),X.d(T,{_KTXTextureLoader:()=>V});var O=X(1103);class u{constructor(v,T){if(this.data=v,this.isInvalid=!1,!u.IsValid(v))return this.isInvalid=!0,void O.d.Error("texture missing KTX identifier");const X=Uint32Array.BYTES_PER_ELEMENT,B=new DataView(this.data.buffer,this.data.byteOffset+12,13*X),m=67305985===B.getUint32(0,!0);return this.glType=B.getUint32(1*X,m),this.glTypeSize=B.getUint32(2*X,m),this.glFormat=B.getUint32(3*X,m),this.glInternalFormat=B.getUint32(4*X,m),this.glBaseInternalFormat=B.getUint32(5*X,m),this.pixelWidth=B.getUint32(6*X,m),this.pixelHeight=B.getUint32(7*X,m),this.pixelDepth=B.getUint32(8*X,m),this.numberOfArrayElements=B.getUint32(9*X,m),this.numberOfFaces=B.getUint32(10*X,m),this.numberOfMipmapLevels=B.getUint32(11*X,m),this.bytesOfKeyValueData=B.getUint32(12*X,m),0!==this.glType?(O.d.Error("only compressed formats currently supported"),void(this.isInvalid=!0)):(this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels),0===this.pixelHeight||0!==this.pixelDepth?(O.d.Error("only 2D textures currently supported"),void(this.isInvalid=!0)):0!==this.numberOfArrayElements?(O.d.Error("texture arrays not currently supported"),void(this.isInvalid=!0)):this.numberOfFaces!==T?(O.d.Error("number of faces expected"+T+", but found "+this.numberOfFaces),void(this.isInvalid=!0)):void(this.loadType=u.COMPRESSED_2D))}uploadLevels(v,T){switch(this.loadType){case u.COMPRESSED_2D:this._upload2DCompressedLevels(v,T);case u.TEX_2D:case u.COMPRESSED_3D:case u.TEX_3D:}}_upload2DCompressedLevels(v,T){let X=u.HEADER_LEN+this.bytesOfKeyValueData,O=this.pixelWidth,B=this.pixelHeight;const m=T?this.numberOfMipmapLevels:1;for(let u=0;u<m;u++){const T=new Int32Array(this.data.buffer,this.data.byteOffset+X,1)[0];X+=4;for(let m=0;m<this.numberOfFaces;m++){const A=new Uint8Array(this.data.buffer,this.data.byteOffset+X,T);v.getEngine()._uploadCompressedDataToTextureDirectly(v,v.format,O,B,A,m,u),X+=T,X+=3-(T+3)%4}O=Math.max(1,.5*O),B=Math.max(1,.5*B)}}static IsValid(v){if(v.byteLength>=12){const T=new Uint8Array(v.buffer,v.byteOffset,12);if(171===T[0]&&75===T[1]&&84===T[2]&&88===T[3]&&32===T[4]&&49===T[5]&&49===T[6]&&187===T[7]&&13===T[8]&&10===T[9]&&26===T[10]&&10===T[11])return!0}return!1}}u.HEADER_LEN=64,u.COMPRESSED_2D=0,u.COMPRESSED_3D=1,u.TEX_2D=2,u.TEX_3D=3;var B,m,A,x=X(10878),f=X(1217);function M(v,T){const X=(null===T||void 0===T?void 0:T.jsDecoderModule)||KTX2DECODER;v&&(v.wasmUASTCToASTC&&(X.LiteTranscoder_UASTC_ASTC.WasmModuleURL=v.wasmUASTCToASTC),v.wasmUASTCToBC7&&(X.LiteTranscoder_UASTC_BC7.WasmModuleURL=v.wasmUASTCToBC7),v.wasmUASTCToRGBA_UNORM&&(X.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=v.wasmUASTCToRGBA_UNORM),v.wasmUASTCToRGBA_SRGB&&(X.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=v.wasmUASTCToRGBA_SRGB),v.wasmUASTCToR8_UNORM&&(X.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=v.wasmUASTCToR8_UNORM),v.wasmUASTCToRG8_UNORM&&(X.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=v.wasmUASTCToRG8_UNORM),v.jsMSCTranscoder&&(X.MSCTranscoder.JSModuleURL=v.jsMSCTranscoder),v.wasmMSCTranscoder&&(X.MSCTranscoder.WasmModuleURL=v.wasmMSCTranscoder),v.wasmZSTDDecoder&&(X.ZSTDDecoder.WasmModuleURL=v.wasmZSTDDecoder)),T&&(T.wasmUASTCToASTC&&(X.LiteTranscoder_UASTC_ASTC.WasmBinary=T.wasmUASTCToASTC),T.wasmUASTCToBC7&&(X.LiteTranscoder_UASTC_BC7.WasmBinary=T.wasmUASTCToBC7),T.wasmUASTCToRGBA_UNORM&&(X.LiteTranscoder_UASTC_RGBA_UNORM.WasmBinary=T.wasmUASTCToRGBA_UNORM),T.wasmUASTCToRGBA_SRGB&&(X.LiteTranscoder_UASTC_RGBA_SRGB.WasmBinary=T.wasmUASTCToRGBA_SRGB),T.wasmUASTCToR8_UNORM&&(X.LiteTranscoder_UASTC_R8_UNORM.WasmBinary=T.wasmUASTCToR8_UNORM),T.wasmUASTCToRG8_UNORM&&(X.LiteTranscoder_UASTC_RG8_UNORM.WasmBinary=T.wasmUASTCToRG8_UNORM),T.jsMSCTranscoder&&(X.MSCTranscoder.JSModule=T.jsMSCTranscoder),T.wasmMSCTranscoder&&(X.MSCTranscoder.WasmBinary=T.wasmMSCTranscoder),T.wasmZSTDDecoder&&(X.ZSTDDecoder.WasmBinary=T.wasmZSTDDecoder))}function H(v){let T;"undefined"===typeof v&&"undefined"!==typeof KTX2DECODER&&(v=KTX2DECODER),onmessage=X=>{if(X.data)switch(X.data.action){case"init":{const O=X.data.urls;O&&(O.jsDecoderModule&&"undefined"===typeof v&&(importScripts(O.jsDecoderModule),v=KTX2DECODER),M(O)),X.data.wasmBinaries&&M(void 0,{...X.data.wasmBinaries,jsDecoderModule:v}),T=new v.KTX2Decoder,postMessage({action:"init"});break}case"setDefaultDecoderOptions":v.KTX2Decoder.DefaultDecoderOptions=X.data.options;break;case"decode":T.decode(X.data.data,X.data.caps,X.data.options).then((v=>{const T=[];for(let X=0;X<v.mipmaps.length;++X){const O=v.mipmaps[X];O&&O.data&&T.push(O.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:v},T)})).catch((v=>{postMessage({action:"decoded",success:!1,msg:v})}))}}}!function(v){v[v.ETC1S=0]="ETC1S",v[v.UASTC4x4=1]="UASTC4x4"}(B||(B={})),function(v){v[v.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",v[v.BC7_RGBA=1]="BC7_RGBA",v[v.BC3_RGBA=2]="BC3_RGBA",v[v.BC1_RGB=3]="BC1_RGB",v[v.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",v[v.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",v[v.ETC2_RGBA=6]="ETC2_RGBA",v[v.ETC1_RGB=7]="ETC1_RGB",v[v.RGBA32=8]="RGBA32",v[v.R8=9]="R8",v[v.RG8=10]="RG8"}(m||(m={})),function(v){v[v.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",v[v.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",v[v.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",v[v.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",v[v.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",v[v.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",v[v.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",v[v.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",v[v.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",v[v.RGBA8Format=32856]="RGBA8Format",v[v.R8Format=33321]="R8Format",v[v.RG8Format=33323]="RG8Format"}(A||(A={}));class n{static GetDefaultNumWorkers(){return"object"===typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static _Initialize(v){if(n._WorkerPoolPromise||n._DecoderModulePromise)return;const T={jsDecoderModule:f.c.GetBabylonScriptURL(this.URLConfig.jsDecoderModule,!0),wasmUASTCToASTC:f.c.GetBabylonScriptURL(this.URLConfig.wasmUASTCToASTC,!0),wasmUASTCToBC7:f.c.GetBabylonScriptURL(this.URLConfig.wasmUASTCToBC7,!0),wasmUASTCToRGBA_UNORM:f.c.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_UNORM,!0),wasmUASTCToRGBA_SRGB:f.c.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_SRGB,!0),wasmUASTCToR8_UNORM:f.c.GetBabylonScriptURL(this.URLConfig.wasmUASTCToR8_UNORM,!0),wasmUASTCToRG8_UNORM:f.c.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRG8_UNORM,!0),jsMSCTranscoder:f.c.GetBabylonScriptURL(this.URLConfig.jsMSCTranscoder,!0),wasmMSCTranscoder:f.c.GetBabylonScriptURL(this.URLConfig.wasmMSCTranscoder,!0),wasmZSTDDecoder:f.c.GetBabylonScriptURL(this.URLConfig.wasmZSTDDecoder,!0)};v&&"function"===typeof Worker&&"undefined"!==typeof URL?n._WorkerPoolPromise=new Promise((X=>{const O=`${M}(${H})()`,u=URL.createObjectURL(new Blob([O],{type:"application/javascript"}));X(new x.e(v,(()=>function(v,T,X){return new Promise(((O,u)=>{const B=T=>{v.removeEventListener("error",B),v.removeEventListener("message",m),u(T)},m=T=>{"init"===T.data.action&&(v.removeEventListener("error",B),v.removeEventListener("message",m),O(v))};v.addEventListener("error",B),v.addEventListener("message",m),v.postMessage({action:"init",urls:X,wasmBinaries:T})}))}(new Worker(u),void 0,T))))})):"undefined"===typeof n._KTX2DecoderModule?n._DecoderModulePromise=f.c.LoadBabylonScriptAsync(T.jsDecoderModule).then((()=>(n._KTX2DecoderModule=KTX2DECODER,n._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,n._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,M(T,n._KTX2DecoderModule),new n._KTX2DecoderModule.KTX2Decoder))):(n._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,n._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,n._DecoderModulePromise=Promise.resolve(new n._KTX2DecoderModule.KTX2Decoder))}constructor(v){let T=arguments.length>1&&void 0!==arguments[1]?arguments[1]:n.DefaultNumWorkers;this._engine=v;const X="object"===typeof T&&T.workerPool||n.WorkerPool;if(X)n._WorkerPoolPromise=Promise.resolve(X);else{var O;if("object"===typeof T)n._KTX2DecoderModule=null===T||void 0===T||null===(O=T.binariesAndModulesContainer)||void 0===O?void 0:O.jsDecoderModule;else"undefined"!==typeof KTX2DECODER&&(n._KTX2DecoderModule=KTX2DECODER);const v="number"===typeof T?T:T.numWorkers??n.DefaultNumWorkers;n._Initialize(v)}}_uploadAsync(v,T,X){const O=this._engine.getCaps(),u={astc:!!O.astc,bptc:!!O.bptc,s3tc:!!O.s3tc,pvrtc:!!O.pvrtc,etc2:!!O.etc2,etc1:!!O.etc1};if(n._WorkerPoolPromise)return n._WorkerPoolPromise.then((O=>new Promise(((B,m)=>{O.push(((O,A)=>{const x=v=>{O.removeEventListener("error",x),O.removeEventListener("message",f),m(v),A()},f=v=>{if("decoded"===v.data.action){if(O.removeEventListener("error",x),O.removeEventListener("message",f),v.data.success)try{this._createTexture(v.data.decodedData,T,X),B()}catch(u){m({message:u})}else m({message:v.data.msg});A()}};O.addEventListener("error",x),O.addEventListener("message",f),O.postMessage({action:"setDefaultDecoderOptions",options:n.DefaultDecoderOptions._getKTX2DecoderOptions()});const M=new Uint8Array(v.byteLength);M.set(new Uint8Array(v.buffer,v.byteOffset,v.byteLength)),O.postMessage({action:"decode",data:M,caps:u,options:X},[M.buffer])}))}))));if(n._DecoderModulePromise)return n._DecoderModulePromise.then((X=>(n.DefaultDecoderOptions.isDirty&&(n._KTX2DecoderModule.KTX2Decoder.DefaultDecoderOptions=n.DefaultDecoderOptions._getKTX2DecoderOptions()),new Promise(((u,B)=>{X.decode(v,O).then((v=>{this._createTexture(v,T),u()})).catch((v=>{B({message:v})}))})))));throw new Error("KTX2 decoder module is not available")}_createTexture(v,T,X){this._engine._bindTextureDirectly(3553,T),X&&(X.transcodedFormat=v.transcodedFormat,X.isInGammaSpace=v.isInGammaSpace,X.yd=v.yd,X.transcoderName=v.transcoderName);let O=!0;switch(v.transcodedFormat){case 32856:T.type=0,T.format=5;break;case 33321:T.type=0,T.format=6;break;case 33323:T.type=0,T.format=7;break;default:T.format=v.transcodedFormat,O=!1}if(T._gammaSpace=v.isInGammaSpace,T.generateMipMaps=v.mipmaps.length>1,v.errors)throw new Error("KTX2 container - could not transcode the data. "+v.errors);for(let u=0;u<v.mipmaps.length;++u){const X=v.mipmaps[u];if(!X||!X.data)throw new Error("KTX2 container - could not transcode one of the image");O?(T.width=X.width,T.height=X.height,this._engine._uploadDataToTextureDirectly(T,X.data,0,u,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(T,v.transcodedFormat,X.width,X.height,X.data,0,u)}T._extension=".ktx2",T.width=v.mipmaps[0].width,T.height=v.mipmaps[0].height,T.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static IsValid(v){if(v.byteLength>=12){const T=new Uint8Array(v.buffer,v.byteOffset,12);if(171===T[0]&&75===T[1]&&84===T[2]&&88===T[3]&&32===T[4]&&50===T[5]&&48===T[6]&&187===T[7]&&13===T[8]&&10===T[9]&&26===T[10]&&10===T[11])return!0}return!1}}n.URLConfig={jsDecoderModule:"https://cdn.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null},n.DefaultNumWorkers=n.GetDefaultNumWorkers(),n.DefaultDecoderOptions=new class{constructor(){this._isDirty=!0,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=!0,this._ktx2DecoderOptions={}}get isDirty(){return this._isDirty}get useRGBAIfASTCBC7NotAvailableWhenUASTC(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set useRGBAIfASTCBC7NotAvailableWhenUASTC(v){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==v&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=v,this._isDirty=!0)}get useRGBAIfOnlyBC1BC3AvailableWhenUASTC(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set useRGBAIfOnlyBC1BC3AvailableWhenUASTC(v){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==v&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=v,this._isDirty=!0)}get forceRGBA(){return this._forceRGBA}set forceRGBA(v){this._forceRGBA!==v&&(this._forceRGBA=v,this._isDirty=!0)}get forceR8(){return this._forceR8}set forceR8(v){this._forceR8!==v&&(this._forceR8=v,this._isDirty=!0)}get forceRG8(){return this._forceRG8}set forceRG8(v){this._forceRG8!==v&&(this._forceRG8=v,this._isDirty=!0)}get bypassTranscoders(){return this._bypassTranscoders}set bypassTranscoders(v){this._bypassTranscoders!==v&&(this._bypassTranscoders=v,this._isDirty=!0)}_getKTX2DecoderOptions(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=!1;const v={useRGBAIfASTCBC7NotAvailableWhenUASTC:this._useRGBAIfASTCBC7NotAvailableWhenUASTC,forceRGBA:this._forceRGBA,forceR8:this._forceR8,forceRG8:this._forceRG8,bypassTranscoders:this._bypassTranscoders};return this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(v.transcodeFormatDecisionTree={UASTC:{transcodeFormat:[m.BC1_RGB,m.BC3_RGBA],yes:{transcodeFormat:m.RGBA32,engineFormat:32856,roundToMultiple4:!1}}}),this._ktx2DecoderOptions=v,v}};class V{constructor(){this.supportCascades=!1}loadCubeData(v,T,X,O){if(Array.isArray(v))return;T._invertVScale=!T.invertY;const B=T.getEngine(),m=new u(v,6),A=m.numberOfMipmapLevels>1&&T.generateMipMaps;B._unpackFlipY(!0),m.uploadLevels(T,T.generateMipMaps),T.width=m.pixelWidth,T.height=m.pixelHeight,B._setCubeMapTextureParams(T,A,m.numberOfMipmapLevels-1),T.isReady=!0,T.onLoadedObservable.notifyObservers(T),T.onLoadedObservable.clear(),O&&O()}loadData(v,T,X,B){if(u.IsValid(v)){T._invertVScale=!T.invertY;const O=new u(v,1),B=function(v){switch(v){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}(O.glInternalFormat);B?(T.format=B,T._useSRGBBuffer=T.getEngine()._getUseSRGBBuffer(!0,T.generateMipMaps),T._gammaSpace=!0):T.format=O.glInternalFormat,X(O.pixelWidth,O.pixelHeight,T.generateMipMaps,!0,(()=>{O.uploadLevels(T,T.generateMipMaps)}),O.isInvalid)}else if(n.IsValid(v)){new n(T.getEngine())._uploadAsync(v,T,B).then((()=>{X(T.width,T.height,T.generateMipMaps,!0,(()=>{}),!1)}),(v=>{O.d.Warn(`Failed to load KTX2 texture data: ${v.message}`),X(0,0,!1,!1,(()=>{}),!0)}))}else O.d.Error("texture missing KTX identifier"),X(0,0,!1,!1,(()=>{}),!0)}}},10878:(v,T,X)=>{X.d(T,{e:()=>u});class O{constructor(v){this._pendingActions=new Array,this._workerInfos=v.map((v=>({workerPromise:Promise.resolve(v),idle:!0})))}dispose(){for(const v of this._workerInfos)v.workerPromise.then((v=>{v.terminate()}));this._workerInfos.length=0,this._pendingActions.length=0}push(v){this._executeOnIdleWorker(v)||this._pendingActions.push(v)}_executeOnIdleWorker(v){for(const T of this._workerInfos)if(T.idle)return this._execute(T,v),!0;return!1}_execute(v,T){v.idle=!1,v.workerPromise.then((X=>{T(X,(()=>{const T=this._pendingActions.shift();T?this._execute(v,T):v.idle=!0}))}))}}class u extends O{constructor(v,T){let X=arguments.length>2&&void 0!==arguments[2]?arguments[2]:u.DefaultOptions;super([]),this._maxWorkers=v,this._createWorkerAsync=T,this._options=X}push(v){if(!this._executeOnIdleWorker(v))if(this._workerInfos.length<this._maxWorkers){const T={workerPromise:this._createWorkerAsync(),idle:!1};this._workerInfos.push(T),this._execute(T,v)}else this._pendingActions.push(v)}_execute(v,T){v.timeoutId&&(clearTimeout(v.timeoutId),delete v.timeoutId),super._execute(v,((X,O)=>{T(X,(()=>{O(),v.idle&&(v.timeoutId=setTimeout((()=>{v.workerPromise.then((v=>{v.terminate()}));const T=this._workerInfos.indexOf(v);-1!==T&&this._workerInfos.splice(T,1)}),this._options.idleTimeElapsedBeforeRelease))}))}))}}u.DefaultOptions={idleTimeElapsedBeforeRelease:1e3}}}]);