"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[9],{10329:(r,L,M)=>{M.r(L),M.d(L,{_KTXTextureLoader:()=>o});var S=M(1027);class T{constructor(r,L){if(this.data=r,this.isInvalid=!1,!T.IsValid(r))return this.isInvalid=!0,void S.c.Error("texture missing KTX identifier");const M=Uint32Array.BYTES_PER_ELEMENT,C=new DataView(this.data.buffer,this.data.byteOffset+12,13*M),y=67305985===C.getUint32(0,!0);return this.glType=C.getUint32(1*M,y),this.glTypeSize=C.getUint32(2*M,y),this.glFormat=C.getUint32(3*M,y),this.glInternalFormat=C.getUint32(4*M,y),this.glBaseInternalFormat=C.getUint32(5*M,y),this.pixelWidth=C.getUint32(6*M,y),this.pixelHeight=C.getUint32(7*M,y),this.pixelDepth=C.getUint32(8*M,y),this.numberOfArrayElements=C.getUint32(9*M,y),this.numberOfFaces=C.getUint32(10*M,y),this.numberOfMipmapLevels=C.getUint32(11*M,y),this.bytesOfKeyValueData=C.getUint32(12*M,y),0!==this.glType?(S.c.Error("only compressed formats currently supported"),void(this.isInvalid=!0)):(this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels),0===this.pixelHeight||0!==this.pixelDepth?(S.c.Error("only 2D textures currently supported"),void(this.isInvalid=!0)):0!==this.numberOfArrayElements?(S.c.Error("texture arrays not currently supported"),void(this.isInvalid=!0)):this.numberOfFaces!==L?(S.c.Error("number of faces expected"+L+", but found "+this.numberOfFaces),void(this.isInvalid=!0)):void(this.loadType=T.COMPRESSED_2D))}uploadLevels(r,L){switch(this.loadType){case T.COMPRESSED_2D:this._upload2DCompressedLevels(r,L);case T.TEX_2D:case T.COMPRESSED_3D:case T.TEX_3D:}}_upload2DCompressedLevels(r,L){let M=T.HEADER_LEN+this.bytesOfKeyValueData,S=this.pixelWidth,C=this.pixelHeight;const y=L?this.numberOfMipmapLevels:1;for(let T=0;T<y;T++){const L=new Int32Array(this.data.buffer,this.data.byteOffset+M,1)[0];M+=4;for(let y=0;y<this.numberOfFaces;y++){const s=new Uint8Array(this.data.buffer,this.data.byteOffset+M,L);r.getEngine()._uploadCompressedDataToTextureDirectly(r,r.format,S,C,s,y,T),M+=L,M+=3-(L+3)%4}S=Math.max(1,.5*S),C=Math.max(1,.5*C)}}static IsValid(r){if(r.byteLength>=12){const L=new Uint8Array(r.buffer,r.byteOffset,12);if(171===L[0]&&75===L[1]&&84===L[2]&&88===L[3]&&32===L[4]&&49===L[5]&&49===L[6]&&187===L[7]&&13===L[8]&&10===L[9]&&26===L[10]&&10===L[11])return!0}return!1}}T.HEADER_LEN=64,T.COMPRESSED_2D=0,T.COMPRESSED_3D=1,T.TEX_2D=2,T.TEX_3D=3;var C,y,s,v=M(10338),u=M(1120);function J(r,L){const M=(null===L||void 0===L?void 0:L.jsDecoderModule)||KTX2DECODER;r&&(r.wasmUASTCToASTC&&(M.LiteTranscoder_UASTC_ASTC.WasmModuleURL=r.wasmUASTCToASTC),r.wasmUASTCToBC7&&(M.LiteTranscoder_UASTC_BC7.WasmModuleURL=r.wasmUASTCToBC7),r.wasmUASTCToRGBA_UNORM&&(M.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=r.wasmUASTCToRGBA_UNORM),r.wasmUASTCToRGBA_SRGB&&(M.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=r.wasmUASTCToRGBA_SRGB),r.wasmUASTCToR8_UNORM&&(M.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=r.wasmUASTCToR8_UNORM),r.wasmUASTCToRG8_UNORM&&(M.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=r.wasmUASTCToRG8_UNORM),r.jsMSCTranscoder&&(M.MSCTranscoder.JSModuleURL=r.jsMSCTranscoder),r.wasmMSCTranscoder&&(M.MSCTranscoder.WasmModuleURL=r.wasmMSCTranscoder),r.wasmZSTDDecoder&&(M.ZSTDDecoder.WasmModuleURL=r.wasmZSTDDecoder)),L&&(L.wasmUASTCToASTC&&(M.LiteTranscoder_UASTC_ASTC.WasmBinary=L.wasmUASTCToASTC),L.wasmUASTCToBC7&&(M.LiteTranscoder_UASTC_BC7.WasmBinary=L.wasmUASTCToBC7),L.wasmUASTCToRGBA_UNORM&&(M.LiteTranscoder_UASTC_RGBA_UNORM.WasmBinary=L.wasmUASTCToRGBA_UNORM),L.wasmUASTCToRGBA_SRGB&&(M.LiteTranscoder_UASTC_RGBA_SRGB.WasmBinary=L.wasmUASTCToRGBA_SRGB),L.wasmUASTCToR8_UNORM&&(M.LiteTranscoder_UASTC_R8_UNORM.WasmBinary=L.wasmUASTCToR8_UNORM),L.wasmUASTCToRG8_UNORM&&(M.LiteTranscoder_UASTC_RG8_UNORM.WasmBinary=L.wasmUASTCToRG8_UNORM),L.jsMSCTranscoder&&(M.MSCTranscoder.JSModule=L.jsMSCTranscoder),L.wasmMSCTranscoder&&(M.MSCTranscoder.WasmBinary=L.wasmMSCTranscoder),L.wasmZSTDDecoder&&(M.ZSTDDecoder.WasmBinary=L.wasmZSTDDecoder))}function f(r){let L;"undefined"===typeof r&&"undefined"!==typeof KTX2DECODER&&(r=KTX2DECODER),onmessage=M=>{if(M.data)switch(M.data.action){case"init":{const S=M.data.urls;S&&(S.jsDecoderModule&&"undefined"===typeof r&&(importScripts(S.jsDecoderModule),r=KTX2DECODER),J(S)),M.data.wasmBinaries&&J(void 0,{...M.data.wasmBinaries,jsDecoderModule:r}),L=new r.KTX2Decoder,postMessage({action:"init"});break}case"setDefaultDecoderOptions":r.KTX2Decoder.DefaultDecoderOptions=M.data.options;break;case"decode":L.decode(M.data.data,M.data.caps,M.data.options).then((r=>{const L=[];for(let M=0;M<r.mipmaps.length;++M){const S=r.mipmaps[M];S&&S.data&&L.push(S.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:r},L)})).catch((r=>{postMessage({action:"decoded",success:!1,msg:r})}))}}}!function(r){r[r.ETC1S=0]="ETC1S",r[r.UASTC4x4=1]="UASTC4x4"}(C||(C={})),function(r){r[r.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",r[r.BC7_RGBA=1]="BC7_RGBA",r[r.BC3_RGBA=2]="BC3_RGBA",r[r.BC1_RGB=3]="BC1_RGB",r[r.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",r[r.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",r[r.ETC2_RGBA=6]="ETC2_RGBA",r[r.ETC1_RGB=7]="ETC1_RGB",r[r.RGBA32=8]="RGBA32",r[r.R8=9]="R8",r[r.RG8=10]="RG8"}(y||(y={})),function(r){r[r.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",r[r.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",r[r.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",r[r.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",r[r.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",r[r.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",r[r.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",r[r.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",r[r.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",r[r.RGBA8Format=32856]="RGBA8Format",r[r.R8Format=33321]="R8Format",r[r.RG8Format=33323]="RG8Format"}(s||(s={}));class t{static GetDefaultNumWorkers(){return"object"===typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static _Initialize(r){if(t._WorkerPoolPromise||t._DecoderModulePromise)return;const L={jsDecoderModule:u.g.GetBabylonScriptURL(this.URLConfig.jsDecoderModule,!0),wasmUASTCToASTC:u.g.GetBabylonScriptURL(this.URLConfig.wasmUASTCToASTC,!0),wasmUASTCToBC7:u.g.GetBabylonScriptURL(this.URLConfig.wasmUASTCToBC7,!0),wasmUASTCToRGBA_UNORM:u.g.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_UNORM,!0),wasmUASTCToRGBA_SRGB:u.g.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_SRGB,!0),wasmUASTCToR8_UNORM:u.g.GetBabylonScriptURL(this.URLConfig.wasmUASTCToR8_UNORM,!0),wasmUASTCToRG8_UNORM:u.g.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRG8_UNORM,!0),jsMSCTranscoder:u.g.GetBabylonScriptURL(this.URLConfig.jsMSCTranscoder,!0),wasmMSCTranscoder:u.g.GetBabylonScriptURL(this.URLConfig.wasmMSCTranscoder,!0),wasmZSTDDecoder:u.g.GetBabylonScriptURL(this.URLConfig.wasmZSTDDecoder,!0)};r&&"function"===typeof Worker&&"undefined"!==typeof URL?t._WorkerPoolPromise=new Promise((M=>{const S=`${J}(${f})()`,T=URL.createObjectURL(new Blob([S],{type:"application/javascript"}));M(new v.d(r,(()=>function(r,L,M){return new Promise(((S,T)=>{const C=L=>{r.removeEventListener("error",C),r.removeEventListener("message",y),T(L)},y=L=>{"init"===L.data.action&&(r.removeEventListener("error",C),r.removeEventListener("message",y),S(r))};r.addEventListener("error",C),r.addEventListener("message",y),r.postMessage({action:"init",urls:M,wasmBinaries:L})}))}(new Worker(T),void 0,L))))})):"undefined"===typeof t._KTX2DecoderModule?t._DecoderModulePromise=u.g.LoadBabylonScriptAsync(L.jsDecoderModule).then((()=>(t._KTX2DecoderModule=KTX2DECODER,t._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,t._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,J(L,t._KTX2DecoderModule),new t._KTX2DecoderModule.KTX2Decoder))):(t._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,t._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,t._DecoderModulePromise=Promise.resolve(new t._KTX2DecoderModule.KTX2Decoder))}constructor(r){let L=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t.DefaultNumWorkers;this._engine=r;const M="object"===typeof L&&L.workerPool||t.WorkerPool;if(M)t._WorkerPoolPromise=Promise.resolve(M);else{var S;if("object"===typeof L)t._KTX2DecoderModule=null===L||void 0===L||null===(S=L.binariesAndModulesContainer)||void 0===S?void 0:S.jsDecoderModule;else"undefined"!==typeof KTX2DECODER&&(t._KTX2DecoderModule=KTX2DECODER);const r="number"===typeof L?L:L.numWorkers??t.DefaultNumWorkers;t._Initialize(r)}}_uploadAsync(r,L,M){const S=this._engine.getCaps(),T={astc:!!S.astc,bptc:!!S.bptc,s3tc:!!S.s3tc,pvrtc:!!S.pvrtc,etc2:!!S.etc2,etc1:!!S.etc1};if(t._WorkerPoolPromise)return t._WorkerPoolPromise.then((S=>new Promise(((C,y)=>{S.push(((S,s)=>{const v=r=>{S.removeEventListener("error",v),S.removeEventListener("message",u),y(r),s()},u=r=>{if("decoded"===r.data.action){if(S.removeEventListener("error",v),S.removeEventListener("message",u),r.data.success)try{this._createTexture(r.data.decodedData,L,M),C()}catch(T){y({message:T})}else y({message:r.data.msg});s()}};S.addEventListener("error",v),S.addEventListener("message",u),S.postMessage({action:"setDefaultDecoderOptions",options:t.DefaultDecoderOptions._getKTX2DecoderOptions()});const J=new Uint8Array(r.byteLength);J.set(new Uint8Array(r.buffer,r.byteOffset,r.byteLength)),S.postMessage({action:"decode",data:J,caps:T,options:M},[J.buffer])}))}))));if(t._DecoderModulePromise)return t._DecoderModulePromise.then((M=>(t.DefaultDecoderOptions.isDirty&&(t._KTX2DecoderModule.KTX2Decoder.DefaultDecoderOptions=t.DefaultDecoderOptions._getKTX2DecoderOptions()),new Promise(((T,C)=>{M.decode(r,S).then((r=>{this._createTexture(r,L),T()})).catch((r=>{C({message:r})}))})))));throw new Error("KTX2 decoder module is not available")}_createTexture(r,L,M){this._engine._bindTextureDirectly(3553,L),M&&(M.transcodedFormat=r.transcodedFormat,M.isInGammaSpace=r.isInGammaSpace,M.Xc=r.Xc,M.transcoderName=r.transcoderName);let S=!0;switch(r.transcodedFormat){case 32856:L.type=0,L.format=5;break;case 33321:L.type=0,L.format=6;break;case 33323:L.type=0,L.format=7;break;default:L.format=r.transcodedFormat,S=!1}if(L._gammaSpace=r.isInGammaSpace,L.generateMipMaps=r.mipmaps.length>1,r.errors)throw new Error("KTX2 container - could not transcode the data. "+r.errors);for(let T=0;T<r.mipmaps.length;++T){const M=r.mipmaps[T];if(!M||!M.data)throw new Error("KTX2 container - could not transcode one of the image");S?(L.width=M.width,L.height=M.height,this._engine._uploadDataToTextureDirectly(L,M.data,0,T,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(L,r.transcodedFormat,M.width,M.height,M.data,0,T)}L._extension=".ktx2",L.width=r.mipmaps[0].width,L.height=r.mipmaps[0].height,L.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static IsValid(r){if(r.byteLength>=12){const L=new Uint8Array(r.buffer,r.byteOffset,12);if(171===L[0]&&75===L[1]&&84===L[2]&&88===L[3]&&32===L[4]&&50===L[5]&&48===L[6]&&187===L[7]&&13===L[8]&&10===L[9]&&26===L[10]&&10===L[11])return!0}return!1}}t.URLConfig={jsDecoderModule:"https://cdn.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null},t.DefaultNumWorkers=t.GetDefaultNumWorkers(),t.DefaultDecoderOptions=new class{constructor(){this._isDirty=!0,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=!0,this._ktx2DecoderOptions={}}get isDirty(){return this._isDirty}get useRGBAIfASTCBC7NotAvailableWhenUASTC(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set useRGBAIfASTCBC7NotAvailableWhenUASTC(r){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==r&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=r,this._isDirty=!0)}get useRGBAIfOnlyBC1BC3AvailableWhenUASTC(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set useRGBAIfOnlyBC1BC3AvailableWhenUASTC(r){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==r&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=r,this._isDirty=!0)}get forceRGBA(){return this._forceRGBA}set forceRGBA(r){this._forceRGBA!==r&&(this._forceRGBA=r,this._isDirty=!0)}get forceR8(){return this._forceR8}set forceR8(r){this._forceR8!==r&&(this._forceR8=r,this._isDirty=!0)}get forceRG8(){return this._forceRG8}set forceRG8(r){this._forceRG8!==r&&(this._forceRG8=r,this._isDirty=!0)}get bypassTranscoders(){return this._bypassTranscoders}set bypassTranscoders(r){this._bypassTranscoders!==r&&(this._bypassTranscoders=r,this._isDirty=!0)}_getKTX2DecoderOptions(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=!1;const r={useRGBAIfASTCBC7NotAvailableWhenUASTC:this._useRGBAIfASTCBC7NotAvailableWhenUASTC,forceRGBA:this._forceRGBA,forceR8:this._forceR8,forceRG8:this._forceRG8,bypassTranscoders:this._bypassTranscoders};return this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(r.transcodeFormatDecisionTree={UASTC:{transcodeFormat:[y.BC1_RGB,y.BC3_RGBA],yes:{transcodeFormat:y.RGBA32,engineFormat:32856,roundToMultiple4:!1}}}),this._ktx2DecoderOptions=r,r}};class o{constructor(){this.supportCascades=!1}loadCubeData(r,L,M,S){if(Array.isArray(r))return;L._invertVScale=!L.invertY;const C=L.getEngine(),y=new T(r,6),s=y.numberOfMipmapLevels>1&&L.generateMipMaps;C._unpackFlipY(!0),y.uploadLevels(L,L.generateMipMaps),L.width=y.pixelWidth,L.height=y.pixelHeight,C._setCubeMapTextureParams(L,s,y.numberOfMipmapLevels-1),L.isReady=!0,L.onLoadedObservable.notifyObservers(L),L.onLoadedObservable.clear(),S&&S()}loadData(r,L,M,C){if(T.IsValid(r)){L._invertVScale=!L.invertY;const S=new T(r,1),C=function(r){switch(r){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}(S.glInternalFormat);C?(L.format=C,L._useSRGBBuffer=L.getEngine()._getUseSRGBBuffer(!0,L.generateMipMaps),L._gammaSpace=!0):L.format=S.glInternalFormat,M(S.pixelWidth,S.pixelHeight,L.generateMipMaps,!0,(()=>{S.uploadLevels(L,L.generateMipMaps)}),S.isInvalid)}else if(t.IsValid(r)){new t(L.getEngine())._uploadAsync(r,L,C).then((()=>{M(L.width,L.height,L.generateMipMaps,!0,(()=>{}),!1)}),(r=>{S.c.Warn(`Failed to load KTX2 texture data: ${r.message}`),M(0,0,!1,!1,(()=>{}),!0)}))}else S.c.Error("texture missing KTX identifier"),M(0,0,!1,!1,(()=>{}),!0)}}},10338:(r,L,M)=>{M.d(L,{d:()=>T});class S{constructor(r){this._pendingActions=new Array,this._workerInfos=r.map((r=>({workerPromise:Promise.resolve(r),idle:!0})))}dispose(){for(const r of this._workerInfos)r.workerPromise.then((r=>{r.terminate()}));this._workerInfos.length=0,this._pendingActions.length=0}push(r){this._executeOnIdleWorker(r)||this._pendingActions.push(r)}_executeOnIdleWorker(r){for(const L of this._workerInfos)if(L.idle)return this._execute(L,r),!0;return!1}_execute(r,L){r.idle=!1,r.workerPromise.then((M=>{L(M,(()=>{const L=this._pendingActions.shift();L?this._execute(r,L):r.idle=!0}))}))}}class T extends S{constructor(r,L){let M=arguments.length>2&&void 0!==arguments[2]?arguments[2]:T.DefaultOptions;super([]),this._maxWorkers=r,this._createWorkerAsync=L,this._options=M}push(r){if(!this._executeOnIdleWorker(r))if(this._workerInfos.length<this._maxWorkers){const L={workerPromise:this._createWorkerAsync(),idle:!1};this._workerInfos.push(L),this._execute(L,r)}else this._pendingActions.push(r)}_execute(r,L){r.timeoutId&&(clearTimeout(r.timeoutId),delete r.timeoutId),super._execute(r,((M,S)=>{L(M,(()=>{S(),r.idle&&(r.timeoutId=setTimeout((()=>{r.workerPromise.then((r=>{r.terminate()}));const L=this._workerInfos.indexOf(r);-1!==L&&this._workerInfos.splice(L,1)}),this._options.idleTimeElapsedBeforeRelease))}))}))}}T.DefaultOptions={idleTimeElapsedBeforeRelease:1e3}}}]);