"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[24],{12493:(z,u,Y)=>{Y.d(u,{b:()=>C,d:()=>d,f:()=>v,i:()=>i});var H=Y(10945),E=Y(10903),J=Y(10937),l=Y(11378),T=Y(11046),b=Y(11397),L=(Y(11504),Y(11442)),D=Y(10953);Y(11488),Y(11473),Y(11591);const g="image/png",M=2,q=[134,22,135,150,246,214,150,54];function C(z){const u=new DataView(z.buffer,z.byteOffset,z.byteLength);let Y=0;for(let l=0;l<q.length;l++)if(u.getUint8(Y++)!==q[l])return D.b.Error("Not a babylon environment map"),null;let H="",E=0;for(;E=u.getUint8(Y++);)H+=String.fromCharCode(E);let J=JSON.parse(H);return J=K(J),J.binaryDataPosition=Y,J.iD&&(J.iD.lodGenerationScale=J.iD.lodGenerationScale||.8),J}function K(z){if(z.version>M)throw new Error(`Unsupported babylon environment map version "${z.version}". Latest supported version is "${M}".`);return 2===z.version?z:z={...z,version:2,imageType:g}}function h(z,u){const Y=(u=K(u)).iD;let H=Math.log2(u.width);if(H=Math.round(H)+1,Y.mipmaps.length!==6*H)throw new Error(`Unsupported specular mipmaps number "${Y.mipmaps.length}"`);const E=new Array(H);for(let J=0;J<H;J++){E[J]=new Array(6);for(let H=0;H<6;H++){const l=Y.mipmaps[6*J+H];E[J][H]=new Uint8Array(z.buffer,z.byteOffset+u.binaryDataPosition+l.position,l.length)}}return E}function o(z,u){var Y;u=K(u);const H=new Array(6),E=null===(Y=u.irradiance)||void 0===Y?void 0:Y.irradianceTexture;if(E){if(6!==E.faces.length)throw new Error(`Incorrect irradiance texture faces number "${E.faces.length}"`);for(let Y=0;Y<6;Y++){const J=E.faces[Y];H[Y]=new Uint8Array(z.buffer,z.byteOffset+u.binaryDataPosition+J.position,J.length)}}return H}function d(z,u,Y){var H;const J=(Y=K(Y)).iD;if(!J)return Promise.resolve([]);z._lodGenerationScale=J.lodGenerationScale;const l=[],T=h(u,Y);l.push(W(z,T,Y.imageType));const b=null===(H=Y.irradiance)||void 0===H?void 0:H.irradianceTexture;if(b){var L,D;const H=o(u,Y);let J=null;null!==(L=Y.irradiance)&&void 0!==L&&null!==(D=L.irradianceTexture)&&void 0!==D&&D.dominantDirection&&(J=E.p.Nl(Y.irradiance.irradianceTexture.dominantDirection)),l.push(Z(z,H,b.size,Y.imageType,J))}return Promise.all(l)}async function t(z,u,Y,H,E,J,l,T,b,L,D){return await new Promise(((g,M)=>{if(Y){const Y=u.createTexture(null,!0,!0,null,1,null,(z=>{M(z)}),z);null===H||void 0===H||H.onEffectCreatedObservable.addOnce((T=>{T.executeWhenCompiled((()=>{H.externalTextureSamplerBinding=!0,H.onApply=H=>{H._bindTexture("textureSampler",Y),H.setFloat2("scale",1,u._features.needsInvertingBitmap&&z instanceof ImageBitmap?-1:1)},u.scenes.length&&(u.scenes[0].postProcessManager.directRender([H],L,!0,J,l),u.restoreDefaultFramebuffer(),Y.dispose(),URL.revokeObjectURL(E),g())}))}))}else{if(u._uploadImageToTexture(D,z,J,l),T){const Y=b[l];Y&&u._uploadImageToTexture(Y._texture,z,J,0)}g()}}))}async function W(z,u){let Y=arguments.length>2&&void 0!==arguments[2]?arguments[2]:g;const H=z.getEngine();z.format=5,z.type=0,z.generateMipMaps=!0,z._cachedAnisotropicFilteringLevel=null,H.updateTextureSamplingMode(3,z),await s(z,u,!0,Y),z.isReady=!0}async function Z(z,u,Y){let H=arguments.length>3&&void 0!==arguments[3]?arguments[3]:g,E=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const J=z.getEngine(),l=new T.d(J,5),L=new b.c(J,l);z._irradianceTexture=L,L._dominantDirection=E,l.isCube=!0,l.format=5,l.type=0,l.generateMipMaps=!0,l._cachedAnisotropicFilteringLevel=null,l.generateMipMaps=!0,l.width=Y,l.height=Y,J.updateTextureSamplingMode(3,l),await s(l,[u],!1,H),J.generateMipMapsForCubemap(l),l.isReady=!0}async function s(z,u,E){let l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:g;if(!H.e.IsExponentOfTwo(z.width))throw new Error("Texture size must be a power of two");const D=(0,J.ILog2)(z.width)+1,M=z.getEngine();let q=!1,C=!1,K=null,h=null,o=null;const d=M.getCaps();d.textureLOD?M._features.supportRenderAndCopyToLodForFloatTextures?d.textureHalfFloatRender&&d.textureHalfFloatLinearFiltering?(q=!0,z.type=2):d.textureFloatRender&&d.textureFloatLinearFiltering&&(q=!0,z.type=1):q=!1:(q=!1,C=E);let W=0;if(q)M.isWebGPU?(W=1,await Y.e(21).then(Y.bind(Y,13297))):await Y.e(14).then(Y.bind(Y,13305)),K=new L.e("rgbdDecode","rgbdDecode",null,null,1,null,3,M,!1,void 0,z.type,void 0,null,!1,void 0,W),z._isRGBD=!1,z.invertY=!1,h=M.createRenderTargetCubeTexture(z.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:z.type,format:5});else if(z._isRGBD=!0,z.invertY=!0,C){const u=3;o={};const Y=z._lodGenerationScale,H=z._lodGenerationOffset;for(let E=0;E<u;E++){const J=(D-1)*Y+H,l=H+(J-H)*(1-E/(u-1)),L=Math.round(Math.min(Math.max(l,0),J)),g=new T.d(M,2);g.isCube=!0,g.invertY=!0,g.generateMipMaps=!1,M.updateTextureSamplingMode(2,g);const q=new b.c(null);switch(q._isCube=!0,q._texture=g,o[L]=q,E){case 0:z._lodTextureLow=q;break;case 1:z._lodTextureMid=q;break;case 2:z._lodTextureHigh=q}}}const Z=[];for(let Y=0;Y<u.length;Y++)for(let H=0;H<6;H++){const E=u[Y][H],J=new Blob([E],{type:l}),T=URL.createObjectURL(J);let b;if(M._features.forceBitmapOverHTMLImageElement)b=M.createImageBitmap(J,{premultiplyAlpha:"none"}).then((async u=>await t(u,M,q,K,T,H,Y,C,o,h,z)));else{const u=new Image;u.src=T,b=new Promise(((E,J)=>{u.onload=()=>{t(u,M,q,K,T,H,Y,C,o,h,z).then((()=>E())).catch((z=>{J(z)}))},u.onerror=z=>{J(z)}}))}Z.push(b)}if(await Promise.all(Z),u.length<D){let Y;const H=Math.pow(2,D-1-u.length),E=H*H*4;switch(z.type){case 0:Y=new Uint8Array(E);break;case 2:Y=new Uint16Array(E);break;case 1:Y=new Float32Array(E)}for(let J=u.length;J<D;J++)for(let u=0;u<6;u++){var s;M._uploadArrayBufferViewToTexture((null===(s=h)||void 0===s?void 0:s.texture)||z,Y,u,J)}}if(h){const u=z._irradianceTexture;z._irradianceTexture=null,M._releaseTexture(z),h._swapAndDie(z),z._irradianceTexture=u}K&&K.dispose(),C&&(z._lodTextureHigh&&z._lodTextureHigh._texture&&(z._lodTextureHigh._texture.isReady=!0),z._lodTextureMid&&z._lodTextureMid._texture&&(z._lodTextureMid._texture.isReady=!0),z._lodTextureLow&&z._lodTextureLow._texture&&(z._lodTextureLow._texture.isReady=!0))}function v(z,u){const Y=(u=K(u)).irradiance;if(!Y)return;const H=new l.h;E.p.FromArrayToRef(Y.x,0,H.x),E.p.FromArrayToRef(Y.y,0,H.y),E.p.FromArrayToRef(Y.z,0,H.z),E.p.FromArrayToRef(Y.xx,0,H.xx),E.p.FromArrayToRef(Y.yy,0,H.yy),E.p.FromArrayToRef(Y.zz,0,H.zz),E.p.FromArrayToRef(Y.yz,0,H.yz),E.p.FromArrayToRef(Y.zx,0,H.zx),E.p.FromArrayToRef(Y.xy,0,H.xy),z._sphericalPolynomial=H}function i(z,u,Y,H,E){const J=W(z.getEngine().createRawCubeTexture(null,z.width,z.format,z.type,z.generateMipMaps,z.invertY,z.samplingMode,z._compression),u).then((()=>z));return z.onRebuildCallback=z=>({proxy:J,isReady:!0,isAsync:!0}),z._source=13,z._bufferViewArrayArray=u,z._lodGenerationScale=H,z._lodGenerationOffset=E,z._sphericalPolynomial=Y,W(z,u).then((()=>(z.isReady=!0,z)))}}}]);