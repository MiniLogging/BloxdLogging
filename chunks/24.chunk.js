"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[24],{12828:(w,p,e)=>{e.d(p,{d:()=>K,h:()=>O,i:()=>i,j:()=>t});var r=e(11071),I=e(11023),d=e(11063),f=e(11475),q=e(11161),E=e(11494),j=(e(11590),e(11530)),X=e(11081);e(11577),e(11555),e(11681);const k="image/png",m=2,J=[134,22,135,150,246,214,150,54];function K(w){const p=new DataView(w.buffer,w.byteOffset,w.byteLength);let e=0;for(let f=0;f<J.length;f++)if(p.getUint8(e++)!==J[f])return X.c.Error("Not a babylon environment map"),null;let r="",I=0;for(;I=p.getUint8(e++);)r+=String.fromCharCode(I);let d=JSON.parse(r);return d=y(d),d.binaryDataPosition=e,d.PX&&(d.PX.lodGenerationScale=d.PX.lodGenerationScale||.8),d}function y(w){if(w.version>m)throw new Error(`Unsupported babylon environment map version "${w.version}". Latest supported version is "${m}".`);return 2===w.version?w:w={...w,version:2,imageType:k}}function c(w,p){const e=(p=y(p)).PX;let r=Math.log2(p.width);if(r=Math.round(r)+1,e.mipmaps.length!==6*r)throw new Error(`Unsupported specular mipmaps number "${e.mipmaps.length}"`);const I=new Array(r);for(let d=0;d<r;d++){I[d]=new Array(6);for(let r=0;r<6;r++){const f=e.mipmaps[6*d+r];I[d][r]=new Uint8Array(w.buffer,w.byteOffset+p.binaryDataPosition+f.position,f.length)}}return I}function s(w,p){var e;p=y(p);const r=new Array(6),I=null===(e=p.irradiance)||void 0===e?void 0:e.irradianceTexture;if(I){if(6!==I.faces.length)throw new Error(`Incorrect irradiance texture faces number "${I.faces.length}"`);for(let e=0;e<6;e++){const d=I.faces[e];r[e]=new Uint8Array(w.buffer,w.byteOffset+p.binaryDataPosition+d.position,d.length)}}return r}function O(w,p,e){var r;const d=(e=y(e)).PX;if(!d)return Promise.resolve([]);w._lodGenerationScale=d.lodGenerationScale;const f=[],q=c(p,e);f.push(A(w,q,e.imageType));const E=null===(r=e.irradiance)||void 0===r?void 0:r.irradianceTexture;if(E){var j,X;const r=s(p,e);let d=null;null!==(j=e.irradiance)&&void 0!==j&&null!==(X=j.irradianceTexture)&&void 0!==X&&X.dominantDirection&&(d=I.k.Ve(e.irradiance.irradianceTexture.dominantDirection)),f.push(z(w,r,E.size,e.imageType,d))}return Promise.all(f)}async function a(w,p,e,r,I,d,f,q,E,j,X){return await new Promise(((k,m)=>{if(e){const e=p.createTexture(null,!0,!0,null,1,null,(w=>{m(w)}),w);null===r||void 0===r||r.onEffectCreatedObservable.addOnce((q=>{q.executeWhenCompiled((()=>{r.externalTextureSamplerBinding=!0,r.onApply=r=>{r._bindTexture("textureSampler",e),r.setFloat2("scale",1,p._features.needsInvertingBitmap&&w instanceof ImageBitmap?-1:1)},p.scenes.length&&(p.scenes[0].postProcessManager.directRender([r],j,!0,d,f),p.restoreDefaultFramebuffer(),e.dispose(),URL.revokeObjectURL(I),k())}))}))}else{if(p._uploadImageToTexture(X,w,d,f),q){const e=E[f];e&&p._uploadImageToTexture(e._texture,w,d,0)}k()}}))}async function A(w,p){let e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:k;const r=w.getEngine();w.format=5,w.type=0,w.generateMipMaps=!0,w._cachedAnisotropicFilteringLevel=null,r.updateTextureSamplingMode(3,w),await M(w,p,!0,e),w.isReady=!0}async function z(w,p,e){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:k,I=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const d=w.getEngine(),f=new q.d(d,5),j=new E.b(d,f);w._irradianceTexture=j,j._dominantDirection=I,f.isCube=!0,f.format=5,f.type=0,f.generateMipMaps=!0,f._cachedAnisotropicFilteringLevel=null,f.generateMipMaps=!0,f.width=e,f.height=e,d.updateTextureSamplingMode(3,f),await M(f,[p],!1,r),d.generateMipMapsForCubemap(f),f.isReady=!0}async function M(w,p,I){let f=arguments.length>3&&void 0!==arguments[3]?arguments[3]:k;if(!r.g.IsExponentOfTwo(w.width))throw new Error("Texture size must be a power of two");const X=(0,d.ILog2)(w.width)+1,m=w.getEngine();let J=!1,K=!1,y=null,c=null,s=null;const O=m.getCaps();O.textureLOD?m._features.supportRenderAndCopyToLodForFloatTextures?O.textureHalfFloatRender&&O.textureHalfFloatLinearFiltering?(J=!0,w.type=2):O.textureFloatRender&&O.textureFloatLinearFiltering&&(J=!0,w.type=1):J=!1:(J=!1,K=I);let A=0;if(J)m.isWebGPU?(A=1,await e.e(21).then(e.bind(e,13728))):await e.e(14).then(e.bind(e,13731)),y=new j.b("rgbdDecode","rgbdDecode",null,null,1,null,3,m,!1,void 0,w.type,void 0,null,!1,void 0,A),w._isRGBD=!1,w.invertY=!1,c=m.createRenderTargetCubeTexture(w.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:w.type,format:5});else if(w._isRGBD=!0,w.invertY=!0,K){const p=3;s={};const e=w._lodGenerationScale,r=w._lodGenerationOffset;for(let I=0;I<p;I++){const d=(X-1)*e+r,f=r+(d-r)*(1-I/(p-1)),j=Math.round(Math.min(Math.max(f,0),d)),k=new q.d(m,2);k.isCube=!0,k.invertY=!0,k.generateMipMaps=!1,m.updateTextureSamplingMode(2,k);const J=new E.b(null);switch(J._isCube=!0,J._texture=k,s[j]=J,I){case 0:w._lodTextureLow=J;break;case 1:w._lodTextureMid=J;break;case 2:w._lodTextureHigh=J}}}const z=[];for(let e=0;e<p.length;e++)for(let r=0;r<6;r++){const I=p[e][r],d=new Blob([I],{type:f}),q=URL.createObjectURL(d);let E;if(m._features.forceBitmapOverHTMLImageElement)E=m.createImageBitmap(d,{premultiplyAlpha:"none"}).then((async p=>await a(p,m,J,y,q,r,e,K,s,c,w)));else{const p=new Image;p.src=q,E=new Promise(((I,d)=>{p.onload=()=>{a(p,m,J,y,q,r,e,K,s,c,w).then((()=>I())).catch((w=>{d(w)}))},p.onerror=w=>{d(w)}}))}z.push(E)}if(await Promise.all(z),p.length<X){let e;const r=Math.pow(2,X-1-p.length),I=r*r*4;switch(w.type){case 0:e=new Uint8Array(I);break;case 2:e=new Uint16Array(I);break;case 1:e=new Float32Array(I)}for(let d=p.length;d<X;d++)for(let p=0;p<6;p++){var M;m._uploadArrayBufferViewToTexture((null===(M=c)||void 0===M?void 0:M.texture)||w,e,p,d)}}if(c){const p=w._irradianceTexture;w._irradianceTexture=null,m._releaseTexture(w),c._swapAndDie(w),w._irradianceTexture=p}y&&y.dispose(),K&&(w._lodTextureHigh&&w._lodTextureHigh._texture&&(w._lodTextureHigh._texture.isReady=!0),w._lodTextureMid&&w._lodTextureMid._texture&&(w._lodTextureMid._texture.isReady=!0),w._lodTextureLow&&w._lodTextureLow._texture&&(w._lodTextureLow._texture.isReady=!0))}function i(w,p){const e=(p=y(p)).irradiance;if(!e)return;const r=new f.h;I.k.FromArrayToRef(e.x,0,r.x),I.k.FromArrayToRef(e.y,0,r.y),I.k.FromArrayToRef(e.z,0,r.z),I.k.FromArrayToRef(e.xx,0,r.xx),I.k.FromArrayToRef(e.yy,0,r.yy),I.k.FromArrayToRef(e.zz,0,r.zz),I.k.FromArrayToRef(e.yz,0,r.yz),I.k.FromArrayToRef(e.zx,0,r.zx),I.k.FromArrayToRef(e.xy,0,r.xy),w._sphericalPolynomial=r}function t(w,p,e,r,I){const d=A(w.getEngine().createRawCubeTexture(null,w.width,w.format,w.type,w.generateMipMaps,w.invertY,w.samplingMode,w._compression),p).then((()=>w));return w.onRebuildCallback=w=>({proxy:d,isReady:!0,isAsync:!0}),w._source=13,w._bufferViewArrayArray=p,w._lodGenerationScale=r,w._lodGenerationOffset=I,w._sphericalPolynomial=e,A(w,p).then((()=>(w.isReady=!0,w)))}}}]);