"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[24],{12605:(q,c,U)=>{U.d(c,{e:()=>H,i:()=>a,m:()=>C,q:()=>i});var J=U(10879),Q=U(10833),s=U(10870),g=U(11258),X=U(10976),n=U(11280),W=(U(11364),U(11309)),D=U(10886);U(11346),U(11337),U(11441);const u="image/png",K=2,r=[134,22,135,150,246,214,150,54];function H(q){const c=new DataView(q.buffer,q.byteOffset,q.byteLength);let U=0;for(let g=0;g<r.length;g++)if(c.getUint8(U++)!==r[g])return D.c.Error("Not a babylon environment map"),null;let J="",Q=0;for(;Q=c.getUint8(U++);)J+=String.fromCharCode(Q);let s=JSON.parse(J);return s=b(s),s.binaryDataPosition=U,s.bD&&(s.bD.lodGenerationScale=s.bD.lodGenerationScale||.8),s}function b(q){if(q.version>K)throw new Error(`Unsupported babylon environment map version "${q.version}". Latest supported version is "${K}".`);return 2===q.version?q:q={...q,version:2,imageType:u}}function h(q,c){const U=(c=b(c)).bD;let J=Math.log2(c.width);if(J=Math.round(J)+1,U.mipmaps.length!==6*J)throw new Error(`Unsupported specular mipmaps number "${U.mipmaps.length}"`);const Q=new Array(J);for(let s=0;s<J;s++){Q[s]=new Array(6);for(let J=0;J<6;J++){const g=U.mipmaps[6*s+J];Q[s][J]=new Uint8Array(q.buffer,q.byteOffset+c.binaryDataPosition+g.position,g.length)}}return Q}function o(q,c){var U;c=b(c);const J=new Array(6),Q=null===(U=c.irradiance)||void 0===U?void 0:U.irradianceTexture;if(Q){if(6!==Q.faces.length)throw new Error(`Incorrect irradiance texture faces number "${Q.faces.length}"`);for(let U=0;U<6;U++){const s=Q.faces[U];J[U]=new Uint8Array(q.buffer,q.byteOffset+c.binaryDataPosition+s.position,s.length)}}return J}function a(q,c,U){var J;const s=(U=b(U)).bD;if(!s)return Promise.resolve([]);q._lodGenerationScale=s.lodGenerationScale;const g=[],X=h(c,U);g.push(R(q,X,U.imageType));const n=null===(J=U.irradiance)||void 0===J?void 0:J.irradianceTexture;if(n){var W,D;const J=o(c,U);let s=null;null!==(W=U.irradiance)&&void 0!==W&&null!==(D=W.irradianceTexture)&&void 0!==D&&D.dominantDirection&&(s=Q.p.Ic(U.irradiance.irradianceTexture.dominantDirection)),g.push(I(q,J,n.size,U.imageType,s))}return Promise.all(g)}async function p(q,c,U,J,Q,s,g,X,n,W,D){return await new Promise(((u,K)=>{if(U){const U=c.createTexture(null,!0,!0,null,1,null,(q=>{K(q)}),q);null===J||void 0===J||J.onEffectCreatedObservable.addOnce((X=>{X.executeWhenCompiled((()=>{J.externalTextureSamplerBinding=!0,J.onApply=J=>{J._bindTexture("textureSampler",U),J.setFloat2("scale",1,c._features.needsInvertingBitmap&&q instanceof ImageBitmap?-1:1)},c.scenes.length&&(c.scenes[0].postProcessManager.directRender([J],W,!0,s,g),c.restoreDefaultFramebuffer(),U.dispose(),URL.revokeObjectURL(Q),u())}))}))}else{if(c._uploadImageToTexture(D,q,s,g),X){const U=n[g];U&&c._uploadImageToTexture(U._texture,q,s,0)}u()}}))}async function R(q,c){let U=arguments.length>2&&void 0!==arguments[2]?arguments[2]:u;const J=q.getEngine();q.format=5,q.type=0,q.generateMipMaps=!0,q._cachedAnisotropicFilteringLevel=null,J.updateTextureSamplingMode(3,q),await t(q,c,!0,U),q.isReady=!0}async function I(q,c,U){let J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:u,Q=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const s=q.getEngine(),g=new X.e(s,5),W=new n.b(s,g);q._irradianceTexture=W,W._dominantDirection=Q,g.isCube=!0,g.format=5,g.type=0,g.generateMipMaps=!0,g._cachedAnisotropicFilteringLevel=null,g.generateMipMaps=!0,g.width=U,g.height=U,s.updateTextureSamplingMode(3,g),await t(g,[c],!1,J),s.generateMipMapsForCubemap(g),g.isReady=!0}async function t(q,c,Q){let g=arguments.length>3&&void 0!==arguments[3]?arguments[3]:u;if(!J.e.IsExponentOfTwo(q.width))throw new Error("Texture size must be a power of two");const D=(0,s.ILog2)(q.width)+1,K=q.getEngine();let r=!1,H=!1,b=null,h=null,o=null;const a=K.getCaps();a.textureLOD?K._features.supportRenderAndCopyToLodForFloatTextures?a.textureHalfFloatRender&&a.textureHalfFloatLinearFiltering?(r=!0,q.type=2):a.textureFloatRender&&a.textureFloatLinearFiltering&&(r=!0,q.type=1):r=!1:(r=!1,H=Q);let R=0;if(r)K.isWebGPU?(R=1,await U.e(21).then(U.bind(U,13463))):await U.e(14).then(U.bind(U,13467)),b=new W.b("rgbdDecode","rgbdDecode",null,null,1,null,3,K,!1,void 0,q.type,void 0,null,!1,void 0,R),q._isRGBD=!1,q.invertY=!1,h=K.createRenderTargetCubeTexture(q.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:q.type,format:5});else if(q._isRGBD=!0,q.invertY=!0,H){const c=3;o={};const U=q._lodGenerationScale,J=q._lodGenerationOffset;for(let Q=0;Q<c;Q++){const s=(D-1)*U+J,g=J+(s-J)*(1-Q/(c-1)),W=Math.round(Math.min(Math.max(g,0),s)),u=new X.e(K,2);u.isCube=!0,u.invertY=!0,u.generateMipMaps=!1,K.updateTextureSamplingMode(2,u);const r=new n.b(null);switch(r._isCube=!0,r._texture=u,o[W]=r,Q){case 0:q._lodTextureLow=r;break;case 1:q._lodTextureMid=r;break;case 2:q._lodTextureHigh=r}}}const I=[];for(let U=0;U<c.length;U++)for(let J=0;J<6;J++){const Q=c[U][J],s=new Blob([Q],{type:g}),X=URL.createObjectURL(s);let n;if(K._features.forceBitmapOverHTMLImageElement)n=K.createImageBitmap(s,{premultiplyAlpha:"none"}).then((async c=>await p(c,K,r,b,X,J,U,H,o,h,q)));else{const c=new Image;c.src=X,n=new Promise(((Q,s)=>{c.onload=()=>{p(c,K,r,b,X,J,U,H,o,h,q).then((()=>Q())).catch((q=>{s(q)}))},c.onerror=q=>{s(q)}}))}I.push(n)}if(await Promise.all(I),c.length<D){let U;const J=Math.pow(2,D-1-c.length),Q=J*J*4;switch(q.type){case 0:U=new Uint8Array(Q);break;case 2:U=new Uint16Array(Q);break;case 1:U=new Float32Array(Q)}for(let s=c.length;s<D;s++)for(let c=0;c<6;c++){var t;K._uploadArrayBufferViewToTexture((null===(t=h)||void 0===t?void 0:t.texture)||q,U,c,s)}}if(h){const c=q._irradianceTexture;q._irradianceTexture=null,K._releaseTexture(q),h._swapAndDie(q),q._irradianceTexture=c}b&&b.dispose(),H&&(q._lodTextureHigh&&q._lodTextureHigh._texture&&(q._lodTextureHigh._texture.isReady=!0),q._lodTextureMid&&q._lodTextureMid._texture&&(q._lodTextureMid._texture.isReady=!0),q._lodTextureLow&&q._lodTextureLow._texture&&(q._lodTextureLow._texture.isReady=!0))}function C(q,c){const U=(c=b(c)).irradiance;if(!U)return;const J=new g.f;Q.p.FromArrayToRef(U.x,0,J.x),Q.p.FromArrayToRef(U.y,0,J.y),Q.p.FromArrayToRef(U.z,0,J.z),Q.p.FromArrayToRef(U.xx,0,J.xx),Q.p.FromArrayToRef(U.yy,0,J.yy),Q.p.FromArrayToRef(U.zz,0,J.zz),Q.p.FromArrayToRef(U.yz,0,J.yz),Q.p.FromArrayToRef(U.zx,0,J.zx),Q.p.FromArrayToRef(U.xy,0,J.xy),q._sphericalPolynomial=J}function i(q,c,U,J,Q){const s=R(q.getEngine().createRawCubeTexture(null,q.width,q.format,q.type,q.generateMipMaps,q.invertY,q.samplingMode,q._compression),c).then((()=>q));return q.onRebuildCallback=q=>({proxy:s,isReady:!0,isAsync:!0}),q._source=13,q._bufferViewArrayArray=c,q._lodGenerationScale=J,q._lodGenerationOffset=Q,q._sphericalPolynomial=U,R(q,c).then((()=>(q.isReady=!0,q)))}}}]);