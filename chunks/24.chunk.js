"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[24],{12663:(q,f,j)=>{j.d(f,{b:()=>D,f:()=>N,g:()=>e,h:()=>Z});var d=j(10992),g=j(10941),h=j(10985),L=j(11389),Q=j(11090),H=j(11417),r=(j(11506),j(11457)),u=j(11005);j(11497),j(11476),j(11578);const X="image/png",z=2,B=[134,22,135,150,246,214,150,54];function D(q){const f=new DataView(q.buffer,q.byteOffset,q.byteLength);let j=0;for(let L=0;L<B.length;L++)if(f.getUint8(j++)!==B[L])return u.e.Error("Not a babylon environment map"),null;let d="",g=0;for(;g=f.getUint8(j++);)d+=String.fromCharCode(g);let h=JSON.parse(d);return h=i(h),h.binaryDataPosition=j,h.bu&&(h.bu.lodGenerationScale=h.bu.lodGenerationScale||.8),h}function i(q){if(q.version>z)throw new Error(`Unsupported babylon environment map version "${q.version}". Latest supported version is "${z}".`);return 2===q.version?q:q={...q,version:2,imageType:X}}function t(q,f){const j=(f=i(f)).bu;let d=Math.log2(f.width);if(d=Math.round(d)+1,j.mipmaps.length!==6*d)throw new Error(`Unsupported specular mipmaps number "${j.mipmaps.length}"`);const g=new Array(d);for(let h=0;h<d;h++){g[h]=new Array(6);for(let d=0;d<6;d++){const L=j.mipmaps[6*h+d];g[h][d]=new Uint8Array(q.buffer,q.byteOffset+f.binaryDataPosition+L.position,L.length)}}return g}function O(q,f){var j;f=i(f);const d=new Array(6),g=null===(j=f.irradiance)||void 0===j?void 0:j.irradianceTexture;if(g){if(6!==g.faces.length)throw new Error(`Incorrect irradiance texture faces number "${g.faces.length}"`);for(let j=0;j<6;j++){const h=g.faces[j];d[j]=new Uint8Array(q.buffer,q.byteOffset+f.binaryDataPosition+h.position,h.length)}}return d}function N(q,f,j){var d;const h=(j=i(j)).bu;if(!h)return Promise.resolve([]);q._lodGenerationScale=h.lodGenerationScale;const L=[],Q=t(f,j);L.push(E(q,Q,j.imageType));const H=null===(d=j.irradiance)||void 0===d?void 0:d.irradianceTexture;if(H){var r,u;const d=O(f,j);let h=null;null!==(r=j.irradiance)&&void 0!==r&&null!==(u=r.irradianceTexture)&&void 0!==u&&u.dominantDirection&&(h=g.j.Pf(j.irradiance.irradianceTexture.dominantDirection)),L.push(s(q,d,H.size,j.imageType,h))}return Promise.all(L)}async function w(q,f,j,d,g,h,L,Q,H,r,u){return await new Promise(((X,z)=>{if(j){const j=f.createTexture(null,!0,!0,null,1,null,(q=>{z(q)}),q);null===d||void 0===d||d.onEffectCreatedObservable.addOnce((Q=>{Q.executeWhenCompiled((()=>{d.externalTextureSamplerBinding=!0,d.onApply=d=>{d._bindTexture("textureSampler",j),d.setFloat2("scale",1,f._features.needsInvertingBitmap&&q instanceof ImageBitmap?-1:1)},f.scenes.length&&(f.scenes[0].postProcessManager.directRender([d],r,!0,h,L),f.restoreDefaultFramebuffer(),j.dispose(),URL.revokeObjectURL(g),X())}))}))}else{if(f._uploadImageToTexture(u,q,h,L),Q){const j=H[L];j&&f._uploadImageToTexture(j._texture,q,h,0)}X()}}))}async function E(q,f){let j=arguments.length>2&&void 0!==arguments[2]?arguments[2]:X;const d=q.getEngine();q.format=5,q.type=0,q.generateMipMaps=!0,q._cachedAnisotropicFilteringLevel=null,d.updateTextureSamplingMode(3,q),await S(q,f,!0,j),q.isReady=!0}async function s(q,f,j){let d=arguments.length>3&&void 0!==arguments[3]?arguments[3]:X,g=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const h=q.getEngine(),L=new Q.c(h,5),r=new H.b(h,L);q._irradianceTexture=r,r._dominantDirection=g,L.isCube=!0,L.format=5,L.type=0,L.generateMipMaps=!0,L._cachedAnisotropicFilteringLevel=null,L.generateMipMaps=!0,L.width=j,L.height=j,h.updateTextureSamplingMode(3,L),await S(L,[f],!1,d),h.generateMipMapsForCubemap(L),L.isReady=!0}async function S(q,f,g){let L=arguments.length>3&&void 0!==arguments[3]?arguments[3]:X;if(!d.h.IsExponentOfTwo(q.width))throw new Error("Texture size must be a power of two");const u=(0,h.ILog2)(q.width)+1,z=q.getEngine();let B=!1,D=!1,i=null,t=null,O=null;const N=z.getCaps();N.textureLOD?z._features.supportRenderAndCopyToLodForFloatTextures?N.textureHalfFloatRender&&N.textureHalfFloatLinearFiltering?(B=!0,q.type=2):N.textureFloatRender&&N.textureFloatLinearFiltering&&(B=!0,q.type=1):B=!1:(B=!1,D=g);let E=0;if(B)z.isWebGPU?(E=1,await j.e(21).then(j.bind(j,13515))):await j.e(14).then(j.bind(j,13519)),i=new r.c("rgbdDecode","rgbdDecode",null,null,1,null,3,z,!1,void 0,q.type,void 0,null,!1,void 0,E),q._isRGBD=!1,q.invertY=!1,t=z.createRenderTargetCubeTexture(q.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:q.type,format:5});else if(q._isRGBD=!0,q.invertY=!0,D){const f=3;O={};const j=q._lodGenerationScale,d=q._lodGenerationOffset;for(let g=0;g<f;g++){const h=(u-1)*j+d,L=d+(h-d)*(1-g/(f-1)),r=Math.round(Math.min(Math.max(L,0),h)),X=new Q.c(z,2);X.isCube=!0,X.invertY=!0,X.generateMipMaps=!1,z.updateTextureSamplingMode(2,X);const B=new H.b(null);switch(B._isCube=!0,B._texture=X,O[r]=B,g){case 0:q._lodTextureLow=B;break;case 1:q._lodTextureMid=B;break;case 2:q._lodTextureHigh=B}}}const s=[];for(let j=0;j<f.length;j++)for(let d=0;d<6;d++){const g=f[j][d],h=new Blob([g],{type:L}),Q=URL.createObjectURL(h);let H;if(z._features.forceBitmapOverHTMLImageElement)H=z.createImageBitmap(h,{premultiplyAlpha:"none"}).then((async f=>await w(f,z,B,i,Q,d,j,D,O,t,q)));else{const f=new Image;f.src=Q,H=new Promise(((g,h)=>{f.onload=()=>{w(f,z,B,i,Q,d,j,D,O,t,q).then((()=>g())).catch((q=>{h(q)}))},f.onerror=q=>{h(q)}}))}s.push(H)}if(await Promise.all(s),f.length<u){let j;const d=Math.pow(2,u-1-f.length),g=d*d*4;switch(q.type){case 0:j=new Uint8Array(g);break;case 2:j=new Uint16Array(g);break;case 1:j=new Float32Array(g)}for(let h=f.length;h<u;h++)for(let f=0;f<6;f++){var S;z._uploadArrayBufferViewToTexture((null===(S=t)||void 0===S?void 0:S.texture)||q,j,f,h)}}if(t){const f=q._irradianceTexture;q._irradianceTexture=null,z._releaseTexture(q),t._swapAndDie(q),q._irradianceTexture=f}i&&i.dispose(),D&&(q._lodTextureHigh&&q._lodTextureHigh._texture&&(q._lodTextureHigh._texture.isReady=!0),q._lodTextureMid&&q._lodTextureMid._texture&&(q._lodTextureMid._texture.isReady=!0),q._lodTextureLow&&q._lodTextureLow._texture&&(q._lodTextureLow._texture.isReady=!0))}function e(q,f){const j=(f=i(f)).irradiance;if(!j)return;const d=new L.f;g.j.FromArrayToRef(j.x,0,d.x),g.j.FromArrayToRef(j.y,0,d.y),g.j.FromArrayToRef(j.z,0,d.z),g.j.FromArrayToRef(j.xx,0,d.xx),g.j.FromArrayToRef(j.yy,0,d.yy),g.j.FromArrayToRef(j.zz,0,d.zz),g.j.FromArrayToRef(j.yz,0,d.yz),g.j.FromArrayToRef(j.zx,0,d.zx),g.j.FromArrayToRef(j.xy,0,d.xy),q._sphericalPolynomial=d}function Z(q,f,j,d,g){const h=E(q.getEngine().createRawCubeTexture(null,q.width,q.format,q.type,q.generateMipMaps,q.invertY,q.samplingMode,q._compression),f).then((()=>q));return q.onRebuildCallback=q=>({proxy:h,isReady:!0,isAsync:!0}),q._source=13,q._bufferViewArrayArray=f,q._lodGenerationScale=d,q._lodGenerationOffset=g,q._sphericalPolynomial=j,E(q,f).then((()=>(q.isReady=!0,q)))}}}]);