"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[24],{12623:(h,d,m)=>{m.d(d,{b:()=>R,c:()=>V,d:()=>y,e:()=>i});var j=m(11107),A=m(11058),b=m(11099),w=m(11516),a=m(11216),D=m(11534),S=(m(11604),m(11559)),M=m(11121);m(11598),m(11582),m(11675);const q="image/png",E=2,I=[134,22,135,150,246,214,150,54];function R(h){const d=new DataView(h.buffer,h.byteOffset,h.byteLength);let m=0;for(let w=0;w<I.length;w++)if(d.getUint8(m++)!==I[w])return M.c.Error("Not a babylon environment map"),null;let j="",A=0;for(;A=d.getUint8(m++);)j+=String.fromCharCode(A);let b=JSON.parse(j);return b=Z(b),b.binaryDataPosition=m,b.TM&&(b.TM.lodGenerationScale=b.TM.lodGenerationScale||.8),b}function Z(h){if(h.version>E)throw new Error(`Unsupported babylon environment map version "${h.version}". Latest supported version is "${E}".`);return 2===h.version?h:h={...h,version:2,imageType:q}}function L(h,d){const m=(d=Z(d)).TM;let j=Math.log2(d.width);if(j=Math.round(j)+1,m.mipmaps.length!==6*j)throw new Error(`Unsupported specular mipmaps number "${m.mipmaps.length}"`);const A=new Array(j);for(let b=0;b<j;b++){A[b]=new Array(6);for(let j=0;j<6;j++){const w=m.mipmaps[6*b+j];A[b][j]=new Uint8Array(h.buffer,h.byteOffset+d.binaryDataPosition+w.position,w.length)}}return A}function B(h,d){var m;d=Z(d);const j=new Array(6),A=null===(m=d.irradiance)||void 0===m?void 0:m.irradianceTexture;if(A){if(6!==A.faces.length)throw new Error(`Incorrect irradiance texture faces number "${A.faces.length}"`);for(let m=0;m<6;m++){const b=A.faces[m];j[m]=new Uint8Array(h.buffer,h.byteOffset+d.binaryDataPosition+b.position,b.length)}}return j}function V(h,d,m){var j;const b=(m=Z(m)).TM;if(!b)return Promise.resolve([]);h._lodGenerationScale=b.lodGenerationScale;const w=[],a=L(d,m);w.push(C(h,a,m.imageType));const D=null===(j=m.irradiance)||void 0===j?void 0:j.irradianceTexture;if(D){var S,M;const j=B(d,m);let b=null;null!==(S=m.irradiance)&&void 0!==S&&null!==(M=S.irradianceTexture)&&void 0!==M&&M.dominantDirection&&(b=A.i.Ud(m.irradiance.irradianceTexture.dominantDirection)),w.push(T(h,j,D.size,m.imageType,b))}return Promise.all(w)}async function v(h,d,m,j,A,b,w,a,D,S,M){return await new Promise(((q,E)=>{if(m){const m=d.createTexture(null,!0,!0,null,1,null,(h=>{E(h)}),h);null===j||void 0===j||j.onEffectCreatedObservable.addOnce((a=>{a.executeWhenCompiled((()=>{j.externalTextureSamplerBinding=!0,j.onApply=j=>{j._bindTexture("textureSampler",m),j.setFloat2("scale",1,d._features.needsInvertingBitmap&&h instanceof ImageBitmap?-1:1)},d.scenes.length&&(d.scenes[0].postProcessManager.directRender([j],S,!0,b,w),d.restoreDefaultFramebuffer(),m.dispose(),URL.revokeObjectURL(A),q())}))}))}else{if(d._uploadImageToTexture(M,h,b,w),a){const m=D[w];m&&d._uploadImageToTexture(m._texture,h,b,0)}q()}}))}async function C(h,d){let m=arguments.length>2&&void 0!==arguments[2]?arguments[2]:q;const j=h.getEngine();h.format=5,h.type=0,h.generateMipMaps=!0,h._cachedAnisotropicFilteringLevel=null,j.updateTextureSamplingMode(3,h),await o(h,d,!0,m),h.isReady=!0}async function T(h,d,m){let j=arguments.length>3&&void 0!==arguments[3]?arguments[3]:q,A=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const b=h.getEngine(),w=new a.c(b,5),S=new D.b(b,w);h._irradianceTexture=S,S._dominantDirection=A,w.isCube=!0,w.format=5,w.type=0,w.generateMipMaps=!0,w._cachedAnisotropicFilteringLevel=null,w.generateMipMaps=!0,w.width=m,w.height=m,b.updateTextureSamplingMode(3,w),await o(w,[d],!1,j),b.generateMipMapsForCubemap(w),w.isReady=!0}async function o(h,d,A){let w=arguments.length>3&&void 0!==arguments[3]?arguments[3]:q;if(!j.e.IsExponentOfTwo(h.width))throw new Error("Texture size must be a power of two");const M=(0,b.ILog2)(h.width)+1,E=h.getEngine();let I=!1,R=!1,Z=null,L=null,B=null;const V=E.getCaps();V.textureLOD?E._features.supportRenderAndCopyToLodForFloatTextures?V.textureHalfFloatRender&&V.textureHalfFloatLinearFiltering?(I=!0,h.type=2):V.textureFloatRender&&V.textureFloatLinearFiltering&&(I=!0,h.type=1):I=!1:(I=!1,R=A);let C=0;if(I)E.isWebGPU?(C=1,await m.e(21).then(m.bind(m,13424))):await m.e(14).then(m.bind(m,13433)),Z=new S.e("rgbdDecode","rgbdDecode",null,null,1,null,3,E,!1,void 0,h.type,void 0,null,!1,void 0,C),h._isRGBD=!1,h.invertY=!1,L=E.createRenderTargetCubeTexture(h.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:h.type,format:5});else if(h._isRGBD=!0,h.invertY=!0,R){const d=3;B={};const m=h._lodGenerationScale,j=h._lodGenerationOffset;for(let A=0;A<d;A++){const b=(M-1)*m+j,w=j+(b-j)*(1-A/(d-1)),S=Math.round(Math.min(Math.max(w,0),b)),q=new a.c(E,2);q.isCube=!0,q.invertY=!0,q.generateMipMaps=!1,E.updateTextureSamplingMode(2,q);const I=new D.b(null);switch(I._isCube=!0,I._texture=q,B[S]=I,A){case 0:h._lodTextureLow=I;break;case 1:h._lodTextureMid=I;break;case 2:h._lodTextureHigh=I}}}const T=[];for(let m=0;m<d.length;m++)for(let j=0;j<6;j++){const A=d[m][j],b=new Blob([A],{type:w}),a=URL.createObjectURL(b);let D;if(E._features.forceBitmapOverHTMLImageElement)D=E.createImageBitmap(b,{premultiplyAlpha:"none"}).then((async d=>await v(d,E,I,Z,a,j,m,R,B,L,h)));else{const d=new Image;d.src=a,D=new Promise(((A,b)=>{d.onload=()=>{v(d,E,I,Z,a,j,m,R,B,L,h).then((()=>A())).catch((h=>{b(h)}))},d.onerror=h=>{b(h)}}))}T.push(D)}if(await Promise.all(T),d.length<M){let m;const j=Math.pow(2,M-1-d.length),A=j*j*4;switch(h.type){case 0:m=new Uint8Array(A);break;case 2:m=new Uint16Array(A);break;case 1:m=new Float32Array(A)}for(let b=d.length;b<M;b++)for(let d=0;d<6;d++){var o;E._uploadArrayBufferViewToTexture((null===(o=L)||void 0===o?void 0:o.texture)||h,m,d,b)}}if(L){const d=h._irradianceTexture;h._irradianceTexture=null,E._releaseTexture(h),L._swapAndDie(h),h._irradianceTexture=d}Z&&Z.dispose(),R&&(h._lodTextureHigh&&h._lodTextureHigh._texture&&(h._lodTextureHigh._texture.isReady=!0),h._lodTextureMid&&h._lodTextureMid._texture&&(h._lodTextureMid._texture.isReady=!0),h._lodTextureLow&&h._lodTextureLow._texture&&(h._lodTextureLow._texture.isReady=!0))}function y(h,d){const m=(d=Z(d)).irradiance;if(!m)return;const j=new w.d;A.i.FromArrayToRef(m.x,0,j.x),A.i.FromArrayToRef(m.y,0,j.y),A.i.FromArrayToRef(m.z,0,j.z),A.i.FromArrayToRef(m.xx,0,j.xx),A.i.FromArrayToRef(m.yy,0,j.yy),A.i.FromArrayToRef(m.zz,0,j.zz),A.i.FromArrayToRef(m.yz,0,j.yz),A.i.FromArrayToRef(m.zx,0,j.zx),A.i.FromArrayToRef(m.xy,0,j.xy),h._sphericalPolynomial=j}function i(h,d,m,j,A){const b=C(h.getEngine().createRawCubeTexture(null,h.width,h.format,h.type,h.generateMipMaps,h.invertY,h.samplingMode,h._compression),d).then((()=>h));return h.onRebuildCallback=h=>({proxy:b,isReady:!0,isAsync:!0}),h._source=13,h._bufferViewArrayArray=d,h._lodGenerationScale=j,h._lodGenerationOffset=A,h._sphericalPolynomial=m,C(h,d).then((()=>(h.isReady=!0,h)))}}}]);