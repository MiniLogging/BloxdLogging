"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[24],{12781:(Z,c,L)=>{L.d(c,{b:()=>x,c:()=>M,d:()=>X,f:()=>h});var k=L(11038),N=L(10993),R=L(11032),G=L(11461),V=L(11139),p=L(11487),J=(L(11588),L(11528)),z=L(11052);L(11574),L(11556),L(11674);const i="image/png",t=2,E=[134,22,135,150,246,214,150,54];function x(Z){const c=new DataView(Z.buffer,Z.byteOffset,Z.byteLength);let L=0;for(let G=0;G<E.length;G++)if(c.getUint8(L++)!==E[G])return z.e.Error("Not a babylon environment map"),null;let k="",N=0;for(;N=c.getUint8(L++);)k+=String.fromCharCode(N);let R=JSON.parse(k);return R=q(R),R.binaryDataPosition=L,R.YJ&&(R.YJ.lodGenerationScale=R.YJ.lodGenerationScale||.8),R}function q(Z){if(Z.version>t)throw new Error(`Unsupported babylon environment map version "${Z.version}". Latest supported version is "${t}".`);return 2===Z.version?Z:Z={...Z,version:2,imageType:i}}function O(Z,c){const L=(c=q(c)).YJ;let k=Math.log2(c.width);if(k=Math.round(k)+1,L.mipmaps.length!==6*k)throw new Error(`Unsupported specular mipmaps number "${L.mipmaps.length}"`);const N=new Array(k);for(let R=0;R<k;R++){N[R]=new Array(6);for(let k=0;k<6;k++){const G=L.mipmaps[6*R+k];N[R][k]=new Uint8Array(Z.buffer,Z.byteOffset+c.binaryDataPosition+G.position,G.length)}}return N}function w(Z,c){var L;c=q(c);const k=new Array(6),N=null===(L=c.irradiance)||void 0===L?void 0:L.irradianceTexture;if(N){if(6!==N.faces.length)throw new Error(`Incorrect irradiance texture faces number "${N.faces.length}"`);for(let L=0;L<6;L++){const R=N.faces[L];k[L]=new Uint8Array(Z.buffer,Z.byteOffset+c.binaryDataPosition+R.position,R.length)}}return k}function M(Z,c,L){var k;const R=(L=q(L)).YJ;if(!R)return Promise.resolve([]);Z._lodGenerationScale=R.lodGenerationScale;const G=[],V=O(c,L);G.push(j(Z,V,L.imageType));const p=null===(k=L.irradiance)||void 0===k?void 0:k.irradianceTexture;if(p){var J,z;const k=w(c,L);let R=null;null!==(J=L.irradiance)&&void 0!==J&&null!==(z=J.irradianceTexture)&&void 0!==z&&z.dominantDirection&&(R=N.h.oc(L.irradiance.irradianceTexture.dominantDirection)),G.push(o(Z,k,p.size,L.imageType,R))}return Promise.all(G)}async function P(Z,c,L,k,N,R,G,V,p,J,z){return await new Promise(((i,t)=>{if(L){const L=c.createTexture(null,!0,!0,null,1,null,(Z=>{t(Z)}),Z);null===k||void 0===k||k.onEffectCreatedObservable.addOnce((V=>{V.executeWhenCompiled((()=>{k.externalTextureSamplerBinding=!0,k.onApply=k=>{k._bindTexture("textureSampler",L),k.setFloat2("scale",1,c._features.needsInvertingBitmap&&Z instanceof ImageBitmap?-1:1)},c.scenes.length&&(c.scenes[0].postProcessManager.directRender([k],J,!0,R,G),c.restoreDefaultFramebuffer(),L.dispose(),URL.revokeObjectURL(N),i())}))}))}else{if(c._uploadImageToTexture(z,Z,R,G),V){const L=p[G];L&&c._uploadImageToTexture(L._texture,Z,R,0)}i()}}))}async function j(Z,c){let L=arguments.length>2&&void 0!==arguments[2]?arguments[2]:i;const k=Z.getEngine();Z.format=5,Z.type=0,Z.generateMipMaps=!0,Z._cachedAnisotropicFilteringLevel=null,k.updateTextureSamplingMode(3,Z),await u(Z,c,!0,L),Z.isReady=!0}async function o(Z,c,L){let k=arguments.length>3&&void 0!==arguments[3]?arguments[3]:i,N=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const R=Z.getEngine(),G=new V.e(R,5),J=new p.d(R,G);Z._irradianceTexture=J,J._dominantDirection=N,G.isCube=!0,G.format=5,G.type=0,G.generateMipMaps=!0,G._cachedAnisotropicFilteringLevel=null,G.generateMipMaps=!0,G.width=L,G.height=L,R.updateTextureSamplingMode(3,G),await u(G,[c],!1,k),R.generateMipMapsForCubemap(G),G.isReady=!0}async function u(Z,c,N){let G=arguments.length>3&&void 0!==arguments[3]?arguments[3]:i;if(!k.c.IsExponentOfTwo(Z.width))throw new Error("Texture size must be a power of two");const z=(0,R.ILog2)(Z.width)+1,t=Z.getEngine();let E=!1,x=!1,q=null,O=null,w=null;const M=t.getCaps();M.textureLOD?t._features.supportRenderAndCopyToLodForFloatTextures?M.textureHalfFloatRender&&M.textureHalfFloatLinearFiltering?(E=!0,Z.type=2):M.textureFloatRender&&M.textureFloatLinearFiltering&&(E=!0,Z.type=1):E=!1:(E=!1,x=N);let j=0;if(E)t.isWebGPU?(j=1,await L.e(21).then(L.bind(L,13673))):await L.e(14).then(L.bind(L,13681)),q=new J.d("rgbdDecode","rgbdDecode",null,null,1,null,3,t,!1,void 0,Z.type,void 0,null,!1,void 0,j),Z._isRGBD=!1,Z.invertY=!1,O=t.createRenderTargetCubeTexture(Z.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:Z.type,format:5});else if(Z._isRGBD=!0,Z.invertY=!0,x){const c=3;w={};const L=Z._lodGenerationScale,k=Z._lodGenerationOffset;for(let N=0;N<c;N++){const R=(z-1)*L+k,G=k+(R-k)*(1-N/(c-1)),J=Math.round(Math.min(Math.max(G,0),R)),i=new V.e(t,2);i.isCube=!0,i.invertY=!0,i.generateMipMaps=!1,t.updateTextureSamplingMode(2,i);const E=new p.d(null);switch(E._isCube=!0,E._texture=i,w[J]=E,N){case 0:Z._lodTextureLow=E;break;case 1:Z._lodTextureMid=E;break;case 2:Z._lodTextureHigh=E}}}const o=[];for(let L=0;L<c.length;L++)for(let k=0;k<6;k++){const N=c[L][k],R=new Blob([N],{type:G}),V=URL.createObjectURL(R);let p;if(t._features.forceBitmapOverHTMLImageElement)p=t.createImageBitmap(R,{premultiplyAlpha:"none"}).then((async c=>await P(c,t,E,q,V,k,L,x,w,O,Z)));else{const c=new Image;c.src=V,p=new Promise(((N,R)=>{c.onload=()=>{P(c,t,E,q,V,k,L,x,w,O,Z).then((()=>N())).catch((Z=>{R(Z)}))},c.onerror=Z=>{R(Z)}}))}o.push(p)}if(await Promise.all(o),c.length<z){let L;const k=Math.pow(2,z-1-c.length),N=k*k*4;switch(Z.type){case 0:L=new Uint8Array(N);break;case 2:L=new Uint16Array(N);break;case 1:L=new Float32Array(N)}for(let R=c.length;R<z;R++)for(let c=0;c<6;c++){var u;t._uploadArrayBufferViewToTexture((null===(u=O)||void 0===u?void 0:u.texture)||Z,L,c,R)}}if(O){const c=Z._irradianceTexture;Z._irradianceTexture=null,t._releaseTexture(Z),O._swapAndDie(Z),Z._irradianceTexture=c}q&&q.dispose(),x&&(Z._lodTextureHigh&&Z._lodTextureHigh._texture&&(Z._lodTextureHigh._texture.isReady=!0),Z._lodTextureMid&&Z._lodTextureMid._texture&&(Z._lodTextureMid._texture.isReady=!0),Z._lodTextureLow&&Z._lodTextureLow._texture&&(Z._lodTextureLow._texture.isReady=!0))}function X(Z,c){const L=(c=q(c)).irradiance;if(!L)return;const k=new G.d;N.h.FromArrayToRef(L.x,0,k.x),N.h.FromArrayToRef(L.y,0,k.y),N.h.FromArrayToRef(L.z,0,k.z),N.h.FromArrayToRef(L.xx,0,k.xx),N.h.FromArrayToRef(L.yy,0,k.yy),N.h.FromArrayToRef(L.zz,0,k.zz),N.h.FromArrayToRef(L.yz,0,k.yz),N.h.FromArrayToRef(L.zx,0,k.zx),N.h.FromArrayToRef(L.xy,0,k.xy),Z._sphericalPolynomial=k}function h(Z,c,L,k,N){const R=j(Z.getEngine().createRawCubeTexture(null,Z.width,Z.format,Z.type,Z.generateMipMaps,Z.invertY,Z.samplingMode,Z._compression),c).then((()=>Z));return Z.onRebuildCallback=Z=>({proxy:R,isReady:!0,isAsync:!0}),Z._source=13,Z._bufferViewArrayArray=c,Z._lodGenerationScale=k,Z._lodGenerationOffset=N,Z._sphericalPolynomial=L,j(Z,c).then((()=>(Z.isReady=!0,Z)))}}}]);