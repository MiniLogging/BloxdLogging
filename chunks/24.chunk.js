"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[24],{12738:(s,Z,o)=>{o.d(Z,{c:()=>Y,d:()=>d,e:()=>i,i:()=>N});var t=o(10938),j=o(10900),S=o(10935),a=o(11367),O=o(11044),v=o(11393),G=(o(11493),o(11433)),B=o(10955);o(11482),o(11460),o(11576);const Q="image/png",D=2,z=[134,22,135,150,246,214,150,54];function Y(s){const Z=new DataView(s.buffer,s.byteOffset,s.byteLength);let o=0;for(let a=0;a<z.length;a++)if(Z.getUint8(o++)!==z[a])return B.b.Error("Not a babylon environment map"),null;let t="",j=0;for(;j=Z.getUint8(o++);)t+=String.fromCharCode(j);let S=JSON.parse(t);return S=b(S),S.binaryDataPosition=o,S.CG&&(S.CG.lodGenerationScale=S.CG.lodGenerationScale||.8),S}function b(s){if(s.version>D)throw new Error(`Unsupported babylon environment map version "${s.version}". Latest supported version is "${D}".`);return 2===s.version?s:s={...s,version:2,imageType:Q}}function f(s,Z){const o=(Z=b(Z)).CG;let t=Math.log2(Z.width);if(t=Math.round(t)+1,o.mipmaps.length!==6*t)throw new Error(`Unsupported specular mipmaps number "${o.mipmaps.length}"`);const j=new Array(t);for(let S=0;S<t;S++){j[S]=new Array(6);for(let t=0;t<6;t++){const a=o.mipmaps[6*S+t];j[S][t]=new Uint8Array(s.buffer,s.byteOffset+Z.binaryDataPosition+a.position,a.length)}}return j}function A(s,Z){var o;Z=b(Z);const t=new Array(6),j=null===(o=Z.irradiance)||void 0===o?void 0:o.irradianceTexture;if(j){if(6!==j.faces.length)throw new Error(`Incorrect irradiance texture faces number "${j.faces.length}"`);for(let o=0;o<6;o++){const S=j.faces[o];t[o]=new Uint8Array(s.buffer,s.byteOffset+Z.binaryDataPosition+S.position,S.length)}}return t}function d(s,Z,o){var t;const S=(o=b(o)).CG;if(!S)return Promise.resolve([]);s._lodGenerationScale=S.lodGenerationScale;const a=[],O=f(Z,o);a.push(u(s,O,o.imageType));const v=null===(t=o.irradiance)||void 0===t?void 0:t.irradianceTexture;if(v){var G,B;const t=A(Z,o);let S=null;null!==(G=o.irradiance)&&void 0!==G&&null!==(B=G.irradianceTexture)&&void 0!==B&&B.dominantDirection&&(S=j.n.oO(o.irradiance.irradianceTexture.dominantDirection)),a.push(H(s,t,v.size,o.imageType,S))}return Promise.all(a)}async function U(s,Z,o,t,j,S,a,O,v,G,B){return await new Promise(((Q,D)=>{if(o){const o=Z.createTexture(null,!0,!0,null,1,null,(s=>{D(s)}),s);null===t||void 0===t||t.onEffectCreatedObservable.addOnce((O=>{O.executeWhenCompiled((()=>{t.externalTextureSamplerBinding=!0,t.onApply=t=>{t._bindTexture("textureSampler",o),t.setFloat2("scale",1,Z._features.needsInvertingBitmap&&s instanceof ImageBitmap?-1:1)},Z.scenes.length&&(Z.scenes[0].postProcessManager.directRender([t],G,!0,S,a),Z.restoreDefaultFramebuffer(),o.dispose(),URL.revokeObjectURL(j),Q())}))}))}else{if(Z._uploadImageToTexture(B,s,S,a),O){const o=v[a];o&&Z._uploadImageToTexture(o._texture,s,S,0)}Q()}}))}async function u(s,Z){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Q;const t=s.getEngine();s.format=5,s.type=0,s.generateMipMaps=!0,s._cachedAnisotropicFilteringLevel=null,t.updateTextureSamplingMode(3,s),await F(s,Z,!0,o),s.isReady=!0}async function H(s,Z,o){let t=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Q,j=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const S=s.getEngine(),a=new O.b(S,5),G=new v.b(S,a);s._irradianceTexture=G,G._dominantDirection=j,a.isCube=!0,a.format=5,a.type=0,a.generateMipMaps=!0,a._cachedAnisotropicFilteringLevel=null,a.generateMipMaps=!0,a.width=o,a.height=o,S.updateTextureSamplingMode(3,a),await F(a,[Z],!1,t),S.generateMipMapsForCubemap(a),a.isReady=!0}async function F(s,Z,j){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Q;if(!t.g.IsExponentOfTwo(s.width))throw new Error("Texture size must be a power of two");const B=(0,S.ILog2)(s.width)+1,D=s.getEngine();let z=!1,Y=!1,b=null,f=null,A=null;const d=D.getCaps();d.textureLOD?D._features.supportRenderAndCopyToLodForFloatTextures?d.textureHalfFloatRender&&d.textureHalfFloatLinearFiltering?(z=!0,s.type=2):d.textureFloatRender&&d.textureFloatLinearFiltering&&(z=!0,s.type=1):z=!1:(z=!1,Y=j);let u=0;if(z)D.isWebGPU?(u=1,await o.e(21).then(o.bind(o,13583))):await o.e(14).then(o.bind(o,13590)),b=new G.d("rgbdDecode","rgbdDecode",null,null,1,null,3,D,!1,void 0,s.type,void 0,null,!1,void 0,u),s._isRGBD=!1,s.invertY=!1,f=D.createRenderTargetCubeTexture(s.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:s.type,format:5});else if(s._isRGBD=!0,s.invertY=!0,Y){const Z=3;A={};const o=s._lodGenerationScale,t=s._lodGenerationOffset;for(let j=0;j<Z;j++){const S=(B-1)*o+t,a=t+(S-t)*(1-j/(Z-1)),G=Math.round(Math.min(Math.max(a,0),S)),Q=new O.b(D,2);Q.isCube=!0,Q.invertY=!0,Q.generateMipMaps=!1,D.updateTextureSamplingMode(2,Q);const z=new v.b(null);switch(z._isCube=!0,z._texture=Q,A[G]=z,j){case 0:s._lodTextureLow=z;break;case 1:s._lodTextureMid=z;break;case 2:s._lodTextureHigh=z}}}const H=[];for(let o=0;o<Z.length;o++)for(let t=0;t<6;t++){const j=Z[o][t],S=new Blob([j],{type:a}),O=URL.createObjectURL(S);let v;if(D._features.forceBitmapOverHTMLImageElement)v=D.createImageBitmap(S,{premultiplyAlpha:"none"}).then((async Z=>await U(Z,D,z,b,O,t,o,Y,A,f,s)));else{const Z=new Image;Z.src=O,v=new Promise(((j,S)=>{Z.onload=()=>{U(Z,D,z,b,O,t,o,Y,A,f,s).then((()=>j())).catch((s=>{S(s)}))},Z.onerror=s=>{S(s)}}))}H.push(v)}if(await Promise.all(H),Z.length<B){let o;const t=Math.pow(2,B-1-Z.length),j=t*t*4;switch(s.type){case 0:o=new Uint8Array(j);break;case 2:o=new Uint16Array(j);break;case 1:o=new Float32Array(j)}for(let S=Z.length;S<B;S++)for(let Z=0;Z<6;Z++){var F;D._uploadArrayBufferViewToTexture((null===(F=f)||void 0===F?void 0:F.texture)||s,o,Z,S)}}if(f){const Z=s._irradianceTexture;s._irradianceTexture=null,D._releaseTexture(s),f._swapAndDie(s),s._irradianceTexture=Z}b&&b.dispose(),Y&&(s._lodTextureHigh&&s._lodTextureHigh._texture&&(s._lodTextureHigh._texture.isReady=!0),s._lodTextureMid&&s._lodTextureMid._texture&&(s._lodTextureMid._texture.isReady=!0),s._lodTextureLow&&s._lodTextureLow._texture&&(s._lodTextureLow._texture.isReady=!0))}function i(s,Z){const o=(Z=b(Z)).irradiance;if(!o)return;const t=new a.h;j.n.FromArrayToRef(o.x,0,t.x),j.n.FromArrayToRef(o.y,0,t.y),j.n.FromArrayToRef(o.z,0,t.z),j.n.FromArrayToRef(o.xx,0,t.xx),j.n.FromArrayToRef(o.yy,0,t.yy),j.n.FromArrayToRef(o.zz,0,t.zz),j.n.FromArrayToRef(o.yz,0,t.yz),j.n.FromArrayToRef(o.zx,0,t.zx),j.n.FromArrayToRef(o.xy,0,t.xy),s._sphericalPolynomial=t}function N(s,Z,o,t,j){const S=u(s.getEngine().createRawCubeTexture(null,s.width,s.format,s.type,s.generateMipMaps,s.invertY,s.samplingMode,s._compression),Z).then((()=>s));return s.onRebuildCallback=s=>({proxy:S,isReady:!0,isAsync:!0}),s._source=13,s._bufferViewArrayArray=Z,s._lodGenerationScale=t,s._lodGenerationOffset=j,s._sphericalPolynomial=o,u(s,Z).then((()=>(s.isReady=!0,s)))}}}]);