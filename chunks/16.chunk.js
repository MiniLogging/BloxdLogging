"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[16],{12925:(O,f,y)=>{y.r(f),y.d(f,{_KTXTextureLoader:()=>I});var S=y(11017);class H{constructor(O,f){if(this.data=O,this.isInvalid=!1,!H.IsValid(O))return this.isInvalid=!0,void S.e.Error("texture missing KTX identifier");const y=Uint32Array.BYTES_PER_ELEMENT,b=new DataView(this.data.buffer,this.data.byteOffset+12,13*y),h=67305985===b.getUint32(0,!0);return this.glType=b.getUint32(1*y,h),this.glTypeSize=b.getUint32(2*y,h),this.glFormat=b.getUint32(3*y,h),this.glInternalFormat=b.getUint32(4*y,h),this.glBaseInternalFormat=b.getUint32(5*y,h),this.pixelWidth=b.getUint32(6*y,h),this.pixelHeight=b.getUint32(7*y,h),this.pixelDepth=b.getUint32(8*y,h),this.numberOfArrayElements=b.getUint32(9*y,h),this.numberOfFaces=b.getUint32(10*y,h),this.numberOfMipmapLevels=b.getUint32(11*y,h),this.bytesOfKeyValueData=b.getUint32(12*y,h),0!==this.glType?(S.e.Error("only compressed formats currently supported"),void(this.isInvalid=!0)):(this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels),0===this.pixelHeight||0!==this.pixelDepth?(S.e.Error("only 2D textures currently supported"),void(this.isInvalid=!0)):0!==this.numberOfArrayElements?(S.e.Error("texture arrays not currently supported"),void(this.isInvalid=!0)):this.numberOfFaces!==f?(S.e.Error("number of faces expected"+f+", but found "+this.numberOfFaces),void(this.isInvalid=!0)):void(this.loadType=H.COMPRESSED_2D))}uploadLevels(O,f){switch(this.loadType){case H.COMPRESSED_2D:this._upload2DCompressedLevels(O,f);case H.TEX_2D:case H.COMPRESSED_3D:case H.TEX_3D:}}_upload2DCompressedLevels(O,f){let y=H.HEADER_LEN+this.bytesOfKeyValueData,S=this.pixelWidth,b=this.pixelHeight;const h=f?this.numberOfMipmapLevels:1;for(let H=0;H<h;H++){const f=new Int32Array(this.data.buffer,this.data.byteOffset+y,1)[0];y+=4;for(let h=0;h<this.numberOfFaces;h++){const v=new Uint8Array(this.data.buffer,this.data.byteOffset+y,f);O.getEngine()._uploadCompressedDataToTextureDirectly(O,O.format,S,b,v,h,H),y+=f,y+=3-(f+3)%4}S=Math.max(1,.5*S),b=Math.max(1,.5*b)}}static IsValid(O){if(O.byteLength>=12){const f=new Uint8Array(O.buffer,O.byteOffset,12);if(171===f[0]&&75===f[1]&&84===f[2]&&88===f[3]&&32===f[4]&&49===f[5]&&49===f[6]&&187===f[7]&&13===f[8]&&10===f[9]&&26===f[10]&&10===f[11])return!0}return!1}}H.HEADER_LEN=64,H.COMPRESSED_2D=0,H.COMPRESSED_3D=1,H.TEX_2D=2,H.TEX_3D=3;var b,h,v,N=y(12283),m=y(10995);function t(O,f){const y=(null===f||void 0===f?void 0:f.jsDecoderModule)||KTX2DECODER;O&&(O.wasmUASTCToASTC&&(y.LiteTranscoder_UASTC_ASTC.WasmModuleURL=O.wasmUASTCToASTC),O.wasmUASTCToBC7&&(y.LiteTranscoder_UASTC_BC7.WasmModuleURL=O.wasmUASTCToBC7),O.wasmUASTCToRGBA_UNORM&&(y.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=O.wasmUASTCToRGBA_UNORM),O.wasmUASTCToRGBA_SRGB&&(y.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=O.wasmUASTCToRGBA_SRGB),O.wasmUASTCToR8_UNORM&&(y.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=O.wasmUASTCToR8_UNORM),O.wasmUASTCToRG8_UNORM&&(y.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=O.wasmUASTCToRG8_UNORM),O.jsMSCTranscoder&&(y.MSCTranscoder.JSModuleURL=O.jsMSCTranscoder),O.wasmMSCTranscoder&&(y.MSCTranscoder.WasmModuleURL=O.wasmMSCTranscoder),O.wasmZSTDDecoder&&(y.ZSTDDecoder.WasmModuleURL=O.wasmZSTDDecoder)),f&&(f.wasmUASTCToASTC&&(y.LiteTranscoder_UASTC_ASTC.WasmBinary=f.wasmUASTCToASTC),f.wasmUASTCToBC7&&(y.LiteTranscoder_UASTC_BC7.WasmBinary=f.wasmUASTCToBC7),f.wasmUASTCToRGBA_UNORM&&(y.LiteTranscoder_UASTC_RGBA_UNORM.WasmBinary=f.wasmUASTCToRGBA_UNORM),f.wasmUASTCToRGBA_SRGB&&(y.LiteTranscoder_UASTC_RGBA_SRGB.WasmBinary=f.wasmUASTCToRGBA_SRGB),f.wasmUASTCToR8_UNORM&&(y.LiteTranscoder_UASTC_R8_UNORM.WasmBinary=f.wasmUASTCToR8_UNORM),f.wasmUASTCToRG8_UNORM&&(y.LiteTranscoder_UASTC_RG8_UNORM.WasmBinary=f.wasmUASTCToRG8_UNORM),f.jsMSCTranscoder&&(y.MSCTranscoder.JSModule=f.jsMSCTranscoder),f.wasmMSCTranscoder&&(y.MSCTranscoder.WasmBinary=f.wasmMSCTranscoder),f.wasmZSTDDecoder&&(y.ZSTDDecoder.WasmBinary=f.wasmZSTDDecoder))}function q(O){let f;"undefined"===typeof O&&"undefined"!==typeof KTX2DECODER&&(O=KTX2DECODER),onmessage=y=>{if(y.data)switch(y.data.action){case"init":{const S=y.data.urls;S&&(S.jsDecoderModule&&"undefined"===typeof O&&(importScripts(S.jsDecoderModule),O=KTX2DECODER),t(S)),y.data.wasmBinaries&&t(void 0,{...y.data.wasmBinaries,jsDecoderModule:O}),f=new O.KTX2Decoder,postMessage({action:"init"});break}case"setDefaultDecoderOptions":O.KTX2Decoder.DefaultDecoderOptions=y.data.options;break;case"decode":f.decode(y.data.data,y.data.caps,y.data.options).then((O=>{const f=[];for(let y=0;y<O.mipmaps.length;++y){const S=O.mipmaps[y];S&&S.data&&f.push(S.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:O},f)})).catch((O=>{postMessage({action:"decoded",success:!1,msg:O})}))}}}!function(O){O[O.ETC1S=0]="ETC1S",O[O.UASTC4x4=1]="UASTC4x4"}(b||(b={})),function(O){O[O.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",O[O.BC7_RGBA=1]="BC7_RGBA",O[O.BC3_RGBA=2]="BC3_RGBA",O[O.BC1_RGB=3]="BC1_RGB",O[O.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",O[O.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",O[O.ETC2_RGBA=6]="ETC2_RGBA",O[O.ETC1_RGB=7]="ETC1_RGB",O[O.RGBA32=8]="RGBA32",O[O.R8=9]="R8",O[O.RG8=10]="RG8"}(h||(h={})),function(O){O[O.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",O[O.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",O[O.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",O[O.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",O[O.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",O[O.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",O[O.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",O[O.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",O[O.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",O[O.RGBA8Format=32856]="RGBA8Format",O[O.R8Format=33321]="R8Format",O[O.RG8Format=33323]="RG8Format"}(v||(v={}));class F{static GetDefaultNumWorkers(){return"object"===typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static _Initialize(O){if(F._WorkerPoolPromise||F._DecoderModulePromise)return;const f={jsDecoderModule:m.d.GetBabylonScriptURL(this.URLConfig.jsDecoderModule,!0),wasmUASTCToASTC:m.d.GetBabylonScriptURL(this.URLConfig.wasmUASTCToASTC,!0),wasmUASTCToBC7:m.d.GetBabylonScriptURL(this.URLConfig.wasmUASTCToBC7,!0),wasmUASTCToRGBA_UNORM:m.d.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_UNORM,!0),wasmUASTCToRGBA_SRGB:m.d.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_SRGB,!0),wasmUASTCToR8_UNORM:m.d.GetBabylonScriptURL(this.URLConfig.wasmUASTCToR8_UNORM,!0),wasmUASTCToRG8_UNORM:m.d.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRG8_UNORM,!0),jsMSCTranscoder:m.d.GetBabylonScriptURL(this.URLConfig.jsMSCTranscoder,!0),wasmMSCTranscoder:m.d.GetBabylonScriptURL(this.URLConfig.wasmMSCTranscoder,!0),wasmZSTDDecoder:m.d.GetBabylonScriptURL(this.URLConfig.wasmZSTDDecoder,!0)};O&&"function"===typeof Worker&&"undefined"!==typeof URL?F._WorkerPoolPromise=new Promise((y=>{const S=`${t}(${q})()`,H=URL.createObjectURL(new Blob([S],{type:"application/javascript"}));y(new N.c(O,(()=>function(O,f,y){return new Promise(((S,H)=>{const b=f=>{O.removeEventListener("error",b),O.removeEventListener("message",h),H(f)},h=f=>{"init"===f.data.action&&(O.removeEventListener("error",b),O.removeEventListener("message",h),S(O))};O.addEventListener("error",b),O.addEventListener("message",h),O.postMessage({action:"init",urls:y,wasmBinaries:f})}))}(new Worker(H),void 0,f))))})):"undefined"===typeof F._KTX2DecoderModule?F._DecoderModulePromise=m.d.LoadBabylonScriptAsync(f.jsDecoderModule).then((()=>(F._KTX2DecoderModule=KTX2DECODER,F._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,F._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,t(f,F._KTX2DecoderModule),new F._KTX2DecoderModule.KTX2Decoder))):(F._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,F._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,F._DecoderModulePromise=Promise.resolve(new F._KTX2DecoderModule.KTX2Decoder))}constructor(O){let f=arguments.length>1&&void 0!==arguments[1]?arguments[1]:F.DefaultNumWorkers;this._engine=O;const y="object"===typeof f&&f.workerPool||F.WorkerPool;if(y)F._WorkerPoolPromise=Promise.resolve(y);else{var S;if("object"===typeof f)F._KTX2DecoderModule=null===f||void 0===f||null===(S=f.binariesAndModulesContainer)||void 0===S?void 0:S.jsDecoderModule;else"undefined"!==typeof KTX2DECODER&&(F._KTX2DecoderModule=KTX2DECODER);const O="number"===typeof f?f:f.numWorkers??F.DefaultNumWorkers;F._Initialize(O)}}_uploadAsync(O,f,y){const S=this._engine.getCaps(),H={astc:!!S.astc,bptc:!!S.bptc,s3tc:!!S.s3tc,pvrtc:!!S.pvrtc,etc2:!!S.etc2,etc1:!!S.etc1};if(F._WorkerPoolPromise)return F._WorkerPoolPromise.then((S=>new Promise(((b,h)=>{S.push(((S,v)=>{const N=O=>{S.removeEventListener("error",N),S.removeEventListener("message",m),h(O),v()},m=O=>{if("decoded"===O.data.action){if(S.removeEventListener("error",N),S.removeEventListener("message",m),O.data.success)try{this._createTexture(O.data.decodedData,f,y),b()}catch(H){h({message:H})}else h({message:O.data.msg});v()}};S.addEventListener("error",N),S.addEventListener("message",m),S.postMessage({action:"setDefaultDecoderOptions",options:F.DefaultDecoderOptions._getKTX2DecoderOptions()});const t=new Uint8Array(O.byteLength);t.set(new Uint8Array(O.buffer,O.byteOffset,O.byteLength)),S.postMessage({action:"decode",data:t,caps:H,options:y},[t.buffer])}))}))));if(F._DecoderModulePromise)return F._DecoderModulePromise.then((y=>(F.DefaultDecoderOptions.isDirty&&(F._KTX2DecoderModule.KTX2Decoder.DefaultDecoderOptions=F.DefaultDecoderOptions._getKTX2DecoderOptions()),new Promise(((H,b)=>{y.decode(O,S).then((O=>{this._createTexture(O,f),H()})).catch((O=>{b({message:O})}))})))));throw new Error("KTX2 decoder module is not available")}_createTexture(O,f,y){this._engine._bindTextureDirectly(3553,f),y&&(y.transcodedFormat=O.transcodedFormat,y.isInGammaSpace=O.isInGammaSpace,y.ke=O.ke,y.transcoderName=O.transcoderName);let S=!0;switch(O.transcodedFormat){case 32856:f.type=0,f.format=5;break;case 33321:f.type=0,f.format=6;break;case 33323:f.type=0,f.format=7;break;default:f.format=O.transcodedFormat,S=!1}if(f._gammaSpace=O.isInGammaSpace,f.generateMipMaps=O.mipmaps.length>1,O.errors)throw new Error("KTX2 container - could not transcode the data. "+O.errors);for(let H=0;H<O.mipmaps.length;++H){const y=O.mipmaps[H];if(!y||!y.data)throw new Error("KTX2 container - could not transcode one of the image");S?(f.width=y.width,f.height=y.height,this._engine._uploadDataToTextureDirectly(f,y.data,0,H,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(f,O.transcodedFormat,y.width,y.height,y.data,0,H)}f._extension=".ktx2",f.width=O.mipmaps[0].width,f.height=O.mipmaps[0].height,f.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static IsValid(O){if(O.byteLength>=12){const f=new Uint8Array(O.buffer,O.byteOffset,12);if(171===f[0]&&75===f[1]&&84===f[2]&&88===f[3]&&32===f[4]&&50===f[5]&&48===f[6]&&187===f[7]&&13===f[8]&&10===f[9]&&26===f[10]&&10===f[11])return!0}return!1}}F.URLConfig={jsDecoderModule:"https://cdn.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null},F.DefaultNumWorkers=F.GetDefaultNumWorkers(),F.DefaultDecoderOptions=new class{constructor(){this._isDirty=!0,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=!0,this._ktx2DecoderOptions={}}get isDirty(){return this._isDirty}get useRGBAIfASTCBC7NotAvailableWhenUASTC(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set useRGBAIfASTCBC7NotAvailableWhenUASTC(O){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==O&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=O,this._isDirty=!0)}get useRGBAIfOnlyBC1BC3AvailableWhenUASTC(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set useRGBAIfOnlyBC1BC3AvailableWhenUASTC(O){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==O&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=O,this._isDirty=!0)}get forceRGBA(){return this._forceRGBA}set forceRGBA(O){this._forceRGBA!==O&&(this._forceRGBA=O,this._isDirty=!0)}get forceR8(){return this._forceR8}set forceR8(O){this._forceR8!==O&&(this._forceR8=O,this._isDirty=!0)}get forceRG8(){return this._forceRG8}set forceRG8(O){this._forceRG8!==O&&(this._forceRG8=O,this._isDirty=!0)}get bypassTranscoders(){return this._bypassTranscoders}set bypassTranscoders(O){this._bypassTranscoders!==O&&(this._bypassTranscoders=O,this._isDirty=!0)}_getKTX2DecoderOptions(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=!1;const O={useRGBAIfASTCBC7NotAvailableWhenUASTC:this._useRGBAIfASTCBC7NotAvailableWhenUASTC,forceRGBA:this._forceRGBA,forceR8:this._forceR8,forceRG8:this._forceRG8,bypassTranscoders:this._bypassTranscoders};return this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(O.transcodeFormatDecisionTree={UASTC:{transcodeFormat:[h.BC1_RGB,h.BC3_RGBA],yes:{transcodeFormat:h.RGBA32,engineFormat:32856,roundToMultiple4:!1}}}),this._ktx2DecoderOptions=O,O}};class I{constructor(){this.supportCascades=!1}loadCubeData(O,f,y,S){if(Array.isArray(O))return;f._invertVScale=!f.invertY;const b=f.getEngine(),h=new H(O,6),v=h.numberOfMipmapLevels>1&&f.generateMipMaps;b._unpackFlipY(!0),h.uploadLevels(f,f.generateMipMaps),f.width=h.pixelWidth,f.height=h.pixelHeight,b._setCubeMapTextureParams(f,v,h.numberOfMipmapLevels-1),f.isReady=!0,f.onLoadedObservable.notifyObservers(f),f.onLoadedObservable.clear(),S&&S()}loadData(O,f,y,b){if(H.IsValid(O)){f._invertVScale=!f.invertY;const S=new H(O,1),b=function(O){switch(O){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}(S.glInternalFormat);b?(f.format=b,f._useSRGBBuffer=f.getEngine()._getUseSRGBBuffer(!0,f.generateMipMaps),f._gammaSpace=!0):f.format=S.glInternalFormat,y(S.pixelWidth,S.pixelHeight,f.generateMipMaps,!0,(()=>{S.uploadLevels(f,f.generateMipMaps)}),S.isInvalid)}else if(F.IsValid(O)){new F(f.getEngine())._uploadAsync(O,f,b).then((()=>{y(f.width,f.height,f.generateMipMaps,!0,(()=>{}),!1)}),(O=>{S.e.Warn(`Failed to load KTX2 texture data: ${O.message}`),y(0,0,!1,!1,(()=>{}),!0)}))}else S.e.Error("texture missing KTX identifier"),y(0,0,!1,!1,(()=>{}),!0)}}}}]);