"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[16],{12873:(V,O,Z)=>{Z.r(O),Z.d(O,{_KTXTextureLoader:()=>W});var d=Z(10914);class p{constructor(V,O){if(this.data=V,this.isInvalid=!1,!p.IsValid(V))return this.isInvalid=!0,void d.b.Error("texture missing KTX identifier");const Z=Uint32Array.BYTES_PER_ELEMENT,r=new DataView(this.data.buffer,this.data.byteOffset+12,13*Z),Y=67305985===r.getUint32(0,!0);return this.glType=r.getUint32(1*Z,Y),this.glTypeSize=r.getUint32(2*Z,Y),this.glFormat=r.getUint32(3*Z,Y),this.glInternalFormat=r.getUint32(4*Z,Y),this.glBaseInternalFormat=r.getUint32(5*Z,Y),this.pixelWidth=r.getUint32(6*Z,Y),this.pixelHeight=r.getUint32(7*Z,Y),this.pixelDepth=r.getUint32(8*Z,Y),this.numberOfArrayElements=r.getUint32(9*Z,Y),this.numberOfFaces=r.getUint32(10*Z,Y),this.numberOfMipmapLevels=r.getUint32(11*Z,Y),this.bytesOfKeyValueData=r.getUint32(12*Z,Y),0!==this.glType?(d.b.Error("only compressed formats currently supported"),void(this.isInvalid=!0)):(this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels),0===this.pixelHeight||0!==this.pixelDepth?(d.b.Error("only 2D textures currently supported"),void(this.isInvalid=!0)):0!==this.numberOfArrayElements?(d.b.Error("texture arrays not currently supported"),void(this.isInvalid=!0)):this.numberOfFaces!==O?(d.b.Error("number of faces expected"+O+", but found "+this.numberOfFaces),void(this.isInvalid=!0)):void(this.loadType=p.COMPRESSED_2D))}uploadLevels(V,O){switch(this.loadType){case p.COMPRESSED_2D:this._upload2DCompressedLevels(V,O);case p.TEX_2D:case p.COMPRESSED_3D:case p.TEX_3D:}}_upload2DCompressedLevels(V,O){let Z=p.HEADER_LEN+this.bytesOfKeyValueData,d=this.pixelWidth,r=this.pixelHeight;const Y=O?this.numberOfMipmapLevels:1;for(let p=0;p<Y;p++){const O=new Int32Array(this.data.buffer,this.data.byteOffset+Z,1)[0];Z+=4;for(let Y=0;Y<this.numberOfFaces;Y++){const m=new Uint8Array(this.data.buffer,this.data.byteOffset+Z,O);V.getEngine()._uploadCompressedDataToTextureDirectly(V,V.format,d,r,m,Y,p),Z+=O,Z+=3-(O+3)%4}d=Math.max(1,.5*d),r=Math.max(1,.5*r)}}static IsValid(V){if(V.byteLength>=12){const O=new Uint8Array(V.buffer,V.byteOffset,12);if(171===O[0]&&75===O[1]&&84===O[2]&&88===O[3]&&32===O[4]&&49===O[5]&&49===O[6]&&187===O[7]&&13===O[8]&&10===O[9]&&26===O[10]&&10===O[11])return!0}return!1}}p.HEADER_LEN=64,p.COMPRESSED_2D=0,p.COMPRESSED_3D=1,p.TEX_2D=2,p.TEX_3D=3;var r,Y,m,a=Z(12230),R=Z(10900);function i(V,O){const Z=(null===O||void 0===O?void 0:O.jsDecoderModule)||KTX2DECODER;V&&(V.wasmUASTCToASTC&&(Z.LiteTranscoder_UASTC_ASTC.WasmModuleURL=V.wasmUASTCToASTC),V.wasmUASTCToBC7&&(Z.LiteTranscoder_UASTC_BC7.WasmModuleURL=V.wasmUASTCToBC7),V.wasmUASTCToRGBA_UNORM&&(Z.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=V.wasmUASTCToRGBA_UNORM),V.wasmUASTCToRGBA_SRGB&&(Z.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=V.wasmUASTCToRGBA_SRGB),V.wasmUASTCToR8_UNORM&&(Z.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=V.wasmUASTCToR8_UNORM),V.wasmUASTCToRG8_UNORM&&(Z.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=V.wasmUASTCToRG8_UNORM),V.jsMSCTranscoder&&(Z.MSCTranscoder.JSModuleURL=V.jsMSCTranscoder),V.wasmMSCTranscoder&&(Z.MSCTranscoder.WasmModuleURL=V.wasmMSCTranscoder),V.wasmZSTDDecoder&&(Z.ZSTDDecoder.WasmModuleURL=V.wasmZSTDDecoder)),O&&(O.wasmUASTCToASTC&&(Z.LiteTranscoder_UASTC_ASTC.WasmBinary=O.wasmUASTCToASTC),O.wasmUASTCToBC7&&(Z.LiteTranscoder_UASTC_BC7.WasmBinary=O.wasmUASTCToBC7),O.wasmUASTCToRGBA_UNORM&&(Z.LiteTranscoder_UASTC_RGBA_UNORM.WasmBinary=O.wasmUASTCToRGBA_UNORM),O.wasmUASTCToRGBA_SRGB&&(Z.LiteTranscoder_UASTC_RGBA_SRGB.WasmBinary=O.wasmUASTCToRGBA_SRGB),O.wasmUASTCToR8_UNORM&&(Z.LiteTranscoder_UASTC_R8_UNORM.WasmBinary=O.wasmUASTCToR8_UNORM),O.wasmUASTCToRG8_UNORM&&(Z.LiteTranscoder_UASTC_RG8_UNORM.WasmBinary=O.wasmUASTCToRG8_UNORM),O.jsMSCTranscoder&&(Z.MSCTranscoder.JSModule=O.jsMSCTranscoder),O.wasmMSCTranscoder&&(Z.MSCTranscoder.WasmBinary=O.wasmMSCTranscoder),O.wasmZSTDDecoder&&(Z.ZSTDDecoder.WasmBinary=O.wasmZSTDDecoder))}function M(V){let O;"undefined"===typeof V&&"undefined"!==typeof KTX2DECODER&&(V=KTX2DECODER),onmessage=Z=>{if(Z.data)switch(Z.data.action){case"init":{const d=Z.data.urls;d&&(d.jsDecoderModule&&"undefined"===typeof V&&(importScripts(d.jsDecoderModule),V=KTX2DECODER),i(d)),Z.data.wasmBinaries&&i(void 0,{...Z.data.wasmBinaries,jsDecoderModule:V}),O=new V.KTX2Decoder,postMessage({action:"init"});break}case"setDefaultDecoderOptions":V.KTX2Decoder.DefaultDecoderOptions=Z.data.options;break;case"decode":O.decode(Z.data.data,Z.data.caps,Z.data.options).then((V=>{const O=[];for(let Z=0;Z<V.mipmaps.length;++Z){const d=V.mipmaps[Z];d&&d.data&&O.push(d.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:V},O)})).catch((V=>{postMessage({action:"decoded",success:!1,msg:V})}))}}}!function(V){V[V.ETC1S=0]="ETC1S",V[V.UASTC4x4=1]="UASTC4x4"}(r||(r={})),function(V){V[V.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",V[V.BC7_RGBA=1]="BC7_RGBA",V[V.BC3_RGBA=2]="BC3_RGBA",V[V.BC1_RGB=3]="BC1_RGB",V[V.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",V[V.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",V[V.ETC2_RGBA=6]="ETC2_RGBA",V[V.ETC1_RGB=7]="ETC1_RGB",V[V.RGBA32=8]="RGBA32",V[V.R8=9]="R8",V[V.RG8=10]="RG8"}(Y||(Y={})),function(V){V[V.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",V[V.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",V[V.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",V[V.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",V[V.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",V[V.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",V[V.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",V[V.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",V[V.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",V[V.RGBA8Format=32856]="RGBA8Format",V[V.R8Format=33321]="R8Format",V[V.RG8Format=33323]="RG8Format"}(m||(m={}));class c{static GetDefaultNumWorkers(){return"object"===typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static _Initialize(V){if(c._WorkerPoolPromise||c._DecoderModulePromise)return;const O={jsDecoderModule:R.e.GetBabylonScriptURL(this.URLConfig.jsDecoderModule,!0),wasmUASTCToASTC:R.e.GetBabylonScriptURL(this.URLConfig.wasmUASTCToASTC,!0),wasmUASTCToBC7:R.e.GetBabylonScriptURL(this.URLConfig.wasmUASTCToBC7,!0),wasmUASTCToRGBA_UNORM:R.e.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_UNORM,!0),wasmUASTCToRGBA_SRGB:R.e.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_SRGB,!0),wasmUASTCToR8_UNORM:R.e.GetBabylonScriptURL(this.URLConfig.wasmUASTCToR8_UNORM,!0),wasmUASTCToRG8_UNORM:R.e.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRG8_UNORM,!0),jsMSCTranscoder:R.e.GetBabylonScriptURL(this.URLConfig.jsMSCTranscoder,!0),wasmMSCTranscoder:R.e.GetBabylonScriptURL(this.URLConfig.wasmMSCTranscoder,!0),wasmZSTDDecoder:R.e.GetBabylonScriptURL(this.URLConfig.wasmZSTDDecoder,!0)};V&&"function"===typeof Worker&&"undefined"!==typeof URL?c._WorkerPoolPromise=new Promise((Z=>{const d=`${i}(${M})()`,p=URL.createObjectURL(new Blob([d],{type:"application/javascript"}));Z(new a.e(V,(()=>function(V,O,Z){return new Promise(((d,p)=>{const r=O=>{V.removeEventListener("error",r),V.removeEventListener("message",Y),p(O)},Y=O=>{"init"===O.data.action&&(V.removeEventListener("error",r),V.removeEventListener("message",Y),d(V))};V.addEventListener("error",r),V.addEventListener("message",Y),V.postMessage({action:"init",urls:Z,wasmBinaries:O})}))}(new Worker(p),void 0,O))))})):"undefined"===typeof c._KTX2DecoderModule?c._DecoderModulePromise=R.e.LoadBabylonScriptAsync(O.jsDecoderModule).then((()=>(c._KTX2DecoderModule=KTX2DECODER,c._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,c._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,i(O,c._KTX2DecoderModule),new c._KTX2DecoderModule.KTX2Decoder))):(c._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,c._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,c._DecoderModulePromise=Promise.resolve(new c._KTX2DecoderModule.KTX2Decoder))}constructor(V){let O=arguments.length>1&&void 0!==arguments[1]?arguments[1]:c.DefaultNumWorkers;this._engine=V;const Z="object"===typeof O&&O.workerPool||c.WorkerPool;if(Z)c._WorkerPoolPromise=Promise.resolve(Z);else{var d;if("object"===typeof O)c._KTX2DecoderModule=null===O||void 0===O||null===(d=O.binariesAndModulesContainer)||void 0===d?void 0:d.jsDecoderModule;else"undefined"!==typeof KTX2DECODER&&(c._KTX2DecoderModule=KTX2DECODER);const V="number"===typeof O?O:O.numWorkers??c.DefaultNumWorkers;c._Initialize(V)}}_uploadAsync(V,O,Z){const d=this._engine.getCaps(),p={astc:!!d.astc,bptc:!!d.bptc,s3tc:!!d.s3tc,pvrtc:!!d.pvrtc,etc2:!!d.etc2,etc1:!!d.etc1};if(c._WorkerPoolPromise)return c._WorkerPoolPromise.then((d=>new Promise(((r,Y)=>{d.push(((d,m)=>{const a=V=>{d.removeEventListener("error",a),d.removeEventListener("message",R),Y(V),m()},R=V=>{if("decoded"===V.data.action){if(d.removeEventListener("error",a),d.removeEventListener("message",R),V.data.success)try{this._createTexture(V.data.decodedData,O,Z),r()}catch(p){Y({message:p})}else Y({message:V.data.msg});m()}};d.addEventListener("error",a),d.addEventListener("message",R),d.postMessage({action:"setDefaultDecoderOptions",options:c.DefaultDecoderOptions._getKTX2DecoderOptions()});const i=new Uint8Array(V.byteLength);i.set(new Uint8Array(V.buffer,V.byteOffset,V.byteLength)),d.postMessage({action:"decode",data:i,caps:p,options:Z},[i.buffer])}))}))));if(c._DecoderModulePromise)return c._DecoderModulePromise.then((Z=>(c.DefaultDecoderOptions.isDirty&&(c._KTX2DecoderModule.KTX2Decoder.DefaultDecoderOptions=c.DefaultDecoderOptions._getKTX2DecoderOptions()),new Promise(((p,r)=>{Z.decode(V,d).then((V=>{this._createTexture(V,O),p()})).catch((V=>{r({message:V})}))})))));throw new Error("KTX2 decoder module is not available")}_createTexture(V,O,Z){this._engine._bindTextureDirectly(3553,O),Z&&(Z.transcodedFormat=V.transcodedFormat,Z.isInGammaSpace=V.isInGammaSpace,Z.uc=V.uc,Z.transcoderName=V.transcoderName);let d=!0;switch(V.transcodedFormat){case 32856:O.type=0,O.format=5;break;case 33321:O.type=0,O.format=6;break;case 33323:O.type=0,O.format=7;break;default:O.format=V.transcodedFormat,d=!1}if(O._gammaSpace=V.isInGammaSpace,O.generateMipMaps=V.mipmaps.length>1,V.errors)throw new Error("KTX2 container - could not transcode the data. "+V.errors);for(let p=0;p<V.mipmaps.length;++p){const Z=V.mipmaps[p];if(!Z||!Z.data)throw new Error("KTX2 container - could not transcode one of the image");d?(O.width=Z.width,O.height=Z.height,this._engine._uploadDataToTextureDirectly(O,Z.data,0,p,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(O,V.transcodedFormat,Z.width,Z.height,Z.data,0,p)}O._extension=".ktx2",O.width=V.mipmaps[0].width,O.height=V.mipmaps[0].height,O.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static IsValid(V){if(V.byteLength>=12){const O=new Uint8Array(V.buffer,V.byteOffset,12);if(171===O[0]&&75===O[1]&&84===O[2]&&88===O[3]&&32===O[4]&&50===O[5]&&48===O[6]&&187===O[7]&&13===O[8]&&10===O[9]&&26===O[10]&&10===O[11])return!0}return!1}}c.URLConfig={jsDecoderModule:"https://cdn.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null},c.DefaultNumWorkers=c.GetDefaultNumWorkers(),c.DefaultDecoderOptions=new class{constructor(){this._isDirty=!0,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=!0,this._ktx2DecoderOptions={}}get isDirty(){return this._isDirty}get useRGBAIfASTCBC7NotAvailableWhenUASTC(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set useRGBAIfASTCBC7NotAvailableWhenUASTC(V){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==V&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=V,this._isDirty=!0)}get useRGBAIfOnlyBC1BC3AvailableWhenUASTC(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set useRGBAIfOnlyBC1BC3AvailableWhenUASTC(V){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==V&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=V,this._isDirty=!0)}get forceRGBA(){return this._forceRGBA}set forceRGBA(V){this._forceRGBA!==V&&(this._forceRGBA=V,this._isDirty=!0)}get forceR8(){return this._forceR8}set forceR8(V){this._forceR8!==V&&(this._forceR8=V,this._isDirty=!0)}get forceRG8(){return this._forceRG8}set forceRG8(V){this._forceRG8!==V&&(this._forceRG8=V,this._isDirty=!0)}get bypassTranscoders(){return this._bypassTranscoders}set bypassTranscoders(V){this._bypassTranscoders!==V&&(this._bypassTranscoders=V,this._isDirty=!0)}_getKTX2DecoderOptions(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=!1;const V={useRGBAIfASTCBC7NotAvailableWhenUASTC:this._useRGBAIfASTCBC7NotAvailableWhenUASTC,forceRGBA:this._forceRGBA,forceR8:this._forceR8,forceRG8:this._forceRG8,bypassTranscoders:this._bypassTranscoders};return this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(V.transcodeFormatDecisionTree={UASTC:{transcodeFormat:[Y.BC1_RGB,Y.BC3_RGBA],yes:{transcodeFormat:Y.RGBA32,engineFormat:32856,roundToMultiple4:!1}}}),this._ktx2DecoderOptions=V,V}};class W{constructor(){this.supportCascades=!1}loadCubeData(V,O,Z,d){if(Array.isArray(V))return;O._invertVScale=!O.invertY;const r=O.getEngine(),Y=new p(V,6),m=Y.numberOfMipmapLevels>1&&O.generateMipMaps;r._unpackFlipY(!0),Y.uploadLevels(O,O.generateMipMaps),O.width=Y.pixelWidth,O.height=Y.pixelHeight,r._setCubeMapTextureParams(O,m,Y.numberOfMipmapLevels-1),O.isReady=!0,O.onLoadedObservable.notifyObservers(O),O.onLoadedObservable.clear(),d&&d()}loadData(V,O,Z,r){if(p.IsValid(V)){O._invertVScale=!O.invertY;const d=new p(V,1),r=function(V){switch(V){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}(d.glInternalFormat);r?(O.format=r,O._useSRGBBuffer=O.getEngine()._getUseSRGBBuffer(!0,O.generateMipMaps),O._gammaSpace=!0):O.format=d.glInternalFormat,Z(d.pixelWidth,d.pixelHeight,O.generateMipMaps,!0,(()=>{d.uploadLevels(O,O.generateMipMaps)}),d.isInvalid)}else if(c.IsValid(V)){new c(O.getEngine())._uploadAsync(V,O,r).then((()=>{Z(O.width,O.height,O.generateMipMaps,!0,(()=>{}),!1)}),(V=>{d.b.Warn(`Failed to load KTX2 texture data: ${V.message}`),Z(0,0,!1,!1,(()=>{}),!0)}))}else d.b.Error("texture missing KTX identifier"),Z(0,0,!1,!1,(()=>{}),!0)}}}}]);