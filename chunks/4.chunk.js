"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[4],{2444:(n,k,T)=>{T(615).b.prototype.createDepthStencilTexture=function(n,k,T){if(k.isCube){const T=n.width||n;return this._createDepthStencilCubeTexture(T,k)}return this._createDepthStencilTexture(n,k,T)}},2415:(n,k,T)=>{T(2391).ThinEngine.prototype.setAlphaMode=function(n){let k=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._alphaMode!==n){switch(n){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0}k||(this.depthCullingState.depthMask=0===n),this._alphaMode=n}else if(!k){const k=0===n;this.depthCullingState.depthMask!==k&&(this.depthCullingState.depthMask=k)}}},2422:(n,k,T)=>{var c=T(2391);c.ThinEngine.prototype.updateDynamicIndexBuffer=function(n,k){let T;this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(n),T=n.is32Bits?k instanceof Uint32Array?k:new Uint32Array(k):k instanceof Uint16Array?k:new Uint16Array(k),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,T,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()},c.ThinEngine.prototype.updateDynamicVertexBuffer=function(n,k,T,c){this.bindArrayBuffer(n),void 0===T&&(T=0);const K=k.byteLength||k.length;void 0===c||c>=K&&0===T?k instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,T,new Float32Array(k)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,T,k):k instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,T,new Float32Array(k).subarray(0,c/4)):(k=k instanceof ArrayBuffer?new Uint8Array(k,0,c):new Uint8Array(k.buffer,k.byteOffset,c),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,T,k)),this._resetVertexBufferBinding()}},2431:(n,k,T)=>{var c=T(654),K=T(556),Q=T(2391),G=T(2437),w=T(2411);class E extends G.e{setDepthStencilTexture(n){let k=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(super.setDepthStencilTexture(n,k),!n)return;const T=this._engine,c=this._context,K=n._hardwareTexture;if(K&&n._autoMSAAManagement&&this._MSAAFramebuffer){const k=T._currentFramebuffer;T._bindUnboundFramebuffer(this._MSAAFramebuffer),c.framebufferRenderbuffer(c.FRAMEBUFFER,(0,w.e)(n.format)?c.DEPTH_STENCIL_ATTACHMENT:c.DEPTH_ATTACHMENT,c.RENDERBUFFER,K.getMSAARenderBuffer()),T._bindUnboundFramebuffer(k)}}constructor(n,k,T,c,K){super(n,k,T,c),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._disposeOnlyFramebuffers=!1,this._currentLOD=0,this._context=K}_cloneRenderTargetWrapper(){let n=null;return this._colorTextureArray&&this._depthStencilTextureArray?(n=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),n.texture.isReady=!0):n=super._cloneRenderTargetWrapper(),n}_swapRenderTargetWrapper(n){super._swapRenderTargetWrapper(n),n._framebuffer=this._framebuffer,n._depthStencilBuffer=this._depthStencilBuffer,n._MSAAFramebuffer=this._MSAAFramebuffer,n._colorTextureArray=this._colorTextureArray,n._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}createDepthStencilTexture(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,k=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],T=arguments.length>2&&void 0!==arguments[2]&&arguments[2],c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,K=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14,Q=arguments.length>5?arguments[5]:void 0;if(this._depthStencilBuffer){const n=this._engine,k=n._currentFramebuffer,T=this._context;n._bindUnboundFramebuffer(this._framebuffer),T.framebufferRenderbuffer(T.FRAMEBUFFER,T.DEPTH_STENCIL_ATTACHMENT,T.RENDERBUFFER,null),T.framebufferRenderbuffer(T.FRAMEBUFFER,T.DEPTH_ATTACHMENT,T.RENDERBUFFER,null),T.framebufferRenderbuffer(T.FRAMEBUFFER,T.STENCIL_ATTACHMENT,T.RENDERBUFFER,null),n._bindUnboundFramebuffer(k),T.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null}return super.createDepthStencilTexture(n,k,T,c,K,Q)}shareDepth(n){super.shareDepth(n);const k=this._context,T=this._depthStencilBuffer,c=n._MSAAFramebuffer||n._framebuffer,K=this._engine;n._depthStencilBuffer&&n._depthStencilBuffer!==T&&k.deleteRenderbuffer(n._depthStencilBuffer),n._depthStencilBuffer=T;const Q=n._generateStencilBuffer?k.DEPTH_STENCIL_ATTACHMENT:k.DEPTH_ATTACHMENT;K._bindUnboundFramebuffer(c),k.framebufferRenderbuffer(k.FRAMEBUFFER,Q,k.RENDERBUFFER,T),K._bindUnboundFramebuffer(null)}_bindTextureRenderTarget(n){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,T=arguments.length>2?arguments[2]:void 0,c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const K=n._hardwareTexture;if(!K)return;const Q=this._framebuffer,G=this._engine,w=G._currentFramebuffer;let E;if(G._bindUnboundFramebuffer(Q),G.webGLVersion>1){const Q=this._context;var I;if(E=Q["COLOR_ATTACHMENT"+k],n.is2DArray||n.is3D)T=T??(null===(I=this.layerIndices)||void 0===I?void 0:I[k])??0,Q.framebufferTextureLayer(Q.FRAMEBUFFER,E,K.underlyingResource,c,T);else if(n.isCube){var S;T=T??(null===(S=this.faceIndices)||void 0===S?void 0:S[k])??0,Q.framebufferTexture2D(Q.FRAMEBUFFER,E,Q.TEXTURE_CUBE_MAP_POSITIVE_X+T,K.underlyingResource,c)}else Q.framebufferTexture2D(Q.FRAMEBUFFER,E,Q.TEXTURE_2D,K.underlyingResource,c)}else{const n=this._context;E=n["COLOR_ATTACHMENT"+k+"_WEBGL"];const Q=void 0!==T?n.TEXTURE_CUBE_MAP_POSITIVE_X+T:n.TEXTURE_2D;n.framebufferTexture2D(n.FRAMEBUFFER,E,Q,K.underlyingResource,c)}if(n._autoMSAAManagement&&this._MSAAFramebuffer){const n=this._context;G._bindUnboundFramebuffer(this._MSAAFramebuffer),n.framebufferRenderbuffer(n.FRAMEBUFFER,E,n.RENDERBUFFER,K.getMSAARenderBuffer())}G._bindUnboundFramebuffer(w)}setTexture(n){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,T=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];super.setTexture(n,k,T),this._bindTextureRenderTarget(n,k)}setLayerAndFaceIndices(n,k){var T;if(super.setLayerAndFaceIndices(n,k),!this.textures||!this.layerIndices||!this.faceIndices)return;const c=(null===(T=this._attachments)||void 0===T?void 0:T.length)??this.textures.length;for(let K=0;K<c;K++){const n=this.textures[K];n&&(n.is2DArray||n.is3D?this._bindTextureRenderTarget(n,K,this.layerIndices[K]):n.isCube?this._bindTextureRenderTarget(n,K,this.faceIndices[K]):this._bindTextureRenderTarget(n,K))}}setLayerAndFaceIndex(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,k=arguments.length>1?arguments[1]:void 0,T=arguments.length>2?arguments[2]:void 0;if(super.setLayerAndFaceIndex(n,k,T),!this.textures||!this.layerIndices||!this.faceIndices)return;const c=this.textures[n];c.is2DArray||c.is3D?this._bindTextureRenderTarget(this.textures[n],n,this.layerIndices[n]):c.isCube&&this._bindTextureRenderTarget(this.textures[n],n,this.faceIndices[n])}resolveMSAATextures(){const n=this._engine,k=n._currentFramebuffer;n._bindUnboundFramebuffer(this._MSAAFramebuffer),super.resolveMSAATextures(),n._bindUnboundFramebuffer(k)}dispose(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._disposeOnlyFramebuffers;const k=this._context;n||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(k.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(k.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(k.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(n)}}T(2444);Q.ThinEngine.prototype._createHardwareRenderTargetWrapper=function(n,k,T){const c=new E(n,k,T,this,this._gl);return this._renderTargetWrapperCache.push(c),c},Q.ThinEngine.prototype.createRenderTargetTexture=function(n,k){const T=this._createHardwareRenderTargetWrapper(!1,!1,n);let c,K,Q=!0,G=!1,w=!1,E=1;void 0!==k&&"object"===typeof k&&(Q=k.generateDepthBuffer??!0,G=!!k.generateStencilBuffer,w=!!k.noColorAttachment,c=k.colorAttachment,E=k.samples??1,K=k.label);const I=c||(w?null:this._createInternalTexture(n,k,!0,5)),S=n.width||n,P=n.height||n,W=this._currentFramebuffer,J=this._gl,H=J.createFramebuffer();if(this._bindUnboundFramebuffer(H),T._depthStencilBuffer=this._setupFramebufferDepthAttachments(G,Q,S,P),!I||I.is2DArray||I.is3D||J.framebufferTexture2D(J.FRAMEBUFFER,J.COLOR_ATTACHMENT0,J.TEXTURE_2D,I._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(W),T.label=K??"RenderTargetWrapper",T._framebuffer=H,T._generateDepthBuffer=Q,T._generateStencilBuffer=G,T.setTextures(I),c){if(T._samples=c.samples,c.samples>1){const n=c._hardwareTexture.getMSAARenderBuffer(0);T._MSAAFramebuffer=J.createFramebuffer(),this._bindUnboundFramebuffer(T._MSAAFramebuffer),J.framebufferRenderbuffer(J.FRAMEBUFFER,J.COLOR_ATTACHMENT0,J.RENDERBUFFER,n),this._bindUnboundFramebuffer(null)}}else this.updateRenderTargetTextureSampleCount(T,E);return T},Q.ThinEngine.prototype._createDepthStencilTexture=function(n,k,T){const Q=this._gl,G=n.layers||0,E=n.depth||0;let I=Q.TEXTURE_2D;0!==G?I=Q.TEXTURE_2D_ARRAY:0!==E&&(I=Q.TEXTURE_3D);const S=new c.d(this,12);if(S.label=k.label,!this._caps.depthTextureExtension)return K.d.Error("Depth texture is not supported by your browser or hardware."),S;const P={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...k};if(this._bindTextureDirectly(I,S,!0),this._setupDepthStencilTexture(S,n,0!==P.comparisonFunction&&P.bilinearFiltering,P.comparisonFunction,P.samples),void 0!==P.depthTextureFormat){if(15!==P.depthTextureFormat&&16!==P.depthTextureFormat&&17!==P.depthTextureFormat&&13!==P.depthTextureFormat&&14!==P.depthTextureFormat&&18!==P.depthTextureFormat)return K.d.Error(`Depth texture ${P.depthTextureFormat} format is not supported.`),S;S.format=P.depthTextureFormat}else S.format=P.generateStencil?13:16;const W=(0,w.e)(S.format),J=this._getWebGLTextureTypeFromDepthTextureFormat(S.format),H=W?Q.DEPTH_STENCIL:Q.DEPTH_COMPONENT,s=this._getInternalFormatFromDepthTextureFormat(S.format,!0,W);return S.is2DArray?Q.texImage3D(I,0,s,S.width,S.height,G,0,H,J,null):S.is3D?Q.texImage3D(I,0,s,S.width,S.height,E,0,H,J,null):Q.texImage2D(I,0,s,S.width,S.height,0,H,J,null),this._bindTextureDirectly(I,null),this._internalTexturesCache.push(S),T._depthStencilBuffer&&(Q.deleteRenderbuffer(T._depthStencilBuffer),T._depthStencilBuffer=null),this._bindUnboundFramebuffer(T._MSAAFramebuffer??T._framebuffer),T._generateStencilBuffer=W,T._depthStencilTextureWithStencil=W,T._depthStencilBuffer=this._setupFramebufferDepthAttachments(T._generateStencilBuffer,T._generateDepthBuffer,T.width,T.height,T.samples,S.format),this._bindUnboundFramebuffer(null),S},Q.ThinEngine.prototype.updateRenderTargetTextureSampleCount=function(n,k){var T;if(this.webGLVersion<2||!n)return 1;if(n.samples===k)return k;const c=this._gl;k=Math.min(k,this.getCaps().maxMSAASamples),n._depthStencilBuffer&&(c.deleteRenderbuffer(n._depthStencilBuffer),n._depthStencilBuffer=null),n._MSAAFramebuffer&&(c.deleteFramebuffer(n._MSAAFramebuffer),n._MSAAFramebuffer=null);const K=null===(T=n.texture)||void 0===T?void 0:T._hardwareTexture;if(null===K||void 0===K||K.releaseMSAARenderBuffers(),n.texture&&k>1&&"function"===typeof c.renderbufferStorageMultisample){const T=c.createFramebuffer();if(!T)throw new Error("Unable to create multi sampled framebuffer");n._MSAAFramebuffer=T,this._bindUnboundFramebuffer(n._MSAAFramebuffer);const Q=this._createRenderBuffer(n.texture.width,n.texture.height,k,-1,this._getRGBABufferInternalSizedFormat(n.texture.type,n.texture.format,n.texture._useSRGBBuffer),c.COLOR_ATTACHMENT0,!1);if(!Q)throw new Error("Unable to create multi sampled framebuffer");null===K||void 0===K||K.addMSAARenderBuffer(Q)}this._bindUnboundFramebuffer(n._MSAAFramebuffer??n._framebuffer),n.texture&&(n.texture.samples=k),n._samples=k;const Q=n._depthStencilTexture?n._depthStencilTexture.format:void 0;return n._depthStencilBuffer=this._setupFramebufferDepthAttachments(n._generateStencilBuffer,n._generateDepthBuffer,n.width,n.height,k,Q),this._bindUnboundFramebuffer(null),k},Q.ThinEngine.prototype._setupDepthStencilTexture=function(n,k,T,c){let K=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;const Q=k.width??k,G=k.height??k,w=k.layers||0,E=k.depth||0;n.baseWidth=Q,n.baseHeight=G,n.width=Q,n.height=G,n.is2DArray=w>0,n.depth=w||E,n.isReady=!0,n.samples=K,n.generateMipMaps=!1,n.samplingMode=T?2:1,n.type=0,n._comparisonFunction=c;const I=this._gl,S=this._getTextureTarget(n),P=this._getSamplingParameters(n.samplingMode,!1);I.texParameteri(S,I.TEXTURE_MAG_FILTER,P.mag),I.texParameteri(S,I.TEXTURE_MIN_FILTER,P.min),I.texParameteri(S,I.TEXTURE_WRAP_S,I.CLAMP_TO_EDGE),I.texParameteri(S,I.TEXTURE_WRAP_T,I.CLAMP_TO_EDGE),this.webGLVersion>1&&(0===c?(I.texParameteri(S,I.TEXTURE_COMPARE_FUNC,515),I.texParameteri(S,I.TEXTURE_COMPARE_MODE,I.NONE)):(I.texParameteri(S,I.TEXTURE_COMPARE_FUNC,c),I.texParameteri(S,I.TEXTURE_COMPARE_MODE,I.COMPARE_REF_TO_TEXTURE)))}},2405:(n,k,T)=>{T.d(k,{c:()=>c});class c{get underlyingResource(){return this._webGLTexture}constructor(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,k=arguments.length>1?arguments[1]:void 0;if(this._MSAARenderBuffers=null,this._context=k,!n&&(n=k.createTexture(),!n))throw new Error("Unable to create webGL texture");this.set(n)}setUsage(){}set(n){this._webGLTexture=n}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(n){this._MSAARenderBuffers||(this._MSAARenderBuffers=[]),this._MSAARenderBuffers.push(n)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(const n of this._MSAARenderBuffers)this._context.deleteRenderbuffer(n);this._MSAARenderBuffers=null}}getMSAARenderBuffer(){var n;let k=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return(null===(n=this._MSAARenderBuffers)||void 0===n?void 0:n[k])??null}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}},2388:(n,k,T)=>{T.d(k,{b:()=>A});var c=T(654),K=T(588),Q=T(2391),G=T(573);class w{constructor(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:30;this._enabled=!0,this._rollingFrameTime=new E(n)}sampleFrame(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:G.e.Now;if(this._enabled){if(null!=this._lastFrameTimeMs){const k=n-this._lastFrameTimeMs;this._rollingFrameTime.add(k)}this._lastFrameTimeMs=n}}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){const n=this._rollingFrameTime.history(0);return 0===n?0:1e3/n}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}}class E{constructor(n){this._samples=new Array(n),this.reset()}add(n){let k;if(this.isSaturated()){const n=this._samples[this._pos];k=n-this.average,this.average-=k/(this._sampleCount-1),this._m2-=k*(n-this.average)}else this._sampleCount++;k=n-this.average,this.average+=k/this._sampleCount,this._m2+=k*(n-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=n,this._pos++,this._pos%=this._samples.length}history(n){if(n>=this._sampleCount||n>=this._samples.length)return 0;const k=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(k-n)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(n){const k=this._samples.length;return(n%k+k)%k}}var I=T(2399),S=T(556),P=T(2405),W=(T(2415),T(693));function J(n,k,T,c){let K,Q=1;1===c?K=new Float32Array(k*T*4):2===c?(K=new Uint16Array(k*T*4),Q=15360):K=7===c?new Uint32Array(k*T*4):new Uint8Array(k*T*4);for(let G=0;G<k;G++)for(let c=0;c<T;c++){const T=3*(c*k+G),w=4*(c*k+G);K[w+0]=n[T+0],K[w+1]=n[T+1],K[w+2]=n[T+2],K[w+3]=Q}return K}function H(n){return function(k,T,K,Q,G,w,E,I){let S=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,P=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;const W=n?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,J=n?10:11,H=new c.d(this,J);H.baseWidth=T,H.baseHeight=K,H.baseDepth=Q,H.width=T,H.height=K,H.depth=Q,H.format=G,H.type=P,H.generateMipMaps=w,H.samplingMode=I,n?H.is3D=!0:H.is2DArray=!0,this._doNotHandleContextLost||(H._bufferView=k),n?this.updateRawTexture3D(H,k,G,E,S,P):this.updateRawTexture2DArray(H,k,G,E,S,P),this._bindTextureDirectly(W,H,!0);const s=this._getSamplingParameters(I,w);return this._gl.texParameteri(W,this._gl.TEXTURE_MAG_FILTER,s.mag),this._gl.texParameteri(W,this._gl.TEXTURE_MIN_FILTER,s.min),w&&this._gl.generateMipmap(W),this._bindTextureDirectly(W,null),this._internalTexturesCache.push(H),H}}function s(n){return function(k,T,c,K){let Q=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,G=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;const w=n?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,E=this._getWebGLTextureType(G),I=this._getInternalFormat(c),S=this._getRGBABufferInternalSizedFormat(G,c);this._bindTextureDirectly(w,k,!0),this._unpackFlipY(void 0===K||!!K),this._doNotHandleContextLost||(k._bufferView=T,k.format=c,k.invertY=K,k._compression=Q),k.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),Q&&T?this._gl.compressedTexImage3D(w,0,this.getCaps().s3tc[Q],k.width,k.height,k.depth,0,T):this._gl.texImage3D(w,0,S,k.width,k.height,k.depth,0,I,E,T),k.generateMipMaps&&this._gl.generateMipmap(w),this._bindTextureDirectly(w,null),k.isReady=!0}}Q.ThinEngine.prototype.updateRawTexture=function(n,k,T,c){let K=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,Q=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,G=arguments.length>6&&void 0!==arguments[6]&&arguments[6];if(!n)return;const w=this._getRGBABufferInternalSizedFormat(Q,T,G),E=this._getInternalFormat(T),I=this._getWebGLTextureType(Q);this._bindTextureDirectly(this._gl.TEXTURE_2D,n,!0),this._unpackFlipY(void 0===c||!!c),this._doNotHandleContextLost||(n._bufferView=k,n.format=T,n.type=Q,n.invertY=c,n._compression=K),n.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),K&&k?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[K],n.width,n.height,0,k):this._gl.texImage2D(this._gl.TEXTURE_2D,0,w,n.width,n.height,0,E,I,k),n.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),n.isReady=!0},Q.ThinEngine.prototype.createRawTexture=function(n,k,T,K,Q,G,w){let E=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,I=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,S=arguments.length>10&&void 0!==arguments[10]&&arguments[10];const P=new c.d(this,3);P.baseWidth=k,P.baseHeight=T,P.width=k,P.height=T,P.format=K,P.generateMipMaps=Q,P.samplingMode=w,P.invertY=G,P._compression=E,P.type=I,P._useSRGBBuffer=this._getUseSRGBBuffer(S,!Q),this._doNotHandleContextLost||(P._bufferView=n),this.updateRawTexture(P,n,K,G,E,I,P._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,P,!0);const W=this._getSamplingParameters(w,Q);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,W.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,W.min),Q&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(P),P},Q.ThinEngine.prototype.createRawCubeTexture=function(n,k,T,K,Q,G,w){let E=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;const I=this._gl,P=new c.d(this,8);P.isCube=!0,P.format=T,P.type=K,this._doNotHandleContextLost||(P._bufferViewArray=n);const J=this._getWebGLTextureType(K);let H=this._getInternalFormat(T);H===I.RGB&&(H=I.RGBA),J!==I.FLOAT||this._caps.textureFloatLinearFiltering?J!==this._gl.HALF_FLOAT_OES||this._caps.textureHalfFloatLinearFiltering?J!==I.FLOAT||this._caps.textureFloatRender?J!==I.HALF_FLOAT||this._caps.colorBufferFloat||(Q=!1,S.d.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(Q=!1,S.d.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(Q=!1,w=1,S.d.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(Q=!1,w=1,S.d.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively."));const s=k,b=s;P.width=s,P.height=b,P.invertY=G,P._compression=E;if(!this.needPOTTextures||(0,W.j)(P.width)&&(0,W.j)(P.height)||(Q=!1),n)this.updateRawCubeTexture(P,n,T,K,G,E);else{const n=this._getRGBABufferInternalSizedFormat(K),k=0;this._bindTextureDirectly(I.TEXTURE_CUBE_MAP,P,!0);for(let T=0;T<6;T++)E?I.compressedTexImage2D(I.TEXTURE_CUBE_MAP_POSITIVE_X+T,k,this.getCaps().s3tc[E],P.width,P.height,0,void 0):I.texImage2D(I.TEXTURE_CUBE_MAP_POSITIVE_X+T,k,n,P.width,P.height,0,H,J,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,P,!0),n&&Q&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);const C=this._getSamplingParameters(w,Q);return I.texParameteri(I.TEXTURE_CUBE_MAP,I.TEXTURE_MAG_FILTER,C.mag),I.texParameteri(I.TEXTURE_CUBE_MAP,I.TEXTURE_MIN_FILTER,C.min),I.texParameteri(I.TEXTURE_CUBE_MAP,I.TEXTURE_WRAP_S,I.CLAMP_TO_EDGE),I.texParameteri(I.TEXTURE_CUBE_MAP,I.TEXTURE_WRAP_T,I.CLAMP_TO_EDGE),this._bindTextureDirectly(I.TEXTURE_CUBE_MAP,null),P.generateMipMaps=Q,P.samplingMode=w,P.isReady=!0,P},Q.ThinEngine.prototype.updateRawCubeTexture=function(n,k,T,c,K){let Q=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,G=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;n._bufferViewArray=k,n.format=T,n.type=c,n.invertY=K,n._compression=Q;const w=this._gl,E=this._getWebGLTextureType(c);let I=this._getInternalFormat(T);const S=this._getRGBABufferInternalSizedFormat(c);let P=!1;I===w.RGB&&(I=w.RGBA,P=!0),this._bindTextureDirectly(w.TEXTURE_CUBE_MAP,n,!0),this._unpackFlipY(void 0===K||!!K),n.width%4!==0&&w.pixelStorei(w.UNPACK_ALIGNMENT,1);for(let W=0;W<6;W++){let T=k[W];Q?w.compressedTexImage2D(w.TEXTURE_CUBE_MAP_POSITIVE_X+W,G,this.getCaps().s3tc[Q],n.width,n.height,0,T):(P&&(T=J(T,n.width,n.height,c)),w.texImage2D(w.TEXTURE_CUBE_MAP_POSITIVE_X+W,G,S,n.width,n.height,0,I,E,T))}(!this.needPOTTextures||(0,W.j)(n.width)&&(0,W.j)(n.height))&&n.generateMipMaps&&0===G&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),n.isReady=!0},Q.ThinEngine.prototype.createRawCubeTextureFromUrl=function(n,k,T,c,K,Q,G,w){let E=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,I=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,S=arguments.length>10&&void 0!==arguments[10]?arguments[10]:3,P=arguments.length>11&&void 0!==arguments[11]&&arguments[11];const W=this._gl,H=this.createRawCubeTexture(null,T,c,K,!Q,P,S,null);null===k||void 0===k||k.addPendingData(H),H.url=n,H.isReady=!1,this._internalTexturesCache.push(H);const s=n=>{if(!H._hardwareTexture)return;const T=H.width,Q=G(n);if(Q){if(w){const n=this._getWebGLTextureType(K);let k=this._getInternalFormat(c);const G=this._getRGBABufferInternalSizedFormat(K);let E=!1;k===W.RGB&&(k=W.RGBA,E=!0),this._bindTextureDirectly(W.TEXTURE_CUBE_MAP,H,!0),this._unpackFlipY(!1);const I=w(Q);for(let c=0;c<I.length;c++){const Q=T>>c;for(let T=0;T<6;T++){let w=I[c][T];E&&(w=J(w,Q,Q,K)),W.texImage2D(T,c,G,Q,Q,0,k,n,w)}}this._bindTextureDirectly(W.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(H,Q,c,K,P);H.isReady=!0,null===k||void 0===k||k.removePendingData(H),H.onLoadedObservable.notifyObservers(H),H.onLoadedObservable.clear(),E&&E()}};return this._loadFile(n,(n=>{s(n)}),void 0,null===k||void 0===k?void 0:k.offlineProvider,!0,((n,T)=>{null===k||void 0===k||k.removePendingData(H),I&&n&&I(n.status+" "+n.statusText,T)})),H},Q.ThinEngine.prototype.createRawTexture2DArray=H(!1),Q.ThinEngine.prototype.createRawTexture3D=H(!0),Q.ThinEngine.prototype.updateRawTexture2DArray=s(!1),Q.ThinEngine.prototype.updateRawTexture3D=s(!0);var b=T(606);Q.ThinEngine.prototype._readTexturePixelsSync=function(n,k,T){let c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,K=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,Q=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,G=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],w=arguments.length>7&&void 0!==arguments[7]&&arguments[7],E=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,I=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;const S=this._gl;if(!S)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){const n=S.createFramebuffer();if(!n)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=n}var P,W;(S.bindFramebuffer(S.FRAMEBUFFER,this._dummyFramebuffer),c>-1)?S.framebufferTexture2D(S.FRAMEBUFFER,S.COLOR_ATTACHMENT0,S.TEXTURE_CUBE_MAP_POSITIVE_X+c,null===(P=n._hardwareTexture)||void 0===P?void 0:P.underlyingResource,K):S.framebufferTexture2D(S.FRAMEBUFFER,S.COLOR_ATTACHMENT0,S.TEXTURE_2D,null===(W=n._hardwareTexture)||void 0===W?void 0:W.underlyingResource,K);let J=void 0!==n.type?this._getWebGLTextureType(n.type):S.UNSIGNED_BYTE;if(w)Q||(Q=(0,b.k)(n.type,4*k*T));else if(J===S.UNSIGNED_BYTE)Q||(Q=new Uint8Array(4*k*T)),J=S.UNSIGNED_BYTE;else Q||(Q=new Float32Array(4*k*T)),J=S.FLOAT;return G&&this.flushFramebuffer(),S.readPixels(E,I,k,T,S.RGBA,J,Q),S.bindFramebuffer(S.FRAMEBUFFER,this._currentFramebuffer),Q},Q.ThinEngine.prototype._readTexturePixels=function(n,k,T){let c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,K=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,Q=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,G=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],w=arguments.length>7&&void 0!==arguments[7]&&arguments[7],E=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,I=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;return Promise.resolve(this._readTexturePixelsSync(n,k,T,c,K,Q,G,w,E,I))};T(2422);Q.ThinEngine.prototype._createDepthStencilCubeTexture=function(n,k){const T=new c.d(this,12);if(T.isCube=!0,1===this.webGLVersion)return S.d.Error("Depth cube texture is not supported by WebGL 1."),T;const K={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...k},Q=this._gl;this._bindTextureDirectly(Q.TEXTURE_CUBE_MAP,T,!0),this._setupDepthStencilTexture(T,n,K.bilinearFiltering,K.comparisonFunction);for(let c=0;c<6;c++)K.generateStencil?Q.texImage2D(Q.TEXTURE_CUBE_MAP_POSITIVE_X+c,0,Q.DEPTH24_STENCIL8,n,n,0,Q.DEPTH_STENCIL,Q.UNSIGNED_INT_24_8,null):Q.texImage2D(Q.TEXTURE_CUBE_MAP_POSITIVE_X+c,0,Q.DEPTH_COMPONENT24,n,n,0,Q.DEPTH_COMPONENT,Q.UNSIGNED_INT,null);return this._bindTextureDirectly(Q.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(T),T},Q.ThinEngine.prototype._setCubeMapTextureParams=function(n,k,T){const c=this._gl;c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_MAG_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_MIN_FILTER,k?c.LINEAR_MIPMAP_LINEAR:c.LINEAR),c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),n.samplingMode=k?3:2,k&&this.getCaps().textureMaxLevel&&void 0!==T&&T>0&&(c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_MAX_LEVEL,T),n._maxLodLevel=T),this._bindTextureDirectly(c.TEXTURE_CUBE_MAP,null)},Q.ThinEngine.prototype.createCubeTexture=function(n,k,T,c){let K=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,Q=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,G=arguments.length>6?arguments[6]:void 0,w=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,E=arguments.length>8&&void 0!==arguments[8]&&arguments[8],I=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,P=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0,J=arguments.length>11&&void 0!==arguments[11]?arguments[11]:null,H=arguments.length>13&&void 0!==arguments[13]&&arguments[13],s=arguments.length>14&&void 0!==arguments[14]?arguments[14]:null;const b=this._gl;return this.createCubeTextureBase(n,k,T,!!c,K,Q,G,w,E,I,P,J,(n=>this._bindTextureDirectly(b.TEXTURE_CUBE_MAP,n,!0)),((n,k)=>{const T=this.needPOTTextures?(0,W.h)(k[0].width,this._caps.maxCubemapTextureSize):k[0].width,Q=T,w=[b.TEXTURE_CUBE_MAP_POSITIVE_X,b.TEXTURE_CUBE_MAP_POSITIVE_Y,b.TEXTURE_CUBE_MAP_POSITIVE_Z,b.TEXTURE_CUBE_MAP_NEGATIVE_X,b.TEXTURE_CUBE_MAP_NEGATIVE_Y,b.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(b.TEXTURE_CUBE_MAP,n,!0),this._unpackFlipY(!1);const E=G?this._getInternalFormat(G,n._useSRGBBuffer):n._useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:b.RGBA;let I=G?this._getInternalFormat(G):b.RGBA;n._useSRGBBuffer&&1===this.webGLVersion&&(I=E);for(let c=0;c<w.length;c++)if(k[c].width!==T||k[c].height!==Q){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext)return void S.d.Warn("Cannot create canvas to resize texture.");this._workingCanvas.width=T,this._workingCanvas.height=Q,this._workingContext.drawImage(k[c],0,0,k[c].width,k[c].height,0,0,T,Q),b.texImage2D(w[c],0,E,I,b.UNSIGNED_BYTE,this._workingCanvas)}else b.texImage2D(w[c],0,E,I,b.UNSIGNED_BYTE,k[c]);c||b.generateMipmap(b.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(n,!c),n.width=T,n.height=Q,n.isReady=!0,G&&(n.format=G),n.onLoadedObservable.notifyObservers(n),n.onLoadedObservable.clear(),K&&K()}),!!H,s)},Q.ThinEngine.prototype.generateMipMapsForCubemap=function(n){let k=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(n.generateMipMaps){const T=this._gl;this._bindTextureDirectly(T.TEXTURE_CUBE_MAP,n,!0),T.generateMipmap(T.TEXTURE_CUBE_MAP),k&&this._bindTextureDirectly(T.TEXTURE_CUBE_MAP,null)}};T(2431);Q.ThinEngine.prototype.setDepthStencilTexture=function(n,k,T,c){void 0!==n&&(k&&(this._boundUniforms[n]=k),T&&T.depthStencilTexture?this._setTexture(n,T,!1,!0,c):this._setTexture(n,null,void 0,void 0,c))},Q.ThinEngine.prototype.createRenderTargetCubeTexture=function(n,k){const T=this._createHardwareRenderTargetWrapper(!1,!0,n),K={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,...k};K.generateStencilBuffer=K.generateDepthBuffer&&K.generateStencilBuffer,(1!==K.type||this._caps.textureFloatLinearFiltering)&&(2!==K.type||this._caps.textureHalfFloatLinearFiltering)||(K.samplingMode=1);const Q=this._gl,G=new c.d(this,5);this._bindTextureDirectly(Q.TEXTURE_CUBE_MAP,G,!0);const w=this._getSamplingParameters(K.samplingMode,K.generateMipMaps);1!==K.type||this._caps.textureFloat||(K.type=0,S.d.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),Q.texParameteri(Q.TEXTURE_CUBE_MAP,Q.TEXTURE_MAG_FILTER,w.mag),Q.texParameteri(Q.TEXTURE_CUBE_MAP,Q.TEXTURE_MIN_FILTER,w.min),Q.texParameteri(Q.TEXTURE_CUBE_MAP,Q.TEXTURE_WRAP_S,Q.CLAMP_TO_EDGE),Q.texParameteri(Q.TEXTURE_CUBE_MAP,Q.TEXTURE_WRAP_T,Q.CLAMP_TO_EDGE);for(let c=0;c<6;c++)Q.texImage2D(Q.TEXTURE_CUBE_MAP_POSITIVE_X+c,0,this._getRGBABufferInternalSizedFormat(K.type,K.format),n,n,0,this._getInternalFormat(K.format),this._getWebGLTextureType(K.type),null);const E=Q.createFramebuffer();return this._bindUnboundFramebuffer(E),T._depthStencilBuffer=this._setupFramebufferDepthAttachments(K.generateStencilBuffer,K.generateDepthBuffer,n,n),K.generateMipMaps&&Q.generateMipmap(Q.TEXTURE_CUBE_MAP),this._bindTextureDirectly(Q.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),T._framebuffer=E,T._generateDepthBuffer=K.generateDepthBuffer,T._generateStencilBuffer=K.generateStencilBuffer,G.width=n,G.height=n,G.isReady=!0,G.isCube=!0,G.samples=1,G.generateMipMaps=K.generateMipMaps,G.samplingMode=K.samplingMode,G.type=K.type,G.format=K.format,this._internalTexturesCache.push(G),T.setTextures(G),T};var C=T(2294),z=T(2342);Q.ThinEngine.prototype.createPrefilteredCubeTexture=function(n,k,K,Q){let G=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,w=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,E=arguments.length>6?arguments[6]:void 0,I=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,P=!(arguments.length>8&&void 0!==arguments[8])||arguments[8];return this.createCubeTexture(n,k,null,!1,(async n=>{if(!n)return void(G&&G(null));const w=n.texture;if(P?n.info.sphericalPolynomial&&(w._sphericalPolynomial=n.info.sphericalPolynomial):w._sphericalPolynomial=new C.d,w._source=9,this.getCaps().textureLOD)return void(G&&G(w));const E=this._gl,I=n.width;if(!I)return;const{DDSTools:W}=await T.e(6).then(T.bind(T,2321)),J=[];for(let T=0;T<3;T++){const G=1-T/2,P=Q,H=Math.log2(I)*K+Q,s=P+(H-P)*G,b=Math.round(Math.min(Math.max(s,0),H)),C=new c.d(this,2);if(C.type=w.type,C.format=w.format,C.width=Math.pow(2,Math.max(Math.log2(I)-b,0)),C.height=C.width,C.isCube=!0,C._cachedWrapU=0,C._cachedWrapV=0,this._bindTextureDirectly(E.TEXTURE_CUBE_MAP,C,!0),C.samplingMode=2,E.texParameteri(E.TEXTURE_CUBE_MAP,E.TEXTURE_MAG_FILTER,E.LINEAR),E.texParameteri(E.TEXTURE_CUBE_MAP,E.TEXTURE_MIN_FILTER,E.LINEAR),E.texParameteri(E.TEXTURE_CUBE_MAP,E.TEXTURE_WRAP_S,E.CLAMP_TO_EDGE),E.texParameteri(E.TEXTURE_CUBE_MAP,E.TEXTURE_WRAP_T,E.CLAMP_TO_EDGE),n.isDDS){const k=n.info,T=n.data;this._unpackFlipY(k.isCompressed),W.UploadDDSLevels(this,C,T,k,!0,6,b)}else S.d.Warn("DDS is the only prefiltered cube map supported so far.");this._bindTextureDirectly(E.TEXTURE_CUBE_MAP,null);const r=new z.b(k);r._isCube=!0,r._texture=C,C.isReady=!0,J.push(r)}w._lodTextureHigh=J[2],w._lodTextureMid=J[1],w._lodTextureLow=J[0],G&&G(w)}),w,E,I,P,K,Q)},Q.ThinEngine.prototype.createUniformBuffer=function(n,k){const T=this._gl.createBuffer();if(!T)throw new Error("Unable to create uniform buffer");const c=new I.c(T);return this.bindUniformBuffer(c),n instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,n,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(n),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),c.references=1,c},Q.ThinEngine.prototype.createDynamicUniformBuffer=function(n,k){const T=this._gl.createBuffer();if(!T)throw new Error("Unable to create dynamic uniform buffer");const c=new I.c(T);return this.bindUniformBuffer(c),n instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,n,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(n),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),c.references=1,c},Q.ThinEngine.prototype.updateUniformBuffer=function(n,k,T,c){this.bindUniformBuffer(n),void 0===T&&(T=0),void 0===c?k instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,T,k):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,T,new Float32Array(k)):k instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,k.subarray(T,T+c)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(k).subarray(T,T+c)),this.bindUniformBuffer(null)},Q.ThinEngine.prototype.bindUniformBuffer=function(n){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,n?n.underlyingResource:null)},Q.ThinEngine.prototype.bindUniformBufferBase=function(n,k,T){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,k,n?n.underlyingResource:null)},Q.ThinEngine.prototype.bindUniformBlock=function(n,k,T){const c=n.program,K=this._gl.getUniformBlockIndex(c,k);4294967295!==K&&this._gl.uniformBlockBinding(c,K,T)};var r=T(551),q=T(615);q.b.prototype.displayLoadingUI=function(){if(!(0,r.k)())return;const n=this.loadingScreen;n&&n.displayLoadingUI()},q.b.prototype.hideLoadingUI=function(){if(!(0,r.k)())return;const n=this._loadingScreen;n&&n.hideLoadingUI()},Object.defineProperty(q.b.prototype,"loadingScreen",{get:function(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=q.b.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen},set:function(n){this._loadingScreen=n},enumerable:!0,configurable:!0}),Object.defineProperty(q.b.prototype,"loadingUIText",{set:function(n){this.loadingScreen.loadingUIText=n},enumerable:!0,configurable:!0}),Object.defineProperty(q.b.prototype,"loadingUIBackgroundColor",{set:function(n){this.loadingScreen.loadingUIBackgroundColor=n},enumerable:!0,configurable:!0}),q.b.prototype.getInputElement=function(){return this._renderingCanvas},q.b.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null},q.b.prototype.getInputElementClientRect=function(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null},q.b.prototype.getAspectRatio=function(n){let k=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const T=n.viewport;return this.getRenderWidth(k)*T.width/(this.getRenderHeight(k)*T.height)},q.b.prototype.getScreenAspectRatio=function(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)},q.b.prototype._verifyPointerLock=function(){var n;null===(n=this._onPointerLockChange)||void 0===n||n.call(this)},q.b.prototype.setAlphaEquation=function(n){if(this._alphaEquation!==n){switch(n){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774)}this._alphaEquation=n}},q.b.prototype.getInputElement=function(){return this._renderingCanvas},q.b.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc},q.b.prototype.setDepthFunction=function(n){this._depthCullingState.depthFunc=n},q.b.prototype.setDepthFunctionToGreater=function(){this.setDepthFunction(516)},q.b.prototype.setDepthFunctionToGreaterOrEqual=function(){this.setDepthFunction(518)},q.b.prototype.setDepthFunctionToLess=function(){this.setDepthFunction(513)},q.b.prototype.setDepthFunctionToLessOrEqual=function(){this.setDepthFunction(515)},q.b.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask},q.b.prototype.setDepthWrite=function(n){this._depthCullingState.depthMask=n},q.b.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest},q.b.prototype.setStencilBuffer=function(n){this._stencilState.stencilTest=n},q.b.prototype.getStencilMask=function(){return this._stencilState.stencilMask},q.b.prototype.setStencilMask=function(n){this._stencilState.stencilMask=n},q.b.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc},q.b.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef},q.b.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask},q.b.prototype.setStencilFunction=function(n){this._stencilState.stencilFunc=n},q.b.prototype.setStencilFunctionReference=function(n){this._stencilState.stencilFuncRef=n},q.b.prototype.setStencilFunctionMask=function(n){this._stencilState.stencilFuncMask=n},q.b.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail},q.b.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail},q.b.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass},q.b.prototype.setStencilOperationFail=function(n){this._stencilState.stencilOpStencilFail=n},q.b.prototype.setStencilOperationDepthFail=function(n){this._stencilState.stencilOpDepthFail=n},q.b.prototype.setStencilOperationPass=function(n){this._stencilState.stencilOpStencilDepthPass=n},q.b.prototype.cacheStencilState=function(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()},q.b.prototype.restoreStencilState=function(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)},q.b.prototype.setAlphaConstants=function(n,k,T,c){this._alphaState.setAlphaBlendConstants(n,k,T,c)},q.b.prototype.getAlphaMode=function(){return this._alphaMode},q.b.prototype.getAlphaEquation=function(){return this._alphaEquation},q.b.prototype.getRenderPassNames=function(){return this._renderPassNames},q.b.prototype.getCurrentRenderPassName=function(){return this._renderPassNames[this.currentRenderPassId]},q.b.prototype.createRenderPassId=function(n){const k=++q.b._RenderPassIdCounter;return this._renderPassNames[k]=n??"NONAME",k},q.b.prototype.releaseRenderPassId=function(n){this._renderPassNames[n]=void 0;for(let k=0;k<this.scenes.length;++k){const T=this.scenes[k];for(let k=0;k<T.meshes.length;++k){const c=T.meshes[k];if(c.si)for(let k=0;k<c.si.length;++k){c.si[k]._removeDrawWrapper(n)}}}};T(2444);function O(n){if(n.requestPointerLock){const k=n.requestPointerLock();k instanceof Promise?k.then((()=>{n.focus()})).catch((()=>{})):n.focus()}}var u=T(2447),f=T(610);class A extends Q.ThinEngine{static get NpmPackage(){return q.b.NpmPackage}static get Version(){return q.b.Version}static get Instances(){return K.e.Instances}static get LastCreatedEngine(){return K.e.LastCreatedEngine}static get LastCreatedScene(){return K.e.LastCreatedScene}static DefaultLoadingScreenFactory(n){return q.b.DefaultLoadingScreenFactory(n)}get _supportsHardwareTextureRescaling(){return!!A._RescalePostProcessFactory}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}get performanceMonitor(){return this._performanceMonitor}constructor(n,k,T){super(n,k,T,arguments.length>3&&void 0!==arguments[3]&&arguments[3]),this.customAnimationFrameRequester=null,this._performanceMonitor=new w,this._drawCalls=new u.d,n&&(this._features.supportRenderPasses=!0,T=this._creationOptions)}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(n){super._sharedInit(n),function(n,k,T){n._onCanvasFocus=()=>{n.onCanvasFocusObservable.notifyObservers(n)},n._onCanvasBlur=()=>{n.onCanvasBlurObservable.notifyObservers(n)},n._onCanvasContextMenu=k=>{n.disableContextMenu&&k.preventDefault()},k.addEventListener("focus",n._onCanvasFocus),k.addEventListener("blur",n._onCanvasBlur),k.addEventListener("contextmenu",n._onCanvasContextMenu),n._onBlur=()=>{n.disablePerformanceMonitorInBackground&&n.performanceMonitor.disable(),n._windowIsBackground=!0},n._onFocus=()=>{n.disablePerformanceMonitorInBackground&&n.performanceMonitor.enable(),n._windowIsBackground=!1},n._onCanvasPointerOut=T=>{document.elementFromPoint(T.clientX,T.clientY)!==k&&n.onCanvasPointerOutObservable.notifyObservers(T)};const c=n.getHostWindow();c&&"function"===typeof c.addEventListener&&(c.addEventListener("blur",n._onBlur),c.addEventListener("focus",n._onFocus)),k.addEventListener("pointerout",n._onCanvasPointerOut),T.doNotHandleTouchAction||function(n){n&&n.setAttribute&&(n.setAttribute("touch-action","none"),n.style.touchAction="none",n.style.webkitTapHighlightColor="transparent")}(k),!q.b.audioEngine&&T.audioEngine&&q.b.AudioEngineFactory&&(q.b.audioEngine=q.b.AudioEngineFactory(n.getRenderingCanvas(),n.getAudioContext(),n.getAudioDestination())),(0,r.f)()&&(n._onFullscreenChange=()=>{n.isFullscreen=!!document.fullscreenElement,n.isFullscreen&&n._pointerLockRequested&&k&&O(k)},document.addEventListener("fullscreenchange",n._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",n._onFullscreenChange,!1),n._onPointerLockChange=()=>{n.isPointerLock=document.pointerLockElement===k},document.addEventListener("pointerlockchange",n._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",n._onPointerLockChange,!1)),n.enableOfflineSupport=void 0!==q.b.OfflineProviderFactory,n._deterministicLockstep=!!T.deterministicLockstep,n._lockstepMaxSteps=T.lockstepMaxSteps||0,n._timeStep=T.timeStep||1/60}(this,n,this._creationOptions)}resizeImageBitmap(n,k,T){return function(n,k,T,c){const K=n.createCanvas(T,c).getContext("2d");if(!K)throw new Error("Unable to get 2d context for resizeImageBitmap");return K.drawImage(k,0,0),K.getImageData(0,0,T,c).data}(this,n,k,T)}async _createImageBitmapFromSource(n,k){return await async function(n,k,T){return await new Promise(((c,K)=>{const Q=new Image;Q.onload=()=>{Q.decode().then((()=>{n.createImageBitmap(Q,T).then((n=>{c(n)}))}))},Q.onerror=()=>{K(`Error loading image ${Q.src}`)},Q.src=k}))}(this,n,k)}switchFullscreen(n){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(n)}enterFullscreen(n){this.isFullscreen||(this._pointerLockRequested=n,this._renderingCanvas&&function(n){const k=n.requestFullscreen||n.webkitRequestFullscreen;k&&k.call(n)}(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&function(){const n=document;document.exitFullscreen?document.exitFullscreen():n.webkitCancelFullScreen&&n.webkitCancelFullScreen()}()}setDitheringState(n){n?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(n){n?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}setDirectViewport(n,k,T,c){const K=this._cachedViewport;return this._cachedViewport=null,this._viewport(n,k,T,c),K}scissorClear(n,k,T,c,K){this.enableScissor(n,k,T,c),this.clear(K,!0,!0,!0),this.disableScissor()}enableScissor(n,k,T,c){const K=this._gl;K.enable(K.SCISSOR_TEST),K.scissor(n,k,T,c)}disableScissor(){const n=this._gl;n.disable(n.SCISSOR_TEST)}async _loadFileAsync(n,k,T){return await new Promise(((c,K)=>{this._loadFile(n,(n=>{c(n)}),void 0,k,T,((n,k)=>{K(k)}))}))}getVertexShaderSource(n){const k=this._gl.getAttachedShaders(n);return k?this._gl.getShaderSource(k[0]):null}getFragmentShaderSource(n){const k=this._gl.getAttachedShaders(n);return k?this._gl.getShaderSource(k[1]):null}set framebufferDimensionsObject(n){this._framebufferDimensionsObject=n,this._framebufferDimensionsObject&&this.onResizeObservable.notifyObservers(this)}_rebuildBuffers(){for(const n of this.scenes)n.resetCachedMaterial(),n._rebuildGeometries();for(const n of this._virtualScenes)n.resetCachedMaterial(),n._rebuildGeometries();super._rebuildBuffers()}getFontOffset(n){return function(n){const k=document.createElement("span");k.textContent="Hg",k.style.font=n;const T=document.createElement("div");T.style.display="inline-block",T.style.width="1px",T.style.height="0px",T.style.verticalAlign="bottom";const c=document.createElement("div");c.style.whiteSpace="nowrap",c.appendChild(k),c.appendChild(T),document.body.appendChild(c);let K=0,Q=0;try{Q=T.getBoundingClientRect().top-k.getBoundingClientRect().top,T.style.verticalAlign="baseline",K=T.getBoundingClientRect().top-k.getBoundingClientRect().top}finally{document.body.removeChild(c)}return{ascent:K,height:Q,descent:Q-K}}(n)}_cancelFrame(){if(this.customAnimationFrameRequester){if(0!==this._frameHandler){this._frameHandler=0;const{cancelAnimationFrame:n}=this.customAnimationFrameRequester;n&&n(this.customAnimationFrameRequester.v)}}else super._cancelFrame()}_renderLoop(n){this._processFrame(n),this._activeRenderLoops.length>0&&0===this._frameHandler&&(this.customAnimationFrameRequester?(this.customAnimationFrameRequester.v=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.v):this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()))}enterPointerlock(){this._renderingCanvas&&O(this._renderingCanvas)}exitPointerlock(){document.exitPointerLock&&document.exitPointerLock()}Ei(){this._measureFps(),super.Ei()}_deletePipelineContext(n){const k=n;k&&k.program&&k.transformFeedback&&(this.deleteTransformFeedback(k.transformFeedback),k.transformFeedback=null),super._deletePipelineContext(n)}createShaderProgram(n,k,T,c,K){let Q=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;K=K||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);const G=super.createShaderProgram(n,k,T,c,K,Q);return this.onAfterShaderCompilationObservable.notifyObservers(this),G}_createShaderProgram(n,k,T,c){let K=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const Q=c.createProgram();if(n.program=Q,!Q)throw new Error("Unable to create program");if(c.attachShader(Q,k),c.attachShader(Q,T),this.webGLVersion>1&&K){const k=this.createTransformFeedback();this.bindTransformFeedback(k),this.setTranformFeedbackVaryings(Q,K),n.transformFeedback=k}return c.linkProgram(Q),this.webGLVersion>1&&K&&this.bindTransformFeedback(null),n.context=c,n.vertexShader=k,n.fragmentShader=T,n.isParallelCompiled||this._finalizePipelineContext(n),Q}_releaseTexture(n){super._releaseTexture(n)}_releaseRenderTargetWrapper(n){super._releaseRenderTargetWrapper(n);for(const k of this.scenes){for(const T of k.postProcesses)T._outputTexture===n&&(T._outputTexture=null);for(const T of k.cameras)for(const k of T._postProcesses)k&&k._outputTexture===n&&(k._outputTexture=null)}}_rescaleTexture(n,k,T,c,K){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);const Q=this.createRenderTargetTexture({width:k.width,height:k.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});if(!this._rescalePostProcess&&A._RescalePostProcessFactory&&(this._rescalePostProcess=A._RescalePostProcessFactory(this)),this._rescalePostProcess){this._rescalePostProcess.externalTextureSamplerBinding=!0;const G=()=>{this._rescalePostProcess.onApply=function(k){k._bindTexture("textureSampler",n)};let G=T;G||(G=this.scenes[this.scenes.length-1]),G.postProcessManager.directRender([this._rescalePostProcess],Q,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,k,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,c,0,0,k.width,k.height,0),this.unBindFramebuffer(Q),Q.dispose(),K&&K()},w=this._rescalePostProcess.getEffect();w?w.executeWhenCompiled(G):this._rescalePostProcess.onEffectCreatedObservable.addOnce((n=>{n.executeWhenCompiled(G)}))}}wrapWebGLTexture(n){let k=arguments.length>1&&void 0!==arguments[1]&&arguments[1],T=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3,K=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,Q=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;const G=new P.c(n,this._gl),w=new c.d(this,0,!0);return w._hardwareTexture=G,w.baseWidth=K,w.baseHeight=Q,w.width=K,w.height=Q,w.isReady=!0,w.useMipMaps=k,this.updateTextureSamplingMode(T,w),w}_uploadImageToTexture(n,k){let T=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const K=this._gl,Q=this._getWebGLTextureType(n.type),G=this._getInternalFormat(n.format),w=this._getRGBABufferInternalSizedFormat(n.type,G),E=n.isCube?K.TEXTURE_CUBE_MAP:K.TEXTURE_2D;this._bindTextureDirectly(E,n,!0),this._unpackFlipY(n.invertY);let I=K.TEXTURE_2D;n.isCube&&(I=K.TEXTURE_CUBE_MAP_POSITIVE_X+T),K.texImage2D(I,c,w,G,Q,k),this._bindTextureDirectly(E,null,!0)}updateTextureComparisonFunction(n,k){if(1===this.webGLVersion)return void S.d.Error("WebGL 1 does not support texture comparison.");const T=this._gl;n.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,n,!0),0===k?(T.texParameteri(T.TEXTURE_CUBE_MAP,T.TEXTURE_COMPARE_FUNC,515),T.texParameteri(T.TEXTURE_CUBE_MAP,T.TEXTURE_COMPARE_MODE,T.NONE)):(T.texParameteri(T.TEXTURE_CUBE_MAP,T.TEXTURE_COMPARE_FUNC,k),T.texParameteri(T.TEXTURE_CUBE_MAP,T.TEXTURE_COMPARE_MODE,T.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,n,!0),0===k?(T.texParameteri(T.TEXTURE_2D,T.TEXTURE_COMPARE_FUNC,515),T.texParameteri(T.TEXTURE_2D,T.TEXTURE_COMPARE_MODE,T.NONE)):(T.texParameteri(T.TEXTURE_2D,T.TEXTURE_COMPARE_FUNC,k),T.texParameteri(T.TEXTURE_2D,T.TEXTURE_COMPARE_MODE,T.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),n._comparisonFunction=k}createInstancesBuffer(n){const k=this._gl.createBuffer();if(!k)throw new Error("Unable to create instance buffer");const T=new I.c(k);return T.Vh=n,this.bindArrayBuffer(T),this._gl.bufferData(this._gl.ARRAY_BUFFER,n,this._gl.DYNAMIC_DRAW),T.references=1,T}deleteInstancesBuffer(n){this._gl.deleteBuffer(n)}async _clientWaitAsync(n){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,T=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;const c=this._gl;return await new Promise(((K,Q)=>{(0,f.f)((()=>{const T=c.clientWaitSync(n,k,0);if(T==c.WAIT_FAILED)throw new Error("clientWaitSync failed");return T!=c.TIMEOUT_EXPIRED}),K,Q,T)}))}_readPixelsAsync(n,k,T,c,K,Q,G){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");const w=this._gl,E=w.createBuffer();w.bindBuffer(w.PIXEL_PACK_BUFFER,E),w.bufferData(w.PIXEL_PACK_BUFFER,G.byteLength,w.STREAM_READ),w.readPixels(n,k,T,c,K,Q,0),w.bindBuffer(w.PIXEL_PACK_BUFFER,null);const I=w.fenceSync(w.SYNC_GPU_COMMANDS_COMPLETE,0);return I?(w.flush(),this._clientWaitAsync(I,0,10).then((()=>(w.deleteSync(I),w.bindBuffer(w.PIXEL_PACK_BUFFER,E),w.getBufferSubData(w.PIXEL_PACK_BUFFER,0,G),w.bindBuffer(w.PIXEL_PACK_BUFFER,null),w.deleteBuffer(E),G)))):null}dispose(){this.hideLoadingUI(),this._rescalePostProcess&&this._rescalePostProcess.dispose(),function(n,k){1===K.e.Instances.length&&q.b.audioEngine&&(q.b.audioEngine.dispose(),q.b.audioEngine=null);const T=n.getHostWindow();T&&"function"===typeof T.removeEventListener&&(T.removeEventListener("blur",n._onBlur),T.removeEventListener("focus",n._onFocus)),k&&(k.removeEventListener("focus",n._onCanvasFocus),k.removeEventListener("blur",n._onCanvasBlur),k.removeEventListener("pointerout",n._onCanvasPointerOut),k.removeEventListener("contextmenu",n._onCanvasContextMenu)),(0,r.f)()&&(document.removeEventListener("fullscreenchange",n._onFullscreenChange),document.removeEventListener("mozfullscreenchange",n._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",n._onFullscreenChange),document.removeEventListener("msfullscreenchange",n._onFullscreenChange),document.removeEventListener("pointerlockchange",n._onPointerLockChange),document.removeEventListener("mspointerlockchange",n._onPointerLockChange),document.removeEventListener("mozpointerlockchange",n._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",n._onPointerLockChange))}(this,this._renderingCanvas),super.dispose()}}A.ALPHA_DISABLE=0,A.ALPHA_ADD=1,A.ALPHA_COMBINE=2,A.ALPHA_SUBTRACT=3,A.ALPHA_MULTIPLY=4,A.ALPHA_MAXIMIZED=5,A.ALPHA_ONEONE=6,A.ALPHA_PREMULTIPLIED=7,A.ALPHA_PREMULTIPLIED_PORTERDUFF=8,A.ALPHA_INTERPOLATE=9,A.ALPHA_SCREENMODE=10,A.DELAYLOADSTATE_NONE=0,A.DELAYLOADSTATE_LOADED=1,A.DELAYLOADSTATE_LOADING=2,A.DELAYLOADSTATE_NOTLOADED=4,A.NEVER=512,A.ALWAYS=519,A.LESS=513,A.EQUAL=514,A.LEQUAL=515,A.GREATER=516,A.GEQUAL=518,A.NOTEQUAL=517,A.KEEP=7680,A.REPLACE=7681,A.INCR=7682,A.DECR=7683,A.INVERT=5386,A.INCR_WRAP=34055,A.DECR_WRAP=34056,A.TEXTURE_CLAMP_ADDRESSMODE=0,A.TEXTURE_WRAP_ADDRESSMODE=1,A.TEXTURE_MIRROR_ADDRESSMODE=2,A.TEXTUREFORMAT_ALPHA=0,A.TEXTUREFORMAT_LUMINANCE=1,A.TEXTUREFORMAT_LUMINANCE_ALPHA=2,A.TEXTUREFORMAT_RGB=4,A.TEXTUREFORMAT_RGBA=5,A.TEXTUREFORMAT_RED=6,A.TEXTUREFORMAT_R=6,A.TEXTUREFORMAT_R16_UNORM=33322,A.TEXTUREFORMAT_RG16_UNORM=33324,A.TEXTUREFORMAT_RGB16_UNORM=32852,A.TEXTUREFORMAT_RGBA16_UNORM=32859,A.TEXTUREFORMAT_R16_SNORM=36760,A.TEXTUREFORMAT_RG16_SNORM=36761,A.TEXTUREFORMAT_RGB16_SNORM=36762,A.TEXTUREFORMAT_RGBA16_SNORM=36763,A.TEXTUREFORMAT_RG=7,A.TEXTUREFORMAT_RED_INTEGER=8,A.TEXTUREFORMAT_R_INTEGER=8,A.TEXTUREFORMAT_RG_INTEGER=9,A.TEXTUREFORMAT_RGB_INTEGER=10,A.TEXTUREFORMAT_RGBA_INTEGER=11,A.TEXTURETYPE_UNSIGNED_BYTE=0,A.TEXTURETYPE_UNSIGNED_INT=0,A.TEXTURETYPE_FLOAT=1,A.TEXTURETYPE_HALF_FLOAT=2,A.TEXTURETYPE_BYTE=3,A.TEXTURETYPE_SHORT=4,A.TEXTURETYPE_UNSIGNED_SHORT=5,A.TEXTURETYPE_INT=6,A.TEXTURETYPE_UNSIGNED_INTEGER=7,A.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,A.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,A.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,A.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,A.TEXTURETYPE_UNSIGNED_INT_24_8=12,A.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,A.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,A.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,A.TEXTURE_NEAREST_SAMPLINGMODE=1,A.TEXTURE_BILINEAR_SAMPLINGMODE=2,A.TEXTURE_TRILINEAR_SAMPLINGMODE=3,A.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,A.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,A.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,A.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,A.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,A.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,A.TEXTURE_NEAREST_LINEAR=7,A.TEXTURE_NEAREST_NEAREST=1,A.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,A.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,A.TEXTURE_LINEAR_LINEAR=2,A.TEXTURE_LINEAR_NEAREST=12,A.TEXTURE_EXPLICIT_MODE=0,A.TEXTURE_SPHERICAL_MODE=1,A.TEXTURE_PLANAR_MODE=2,A.TEXTURE_CUBIC_MODE=3,A.TEXTURE_PROJECTION_MODE=4,A.TEXTURE_SKYBOX_MODE=5,A.TEXTURE_INVCUBIC_MODE=6,A.TEXTURE_EQUIRECTANGULAR_MODE=7,A.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,A.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,A.SCALEMODE_FLOOR=1,A.SCALEMODE_NEAREST=2,A.SCALEMODE_CEILING=3},2437:(n,k,T)=>{T.d(k,{e:()=>K});var c=T(2411);class K{get depthStencilTexture(){return this._depthStencilTexture}setDepthStencilTexture(n){(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&this._depthStencilTexture&&this._depthStencilTexture.dispose(),this._depthStencilTexture=n,this._generateDepthBuffer=this._generateStencilBuffer=this._depthStencilTextureWithStencil=!1,n&&(this._generateDepthBuffer=!0,this._generateStencilBuffer=this._depthStencilTextureWithStencil=(0,c.e)(n.format))}get depthStencilTextureWithStencil(){return this._depthStencilTextureWithStencil}get isCube(){return this._isCube}get isMulti(){return this._isMulti}get is2DArray(){return this.layers>0}get is3D(){return this.depth>0}get size(){return this.width}get width(){return this._size.width??this._size}get height(){return this._size.height??this._size}get layers(){return this._size.layers||0}get depth(){return this._size.depth||0}get texture(){var n;return(null===(n=this._textures)||void 0===n?void 0:n[0])??null}get textures(){return this._textures}get faceIndices(){return this._faceIndices}get layerIndices(){return this._layerIndices}getBaseArrayLayer(n){var k,T;if(!this._textures)return-1;const c=this._textures[n],K=(null===(k=this._layerIndices)||void 0===k?void 0:k[n])??0,Q=(null===(T=this._faceIndices)||void 0===T?void 0:T[n])??0;return c.isCube?6*K+Q:c.is3D?0:K}get samples(){return this._samples}setSamples(n){let k=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],T=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this.samples===n&&!T)return n;const c=this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,n,k):this._engine.updateRenderTargetTextureSampleCount(this,n);return this._samples=n,c}resolveMSAATextures(){this.isMulti?this._engine.resolveMultiFramebuffer(this):this._engine.resolveFramebuffer(this)}generateMipMaps(){this._engine._currentRenderTarget===this&&this._engine.unBindFramebuffer(this,!0),this.isMulti?this._engine.generateMipMapsMultiFramebuffer(this):this._engine.generateMipMapsFramebuffer(this)}constructor(n,k,T,c,K){this._textures=null,this._faceIndices=null,this._layerIndices=null,this._samples=1,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this.disableAutomaticMSAAResolve=!1,this.resolveMSAAColors=!0,this.resolveMSAADepth=!1,this.resolveMSAAStencil=!1,this._isMulti=n,this._isCube=k,this._size=T,this._engine=c,this._depthStencilTexture=null,this.label=K}setTextures(n){Array.isArray(n)?this._textures=n:this._textures=n?[n]:null}setTexture(n){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,T=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._textures||(this._textures=[]),this._textures[k]!==n&&(this._textures[k]&&T&&this._textures[k].dispose(),this._textures[k]=n)}setLayerAndFaceIndices(n,k){this._layerIndices=n,this._faceIndices=k}setLayerAndFaceIndex(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,k=arguments.length>1?arguments[1]:void 0,T=arguments.length>2?arguments[2]:void 0;this._layerIndices||(this._layerIndices=[]),this._faceIndices||(this._faceIndices=[]),void 0!==k&&k>=0&&(this._layerIndices[n]=k),void 0!==T&&T>=0&&(this._faceIndices[n]=T)}createDepthStencilTexture(){var n;let k=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,T=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],c=arguments.length>2&&void 0!==arguments[2]&&arguments[2],K=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,Q=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14,G=arguments.length>5?arguments[5]:void 0;return null===(n=this._depthStencilTexture)||void 0===n||n.dispose(),this._depthStencilTextureWithStencil=c,this._depthStencilTextureLabel=G,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:T,comparisonFunction:k,generateStencil:c,isCube:this._isCube,samples:K,depthTextureFormat:Q,label:G},this),this._depthStencilTexture}_shareDepth(n){this.shareDepth(n)}shareDepth(n){this._depthStencilTexture&&(n._depthStencilTexture&&n._depthStencilTexture.dispose(),n._depthStencilTexture=this._depthStencilTexture,n._depthStencilTextureWithStencil=this._depthStencilTextureWithStencil,this._depthStencilTexture.incrementReferences())}_swapAndDie(n){this.texture&&this.texture._swapAndDie(n),this._textures=null,this.dispose(!0)}_cloneRenderTargetWrapper(){let n=null;if(this._isMulti){const k=this.textures;if(k&&k.length>0){let T=!1,c=k.length,K=-1;const Q=k[k.length-1]._source;14!==Q&&12!==Q||(T=!0,K=k[k.length-1].format,c--);const G=[],w=[],E=[],I=[],S=[],P=[],W=[],J={};for(let n=0;n<c;++n){const T=k[n];G.push(T.samplingMode),w.push(T.type),E.push(T.format);void 0!==J[T.uniqueId]?(I.push(-1),W.push(0)):(J[T.uniqueId]=n,T.is2DArray?(I.push(35866),W.push(T.depth)):T.isCube?(I.push(34067),W.push(0)):T.is3D?(I.push(32879),W.push(T.depth)):(I.push(3553),W.push(0))),this._faceIndices&&S.push(this._faceIndices[n]??0),this._layerIndices&&P.push(this._layerIndices[n]??0)}const H={samplingModes:G,generateMipMaps:k[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:T,depthTextureFormat:K,types:w,formats:E,textureCount:c,targetTypes:I,faceIndex:S,layerIndex:P,layerCounts:W,label:this.label},s={width:this.width,height:this.height,depth:this.depth};n=this._engine.createMultipleRenderTarget(s,H);for(let b=0;b<c;++b){if(-1!==I[b])continue;const T=J[k[b].uniqueId];n.setTexture(n.textures[T],b)}}}else{var k,T,c,K;const G={};if(G.generateDepthBuffer=this._generateDepthBuffer,G.generateMipMaps=(null===(k=this.texture)||void 0===k?void 0:k.generateMipMaps)??!1,G.generateStencilBuffer=this._generateStencilBuffer,G.samplingMode=null===(T=this.texture)||void 0===T?void 0:T.samplingMode,G.type=null===(c=this.texture)||void 0===c?void 0:c.type,G.format=null===(K=this.texture)||void 0===K?void 0:K.format,G.noColorAttachment=!this._textures,G.label=this.label,this.isCube)n=this._engine.createRenderTargetCubeTexture(this.width,G);else{var Q;const k={width:this.width,height:this.height,layers:this.is2DArray||this.is3D?null===(Q=this.texture)||void 0===Q?void 0:Q.depth:void 0};n=this._engine.createRenderTargetTexture(k,G)}n.texture&&(n.texture.isReady=!0)}return n}_swapRenderTargetWrapper(n){if(this._textures&&n._textures)for(let k=0;k<this._textures.length;++k)this._textures[k]._swapAndDie(n._textures[k],!1),n._textures[k].isReady=!0;this._depthStencilTexture&&n._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(n._depthStencilTexture),n._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null}_rebuild(){const n=this._cloneRenderTargetWrapper();if(n){if(this._depthStencilTexture){const k=this._depthStencilTexture.samplingMode,T=this._depthStencilTexture.format,c=2===k||3===k||11===k;n.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,c,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples,T,this._depthStencilTextureLabel)}this.samples>1&&n.setSamples(this.samples),n._swapRenderTargetWrapper(this),n.dispose()}}releaseTextures(){if(this._textures)for(let n=0;n<this._textures.length;++n)this._textures[n].dispose();this._textures=null}dispose(){var n;arguments.length>0&&void 0!==arguments[0]&&arguments[0]||(null===(n=this._depthStencilTexture)||void 0===n||n.dispose(),this._depthStencilTexture=null,this.releaseTextures());this._engine._releaseRenderTargetWrapper(this)}}},2391:(n,k,T)=>{T.r(k),T.d(k,{ThinEngine:()=>q});var c=T(637),K=T(2394),Q=T(556),G=T(551);class w{constructor(){this.shaderLanguage=0}postProcessor(n,k,T,c,K){if(K.drawBuffersExtensionDisabled){const k=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;n=n.replace(k,"")}return n}}const E=/(flat\s)?\s*varying\s*.*/;class I{constructor(){this.shaderLanguage=0}attributeProcessor(n){return n.replace("attribute","in")}varyingCheck(n,k){return E.test(n)}varyingProcessor(n,k){return n.replace("varying",k?"in":"out")}postProcessor(n,k,T){const c=-1!==n.search(/#extension.+GL_EXT_draw_buffers.+require/);if(n=(n=n.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),T){const k=-1!==n.search(/layout *\(location *= *0\) *out/g);n=(n=(n=(n=(n=(n=(n=n.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/void\s+?main\s*\(/g,(c||k?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(")}else{if(-1!==k.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+n}return n}}var S=T(2399),P=T(693),W=T(615),J=T(2405),H=T(654),s=T(617),b=T(606),C=T(629),z=T(2411);class r{}class q extends W.b{get name(){return this._name}set name(n){this._name=n}get version(){return this._webGLVersion}static get ShadersRepository(){return s.b.ShadersRepository}static set ShadersRepository(n){s.b.ShadersRepository=n}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(n){this._framebufferDimensionsObject=n}snapshotRenderingReset(){this.snapshotRendering=!1}constructor(n,k,T,K){if(T=T||{},super(k??T.antialias,T,K),this._name="WebGL",this.forcePOTTextures=!1,this.validateShaderPrograms=!1,this.disableUniformBuffers=!1,this._webGLVersion=1,this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},!n)return;let G=null;if(n.getContext){if(G=n,void 0===T.Sg&&(T.Sg=!1),void 0===T.xrCompatible&&(T.xrCompatible=!1),navigator&&navigator.userAgent){this._setupMobileChecks();const n=navigator.userAgent;for(const k of q.ExceptionList){const c=k.key,K=k.targets;if(new RegExp(c).test(n)){if(k.capture&&k.captureConstraint){const T=k.capture,c=k.captureConstraint,K=new RegExp(T).exec(n);if(K&&K.length>0){if(parseInt(K[K.length-1])>=c)continue}}for(const n of K)switch(n){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":T.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1}}}}if(this._doNotHandleContextLost?this._onContextLost=()=>{(0,c.z)(this._gl)}:(this._onContextLost=n=>{n.preventDefault(),this._contextWasLost=!0,(0,c.z)(this._gl),Q.d.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost((()=>this._initGLContext()))},G.addEventListener("webglcontextrestored",this._onContextRestored,!1),T.powerPreference=T.powerPreference||"high-performance"),G.addEventListener("webglcontextlost",this._onContextLost,!1),this._badDesktopOS&&(T.xrCompatible=!1),!T.disableWebGL2Support)try{this._gl=G.getContext("webgl2",T)||G.getContext("experimental-webgl2",T),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch(P){}if(!this._gl){if(!G)throw new Error("The provided canvas is null or undefined.");try{this._gl=G.getContext("webgl",T)||G.getContext("experimental-webgl",T)}catch(P){throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=n,G=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const k=this._gl.getContextAttributes();k&&(T.stencil=k.stencil)}this._sharedInit(G),this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),void 0!==T.useHighPrecisionFloats&&(this._highPrecisionShadersAllowed=T.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let c=0;c<this._caps.maxVertexAttribs;c++)this._currentBufferPointers[c]=new r;this._shaderProcessor=this.webGLVersion>1?new I:new w;const E=`Babylon.js v${q.Version}`;Q.d.Log(E+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",E);const S=(0,c.A)(this._gl);S.validateShaderPrograms=this.validateShaderPrograms,S.parallelShaderCompile=this._caps.parallelShaderCompile}_clearEmptyResources(){this._dummyFramebuffer=null,super._clearEmptyResources()}_getShaderProcessingContext(n){return null}areAllEffectsReady(){for(const n in this._compiledEffects){if(!this._compiledEffects[n].isReady())return!1}return!0}_initGLContext(){this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||null!==this._gl.getExtension("OES_standard_derivatives"),maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||null!==this._gl.getExtension("OES_element_index_uint"),fragmentDepthSupported:this._webGLVersion>1||null!==this._gl.getExtension("EXT_frag_depth"),highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,colorBufferHalfFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_half_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:1!==this._webGLVersion,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1,textureNorm16:!!this._gl.getExtension("EXT_texture_norm16")},this._caps.supportFloatTexturesResolve=this._caps.colorBufferFloat,this._caps.rg11b10ufColorRenderable=this._caps.colorBufferFloat,this._glVersion=this._gl.getParameter(this._gl.VERSION);const n=this._gl.getExtension("WEBGL_debug_renderer_info");if(null!=n&&(this._glRenderer=this._gl.getParameter(n.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(n.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),36193!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=36193),34842!==this._gl.RGBA16F&&(this._gl.RGBA16F=34842),34836!==this._gl.RGBA32F&&(this._gl.RGBA32F=34836),35056!==this._gl.DEPTH24_STENCIL8&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(1===this._webGLVersion&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=(this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)??0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!(!this._caps.textureFloat||!this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!(!this._caps.textureFloat||!this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.textureNorm16&&(this._gl.R16_EXT=33322,this._gl.RG16_EXT=33324,this._gl.RGB16_EXT=32852,this._gl.RGBA16_EXT=32859,this._gl.R16_SNORM_EXT=36760,this._gl.RG16_SNORM_EXT=36761,this._gl.RGB16_SNORM_EXT=36762,this._gl.RGBA16_SNORM_EXT=36763),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&5131!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=null!==this._maxMSAASamplesOverride?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES),this._caps.maxDrawBuffers=this._gl.getParameter(this._gl.MAX_DRAW_BUFFERS);else{const n=this._gl.getExtension("WEBGL_draw_buffers");if(null!==n){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=n.drawBuffersWEBGL.bind(n),this._caps.maxDrawBuffers=this._gl.getParameter(n.MAX_DRAW_BUFFERS_WEBGL),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let k=0;k<16;k++)this._gl["COLOR_ATTACHMENT"+k+"_WEBGL"]=n["COLOR_ATTACHMENT"+k+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{const n=this._gl.getExtension("WEBGL_depth_texture");null!=n&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=n.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{const n=this._gl.getExtension("OES_vertex_array_object");null!=n&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=n.createVertexArrayOES.bind(n),this._gl.bindVertexArray=n.bindVertexArrayOES.bind(n),this._gl.deleteVertexArray=n.deleteVertexArrayOES.bind(n))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{const n=this._gl.getExtension("ANGLE_instanced_arrays");null!=n?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=n.drawArraysInstancedANGLE.bind(n),this._gl.drawElementsInstanced=n.drawElementsInstancedANGLE.bind(n),this._gl.vertexAttribDivisor=n.vertexAttribDivisorANGLE.bind(n)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){const n=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),k=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);n&&k&&(this._caps.highPrecisionShaderSupported=0!==n.precision&&0!==k.precision)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{const n=this._gl.getExtension("EXT_blend_minmax");null!=n&&(this._caps.blendMinMax=!0,this._gl.MAX=n.MAX_EXT,this._gl.MIN=n.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:WebGL2RenderingContext.SRGB,SRGB8:WebGL2RenderingContext.SRGB8,SRGB8_ALPHA8:WebGL2RenderingContext.SRGB8_ALPHA8};else{const n=this._gl.getExtension("EXT_sRGB");null!=n&&(this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:n.SRGB_EXT,SRGB8:n.SRGB_ALPHA_EXT,SRGB8_ALPHA8:n.SRGB_ALPHA_EXT})}if(this._creationOptions){const n=this._creationOptions.forceSRGBBufferSupportState;void 0!==n&&(this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&n)}}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let k=0;k<this._maxSimultaneousTextures;k++)this._nextFreeTextureSlots.push(k);"Mali-G72"===this._glRenderer&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:"undefined"===typeof HTMLImageElement,supportRenderAndCopyToLodForFloatTextures:1!==this._webGLVersion,supportDepthStencilTexture:1!==this._webGLVersion,supportShadowSamplers:1!==this._webGLVersion,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:1!==this._webGLVersion,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:1!==this._webGLVersion,basisNeedsPOT:1===this._webGLVersion,support3DTextures:1!==this._webGLVersion,needTypeSuffixInShaderConstants:1!==this._webGLVersion,supportMSAA:1!==this._webGLVersion,supportSSAO2:1!==this._webGLVersion,supportIBLShadows:1!==this._webGLVersion,supportExtendedTextureFormats:1!==this._webGLVersion,supportSwitchCaseInShader:1!==this._webGLVersion,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,forceVertexBufferStrideAndOffsetMultiple4Bytes:!1,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const n=this._workingCanvas.getContext("2d");n&&(this._workingContext=n)}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}extractDriverInfo(){const n=this.getGlInfo();return n&&n.renderer?n.renderer:""}getRenderWidth(){return!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(){return!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}clear(n,k,T){let c=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const K=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=K;let Q=0;if(k&&n){let k=!0;if(this._currentRenderTarget){var G;const T=null===(G=this._currentRenderTarget.texture)||void 0===G?void 0:G.format;if(8===T||9===T||10===T||11===T){var w;const T=null===(w=this._currentRenderTarget.texture)||void 0===w?void 0:w.type;7===T||5===T?(q._TempClearColorUint32[0]=255*n.r,q._TempClearColorUint32[1]=255*n.g,q._TempClearColorUint32[2]=255*n.b,q._TempClearColorUint32[3]=255*n.a,this._gl.clearBufferuiv(this._gl.COLOR,0,q._TempClearColorUint32),k=!1):(q._TempClearColorInt32[0]=255*n.r,q._TempClearColorInt32[1]=255*n.g,q._TempClearColorInt32[2]=255*n.b,q._TempClearColorInt32[3]=255*n.a,this._gl.clearBufferiv(this._gl.COLOR,0,q._TempClearColorInt32),k=!1)}}k&&(this._gl.clearColor(n.r,n.g,n.b,void 0!==n.a?n.a:1),Q|=this._gl.COLOR_BUFFER_BIT)}T&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),Q|=this._gl.DEPTH_BUFFER_BIT),c&&(this._gl.clearStencil(0),Q|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(Q)}_viewport(n,k,T,c){n===this._viewportCached.x&&k===this._viewportCached.y&&T===this._viewportCached.z&&c===this._viewportCached.w||(this._viewportCached.x=n,this._viewportCached.y=k,this._viewportCached.z=T,this._viewportCached.w=c,this._gl.viewport(n,k,T,c))}Fi(){super.Fi(),this._badOS&&this.flushFramebuffer()}get performanceMonitor(){throw new Error("Not Supported by ThinEngine")}bindFramebuffer(n){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,T=arguments.length>2?arguments[2]:void 0,c=arguments.length>3?arguments[3]:void 0,K=arguments.length>4?arguments[4]:void 0,G=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,w=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;const E=n;this._currentRenderTarget&&this._resolveAndGenerateMipMapsFramebuffer(this._currentRenderTarget),this._currentRenderTarget=n,this._bindUnboundFramebuffer(E._framebuffer);const I=this._gl;var S;if(!n.isMulti)if(n.is2DArray||n.is3D)I.framebufferTextureLayer(I.FRAMEBUFFER,I.COLOR_ATTACHMENT0,null===(S=n.texture._hardwareTexture)||void 0===S?void 0:S.underlyingResource,G,w),E._currentLOD=G;else if(n.isCube){var P;I.framebufferTexture2D(I.FRAMEBUFFER,I.COLOR_ATTACHMENT0,I.TEXTURE_CUBE_MAP_POSITIVE_X+k,null===(P=n.texture._hardwareTexture)||void 0===P?void 0:P.underlyingResource,G)}else if(E._currentLOD!==G){var W;I.framebufferTexture2D(I.FRAMEBUFFER,I.COLOR_ATTACHMENT0,I.TEXTURE_2D,null===(W=n.texture._hardwareTexture)||void 0===W?void 0:W.underlyingResource,G),E._currentLOD=G}const J=n._depthStencilTexture;if(J){n.is3D&&(n.texture.width===J.width&&n.texture.height===J.height&&n.texture.depth===J.depth||Q.d.Warn("Depth/Stencil attachment for 3D target must have same dimensions as color attachment"));const T=n._depthStencilTextureWithStencil?I.DEPTH_STENCIL_ATTACHMENT:I.DEPTH_ATTACHMENT;var H;if(n.is2DArray||n.is3D)I.framebufferTextureLayer(I.FRAMEBUFFER,T,null===(H=J._hardwareTexture)||void 0===H?void 0:H.underlyingResource,G,w);else if(n.isCube){var s;I.framebufferTexture2D(I.FRAMEBUFFER,T,I.TEXTURE_CUBE_MAP_POSITIVE_X+k,null===(s=J._hardwareTexture)||void 0===s?void 0:s.underlyingResource,G)}else{var b;I.framebufferTexture2D(I.FRAMEBUFFER,T,I.TEXTURE_2D,null===(b=J._hardwareTexture)||void 0===b?void 0:b.underlyingResource,G)}}E._MSAAFramebuffer&&this._bindUnboundFramebuffer(E._MSAAFramebuffer),this._cachedViewport&&!K?this.setViewport(this._cachedViewport,T,c):(T||(T=n.width,G&&(T/=Math.pow(2,G))),c||(c=n.height,G&&(c/=Math.pow(2,G))),this._viewport(0,0,T,c)),this.wipeCaches()}setStateCullFaceType(n,k){const T=this.cullBackFaces??n??1?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==T||k)&&(this._depthCullingState.cullFace=T)}setState(n){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,T=arguments.length>2?arguments[2]:void 0,c=arguments.length>3&&void 0!==arguments[3]&&arguments[3],K=arguments.length>4?arguments[4]:void 0,Q=arguments.length>5?arguments[5]:void 0,G=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;(this._depthCullingState.cull!==n||T)&&(this._depthCullingState.cull=n),this.setStateCullFaceType(K,T),this.setZOffset(k),this.setZOffsetUnits(G);const w=c?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==w||T)&&(this._depthCullingState.frontFace=w),this._stencilStateComposer.stencilMaterial=Q}_resolveAndGenerateMipMapsFramebuffer(n){let k=arguments.length>1&&void 0!==arguments[1]&&arguments[1];n.disableAutomaticMSAAResolve||(n.isMulti?this.resolveMultiFramebuffer(n):this.resolveFramebuffer(n)),k||(n.isMulti?this.generateMipMapsMultiFramebuffer(n):this.generateMipMapsFramebuffer(n))}_bindUnboundFramebuffer(n){this._currentFramebuffer!==n&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,n),this._currentFramebuffer=n)}_currentFrameBufferIsDefaultFrameBuffer(){return null===this._currentFramebuffer}generateMipmaps(n){const k=this._getTextureTarget(n);this._bindTextureDirectly(k,n,!0),this._gl.generateMipmap(k),this._bindTextureDirectly(k,null)}unBindFramebuffer(n,k,T){const c=n;this._currentRenderTarget=null,this._resolveAndGenerateMipMapsFramebuffer(n,k),T&&(c._MSAAFramebuffer&&this._bindUnboundFramebuffer(c._framebuffer),T()),this._bindUnboundFramebuffer(null)}generateMipMapsFramebuffer(n){var k;n.isMulti||null===(k=n.texture)||void 0===k||!k.generateMipMaps||n.isCube||this.generateMipmaps(n.texture)}resolveFramebuffer(n){const k=n,T=this._gl;if(!k._MSAAFramebuffer||k.isMulti)return;let c=k.resolveMSAAColors?T.COLOR_BUFFER_BIT:0;c|=k._generateDepthBuffer&&k.resolveMSAADepth?T.DEPTH_BUFFER_BIT:0,c|=k._generateStencilBuffer&&k.resolveMSAAStencil?T.STENCIL_BUFFER_BIT:0,T.bindFramebuffer(T.READ_FRAMEBUFFER,k._MSAAFramebuffer),T.bindFramebuffer(T.DRAW_FRAMEBUFFER,k._framebuffer),T.blitFramebuffer(0,0,n.width,n.height,0,0,n.width,n.height,c,T.NEAREST)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(n,k,T){return this._createVertexBuffer(n,this._gl.STATIC_DRAW)}_createVertexBuffer(n,k){const T=this._gl.createBuffer();if(!T)throw new Error("Unable to create vertex buffer");const c=new S.c(T);return this.bindArrayBuffer(c),"number"!==typeof n?n instanceof Array?(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(n),k),c.Vh=4*n.length):(this._gl.bufferData(this._gl.ARRAY_BUFFER,n,k),c.Vh=n.byteLength):(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Uint8Array(n),k),c.Vh=n),this._resetVertexBufferBinding(),c.references=1,c}createDynamicVertexBuffer(n,k){return this._createVertexBuffer(n,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(n,k,T){const c=this._gl.createBuffer(),K=new S.c(c);if(!c)throw new Error("Unable to create index buffer");this.bindIndexBuffer(K);const Q=this._normalizeIndexData(n);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,Q,k?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),K.references=1,K.is32Bits=4===Q.BYTES_PER_ELEMENT,K}_normalizeIndexData(n){if(2===n.BYTES_PER_ELEMENT)return n;if(this._caps.uintIndices){if(n instanceof Uint32Array)return n;for(let k=0;k<n.length;k++)if(n[k]>=65535)return new Uint32Array(n);return new Uint16Array(n)}return new Uint16Array(n)}bindArrayBuffer(n){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(n,this._gl.ARRAY_BUFFER)}bindUniformBlock(n,k,T){const c=n.program,K=this._gl.getUniformBlockIndex(c,k);this._gl.uniformBlockBinding(c,K,T)}bindIndexBuffer(n){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(n,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(n,k){(this._vaoRecordInProgress||this._currentBoundBuffer[k]!==n)&&(this._gl.bindBuffer(k,n?n.underlyingResource:null),this._currentBoundBuffer[k]=n)}updateArrayBuffer(n){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,n)}_vertexAttribPointer(n,k,T,c,K,Q,G){const w=this._currentBufferPointers[k];if(!w)return;let E=!1;w.active?(w.buffer!==n&&(w.buffer=n,E=!0),w.size!==T&&(w.size=T,E=!0),w.type!==c&&(w.type=c,E=!0),w.normalized!==K&&(w.normalized=K,E=!0),w.stride!==Q&&(w.stride=Q,E=!0),w.offset!==G&&(w.offset=G,E=!0)):(E=!0,w.active=!0,w.index=k,w.size=T,w.type=c,w.normalized=K,w.stride=Q,w.offset=G,w.buffer=n),(E||this._vaoRecordInProgress)&&(this.bindArrayBuffer(n),c===this._gl.UNSIGNED_INT||c===this._gl.INT?this._gl.vertexAttribIPointer(k,T,c,Q,G):this._gl.vertexAttribPointer(k,T,c,K,Q,G))}_bindIndexBufferWithCache(n){null!=n&&this._cachedIndexBuffer!==n&&(this._cachedIndexBuffer=n,this.bindIndexBuffer(n),this._uintIndicesCurrentlySet=n.is32Bits)}_bindVertexBuffersAttributes(n,k,T){const c=k.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let K=0;K<c.length;K++){const Q=k.getAttributeLocation(K);if(Q>=0){const k=c[K];let G=null;if(T&&(G=T[k]),G||(G=n[k]),!G)continue;this._gl.enableVertexAttribArray(Q),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[Q]=!0);const w=G.getBuffer();w&&(this._vertexAttribPointer(w,Q,G.getSize(),G.type,G.normalized,G.byteStride,G.byteOffset),G.getIsInstanced()&&(this._gl.vertexAttribDivisor(Q,G.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(Q),this._currentInstanceBuffers.push(w))))}}}recordVertexArrayObject(n,k,T,c){const K=this._gl.createVertexArray();if(!K)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(K),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(n,T,c),this.bindIndexBuffer(k),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),K}bindVertexArrayObject(n,k){this._cachedVertexArrayObject!==n&&(this._cachedVertexArrayObject=n,this._gl.bindVertexArray(n),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=null!=k&&k.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(n,k,T,c,K){if(this._cachedVertexBuffers!==n||this._cachedEffectForVertexBuffers!==K){this._cachedVertexBuffers=n,this._cachedEffectForVertexBuffers=K;const k=K.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let Q=0;for(let G=0;G<k;G++)if(G<T.length){const k=K.getAttributeLocation(G);k>=0&&(this._gl.enableVertexAttribArray(k),this._vertexAttribArraysEnabled[k]=!0,this._vertexAttribPointer(n,k,T[G],this._gl.FLOAT,!1,c,Q)),Q+=4*T[G]}}this._bindIndexBufferWithCache(k)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(n,k,T,c){this._cachedVertexBuffers===n&&this._cachedEffectForVertexBuffers===T||(this._cachedVertexBuffers=n,this._cachedEffectForVertexBuffers=T,this._bindVertexBuffersAttributes(n,T,c)),this._bindIndexBufferWithCache(k)}unbindInstanceAttributes(){let n;for(let k=0,T=this._currentInstanceLocations.length;k<T;k++){const T=this._currentInstanceBuffers[k];n!=T&&T.references&&(n=T,this.bindArrayBuffer(T));const c=this._currentInstanceLocations[k];this._gl.vertexAttribDivisor(c,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(n){this._gl.deleteVertexArray(n)}_releaseBuffer(n){return n.references--,0===n.references&&(this._deleteBuffer(n),!0)}_deleteBuffer(n){this._gl.deleteBuffer(n.underlyingResource)}updateAndBindInstancesBuffer(n,k,T){if(this.bindArrayBuffer(n),k&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,k),void 0!==T[0].index)this.bindInstancesBuffer(n,T,!0);else for(let c=0;c<4;c++){const k=T[c];this._vertexAttribArraysEnabled[k]||(this._gl.enableVertexAttribArray(k),this._vertexAttribArraysEnabled[k]=!0),this._vertexAttribPointer(n,k,4,this._gl.FLOAT,!1,64,16*c),this._gl.vertexAttribDivisor(k,1),this._currentInstanceLocations.push(k),this._currentInstanceBuffers.push(n)}}bindInstancesBuffer(n,k){let T=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.bindArrayBuffer(n);let c=0;if(T)for(let K=0;K<k.length;K++){c+=4*k[K].attributeSize}for(let K=0;K<k.length;K++){const T=k[K];void 0===T.index&&(T.index=this._currentEffect.getAttributeLocationByName(T.attributeName)),T.index<0||(this._vertexAttribArraysEnabled[T.index]||(this._gl.enableVertexAttribArray(T.index),this._vertexAttribArraysEnabled[T.index]=!0),this._vertexAttribPointer(n,T.index,T.attributeSize,T.attributeType||this._gl.FLOAT,T.normalized||!1,c,T.offset),this._gl.vertexAttribDivisor(T.index,void 0===T.divisor?1:T.divisor),this._currentInstanceLocations.push(T.index),this._currentInstanceBuffers.push(n))}}disableInstanceAttributeByName(n){if(!this._currentEffect)return;const k=this._currentEffect.getAttributeLocationByName(n);this.disableInstanceAttribute(k)}disableInstanceAttribute(n){let k,T=!1;for(;-1!==(k=this._currentInstanceLocations.indexOf(n));)this._currentInstanceLocations.splice(k,1),this._currentInstanceBuffers.splice(k,1),T=!0,k=this._currentInstanceLocations.indexOf(n);T&&(this._gl.vertexAttribDivisor(n,0),this.disableAttributeByIndex(n))}disableAttributeByIndex(n){this._gl.disableVertexAttribArray(n),this._vertexAttribArraysEnabled[n]=!1,this._currentBufferPointers[n].active=!1}draw(n,k,T,c){this.drawElementsType(n?0:1,k,T,c)}drawPointClouds(n,k,T){this.drawArraysType(2,n,k,T)}drawUnIndexed(n,k,T,c){this.drawArraysType(n?0:1,k,T,c)}drawElementsType(n,k,T,c){this.applyStates(),this._reportDrawCall();const K=this._drawMode(n),Q=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,G=this._uintIndicesCurrentlySet?4:2;c?this._gl.drawElementsInstanced(K,T,Q,k*G,c):this._gl.drawElements(K,T,Q,k*G)}drawArraysType(n,k,T,c){this.applyStates(),this._reportDrawCall();const K=this._drawMode(n);c?this._gl.drawArraysInstanced(K,k,T,c):this._gl.drawArrays(K,k,T)}_drawMode(n){switch(n){case 0:default:return this._gl.TRIANGLES;case 2:case 3:return this._gl.POINTS;case 1:case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN}}_releaseEffect(n){this._compiledEffects[n._key]&&delete this._compiledEffects[n._key];const k=n.getPipelineContext();k&&this._deletePipelineContext(k)}_deletePipelineContext(n){const k=n;k&&k.program&&(k.program.__SPECTOR_rebuildProgram=null,(0,C.n)(k),this._gl&&(this._currentProgram===k.program&&this._setProgram(null),this._gl.deleteProgram(k.program)))}_getGlobalDefines(n){return(0,b.g)(n,this.isNDCHalfZRange,this.useReverseDepthBuffer,this.useExactSrgbConversions)}createEffect(n,k,T,K,Q,G,w,E,I){let S=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,P=arguments.length>10?arguments[10]:void 0;const W="string"===typeof n?n:n.vertexToken||n.vertexSource||n.vertexElement||n.vertex,J="string"===typeof n?n:n.fragmentToken||n.fragmentSource||n.fragmentElement||n.fragment,H=this._getGlobalDefines(),b=void 0!==k.attributes;let C=Q??k.defines??"";H&&(C+=H);const z=W+"+"+J+"@"+C;if(this._compiledEffects[z]){const n=this._compiledEffects[z];return w&&n.isReady()&&w(n),n._refCount++,n}this._gl&&(0,c.A)(this._gl);const r=new s.b(n,k,b?this:T,K,this,Q,G,w,E,I,z,k.shaderLanguage??S,k.extraInitializationsAsync??P);return this._compiledEffects[z]=r,r}_getShaderSource(n){return this._gl.getShaderSource(n)}createRawShaderProgram(n,k,T,K){let Q=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const G=(0,c.A)(this._gl);return G._contextWasLost=this._contextWasLost,G.validateShaderPrograms=this.validateShaderPrograms,(0,c.u)(n,k,T,K||this._gl,Q)}createShaderProgram(n,k,T,K,Q){let G=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;const w=(0,c.A)(this._gl);return w._contextWasLost=this._contextWasLost,w.validateShaderPrograms=this.validateShaderPrograms,(0,c.y)(n,k,T,K,Q||this._gl,G)}inlineShaderCode(n){return n}createPipelineContext(n){if(this._gl){(0,c.A)(this._gl).parallelShaderCompile=this._caps.parallelShaderCompile}const k=(0,c.s)(this._gl,n);return k.Hi=this,k}createMaterialContext(){}createDrawContext(){}_finalizePipelineContext(n){return(0,c.f)(n,this._gl,this.validateShaderPrograms)}_preparePipelineContextAsync(n,k,T,K,Q,G,w,E,I,S,P){const W=(0,c.A)(this._gl);return W._contextWasLost=this._contextWasLost,W.validateShaderPrograms=this.validateShaderPrograms,W._createShaderProgramInjection=this._createShaderProgram.bind(this),W.createRawShaderProgramInjection=this.createRawShaderProgram.bind(this),W.createShaderProgramInjection=this.createShaderProgram.bind(this),W.loadFileInjection=this._loadFile.bind(this),(0,c.m)(n,k,T,K,Q,G,w,E,I,S,P)}_createShaderProgram(n,k,T,K){let Q=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return(0,c.c)(n,k,T,K,Q)}_isRenderingStateCompiled(n){return!this._isDisposed&&(0,c.i)(n,this._gl,this.validateShaderPrograms)}_executeWhenRenderingStateIsCompiled(n,k){(0,c.d)(n,k)}getUniforms(n,k){const T=new Array,c=n;for(let K=0;K<k.length;K++)T.push(this._gl.getUniformLocation(c.program,k[K]));return T}getAttributes(n,k){const T=[],c=n;for(let Q=0;Q<k.length;Q++)try{T.push(this._gl.getAttribLocation(c.program,k[Q]))}catch(K){T.push(-1)}return T}enableEffect(n){(n=null!==n&&(0,K.b)(n)?n.effect:n)&&n!==this._currentEffect&&(this._stencilStateComposer.stencilMaterial=void 0,this.bindSamplers(n),this._currentEffect=n,n.onBind&&n.onBind(n),n._onBindObservable&&n._onBindObservable.notifyObservers(n))}setInt(n,k){return!!n&&(this._gl.uniform1i(n,k),!0)}setInt2(n,k,T){return!!n&&(this._gl.uniform2i(n,k,T),!0)}setInt3(n,k,T,c){return!!n&&(this._gl.uniform3i(n,k,T,c),!0)}setInt4(n,k,T,c,K){return!!n&&(this._gl.uniform4i(n,k,T,c,K),!0)}setIntArray(n,k){return!!n&&(this._gl.uniform1iv(n,k),!0)}setIntArray2(n,k){return!(!n||k.length%2!==0)&&(this._gl.uniform2iv(n,k),!0)}setIntArray3(n,k){return!(!n||k.length%3!==0)&&(this._gl.uniform3iv(n,k),!0)}setIntArray4(n,k){return!(!n||k.length%4!==0)&&(this._gl.uniform4iv(n,k),!0)}setUInt(n,k){return!!n&&(this._gl.uniform1ui(n,k),!0)}setUInt2(n,k,T){return!!n&&(this._gl.uniform2ui(n,k,T),!0)}setUInt3(n,k,T,c){return!!n&&(this._gl.uniform3ui(n,k,T,c),!0)}setUInt4(n,k,T,c,K){return!!n&&(this._gl.uniform4ui(n,k,T,c,K),!0)}setUIntArray(n,k){return!!n&&(this._gl.uniform1uiv(n,k),!0)}setUIntArray2(n,k){return!(!n||k.length%2!==0)&&(this._gl.uniform2uiv(n,k),!0)}setUIntArray3(n,k){return!(!n||k.length%3!==0)&&(this._gl.uniform3uiv(n,k),!0)}setUIntArray4(n,k){return!(!n||k.length%4!==0)&&(this._gl.uniform4uiv(n,k),!0)}setArray(n,k){return!!n&&(!(k.length<1)&&(this._gl.uniform1fv(n,k),!0))}setArray2(n,k){return!(!n||k.length%2!==0)&&(this._gl.uniform2fv(n,k),!0)}setArray3(n,k){return!(!n||k.length%3!==0)&&(this._gl.uniform3fv(n,k),!0)}setArray4(n,k){return!(!n||k.length%4!==0)&&(this._gl.uniform4fv(n,k),!0)}setMatrices(n,k){return!!n&&(this._gl.uniformMatrix4fv(n,!1,k),!0)}setMatrix3x3(n,k){return!!n&&(this._gl.uniformMatrix3fv(n,!1,k),!0)}setMatrix2x2(n,k){return!!n&&(this._gl.uniformMatrix2fv(n,!1,k),!0)}setFloat(n,k){return!!n&&(this._gl.uniform1f(n,k),!0)}setFloat2(n,k,T){return!!n&&(this._gl.uniform2f(n,k,T),!0)}setFloat3(n,k,T,c){return!!n&&(this._gl.uniform3f(n,k,T,c),!0)}setFloat4(n,k,T,c,K){return!!n&&(this._gl.uniform4f(n,k,T,c,K),!0)}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;const n=this._colorWrite;this._gl.colorMask(n,n,n,n)}}wipeCaches(n){this.preventCacheWipeBetweenFrames&&!n||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),n&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(n,k){const T=this._gl;let c=T.NEAREST,K=T.NEAREST,Q=!1;switch(n){case 11:c=T.LINEAR,K=k?T.LINEAR_MIPMAP_NEAREST:T.LINEAR;break;case 3:c=T.LINEAR,Q=!0,K=k?T.LINEAR_MIPMAP_LINEAR:T.LINEAR;break;case 8:Q=!0,c=T.NEAREST,K=k?T.NEAREST_MIPMAP_LINEAR:T.NEAREST;break;case 4:c=T.NEAREST,K=k?T.NEAREST_MIPMAP_NEAREST:T.NEAREST;break;case 5:c=T.NEAREST,K=k?T.LINEAR_MIPMAP_NEAREST:T.LINEAR;break;case 6:Q=!0,c=T.NEAREST,K=k?T.LINEAR_MIPMAP_LINEAR:T.LINEAR;break;case 7:c=T.NEAREST,K=T.LINEAR;break;case 1:c=T.NEAREST,K=T.NEAREST;break;case 9:c=T.LINEAR,K=k?T.NEAREST_MIPMAP_NEAREST:T.NEAREST;break;case 10:Q=!0,c=T.LINEAR,K=k?T.NEAREST_MIPMAP_LINEAR:T.NEAREST;break;case 2:c=T.LINEAR,K=T.LINEAR;break;case 12:c=T.LINEAR,K=T.NEAREST}return{min:K,mag:c,hasMipMaps:Q}}_createTexture(){const n=this._gl.createTexture();if(!n)throw new Error("Unable to create texture");return n}_createHardwareTexture(){return new J.c(this._createTexture(),this._gl)}_createInternalTexture(n,k){let T,c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,K=!1,G=!1,w=0,E=3,I=5,S=!1,P=1,W=!1,J=0;void 0!==k&&"object"===typeof k?(K=!!k.generateMipMaps,G=!!k.createMipMaps,w=void 0===k.type?0:k.type,E=void 0===k.samplingMode?3:k.samplingMode,I=void 0===k.format?5:k.format,S=void 0!==k.useSRGBBuffer&&k.useSRGBBuffer,P=k.samples??1,T=k.label,W=!!k.createMSAATexture,J=k.comparisonFunction||0):K=!!k,S&&(S=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(1!==w||this._caps.textureFloatLinearFiltering)&&(2!==w||this._caps.textureHalfFloatLinearFiltering)||(E=1),1!==w||this._caps.textureFloat||(w=0,Q.d.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const s=(0,z.h)(I),b=(0,z.e)(I),C=this._gl,r=new H.d(this,c),q=n.width||n,O=n.height||n,u=n.depth||0,f=n.layers||0,A=this._getSamplingParameters(E,(K||G)&&!s),v=0!==f?C.TEXTURE_2D_ARRAY:0!==u?C.TEXTURE_3D:C.TEXTURE_2D,F=s?this._getInternalFormatFromDepthTextureFormat(I,!0,b):this._getRGBABufferInternalSizedFormat(w,I,S),m=s?b?C.DEPTH_STENCIL:C.DEPTH_COMPONENT:this._getInternalFormat(I),x=s?this._getWebGLTextureTypeFromDepthTextureFormat(I):this._getWebGLTextureType(w);if(this._bindTextureDirectly(v,r),0!==f?(r.is2DArray=!0,C.texImage3D(v,0,F,q,O,f,0,m,x,null)):0!==u?(r.is3D=!0,C.texImage3D(v,0,F,q,O,u,0,m,x,null)):C.texImage2D(v,0,F,q,O,0,m,x,null),C.texParameteri(v,C.TEXTURE_MAG_FILTER,A.mag),C.texParameteri(v,C.TEXTURE_MIN_FILTER,A.min),C.texParameteri(v,C.TEXTURE_WRAP_S,C.CLAMP_TO_EDGE),C.texParameteri(v,C.TEXTURE_WRAP_T,C.CLAMP_TO_EDGE),s&&this.webGLVersion>1&&(0===J?(C.texParameteri(v,C.TEXTURE_COMPARE_FUNC,515),C.texParameteri(v,C.TEXTURE_COMPARE_MODE,C.NONE)):(C.texParameteri(v,C.TEXTURE_COMPARE_FUNC,J),C.texParameteri(v,C.TEXTURE_COMPARE_MODE,C.COMPARE_REF_TO_TEXTURE))),(K||G)&&this._gl.generateMipmap(v),this._bindTextureDirectly(v,null),r._useSRGBBuffer=S,r.baseWidth=q,r.baseHeight=O,r.width=q,r.height=O,r.depth=f||u,r.isReady=!0,r.samples=P,r.generateMipMaps=K,r.samplingMode=E,r.type=w,r.format=I,r.label=T,r.comparisonFunction=J,this._internalTexturesCache.push(r),W){let n=null;if(n=(0,z.h)(r.format)?this._setupFramebufferDepthAttachments((0,z.e)(r.format),19!==r.format,r.width,r.height,P,r.format,!0):this._createRenderBuffer(r.width,r.height,P,-1,this._getRGBABufferInternalSizedFormat(r.type,r.format,r._useSRGBBuffer),-1),!n)throw new Error("Unable to create render buffer");r._autoMSAAManagement=!0;let k=r._hardwareTexture;k||(k=r._hardwareTexture=this._createHardwareTexture()),k.addMSAARenderBuffer(n)}return r}_getUseSRGBBuffer(n,k){return n&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||k)}createTexture(n,k,T,c){var K=this;let Q=arguments.length>4&&void 0!==arguments[4]?arguments[4]:3,G=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,w=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,E=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,I=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,S=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,P=arguments.length>10&&void 0!==arguments[10]?arguments[10]:null,W=arguments.length>11?arguments[11]:void 0,J=arguments.length>12?arguments[12]:void 0,s=arguments.length>13?arguments[13]:void 0,b=arguments.length>14?arguments[14]:void 0;return this._createTextureBase(n,k,T,c,Q,G,w,(function(){for(var n=arguments.length,k=new Array(n),T=0;T<n;T++)k[T]=arguments[T];return K._prepareWebGLTexture(...k,S)}),((n,k,T,K,Q,G)=>{const w=this._gl,E=T.width===n&&T.height===k;Q._creationFlags=s??0;const I=this._getTexImageParametersForCreateTexture(Q.format,Q._useSRGBBuffer);if(E)return w.texImage2D(w.TEXTURE_2D,0,I.internalFormat,I.format,I.type,T),!1;const S=this._caps.maxTextureSize;if(T.width>S||T.height>S||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!(!this._workingCanvas||!this._workingContext)&&(this._workingCanvas.width=n,this._workingCanvas.height=k,this._workingContext.drawImage(T,0,0,T.width,T.height,0,0,n,k),w.texImage2D(w.TEXTURE_2D,0,I.internalFormat,I.format,I.type,this._workingCanvas),Q.width=n,Q.height=k,!1);{const n=new H.d(this,2);this._bindTextureDirectly(w.TEXTURE_2D,n,!0),w.texImage2D(w.TEXTURE_2D,0,I.internalFormat,I.format,I.type,T),this._rescaleTexture(n,Q,c,I.format,(()=>{this._releaseTexture(n),this._bindTextureDirectly(w.TEXTURE_2D,Q,!0),G()}))}return!0}),E,I,S,P,W,J,b)}_getTexImageParametersForCreateTexture(n,k){let T,c;return 1===this.webGLVersion?(T=this._getInternalFormat(n,k),c=T):(T=this._getInternalFormat(n,!1),c=this._getRGBABufferInternalSizedFormat(0,n,k)),{internalFormat:c,format:T,type:this._gl.UNSIGNED_BYTE}}_rescaleTexture(n,k,T,c,K){}_unpackFlipY(n){this._unpackFlipYCached!==n&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,n?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=n))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(n){return n.isCube?this._gl.TEXTURE_CUBE_MAP:n.is3D?this._gl.TEXTURE_3D:n.is2DArray||n.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(n,k){let T=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const c=this._getTextureTarget(k),K=this._getSamplingParameters(n,k.useMipMaps||T);this._setTextureParameterInteger(c,this._gl.TEXTURE_MAG_FILTER,K.mag,k),this._setTextureParameterInteger(c,this._gl.TEXTURE_MIN_FILTER,K.min),T&&K.hasMipMaps&&(k.generateMipMaps=!0,this._gl.generateMipmap(c)),this._bindTextureDirectly(c,null),k.samplingMode=n}updateTextureDimensions(n,k,T){}updateTextureWrappingMode(n,k){let T=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;const K=this._getTextureTarget(n);null!==k&&(this._setTextureParameterInteger(K,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(k),n),n._cachedWrapU=k),null!==T&&(this._setTextureParameterInteger(K,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(T),n),n._cachedWrapV=T),(n.is2DArray||n.is3D)&&null!==c&&(this._setTextureParameterInteger(K,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(c),n),n._cachedWrapR=c),this._bindTextureDirectly(K,null)}_uploadCompressedDataToTextureDirectly(n,k,T,c,K){let Q=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,G=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;const w=this._gl;let E=w.TEXTURE_2D;if(n.isCube&&(E=w.TEXTURE_CUBE_MAP_POSITIVE_X+Q),n._useSRGBBuffer)switch(k){case 37492:case 36196:this._caps.etc2?k=w.COMPRESSED_SRGB8_ETC2:n._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?k=w.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:n._useSRGBBuffer=!1;break;case 36492:k=w.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:k=w.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?k=w.COMPRESSED_SRGB_S3TC_DXT1_EXT:n._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?k=w.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:n._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?k=w.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:n._useSRGBBuffer=!1;break;default:n._useSRGBBuffer=!1}this._gl.compressedTexImage2D(E,G,k,T,c,0,K)}_uploadDataToTextureDirectly(n,k){let T=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,K=arguments.length>4?arguments[4]:void 0,Q=arguments.length>5&&void 0!==arguments[5]&&arguments[5];const G=this._gl,w=this._getWebGLTextureType(n.type),E=this._getInternalFormat(n.format),I=void 0===K?this._getRGBABufferInternalSizedFormat(n.type,n.format,n._useSRGBBuffer):this._getInternalFormat(K,n._useSRGBBuffer);this._unpackFlipY(n.invertY);let S=G.TEXTURE_2D;n.isCube&&(S=G.TEXTURE_CUBE_MAP_POSITIVE_X+T);const P=Math.round(Math.log(n.width)*Math.LOG2E),W=Math.round(Math.log(n.height)*Math.LOG2E),J=Q?n.width:Math.pow(2,Math.max(P-c,0)),H=Q?n.height:Math.pow(2,Math.max(W-c,0));G.texImage2D(S,c,I,J,H,0,E,w,k)}updateTextureData(n,k,T,c,K,Q){let G=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,w=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,E=arguments.length>8&&void 0!==arguments[8]&&arguments[8];const I=this._gl,S=this._getWebGLTextureType(n.type),P=this._getInternalFormat(n.format);this._unpackFlipY(n.invertY);let W=I.TEXTURE_2D,J=I.TEXTURE_2D;n.isCube&&(J=I.TEXTURE_CUBE_MAP_POSITIVE_X+G,W=I.TEXTURE_CUBE_MAP),this._bindTextureDirectly(W,n,!0),I.texSubImage2D(J,w,T,c,K,Q,P,S,k),E&&this._gl.generateMipmap(J),this._bindTextureDirectly(W,null)}_uploadArrayBufferViewToTexture(n,k){let T=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const K=this._gl,Q=n.isCube?K.TEXTURE_CUBE_MAP:K.TEXTURE_2D;this._bindTextureDirectly(Q,n,!0),this._uploadDataToTextureDirectly(n,k,T,c),this._bindTextureDirectly(Q,null,!0)}_prepareWebGLTextureContinuation(n,k,T,c,K){const Q=this._gl;if(!Q)return;const G=this._getSamplingParameters(K,!T);Q.texParameteri(Q.TEXTURE_2D,Q.TEXTURE_MAG_FILTER,G.mag),Q.texParameteri(Q.TEXTURE_2D,Q.TEXTURE_MIN_FILTER,G.min),T||c||Q.generateMipmap(Q.TEXTURE_2D),this._bindTextureDirectly(Q.TEXTURE_2D,null),k&&k.removePendingData(n),n.onLoadedObservable.notifyObservers(n),n.onLoadedObservable.clear()}_prepareWebGLTexture(n,k,T,c,K,Q,G,w,E,I){const S=this.getCaps().maxTextureSize,W=Math.min(S,this.needPOTTextures?(0,P.h)(c.width,S):c.width),J=Math.min(S,this.needPOTTextures?(0,P.h)(c.height,S):c.height),H=this._gl;H&&(n._hardwareTexture?(this._bindTextureDirectly(H.TEXTURE_2D,n,!0),this._unpackFlipY(void 0===K||!!K),n.baseWidth=c.width,n.baseHeight=c.height,n.width=W,n.height=J,n.isReady=!0,n.type=-1!==n.type?n.type:0,n.format=-1!==n.format?n.format:I??(".jpg"!==k||n._useSRGBBuffer?5:4),w(W,J,c,k,n,(()=>{this._prepareWebGLTextureContinuation(n,T,Q,G,E)}))||this._prepareWebGLTextureContinuation(n,T,Q,G,E)):T&&T.removePendingData(n))}_getInternalFormatFromDepthTextureFormat(n,k,T){const c=this._gl;if(!k)return c.STENCIL_INDEX8;let K=T?c.DEPTH_STENCIL:c.DEPTH_COMPONENT;return this.webGLVersion>1?15===n?K=c.DEPTH_COMPONENT16:16===n?K=c.DEPTH_COMPONENT24:17===n||13===n?K=T?c.DEPTH24_STENCIL8:c.DEPTH_COMPONENT24:14===n?K=c.DEPTH_COMPONENT32F:18===n&&(K=T?c.DEPTH32F_STENCIL8:c.DEPTH_COMPONENT32F):K=c.DEPTH_COMPONENT16,K}_getWebGLTextureTypeFromDepthTextureFormat(n){const k=this._gl;let T=k.UNSIGNED_INT;return 15===n?T=k.UNSIGNED_SHORT:17===n||13===n?T=k.UNSIGNED_INT_24_8:14===n?T=k.FLOAT:18===n?T=k.FLOAT_32_UNSIGNED_INT_24_8_REV:19===n&&(T=k.UNSIGNED_BYTE),T}_setupFramebufferDepthAttachments(n,k,T,c){let K=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,Q=arguments.length>5?arguments[5]:void 0,G=arguments.length>6&&void 0!==arguments[6]&&arguments[6];const w=this._gl;Q=Q??(n?13:14);const E=this._getInternalFormatFromDepthTextureFormat(Q,k,n);return n&&k?this._createRenderBuffer(T,c,K,w.DEPTH_STENCIL,E,G?-1:w.DEPTH_STENCIL_ATTACHMENT):k?this._createRenderBuffer(T,c,K,E,E,G?-1:w.DEPTH_ATTACHMENT):n?this._createRenderBuffer(T,c,K,E,E,G?-1:w.STENCIL_ATTACHMENT):null}_createRenderBuffer(n,k,T,c,K,Q){let G=!(arguments.length>6&&void 0!==arguments[6])||arguments[6];const w=this._gl.createRenderbuffer();return this._updateRenderBuffer(w,n,k,T,c,K,Q,G)}_updateRenderBuffer(n,k,T,c,K,Q,G){let w=!(arguments.length>7&&void 0!==arguments[7])||arguments[7];const E=this._gl;return E.bindRenderbuffer(E.RENDERBUFFER,n),c>1&&E.renderbufferStorageMultisample?E.renderbufferStorageMultisample(E.RENDERBUFFER,c,Q,k,T):E.renderbufferStorage(E.RENDERBUFFER,K,k,T),-1!==G&&E.framebufferRenderbuffer(E.FRAMEBUFFER,G,E.RENDERBUFFER,n),w&&E.bindRenderbuffer(E.RENDERBUFFER,null),n}_releaseTexture(n){this._deleteTexture(n._hardwareTexture),this.unbindAllTextures();const k=this._internalTexturesCache.indexOf(n);-1!==k&&this._internalTexturesCache.splice(k,1),n._lodTextureHigh&&n._lodTextureHigh.dispose(),n._lodTextureMid&&n._lodTextureMid.dispose(),n._lodTextureLow&&n._lodTextureLow.dispose(),n._irradianceTexture&&n._irradianceTexture.dispose()}_deleteTexture(n){null===n||void 0===n||n.release()}_setProgram(n){this._currentProgram!==n&&((0,c.q)(n,this._gl),this._currentProgram=n)}bindSamplers(n){const k=n.getPipelineContext();this._setProgram(k.program);const T=n.getSamplers();for(let c=0;c<T.length;c++){const k=n.getUniform(T[c]);k&&(this._boundUniforms[c]=k)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(n,k){let T=arguments.length>2&&void 0!==arguments[2]&&arguments[2],c=arguments.length>3&&void 0!==arguments[3]&&arguments[3],K=!1;const G=k&&k._associatedChannel>-1;T&&G&&(this._activeChannel=k._associatedChannel);if(this._boundTexturesCache[this._activeChannel]!==k||c){if(this._activateCurrentTexture(),k&&k.isMultiview)throw Q.d.Error(["_bindTextureDirectly called with a multiview texture!",n,k]),"_bindTextureDirectly called with a multiview texture!";var w;this._gl.bindTexture(n,(null===k||void 0===k||null===(w=k._hardwareTexture)||void 0===w?void 0:w.underlyingResource)??null),this._boundTexturesCache[this._activeChannel]=k,k&&(k._associatedChannel=this._activeChannel)}else T&&(K=!0,this._activateCurrentTexture());return G&&!T&&this._bindSamplerUniformToChannel(k._associatedChannel,this._activeChannel),K}_bindTexture(n,k,T){if(void 0===n)return;k&&(k._associatedChannel=n),this._activeChannel=n;const c=k?this._getTextureTarget(k):this._gl.TEXTURE_2D;this._bindTextureDirectly(c,k)}unbindAllTextures(){for(let n=0;n<this._maxSimultaneousTextures;n++)this._activeChannel=n,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(n,k,T,c){void 0!==n&&(k&&(this._boundUniforms[n]=k),this._setTexture(n,T))}_bindSamplerUniformToChannel(n,k){const T=this._boundUniforms[n];T&&T._currentState!==k&&(this._gl.uniform1i(T,k),T._currentState=k)}_getTextureWrapMode(n){switch(n){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(n,k){let T,c=arguments.length>2&&void 0!==arguments[2]&&arguments[2],K=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!k)return null!=this._boundTexturesCache[n]&&(this._activeChannel=n,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(k.video){this._activeChannel=n;const T=k.getInternalTexture();T&&(T._associatedChannel=n),k.update()}else if(4===k.delayLoadState)return k.delayLoad(),!1;T=K?k.depthStencilTexture:k.isReady()?k.getInternalTexture():k.isCube?this.emptyCubeTexture:k.is3D?this.emptyTexture3D:k.is2DArray?this.emptyTexture2DArray:this.emptyTexture,!c&&T&&(T._associatedChannel=n);let Q=!0;this._boundTexturesCache[n]===T&&(c||this._bindSamplerUniformToChannel(T._associatedChannel,n),Q=!1),this._activeChannel=n;const G=this._getTextureTarget(T);if(Q&&this._bindTextureDirectly(G,T,c),T&&!T.isMultiview){if(T.isCube&&T._cachedCoordinatesMode!==k.coordinatesMode){T._cachedCoordinatesMode=k.coordinatesMode;const n=3!==k.coordinatesMode&&5!==k.coordinatesMode?1:0;k.wrapU=n,k.wrapV=n}T._cachedWrapU!==k.wrapU&&(T._cachedWrapU=k.wrapU,this._setTextureParameterInteger(G,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(k.wrapU),T)),T._cachedWrapV!==k.wrapV&&(T._cachedWrapV=k.wrapV,this._setTextureParameterInteger(G,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(k.wrapV),T)),T.is3D&&T._cachedWrapR!==k.wrapR&&(T._cachedWrapR=k.wrapR,this._setTextureParameterInteger(G,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(k.wrapR),T)),this._setAnisotropicLevel(G,T,k.anisotropicFilteringLevel)}return!0}setTextureArray(n,k,T,c){if(void 0!==n&&k){this._textureUnits&&this._textureUnits.length===T.length||(this._textureUnits=new Int32Array(T.length));for(let k=0;k<T.length;k++){const c=T[k].getInternalTexture();c?(this._textureUnits[k]=n+k,c._associatedChannel=n+k):this._textureUnits[k]=-1}this._gl.uniform1iv(k,this._textureUnits);for(let n=0;n<T.length;n++)this._setTexture(this._textureUnits[n],T[n],!0)}}_setAnisotropicLevel(n,k,T){const c=this._caps.textureAnisotropicFilterExtension;11!==k.samplingMode&&3!==k.samplingMode&&2!==k.samplingMode&&(T=1),c&&k._cachedAnisotropicFilteringLevel!==T&&(this._setTextureParameterFloat(n,c.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(T,this._caps.maxAnisotropy),k),k._cachedAnisotropicFilteringLevel=T)}_setTextureParameterFloat(n,k,T,c){this._bindTextureDirectly(n,c,!0,!0),this._gl.texParameterf(n,k,T)}_setTextureParameterInteger(n,k,T,c){c&&this._bindTextureDirectly(n,c,!0,!0),this._gl.texParameteri(n,k,T)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let n=0;n<this._caps.maxVertexAttribs;n++)this.disableAttributeByIndex(n)}else for(let n=0,k=this._vertexAttribArraysEnabled.length;n<k;n++)n>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[n]||this.disableAttributeByIndex(n)}releaseEffects(){this._compiledEffects={},this.onReleaseEffectsObservable.notifyObservers(this)}dispose(){var n;((0,G.k)()&&this._renderingCanvas&&(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._onContextRestored&&this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),super.dispose(),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.unbindAllAttributes(),this._boundUniforms={},this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._currentProgram=null,this._creationOptions.loseContextOnDispose)&&(null===(n=this._gl.getExtension("WEBGL_lose_context"))||void 0===n||n.loseContext());(0,c.z)(this._gl)}attachContextLostEvent(n){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",n,!1)}attachContextRestoredEvent(n){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",n,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(n){const k=this._gl;for(;k.getError()!==k.NO_ERROR;);let T=!0;const c=k.createTexture();k.bindTexture(k.TEXTURE_2D,c),k.texImage2D(k.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(n),1,1,0,k.RGBA,this._getWebGLTextureType(n),null),k.texParameteri(k.TEXTURE_2D,k.TEXTURE_MIN_FILTER,k.NEAREST),k.texParameteri(k.TEXTURE_2D,k.TEXTURE_MAG_FILTER,k.NEAREST);const K=k.createFramebuffer();k.bindFramebuffer(k.FRAMEBUFFER,K),k.framebufferTexture2D(k.FRAMEBUFFER,k.COLOR_ATTACHMENT0,k.TEXTURE_2D,c,0);const Q=k.checkFramebufferStatus(k.FRAMEBUFFER);if(T=T&&Q===k.FRAMEBUFFER_COMPLETE,T=T&&k.getError()===k.NO_ERROR,T&&(k.clear(k.COLOR_BUFFER_BIT),T=T&&k.getError()===k.NO_ERROR),T){k.bindFramebuffer(k.FRAMEBUFFER,null);const n=k.RGBA,c=k.UNSIGNED_BYTE,K=new Uint8Array(4);k.readPixels(0,0,1,1,n,c,K),T=T&&k.getError()===k.NO_ERROR}for(k.deleteTexture(c),k.deleteFramebuffer(K),k.bindFramebuffer(k.FRAMEBUFFER,null);!T&&k.getError()!==k.NO_ERROR;);return T}_getWebGLTextureType(n){if(1===this._webGLVersion){switch(n){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(n){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(n){let k=arguments.length>1&&void 0!==arguments[1]&&arguments[1],T=k?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;switch(n){case 0:T=this._gl.ALPHA;break;case 1:T=this._gl.LUMINANCE;break;case 2:T=this._gl.LUMINANCE_ALPHA;break;case 6:case 33322:case 36760:T=this._gl.RED;break;case 7:case 33324:case 36761:T=this._gl.RG;break;case 4:case 32852:case 36762:T=k?this._glSRGBExtensionValues.SRGB:this._gl.RGB;break;case 5:case 32859:case 36763:T=k?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA}if(this._webGLVersion>1)switch(n){case 8:T=this._gl.RED_INTEGER;break;case 9:T=this._gl.RG_INTEGER;break;case 10:T=this._gl.RGB_INTEGER;break;case 11:T=this._gl.RGBA_INTEGER}return T}_getRGBABufferInternalSizedFormat(n,k){let T=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(1===this._webGLVersion){if(void 0!==k)switch(k){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return T?this._glSRGBExtensionValues.SRGB:this._gl.RGB}return this._gl.RGBA}switch(n){case 3:switch(k){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(k){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return T?this._glSRGBExtensionValues.SRGB8:this._gl.RGB8;case 5:return T?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(k){case 8:return this._gl.R16I;case 36760:return this._gl.R16_SNORM_EXT;case 36761:return this._gl.RG16_SNORM_EXT;case 36762:return this._gl.RGB16_SNORM_EXT;case 36763:return this._gl.RGBA16_SNORM_EXT;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;default:return this._gl.RGBA16I}case 5:switch(k){case 8:return this._gl.R16UI;case 33322:return this._gl.R16_EXT;case 33324:return this._gl.RG16_EXT;case 32852:return this._gl.RGB16_EXT;case 32859:return this._gl.RGBA16_EXT;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;default:return this._gl.RGBA16UI}case 6:switch(k){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;default:return this._gl.RGBA32I}case 7:switch(k){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;default:return this._gl.RGBA32UI}case 1:switch(k){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;default:return this._gl.RGBA32F}case 2:switch(k){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(k){case 5:default:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI}}return T?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8}readPixels(n,k,T,c){let K=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],G=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],w=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;const E=K?4:3,I=K?this._gl.RGBA:this._gl.RGB,S=T*c*E;if(w){if(w.length<S)return Q.d.Error(`Data buffer is too small to store the read pixels (${w.length} should be more than ${S})`),Promise.resolve(w)}else w=new Uint8Array(S);return G&&this.flushFramebuffer(),this._gl.readPixels(n,k,T,c,I,this._gl.UNSIGNED_BYTE,w),Promise.resolve(w)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(null!==this._HasMajorPerformanceCaveat)return!this._HasMajorPerformanceCaveat;if(null===this._IsSupported)try{const n=W.b._CreateCanvas(1,1),k=n.getContext("webgl")||n.getContext("experimental-webgl");this._IsSupported=null!=k&&!!window.WebGLRenderingContext}catch(n){this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(null===this._HasMajorPerformanceCaveat)try{const n=W.b._CreateCanvas(1,1),k=n.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||n.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!k}catch(n){this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}}q._TempClearColorUint32=new Uint32Array(4),q._TempClearColorInt32=new Int32Array(4),q.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/12\\d\\..+?Mobile",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}],q._ConcatenateShader=b.d,q._IsSupported=null,q._HasMajorPerformanceCaveat=null},2350:(n,k,T)=>{T.d(k,{e:()=>J});var c=T(539),K=T(730),Q=T(2334),G=T(2353),w=T(693),E=T(617),I=T(556),S=T(2362),P=T(744);class W{get renderList(){return this._renderList}set renderList(n){this._renderList!==n&&(this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),n&&(this._unObserveRenderList=(0,P.i)(n,this._renderListHasChanged)),this._renderList=n)}get disableImageProcessing(){return this._disableImageProcessing}set disableImageProcessing(n){n!==this._disableImageProcessing&&(this._disableImageProcessing=n,this._scene.markAllMaterialsAsDirty(64))}get name(){return this._name}set name(n){if(this._name===n)return;if(this._name=n,!this._scene)return;const k=this._scene.getEngine();for(let T=0;T<this._renderPassIds.length;++T){const n=this._renderPassIds[T];k._renderPassNames[n]=`${this._name}#${T}`}}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}setMaterialForRendering(n,k){let T;T=Array.isArray(n)?n:[n];for(let c=0;c<T.length;++c)for(let n=0;n<this.options.numPasses;++n){let K=T[c];T[c].isAnInstance&&(K=T[c].sourceMesh),K.setMaterialForRenderPass(this._renderPassIds[n],void 0!==k?Array.isArray(k)?k[n]:k:void 0)}}constructor(n,k,T){this._unObserveRenderList=null,this._renderListHasChanged=(n,k)=>{const T=this._renderList?this._renderList.length:0;if(0===k&&T>0||0===T)for(const c of this._scene.meshes)c._markSubMeshesAsLightDirty()},this.particleSystemList=null,this.getCustomRenderList=null,this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this._disableImageProcessing=!1,this.onBeforeRenderObservable=new c.b,this.onAfterRenderObservable=new c.b,this.onBeforeRenderingManagerRenderObservable=new c.b,this.onAfterRenderingManagerRenderObservable=new c.b,this.onFastPathRenderObservable=new c.b,this._currentRefreshId=-1,this._refreshRate=1,this._currentApplyByPostProcessSetting=!1,this._currentSceneCamera=null,this.name=n,this._scene=k,this.renderList=[],this._renderPassIds=[],this.options={numPasses:1,doNotChangeAspectRatio:!0,...T},this._createRenderPassId(),this.renderPassId=this._renderPassIds[0],this._renderingManager=new S.b(k),this._renderingManager._useSceneAutoClearSetup=!0}_releaseRenderPassId(){const n=this._scene.getEngine();for(let k=0;k<this.options.numPasses;++k)n.releaseRenderPassId(this._renderPassIds[k]);this._renderPassIds.length=0}_createRenderPassId(){this._releaseRenderPassId();const n=this._scene.getEngine();for(let k=0;k<this.options.numPasses;++k)this._renderPassIds[k]=n.createRenderPassId(`${this.name}#${k}`)}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(n){this._refreshRate=n,this.resetRefreshCounter()}shouldRender(){return-1===this._currentRefreshId||this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}isReadyForRendering(n,k){this.prepareRenderList(),this.initRender(n,k);const T=this._checkReadiness();return this.finishRender(),T}prepareRenderList(){const n=this._scene;if(this._waitingRenderList){if(!this.renderListPredicate){this.renderList=[];for(let k=0;k<this._waitingRenderList.length;k++){const T=this._waitingRenderList[k],c=n.getMeshById(T);c&&this.renderList.push(c)}}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const n=this._scene.meshes;for(let k=0;k<n.length;k++){const T=n[k];this.renderListPredicate(T)&&this.renderList.push(T)}}this._currentApplyByPostProcessSetting=this._scene.imageProcessingConfiguration.applyByPostProcess,this._disableImageProcessing&&(this._scene.imageProcessingConfiguration._applyByPostProcess=this._disableImageProcessing)}initRender(n,k){const T=this._scene.getEngine(),c=this.activeCamera??this._scene.activeCamera;this._currentSceneCamera=this._scene.activeCamera,c&&(c!==this._scene.activeCamera&&(this._scene.setTransformMatrix(c.getViewMatrix(),c.getProjectionMatrix(!0)),this._scene.activeCamera=c),T.setViewport(c.rigParent?c.rigParent.viewport:c.viewport,n,k)),this._defaultRenderListPrepared=!1}finishRender(){const n=this._scene;this._disableImageProcessing&&(n.imageProcessingConfiguration._applyByPostProcess=this._currentApplyByPostProcessSetting),n.activeCamera=this._currentSceneCamera,this._currentSceneCamera&&(this.activeCamera&&this.activeCamera!==n.activeCamera&&n.setTransformMatrix(this._currentSceneCamera.getViewMatrix(),this._currentSceneCamera.getProjectionMatrix(!0)),n.getEngine().setViewport(this._currentSceneCamera.viewport)),n.resetCachedMaterial()}render(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,k=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const T=this._scene,c=T.getEngine(),K=c.currentRenderPassId;c.currentRenderPassId=this._renderPassIds[n],this.onBeforeRenderObservable.notifyObservers(n);if(c.snapshotRendering&&1===c.snapshotRenderingMode)this.onFastPathRenderObservable.notifyObservers(n);else{let k=null;const c=this.renderList?this.renderList:T.getActiveMeshes().data,K=this.renderList?this.renderList.length:T.getActiveMeshes().length;this.getCustomRenderList&&(k=this.getCustomRenderList(n,c,K)),k?this._prepareRenderingManager(k,k.length,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(c,K,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),k=c),this.onBeforeRenderingManagerRenderObservable.notifyObservers(n),this._renderingManager.render(this.customRenderFunction,k,this.renderParticles,this.renderSprites),this.onAfterRenderingManagerRenderObservable.notifyObservers(n)}k||this.onAfterRenderObservable.notifyObservers(n),c.currentRenderPassId=K}_checkReadiness(){const n=this._scene,k=n.getEngine(),T=k.currentRenderPassId;let c=!0;n.getViewMatrix()||n.updateTransformMatrix();const K=this.options.numPasses;for(let G=0;G<K&&c;G++){let T=null;const Q=this.renderList?this.renderList:n.getActiveMeshes().data,w=this.renderList?this.renderList.length:n.getActiveMeshes().length;k.currentRenderPassId=this._renderPassIds[G],this.onBeforeRenderObservable.notifyObservers(G),this.getCustomRenderList&&(T=this.getCustomRenderList(G,Q,w)),T||(T=Q),this.options.doNotChangeAspectRatio||n.updateTransformMatrix(!0);for(let n=0;n<T.length&&c;++n){const k=T[n];if(k.isEnabled()&&!k.isBlocked&&k.isVisible&&k.si)if(this.customIsReadyFunction){if(!this.customIsReadyFunction(k,this.refreshRate,!0)){c=!1;continue}}else if(!k.isReady(!0)){c=!1;continue}}this.onAfterRenderObservable.notifyObservers(G),K>1&&(n.incrementRenderId(),n.resetCachedMaterial())}const Q=this.particleSystemList||n.oi;for(const G of Q)G.isReady()||(c=!1);return k.currentRenderPassId=T,c}_prepareRenderingManager(n,k,T){const c=this._scene,K=c.activeCamera,Q=this.cameraForLOD??K;this._renderingManager.reset();const G=c.getRenderId(),w=c.getFrameId();for(let I=0;I<k;I++){const k=n[I];if(k&&!k.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(k,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!k.isReady(0===this.refreshRate)){this.resetRefreshCounter();continue}let n,E=null;if(Q){const n=k._internalAbstractMeshDataInfo._currentLOD.get(Q);n&&n[1]===w?E=n[0]:(E=c.customLODSelector?c.customLODSelector(k,Q):k.getLOD(Q),n?(n[0]=E,n[1]=w):k._internalAbstractMeshDataInfo._currentLOD.set(Q,[E,w]))}else E=k;if(!E)continue;if(E!==k&&0!==E.billboardMode&&E.pi(),E._preActivateForIntermediateRendering(G),n=!(!T||!K)&&0===(k.layerMask&K.layerMask),k.isEnabled()&&k.isVisible&&k.si&&!n){if(E!==k&&E._activate(G,!0),k._activate(G,!0)&&k.si.length){k.isAnInstance?k._internalAbstractMeshDataInfo._actAsRegularMesh&&(E=k):E._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,E._internalAbstractMeshDataInfo._isActiveIntermediate=!0,c._prepareSkeleton(E);for(let n=0;n<E.si.length;n++){const k=E.si[n];this._renderingManager.dispatch(k,E)}}k._postActivate()}}}const E=this.particleSystemList||c.oi;for(let I=0;I<E.length;I++){const n=E[I],k=n.j;n.isStarted()&&k&&(!k.position||k.isEnabled())&&this._renderingManager.dispatchParticles(n)}}setRenderingOrder(n){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,T=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this._renderingManager.setRenderingOrder(n,k,T,c)}setRenderingAutoClearDepthStencil(n,k){let T=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],c=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];this._renderingManager.setRenderingAutoClearDepthStencil(n,k,T,c),this._renderingManager._useSceneAutoClearSetup=!1}clone(){const n=new W(this.name,this._scene,this.options);return this.renderList&&(n.renderList=this.renderList.slice(0)),n}dispose(){const n=this.renderList?this.renderList:this._scene.getActiveMeshes().data,k=this.renderList?this.renderList.length:this._scene.getActiveMeshes().length;for(let T=0;T<k;T++){const k=n[T];k&&void 0!==k.getMaterialForRenderPass(this.renderPassId)&&k.setMaterialForRenderPass(this.renderPassId,void 0)}this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderingManagerRenderObservable.clear(),this.onAfterRenderingManagerRenderObservable.clear(),this.onFastPathRenderObservable.clear(),this._releaseRenderPassId(),this.renderList=null}_rebuild(){this.refreshRate===W.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=W.REFRESHRATE_RENDER_ONCE)}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}}W.REFRESHRATE_RENDER_ONCE=0,W.REFRESHRATE_RENDER_ONEVERYFRAME=1,W.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,E.b.prototype.setDepthStencilTexture=function(n,k){this._engine.setDepthStencilTexture(this._samplers[n],this._uniforms[n],k,n)};class J extends Q.b{get renderListPredicate(){return this._objectRenderer.renderListPredicate}set renderListPredicate(n){this._objectRenderer.renderListPredicate=n}get renderList(){return this._objectRenderer.renderList}set renderList(n){this._objectRenderer.renderList=n}get particleSystemList(){return this._objectRenderer.particleSystemList}set particleSystemList(n){this._objectRenderer.particleSystemList=n}get getCustomRenderList(){return this._objectRenderer.getCustomRenderList}set getCustomRenderList(n){this._objectRenderer.getCustomRenderList=n}get renderParticles(){return this._objectRenderer.renderParticles}set renderParticles(n){this._objectRenderer.renderParticles=n}get renderSprites(){return this._objectRenderer.renderSprites}set renderSprites(n){this._objectRenderer.renderSprites=n}get forceLayerMaskCheck(){return this._objectRenderer.forceLayerMaskCheck}set forceLayerMaskCheck(n){this._objectRenderer.forceLayerMaskCheck=n}get activeCamera(){return this._objectRenderer.activeCamera}set activeCamera(n){this._objectRenderer.activeCamera=n}get cameraForLOD(){return this._objectRenderer.cameraForLOD}set cameraForLOD(n){this._objectRenderer.cameraForLOD=n}get disableImageProcessing(){return this._objectRenderer.disableImageProcessing}set disableImageProcessing(n){this._objectRenderer.disableImageProcessing=n}get customIsReadyFunction(){return this._objectRenderer.customIsReadyFunction}set customIsReadyFunction(n){this._objectRenderer.customIsReadyFunction=n}get customRenderFunction(){return this._objectRenderer.customRenderFunction}set customRenderFunction(n){this._objectRenderer.customRenderFunction=n}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(n){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(n)}get onBeforeRenderObservable(){return this._objectRenderer.onBeforeRenderObservable}set onBeforeRender(n){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(n)}get onAfterRenderObservable(){return this._objectRenderer.onAfterRenderObservable}set onAfterRender(n){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(n)}set onClear(n){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(n)}get _waitingRenderList(){return this._objectRenderer._waitingRenderList}set _waitingRenderList(n){this._objectRenderer._waitingRenderList=n}get renderPassId(){return this._objectRenderer.renderPassId}get renderPassIds(){return this._objectRenderer.renderPassIds}get currentRefreshId(){return this._objectRenderer.currentRefreshId}setMaterialForRendering(n,k){this._objectRenderer.setMaterialForRendering(n,k)}get isMulti(){var n;return(null===(n=this._renderTarget)||void 0===n?void 0:n.isMulti)??!1}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(n){if(this._boundingBoxSize&&this._boundingBoxSize.equals(n))return;this._boundingBoxSize=n;const k=this.va();k&&k.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){var n;return(null===(n=this._renderTarget)||void 0===n?void 0:n._depthStencilTexture)??null}constructor(n,k,T){let G,w,E=arguments.length>3&&void 0!==arguments[3]&&arguments[3],S=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],P=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,J=arguments.length>6&&void 0!==arguments[6]&&arguments[6],H=arguments.length>7&&void 0!==arguments[7]?arguments[7]:Q.b.TRILINEAR_SAMPLINGMODE,s=!(arguments.length>8&&void 0!==arguments[8])||arguments[8],b=arguments.length>9&&void 0!==arguments[9]&&arguments[9],C=arguments.length>10&&void 0!==arguments[10]&&arguments[10],z=arguments.length>11&&void 0!==arguments[11]?arguments[11]:5,r=arguments.length>12&&void 0!==arguments[12]&&arguments[12],q=arguments.length>13?arguments[13]:void 0,O=arguments.length>14?arguments[14]:void 0,u=arguments.length>15&&void 0!==arguments[15]&&arguments[15],f=arguments.length>16&&void 0!==arguments[16]&&arguments[16],A=!0;if("object"===typeof E){const n=E;E=!!n.generateMipMaps,S=n.doNotChangeAspectRatio??!0,P=n.type??0,J=!!n.isCube,H=n.samplingMode??Q.b.TRILINEAR_SAMPLINGMODE,s=n.generateDepthBuffer??!0,b=!!n.generateStencilBuffer,C=!!n.isMulti,z=n.format??5,r=!!n.delayAllocation,q=n.samples,O=n.creationFlags,u=!!n.noColorAttachment,f=!!n.useSRGBBuffer,G=n.colorAttachment,A=n.gammaSpace??A,w=n.existingObjectRenderer}if(super(null,T,!E,void 0,H,void 0,void 0,void 0,void 0,z),this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new c.b,this.onAfterUnbindObservable=new c.b,this.onClearObservable=new c.b,this.onResizeObservable=new c.b,this._cleared=!1,this.skipInitialClear=!1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this._dontDisposeObjectRenderer=!1,this.boundingBoxPosition=K.o.Zero(),this._disableEngineStages=!1,this._dumpToolsLoading=!1,!(T=this.va()))return;const v=this.va().getEngine();this._gammaSpace=A,this._coordinatesMode=Q.b.PROJECTION_MODE,this.name=n,this.isRenderTarget=!0,this._initialSizeParameter=k,this._dontDisposeObjectRenderer=!!w,this._processSizeParameter(k),this._objectRenderer=w??new W(n,T,{numPasses:J?6:this.getRenderLayers()||1,doNotChangeAspectRatio:S}),this._onBeforeRenderingManagerRenderObserver=this._objectRenderer.onBeforeRenderingManagerRenderObservable.add((()=>{if(!this._disableEngineStages)for(const n of this._scene._beforeRenderTargetClearStage)n.action(this,this._currentFaceIndex,this._currentLayer);if(this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(v):this.skipInitialClear||v.clear(this.clearColor||this._scene.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),!this._disableEngineStages)for(const n of this._scene._beforeRenderTargetDrawStage)n.action(this,this._currentFaceIndex,this._currentLayer)})),this._onAfterRenderingManagerRenderObserver=this._objectRenderer.onAfterRenderingManagerRenderObservable.add((()=>{var n;if(!this._disableEngineStages)for(const T of this._scene._afterRenderTargetDrawStage)T.action(this,this._currentFaceIndex,this._currentLayer);const k=(null===(n=this._texture)||void 0===n?void 0:n.generateMipMaps)??!1;if(this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex,this._postProcesses,this.ignoreCameraViewport):this._currentUseCameraPostProcess&&this._scene.postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex),!this._disableEngineStages)for(const T of this._scene._afterRenderTargetPostProcessStage)T.action(this,this._currentFaceIndex,this._currentLayer);this._texture&&(this._texture.generateMipMaps=k),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),this._currentDumpForDebug&&(this._dumpTools?this._dumpTools.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),v):I.d.Error("dumpTools module is still being loaded. To speed up the process import dump tools directly in your project"))})),this._onFastPathRenderObserver=this._objectRenderer.onFastPathRenderObservable.add((()=>{this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(v):this.skipInitialClear||v.clear(this.clearColor||this._scene.clearColor,!0,!0,!0)})),this._resizeObserver=v.onResizeObservable.add((()=>{})),this._generateMipMaps=!!E,this._doNotChangeAspectRatio=S,C||(this._renderTargetOptions={generateMipMaps:E,type:P,format:this._format??void 0,samplingMode:this.samplingMode,generateDepthBuffer:s,generateStencilBuffer:b,samples:q,creationFlags:O,noColorAttachment:u,useSRGBBuffer:f,colorAttachment:G,label:this.name},this.samplingMode===Q.b.NEAREST_SAMPLINGMODE&&(this.wrapU=Q.b.CLAMP_ADDRESSMODE,this.wrapV=Q.b.CLAMP_ADDRESSMODE),r||(J?(this._renderTarget=T.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=Q.b.INVCUBIC_MODE,this._textureMatrix=K.d.Identity()):this._renderTarget=T.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==q&&(this.samples=q)))}createDepthStencilTexture(){var n;let k=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,T=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],c=arguments.length>2&&void 0!==arguments[2]&&arguments[2],K=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,Q=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14,G=arguments.length>5?arguments[5]:void 0;null===(n=this._renderTarget)||void 0===n||n.createDepthStencilTexture(k,T,c,K,Q,G)}_processSizeParameter(n){if(n.ratio){this._sizeRatio=n.ratio;const k=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(k.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(k.getRenderHeight(),this._sizeRatio)}}else this._size=n}get samples(){var n;return(null===(n=this._renderTarget)||void 0===n?void 0:n.samples)??this._samples}set samples(n){this._renderTarget&&(this._samples=this._renderTarget.setSamples(n))}addPostProcess(n){if(!this._postProcessManager){const n=this.va();if(!n)return;this._postProcessManager=new G.e(n),this._postProcesses=new Array}this._postProcesses.push(n),this._postProcesses[0].vl=!1}clearPostProcesses(){let n=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._postProcesses){if(n)for(const n of this._postProcesses)n.dispose();this._postProcesses=[]}}removePostProcess(n){if(!this._postProcesses)return;const k=this._postProcesses.indexOf(n);-1!==k&&(this._postProcesses.splice(k,1),this._postProcesses.length>0&&(this._postProcesses[0].vl=!1))}resetRefreshCounter(){this._objectRenderer.resetRefreshCounter()}get refreshRate(){return this._objectRenderer.refreshRate}set refreshRate(n){this._objectRenderer.refreshRate=n}_shouldRender(){return this._objectRenderer.shouldRender()}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){const n=this._size.layers;if(n)return n;const k=this._size.depth;return k||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(n){const k=Math.max(1,this.getRenderSize()*n);this.resize(k)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(n){var k;const T=this.isCube;null===(k=this._renderTarget)||void 0===k||k.dispose(),this._renderTarget=null;const c=this.va();c&&(this._processSizeParameter(n),this._renderTarget=T?c.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):c.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==this._renderTargetOptions.samples&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(){let n=arguments.length>0&&void 0!==arguments[0]&&arguments[0],k=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._render(n,k)}isReadyForRendering(){this._dumpToolsLoading||(this._dumpToolsLoading=!0,T.e(11).then(T.bind(T,2539)).then((n=>this._dumpTools=n))),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight());const n=this._objectRenderer._checkReadiness();return this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender(),n}_render(){let n=arguments.length>0&&void 0!==arguments[0]&&arguments[0],k=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const T=this.va();if(T){if(void 0!==this.useCameraPostProcesses&&(n=this.useCameraPostProcesses),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight()),!this.is2DArray&&!this.is3D||this.isMulti)if(this.isCube&&!this.isMulti)for(let c=0;c<6;c++)this._renderToTarget(c,n,k),T.incrementRenderId(),T.resetCachedMaterial();else this._renderToTarget(0,n,k);else for(let c=0;c<this.getRenderLayers();c++)this._renderToTarget(0,n,k,c),T.incrementRenderId(),T.resetCachedMaterial();this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender()}}_bestReflectionRenderTargetDimension(n,k){const T=n*k,c=(0,w.n)(T+16384/(128+T));return Math.min((0,w.d)(n),c)}_bindFrameBuffer(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const T=this.va();if(!T)return;const c=T.getEngine();this._renderTarget&&c.bindFramebuffer(this._renderTarget,this.isCube?n:void 0,void 0,void 0,this.ignoreCameraViewport,0,k)}_unbindFrameBuffer(n,k){this._renderTarget&&n.unBindFramebuffer(this._renderTarget,this.isCube,(()=>{this.onAfterRenderObservable.notifyObservers(k)}))}_prepareFrame(n,k,T,c){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses)||this._bindFrameBuffer(k,T):c&&n.postProcessManager._prepareFrame(this._texture)||this._bindFrameBuffer(k,T)}_renderToTarget(n,k,T){var c,K;let Q=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const G=this.va();if(!G)return;const w=G.getEngine();this._currentFaceIndex=n,this._currentLayer=Q,this._currentUseCameraPostProcess=k,this._currentDumpForDebug=T,this._prepareFrame(G,n,Q,k),null===(c=w._debugPushGroup)||void 0===c||c.call(w,`render to face #${n} layer #${Q}`,2),this._objectRenderer.render(n+Q,!0),null===(K=w._debugPopGroup)||void 0===K||K.call(w,2),this._unbindFrameBuffer(w,n),this._texture&&this.isCube&&5===n&&w.generateMipMapsForCubemap(this._texture,!0)}setRenderingOrder(n){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,T=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this._objectRenderer.setRenderingOrder(n,k,T,c)}setRenderingAutoClearDepthStencil(n,k){this._objectRenderer.setRenderingAutoClearDepthStencil(n,k)}clone(){const n=this.getSize(),k=new J(this.name,n,this.va(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return k.Bj=this.Bj,k.level=this.level,k.coordinatesMode=this.coordinatesMode,this.renderList&&(k.renderList=this.renderList.slice(0)),k}serialize(){if(!this.name)return null;const n=super.serialize();if(n.renderTargetSize=this.getRenderSize(),n.renderList=[],this.renderList)for(let k=0;k<this.renderList.length;k++)n.renderList.push(this.renderList[k].id);return n}disposeFramebufferObjects(){var n;null===(n=this._renderTarget)||void 0===n||n.dispose(!0)}releaseInternalTexture(){var n;null===(n=this._renderTarget)||void 0===n||n.releaseTextures(),this._texture=null}dispose(){var n;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._objectRenderer.onBeforeRenderingManagerRenderObservable.remove(this._onBeforeRenderingManagerRenderObserver),this._objectRenderer.onAfterRenderingManagerRenderObservable.remove(this._onAfterRenderingManagerRenderObserver),this._objectRenderer.onFastPathRenderObservable.remove(this._onFastPathRenderObserver),this._dontDisposeObjectRenderer||this._objectRenderer.dispose(),this.clearPostProcesses(!0),this._resizeObserver&&(this.va().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null);const k=this.va();if(!k)return;let T=k.customRenderTargets.indexOf(this);T>=0&&k.customRenderTargets.splice(T,1);for(const c of k.cameras)T=c.customRenderTargets.indexOf(this),T>=0&&c.customRenderTargets.splice(T,1);null===(n=this._renderTarget)||void 0===n||n.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this._objectRenderer._rebuild(),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._objectRenderer.freeRenderingGroups()}getViewCount(){return 1}}J.REFRESHRATE_RENDER_ONCE=W.REFRESHRATE_RENDER_ONCE,J.REFRESHRATE_RENDER_ONEVERYFRAME=W.REFRESHRATE_RENDER_ONEVERYFRAME,J.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=W.REFRESHRATE_RENDER_ONEVERYTWOFRAMES,Q.b._CreateRenderTargetTexture=(n,k,T,c,K)=>new J(n,k,T,c)},2411:(n,k,T)=>{function c(n){return 13===n||14===n||15===n||16===n||17===n||18===n||19===n}function K(n){return 13===n||17===n||18===n||19===n}T.d(k,{e:()=>K,h:()=>c})},2394:(n,k,T)=>{function c(n){return void 0===n.getPipelineContext}T.d(k,{b:()=>c})},2374:(n,k,T)=>{T.d(k,{b:()=>I,e:()=>S});var c=T(781),K=T(767),Q=T(539),G=T(617),w=T(848);T(2383);const E={xa:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class I{constructor(n){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:E;this._fullscreenViewport=new K.b(0,0,1,1);const T=k.xa??E.xa,Q=k.indices??E.indices;this.Hi=n,this._vertexBuffers={[c.f.PositionKind]:new c.f(n,T,c.f.PositionKind,!1,!1,2)},this._indexBuffer=n.createIndexBuffer(Q),this._indexBufferLength=Q.length,this._onContextRestoredObserver=n.onContextRestoredObservable.add((()=>{this._indexBuffer=n.createIndexBuffer(Q);for(const n in this._vertexBuffers){this._vertexBuffers[n]._rebuild()}}))}setViewport(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._fullscreenViewport;this.Hi.setViewport(n)}bindBuffers(n){this.Hi.bindBuffers(this._vertexBuffers,this._indexBuffer,n)}applyEffectWrapper(n){this.Hi.setState(!0),this.Hi.depthCullingState.depthTest=!1,this.Hi.stencilState.stencilTest=!1,this.Hi.enableEffect(n.drawWrapper),this.bindBuffers(n.effect),n.onApplyObservable.notifyObservers({})}saveStates(){this._savedStateDepthTest=this.Hi.depthCullingState.depthTest,this._savedStateStencilTest=this.Hi.stencilState.stencilTest}restoreStates(){this.Hi.depthCullingState.depthTest=this._savedStateDepthTest,this.Hi.stencilState.stencilTest=this._savedStateStencilTest}draw(){this.Hi.drawElementsType(0,0,this._indexBufferLength)}_isRenderTargetTexture(n){return void 0!==n.renderTarget}render(n){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!n.effect.isReady())return;this.saveStates(),this.setViewport();const T=null===k?null:this._isRenderTargetTexture(k)?k.renderTarget:k;T&&this.Hi.bindFramebuffer(T),this.applyEffectWrapper(n),this.draw(),T&&this.Hi.unBindFramebuffer(T),this.restoreStates()}dispose(){const n=this._vertexBuffers[c.f.PositionKind];n&&(n.dispose(),delete this._vertexBuffers[c.f.PositionKind]),this._indexBuffer&&this.Hi._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.Hi.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}}class S{static RegisterShaderCodeProcessing(n,k){k?S._CustomShaderCodeProcessing[n??""]=k:delete S._CustomShaderCodeProcessing[n??""]}static _GetShaderCodeProcessing(n){return S._CustomShaderCodeProcessing[n]??S._CustomShaderCodeProcessing[""]}get name(){return this.options.name}set name(n){this.options.name=n}isReady(){var n;return(null===(n=this._drawWrapper.effect)||void 0===n?void 0:n.isReady())??!1}get drawWrapper(){return this._drawWrapper}get effect(){return this._drawWrapper.effect}set effect(n){this._drawWrapper.effect=n}constructor(n){this.alphaMode=0,this.onEffectCreatedObservable=new Q.b(void 0,!0),this.onApplyObservable=new Q.b,this._shadersLoaded=!1,this._webGPUReady=!1,this._importPromises=[],this.options={...n,name:n.name||"effectWrapper",Hi:n.Hi,uniforms:n.uniforms||n.uniformNames||[],uniformNames:void 0,samplers:n.samplers||n.samplerNames||[],samplerNames:void 0,attributeNames:n.attributeNames||["position"],uniformBuffers:n.uniformBuffers||[],defines:n.defines||"",useShaderStore:n.useShaderStore||!1,vertexUrl:n.vertexUrl||n.vertexShader||"postprocess",vertexShader:void 0,fragmentShader:n.fragmentShader||"pass",indexParameters:n.indexParameters,blockCompilation:n.blockCompilation||!1,shaderLanguage:n.shaderLanguage||0,onCompiled:n.onCompiled||void 0,extraInitializations:n.extraInitializations||void 0,extraInitializationsAsync:n.extraInitializationsAsync||void 0,useAsPostProcess:n.useAsPostProcess??!1},this.options.uniformNames=this.options.uniforms,this.options.samplerNames=this.options.samplers,this.options.vertexShader=this.options.vertexUrl,this.options.useAsPostProcess&&(-1===this.options.samplers.indexOf("textureSampler")&&this.options.samplers.push("textureSampler"),-1===this.options.uniforms.indexOf("scale")&&this.options.uniforms.push("scale")),n.vertexUrl||n.vertexShader?this._shaderPath={vertexSource:this.options.vertexShader}:(this.options.useAsPostProcess||(this.options.uniforms.push("scale"),this.onApplyObservable.add((()=>{this.effect.setFloat2("scale",1,1)}))),this._shaderPath={vertex:this.options.vertexShader}),this._shaderPath.fragmentSource=this.options.fragmentShader,this._shaderPath.spectorName=this.options.name,this.options.useShaderStore&&(this._shaderPath.fragment=this._shaderPath.fragmentSource,this._shaderPath.vertex||(this._shaderPath.vertex=this._shaderPath.vertexSource),delete this._shaderPath.fragmentSource,delete this._shaderPath.vertexSource),this.onApplyObservable.add((()=>{this.bind()})),this.options.useShaderStore||(this._onContextRestoredObserver=this.options.Hi.onContextRestoredObservable.add((()=>{this.effect._pipelineContext=null,this.effect._prepareEffect()}))),this._drawWrapper=new w.b(this.options.Hi),this._webGPUReady=1===this.options.shaderLanguage;const k=Array.isArray(this.options.defines)?this.options.defines.join("\n"):this.options.defines;this._postConstructor(this.options.blockCompilation,k,this.options.extraInitializations)}_gatherImports(){let n=arguments.length>0&&void 0!==arguments[0]&&arguments[0],k=arguments.length>1?arguments[1]:void 0;this.options.useAsPostProcess&&(n&&this._webGPUReady?k.push(Promise.all([T.e(33).then(T.bind(T,13367))])):k.push(Promise.all([Promise.resolve().then(T.bind(T,2383))])))}_postConstructor(n){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,T=arguments.length>2?arguments[2]:void 0,c=arguments.length>3?arguments[3]:void 0;this._importPromises.length=0,c&&this._importPromises.push(...c);const K=this.options.Hi.isWebGPU&&!S.ForceGLSL;this._gatherImports(K,this._importPromises),void 0!==T&&T(K,this._importPromises),K&&this._webGPUReady&&(this.options.shaderLanguage=1),n||this.updateEffect(k)}updateEffect(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,T=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,c=arguments.length>3?arguments[3]:void 0,K=arguments.length>4?arguments[4]:void 0,Q=arguments.length>5?arguments[5]:void 0,w=arguments.length>6?arguments[6]:void 0,E=arguments.length>7?arguments[7]:void 0;const I=S._GetShaderCodeProcessing(this.name);if(null!==I&&void 0!==I&&I.defineCustomBindings){var P,W;const c=(null===(P=k)||void 0===P?void 0:P.slice())??[];c.push(...this.options.uniforms);const K=(null===(W=T)||void 0===W?void 0:W.slice())??[];K.push(...this.options.samplers),n=I.defineCustomBindings(this.name,n,c,K),k=c,T=K}this.options.defines=n||"";const J=this._shadersLoaded||0===this._importPromises.length?void 0:async()=>{await Promise.all(this._importPromises),this._shadersLoaded=!0};let H;H=this.options.extraInitializationsAsync?async()=>{null===J||void 0===J||J(),await this.options.extraInitializationsAsync()}:J,this.options.useShaderStore?this._drawWrapper.effect=this.options.Hi.createEffect({vertex:w??this._shaderPath.vertex,fragment:E??this._shaderPath.fragment},{attributes:this.options.attributeNames,uniformsNames:k||this.options.uniforms,uniformBuffersNames:this.options.uniformBuffers,samplers:T||this.options.samplers,defines:null!==n?n:"",fallbacks:null,onCompiled:K??this.options.onCompiled,onError:Q??null,indexParameters:c||this.options.indexParameters,processCodeAfterIncludes:null!==I&&void 0!==I&&I.processCodeAfterIncludes?(n,k)=>I.processCodeAfterIncludes(this.name,n,k):null,processFinalCode:null!==I&&void 0!==I&&I.processFinalCode?(n,k)=>I.processFinalCode(this.name,n,k):null,shaderLanguage:this.options.shaderLanguage,extraInitializationsAsync:H},this.options.Hi):this._drawWrapper.effect=new G.b(this._shaderPath,this.options.attributeNames,k||this.options.uniforms,T||this.options.samplerNames,this.options.Hi,n,void 0,K||this.options.onCompiled,void 0,void 0,void 0,this.options.shaderLanguage,H),this.onEffectCreatedObservable.notifyObservers(this._drawWrapper.effect)}bind(){var n,k;let T=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.options.useAsPostProcess&&!T&&(this.options.Hi.setAlphaMode(this.alphaMode),this.drawWrapper.effect.setFloat2("scale",1,1)),null===(n=S._GetShaderCodeProcessing(this.name))||void 0===n||null===(k=n.bindCustomBindings)||void 0===k||k.call(n,this.name,this._drawWrapper.effect)}dispose(){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.onEffectCreatedObservable.clear(),this._drawWrapper.dispose(!0)}}S.ForceGLSL=!1,S._CustomShaderCodeProcessing={}},2302:(n,k,T)=>{T.d(k,{e:()=>c.d,g:()=>c.h,h:()=>c.l,j:()=>c.o});T(909),T(764),T(736),T(773),T(2308),T(775),T(2313);var c=T(730);T(767)},2308:(n,k,T)=>{T.d(k,{c:()=>w,d:()=>S,f:()=>P});var c,K=T(747),Q=T(730),G=T(736);!function(n){n[n.CW=0]="CW",n[n.CCW=1]="CCW"}(c||(c={}));class w{static Interpolate(n,k,T,c,K){if(0===n)return 0;const Q=1-3*c+3*k,G=3*c-6*k,w=3*k;let E=n;for(let I=0;I<5;I++){const k=E*E;E-=(Q*(k*E)+G*k+w*E-n)*(1/(3*Q*k+2*G*E+w)),E=Math.min(1,Math.max(0,E))}return 3*Math.pow(1-E,2)*E*T+3*(1-E)*Math.pow(E,2)*K+Math.pow(E,3)}}class E{constructor(n){this._radians=n,this._radians<0&&(this._radians+=2*Math.PI)}degrees(){return 180*this._radians/Math.PI}radians(){return this._radians}static BetweenTwoPoints(n,k){const T=k.Fg(n),c=Math.atan2(T.y,T.x);return new E(c)}static BetweenTwoVectors(n,k){let T=n.lengthSquared()*k.lengthSquared();if(0===T)return new E(Math.PI/2);T=Math.sqrt(T);let c=n.dot(k)/T;c=(0,K.b)(c,-1,1);const Q=Math.acos(c);return new E(Q)}static FromRadians(n){return new E(n)}static FromDegrees(n){return new E(n*Math.PI/180)}}class I{constructor(n,k,T){this.startPoint=n,this.midPoint=k,this.endPoint=T;const c=Math.pow(k.x,2)+Math.pow(k.y,2),K=(Math.pow(n.x,2)+Math.pow(n.y,2)-c)/2,G=(c-Math.pow(T.x,2)-Math.pow(T.y,2))/2,w=(n.x-k.x)*(k.y-T.y)-(k.x-T.x)*(n.y-k.y);this.centerPoint=new Q.m((K*(k.y-T.y)-G*(n.y-k.y))/w,((n.x-k.x)*G-(k.x-T.x)*K)/w),this.radius=this.centerPoint.Fg(this.startPoint).length(),this.startAngle=E.BetweenTwoPoints(this.centerPoint,this.startPoint);const I=this.startAngle.degrees();let S=E.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),P=E.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();S-I>180&&(S-=360),S-I<-180&&(S+=360),P-S>180&&(P-=360),P-S<-180&&(P+=360),this.orientation=S-I<0?0:1,this.angle=E.FromDegrees(0===this.orientation?I-P:P-I)}}class S{constructor(n,k){this._points=new Array,this._length=0,this.closed=!1,this._points.push(new Q.m(n,k))}addLineTo(n,k){if(this.closed)return this;const T=new Q.m(n,k),c=this._points[this._points.length-1];return this._points.push(T),this._length+=T.Fg(c).length(),this}addArcTo(n,k,T,c){let K=arguments.length>4&&void 0!==arguments[4]?arguments[4]:36;if(this.closed)return this;const G=this._points[this._points.length-1],w=new Q.m(n,k),E=new Q.m(T,c),S=new I(G,w,E);let P=S.angle.radians()/K;0===S.orientation&&(P*=-1);let W=S.startAngle.radians()+P;for(let Q=0;Q<K;Q++){const n=Math.cos(W)*S.radius+S.centerPoint.x,k=Math.sin(W)*S.radius+S.centerPoint.y;this.addLineTo(n,k),W+=P}return this}addQuadraticCurveTo(n,k,T,c){let K=arguments.length>4&&void 0!==arguments[4]?arguments[4]:36;if(this.closed)return this;const Q=(n,k,T,c)=>(1-n)*(1-n)*k+2*n*(1-n)*T+n*n*c,G=this._points[this._points.length-1];for(let w=0;w<=K;w++){const E=w/K,I=Q(E,G.x,n,T),S=Q(E,G.y,k,c);this.addLineTo(I,S)}return this}addBezierCurveTo(n,k,T,c,K,Q){let G=arguments.length>6&&void 0!==arguments[6]?arguments[6]:36;if(this.closed)return this;const w=(n,k,T,c,K)=>(1-n)*(1-n)*(1-n)*k+3*n*(1-n)*(1-n)*T+3*n*n*(1-n)*c+n*n*n*K,E=this._points[this._points.length-1];for(let I=0;I<=G;I++){const S=I/G,P=w(S,E.x,n,T,K),W=w(S,E.y,k,c,Q);this.addLineTo(P,W)}return this}isPointInside(n){let k=!1;const T=this._points.length;for(let c=T-1,K=0;K<T;c=K++){let T=this._points[c],Q=this._points[K],G=Q.x-T.x,w=Q.y-T.y;if(Math.abs(w)>Number.EPSILON){if(w<0&&(T=this._points[K],G=-G,Q=this._points[c],w=-w),n.y<T.y||n.y>Q.y)continue;if(n.y===T.y&&n.x===T.x)return!0;{const c=w*(n.x-T.x)-G*(n.y-T.y);if(0===c)return!0;if(c<0)continue;k=!k}}else{if(n.y!==T.y)continue;if(Q.x<=n.x&&n.x<=T.x||T.x<=n.x&&n.x<=Q.x)return!0}}return k}close(){return this.closed=!0,this}length(){let n=this._length;if(this.closed){const k=this._points[this._points.length-1];n+=this._points[0].Fg(k).length()}return n}area(){const n=this._points.length;let k=0;for(let T=n-1,c=0;c<n;T=c++)k+=this._points[T].x*this._points[c].y-this._points[c].x*this._points[T].y;return.5*k}getPoints(){return this._points}getPointAtLengthPosition(n){if(n<0||n>1)return Q.m.Zero();const k=n*this.length();let T=0;for(let c=0;c<this._points.length;c++){const n=(c+1)%this._points.length,K=this._points[c],G=this._points[n].Fg(K),w=G.length()+T;if(k>=T&&k<=w){const n=G.normalize(),c=k-T;return new Q.m(K.x+n.x*c,K.y+n.y*c)}T=w}return Q.m.Zero()}static StartingAt(n,k){return new S(n,k)}}class P{constructor(n){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,T=arguments.length>2?arguments[2]:void 0,c=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.path=n,this._curve=new Array,this._distances=new Array,this._tangents=new Array,this._normals=new Array,this._binormals=new Array,this._pointAtData={id:0,point:Q.o.Zero(),previousPointArrayIndex:0,position:0,subPosition:0,interpolateReady:!1,interpolationMatrix:Q.d.Identity()};for(let K=0;K<n.length;K++)this._curve[K]=n[K].clone();this._raw=T||!1,this._alignTangentsWithPath=c,this._compute(k,c)}getCurve(){return this._curve}getPoints(){return this._curve}length(){return this._distances[this._distances.length-1]}getTangents(){return this._tangents}getNormals(){return this._normals}getBinormals(){return this._binormals}getDistances(){return this._distances}getPointAt(n){return this._updatePointAtData(n).point}getTangentAt(n){let k=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(n,k),k?Q.o.TransformCoordinates(Q.o.Forward(),this._pointAtData.interpolationMatrix):this._tangents[this._pointAtData.previousPointArrayIndex]}getNormalAt(n){let k=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(n,k),k?Q.o.TransformCoordinates(Q.o.Right(),this._pointAtData.interpolationMatrix):this._normals[this._pointAtData.previousPointArrayIndex]}getBinormalAt(n){let k=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(n,k),k?Q.o.TransformCoordinates(Q.o.UpReadOnly,this._pointAtData.interpolationMatrix):this._binormals[this._pointAtData.previousPointArrayIndex]}getDistanceAt(n){return this.length()*n}getPreviousPointIndexAt(n){return this._updatePointAtData(n),this._pointAtData.previousPointArrayIndex}getSubPositionAt(n){return this._updatePointAtData(n),this._pointAtData.subPosition}getClosestPositionTo(n){let k=Number.MAX_VALUE,T=0;for(let c=0;c<this._curve.length-1;c++){const K=this._curve[c+0],G=this._curve[c+1].Fg(K).normalize(),w=this._distances[c+1]-this._distances[c+0],E=Math.min(Math.max(Q.o.Dot(G,n.Fg(K).normalize()),0)*Q.o.Distance(K,n)/w,1),I=Q.o.Distance(K.add(G.scale(E*w)),n);I<k&&(k=I,T=(this._distances[c+0]+w*E)/this.length())}return T}slice(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(n<0&&(n=1- -1*n%1),k<0&&(k=1- -1*k%1),n>k){const T=n;n=k,k=T}const T=this.getCurve(),c=this.getPointAt(n);let K=this.getPreviousPointIndexAt(n);const Q=this.getPointAt(k),G=this.getPreviousPointIndexAt(k)+1,w=[];return 0!==n&&(K++,w.push(c)),w.push(...T.slice(K,G)),1===k&&1!==n||w.push(Q),new P(w,this.getNormalAt(n),this._raw,this._alignTangentsWithPath)}update(n){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,T=arguments.length>2&&void 0!==arguments[2]&&arguments[2];for(let c=0;c<n.length;c++)this._curve[c].x=n[c].x,this._curve[c].y=n[c].y,this._curve[c].z=n[c].z;return this._compute(k,T),this}_compute(n){let k=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const T=this._curve.length;if(T<2)return;this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[T-1]=this._curve[T-1].Fg(this._curve[T-2]),this._raw||this._tangents[T-1].normalize();const c=this._tangents[0],K=this._normalVector(c,n);let G,w,E,I,S;this._normals[0]=K,this._raw||this._normals[0].normalize(),this._binormals[0]=Q.o.Cross(c,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;for(let P=1;P<T;P++)G=this._getLastNonNullVector(P),P<T-1&&(w=this._getFirstNonNullVector(P),this._tangents[P]=k?w:G.add(w),this._tangents[P].normalize()),this._distances[P]=this._distances[P-1]+this._curve[P].Fg(this._curve[P-1]).length(),E=this._tangents[P],S=this._binormals[P-1],this._normals[P]=Q.o.Cross(S,E),this._raw||(0===this._normals[P].length()?(I=this._normals[P-1],this._normals[P]=I.clone()):this._normals[P].normalize()),this._binormals[P]=Q.o.Cross(E,this._normals[P]),this._raw||this._binormals[P].normalize();this._pointAtData.id=NaN}_getFirstNonNullVector(n){let k=1,T=this._curve[n+k].Fg(this._curve[n]);for(;0===T.length()&&n+k+1<this._curve.length;)k++,T=this._curve[n+k].Fg(this._curve[n]);return T}_getLastNonNullVector(n){let k=1,T=this._curve[n].Fg(this._curve[n-k]);for(;0===T.length()&&n>k+1;)k++,T=this._curve[n].Fg(this._curve[n-k]);return T}_normalVector(n,k){let T,c=n.length();if(0===c&&(c=1),void 0===k||null===k){let k;k=(0,K.p)(Math.abs(n.y)/c,1,G.b)?(0,K.p)(Math.abs(n.x)/c,1,G.b)?(0,K.p)(Math.abs(n.z)/c,1,G.b)?Q.o.Zero():new Q.o(0,0,1):new Q.o(1,0,0):new Q.o(0,-1,0),T=Q.o.Cross(n,k)}else T=Q.o.Cross(n,k),Q.o.CrossToRef(T,n,T);return T.normalize(),T}_updatePointAtData(n){let k=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._pointAtData.id===n)return this._pointAtData.interpolateReady||this._updateInterpolationMatrix(),this._pointAtData;this._pointAtData.id=n;const T=this.getPoints();if(n<=0)return this._setPointAtData(0,0,T[0],0,k);if(n>=1)return this._setPointAtData(1,1,T[T.length-1],T.length-1,k);let c,K=T[0],G=0;const w=n*this.length();for(let E=1;E<T.length;E++){c=T[E];const I=Q.o.Distance(K,c);if(G+=I,G===w)return this._setPointAtData(n,1,c,E,k);if(G>w){const T=(G-w)/I,Q=K.Fg(c),S=c.add(Q.scaleInPlace(T));return this._setPointAtData(n,1-T,S,E-1,k)}K=c}return this._pointAtData}_setPointAtData(n,k,T,c,K){return this._pointAtData.point=T,this._pointAtData.position=n,this._pointAtData.subPosition=k,this._pointAtData.previousPointArrayIndex=c,this._pointAtData.interpolateReady=K,K&&this._updateInterpolationMatrix(),this._pointAtData}_updateInterpolationMatrix(){this._pointAtData.interpolationMatrix=Q.d.Identity();const n=this._pointAtData.previousPointArrayIndex;if(n!==this._tangents.length-1){const k=n+1,T=this._tangents[n].clone(),c=this._normals[n].clone(),K=this._binormals[n].clone(),G=this._tangents[k].clone(),w=this._normals[k].clone(),E=this._binormals[k].clone(),I=Q.h.RotationQuaternionFromAxis(c,K,T),S=Q.h.RotationQuaternionFromAxis(w,E,G);Q.h.Slerp(I,S,this._pointAtData.subPosition).toRotationMatrix(this._pointAtData.interpolationMatrix)}}}},2294:(n,k,T)=>{T.d(k,{b:()=>I,d:()=>S});var c=T(730),K=T(2302);const Q=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],G=[()=>1,n=>n.y,n=>n.z,n=>n.x,n=>n.x*n.y,n=>n.y*n.z,n=>3*n.z*n.z-1,n=>n.x*n.z,n=>n.x*n.x-n.y*n.y],w=(n,k)=>Q[n]*G[n](k),E=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4];class I{constructor(){this.preScaled=!1,this.l00=c.o.Zero(),this.l1_1=c.o.Zero(),this.l10=c.o.Zero(),this.l11=c.o.Zero(),this.l2_2=c.o.Zero(),this.l2_1=c.o.Zero(),this.l20=c.o.Zero(),this.l21=c.o.Zero(),this.l22=c.o.Zero()}addLight(n,k,T){K.h.li[0].set(k.r,k.g,k.b);const c=K.h.li[0],Q=K.h.li[1];c.scaleToRef(T,Q),Q.scaleToRef(w(0,n),K.h.li[2]),this.l00.addInPlace(K.h.li[2]),Q.scaleToRef(w(1,n),K.h.li[2]),this.l1_1.addInPlace(K.h.li[2]),Q.scaleToRef(w(2,n),K.h.li[2]),this.l10.addInPlace(K.h.li[2]),Q.scaleToRef(w(3,n),K.h.li[2]),this.l11.addInPlace(K.h.li[2]),Q.scaleToRef(w(4,n),K.h.li[2]),this.l2_2.addInPlace(K.h.li[2]),Q.scaleToRef(w(5,n),K.h.li[2]),this.l2_1.addInPlace(K.h.li[2]),Q.scaleToRef(w(6,n),K.h.li[2]),this.l20.addInPlace(K.h.li[2]),Q.scaleToRef(w(7,n),K.h.li[2]),this.l21.addInPlace(K.h.li[2]),Q.scaleToRef(w(8,n),K.h.li[2]),this.l22.addInPlace(K.h.li[2])}scaleInPlace(n){this.l00.scaleInPlace(n),this.l1_1.scaleInPlace(n),this.l10.scaleInPlace(n),this.l11.scaleInPlace(n),this.l2_2.scaleInPlace(n),this.l2_1.scaleInPlace(n),this.l20.scaleInPlace(n),this.l21.scaleInPlace(n),this.l22.scaleInPlace(n)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(E[0]),this.l1_1.scaleInPlace(E[1]),this.l10.scaleInPlace(E[2]),this.l11.scaleInPlace(E[3]),this.l2_2.scaleInPlace(E[4]),this.l2_1.scaleInPlace(E[5]),this.l20.scaleInPlace(E[6]),this.l21.scaleInPlace(E[7]),this.l22.scaleInPlace(E[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(Q[0]),this.l1_1.scaleInPlace(Q[1]),this.l10.scaleInPlace(Q[2]),this.l11.scaleInPlace(Q[3]),this.l2_2.scaleInPlace(Q[4]),this.l2_1.scaleInPlace(Q[5]),this.l20.scaleInPlace(Q[6]),this.l21.scaleInPlace(Q[7]),this.l22.scaleInPlace(Q[8])}updateFromArray(n){return c.o.FromArrayToRef(n[0],0,this.l00),c.o.FromArrayToRef(n[1],0,this.l1_1),c.o.FromArrayToRef(n[2],0,this.l10),c.o.FromArrayToRef(n[3],0,this.l11),c.o.FromArrayToRef(n[4],0,this.l2_2),c.o.FromArrayToRef(n[5],0,this.l2_1),c.o.FromArrayToRef(n[6],0,this.l20),c.o.FromArrayToRef(n[7],0,this.l21),c.o.FromArrayToRef(n[8],0,this.l22),this}updateFromFloatsArray(n){return c.o.FromFloatsToRef(n[0],n[1],n[2],this.l00),c.o.FromFloatsToRef(n[3],n[4],n[5],this.l1_1),c.o.FromFloatsToRef(n[6],n[7],n[8],this.l10),c.o.FromFloatsToRef(n[9],n[10],n[11],this.l11),c.o.FromFloatsToRef(n[12],n[13],n[14],this.l2_2),c.o.FromFloatsToRef(n[15],n[16],n[17],this.l2_1),c.o.FromFloatsToRef(n[18],n[19],n[20],this.l20),c.o.FromFloatsToRef(n[21],n[22],n[23],this.l21),c.o.FromFloatsToRef(n[24],n[25],n[26],this.l22),this}static ji(n){return(new I).updateFromArray(n)}static FromPolynomial(n){const k=new I;return k.l00=n.xx.scale(.376127).add(n.yy.scale(.376127)).add(n.zz.scale(.376126)),k.l1_1=n.y.scale(.977204),k.l10=n.z.scale(.977204),k.l11=n.x.scale(.977204),k.l2_2=n.xy.scale(1.16538),k.l2_1=n.yz.scale(1.16538),k.l20=n.zz.scale(1.34567).Fg(n.xx.scale(.672834)).Fg(n.yy.scale(.672834)),k.l21=n.zx.scale(1.16538),k.l22=n.xx.scale(1.16538).Fg(n.yy.scale(1.16538)),k.l1_1.scaleInPlace(-1),k.l11.scaleInPlace(-1),k.l2_1.scaleInPlace(-1),k.l21.scaleInPlace(-1),k.scaleInPlace(Math.PI),k}}class S{constructor(){this.x=c.o.Zero(),this.y=c.o.Zero(),this.z=c.o.Zero(),this.xx=c.o.Zero(),this.yy=c.o.Zero(),this.zz=c.o.Zero(),this.xy=c.o.Zero(),this.yz=c.o.Zero(),this.zx=c.o.Zero()}get preScaledHarmonics(){return this._harmonics||(this._harmonics=I.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(n){K.h.li[0].di(n.r,n.g,n.b);const k=K.h.li[0];this.xx.addInPlace(k),this.yy.addInPlace(k),this.zz.addInPlace(k)}scaleInPlace(n){this.x.scaleInPlace(n),this.y.scaleInPlace(n),this.z.scaleInPlace(n),this.xx.scaleInPlace(n),this.yy.scaleInPlace(n),this.zz.scaleInPlace(n),this.yz.scaleInPlace(n),this.zx.scaleInPlace(n),this.xy.scaleInPlace(n)}updateFromHarmonics(n){return this._harmonics=n,this.x.p(n.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.p(n.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.p(n.l10),this.z.scaleInPlace(1.02333),this.xx.p(n.l00),K.h.li[0].p(n.l20).scaleInPlace(.247708),K.h.li[1].p(n.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).Oi(K.h.li[0]).addInPlace(K.h.li[1]),this.yy.p(n.l00),this.yy.scaleInPlace(.886277).Oi(K.h.li[0]).Oi(K.h.li[1]),this.zz.p(n.l00),K.h.li[0].p(n.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(K.h.li[0]),this.yz.p(n.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.p(n.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.p(n.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(n){return(new S).updateFromHarmonics(n)}static ji(n){const k=new S;return c.o.FromArrayToRef(n[0],0,k.x),c.o.FromArrayToRef(n[1],0,k.y),c.o.FromArrayToRef(n[2],0,k.z),c.o.FromArrayToRef(n[3],0,k.xx),c.o.FromArrayToRef(n[4],0,k.yy),c.o.FromArrayToRef(n[5],0,k.zz),c.o.FromArrayToRef(n[6],0,k.yz),c.o.FromArrayToRef(n[7],0,k.zx),c.o.FromArrayToRef(n[8],0,k.xy),k}}},2399:(n,k,T)=>{T.d(k,{c:()=>K});var c=T(787);class K extends c.b{constructor(n){super(),this._buffer=n}get underlyingResource(){return this._buffer}}},2325:(n,k,T)=>{T.d(k,{e:()=>I});var c=T(730),K=T(747),Q=T(2294),G=T(736),w=T(764);class E{constructor(n,k,T,c){this.name=n,this.worldAxisForNormal=k,this.worldAxisForFileX=T,this.worldAxisForFileY=c}}class I{static ConvertCubeMapTextureToSphericalPolynomial(n){var k;if(!n.isCube)return null;null===(k=n.va())||void 0===k||k.getEngine().flushFramebuffer();const T=n.getSize().width,c=n.readPixels(0,void 0,void 0,!1),K=n.readPixels(1,void 0,void 0,!1);let Q,G;n.isRenderTarget?(Q=n.readPixels(3,void 0,void 0,!1),G=n.readPixels(2,void 0,void 0,!1)):(Q=n.readPixels(2,void 0,void 0,!1),G=n.readPixels(3,void 0,void 0,!1));const w=n.readPixels(4,void 0,void 0,!1),E=n.readPixels(5,void 0,void 0,!1),I=n.gammaSpace;let S=0;return 1!=n.textureType&&2!=n.textureType||(S=1),new Promise((n=>{Promise.all([K,c,Q,G,w,E]).then((k=>{let[c,K,Q,G,w,E]=k;const P={size:T,right:K,left:c,up:Q,down:G,front:w,back:E,format:5,type:S,gammaSpace:I};n(this.ConvertCubeMapToSphericalPolynomial(P))}))}))}static _AreaElement(n,k){return Math.atan2(n*k,Math.sqrt(n*n+k*k+1))}static ConvertCubeMapToSphericalPolynomial(n){const k=new Q.b;let T=0;const c=2/n.size,E=c,I=.5*c,S=I-1;for(let Q=0;Q<6;Q++){const P=this._FileFaces[Q],W=n[P.name];let J=S;const H=5===n.format?4:3;for(let Q=0;Q<n.size;Q++){let s=S;for(let E=0;E<n.size;E++){const S=P.worldAxisForFileX.scale(s).add(P.worldAxisForFileY.scale(J)).add(P.worldAxisForNormal);S.normalize();const b=this._AreaElement(s-I,J-I)-this._AreaElement(s-I,J+I)-this._AreaElement(s+I,J-I)+this._AreaElement(s+I,J+I);let C=W[Q*n.size*H+E*H+0],z=W[Q*n.size*H+E*H+1],r=W[Q*n.size*H+E*H+2];isNaN(C)&&(C=0),isNaN(z)&&(z=0),isNaN(r)&&(r=0),0===n.type&&(C/=255,z/=255,r/=255),n.gammaSpace&&(C=Math.pow((0,K.b)(C),G.h),z=Math.pow((0,K.b)(z),G.h),r=Math.pow((0,K.b)(r),G.h));const q=this.MAX_HDRI_VALUE;if(this.PRESERVE_CLAMPED_COLORS){const n=Math.max(C,z,r);if(n>q){const k=q/n;C*=k,z*=k,r*=k}}else C=(0,K.b)(C,0,q),z=(0,K.b)(z,0,q),r=(0,K.b)(r,0,q);const O=new w.e(C,z,r);k.addLight(S,O,b),T+=b,s+=c}J+=E}}const P=6*(4*Math.PI)/6/T;return k.scaleInPlace(P),k.convertIncidentRadianceToIrradiance(),k.convertIrradianceToLambertianRadiance(),Q.d.FromHarmonics(k)}}I._FileFaces=[new E("right",new c.o(1,0,0),new c.o(0,0,-1),new c.o(0,-1,0)),new E("left",new c.o(-1,0,0),new c.o(0,0,1),new c.o(0,-1,0)),new E("up",new c.o(0,1,0),new c.o(1,0,0),new c.o(0,0,1)),new E("down",new c.o(0,-1,0),new c.o(1,0,0),new c.o(0,0,-1)),new E("front",new c.o(0,0,1),new c.o(1,0,0),new c.o(0,-1,0)),new E("back",new c.o(0,0,-1),new c.o(-1,0,0),new c.o(0,-1,0))],I.MAX_HDRI_VALUE=4096,I.PRESERVE_CLAMPED_COLORS=!1},2447:(n,k,T)=>{T.d(k,{d:()=>K});var c=T(573);class K{get min(){return this._min}get max(){return this._max}get average(){return this._average}get lastSecAverage(){return this._lastSecAverage}get current(){return this._current}get total(){return this._totalAccumulated}get count(){return this._totalValueCount}constructor(){this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0}fetchNewFrame(){this._totalValueCount++,this._current=0,this._lastSecValueCount++}addCount(n,k){K.Enabled&&(this._current+=n,k&&this._fetchResult())}beginMonitoring(){K.Enabled&&(this._startMonitoringTime=c.e.Now)}endMonitoring(){let n=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(!K.Enabled)return;n&&this.fetchNewFrame();const k=c.e.Now;this._current=k-this._startMonitoringTime,n&&this._fetchResult()}Fi(){this._fetchResult()}_fetchResult(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=Math.min(this._min,this._current),this._max=Math.max(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;const n=c.e.Now;n-this._lastSecTime>1e3&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=n,this._lastSecAccumulated=0,this._lastSecValueCount=0)}}K.Enabled=!0},2329:(n,k,T)=>{T.d(k,{e:()=>C,g:()=>O,i:()=>u,m:()=>q});var c=T(2334),K=T(2350),Q=T(706),G=T(2371),w=T(615),E=T(675),I=T(760),S=T(2374),P=T(2388);class W extends S.e{_gatherImports(n,k){n?(this._webGPUReady=!0,k.push(Promise.all([T.e(34).then(T.bind(T,13375))]))):k.push(Promise.all([T.e(35).then(T.bind(T,13382))])),super._gatherImports(n,k)}constructor(n){super({...arguments.length>2?arguments[2]:void 0,name:n,Hi:(arguments.length>1&&void 0!==arguments[1]?arguments[1]:null)||P.b.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:W.FragmentUrl})}}W.FragmentUrl="pass";class J extends S.e{_gatherImports(n,k){n?(this._webGPUReady=!0,k.push(Promise.all([T.e(36).then(T.bind(T,13386))]))):k.push(Promise.all([T.e(37).then(T.bind(T,13391))])),super._gatherImports(n,k)}constructor(n){super({...arguments.length>2?arguments[2]:void 0,name:n,Hi:(arguments.length>1&&void 0!==arguments[1]?arguments[1]:null)||P.b.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:J.FragmentUrl,defines:"#define POSITIVEX"}),this._face=0}get face(){return this._face}set face(n){if(!(n<0||n>5))switch(this._face=n,this._face){case 0:this.updateEffect("#define POSITIVEX");break;case 1:this.updateEffect("#define NEGATIVEX");break;case 2:this.updateEffect("#define POSITIVEY");break;case 3:this.updateEffect("#define NEGATIVEY");break;case 4:this.updateEffect("#define POSITIVEZ");break;case 5:this.updateEffect("#define NEGATIVEZ")}}}J.FragmentUrl="passCube";var H=T(712);class s extends G.c{getClassName(){return"PassPostProcess"}constructor(n,k){let T=arguments.length>4?arguments[4]:void 0;const c={size:"number"===typeof k?k:void 0,camera:arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,samplingMode:arguments.length>3?arguments[3]:void 0,Hi:T,reusable:arguments.length>5?arguments[5]:void 0,textureType:arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,blockCompilation:arguments.length>7&&void 0!==arguments[7]&&arguments[7],...k};super(n,W.FragmentUrl,{effectWrapper:"number"!==typeof k&&k.effectWrapper?void 0:new W(n,T,c),...c})}static _Parse(n,k,T,c){return I.d.Parse((()=>new s(n.name,n.options,k,n.renderTargetSamplingMode,n._engine,n.reusable)),n,T,c)}}(0,E.f)("BABYLON.PassPostProcess",s);class b extends G.c{get face(){return this._effectWrapper.face}set face(n){this._effectWrapper.face=n}getClassName(){return"PassCubePostProcess"}constructor(n,k){let T=arguments.length>4?arguments[4]:void 0;const c={size:"number"===typeof k?k:void 0,camera:arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,samplingMode:arguments.length>3?arguments[3]:void 0,Hi:T,reusable:arguments.length>5?arguments[5]:void 0,textureType:arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,blockCompilation:arguments.length>7&&void 0!==arguments[7]&&arguments[7],...k};super(n,W.FragmentUrl,{effectWrapper:"number"!==typeof k&&k.effectWrapper?void 0:new J(n,T,c),...c})}static _Parse(n,k,T,c){return I.d.Parse((()=>new b(n.name,n.options,k,n.renderTargetSamplingMode,n._engine,n.reusable)),n,T,c)}}function C(n,k,T,c,K,Q,w,E){const I=k.getEngine();return k.isReady=!1,K=K??k.samplingMode,c=c??k.type,Q=Q??k.format,w=w??k.width,E=E??k.height,-1===c&&(c=0),new Promise((S=>{const P=new G.c("postprocess",n,null,null,1,null,K,I,!1,void 0,c,void 0,null,!1,Q);P.externalTextureSamplerBinding=!0;const W=I.createRenderTargetTexture({width:w,height:E},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:K,type:c,format:Q});P.onEffectCreatedObservable.addOnce((n=>{n.executeWhenCompiled((()=>{P.onApply=n=>{n._bindTexture("textureSampler",k),n.setFloat2("scale",1,1)},T.postProcessManager.directRender([P],W,!0),I.restoreDefaultFramebuffer(),I._releaseTexture(k),P&&P.dispose(),W._swapAndDie(k),k.type=c,k.format=5,k.isReady=!0,S(k)}))}))}))}let z,r;function q(n){z||(z=new Float32Array(1),r=new Int32Array(z.buffer)),z[0]=n;const k=r[0];let T=k>>16&32768,c=k>>12&2047;const K=k>>23&255;return K<103?T:K>142?(T|=31744,T|=(255==K?0:1)&&8388607&k,T):K<113?(c|=2048,T|=(c>>114-K)+(c>>113-K&1),T):(T|=K-112<<10|c>>1,T+=1&c,T)}function O(n){const k=(32768&n)>>15,T=(31744&n)>>10,c=1023&n;return 0===T?(k?-1:1)*Math.pow(2,-14)*(c/Math.pow(2,10)):31==T?c?NaN:1/0*(k?-1:1):(k?-1:1)*Math.pow(2,T-15)*(1+c/Math.pow(2,10))}(0,Q.e)([(0,H.K)()],b.prototype,"face",null),w.b._RescalePostProcessFactory=n=>new s("rescale",1,null,2,n,!1,0);const u={CreateResizedCopy:function(n,k,T){let Q=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const G=n.va(),w=G.getEngine(),E=new K.e("resized"+n.name,{width:k,height:T},G,!n.noMipmap,!0,n._texture.type,!1,n.samplingMode,!1);E.wrapU=n.wrapU,E.wrapV=n.wrapV,E.uOffset=n.uOffset,E.vOffset=n.vOffset,E.uScale=n.uScale,E.vScale=n.vScale,E.uAng=n.uAng,E.vAng=n.vAng,E.wAng=n.wAng,E.coordinatesIndex=n.coordinatesIndex,E.level=n.level,E.anisotropicFilteringLevel=n.anisotropicFilteringLevel,E._texture.isReady=!1,n.wrapU=c.b.CLAMP_ADDRESSMODE,n.wrapV=c.b.CLAMP_ADDRESSMODE;const I=new s("pass",1,null,Q?c.b.BILINEAR_SAMPLINGMODE:c.b.NEAREST_SAMPLINGMODE,w,!1,0);return I.externalTextureSamplerBinding=!0,I.onEffectCreatedObservable.addOnce((k=>{k.executeWhenCompiled((()=>{I.onApply=function(k){k.setTexture("textureSampler",n)};const k=E.renderTarget;k&&(G.postProcessManager.directRender([I],k),w.unBindFramebuffer(k),E.disposeFramebufferObjects(),I.dispose(),E.getInternalTexture().isReady=!0)}))})),E},ApplyPostProcess:C,ToHalfFloat:q,FromHalfFloat:O,GetTextureDataAsync:async function(n,k,Q){let w=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,E=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;return!n.isReady()&&n._texture&&await new Promise(((k,T)=>{null!==n._texture?n._texture.onLoadedObservable.addOnce((()=>{k(0)})):T(0)})),await(async(n,k,Q,w,E)=>{const I=n.va(),S=I.getEngine();let P;if(S.isWebGPU?n.isCube?await T.e(31).then(T.bind(T,13356)):await T.e(32).then(T.bind(T,13358)):n.isCube?await T.e(29).then(T.bind(T,13348)):await T.e(30).then(T.bind(T,13351)),n.isCube){const n=["#define POSITIVEX","#define NEGATIVEX","#define POSITIVEY","#define NEGATIVEY","#define POSITIVEZ","#define NEGATIVEZ"];P=new G.c("lodCube","lodCube",{uniforms:["lod","gamma"],samplingMode:c.b.NEAREST_NEAREST_MIPNEAREST,Hi:S,defines:n[w],shaderLanguage:S.isWebGPU?1:0})}else P=new G.c("lod","lod",{uniforms:["lod","gamma"],samplingMode:c.b.NEAREST_NEAREST_MIPNEAREST,Hi:S,shaderLanguage:S.isWebGPU?1:0});await new Promise((n=>{P.onEffectCreatedObservable.addOnce((k=>{k.executeWhenCompiled((()=>{n(0)}))}))}));const W=new K.e("temp",{width:k,height:Q},I,!1);P.onApply=function(k){k.setTexture("textureSampler",n),k.setFloat("lod",E),k.setInt("gamma",n.gammaSpace?1:0)};const J=n.getInternalTexture();try{if(W.renderTarget&&J){const T=J.samplingMode;0!==E?n.updateSamplingMode(c.b.NEAREST_NEAREST_MIPNEAREST):n.updateSamplingMode(c.b.NEAREST_NEAREST),I.postProcessManager.directRender([P],W.renderTarget,!0),n.updateSamplingMode(T);const K=await S.readPixels(0,0,k,Q),G=new Uint8Array(K.buffer,0,K.byteLength);return S.unBindFramebuffer(W.renderTarget),G}throw Error("Render to texture failed.")}finally{W.dispose(),P.dispose()}})(n,k,Q,w,E)}}},2371:(n,k,T)=>{T.d(k,{c:()=>H});var c=T(706),K=T(727),Q=T(539),G=T(730),w=T(617),E=T(712),I=T(760),S=T(675),P=T(615),W=T(693),J=T(2374);P.b.prototype.setTextureFromPostProcess=function(n,k,T){var c;let K=null;k&&(k._forcedOutputTexture?K=k._forcedOutputTexture:k._textures.data[k._currentRenderTextureInd]&&(K=k._textures.data[k._currentRenderTextureInd])),this._bindTexture(n,(null===(c=K)||void 0===c?void 0:c.texture)??null,T)},P.b.prototype.setTextureFromPostProcessOutput=function(n,k,T){var c;this._bindTexture(n,(null===k||void 0===k||null===(c=k._outputTexture)||void 0===c?void 0:c.texture)??null,T)},w.b.prototype.setTextureFromPostProcess=function(n,k){this._engine.setTextureFromPostProcess(this._samplers[n],k,n)},w.b.prototype.setTextureFromPostProcessOutput=function(n,k){this._engine.setTextureFromPostProcessOutput(this._samplers[n],k,n)};class H{static get ForceGLSL(){return J.e.ForceGLSL}static set ForceGLSL(n){J.e.ForceGLSL=n}static RegisterShaderCodeProcessing(n,k){J.e.RegisterShaderCodeProcessing(n,k)}get name(){return this._effectWrapper.name}set name(n){this._effectWrapper.name=n}get alphaMode(){return this._effectWrapper.alphaMode}set alphaMode(n){this._effectWrapper.alphaMode=n}get samples(){return this._samples}set samples(n){this._samples=Math.min(n,this._engine.getCaps().maxMSAASamples),this._textures.forEach((n=>{n.setSamples(this._samples)}))}get shaderLanguage(){return this._shaderLanguage}getEffectName(){return this._fragmentUrl}set onActivate(n){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),n&&(this._onActivateObserver=this.onActivateObservable.add(n))}set onSizeChanged(n){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(n)}set onApply(n){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(n)}set onBeforeRender(n){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(n)}set onAfterRender(n){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(n)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(n){this._forcedOutputTexture=n}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.di(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(n,k,T,c,w,E){var I;let S=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,P=arguments.length>7?arguments[7]:void 0,W=arguments.length>8?arguments[8]:void 0,s=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,b=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0,C=arguments.length>11&&void 0!==arguments[11]?arguments[11]:"postprocess",z=arguments.length>12?arguments[12]:void 0,r=arguments.length>13&&void 0!==arguments[13]&&arguments[13],q=arguments.length>14&&void 0!==arguments[14]?arguments[14]:5,O=arguments.length>15?arguments[15]:void 0,u=arguments.length>16?arguments[16]:void 0;this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.vl=!0,this.forceAutoClearInAlphaMode=!1,this.animations=[],this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._webGPUReady=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new K.g(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new G.m(1,1),this._texelSize=G.m.Zero(),this.onActivateObservable=new Q.b,this.onSizeChangedObservable=new Q.b,this.onApplyObservable=new Q.b,this.onBeforeRenderObservable=new Q.b,this.onAfterRenderObservable=new Q.b,this.Gi=new Q.b;let f,A=1,v=null;if(T&&!Array.isArray(T)){const n=T;T=n.uniforms??null,c=n.samplers??null,A=n.size??1,E=n.camera??null,S=n.samplingMode??1,P=n.Hi,W=n.reusable,s=Array.isArray(n.defines)?n.defines.join("\n"):n.defines??null,b=n.textureType??0,C=n.vertexUrl??"postprocess",z=n.indexParameters,r=n.blockCompilation??!1,q=n.textureFormat??5,O=n.shaderLanguage??0,v=n.uniformBuffers??null,u=n.extraInitializations,f=n.effectWrapper}else w&&(A="number"===typeof w?w:{width:w.width,height:w.height});if(this._useExistingThinPostProcess=!!f,this._effectWrapper=f??new J.e({name:n,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:k,Hi:P||(null===(I=E)||void 0===I?void 0:I.va().getEngine()),uniforms:T,samplers:c,uniformBuffers:v,defines:s,vertexUrl:C,indexParameters:z,blockCompilation:!0,shaderLanguage:O,extraInitializations:void 0}),this.name=n,this.onEffectCreatedObservable=this._effectWrapper.onEffectCreatedObservable,null!=E?(this._camera=E,this._scene=E.va(),E.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):P&&(this._engine=P,this._engine.postProcesses.push(this)),this._options=A,this.renderTargetSamplingMode=S||1,this._reusable=W||!1,this._textureType=b,this._textureFormat=q,this._shaderLanguage=O||0,this._samplers=c||[],-1===this._samplers.indexOf("textureSampler")&&this._samplers.push("textureSampler"),this._fragmentUrl=k,this._vertexUrl=C,this._parameters=T||[],-1===this._parameters.indexOf("scale")&&this._parameters.push("scale"),this._uniformBuffers=v||[],this._indexParameters=z,!this._useExistingThinPostProcess){this._webGPUReady=1===this._shaderLanguage;const n=[];this._gatherImports(this._engine.isWebGPU&&!H.ForceGLSL,n),this._effectWrapper._webGPUReady=this._webGPUReady,this._effectWrapper._postConstructor(r,s,u,n)}}_gatherImports(){let n=arguments.length>1?arguments[1]:void 0;arguments.length>0&&void 0!==arguments[0]&&arguments[0]&&this._webGPUReady?n.push(Promise.all([T.e(33).then(T.bind(T,13367))])):n.push(Promise.all([Promise.resolve().then(T.bind(T,2383))]))}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._effectWrapper.drawWrapper.effect}shareOutputWith(n){return this._disposeTextures(),this._shareOutputWithPostProcess=n,this}useOwnOutput(){0==this._textures.length&&(this._textures=new K.g(2)),this._shareOutputWithPostProcess=null}updateEffect(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,T=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,c=arguments.length>3?arguments[3]:void 0,K=arguments.length>4?arguments[4]:void 0,Q=arguments.length>5?arguments[5]:void 0,G=arguments.length>6?arguments[6]:void 0,w=arguments.length>7?arguments[7]:void 0;this._effectWrapper.updateEffect(n,k,T,c,K,Q,G,w),this._postProcessDefines=Array.isArray(this._effectWrapper.options.defines)?this._effectWrapper.options.defines.join("\n"):this._effectWrapper.options.defines}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(n,k){let T=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;for(let K=0;K<this._textureCache.length;K++)if(this._textureCache[K].texture.width===n.width&&this._textureCache[K].texture.height===n.height&&this._textureCache[K].postProcessChannel===T&&this._textureCache[K].texture._generateDepthBuffer===k.generateDepthBuffer&&this._textureCache[K].texture.samples===k.samples)return this._textureCache[K].texture;const c=this._engine.createRenderTargetTexture(n,k);return this._textureCache.push({texture:c,postProcessChannel:T,lastUsedRenderId:-1}),c}_flushTextureCache(){const n=this._renderId;for(let k=this._textureCache.length-1;k>=0;k--)if(n-this._textureCache[k].lastUsedRenderId>100){let n=!1;for(let T=0;T<this._textures.length;T++)if(this._textures.data[T]===this._textureCache[k].texture){n=!0;break}n||(this._textureCache[k].texture.dispose(),this._textureCache.splice(k,1))}}resize(n,k){let T=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,c=arguments.length>3&&void 0!==arguments[3]&&arguments[3],K=arguments.length>4&&void 0!==arguments[4]&&arguments[4];this._textures.length>0&&this._textures.reset(),this.width=n,this.height=k;let Q=null;if(T)for(let E=0;E<T._postProcesses.length;E++)if(null!==T._postProcesses[E]){Q=T._postProcesses[E];break}const G={width:this.width,height:this.height},w={generateMipMaps:c,generateDepthBuffer:K||Q===this,generateStencilBuffer:(K||Q===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples,label:"PostProcessRTT-"+this.name};this._textures.push(this._createRenderTargetTexture(G,w,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(G,w,1)),this._texelSize.di(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}_getTarget(){let n;if(this._shareOutputWithPostProcess)n=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)n=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{let k;n=this.inputTexture;for(let T=0;T<this._textureCache.length;T++)if(this._textureCache[T].texture===n){k=this._textureCache[T];break}k&&(k.lastUsedRenderId=this._renderId)}return n}activate(n){var k,T;let c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,K=arguments.length>2?arguments[2]:void 0;const Q=null===n||void 0!==n.cameraRigMode?n||this._camera:null,G=(null===Q||void 0===Q?void 0:Q.va())??n,w=G.getEngine(),E=w.getCaps().maxTextureSize,I=(c?c.width:this._engine.getRenderWidth(!0))*this._options|0,S=(c?c.height:this._engine.getRenderHeight(!0))*this._options|0;let P=this._options.width||I,J=this._options.height||S;const H=7!==this.renderTargetSamplingMode&&1!==this.renderTargetSamplingMode&&2!==this.renderTargetSamplingMode;let s=null;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const n=w.currentViewport;n&&(P*=n.width,J*=n.height)}(H||this.alwaysForcePOT)&&(this._options.width||(P=w.needPOTTextures?(0,W.h)(P,E,this.scaleMode):P),this._options.height||(J=w.needPOTTextures?(0,W.h)(J,E,this.scaleMode):J)),this.width===P&&this.height===J&&(s=this._getTarget())||this.resize(P,J,Q,H,K),this._textures.forEach((n=>{n.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(n,this.samples)})),this._flushTextureCache(),this._renderId++}return s||(s=this._getTarget()),this.enablePixelPerfectMode?(this._scaleRatio.di(I/P,S/J),this._engine.bindFramebuffer(s,0,I,S,this.forceFullscreenViewport)):(this._scaleRatio.di(1,1),this._engine.bindFramebuffer(s,0,void 0,void 0,this.forceFullscreenViewport)),null===(k=(T=this._engine)._debugInsertMarker)||void 0===k||k.call(T,`post process ${this.name} input`),this.onActivateObservable.notifyObservers(Q),this.vl&&(0===this.alphaMode||this.forceAutoClearInAlphaMode)&&this._engine.clear(this.clearColor?this.clearColor:G.clearColor,G._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),s}get isSupported(){return this._effectWrapper.drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){return this._effectWrapper.isReady()}apply(){if(!this._effectWrapper.isReady())return null;let n;var k;(this._engine.enableEffect(this._effectWrapper.drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a),this._engine.setAlphaMode(this.alphaMode),n=this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?this._forcedOutputTexture:this.inputTexture,this.externalTextureSamplerBinding)||this._effectWrapper.drawWrapper.effect._bindTexture("textureSampler",null===(k=n)||void 0===k?void 0:k.texture);return this._effectWrapper.drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._effectWrapper.drawWrapper.effect),this._effectWrapper.bind(!0),this._effectWrapper.drawWrapper.effect}_disposeTextures(){this._shareOutputWithPostProcess||this._forcedOutputTexture?this._disposeTextureCache():(this._disposeTextureCache(),this._textures.dispose())}_disposeTextureCache(){for(let n=this._textureCache.length-1;n>=0;n--)this._textureCache[n].texture.dispose();this._textureCache.length=0}setPrePassRenderer(n){return!!this._prePassEffectConfiguration&&(this._prePassEffectConfiguration=n.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0)}dispose(n){let k;if(n=n||this._camera,this._useExistingThinPostProcess||this._effectWrapper.dispose(),this._disposeTextures(),this._scene&&(k=this._scene.postProcesses.indexOf(this),-1!==k&&this._scene.postProcesses.splice(k,1)),this._parentContainer){const n=this._parentContainer.postProcesses.indexOf(this);n>-1&&this._parentContainer.postProcesses.splice(n,1),this._parentContainer=null}if(k=this._engine.postProcesses.indexOf(this),-1!==k&&this._engine.postProcesses.splice(k,1),this.Gi.notifyObservers(),n){if(n.detachPostProcess(this),k=n._postProcesses.indexOf(this),0===k&&n._postProcesses.length>0){const n=this._camera._getFirstPostProcess();n&&n.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear(),this.onEffectCreatedObservable.clear()}}serialize(){const n=I.d.Serialize(this),k=this.getCamera()||this._scene&&this._scene.activeCamera;return n.customType="BABYLON."+this.getClassName(),n.cameraId=k?k.id:null,n.reusable=this._reusable,n.textureType=this._textureType,n.fragmentUrl=this._fragmentUrl,n.parameters=this._parameters,n.samplers=this._samplers,n.uniformBuffers=this._uniformBuffers,n.options=this._options,n.defines=this._postProcessDefines,n.textureFormat=this._textureFormat,n.vertexUrl=this._vertexUrl,n.indexParameters=this._indexParameters,n}clone(){const n=this.serialize();n._engine=this._engine,n.cameraId=null;const k=H.Parse(n,this._scene,"");return k?(k.onActivateObservable=this.onActivateObservable.clone(),k.onSizeChangedObservable=this.onSizeChangedObservable.clone(),k.onApplyObservable=this.onApplyObservable.clone(),k.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),k.onAfterRenderObservable=this.onAfterRenderObservable.clone(),k._prePassEffectConfiguration=this._prePassEffectConfiguration,k):null}static Parse(n,k,T){const c=(0,S.b)(n.customType);if(!c||!c._Parse)return null;const K=k?k.getCameraById(n.cameraId):null;return c._Parse(n,K,k,T)}static _Parse(n,k,T,c){return I.d.Parse((()=>new H(n.name,n.fragmentUrl,n.parameters,n.samplers,n.options,k,n.renderTargetSamplingMode,n._engine,n.reusable,n.defines,n.textureType,n.vertexUrl,n.indexParameters,!1,n.textureFormat)),n,T,c)}}(0,c.e)([(0,E.K)()],H.prototype,"uniqueId",void 0),(0,c.e)([(0,E.K)()],H.prototype,"name",null),(0,c.e)([(0,E.K)()],H.prototype,"width",void 0),(0,c.e)([(0,E.K)()],H.prototype,"height",void 0),(0,c.e)([(0,E.K)()],H.prototype,"renderTargetSamplingMode",void 0),(0,c.e)([(0,E.k)()],H.prototype,"clearColor",void 0),(0,c.e)([(0,E.K)()],H.prototype,"vl",void 0),(0,c.e)([(0,E.K)()],H.prototype,"forceAutoClearInAlphaMode",void 0),(0,c.e)([(0,E.K)()],H.prototype,"alphaMode",null),(0,c.e)([(0,E.K)()],H.prototype,"alphaConstants",void 0),(0,c.e)([(0,E.K)()],H.prototype,"enablePixelPerfectMode",void 0),(0,c.e)([(0,E.K)()],H.prototype,"forceFullscreenViewport",void 0),(0,c.e)([(0,E.K)()],H.prototype,"scaleMode",void 0),(0,c.e)([(0,E.K)()],H.prototype,"alwaysForcePOT",void 0),(0,c.e)([(0,E.K)("samples")],H.prototype,"_samples",void 0),(0,c.e)([(0,E.K)()],H.prototype,"adaptScaleToCurrentViewport",void 0),(0,S.f)("BABYLON.PostProcess",H)},2353:(n,k,T)=>{T.d(k,{e:()=>Q});var c=T(781),K=T(539);class Q{constructor(n){this._vertexBuffers={},this.onBeforeRenderObservable=new K.b,this._scene=n}_prepareBuffers(){if(this._vertexBuffers[c.f.PositionKind])return;const n=[];n.push(1,1),n.push(-1,1),n.push(-1,-1),n.push(1,-1),this._vertexBuffers[c.f.PositionKind]=new c.f(this._scene.getEngine(),n,c.f.PositionKind,!1,!1,2),this._buildIndexBuffer()}_buildIndexBuffer(){const n=[];n.push(0),n.push(1),n.push(2),n.push(0),n.push(2),n.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(n)}_rebuild(){const n=this._vertexBuffers[c.f.PositionKind];n&&(n._rebuild(),this._buildIndexBuffer())}_prepareFrame(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const T=this._scene.activeCamera;return!!T&&(k=k||T._postProcesses.filter((n=>null!=n)),!(!k||0===k.length||!this._scene.postProcessesEnabled)&&(k[0].activate(T,n,null!==k&&void 0!==k),!0))}directRender(n){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,T=arguments.length>2&&void 0!==arguments[2]&&arguments[2],c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,K=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,Q=arguments.length>5&&void 0!==arguments[5]&&arguments[5],G=arguments.length>6&&void 0!==arguments[6]?arguments[6]:n.length;const w=this._scene.getEngine();for(let I=0;I<G;I++){var E;if(I<n.length-1)n[I+1].activate(this._scene.activeCamera||this._scene,null===k||void 0===k?void 0:k.texture);else k?w.bindFramebuffer(k,c,void 0,void 0,T,K):Q||w.restoreDefaultFramebuffer(),null===(E=w._debugInsertMarker)||void 0===E||E.call(w,`post process ${n[I].name} output`);const G=n[I],S=G.apply();S&&(G.onBeforeRenderObservable.notifyObservers(S),this._prepareBuffers(),w.bindBuffers(this._vertexBuffers,this._indexBuffer,S),w.drawElementsType(0,0,6),G.onAfterRenderObservable.notifyObservers(S))}w.setDepthBuffer(!0),w.setDepthWrite(!0)}_finalizeFrame(n,k,T,c){let K=arguments.length>4&&void 0!==arguments[4]&&arguments[4];const Q=this._scene.activeCamera;if(!Q)return;if(this.onBeforeRenderObservable.notifyObservers(this),0===(c=c||Q._postProcesses.filter((n=>null!=n))).length||!this._scene.postProcessesEnabled)return;const G=this._scene.getEngine();for(let E=0,I=c.length;E<I;E++){const S=c[E];var w;if(E<I-1)S._outputTexture=c[E+1].activate(Q,null===k||void 0===k?void 0:k.texture);else k?(G.bindFramebuffer(k,T,void 0,void 0,K),S._outputTexture=k):(G.restoreDefaultFramebuffer(),S._outputTexture=null),null===(w=G._debugInsertMarker)||void 0===w||w.call(G,`post process ${c[E].name} output`);if(n)break;const P=S.apply();P&&(S.onBeforeRenderObservable.notifyObservers(P),this._prepareBuffers(),G.bindBuffers(this._vertexBuffers,this._indexBuffer,P),G.drawElementsType(0,0,6),S.onAfterRenderObservable.notifyObservers(P))}G.setDepthBuffer(!0),G.setDepthWrite(!0),G.setAlphaMode(0)}dispose(){const n=this._vertexBuffers[c.f.PositionKind];n&&(n.dispose(),this._vertexBuffers[c.f.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)}}},2362:(n,k,T)=>{T.d(k,{b:()=>w});var c=T(727),K=T(730);class Q{set opaqueSortCompareFn(n){this._opaqueSortCompareFn=n||Q.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted}set alphaTestSortCompareFn(n){this._alphaTestSortCompareFn=n||Q.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted}set transparentSortCompareFn(n){this._transparentSortCompareFn=n||Q.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted}constructor(n,k){let T=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,K=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,Q=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;this.index=n,this._opaqueSubMeshes=new c.g(256),this._transparentSubMeshes=new c.g(256),this._alphaTestSubMeshes=new c.g(256),this._depthOnlySubMeshes=new c.g(256),this._particleSystems=new c.g(256),this._spriteManagers=new c.g(256),this._empty=!0,this._edgesRenderers=new c.e(16),this._scene=k,this.opaqueSortCompareFn=T,this.alphaTestSortCompareFn=K,this.transparentSortCompareFn=Q}render(n,k,T,c){if(n)return void n(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);const K=this._scene.getEngine();0!==this._depthOnlySubMeshes.length&&(K.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),K.setColorWrite(!0)),0!==this._opaqueSubMeshes.length&&this._renderOpaque(this._opaqueSubMeshes),0!==this._alphaTestSubMeshes.length&&this._renderAlphaTest(this._alphaTestSubMeshes);const Q=K.getStencilBuffer();if(K.setStencilBuffer(!1),k&&this._renderSprites(),T&&this._renderParticles(c),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),0!==this._transparentSubMeshes.length||this._scene.useOrderIndependentTransparency){if(K.setStencilBuffer(Q),this._scene.useOrderIndependentTransparency){const n=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);n.length&&this._renderTransparent(n)}else this._renderTransparent(this._transparentSubMeshes);K.setAlphaMode(0)}if(K.setStencilBuffer(!1),this._edgesRenderers.length){for(let n=0;n<this._edgesRenderers.length;n++)this._edgesRenderers.data[n].render();K.setAlphaMode(0)}K.setStencilBuffer(Q)}_renderOpaqueSorted(n){Q._RenderSorted(n,this._opaqueSortCompareFn,this._scene.activeCamera,!1)}_renderAlphaTestSorted(n){Q._RenderSorted(n,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)}_renderTransparentSorted(n){Q._RenderSorted(n,this._transparentSortCompareFn,this._scene.activeCamera,!0)}static _RenderSorted(n,k,T,c){let G,w=0;const E=T?T.globalPosition:Q._ZeroVector;if(c)for(;w<n.length;w++)G=n.data[w],G._alphaIndex=G.getMesh().alphaIndex,G._distanceToCamera=K.o.Distance(G.getBoundingInfo().boundingSphere.centerWorld,E);const I=n.length===n.data.length?n.data:n.data.slice(0,n.length);k&&I.sort(k);const S=I[0].getMesh().va();for(w=0;w<I.length;w++)if(G=I[w],!S._activeMeshesFrozenButKeepClipping||G.isInFrustum(S._frustumPlanes)){if(c){const n=G.Ha();if(n&&n.needDepthPrePass){const k=n.va().getEngine();k.setColorWrite(!1),k.setAlphaMode(0),G.render(!1),k.setColorWrite(!0)}}G.render(c)}}static defaultTransparentSortCompare(n,k){return n._alphaIndex>k._alphaIndex?1:n._alphaIndex<k._alphaIndex?-1:Q.backToFrontSortCompare(n,k)}static backToFrontSortCompare(n,k){return n._distanceToCamera<k._distanceToCamera?1:n._distanceToCamera>k._distanceToCamera?-1:0}static frontToBackSortCompare(n,k){return n._distanceToCamera<k._distanceToCamera?-1:n._distanceToCamera>k._distanceToCamera?1:0}static PainterSortCompare(n,k){const T=n.getMesh(),c=k.getMesh();return T.material&&c.material?T.material.uniqueId-c.material.uniqueId:T.uniqueId-c.uniqueId}prepare(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this.prepareSprites(),this._edgesRenderers.reset(),this._empty=!0}prepareSprites(){this._spriteManagers.reset()}dispose(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()}dispatch(n,k,T){void 0===k&&(k=n.getMesh()),void 0===T&&(T=n.Ha()),null!==T&&void 0!==T&&(T.needAlphaBlendingForMesh(k)?this._transparentSubMeshes.push(n):T.needAlphaTestingForMesh(k)?(T.needDepthPrePass&&this._depthOnlySubMeshes.push(n),this._alphaTestSubMeshes.push(n)):(T.needDepthPrePass&&this._depthOnlySubMeshes.push(n),this._opaqueSubMeshes.push(n)),k._renderingGroup=this,k._edgesRenderer&&k.isEnabled()&&k.isVisible&&k._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(k._edgesRenderer),this._empty=!1)}dispatchSprites(n){this._spriteManagers.push(n),this._empty=!1}dispatchParticles(n){this._particleSystems.push(n),this._empty=!1}_renderParticles(n){if(0===this._particleSystems.length)return;const k=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(let T=0;T<this._particleSystems.length;T++){const c=this._particleSystems.data[T];if(0===(k&&k.layerMask&c.layerMask))continue;const K=c.j;K.position&&n&&-1===n.indexOf(K)||this._scene._activeParticles.addCount(c.render(),!1)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}_renderSprites(){if(!this._scene.spritesEnabled||0===this._spriteManagers.length)return;const n=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(let k=0;k<this._spriteManagers.length;k++){const T=this._spriteManagers.data[k];0!==(n&&n.layerMask&T.layerMask)&&T.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}}Q._ZeroVector=K.o.Zero();class G{}class w{get maintainStateBetweenFrames(){return this._maintainStateBetweenFrames}set maintainStateBetweenFrames(n){n!==this._maintainStateBetweenFrames&&(this._maintainStateBetweenFrames=n,this._maintainStateBetweenFrames||this.restoreDispachedFlags())}restoreDispachedFlags(){for(const n of this._scene.meshes)if(n.si)for(const k of n.si)k._wasDispatched=!1;if(this._scene.spriteManagers)for(const n of this._scene.spriteManagers)n._wasDispatched=!1;for(const n of this._scene.oi)n._wasDispatched=!1}constructor(n){this._useSceneAutoClearSetup=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new G,this._maintainStateBetweenFrames=!1,this._scene=n;for(let k=w.MIN_RENDERINGGROUPS;k<w.MAX_RENDERINGGROUPS;k++)this._autoClearDepthStencil[k]={vl:!0,depth:!0,stencil:!0}}getRenderingGroup(n){const k=n||0;return this._prepareRenderingGroup(k),this._renderingGroups[k]}_clearDepthStencilBuffer(){let n=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],k=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,!1,n,k),this._depthStencilBufferAlreadyCleaned=!0)}render(n,k,T,c){const K=this._renderingGroupInfo;if(K.me=this._scene,K.camera=this._scene.activeCamera,K.renderingManager=this,this._scene.spriteManagers&&c)for(let Q=0;Q<this._scene.spriteManagers.length;Q++){const n=this._scene.spriteManagers[Q];this.dispatchSprites(n)}for(let Q=w.MIN_RENDERINGGROUPS;Q<w.MAX_RENDERINGGROUPS;Q++){this._depthStencilBufferAlreadyCleaned=Q===w.MIN_RENDERINGGROUPS;const G=this._renderingGroups[Q];if(!G||G._empty)continue;const E=1<<Q;if(K.renderingGroupId=Q,this._scene.onBeforeRenderingGroupObservable.notifyObservers(K,E),w.AUTOCLEAR){const n=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(Q):this._autoClearDepthStencil[Q];n&&n.vl&&this._clearDepthStencilBuffer(n.depth,n.stencil)}for(const n of this._scene._beforeRenderingGroupDrawStage)n.action(Q);G.render(n,c,T,k);for(const n of this._scene._afterRenderingGroupDrawStage)n.action(Q);this._scene.onAfterRenderingGroupObservable.notifyObservers(K,E)}}reset(){if(!this.maintainStateBetweenFrames)for(let n=w.MIN_RENDERINGGROUPS;n<w.MAX_RENDERINGGROUPS;n++){const k=this._renderingGroups[n];k&&k.prepare()}}resetSprites(){if(!this.maintainStateBetweenFrames)for(let n=w.MIN_RENDERINGGROUPS;n<w.MAX_RENDERINGGROUPS;n++){const k=this._renderingGroups[n];k&&k.prepareSprites()}}dispose(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null}freeRenderingGroups(){for(let n=w.MIN_RENDERINGGROUPS;n<w.MAX_RENDERINGGROUPS;n++){const k=this._renderingGroups[n];k&&k.dispose()}}_prepareRenderingGroup(n){void 0===this._renderingGroups[n]&&(this._renderingGroups[n]=new Q(n,this._scene,this._customOpaqueSortCompareFn[n],this._customAlphaTestSortCompareFn[n],this._customTransparentSortCompareFn[n]))}dispatchSprites(n){this.maintainStateBetweenFrames&&n._wasDispatched||(n._wasDispatched=!0,this.getRenderingGroup(n.renderingGroupId).dispatchSprites(n))}dispatchParticles(n){this.maintainStateBetweenFrames&&n._wasDispatched||(n._wasDispatched=!0,this.getRenderingGroup(n.renderingGroupId).dispatchParticles(n))}dispatch(n,k,T){void 0===k&&(k=n.getMesh()),this.maintainStateBetweenFrames&&n._wasDispatched||(n._wasDispatched=!0,this.getRenderingGroup(k.renderingGroupId).dispatch(n,k,T))}setRenderingOrder(n){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,T=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(this._customOpaqueSortCompareFn[n]=k,this._customAlphaTestSortCompareFn[n]=T,this._customTransparentSortCompareFn[n]=c,this._renderingGroups[n]){const k=this._renderingGroups[n];k.opaqueSortCompareFn=this._customOpaqueSortCompareFn[n],k.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[n],k.transparentSortCompareFn=this._customTransparentSortCompareFn[n]}}setRenderingAutoClearDepthStencil(n,k){let T=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],c=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];this._autoClearDepthStencil[n]={vl:k,depth:T,stencil:c}}getAutoClearDepthStencilSetup(n){return this._autoClearDepthStencil[n]}}w.MAX_RENDERINGGROUPS=4,w.MIN_RENDERINGGROUPS=0,w.AUTOCLEAR=!0},2383:(n,k,T)=>{T.r(k),T.d(k,{postprocessVertexShader:()=>G});var c=T(624);const K="postprocessVertexShader",Q="attribute vec2 position;uniform vec2 scale;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=(position*madd+madd)*scale;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";c.b.ShadersStore[K]||(c.b.ShadersStore[K]=Q);const G={name:K,shader:Q}}}]);