"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[22],{12179:(a,x,Q)=>{Q.d(x,{b:()=>s});class s{get underlyingResource(){return this._webGLTexture}constructor(){let a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,x=arguments.length>1?arguments[1]:void 0;if(this._MSAARenderBuffers=null,this._context=x,!a&&(a=x.createTexture(),!a))throw new Error("Unable to create webGL texture");this.set(a)}setUsage(){}set(a){this._webGLTexture=a}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(a){this._MSAARenderBuffers||(this._MSAARenderBuffers=[]),this._MSAARenderBuffers.push(a)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(const a of this._MSAARenderBuffers)this._context.deleteRenderbuffer(a);this._MSAARenderBuffers=null}}getMSAARenderBuffer(){var a;let x=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return(null===(a=this._MSAARenderBuffers)||void 0===a?void 0:a[x])??null}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}},12158:(a,x,Q)=>{Q.r(x),Q.d(x,{ThinEngine:()=>y});var s=Q(587),h=Q(12167),D=Q(507),N=Q(499);class C{constructor(){this.shaderLanguage=0}postProcessor(a,x,Q,s,h){if(h.drawBuffersExtensionDisabled){const x=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;a=a.replace(x,"")}return a}}const R=/(flat\s)?\s*varying\s*.*/;class U{constructor(){this.shaderLanguage=0}attributeProcessor(a){return a.replace("attribute","in")}varyingCheck(a,x){return R.test(a)}varyingProcessor(a,x){return a.replace("varying",x?"in":"out")}postProcessor(a,x,Q){const s=-1!==a.search(/#extension.+GL_EXT_draw_buffers.+require/);if(a=(a=a.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),Q){const x=-1!==a.search(/layout *\(location *= *0\) *out/g);a=(a=(a=(a=(a=(a=(a=a.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/void\s+?main\s*\(/g,(s||x?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(")}else{if(-1!==x.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+a}return a}}var W=Q(12176),v=Q(626),e=Q(568),p=Q(12179),j=Q(594),H=Q(570),d=Q(562),i=Q(580);class Z{}class y extends e.b{get name(){return this._name}set name(a){this._name=a}get version(){return this._webGLVersion}static get ShadersRepository(){return H.c.ShadersRepository}static set ShadersRepository(a){H.c.ShadersRepository=a}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(a){this._framebufferDimensionsObject=a}snapshotRenderingReset(){this.snapshotRendering=!1}constructor(a,x,Q,h){if(Q=Q||{},super(x??Q.antialias,Q,h),this._name="WebGL",this.forcePOTTextures=!1,this.validateShaderPrograms=!1,this.disableUniformBuffers=!1,this._webGLVersion=1,this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},!a)return;let N=null;if(a.getContext){if(N=a,this._renderingCanvas=N,void 0===Q.Mk&&(Q.Mk=!1),void 0===Q.xrCompatible&&(Q.xrCompatible=!1),navigator&&navigator.userAgent){this._setupMobileChecks();const a=navigator.userAgent;for(const x of y.ExceptionList){const s=x.key,h=x.targets;if(new RegExp(s).test(a)){if(x.capture&&x.captureConstraint){const Q=x.capture,s=x.captureConstraint,h=new RegExp(Q).exec(a);if(h&&h.length>0){if(parseInt(h[h.length-1])>=s)continue}}for(const a of h)switch(a){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":Q.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1}}}}if(this._doNotHandleContextLost||(this._onContextLost=a=>{a.preventDefault(),this._contextWasLost=!0,D.d.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost((()=>this._initGLContext()))},N.addEventListener("webglcontextlost",this._onContextLost,!1),N.addEventListener("webglcontextrestored",this._onContextRestored,!1),Q.powerPreference=Q.powerPreference||"high-performance"),this._badDesktopOS&&(Q.xrCompatible=!1),!Q.disableWebGL2Support)try{this._gl=N.getContext("webgl2",Q)||N.getContext("experimental-webgl2",Q),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch(v){}if(!this._gl){if(!N)throw new Error("The provided canvas is null or undefined.");try{this._gl=N.getContext("webgl",Q)||N.getContext("experimental-webgl",Q)}catch(v){throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=a,this._renderingCanvas=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const x=this._gl.getContextAttributes();x&&(Q.stencil=x.stencil)}this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),void 0!==Q.useHighPrecisionFloats&&(this._highPrecisionShadersAllowed=Q.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let s=0;s<this._caps.maxVertexAttribs;s++)this._currentBufferPointers[s]=new Z;this._shaderProcessor=this.webGLVersion>1?new U:new C;const R=`Babylon.js v${y.Version}`;D.d.Log(R+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",R);const W=(0,s.C)(this._gl);W.validateShaderPrograms=this.validateShaderPrograms,W.parallelShaderCompile=this._caps.parallelShaderCompile}_clearEmptyResources(){this._dummyFramebuffer=null,super._clearEmptyResources()}_getShaderProcessingContext(a){return null}areAllEffectsReady(){for(const a in this._compiledEffects){if(!this._compiledEffects[a].isReady())return!1}return!0}_initGLContext(){this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||null!==this._gl.getExtension("OES_standard_derivatives"),maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||null!==this._gl.getExtension("OES_element_index_uint"),fragmentDepthSupported:this._webGLVersion>1||null!==this._gl.getExtension("EXT_frag_depth"),highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,colorBufferHalfFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_half_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:1!==this._webGLVersion,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1},this._caps.supportFloatTexturesResolve=this._caps.colorBufferFloat,this._caps.rg11b10ufColorRenderable=this._caps.colorBufferFloat,this._glVersion=this._gl.getParameter(this._gl.VERSION);const a=this._gl.getExtension("WEBGL_debug_renderer_info");if(null!=a&&(this._glRenderer=this._gl.getParameter(a.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(a.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),36193!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=36193),34842!==this._gl.RGBA16F&&(this._gl.RGBA16F=34842),34836!==this._gl.RGBA32F&&(this._gl.RGBA32F=34836),35056!==this._gl.DEPTH24_STENCIL8&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(1===this._webGLVersion&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=(this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)??0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!(!this._caps.textureFloat||!this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!(!this._caps.textureFloat||!this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&5131!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=null!==this._maxMSAASamplesOverride?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES),this._caps.maxDrawBuffers=this._gl.getParameter(this._gl.MAX_DRAW_BUFFERS);else{const a=this._gl.getExtension("WEBGL_draw_buffers");if(null!==a){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=a.drawBuffersWEBGL.bind(a),this._caps.maxDrawBuffers=this._gl.getParameter(a.MAX_DRAW_BUFFERS_WEBGL),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let x=0;x<16;x++)this._gl["COLOR_ATTACHMENT"+x+"_WEBGL"]=a["COLOR_ATTACHMENT"+x+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{const a=this._gl.getExtension("WEBGL_depth_texture");null!=a&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=a.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{const a=this._gl.getExtension("OES_vertex_array_object");null!=a&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=a.createVertexArrayOES.bind(a),this._gl.bindVertexArray=a.bindVertexArrayOES.bind(a),this._gl.deleteVertexArray=a.deleteVertexArrayOES.bind(a))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{const a=this._gl.getExtension("ANGLE_instanced_arrays");null!=a?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=a.drawArraysInstancedANGLE.bind(a),this._gl.drawElementsInstanced=a.drawElementsInstancedANGLE.bind(a),this._gl.vertexAttribDivisor=a.vertexAttribDivisorANGLE.bind(a)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){const a=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),x=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);a&&x&&(this._caps.highPrecisionShaderSupported=0!==a.precision&&0!==x.precision)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{const a=this._gl.getExtension("EXT_blend_minmax");null!=a&&(this._caps.blendMinMax=!0,this._gl.MAX=a.MAX_EXT,this._gl.MIN=a.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:WebGL2RenderingContext.SRGB,SRGB8:WebGL2RenderingContext.SRGB8,SRGB8_ALPHA8:WebGL2RenderingContext.SRGB8_ALPHA8};else{const a=this._gl.getExtension("EXT_sRGB");null!=a&&(this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:a.SRGB_EXT,SRGB8:a.SRGB_ALPHA_EXT,SRGB8_ALPHA8:a.SRGB_ALPHA_EXT})}if(this._creationOptions){const a=this._creationOptions.forceSRGBBufferSupportState;void 0!==a&&(this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&a)}}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let x=0;x<this._maxSimultaneousTextures;x++)this._nextFreeTextureSlots.push(x);"Mali-G72"===this._glRenderer&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:"undefined"===typeof HTMLImageElement,supportRenderAndCopyToLodForFloatTextures:1!==this._webGLVersion,supportDepthStencilTexture:1!==this._webGLVersion,supportShadowSamplers:1!==this._webGLVersion,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:1!==this._webGLVersion,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:1!==this._webGLVersion,basisNeedsPOT:1===this._webGLVersion,support3DTextures:1!==this._webGLVersion,needTypeSuffixInShaderConstants:1!==this._webGLVersion,supportMSAA:1!==this._webGLVersion,supportSSAO2:1!==this._webGLVersion,supportIBLShadows:1!==this._webGLVersion,supportExtendedTextureFormats:1!==this._webGLVersion,supportSwitchCaseInShader:1!==this._webGLVersion,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,forceVertexBufferStrideAndOffsetMultiple4Bytes:!1,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const a=this._workingCanvas.getContext("2d");a&&(this._workingContext=a)}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}extractDriverInfo(){const a=this.getGlInfo();return a&&a.renderer?a.renderer:""}getRenderWidth(){return!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(){return!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}clear(a,x,Q){let s=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const h=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=h;let D=0;if(x&&a){let x=!0;if(this._currentRenderTarget){var N;const Q=null===(N=this._currentRenderTarget.texture)||void 0===N?void 0:N.format;if(8===Q||9===Q||10===Q||11===Q){var C;const Q=null===(C=this._currentRenderTarget.texture)||void 0===C?void 0:C.type;7===Q||5===Q?(y._TempClearColorUint32[0]=255*a.r,y._TempClearColorUint32[1]=255*a.g,y._TempClearColorUint32[2]=255*a.b,y._TempClearColorUint32[3]=255*a.a,this._gl.clearBufferuiv(this._gl.COLOR,0,y._TempClearColorUint32),x=!1):(y._TempClearColorInt32[0]=255*a.r,y._TempClearColorInt32[1]=255*a.g,y._TempClearColorInt32[2]=255*a.b,y._TempClearColorInt32[3]=255*a.a,this._gl.clearBufferiv(this._gl.COLOR,0,y._TempClearColorInt32),x=!1)}}x&&(this._gl.clearColor(a.r,a.g,a.b,void 0!==a.a?a.a:1),D|=this._gl.COLOR_BUFFER_BIT)}Q&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),D|=this._gl.DEPTH_BUFFER_BIT),s&&(this._gl.clearStencil(0),D|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(D)}_viewport(a,x,Q,s){a===this._viewportCached.x&&x===this._viewportCached.y&&Q===this._viewportCached.z&&s===this._viewportCached.w||(this._viewportCached.x=a,this._viewportCached.y=x,this._viewportCached.z=Q,this._viewportCached.w=s,this._gl.viewport(a,x,Q,s))}Ei(){super.Ei(),this._badOS&&this.flushFramebuffer()}get performanceMonitor(){throw new Error("Not Supported by ThinEngine")}bindFramebuffer(a){let x=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,Q=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0,h=arguments.length>4?arguments[4]:void 0,N=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,C=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;const R=a;this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=a,this._bindUnboundFramebuffer(R._framebuffer);const U=this._gl;var W;if(!a.isMulti)if(a.is2DArray||a.is3D)U.framebufferTextureLayer(U.FRAMEBUFFER,U.COLOR_ATTACHMENT0,null===(W=a.texture._hardwareTexture)||void 0===W?void 0:W.underlyingResource,N,C),R._currentLOD=N;else if(a.isCube){var v;U.framebufferTexture2D(U.FRAMEBUFFER,U.COLOR_ATTACHMENT0,U.TEXTURE_CUBE_MAP_POSITIVE_X+x,null===(v=a.texture._hardwareTexture)||void 0===v?void 0:v.underlyingResource,N)}else if(R._currentLOD!==N){var e;U.framebufferTexture2D(U.FRAMEBUFFER,U.COLOR_ATTACHMENT0,U.TEXTURE_2D,null===(e=a.texture._hardwareTexture)||void 0===e?void 0:e.underlyingResource,N),R._currentLOD=N}const p=a._depthStencilTexture;if(p){a.is3D&&(a.texture.width===p.width&&a.texture.height===p.height&&a.texture.depth===p.depth||D.d.Warn("Depth/Stencil attachment for 3D target must have same dimensions as color attachment"));const Q=a._depthStencilTextureWithStencil?U.DEPTH_STENCIL_ATTACHMENT:U.DEPTH_ATTACHMENT;var j;if(a.is2DArray||a.is3D)U.framebufferTextureLayer(U.FRAMEBUFFER,Q,null===(j=p._hardwareTexture)||void 0===j?void 0:j.underlyingResource,N,C);else if(a.isCube){var H;U.framebufferTexture2D(U.FRAMEBUFFER,Q,U.TEXTURE_CUBE_MAP_POSITIVE_X+x,null===(H=p._hardwareTexture)||void 0===H?void 0:H.underlyingResource,N)}else{var d;U.framebufferTexture2D(U.FRAMEBUFFER,Q,U.TEXTURE_2D,null===(d=p._hardwareTexture)||void 0===d?void 0:d.underlyingResource,N)}}R._MSAAFramebuffer&&this._bindUnboundFramebuffer(R._MSAAFramebuffer),this._cachedViewport&&!h?this.setViewport(this._cachedViewport,Q,s):(Q||(Q=a.width,N&&(Q/=Math.pow(2,N))),s||(s=a.height,N&&(s/=Math.pow(2,N))),this._viewport(0,0,Q,s)),this.wipeCaches()}setState(a){let x=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,Q=arguments.length>2?arguments[2]:void 0,s=arguments.length>3&&void 0!==arguments[3]&&arguments[3],h=arguments.length>4?arguments[4]:void 0,D=arguments.length>5?arguments[5]:void 0,N=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;(this._depthCullingState.cull!==a||Q)&&(this._depthCullingState.cull=a);const C=this.cullBackFaces??h??1?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==C||Q)&&(this._depthCullingState.cullFace=C),this.setZOffset(x),this.setZOffsetUnits(N);const R=s?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==R||Q)&&(this._depthCullingState.frontFace=R),this._stencilStateComposer.stencilMaterial=D}_bindUnboundFramebuffer(a){this._currentFramebuffer!==a&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,a),this._currentFramebuffer=a)}_currentFrameBufferIsDefaultFrameBuffer(){return null===this._currentFramebuffer}generateMipmaps(a){const x=this._getTextureTarget(a);this._bindTextureDirectly(x,a,!0),this._gl.generateMipmap(x),this._bindTextureDirectly(x,null)}unBindFramebuffer(a){var x;let Q=arguments.length>1&&void 0!==arguments[1]&&arguments[1],s=arguments.length>2?arguments[2]:void 0;const h=a;this._currentRenderTarget=null;const D=this._gl;if(h._MSAAFramebuffer){if(a.isMulti)return void this.unBindMultiColorAttachmentFramebuffer(a,Q,s);D.bindFramebuffer(D.READ_FRAMEBUFFER,h._MSAAFramebuffer),D.bindFramebuffer(D.DRAW_FRAMEBUFFER,h._framebuffer),D.blitFramebuffer(0,0,a.width,a.height,0,0,a.width,a.height,D.COLOR_BUFFER_BIT,D.NEAREST)}null===(x=a.texture)||void 0===x||!x.generateMipMaps||Q||a.isCube||this.generateMipmaps(a.texture),s&&(h._MSAAFramebuffer&&this._bindUnboundFramebuffer(h._framebuffer),s()),this._bindUnboundFramebuffer(null)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(a,x,Q){return this._createVertexBuffer(a,this._gl.STATIC_DRAW)}_createVertexBuffer(a,x){const Q=this._gl.createBuffer();if(!Q)throw new Error("Unable to create vertex buffer");const s=new W.b(Q);return this.bindArrayBuffer(s),"number"!==typeof a?a instanceof Array?(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(a),x),s.Uh=4*a.length):(this._gl.bufferData(this._gl.ARRAY_BUFFER,a,x),s.Uh=a.byteLength):(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Uint8Array(a),x),s.Uh=a),this._resetVertexBufferBinding(),s.references=1,s}createDynamicVertexBuffer(a,x){return this._createVertexBuffer(a,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(a,x,Q){const s=this._gl.createBuffer(),h=new W.b(s);if(!s)throw new Error("Unable to create index buffer");this.bindIndexBuffer(h);const D=this._normalizeIndexData(a);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,D,x?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),h.references=1,h.is32Bits=4===D.BYTES_PER_ELEMENT,h}_normalizeIndexData(a){if(2===a.BYTES_PER_ELEMENT)return a;if(this._caps.uintIndices){if(a instanceof Uint32Array)return a;for(let x=0;x<a.length;x++)if(a[x]>=65535)return new Uint32Array(a);return new Uint16Array(a)}return new Uint16Array(a)}bindArrayBuffer(a){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(a,this._gl.ARRAY_BUFFER)}bindUniformBlock(a,x,Q){const s=a.program,h=this._gl.getUniformBlockIndex(s,x);this._gl.uniformBlockBinding(s,h,Q)}bindIndexBuffer(a){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(a,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(a,x){(this._vaoRecordInProgress||this._currentBoundBuffer[x]!==a)&&(this._gl.bindBuffer(x,a?a.underlyingResource:null),this._currentBoundBuffer[x]=a)}updateArrayBuffer(a){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,a)}_vertexAttribPointer(a,x,Q,s,h,D,N){const C=this._currentBufferPointers[x];if(!C)return;let R=!1;C.active?(C.buffer!==a&&(C.buffer=a,R=!0),C.size!==Q&&(C.size=Q,R=!0),C.type!==s&&(C.type=s,R=!0),C.normalized!==h&&(C.normalized=h,R=!0),C.stride!==D&&(C.stride=D,R=!0),C.offset!==N&&(C.offset=N,R=!0)):(R=!0,C.active=!0,C.index=x,C.size=Q,C.type=s,C.normalized=h,C.stride=D,C.offset=N,C.buffer=a),(R||this._vaoRecordInProgress)&&(this.bindArrayBuffer(a),s===this._gl.UNSIGNED_INT||s===this._gl.INT?this._gl.vertexAttribIPointer(x,Q,s,D,N):this._gl.vertexAttribPointer(x,Q,s,h,D,N))}_bindIndexBufferWithCache(a){null!=a&&this._cachedIndexBuffer!==a&&(this._cachedIndexBuffer=a,this.bindIndexBuffer(a),this._uintIndicesCurrentlySet=a.is32Bits)}_bindVertexBuffersAttributes(a,x,Q){const s=x.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let h=0;h<s.length;h++){const D=x.getAttributeLocation(h);if(D>=0){const x=s[h];let N=null;if(Q&&(N=Q[x]),N||(N=a[x]),!N)continue;this._gl.enableVertexAttribArray(D),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[D]=!0);const C=N.getBuffer();C&&(this._vertexAttribPointer(C,D,N.getSize(),N.type,N.normalized,N.byteStride,N.byteOffset),N.getIsInstanced()&&(this._gl.vertexAttribDivisor(D,N.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(D),this._currentInstanceBuffers.push(C))))}}}recordVertexArrayObject(a,x,Q,s){const h=this._gl.createVertexArray();if(!h)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(h),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(a,Q,s),this.bindIndexBuffer(x),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),h}bindVertexArrayObject(a,x){this._cachedVertexArrayObject!==a&&(this._cachedVertexArrayObject=a,this._gl.bindVertexArray(a),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=null!=x&&x.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(a,x,Q,s,h){if(this._cachedVertexBuffers!==a||this._cachedEffectForVertexBuffers!==h){this._cachedVertexBuffers=a,this._cachedEffectForVertexBuffers=h;const x=h.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let D=0;for(let N=0;N<x;N++)if(N<Q.length){const x=h.getAttributeLocation(N);x>=0&&(this._gl.enableVertexAttribArray(x),this._vertexAttribArraysEnabled[x]=!0,this._vertexAttribPointer(a,x,Q[N],this._gl.FLOAT,!1,s,D)),D+=4*Q[N]}}this._bindIndexBufferWithCache(x)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(a,x,Q,s){this._cachedVertexBuffers===a&&this._cachedEffectForVertexBuffers===Q||(this._cachedVertexBuffers=a,this._cachedEffectForVertexBuffers=Q,this._bindVertexBuffersAttributes(a,Q,s)),this._bindIndexBufferWithCache(x)}unbindInstanceAttributes(){let a;for(let x=0,Q=this._currentInstanceLocations.length;x<Q;x++){const Q=this._currentInstanceBuffers[x];a!=Q&&Q.references&&(a=Q,this.bindArrayBuffer(Q));const s=this._currentInstanceLocations[x];this._gl.vertexAttribDivisor(s,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(a){this._gl.deleteVertexArray(a)}_releaseBuffer(a){return a.references--,0===a.references&&(this._deleteBuffer(a),!0)}_deleteBuffer(a){this._gl.deleteBuffer(a.underlyingResource)}updateAndBindInstancesBuffer(a,x,Q){if(this.bindArrayBuffer(a),x&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,x),void 0!==Q[0].index)this.bindInstancesBuffer(a,Q,!0);else for(let s=0;s<4;s++){const x=Q[s];this._vertexAttribArraysEnabled[x]||(this._gl.enableVertexAttribArray(x),this._vertexAttribArraysEnabled[x]=!0),this._vertexAttribPointer(a,x,4,this._gl.FLOAT,!1,64,16*s),this._gl.vertexAttribDivisor(x,1),this._currentInstanceLocations.push(x),this._currentInstanceBuffers.push(a)}}bindInstancesBuffer(a,x){let Q=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.bindArrayBuffer(a);let s=0;if(Q)for(let h=0;h<x.length;h++){s+=4*x[h].attributeSize}for(let h=0;h<x.length;h++){const Q=x[h];void 0===Q.index&&(Q.index=this._currentEffect.getAttributeLocationByName(Q.attributeName)),Q.index<0||(this._vertexAttribArraysEnabled[Q.index]||(this._gl.enableVertexAttribArray(Q.index),this._vertexAttribArraysEnabled[Q.index]=!0),this._vertexAttribPointer(a,Q.index,Q.attributeSize,Q.attributeType||this._gl.FLOAT,Q.normalized||!1,s,Q.offset),this._gl.vertexAttribDivisor(Q.index,void 0===Q.divisor?1:Q.divisor),this._currentInstanceLocations.push(Q.index),this._currentInstanceBuffers.push(a))}}disableInstanceAttributeByName(a){if(!this._currentEffect)return;const x=this._currentEffect.getAttributeLocationByName(a);this.disableInstanceAttribute(x)}disableInstanceAttribute(a){let x,Q=!1;for(;-1!==(x=this._currentInstanceLocations.indexOf(a));)this._currentInstanceLocations.splice(x,1),this._currentInstanceBuffers.splice(x,1),Q=!0,x=this._currentInstanceLocations.indexOf(a);Q&&(this._gl.vertexAttribDivisor(a,0),this.disableAttributeByIndex(a))}disableAttributeByIndex(a){this._gl.disableVertexAttribArray(a),this._vertexAttribArraysEnabled[a]=!1,this._currentBufferPointers[a].active=!1}draw(a,x,Q,s){this.drawElementsType(a?0:1,x,Q,s)}drawPointClouds(a,x,Q){this.drawArraysType(2,a,x,Q)}drawUnIndexed(a,x,Q,s){this.drawArraysType(a?0:1,x,Q,s)}drawElementsType(a,x,Q,s){this.applyStates(),this._reportDrawCall();const h=this._drawMode(a),D=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,N=this._uintIndicesCurrentlySet?4:2;s?this._gl.drawElementsInstanced(h,Q,D,x*N,s):this._gl.drawElements(h,Q,D,x*N)}drawArraysType(a,x,Q,s){this.applyStates(),this._reportDrawCall();const h=this._drawMode(a);s?this._gl.drawArraysInstanced(h,x,Q,s):this._gl.drawArrays(h,x,Q)}_drawMode(a){switch(a){case 0:default:return this._gl.TRIANGLES;case 2:case 3:return this._gl.POINTS;case 1:case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN}}_releaseEffect(a){this._compiledEffects[a._key]&&delete this._compiledEffects[a._key];const x=a.getPipelineContext();x&&this._deletePipelineContext(x)}_deletePipelineContext(a){const x=a;x&&x.program&&(x.program.__SPECTOR_rebuildProgram=null,(0,i.i)(x),this._gl.deleteProgram(x.program))}_getGlobalDefines(a){return(0,d.k)(a,this.isNDCHalfZRange,this.useReverseDepthBuffer,this.useExactSrgbConversions)}createEffect(a,x,Q,h,D,N,C,R,U){let W=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,v=arguments.length>10?arguments[10]:void 0;const e="string"===typeof a?a:a.vertexToken||a.vertexSource||a.vertexElement||a.vertex,p="string"===typeof a?a:a.fragmentToken||a.fragmentSource||a.fragmentElement||a.fragment,j=this._getGlobalDefines();let d=D??x.defines??"";j&&(d+=j);const i=e+"+"+p+"@"+d;if(this._compiledEffects[i]){const a=this._compiledEffects[i];return C&&a.isReady()&&C(a),a._refCount++,a}this._gl&&(0,s.C)(this._gl);const Z=new H.c(a,x,Q,h,this,D,N,C,R,U,i,x.shaderLanguage??W,x.extraInitializationsAsync??v);return this._compiledEffects[i]=Z,Z}_getShaderSource(a){return this._gl.getShaderSource(a)}createRawShaderProgram(a,x,Q,h){let D=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const N=(0,s.C)(this._gl);return N._contextWasLost=this._contextWasLost,N.validateShaderPrograms=this.validateShaderPrograms,(0,s.r)(a,x,Q,h||this._gl,D)}createShaderProgram(a,x,Q,h,D){let N=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;const C=(0,s.C)(this._gl);return C._contextWasLost=this._contextWasLost,C.validateShaderPrograms=this.validateShaderPrograms,(0,s.v)(a,x,Q,h,D||this._gl,N)}inlineShaderCode(a){return a}createPipelineContext(a){if(this._gl){(0,s.C)(this._gl).parallelShaderCompile=this._caps.parallelShaderCompile}const x=(0,s.n)(this._gl,a);return x.Gi=this,x}createMaterialContext(){}createDrawContext(){}_finalizePipelineContext(a){return(0,s.e)(a,this._gl,this.validateShaderPrograms)}_preparePipelineContext(a,x,Q,h,D,N,C,R,U,W,v){const e=(0,s.C)(this._gl);return e._contextWasLost=this._contextWasLost,e.validateShaderPrograms=this.validateShaderPrograms,e._createShaderProgramInjection=this._createShaderProgram.bind(this),e.createRawShaderProgramInjection=this.createRawShaderProgram.bind(this),e.createShaderProgramInjection=this.createShaderProgram.bind(this),e.loadFileInjection=this._loadFile.bind(this),(0,s.i)(a,x,Q,h,D,N,C,R,U,W,v)}_createShaderProgram(a,x,Q,h){let D=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return(0,s.b)(a,x,Q,h,D)}_isRenderingStateCompiled(a){const x=a;return!this._isDisposed&&!x._isDisposed&&(!!this._gl.getProgramParameter(x.program,this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)&&(this._finalizePipelineContext(x),!0))}_executeWhenRenderingStateIsCompiled(a,x){(0,s.c)(a,x)}getUniforms(a,x){const Q=new Array,s=a;for(let h=0;h<x.length;h++)Q.push(this._gl.getUniformLocation(s.program,x[h]));return Q}getAttributes(a,x){const Q=[],s=a;for(let D=0;D<x.length;D++)try{Q.push(this._gl.getAttribLocation(s.program,x[D]))}catch(h){Q.push(-1)}return Q}enableEffect(a){(a=null!==a&&(0,h.b)(a)?a.effect:a)&&a!==this._currentEffect&&(this._stencilStateComposer.stencilMaterial=void 0,this.bindSamplers(a),this._currentEffect=a,a.onBind&&a.onBind(a),a._onBindObservable&&a._onBindObservable.notifyObservers(a))}setInt(a,x){return!!a&&(this._gl.uniform1i(a,x),!0)}setInt2(a,x,Q){return!!a&&(this._gl.uniform2i(a,x,Q),!0)}setInt3(a,x,Q,s){return!!a&&(this._gl.uniform3i(a,x,Q,s),!0)}setInt4(a,x,Q,s,h){return!!a&&(this._gl.uniform4i(a,x,Q,s,h),!0)}setIntArray(a,x){return!!a&&(this._gl.uniform1iv(a,x),!0)}setIntArray2(a,x){return!(!a||x.length%2!==0)&&(this._gl.uniform2iv(a,x),!0)}setIntArray3(a,x){return!(!a||x.length%3!==0)&&(this._gl.uniform3iv(a,x),!0)}setIntArray4(a,x){return!(!a||x.length%4!==0)&&(this._gl.uniform4iv(a,x),!0)}setUInt(a,x){return!!a&&(this._gl.uniform1ui(a,x),!0)}setUInt2(a,x,Q){return!!a&&(this._gl.uniform2ui(a,x,Q),!0)}setUInt3(a,x,Q,s){return!!a&&(this._gl.uniform3ui(a,x,Q,s),!0)}setUInt4(a,x,Q,s,h){return!!a&&(this._gl.uniform4ui(a,x,Q,s,h),!0)}setUIntArray(a,x){return!!a&&(this._gl.uniform1uiv(a,x),!0)}setUIntArray2(a,x){return!(!a||x.length%2!==0)&&(this._gl.uniform2uiv(a,x),!0)}setUIntArray3(a,x){return!(!a||x.length%3!==0)&&(this._gl.uniform3uiv(a,x),!0)}setUIntArray4(a,x){return!(!a||x.length%4!==0)&&(this._gl.uniform4uiv(a,x),!0)}setArray(a,x){return!!a&&(!(x.length<1)&&(this._gl.uniform1fv(a,x),!0))}setArray2(a,x){return!(!a||x.length%2!==0)&&(this._gl.uniform2fv(a,x),!0)}setArray3(a,x){return!(!a||x.length%3!==0)&&(this._gl.uniform3fv(a,x),!0)}setArray4(a,x){return!(!a||x.length%4!==0)&&(this._gl.uniform4fv(a,x),!0)}setMatrices(a,x){return!!a&&(this._gl.uniformMatrix4fv(a,!1,x),!0)}setMatrix3x3(a,x){return!!a&&(this._gl.uniformMatrix3fv(a,!1,x),!0)}setMatrix2x2(a,x){return!!a&&(this._gl.uniformMatrix2fv(a,!1,x),!0)}setFloat(a,x){return!!a&&(this._gl.uniform1f(a,x),!0)}setFloat2(a,x,Q){return!!a&&(this._gl.uniform2f(a,x,Q),!0)}setFloat3(a,x,Q,s){return!!a&&(this._gl.uniform3f(a,x,Q,s),!0)}setFloat4(a,x,Q,s,h){return!!a&&(this._gl.uniform4f(a,x,Q,s,h),!0)}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;const a=this._colorWrite;this._gl.colorMask(a,a,a,a)}}wipeCaches(a){this.preventCacheWipeBetweenFrames&&!a||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),a&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(a,x){const Q=this._gl;let s=Q.NEAREST,h=Q.NEAREST;switch(a){case 11:s=Q.LINEAR,h=x?Q.LINEAR_MIPMAP_NEAREST:Q.LINEAR;break;case 3:s=Q.LINEAR,h=x?Q.LINEAR_MIPMAP_LINEAR:Q.LINEAR;break;case 8:s=Q.NEAREST,h=x?Q.NEAREST_MIPMAP_LINEAR:Q.NEAREST;break;case 4:s=Q.NEAREST,h=x?Q.NEAREST_MIPMAP_NEAREST:Q.NEAREST;break;case 5:s=Q.NEAREST,h=x?Q.LINEAR_MIPMAP_NEAREST:Q.LINEAR;break;case 6:s=Q.NEAREST,h=x?Q.LINEAR_MIPMAP_LINEAR:Q.LINEAR;break;case 7:s=Q.NEAREST,h=Q.LINEAR;break;case 1:s=Q.NEAREST,h=Q.NEAREST;break;case 9:s=Q.LINEAR,h=x?Q.NEAREST_MIPMAP_NEAREST:Q.NEAREST;break;case 10:s=Q.LINEAR,h=x?Q.NEAREST_MIPMAP_LINEAR:Q.NEAREST;break;case 2:s=Q.LINEAR,h=Q.LINEAR;break;case 12:s=Q.LINEAR,h=Q.NEAREST}return{min:h,mag:s}}_createTexture(){const a=this._gl.createTexture();if(!a)throw new Error("Unable to create texture");return a}_createHardwareTexture(){return new p.b(this._createTexture(),this._gl)}_createInternalTexture(a,x){let Q,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,h=!1,N=0,C=3,R=5,U=!1,W=1;void 0!==x&&"object"===typeof x?(h=!!x.generateMipMaps,N=void 0===x.type?0:x.type,C=void 0===x.samplingMode?3:x.samplingMode,R=void 0===x.format?5:x.format,U=void 0!==x.useSRGBBuffer&&x.useSRGBBuffer,W=x.samples??1,Q=x.label):h=!!x,U&&(U=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(1!==N||this._caps.textureFloatLinearFiltering)&&(2!==N||this._caps.textureHalfFloatLinearFiltering)||(C=1),1!==N||this._caps.textureFloat||(N=0,D.d.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const v=this._gl,e=new j.c(this,s),p=a.width||a,H=a.height||a,d=a.depth||0,i=a.layers||0,Z=this._getSamplingParameters(C,h),y=0!==i?v.TEXTURE_2D_ARRAY:0!==d?v.TEXTURE_3D:v.TEXTURE_2D,k=this._getRGBABufferInternalSizedFormat(N,R,U),F=this._getInternalFormat(R),g=this._getWebGLTextureType(N);return this._bindTextureDirectly(y,e),0!==i?(e.is2DArray=!0,v.texImage3D(y,0,k,p,H,i,0,F,g,null)):0!==d?(e.is3D=!0,v.texImage3D(y,0,k,p,H,d,0,F,g,null)):v.texImage2D(y,0,k,p,H,0,F,g,null),v.texParameteri(y,v.TEXTURE_MAG_FILTER,Z.mag),v.texParameteri(y,v.TEXTURE_MIN_FILTER,Z.min),v.texParameteri(y,v.TEXTURE_WRAP_S,v.CLAMP_TO_EDGE),v.texParameteri(y,v.TEXTURE_WRAP_T,v.CLAMP_TO_EDGE),h&&this._gl.generateMipmap(y),this._bindTextureDirectly(y,null),e._useSRGBBuffer=U,e.baseWidth=p,e.baseHeight=H,e.width=p,e.height=H,e.depth=i,e.isReady=!0,e.samples=W,e.generateMipMaps=h,e.samplingMode=C,e.type=N,e.format=R,e.label=Q,this._internalTexturesCache.push(e),e}_getUseSRGBBuffer(a,x){return a&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||x)}createTexture(a,x,Q,s){var h=this;let D=arguments.length>4&&void 0!==arguments[4]?arguments[4]:3,N=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,C=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,R=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,U=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,W=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,v=arguments.length>10&&void 0!==arguments[10]?arguments[10]:null,e=arguments.length>11?arguments[11]:void 0,p=arguments.length>12?arguments[12]:void 0,H=arguments.length>13?arguments[13]:void 0,d=arguments.length>14?arguments[14]:void 0;return this._createTextureBase(a,x,Q,s,D,N,C,(function(){for(var a=arguments.length,x=new Array(a),Q=0;Q<a;Q++)x[Q]=arguments[Q];return h._prepareWebGLTexture(...x,W)}),((a,x,Q,h,D,N)=>{const C=this._gl,R=Q.width===a&&Q.height===x;D._creationFlags=H??0;const U=this._getTexImageParametersForCreateTexture(D.format,D._useSRGBBuffer);if(R)return C.texImage2D(C.TEXTURE_2D,0,U.internalFormat,U.format,U.type,Q),!1;const W=this._caps.maxTextureSize;if(Q.width>W||Q.height>W||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!(!this._workingCanvas||!this._workingContext)&&(this._workingCanvas.width=a,this._workingCanvas.height=x,this._workingContext.drawImage(Q,0,0,Q.width,Q.height,0,0,a,x),C.texImage2D(C.TEXTURE_2D,0,U.internalFormat,U.format,U.type,this._workingCanvas),D.width=a,D.height=x,!1);{const a=new j.c(this,2);this._bindTextureDirectly(C.TEXTURE_2D,a,!0),C.texImage2D(C.TEXTURE_2D,0,U.internalFormat,U.format,U.type,Q),this._rescaleTexture(a,D,s,U.format,(()=>{this._releaseTexture(a),this._bindTextureDirectly(C.TEXTURE_2D,D,!0),N()}))}return!0}),R,U,W,v,e,p,d)}_getTexImageParametersForCreateTexture(a,x){let Q,s;return 1===this.webGLVersion?(Q=this._getInternalFormat(a,x),s=Q):(Q=this._getInternalFormat(a,!1),s=this._getRGBABufferInternalSizedFormat(0,a,x)),{internalFormat:s,format:Q,type:this._gl.UNSIGNED_BYTE}}_rescaleTexture(a,x,Q,s,h){}_unpackFlipY(a){this._unpackFlipYCached!==a&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,a?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=a))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(a){return a.isCube?this._gl.TEXTURE_CUBE_MAP:a.is3D?this._gl.TEXTURE_3D:a.is2DArray||a.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(a,x){let Q=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const s=this._getTextureTarget(x),h=this._getSamplingParameters(a,x.useMipMaps||Q);this._setTextureParameterInteger(s,this._gl.TEXTURE_MAG_FILTER,h.mag,x),this._setTextureParameterInteger(s,this._gl.TEXTURE_MIN_FILTER,h.min),Q&&(x.generateMipMaps=!0,this._gl.generateMipmap(s)),this._bindTextureDirectly(s,null),x.samplingMode=a}updateTextureDimensions(a,x,Q){}updateTextureWrappingMode(a,x){let Q=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;const h=this._getTextureTarget(a);null!==x&&(this._setTextureParameterInteger(h,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(x),a),a._cachedWrapU=x),null!==Q&&(this._setTextureParameterInteger(h,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(Q),a),a._cachedWrapV=Q),(a.is2DArray||a.is3D)&&null!==s&&(this._setTextureParameterInteger(h,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(s),a),a._cachedWrapR=s),this._bindTextureDirectly(h,null)}_uploadCompressedDataToTextureDirectly(a,x,Q,s,h){let D=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,N=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;const C=this._gl;let R=C.TEXTURE_2D;if(a.isCube&&(R=C.TEXTURE_CUBE_MAP_POSITIVE_X+D),a._useSRGBBuffer)switch(x){case 37492:case 36196:this._caps.etc2?x=C.COMPRESSED_SRGB8_ETC2:a._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?x=C.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:a._useSRGBBuffer=!1;break;case 36492:x=C.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:x=C.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?x=C.COMPRESSED_SRGB_S3TC_DXT1_EXT:a._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?x=C.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:a._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?x=C.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:a._useSRGBBuffer=!1;break;default:a._useSRGBBuffer=!1}this._gl.compressedTexImage2D(R,N,x,Q,s,0,h)}_uploadDataToTextureDirectly(a,x){let Q=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,h=arguments.length>4?arguments[4]:void 0,D=arguments.length>5&&void 0!==arguments[5]&&arguments[5];const N=this._gl,C=this._getWebGLTextureType(a.type),R=this._getInternalFormat(a.format),U=void 0===h?this._getRGBABufferInternalSizedFormat(a.type,a.format,a._useSRGBBuffer):this._getInternalFormat(h,a._useSRGBBuffer);this._unpackFlipY(a.invertY);let W=N.TEXTURE_2D;a.isCube&&(W=N.TEXTURE_CUBE_MAP_POSITIVE_X+Q);const v=Math.round(Math.log(a.width)*Math.LOG2E),e=Math.round(Math.log(a.height)*Math.LOG2E),p=D?a.width:Math.pow(2,Math.max(v-s,0)),j=D?a.height:Math.pow(2,Math.max(e-s,0));N.texImage2D(W,s,U,p,j,0,R,C,x)}updateTextureData(a,x,Q,s,h,D){let N=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,C=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,R=arguments.length>8&&void 0!==arguments[8]&&arguments[8];const U=this._gl,W=this._getWebGLTextureType(a.type),v=this._getInternalFormat(a.format);this._unpackFlipY(a.invertY);let e=U.TEXTURE_2D,p=U.TEXTURE_2D;a.isCube&&(p=U.TEXTURE_CUBE_MAP_POSITIVE_X+N,e=U.TEXTURE_CUBE_MAP),this._bindTextureDirectly(e,a,!0),U.texSubImage2D(p,C,Q,s,h,D,v,W,x),R&&this._gl.generateMipmap(p),this._bindTextureDirectly(e,null)}_uploadArrayBufferViewToTexture(a,x){let Q=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const h=this._gl,D=a.isCube?h.TEXTURE_CUBE_MAP:h.TEXTURE_2D;this._bindTextureDirectly(D,a,!0),this._uploadDataToTextureDirectly(a,x,Q,s),this._bindTextureDirectly(D,null,!0)}_prepareWebGLTextureContinuation(a,x,Q,s,h){const D=this._gl;if(!D)return;const N=this._getSamplingParameters(h,!Q);D.texParameteri(D.TEXTURE_2D,D.TEXTURE_MAG_FILTER,N.mag),D.texParameteri(D.TEXTURE_2D,D.TEXTURE_MIN_FILTER,N.min),Q||s||D.generateMipmap(D.TEXTURE_2D),this._bindTextureDirectly(D.TEXTURE_2D,null),x&&x.removePendingData(a),a.onLoadedObservable.notifyObservers(a),a.onLoadedObservable.clear()}_prepareWebGLTexture(a,x,Q,s,h,D,N,C,R,U){const W=this.getCaps().maxTextureSize,e=Math.min(W,this.needPOTTextures?(0,v.h)(s.width,W):s.width),p=Math.min(W,this.needPOTTextures?(0,v.h)(s.height,W):s.height),j=this._gl;j&&(a._hardwareTexture?(this._bindTextureDirectly(j.TEXTURE_2D,a,!0),this._unpackFlipY(void 0===h||!!h),a.baseWidth=s.width,a.baseHeight=s.height,a.width=e,a.height=p,a.isReady=!0,a.type=-1!==a.type?a.type:0,a.format=-1!==a.format?a.format:U??(".jpg"!==x||a._useSRGBBuffer?5:4),C(e,p,s,x,a,(()=>{this._prepareWebGLTextureContinuation(a,Q,D,N,R)}))||this._prepareWebGLTextureContinuation(a,Q,D,N,R)):Q&&Q.removePendingData(a))}_getInternalFormatFromDepthTextureFormat(a,x,Q){const s=this._gl;if(!x)return s.STENCIL_INDEX8;let h=Q?s.DEPTH_STENCIL:s.DEPTH_COMPONENT;return this.webGLVersion>1?15===a?h=s.DEPTH_COMPONENT16:16===a?h=s.DEPTH_COMPONENT24:17===a||13===a?h=Q?s.DEPTH24_STENCIL8:s.DEPTH_COMPONENT24:14===a?h=s.DEPTH_COMPONENT32F:18===a&&(h=Q?s.DEPTH32F_STENCIL8:s.DEPTH_COMPONENT32F):h=s.DEPTH_COMPONENT16,h}_setupFramebufferDepthAttachments(a,x,Q,s){let h=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,D=arguments.length>5?arguments[5]:void 0;const N=this._gl;D=D??(a?13:14);const C=this._getInternalFormatFromDepthTextureFormat(D,x,a);return a&&x?this._createRenderBuffer(Q,s,h,N.DEPTH_STENCIL,C,N.DEPTH_STENCIL_ATTACHMENT):x?this._createRenderBuffer(Q,s,h,C,C,N.DEPTH_ATTACHMENT):a?this._createRenderBuffer(Q,s,h,C,C,N.STENCIL_ATTACHMENT):null}_createRenderBuffer(a,x,Q,s,h,D){let N=!(arguments.length>6&&void 0!==arguments[6])||arguments[6];const C=this._gl.createRenderbuffer();return this._updateRenderBuffer(C,a,x,Q,s,h,D,N)}_updateRenderBuffer(a,x,Q,s,h,D,N){let C=!(arguments.length>7&&void 0!==arguments[7])||arguments[7];const R=this._gl;return R.bindRenderbuffer(R.RENDERBUFFER,a),s>1&&R.renderbufferStorageMultisample?R.renderbufferStorageMultisample(R.RENDERBUFFER,s,D,x,Q):R.renderbufferStorage(R.RENDERBUFFER,h,x,Q),R.framebufferRenderbuffer(R.FRAMEBUFFER,N,R.RENDERBUFFER,a),C&&R.bindRenderbuffer(R.RENDERBUFFER,null),a}_releaseTexture(a){this._deleteTexture(a._hardwareTexture),this.unbindAllTextures();const x=this._internalTexturesCache.indexOf(a);-1!==x&&this._internalTexturesCache.splice(x,1),a._lodTextureHigh&&a._lodTextureHigh.dispose(),a._lodTextureMid&&a._lodTextureMid.dispose(),a._lodTextureLow&&a._lodTextureLow.dispose(),a._irradianceTexture&&a._irradianceTexture.dispose()}_deleteTexture(a){null===a||void 0===a||a.release()}_setProgram(a){this._currentProgram!==a&&((0,s.m)(a,this._gl),this._currentProgram=a)}bindSamplers(a){const x=a.getPipelineContext();this._setProgram(x.program);const Q=a.getSamplers();for(let s=0;s<Q.length;s++){const x=a.getUniform(Q[s]);x&&(this._boundUniforms[s]=x)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(a,x){let Q=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=arguments.length>3&&void 0!==arguments[3]&&arguments[3],h=!1;const N=x&&x._associatedChannel>-1;Q&&N&&(this._activeChannel=x._associatedChannel);if(this._boundTexturesCache[this._activeChannel]!==x||s){if(this._activateCurrentTexture(),x&&x.isMultiview)throw D.d.Error(["_bindTextureDirectly called with a multiview texture!",a,x]),"_bindTextureDirectly called with a multiview texture!";var C;this._gl.bindTexture(a,(null===x||void 0===x||null===(C=x._hardwareTexture)||void 0===C?void 0:C.underlyingResource)??null),this._boundTexturesCache[this._activeChannel]=x,x&&(x._associatedChannel=this._activeChannel)}else Q&&(h=!0,this._activateCurrentTexture());return N&&!Q&&this._bindSamplerUniformToChannel(x._associatedChannel,this._activeChannel),h}_bindTexture(a,x,Q){if(void 0===a)return;x&&(x._associatedChannel=a),this._activeChannel=a;const s=x?this._getTextureTarget(x):this._gl.TEXTURE_2D;this._bindTextureDirectly(s,x)}unbindAllTextures(){for(let a=0;a<this._maxSimultaneousTextures;a++)this._activeChannel=a,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(a,x,Q,s){void 0!==a&&(x&&(this._boundUniforms[a]=x),this._setTexture(a,Q))}_bindSamplerUniformToChannel(a,x){const Q=this._boundUniforms[a];Q&&Q._currentState!==x&&(this._gl.uniform1i(Q,x),Q._currentState=x)}_getTextureWrapMode(a){switch(a){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(a,x){let Q,s=arguments.length>2&&void 0!==arguments[2]&&arguments[2],h=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!x)return null!=this._boundTexturesCache[a]&&(this._activeChannel=a,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(x.video){this._activeChannel=a;const Q=x.getInternalTexture();Q&&(Q._associatedChannel=a),x.update()}else if(4===x.delayLoadState)return x.delayLoad(),!1;Q=h?x.depthStencilTexture:x.isReady()?x.getInternalTexture():x.isCube?this.emptyCubeTexture:x.is3D?this.emptyTexture3D:x.is2DArray?this.emptyTexture2DArray:this.emptyTexture,!s&&Q&&(Q._associatedChannel=a);let D=!0;this._boundTexturesCache[a]===Q&&(s||this._bindSamplerUniformToChannel(Q._associatedChannel,a),D=!1),this._activeChannel=a;const N=this._getTextureTarget(Q);if(D&&this._bindTextureDirectly(N,Q,s),Q&&!Q.isMultiview){if(Q.isCube&&Q._cachedCoordinatesMode!==x.coordinatesMode){Q._cachedCoordinatesMode=x.coordinatesMode;const a=3!==x.coordinatesMode&&5!==x.coordinatesMode?1:0;x.wrapU=a,x.wrapV=a}Q._cachedWrapU!==x.wrapU&&(Q._cachedWrapU=x.wrapU,this._setTextureParameterInteger(N,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(x.wrapU),Q)),Q._cachedWrapV!==x.wrapV&&(Q._cachedWrapV=x.wrapV,this._setTextureParameterInteger(N,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(x.wrapV),Q)),Q.is3D&&Q._cachedWrapR!==x.wrapR&&(Q._cachedWrapR=x.wrapR,this._setTextureParameterInteger(N,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(x.wrapR),Q)),this._setAnisotropicLevel(N,Q,x.anisotropicFilteringLevel)}return!0}setTextureArray(a,x,Q,s){if(void 0!==a&&x){this._textureUnits&&this._textureUnits.length===Q.length||(this._textureUnits=new Int32Array(Q.length));for(let x=0;x<Q.length;x++){const s=Q[x].getInternalTexture();s?(this._textureUnits[x]=a+x,s._associatedChannel=a+x):this._textureUnits[x]=-1}this._gl.uniform1iv(x,this._textureUnits);for(let a=0;a<Q.length;a++)this._setTexture(this._textureUnits[a],Q[a],!0)}}_setAnisotropicLevel(a,x,Q){const s=this._caps.textureAnisotropicFilterExtension;11!==x.samplingMode&&3!==x.samplingMode&&2!==x.samplingMode&&(Q=1),s&&x._cachedAnisotropicFilteringLevel!==Q&&(this._setTextureParameterFloat(a,s.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(Q,this._caps.maxAnisotropy),x),x._cachedAnisotropicFilteringLevel=Q)}_setTextureParameterFloat(a,x,Q,s){this._bindTextureDirectly(a,s,!0,!0),this._gl.texParameterf(a,x,Q)}_setTextureParameterInteger(a,x,Q,s){s&&this._bindTextureDirectly(a,s,!0,!0),this._gl.texParameteri(a,x,Q)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let a=0;a<this._caps.maxVertexAttribs;a++)this.disableAttributeByIndex(a)}else for(let a=0,x=this._vertexAttribArraysEnabled.length;a<x;a++)a>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[a]||this.disableAttributeByIndex(a)}releaseEffects(){const a=Object.keys(this._compiledEffects);for(const x of a){this._compiledEffects[x].dispose()}this._compiledEffects={}}dispose(){var a;((0,N.j)()&&this._renderingCanvas&&(this._doNotHandleContextLost||(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored))),super.dispose(),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.unbindAllAttributes(),this._boundUniforms={},this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._currentProgram=null,this._creationOptions.loseContextOnDispose)&&(null===(a=this._gl.getExtension("WEBGL_lose_context"))||void 0===a||a.loseContext());(0,s.y)(this._gl)}attachContextLostEvent(a){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",a,!1)}attachContextRestoredEvent(a){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",a,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(a){const x=this._gl;for(;x.getError()!==x.NO_ERROR;);let Q=!0;const s=x.createTexture();x.bindTexture(x.TEXTURE_2D,s),x.texImage2D(x.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(a),1,1,0,x.RGBA,this._getWebGLTextureType(a),null),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MIN_FILTER,x.NEAREST),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MAG_FILTER,x.NEAREST);const h=x.createFramebuffer();x.bindFramebuffer(x.FRAMEBUFFER,h),x.framebufferTexture2D(x.FRAMEBUFFER,x.COLOR_ATTACHMENT0,x.TEXTURE_2D,s,0);const D=x.checkFramebufferStatus(x.FRAMEBUFFER);if(Q=Q&&D===x.FRAMEBUFFER_COMPLETE,Q=Q&&x.getError()===x.NO_ERROR,Q&&(x.clear(x.COLOR_BUFFER_BIT),Q=Q&&x.getError()===x.NO_ERROR),Q){x.bindFramebuffer(x.FRAMEBUFFER,null);const a=x.RGBA,s=x.UNSIGNED_BYTE,h=new Uint8Array(4);x.readPixels(0,0,1,1,a,s,h),Q=Q&&x.getError()===x.NO_ERROR}for(x.deleteTexture(s),x.deleteFramebuffer(h),x.bindFramebuffer(x.FRAMEBUFFER,null);!Q&&x.getError()!==x.NO_ERROR;);return Q}_getWebGLTextureType(a){if(1===this._webGLVersion){switch(a){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(a){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(a){let x=arguments.length>1&&void 0!==arguments[1]&&arguments[1],Q=x?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;switch(a){case 0:Q=this._gl.ALPHA;break;case 1:Q=this._gl.LUMINANCE;break;case 2:Q=this._gl.LUMINANCE_ALPHA;break;case 6:Q=this._gl.RED;break;case 7:Q=this._gl.RG;break;case 4:Q=x?this._glSRGBExtensionValues.SRGB:this._gl.RGB;break;case 5:Q=x?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA}if(this._webGLVersion>1)switch(a){case 8:Q=this._gl.RED_INTEGER;break;case 9:Q=this._gl.RG_INTEGER;break;case 10:Q=this._gl.RGB_INTEGER;break;case 11:Q=this._gl.RGBA_INTEGER}return Q}_getRGBABufferInternalSizedFormat(a,x){let Q=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(1===this._webGLVersion){if(void 0!==x)switch(x){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return Q?this._glSRGBExtensionValues.SRGB:this._gl.RGB}return this._gl.RGBA}switch(a){case 3:switch(x){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(x){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return Q?this._glSRGBExtensionValues.SRGB8:this._gl.RGB8;case 5:return Q?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(x){case 8:return this._gl.R16I;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;default:return this._gl.RGBA16I}case 5:switch(x){case 8:return this._gl.R16UI;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;default:return this._gl.RGBA16UI}case 6:switch(x){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;default:return this._gl.RGBA32I}case 7:switch(x){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;default:return this._gl.RGBA32UI}case 1:switch(x){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;default:return this._gl.RGBA32F}case 2:switch(x){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(x){case 5:default:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI}}return Q?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8}readPixels(a,x,Q,s){let h=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],D=!(arguments.length>5&&void 0!==arguments[5])||arguments[5];const N=h?4:3,C=h?this._gl.RGBA:this._gl.RGB,R=new Uint8Array(s*Q*N);return D&&this.flushFramebuffer(),this._gl.readPixels(a,x,Q,s,C,this._gl.UNSIGNED_BYTE,R),Promise.resolve(R)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(null!==this._HasMajorPerformanceCaveat)return!this._HasMajorPerformanceCaveat;if(null===this._IsSupported)try{const a=e.b._CreateCanvas(1,1),x=a.getContext("webgl")||a.getContext("experimental-webgl");this._IsSupported=null!=x&&!!window.WebGLRenderingContext}catch(a){this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(null===this._HasMajorPerformanceCaveat)try{const a=e.b._CreateCanvas(1,1),x=a.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||a.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!x}catch(a){this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}}y._TempClearColorUint32=new Uint32Array(4),y._TempClearColorInt32=new Int32Array(4),y.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/12\\d\\..+?Mobile",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}],y._ConcatenateShader=d.g,y._IsSupported=null,y._HasMajorPerformanceCaveat=null},12167:(a,x,Q)=>{function s(a){return void 0===a.getPipelineContext}Q.d(x,{b:()=>s})},12176:(a,x,Q)=>{Q.d(x,{b:()=>h});var s=Q(750);class h extends s.c{constructor(a){super(),this._buffer=a}get underlyingResource(){return this._buffer}}}}]);