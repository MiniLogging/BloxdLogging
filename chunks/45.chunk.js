"use strict";(self["269hv5nclphh"]=self["269hv5nclphh"]||[]).push([[45],{14053:(E,H,d)=>{d.d(H,{b:()=>w,c:()=>D,f:()=>f,j:()=>P});var n=d(12228),Z=d(12384),I=d(12406),g=d(12582),l=d(12323),r=d(12414),t=(d(12634),d(12500)),S=d(12237);d(12887),d(12614),d(12893);const M="image/png",V=2,C=[134,22,135,150,246,214,150,54];function w(E){const H=new DataView(E.buffer,E.byteOffset,E.byteLength);let d=0;for(let g=0;g<C.length;g++)if(H.getUint8(d++)!==C[g])return S.b.Error("Not a babylon environment map"),null;let n="",Z=0;for(;Z=H.getUint8(d++);)n+=String.fromCharCode(Z);let I=JSON.parse(n);return I=R(I),I.binaryDataPosition=d,I.fS&&(I.fS.lodGenerationScale=I.fS.lodGenerationScale||.8),I}function R(E){if(E.version>V)throw new Error(`Unsupported babylon environment map version "${E.version}". Latest supported version is "${V}".`);return 2===E.version?E:E={...E,version:2,imageType:M}}function Q(E,H){const d=(H=R(H)).fS;let n=Math.log2(H.width);if(n=Math.round(n)+1,d.mipmaps.length!==6*n)throw new Error(`Unsupported specular mipmaps number "${d.mipmaps.length}"`);const Z=new Array(n);for(let I=0;I<n;I++){Z[I]=new Array(6);for(let n=0;n<6;n++){const g=d.mipmaps[6*I+n];Z[I][n]=new Uint8Array(E.buffer,E.byteOffset+H.binaryDataPosition+g.position,g.length)}}return Z}function L(E,H){var d;H=R(H);const n=new Array(6),Z=null===(d=H.irradiance)||void 0===d?void 0:d.irradianceTexture;if(Z){if(6!==Z.faces.length)throw new Error(`Incorrect irradiance texture faces number "${Z.faces.length}"`);for(let d=0;d<6;d++){const I=Z.faces[d];n[d]=new Uint8Array(E.buffer,E.byteOffset+H.binaryDataPosition+I.position,I.length)}}return n}function D(E,H,d){var n;const I=(d=R(d)).fS;if(!I)return Promise.resolve([]);E._lodGenerationScale=I.lodGenerationScale;const g=[],l=Q(H,d);g.push(s(E,l,d.imageType));const r=null===(n=d.irradiance)||void 0===n?void 0:n.irradianceTexture;if(r){var t,S;const n=L(H,d);let I=null;null!==(t=d.irradiance)&&void 0!==t&&null!==(S=t.irradianceTexture)&&void 0!==S&&S.dominantDirection&&(I=Z.wH.eH(d.irradiance.irradianceTexture.dominantDirection)),g.push(i(E,n,r.size,d.imageType,I))}return Promise.all(g)}async function e(E,H,d,n,Z,I,g,l,r,t,S){return await new Promise(((M,V)=>{if(d){const d=H.createTexture(null,!0,!0,null,1,null,(E=>{V(E)}),E);null===n||void 0===n||n.onEffectCreatedObservable.addOnce((l=>{l.executeWhenCompiled((()=>{n.externalTextureSamplerBinding=!0,n.onApply=n=>{n._bindTexture("textureSampler",d),n.setFloat2("scale",1,H._features.needsInvertingBitmap&&E instanceof ImageBitmap?-1:1)},H.scenes.length&&(H.scenes[0].postProcessManager.directRender([n],t,!0,I,g),H.restoreDefaultFramebuffer(),d.dispose(),URL.revokeObjectURL(Z),M())}))}))}else{if(H._uploadImageToTexture(S,E,I,g),l){const d=r[g];d&&H._uploadImageToTexture(d._texture,E,I,0)}M()}}))}async function s(E,H){let d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:M;const n=E.getEngine();E.format=5,E.type=0,E.generateMipMaps=!0,E._cachedAnisotropicFilteringLevel=null,n.updateTextureSamplingMode(3,E),await p(E,H,!0,d),E.isReady=!0}async function i(E,H,d){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:M,Z=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const I=E.getEngine(),g=new l.d(I,5),t=new r.b(I,g);E._irradianceTexture=t,t._dominantDirection=Z,g.isCube=!0,g.format=5,g.type=0,g.generateMipMaps=!0,g._cachedAnisotropicFilteringLevel=null,g.generateMipMaps=!0,g.width=d,g.height=d,I.updateTextureSamplingMode(3,g),await p(g,[H],!1,n),I.generateMipMapsForCubemap(g),g.isReady=!0}async function p(E,H,Z){let g=arguments.length>3&&void 0!==arguments[3]?arguments[3]:M;if(!n.Tools.IsExponentOfTwo(E.width))throw new Error("Texture size must be a power of two");const S=(0,I.ILog2)(E.width)+1,V=E.getEngine();let C=!1,w=!1,R=null,Q=null,L=null;const D=V.getCaps();D.textureLOD?V._features.supportRenderAndCopyToLodForFloatTextures?D.textureHalfFloatRender&&D.textureHalfFloatLinearFiltering?(C=!0,E.type=2):D.textureFloatRender&&D.textureFloatLinearFiltering&&(C=!0,E.type=1):C=!1:(C=!1,w=Z);let s=0;if(C)V.isWebGPU?(s=1,await d.e(42).then(d.bind(d,15430))):await d.e(35).then(d.bind(d,15439)),R=new t.c("rgbdDecode","rgbdDecode",null,null,1,null,3,V,!1,void 0,E.type,void 0,null,!1,void 0,s),E._isRGBD=!1,E.invertY=!1,Q=V.createRenderTargetCubeTexture(E.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:E.type,format:5});else if(E._isRGBD=!0,E.invertY=!0,w){const H=3;L={};const d=E._lodGenerationScale,n=E._lodGenerationOffset;for(let Z=0;Z<H;Z++){const I=(S-1)*d+n,g=n+(I-n)*(1-Z/(H-1)),t=Math.round(Math.min(Math.max(g,0),I)),M=new l.d(V,2);M.isCube=!0,M.invertY=!0,M.generateMipMaps=!1,V.updateTextureSamplingMode(2,M);const C=new r.b(null);switch(C._isCube=!0,C._texture=M,L[t]=C,Z){case 0:E._lodTextureLow=C;break;case 1:E._lodTextureMid=C;break;case 2:E._lodTextureHigh=C}}}const i=[];for(let d=0;d<H.length;d++)for(let n=0;n<6;n++){const Z=H[d][n],I=new Blob([Z],{type:g}),l=URL.createObjectURL(I);let r;if(V._features.forceBitmapOverHTMLImageElement)r=V.createImageBitmap(I,{premultiplyAlpha:"none"}).then((async H=>await e(H,V,C,R,l,n,d,w,L,Q,E)));else{const H=new Image;H.src=l,r=new Promise(((Z,I)=>{H.onload=()=>{e(H,V,C,R,l,n,d,w,L,Q,E).then((()=>Z())).catch((E=>{I(E)}))},H.onerror=E=>{I(E)}}))}i.push(r)}if(await Promise.all(i),H.length<S){let d;const n=Math.pow(2,S-1-H.length),Z=n*n*4;switch(E.type){case 0:d=new Uint8Array(Z);break;case 2:d=new Uint16Array(Z);break;case 1:d=new Float32Array(Z)}for(let I=H.length;I<S;I++)for(let H=0;H<6;H++){var p;V._uploadArrayBufferViewToTexture((null===(p=Q)||void 0===p?void 0:p.texture)||E,d,H,I)}}if(Q){const H=E._irradianceTexture;E._irradianceTexture=null,V._releaseTexture(E),Q._swapAndDie(E),E._irradianceTexture=H}R&&R.dispose(),w&&(E._lodTextureHigh&&E._lodTextureHigh._texture&&(E._lodTextureHigh._texture.isReady=!0),E._lodTextureMid&&E._lodTextureMid._texture&&(E._lodTextureMid._texture.isReady=!0),E._lodTextureLow&&E._lodTextureLow._texture&&(E._lodTextureLow._texture.isReady=!0))}function f(E,H){const d=(H=R(H)).irradiance;if(!d)return;const n=new g.e;Z.wH.FromArrayToRef(d.x,0,n.x),Z.wH.FromArrayToRef(d.y,0,n.y),Z.wH.FromArrayToRef(d.z,0,n.z),Z.wH.FromArrayToRef(d.xx,0,n.xx),Z.wH.FromArrayToRef(d.yy,0,n.yy),Z.wH.FromArrayToRef(d.zz,0,n.zz),Z.wH.FromArrayToRef(d.yz,0,n.yz),Z.wH.FromArrayToRef(d.zx,0,n.zx),Z.wH.FromArrayToRef(d.xy,0,n.xy),E._sphericalPolynomial=n}function P(E,H,d,n,Z){const I=s(E.getEngine().createRawCubeTexture(null,E.width,E.format,E.type,E.generateMipMaps,E.invertY,E.samplingMode,E._compression),H).then((()=>E));return E.onRebuildCallback=E=>({proxy:I,isReady:!0,isAsync:!0}),E._source=13,E._bufferViewArrayArray=H,E._lodGenerationScale=n,E._lodGenerationOffset=Z,E._sphericalPolynomial=d,s(E,H).then((()=>(E.isReady=!0,E)))}}}]);