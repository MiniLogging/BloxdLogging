"use strict";(self.vb3rpbgyozo=self.vb3rpbgyozo||[]).push([[45],{14401:(q,I,l)=>{l.d(I,{d:()=>d,g:()=>B,i:()=>W,j:()=>e});var w=l(12564),t=l(12747),O=l(12761),c=l(12939),a=l(12687),F=l(12765),s=(l(12987),l(12847)),Z=l(12591);l(13229),l(12972),l(13237);const r="image/png",x=2,o=[134,22,135,150,246,214,150,54];function d(q){const I=new DataView(q.buffer,q.byteOffset,q.byteLength);let l=0;for(let c=0;c<o.length;c++)if(I.getUint8(l++)!==o[c])return Z.b.Error("Not a babylon environment map"),null;let w="",t=0;for(;t=I.getUint8(l++);)w+=String.fromCharCode(t);let O=JSON.parse(w);return O=T(O),O.binaryDataPosition=l,O.EZ&&(O.EZ.lodGenerationScale=O.EZ.lodGenerationScale||.8),O}function T(q){if(q.version>x)throw new Error(`Unsupported babylon environment map version "${q.version}". Latest supported version is "${x}".`);return 2===q.version?q:q={...q,version:2,imageType:r}}function V(q,I){const l=(I=T(I)).EZ;let w=Math.log2(I.width);if(w=Math.round(w)+1,l.mipmaps.length!==6*w)throw new Error(`Unsupported specular mipmaps number "${l.mipmaps.length}"`);const t=new Array(w);for(let O=0;O<w;O++){t[O]=new Array(6);for(let w=0;w<6;w++){const c=l.mipmaps[6*O+w];t[O][w]=new Uint8Array(q.buffer,q.byteOffset+I.binaryDataPosition+c.position,c.length)}}return t}function U(q,I){var l;I=T(I);const w=new Array(6),t=null===(l=I.irradiance)||void 0===l?void 0:l.irradianceTexture;if(t){if(6!==t.faces.length)throw new Error(`Incorrect irradiance texture faces number "${t.faces.length}"`);for(let l=0;l<6;l++){const O=t.faces[l];w[l]=new Uint8Array(q.buffer,q.byteOffset+I.binaryDataPosition+O.position,O.length)}}return w}function B(q,I,l){var w;const O=(l=T(l)).EZ;if(!O)return Promise.resolve([]);q._lodGenerationScale=O.lodGenerationScale;const c=[],a=V(I,l);c.push(k(q,a,l.imageType));const F=null===(w=l.irradiance)||void 0===w?void 0:w.irradianceTexture;if(F){var s,Z;const w=U(I,l);let O=null;null!==(s=l.irradiance)&&void 0!==s&&null!==(Z=s.irradianceTexture)&&void 0!==Z&&Z.dominantDirection&&(O=t.dI.vI(l.irradiance.irradianceTexture.dominantDirection)),c.push(C(q,w,F.size,l.imageType,O))}return Promise.all(c)}async function v(q,I,l,w,t,O,c,a,F,s,Z){return await new Promise(((r,x)=>{if(l){const l=I.createTexture(null,!0,!0,null,1,null,(q=>{x(q)}),q);null===w||void 0===w||w.onEffectCreatedObservable.addOnce((a=>{a.executeWhenCompiled((()=>{w.externalTextureSamplerBinding=!0,w.onApply=w=>{w._bindTexture("textureSampler",l),w.setFloat2("scale",1,I._features.needsInvertingBitmap&&q instanceof ImageBitmap?-1:1)},I.scenes.length&&(I.scenes[0].postProcessManager.directRender([w],s,!0,O,c),I.restoreDefaultFramebuffer(),l.dispose(),URL.revokeObjectURL(t),r())}))}))}else{if(I._uploadImageToTexture(Z,q,O,c),a){const l=F[c];l&&I._uploadImageToTexture(l._texture,q,O,0)}r()}}))}async function k(q,I){let l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:r;const w=q.getEngine();q.format=5,q.type=0,q.generateMipMaps=!0,q._cachedAnisotropicFilteringLevel=null,w.updateTextureSamplingMode(3,q),await R(q,I,!0,l),q.isReady=!0}async function C(q,I,l){let w=arguments.length>3&&void 0!==arguments[3]?arguments[3]:r,t=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const O=q.getEngine(),c=new a.b(O,5),s=new F.e(O,c);q._irradianceTexture=s,s._dominantDirection=t,c.isCube=!0,c.format=5,c.type=0,c.generateMipMaps=!0,c._cachedAnisotropicFilteringLevel=null,c.generateMipMaps=!0,c.width=l,c.height=l,O.updateTextureSamplingMode(3,c),await R(c,[I],!1,w),O.generateMipMapsForCubemap(c),c.isReady=!0}async function R(q,I,t){let c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:r;if(!w.Tools.IsExponentOfTwo(q.width))throw new Error("Texture size must be a power of two");const Z=(0,O.ILog2)(q.width)+1,x=q.getEngine();let o=!1,d=!1,T=null,V=null,U=null;const B=x.getCaps();B.textureLOD?x._features.supportRenderAndCopyToLodForFloatTextures?B.textureHalfFloatRender&&B.textureHalfFloatLinearFiltering?(o=!0,q.type=2):B.textureFloatRender&&B.textureFloatLinearFiltering&&(o=!0,q.type=1):o=!1:(o=!1,d=t);let k=0;if(o)x.isWebGPU?(k=1,await l.e(42).then(l.bind(l,15799))):await l.e(35).then(l.bind(l,15804)),T=new s.d("rgbdDecode","rgbdDecode",null,null,1,null,3,x,!1,void 0,q.type,void 0,null,!1,void 0,k),q._isRGBD=!1,q.invertY=!1,V=x.createRenderTargetCubeTexture(q.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:q.type,format:5});else if(q._isRGBD=!0,q.invertY=!0,d){const I=3;U={};const l=q._lodGenerationScale,w=q._lodGenerationOffset;for(let t=0;t<I;t++){const O=(Z-1)*l+w,c=w+(O-w)*(1-t/(I-1)),s=Math.round(Math.min(Math.max(c,0),O)),r=new a.b(x,2);r.isCube=!0,r.invertY=!0,r.generateMipMaps=!1,x.updateTextureSamplingMode(2,r);const o=new F.e(null);switch(o._isCube=!0,o._texture=r,U[s]=o,t){case 0:q._lodTextureLow=o;break;case 1:q._lodTextureMid=o;break;case 2:q._lodTextureHigh=o}}}const C=[];for(let l=0;l<I.length;l++)for(let w=0;w<6;w++){const t=I[l][w],O=new Blob([t],{type:c}),a=URL.createObjectURL(O);let F;if(x._features.forceBitmapOverHTMLImageElement)F=x.createImageBitmap(O,{premultiplyAlpha:"none"}).then((async I=>await v(I,x,o,T,a,w,l,d,U,V,q)));else{const I=new Image;I.src=a,F=new Promise(((t,O)=>{I.onload=()=>{v(I,x,o,T,a,w,l,d,U,V,q).then((()=>t())).catch((q=>{O(q)}))},I.onerror=q=>{O(q)}}))}C.push(F)}if(await Promise.all(C),I.length<Z){let l;const w=Math.pow(2,Z-1-I.length),t=w*w*4;switch(q.type){case 0:l=new Uint8Array(t);break;case 2:l=new Uint16Array(t);break;case 1:l=new Float32Array(t)}for(let O=I.length;O<Z;O++)for(let I=0;I<6;I++){var R;x._uploadArrayBufferViewToTexture((null===(R=V)||void 0===R?void 0:R.texture)||q,l,I,O)}}if(V){const I=q._irradianceTexture;q._irradianceTexture=null,x._releaseTexture(q),V._swapAndDie(q),q._irradianceTexture=I}T&&T.dispose(),d&&(q._lodTextureHigh&&q._lodTextureHigh._texture&&(q._lodTextureHigh._texture.isReady=!0),q._lodTextureMid&&q._lodTextureMid._texture&&(q._lodTextureMid._texture.isReady=!0),q._lodTextureLow&&q._lodTextureLow._texture&&(q._lodTextureLow._texture.isReady=!0))}function W(q,I){const l=(I=T(I)).irradiance;if(!l)return;const w=new c.e;t.dI.FromArrayToRef(l.x,0,w.x),t.dI.FromArrayToRef(l.y,0,w.y),t.dI.FromArrayToRef(l.z,0,w.z),t.dI.FromArrayToRef(l.xx,0,w.xx),t.dI.FromArrayToRef(l.yy,0,w.yy),t.dI.FromArrayToRef(l.zz,0,w.zz),t.dI.FromArrayToRef(l.yz,0,w.yz),t.dI.FromArrayToRef(l.zx,0,w.zx),t.dI.FromArrayToRef(l.xy,0,w.xy),q._sphericalPolynomial=w}function e(q,I,l,w,t){const O=k(q.getEngine().createRawCubeTexture(null,q.width,q.format,q.type,q.generateMipMaps,q.invertY,q.samplingMode,q._compression),I).then((()=>q));return q.onRebuildCallback=q=>({proxy:O,isReady:!0,isAsync:!0}),q._source=13,q._bufferViewArrayArray=I,q._lodGenerationScale=w,q._lodGenerationOffset=t,q._sphericalPolynomial=l,k(q,I).then((()=>(q.isReady=!0,q)))}}}]);