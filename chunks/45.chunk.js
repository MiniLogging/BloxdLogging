"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[45],{12780:(g,w,q)=>{q.d(w,{b:()=>L,e:()=>x,g:()=>N,h:()=>a});var R=q(10991),o=q(11180),r=q(11195),S=q(11345),i=q(11103),T=q(11204),z=(q(11395),q(11272)),t=q(11011);q(11630),q(11381),q(11644);const m="image/png",e=2,y=[134,22,135,150,246,214,150,54];function L(g){const w=new DataView(g.buffer,g.byteOffset,g.byteLength);let q=0;for(let S=0;S<y.length;S++)if(w.getUint8(q++)!==y[S])return t.d.Error("Not a babylon environment map"),null;let R="",o=0;for(;o=w.getUint8(q++);)R+=String.fromCharCode(o);let r=JSON.parse(R);return r=A(r),r.binaryDataPosition=q,r.wt&&(r.wt.lodGenerationScale=r.wt.lodGenerationScale||.8),r}function A(g){if(g.version>e)throw new Error(`Unsupported babylon environment map version "${g.version}". Latest supported version is "${e}".`);return 2===g.version?g:g={...g,version:2,imageType:m}}function l(g,w){const q=(w=A(w)).wt;let R=Math.log2(w.width);if(R=Math.round(R)+1,q.mipmaps.length!==6*R)throw new Error(`Unsupported specular mipmaps number "${q.mipmaps.length}"`);const o=new Array(R);for(let r=0;r<R;r++){o[r]=new Array(6);for(let R=0;R<6;R++){const S=q.mipmaps[6*r+R];o[r][R]=new Uint8Array(g.buffer,g.byteOffset+w.binaryDataPosition+S.position,S.length)}}return o}function J(g,w){var q;w=A(w);const R=new Array(6),o=null===(q=w.irradiance)||void 0===q?void 0:q.irradianceTexture;if(o){if(6!==o.faces.length)throw new Error(`Incorrect irradiance texture faces number "${o.faces.length}"`);for(let q=0;q<6;q++){const r=o.faces[q];R[q]=new Uint8Array(g.buffer,g.byteOffset+w.binaryDataPosition+r.position,r.length)}}return R}function x(g,w,q){var R;const r=(q=A(q)).wt;if(!r)return Promise.resolve([]);g._lodGenerationScale=r.lodGenerationScale;const S=[],i=l(w,q);S.push(d(g,i,q.imageType));const T=null===(R=q.irradiance)||void 0===R?void 0:R.irradianceTexture;if(T){var z,t;const R=J(w,q);let r=null;null!==(z=q.irradiance)&&void 0!==z&&null!==(t=z.irradianceTexture)&&void 0!==t&&t.dominantDirection&&(r=o.ew.Ri(q.irradiance.irradianceTexture.dominantDirection)),S.push(D(g,R,T.size,q.imageType,r))}return Promise.all(S)}async function G(g,w,q,R,o,r,S,i,T,z,t){return await new Promise(((m,e)=>{if(q){const q=w.createTexture(null,!0,!0,null,1,null,(g=>{e(g)}),g);null===R||void 0===R||R.onEffectCreatedObservable.addOnce((i=>{i.executeWhenCompiled((()=>{R.externalTextureSamplerBinding=!0,R.onApply=R=>{R._bindTexture("textureSampler",q),R.setFloat2("scale",1,w._features.needsInvertingBitmap&&g instanceof ImageBitmap?-1:1)},w.scenes.length&&(w.scenes[0].postProcessManager.directRender([R],z,!0,r,S),w.restoreDefaultFramebuffer(),q.dispose(),URL.revokeObjectURL(o),m())}))}))}else{if(w._uploadImageToTexture(t,g,r,S),i){const q=T[S];q&&w._uploadImageToTexture(q._texture,g,r,0)}m()}}))}async function d(g,w){let q=arguments.length>2&&void 0!==arguments[2]?arguments[2]:m;const R=g.getEngine();g.format=5,g.type=0,g.generateMipMaps=!0,g._cachedAnisotropicFilteringLevel=null,R.updateTextureSamplingMode(3,g),await U(g,w,!0,q),g.isReady=!0}async function D(g,w,q){let R=arguments.length>3&&void 0!==arguments[3]?arguments[3]:m,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const r=g.getEngine(),S=new i.d(r,5),z=new T.d(r,S);g._irradianceTexture=z,z._dominantDirection=o,S.isCube=!0,S.format=5,S.type=0,S.generateMipMaps=!0,S._cachedAnisotropicFilteringLevel=null,S.generateMipMaps=!0,S.width=q,S.height=q,r.updateTextureSamplingMode(3,S),await U(S,[w],!1,R),r.generateMipMapsForCubemap(S),S.isReady=!0}async function U(g,w,o){let S=arguments.length>3&&void 0!==arguments[3]?arguments[3]:m;if(!R.Tools.IsExponentOfTwo(g.width))throw new Error("Texture size must be a power of two");const t=(0,r.ILog2)(g.width)+1,e=g.getEngine();let y=!1,L=!1,A=null,l=null,J=null;const x=e.getCaps();x.textureLOD?e._features.supportRenderAndCopyToLodForFloatTextures?x.textureHalfFloatRender&&x.textureHalfFloatLinearFiltering?(y=!0,g.type=2):x.textureFloatRender&&x.textureFloatLinearFiltering&&(y=!0,g.type=1):y=!1:(y=!1,L=o);let d=0;if(y)e.isWebGPU?(d=1,await q.e(42).then(q.bind(q,14136))):await q.e(35).then(q.bind(q,14145)),A=new z.c("rgbdDecode","rgbdDecode",null,null,1,null,3,e,!1,void 0,g.type,void 0,null,!1,void 0,d),g._isRGBD=!1,g.invertY=!1,l=e.createRenderTargetCubeTexture(g.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:g.type,format:5});else if(g._isRGBD=!0,g.invertY=!0,L){const w=3;J={};const q=g._lodGenerationScale,R=g._lodGenerationOffset;for(let o=0;o<w;o++){const r=(t-1)*q+R,S=R+(r-R)*(1-o/(w-1)),z=Math.round(Math.min(Math.max(S,0),r)),m=new i.d(e,2);m.isCube=!0,m.invertY=!0,m.generateMipMaps=!1,e.updateTextureSamplingMode(2,m);const y=new T.d(null);switch(y._isCube=!0,y._texture=m,J[z]=y,o){case 0:g._lodTextureLow=y;break;case 1:g._lodTextureMid=y;break;case 2:g._lodTextureHigh=y}}}const D=[];for(let q=0;q<w.length;q++)for(let R=0;R<6;R++){const o=w[q][R],r=new Blob([o],{type:S}),i=URL.createObjectURL(r);let T;if(e._features.forceBitmapOverHTMLImageElement)T=e.createImageBitmap(r,{premultiplyAlpha:"none"}).then((async w=>await G(w,e,y,A,i,R,q,L,J,l,g)));else{const w=new Image;w.src=i,T=new Promise(((o,r)=>{w.onload=()=>{G(w,e,y,A,i,R,q,L,J,l,g).then((()=>o())).catch((g=>{r(g)}))},w.onerror=g=>{r(g)}}))}D.push(T)}if(await Promise.all(D),w.length<t){let q;const R=Math.pow(2,t-1-w.length),o=R*R*4;switch(g.type){case 0:q=new Uint8Array(o);break;case 2:q=new Uint16Array(o);break;case 1:q=new Float32Array(o)}for(let r=w.length;r<t;r++)for(let w=0;w<6;w++){var U;e._uploadArrayBufferViewToTexture((null===(U=l)||void 0===U?void 0:U.texture)||g,q,w,r)}}if(l){const w=g._irradianceTexture;g._irradianceTexture=null,e._releaseTexture(g),l._swapAndDie(g),g._irradianceTexture=w}A&&A.dispose(),L&&(g._lodTextureHigh&&g._lodTextureHigh._texture&&(g._lodTextureHigh._texture.isReady=!0),g._lodTextureMid&&g._lodTextureMid._texture&&(g._lodTextureMid._texture.isReady=!0),g._lodTextureLow&&g._lodTextureLow._texture&&(g._lodTextureLow._texture.isReady=!0))}function N(g,w){const q=(w=A(w)).irradiance;if(!q)return;const R=new S.h;o.ew.FromArrayToRef(q.x,0,R.x),o.ew.FromArrayToRef(q.y,0,R.y),o.ew.FromArrayToRef(q.z,0,R.z),o.ew.FromArrayToRef(q.xx,0,R.xx),o.ew.FromArrayToRef(q.yy,0,R.yy),o.ew.FromArrayToRef(q.zz,0,R.zz),o.ew.FromArrayToRef(q.yz,0,R.yz),o.ew.FromArrayToRef(q.zx,0,R.zx),o.ew.FromArrayToRef(q.xy,0,R.xy),g._sphericalPolynomial=R}function a(g,w,q,R,o){const r=d(g.getEngine().createRawCubeTexture(null,g.width,g.format,g.type,g.generateMipMaps,g.invertY,g.samplingMode,g._compression),w).then((()=>g));return g.onRebuildCallback=g=>({proxy:r,isReady:!0,isAsync:!0}),g._source=13,g._bufferViewArrayArray=w,g._lodGenerationScale=R,g._lodGenerationOffset=o,g._sphericalPolynomial=q,d(g,w).then((()=>(g.isReady=!0,g)))}}}]);