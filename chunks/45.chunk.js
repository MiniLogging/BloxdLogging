"use strict";(self["3gghkoft8x"]=self["3gghkoft8x"]||[]).push([[45],{13994:(y,S,I)=>{I.d(S,{b:()=>L,c:()=>s,g:()=>D,h:()=>o});var V=I(12128),i=I(12321),A=I(12338),B=I(12511),d=I(12265),F=I(12340),J=(I(12556),I(12421)),u=I(12151);I(12811),I(12544),I(12821);const K="image/png",G=2,p=[134,22,135,150,246,214,150,54];function L(y){const S=new DataView(y.buffer,y.byteOffset,y.byteLength);let I=0;for(let B=0;B<p.length;B++)if(S.getUint8(I++)!==p[B])return u.b.Error("Not a babylon environment map"),null;let V="",i=0;for(;i=S.getUint8(I++);)V+=String.fromCharCode(i);let A=JSON.parse(V);return A=T(A),A.binaryDataPosition=I,A.Cu&&(A.Cu.lodGenerationScale=A.Cu.lodGenerationScale||.8),A}function T(y){if(y.version>G)throw new Error(`Unsupported babylon environment map version "${y.version}". Latest supported version is "${G}".`);return 2===y.version?y:y={...y,version:2,imageType:K}}function l(y,S){const I=(S=T(S)).Cu;let V=Math.log2(S.width);if(V=Math.round(V)+1,I.mipmaps.length!==6*V)throw new Error(`Unsupported specular mipmaps number "${I.mipmaps.length}"`);const i=new Array(V);for(let A=0;A<V;A++){i[A]=new Array(6);for(let V=0;V<6;V++){const B=I.mipmaps[6*A+V];i[A][V]=new Uint8Array(y.buffer,y.byteOffset+S.binaryDataPosition+B.position,B.length)}}return i}function j(y,S){var I;S=T(S);const V=new Array(6),i=null===(I=S.irradiance)||void 0===I?void 0:I.irradianceTexture;if(i){if(6!==i.faces.length)throw new Error(`Incorrect irradiance texture faces number "${i.faces.length}"`);for(let I=0;I<6;I++){const A=i.faces[I];V[I]=new Uint8Array(y.buffer,y.byteOffset+S.binaryDataPosition+A.position,A.length)}}return V}function s(y,S,I){var V;const A=(I=T(I)).Cu;if(!A)return Promise.resolve([]);y._lodGenerationScale=A.lodGenerationScale;const B=[],d=l(S,I);B.push(f(y,d,I.imageType));const F=null===(V=I.irradiance)||void 0===V?void 0:V.irradianceTexture;if(F){var J,u;const V=j(S,I);let A=null;null!==(J=I.irradiance)&&void 0!==J&&null!==(u=J.irradianceTexture)&&void 0!==u&&u.dominantDirection&&(A=i.OS.oS(I.irradiance.irradianceTexture.dominantDirection)),B.push(my(y,V,F.size,I.imageType,A))}return Promise.all(B)}async function O(y,S,I,V,i,A,B,d,F,J,u){return await new Promise(((K,G)=>{if(I){const I=S.createTexture(null,!0,!0,null,1,null,(y=>{G(y)}),y);null===V||void 0===V||V.onEffectCreatedObservable.addOnce((d=>{d.executeWhenCompiled((()=>{V.externalTextureSamplerBinding=!0,V.onApply=V=>{V._bindTexture("textureSampler",I),V.setFloat2("scale",1,S._features.needsInvertingBitmap&&y instanceof ImageBitmap?-1:1)},S.scenes.length&&(S.scenes[0].postProcessManager.directRender([V],J,!0,A,B),S.restoreDefaultFramebuffer(),I.dispose(),URL.revokeObjectURL(i),K())}))}))}else{if(S._uploadImageToTexture(u,y,A,B),d){const I=F[B];I&&S._uploadImageToTexture(I._texture,y,A,0)}K()}}))}async function f(y,S){let I=arguments.length>2&&void 0!==arguments[2]?arguments[2]:K;const V=y.getEngine();y.format=5,y.type=0,y.generateMipMaps=!0,y._cachedAnisotropicFilteringLevel=null,V.updateTextureSamplingMode(3,y),await C(y,S,!0,I),y.isReady=!0}async function my(y,S,I){let V=arguments.length>3&&void 0!==arguments[3]?arguments[3]:K,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const A=y.getEngine(),B=new d.c(A,5),J=new F.b(A,B);y._irradianceTexture=J,J._dominantDirection=i,B.isCube=!0,B.format=5,B.type=0,B.generateMipMaps=!0,B._cachedAnisotropicFilteringLevel=null,B.generateMipMaps=!0,B.width=I,B.height=I,A.updateTextureSamplingMode(3,B),await C(B,[S],!1,V),A.generateMipMapsForCubemap(B),B.isReady=!0}async function C(y,S,i){let B=arguments.length>3&&void 0!==arguments[3]?arguments[3]:K;if(!V.Tools.IsExponentOfTwo(y.width))throw new Error("Texture size must be a power of two");const u=(0,A.ILog2)(y.width)+1,G=y.getEngine();let p=!1,L=!1,T=null,l=null,j=null;const s=G.getCaps();s.textureLOD?G._features.supportRenderAndCopyToLodForFloatTextures?s.textureHalfFloatRender&&s.textureHalfFloatLinearFiltering?(p=!0,y.type=2):s.textureFloatRender&&s.textureFloatLinearFiltering&&(p=!0,y.type=1):p=!1:(p=!1,L=i);let f=0;if(p)G.isWebGPU?(f=1,await I.e(42).then(I.bind(I,15349))):await I.e(35).then(I.bind(I,15353)),T=new J.c("rgbdDecode","rgbdDecode",null,null,1,null,3,G,!1,void 0,y.type,void 0,null,!1,void 0,f),y._isRGBD=!1,y.invertY=!1,l=G.createRenderTargetCubeTexture(y.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:y.type,format:5});else if(y._isRGBD=!0,y.invertY=!0,L){const S=3;j={};const I=y._lodGenerationScale,V=y._lodGenerationOffset;for(let i=0;i<S;i++){const A=(u-1)*I+V,B=V+(A-V)*(1-i/(S-1)),J=Math.round(Math.min(Math.max(B,0),A)),K=new d.c(G,2);K.isCube=!0,K.invertY=!0,K.generateMipMaps=!1,G.updateTextureSamplingMode(2,K);const p=new F.b(null);switch(p._isCube=!0,p._texture=K,j[J]=p,i){case 0:y._lodTextureLow=p;break;case 1:y._lodTextureMid=p;break;case 2:y._lodTextureHigh=p}}}const my=[];for(let I=0;I<S.length;I++)for(let V=0;V<6;V++){const i=S[I][V],A=new Blob([i],{type:B}),d=URL.createObjectURL(A);let F;if(G._features.forceBitmapOverHTMLImageElement)F=G.createImageBitmap(A,{premultiplyAlpha:"none"}).then((async S=>await O(S,G,p,T,d,V,I,L,j,l,y)));else{const S=new Image;S.src=d,F=new Promise(((i,A)=>{S.onload=()=>{O(S,G,p,T,d,V,I,L,j,l,y).then((()=>i())).catch((y=>{A(y)}))},S.onerror=y=>{A(y)}}))}my.push(F)}if(await Promise.all(my),S.length<u){let I;const V=Math.pow(2,u-1-S.length),i=V*V*4;switch(y.type){case 0:I=new Uint8Array(i);break;case 2:I=new Uint16Array(i);break;case 1:I=new Float32Array(i)}for(let A=S.length;A<u;A++)for(let S=0;S<6;S++){var C;G._uploadArrayBufferViewToTexture((null===(C=l)||void 0===C?void 0:C.texture)||y,I,S,A)}}if(l){const S=y._irradianceTexture;y._irradianceTexture=null,G._releaseTexture(y),l._swapAndDie(y),y._irradianceTexture=S}T&&T.dispose(),L&&(y._lodTextureHigh&&y._lodTextureHigh._texture&&(y._lodTextureHigh._texture.isReady=!0),y._lodTextureMid&&y._lodTextureMid._texture&&(y._lodTextureMid._texture.isReady=!0),y._lodTextureLow&&y._lodTextureLow._texture&&(y._lodTextureLow._texture.isReady=!0))}function D(y,S){const I=(S=T(S)).irradiance;if(!I)return;const V=new B.h;i.OS.FromArrayToRef(I.x,0,V.x),i.OS.FromArrayToRef(I.y,0,V.y),i.OS.FromArrayToRef(I.z,0,V.z),i.OS.FromArrayToRef(I.xx,0,V.xx),i.OS.FromArrayToRef(I.yy,0,V.yy),i.OS.FromArrayToRef(I.zz,0,V.zz),i.OS.FromArrayToRef(I.yz,0,V.yz),i.OS.FromArrayToRef(I.zx,0,V.zx),i.OS.FromArrayToRef(I.xy,0,V.xy),y._sphericalPolynomial=V}function o(y,S,I,V,i){const A=f(y.getEngine().createRawCubeTexture(null,y.width,y.format,y.type,y.generateMipMaps,y.invertY,y.samplingMode,y._compression),S).then((()=>y));return y.onRebuildCallback=y=>({proxy:A,isReady:!0,isAsync:!0}),y._source=13,y._bufferViewArrayArray=S,y._lodGenerationScale=V,y._lodGenerationOffset=i,y._sphericalPolynomial=I,f(y,S).then((()=>(y.isReady=!0,y)))}}}]);