"use strict";(self.c2c3ycupenc=self.c2c3ycupenc||[]).push([[45],{13347:(c,r,D)=>{D.d(r,{d:()=>v,h:()=>J,i:()=>y,j:()=>U});var W=D(11487),B=D(11683),t=D(11696),u=D(11868),a=D(11615),H=D(11705),x=(D(11924),D(11768)),M=D(11509);D(12183),D(11905),D(12191);const E="image/png",m=2,Y=[134,22,135,150,246,214,150,54];function v(c){const r=new DataView(c.buffer,c.byteOffset,c.byteLength);let D=0;for(let u=0;u<Y.length;u++)if(r.getUint8(D++)!==Y[u])return M.e.Error("Not a babylon environment map"),null;let W="",B=0;for(;B=r.getUint8(D++);)W+=String.fromCharCode(B);let t=JSON.parse(W);return t=k(t),t.binaryDataPosition=D,t.wM&&(t.wM.lodGenerationScale=t.wM.lodGenerationScale||.8),t}function k(c){if(c.version>m)throw new Error(`Unsupported babylon environment map version "${c.version}". Latest supported version is "${m}".`);return 2===c.version?c:c={...c,version:2,imageType:E}}function w(c,r){const D=(r=k(r)).wM;let W=Math.log2(r.width);if(W=Math.round(W)+1,D.mipmaps.length!==6*W)throw new Error(`Unsupported specular mipmaps number "${D.mipmaps.length}"`);const B=new Array(W);for(let t=0;t<W;t++){B[t]=new Array(6);for(let W=0;W<6;W++){const u=D.mipmaps[6*t+W];B[t][W]=new Uint8Array(c.buffer,c.byteOffset+r.binaryDataPosition+u.position,u.length)}}return B}function Z(c,r){var D;r=k(r);const W=new Array(6),B=null===(D=r.irradiance)||void 0===D?void 0:D.irradianceTexture;if(B){if(6!==B.faces.length)throw new Error(`Incorrect irradiance texture faces number "${B.faces.length}"`);for(let D=0;D<6;D++){const t=B.faces[D];W[D]=new Uint8Array(c.buffer,c.byteOffset+r.binaryDataPosition+t.position,t.length)}}return W}function J(c,r,D){var W;const t=(D=k(D)).wM;if(!t)return Promise.resolve([]);c._lodGenerationScale=t.lodGenerationScale;const u=[],a=w(r,D);u.push(j(c,a,D.imageType));const H=null===(W=D.irradiance)||void 0===W?void 0:W.irradianceTexture;if(H){var x,M;const W=Z(r,D);let t=null;null!==(x=D.irradiance)&&void 0!==x&&null!==(M=x.irradianceTexture)&&void 0!==M&&M.dominantDirection&&(t=B.Zr.er(D.irradiance.irradianceTexture.dominantDirection)),u.push(X(c,W,H.size,D.imageType,t))}return Promise.all(u)}async function q(c,r,D,W,B,t,u,a,H,x,M){return await new Promise(((E,m)=>{if(D){const D=r.createTexture(null,!0,!0,null,1,null,(c=>{m(c)}),c);null===W||void 0===W||W.onEffectCreatedObservable.addOnce((a=>{a.executeWhenCompiled((()=>{W.externalTextureSamplerBinding=!0,W.onApply=W=>{W._bindTexture("textureSampler",D),W.setFloat2("scale",1,r._features.needsInvertingBitmap&&c instanceof ImageBitmap?-1:1)},r.scenes.length&&(r.scenes[0].postProcessManager.directRender([W],x,!0,t,u),r.restoreDefaultFramebuffer(),D.dispose(),URL.revokeObjectURL(B),E())}))}))}else{if(r._uploadImageToTexture(M,c,t,u),a){const D=H[u];D&&r._uploadImageToTexture(D._texture,c,t,0)}E()}}))}async function j(c,r){let D=arguments.length>2&&void 0!==arguments[2]?arguments[2]:E;const W=c.getEngine();c.format=5,c.type=0,c.generateMipMaps=!0,c._cachedAnisotropicFilteringLevel=null,W.updateTextureSamplingMode(3,c),await e(c,r,!0,D),c.isReady=!0}async function X(c,r,D){let W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:E,B=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const t=c.getEngine(),u=new a.e(t,5),x=new H.c(t,u);c._irradianceTexture=x,x._dominantDirection=B,u.isCube=!0,u.format=5,u.type=0,u.generateMipMaps=!0,u._cachedAnisotropicFilteringLevel=null,u.generateMipMaps=!0,u.width=D,u.height=D,t.updateTextureSamplingMode(3,u),await e(u,[r],!1,W),t.generateMipMapsForCubemap(u),u.isReady=!0}async function e(c,r,B){let u=arguments.length>3&&void 0!==arguments[3]?arguments[3]:E;if(!W.Tools.IsExponentOfTwo(c.width))throw new Error("Texture size must be a power of two");const M=(0,t.ILog2)(c.width)+1,m=c.getEngine();let Y=!1,v=!1,k=null,w=null,Z=null;const J=m.getCaps();J.textureLOD?m._features.supportRenderAndCopyToLodForFloatTextures?J.textureHalfFloatRender&&J.textureHalfFloatLinearFiltering?(Y=!0,c.type=2):J.textureFloatRender&&J.textureFloatLinearFiltering&&(Y=!0,c.type=1):Y=!1:(Y=!1,v=B);let j=0;if(Y)m.isWebGPU?(j=1,await D.e(42).then(D.bind(D,14735))):await D.e(35).then(D.bind(D,14739)),k=new x.e("rgbdDecode","rgbdDecode",null,null,1,null,3,m,!1,void 0,c.type,void 0,null,!1,void 0,j),c._isRGBD=!1,c.invertY=!1,w=m.createRenderTargetCubeTexture(c.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:c.type,format:5});else if(c._isRGBD=!0,c.invertY=!0,v){const r=3;Z={};const D=c._lodGenerationScale,W=c._lodGenerationOffset;for(let B=0;B<r;B++){const t=(M-1)*D+W,u=W+(t-W)*(1-B/(r-1)),x=Math.round(Math.min(Math.max(u,0),t)),E=new a.e(m,2);E.isCube=!0,E.invertY=!0,E.generateMipMaps=!1,m.updateTextureSamplingMode(2,E);const Y=new H.c(null);switch(Y._isCube=!0,Y._texture=E,Z[x]=Y,B){case 0:c._lodTextureLow=Y;break;case 1:c._lodTextureMid=Y;break;case 2:c._lodTextureHigh=Y}}}const X=[];for(let D=0;D<r.length;D++)for(let W=0;W<6;W++){const B=r[D][W],t=new Blob([B],{type:u}),a=URL.createObjectURL(t);let H;if(m._features.forceBitmapOverHTMLImageElement)H=m.createImageBitmap(t,{premultiplyAlpha:"none"}).then((async r=>await q(r,m,Y,k,a,W,D,v,Z,w,c)));else{const r=new Image;r.src=a,H=new Promise(((B,t)=>{r.onload=()=>{q(r,m,Y,k,a,W,D,v,Z,w,c).then((()=>B())).catch((c=>{t(c)}))},r.onerror=c=>{t(c)}}))}X.push(H)}if(await Promise.all(X),r.length<M){let D;const W=Math.pow(2,M-1-r.length),B=W*W*4;switch(c.type){case 0:D=new Uint8Array(B);break;case 2:D=new Uint16Array(B);break;case 1:D=new Float32Array(B)}for(let t=r.length;t<M;t++)for(let r=0;r<6;r++){var e;m._uploadArrayBufferViewToTexture((null===(e=w)||void 0===e?void 0:e.texture)||c,D,r,t)}}if(w){const r=c._irradianceTexture;c._irradianceTexture=null,m._releaseTexture(c),w._swapAndDie(c),c._irradianceTexture=r}k&&k.dispose(),v&&(c._lodTextureHigh&&c._lodTextureHigh._texture&&(c._lodTextureHigh._texture.isReady=!0),c._lodTextureMid&&c._lodTextureMid._texture&&(c._lodTextureMid._texture.isReady=!0),c._lodTextureLow&&c._lodTextureLow._texture&&(c._lodTextureLow._texture.isReady=!0))}function y(c,r){const D=(r=k(r)).irradiance;if(!D)return;const W=new u.e;B.Zr.FromArrayToRef(D.x,0,W.x),B.Zr.FromArrayToRef(D.y,0,W.y),B.Zr.FromArrayToRef(D.z,0,W.z),B.Zr.FromArrayToRef(D.xx,0,W.xx),B.Zr.FromArrayToRef(D.yy,0,W.yy),B.Zr.FromArrayToRef(D.zz,0,W.zz),B.Zr.FromArrayToRef(D.yz,0,W.yz),B.Zr.FromArrayToRef(D.zx,0,W.zx),B.Zr.FromArrayToRef(D.xy,0,W.xy),c._sphericalPolynomial=W}function U(c,r,D,W,B){const t=j(c.getEngine().createRawCubeTexture(null,c.width,c.format,c.type,c.generateMipMaps,c.invertY,c.samplingMode,c._compression),r).then((()=>c));return c.onRebuildCallback=c=>({proxy:t,isReady:!0,isAsync:!0}),c._source=13,c._bufferViewArrayArray=r,c._lodGenerationScale=W,c._lodGenerationOffset=B,c._sphericalPolynomial=D,j(c,r).then((()=>(c.isReady=!0,c)))}}}]);