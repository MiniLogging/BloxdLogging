"use strict";(self.ksd6jhs1yr=self.ksd6jhs1yr||[]).push([[45],{14084:(C,c,d)=>{d.d(c,{c:()=>A,e:()=>t,h:()=>N,k:()=>r});var b=d(12219),X=d(12403),P=d(12418),V=d(12595),R=d(12316),p=d(12426),j=(d(12637),d(12499)),g=d(12233);d(12904),d(12622),d(12917);const k="image/png",Z=2,U=[134,22,135,150,246,214,150,54];function A(C){const c=new DataView(C.buffer,C.byteOffset,C.byteLength);let d=0;for(let V=0;V<U.length;V++)if(c.getUint8(d++)!==U[V])return g.d.Error("Not a babylon environment map"),null;let b="",X=0;for(;X=c.getUint8(d++);)b+=String.fromCharCode(X);let P=JSON.parse(b);return P=u(P),P.binaryDataPosition=d,P.Ik&&(P.Ik.lodGenerationScale=P.Ik.lodGenerationScale||.8),P}function u(C){if(C.version>Z)throw new Error(`Unsupported babylon environment map version "${C.version}". Latest supported version is "${Z}".`);return 2===C.version?C:C={...C,version:2,imageType:k}}function q(C,c){const d=(c=u(c)).Ik;let b=Math.log2(c.width);if(b=Math.round(b)+1,d.mipmaps.length!==6*b)throw new Error(`Unsupported specular mipmaps number "${d.mipmaps.length}"`);const X=new Array(b);for(let P=0;P<b;P++){X[P]=new Array(6);for(let b=0;b<6;b++){const V=d.mipmaps[6*P+b];X[P][b]=new Uint8Array(C.buffer,C.byteOffset+c.binaryDataPosition+V.position,V.length)}}return X}function B(C,c){var d;c=u(c);const b=new Array(6),X=null===(d=c.irradiance)||void 0===d?void 0:d.irradianceTexture;if(X){if(6!==X.faces.length)throw new Error(`Incorrect irradiance texture faces number "${X.faces.length}"`);for(let d=0;d<6;d++){const P=X.faces[d];b[d]=new Uint8Array(C.buffer,C.byteOffset+c.binaryDataPosition+P.position,P.length)}}return b}function t(C,c,d){var b;const P=(d=u(d)).Ik;if(!P)return Promise.resolve([]);C._lodGenerationScale=P.lodGenerationScale;const V=[],R=q(c,d);V.push(n(C,R,d.imageType));const p=null===(b=d.irradiance)||void 0===b?void 0:b.irradianceTexture;if(p){var j,g;const b=B(c,d);let P=null;null!==(j=d.irradiance)&&void 0!==j&&null!==(g=j.irradianceTexture)&&void 0!==g&&g.dominantDirection&&(P=X.dd.jd(d.irradiance.irradianceTexture.dominantDirection)),V.push(W(C,b,p.size,d.imageType,P))}return Promise.all(V)}async function e(C,c,d,b,X,P,V,R,p,j,g){return await new Promise(((k,Z)=>{if(d){const d=c.createTexture(null,!0,!0,null,1,null,(C=>{Z(C)}),C);null===b||void 0===b||b.onEffectCreatedObservable.addOnce((R=>{R.executeWhenCompiled((()=>{b.externalTextureSamplerBinding=!0,b.onApply=b=>{b._bindTexture("textureSampler",d),b.setFloat2("scale",1,c._features.needsInvertingBitmap&&C instanceof ImageBitmap?-1:1)},c.scenes.length&&(c.scenes[0].postProcessManager.directRender([b],j,!0,P,V),c.restoreDefaultFramebuffer(),d.dispose(),URL.revokeObjectURL(X),k())}))}))}else{if(c._uploadImageToTexture(g,C,P,V),R){const d=p[V];d&&c._uploadImageToTexture(d._texture,C,P,0)}k()}}))}async function n(C,c){let d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:k;const b=C.getEngine();C.format=5,C.type=0,C.generateMipMaps=!0,C._cachedAnisotropicFilteringLevel=null,b.updateTextureSamplingMode(3,C),await E(C,c,!0,d),C.isReady=!0}async function W(C,c,d){let b=arguments.length>3&&void 0!==arguments[3]?arguments[3]:k,X=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const P=C.getEngine(),V=new R.d(P,5),j=new p.e(P,V);C._irradianceTexture=j,j._dominantDirection=X,V.isCube=!0,V.format=5,V.type=0,V.generateMipMaps=!0,V._cachedAnisotropicFilteringLevel=null,V.generateMipMaps=!0,V.width=d,V.height=d,P.updateTextureSamplingMode(3,V),await E(V,[c],!1,b),P.generateMipMapsForCubemap(V),V.isReady=!0}async function E(C,c,X){let V=arguments.length>3&&void 0!==arguments[3]?arguments[3]:k;if(!b.Tools.IsExponentOfTwo(C.width))throw new Error("Texture size must be a power of two");const g=(0,P.ILog2)(C.width)+1,Z=C.getEngine();let U=!1,A=!1,u=null,q=null,B=null;const t=Z.getCaps();t.textureLOD?Z._features.supportRenderAndCopyToLodForFloatTextures?t.textureHalfFloatRender&&t.textureHalfFloatLinearFiltering?(U=!0,C.type=2):t.textureFloatRender&&t.textureFloatLinearFiltering&&(U=!0,C.type=1):U=!1:(U=!1,A=X);let n=0;if(U)Z.isWebGPU?(n=1,await d.e(42).then(d.bind(d,15438))):await d.e(35).then(d.bind(d,15441)),u=new j.d("rgbdDecode","rgbdDecode",null,null,1,null,3,Z,!1,void 0,C.type,void 0,null,!1,void 0,n),C._isRGBD=!1,C.invertY=!1,q=Z.createRenderTargetCubeTexture(C.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:C.type,format:5});else if(C._isRGBD=!0,C.invertY=!0,A){const c=3;B={};const d=C._lodGenerationScale,b=C._lodGenerationOffset;for(let X=0;X<c;X++){const P=(g-1)*d+b,V=b+(P-b)*(1-X/(c-1)),j=Math.round(Math.min(Math.max(V,0),P)),k=new R.d(Z,2);k.isCube=!0,k.invertY=!0,k.generateMipMaps=!1,Z.updateTextureSamplingMode(2,k);const U=new p.e(null);switch(U._isCube=!0,U._texture=k,B[j]=U,X){case 0:C._lodTextureLow=U;break;case 1:C._lodTextureMid=U;break;case 2:C._lodTextureHigh=U}}}const W=[];for(let d=0;d<c.length;d++)for(let b=0;b<6;b++){const X=c[d][b],P=new Blob([X],{type:V}),R=URL.createObjectURL(P);let p;if(Z._features.forceBitmapOverHTMLImageElement)p=Z.createImageBitmap(P,{premultiplyAlpha:"none"}).then((async c=>await e(c,Z,U,u,R,b,d,A,B,q,C)));else{const c=new Image;c.src=R,p=new Promise(((X,P)=>{c.onload=()=>{e(c,Z,U,u,R,b,d,A,B,q,C).then((()=>X())).catch((C=>{P(C)}))},c.onerror=C=>{P(C)}}))}W.push(p)}if(await Promise.all(W),c.length<g){let d;const b=Math.pow(2,g-1-c.length),X=b*b*4;switch(C.type){case 0:d=new Uint8Array(X);break;case 2:d=new Uint16Array(X);break;case 1:d=new Float32Array(X)}for(let P=c.length;P<g;P++)for(let c=0;c<6;c++){var E;Z._uploadArrayBufferViewToTexture((null===(E=q)||void 0===E?void 0:E.texture)||C,d,c,P)}}if(q){const c=C._irradianceTexture;C._irradianceTexture=null,Z._releaseTexture(C),q._swapAndDie(C),C._irradianceTexture=c}u&&u.dispose(),A&&(C._lodTextureHigh&&C._lodTextureHigh._texture&&(C._lodTextureHigh._texture.isReady=!0),C._lodTextureMid&&C._lodTextureMid._texture&&(C._lodTextureMid._texture.isReady=!0),C._lodTextureLow&&C._lodTextureLow._texture&&(C._lodTextureLow._texture.isReady=!0))}function N(C,c){const d=(c=u(c)).irradiance;if(!d)return;const b=new V.e;X.dd.FromArrayToRef(d.x,0,b.x),X.dd.FromArrayToRef(d.y,0,b.y),X.dd.FromArrayToRef(d.z,0,b.z),X.dd.FromArrayToRef(d.xx,0,b.xx),X.dd.FromArrayToRef(d.yy,0,b.yy),X.dd.FromArrayToRef(d.zz,0,b.zz),X.dd.FromArrayToRef(d.yz,0,b.yz),X.dd.FromArrayToRef(d.zx,0,b.zx),X.dd.FromArrayToRef(d.xy,0,b.xy),C._sphericalPolynomial=b}function r(C,c,d,b,X){const P=n(C.getEngine().createRawCubeTexture(null,C.width,C.format,C.type,C.generateMipMaps,C.invertY,C.samplingMode,C._compression),c).then((()=>C));return C.onRebuildCallback=C=>({proxy:P,isReady:!0,isAsync:!0}),C._source=13,C._bufferViewArrayArray=c,C._lodGenerationScale=b,C._lodGenerationOffset=X,C._sphericalPolynomial=d,n(C,c).then((()=>(C.isReady=!0,C)))}}}]);