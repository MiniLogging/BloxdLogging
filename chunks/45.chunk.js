"use strict";(self.v2pspxy442l=self.v2pspxy442l||[]).push([[45],{14096:(l,a,N)=>{N.d(a,{d:()=>u,g:()=>C,j:()=>b,m:()=>z});var U=N(12254),c=N(12447),K=N(12461),Z=N(12623),w=N(12373),S=N(12467),T=(N(12678),N(12536)),J=N(12268);N(12930),N(12664),N(12942);const n="image/png",y=2,H=[134,22,135,150,246,214,150,54];function u(l){const a=new DataView(l.buffer,l.byteOffset,l.byteLength);let N=0;for(let Z=0;Z<H.length;Z++)if(a.getUint8(N++)!==H[Z])return J.b.Error("Not a babylon environment map"),null;let U="",c=0;for(;c=a.getUint8(N++);)U+=String.fromCharCode(c);let K=JSON.parse(U);return K=W(K),K.binaryDataPosition=N,K.MJ&&(K.MJ.lodGenerationScale=K.MJ.lodGenerationScale||.8),K}function W(l){if(l.version>y)throw new Error(`Unsupported babylon environment map version "${l.version}". Latest supported version is "${y}".`);return 2===l.version?l:l={...l,version:2,imageType:n}}function B(l,a){const N=(a=W(a)).MJ;let U=Math.log2(a.width);if(U=Math.round(U)+1,N.mipmaps.length!==6*U)throw new Error(`Unsupported specular mipmaps number "${N.mipmaps.length}"`);const c=new Array(U);for(let K=0;K<U;K++){c[K]=new Array(6);for(let U=0;U<6;U++){const Z=N.mipmaps[6*K+U];c[K][U]=new Uint8Array(l.buffer,l.byteOffset+a.binaryDataPosition+Z.position,Z.length)}}return c}function Y(l,a){var N;a=W(a);const U=new Array(6),c=null===(N=a.irradiance)||void 0===N?void 0:N.irradianceTexture;if(c){if(6!==c.faces.length)throw new Error(`Incorrect irradiance texture faces number "${c.faces.length}"`);for(let N=0;N<6;N++){const K=c.faces[N];U[N]=new Uint8Array(l.buffer,l.byteOffset+a.binaryDataPosition+K.position,K.length)}}return U}function C(l,a,N){var U;const K=(N=W(N)).MJ;if(!K)return Promise.resolve([]);l._lodGenerationScale=K.lodGenerationScale;const Z=[],w=B(a,N);Z.push(A(l,w,N.imageType));const S=null===(U=N.irradiance)||void 0===U?void 0:U.irradianceTexture;if(S){var T,J;const U=Y(a,N);let K=null;null!==(T=N.irradiance)&&void 0!==T&&null!==(J=T.irradianceTexture)&&void 0!==J&&J.dominantDirection&&(K=c.ua.Ma(N.irradiance.irradianceTexture.dominantDirection)),Z.push(E(l,U,S.size,N.imageType,K))}return Promise.all(Z)}async function M(l,a,N,U,c,K,Z,w,S,T,J){return await new Promise(((n,y)=>{if(N){const N=a.createTexture(null,!0,!0,null,1,null,(l=>{y(l)}),l);null===U||void 0===U||U.onEffectCreatedObservable.addOnce((w=>{w.executeWhenCompiled((()=>{U.externalTextureSamplerBinding=!0,U.onApply=U=>{U._bindTexture("textureSampler",N),U.setFloat2("scale",1,a._features.needsInvertingBitmap&&l instanceof ImageBitmap?-1:1)},a.scenes.length&&(a.scenes[0].postProcessManager.directRender([U],T,!0,K,Z),a.restoreDefaultFramebuffer(),N.dispose(),URL.revokeObjectURL(c),n())}))}))}else{if(a._uploadImageToTexture(J,l,K,Z),w){const N=S[Z];N&&a._uploadImageToTexture(N._texture,l,K,0)}n()}}))}async function A(l,a){let N=arguments.length>2&&void 0!==arguments[2]?arguments[2]:n;const U=l.getEngine();l.format=5,l.type=0,l.generateMipMaps=!0,l._cachedAnisotropicFilteringLevel=null,U.updateTextureSamplingMode(3,l),await q(l,a,!0,N),l.isReady=!0}async function E(l,a,N){let U=arguments.length>3&&void 0!==arguments[3]?arguments[3]:n,c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const K=l.getEngine(),Z=new w.c(K,5),T=new S.b(K,Z);l._irradianceTexture=T,T._dominantDirection=c,Z.isCube=!0,Z.format=5,Z.type=0,Z.generateMipMaps=!0,Z._cachedAnisotropicFilteringLevel=null,Z.generateMipMaps=!0,Z.width=N,Z.height=N,K.updateTextureSamplingMode(3,Z),await q(Z,[a],!1,U),K.generateMipMapsForCubemap(Z),Z.isReady=!0}async function q(l,a,c){let Z=arguments.length>3&&void 0!==arguments[3]?arguments[3]:n;if(!U.Tools.IsExponentOfTwo(l.width))throw new Error("Texture size must be a power of two");const J=(0,K.ILog2)(l.width)+1,y=l.getEngine();let H=!1,u=!1,W=null,B=null,Y=null;const C=y.getCaps();C.textureLOD?y._features.supportRenderAndCopyToLodForFloatTextures?C.textureHalfFloatRender&&C.textureHalfFloatLinearFiltering?(H=!0,l.type=2):C.textureFloatRender&&C.textureFloatLinearFiltering&&(H=!0,l.type=1):H=!1:(H=!1,u=c);let A=0;if(H)y.isWebGPU?(A=1,await N.e(42).then(N.bind(N,15463))):await N.e(35).then(N.bind(N,15469)),W=new T.c("rgbdDecode","rgbdDecode",null,null,1,null,3,y,!1,void 0,l.type,void 0,null,!1,void 0,A),l._isRGBD=!1,l.invertY=!1,B=y.createRenderTargetCubeTexture(l.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:l.type,format:5});else if(l._isRGBD=!0,l.invertY=!0,u){const a=3;Y={};const N=l._lodGenerationScale,U=l._lodGenerationOffset;for(let c=0;c<a;c++){const K=(J-1)*N+U,Z=U+(K-U)*(1-c/(a-1)),T=Math.round(Math.min(Math.max(Z,0),K)),n=new w.c(y,2);n.isCube=!0,n.invertY=!0,n.generateMipMaps=!1,y.updateTextureSamplingMode(2,n);const H=new S.b(null);switch(H._isCube=!0,H._texture=n,Y[T]=H,c){case 0:l._lodTextureLow=H;break;case 1:l._lodTextureMid=H;break;case 2:l._lodTextureHigh=H}}}const E=[];for(let N=0;N<a.length;N++)for(let U=0;U<6;U++){const c=a[N][U],K=new Blob([c],{type:Z}),w=URL.createObjectURL(K);let S;if(y._features.forceBitmapOverHTMLImageElement)S=y.createImageBitmap(K,{premultiplyAlpha:"none"}).then((async a=>await M(a,y,H,W,w,U,N,u,Y,B,l)));else{const a=new Image;a.src=w,S=new Promise(((c,K)=>{a.onload=()=>{M(a,y,H,W,w,U,N,u,Y,B,l).then((()=>c())).catch((l=>{K(l)}))},a.onerror=l=>{K(l)}}))}E.push(S)}if(await Promise.all(E),a.length<J){let N;const U=Math.pow(2,J-1-a.length),c=U*U*4;switch(l.type){case 0:N=new Uint8Array(c);break;case 2:N=new Uint16Array(c);break;case 1:N=new Float32Array(c)}for(let K=a.length;K<J;K++)for(let a=0;a<6;a++){var q;y._uploadArrayBufferViewToTexture((null===(q=B)||void 0===q?void 0:q.texture)||l,N,a,K)}}if(B){const a=l._irradianceTexture;l._irradianceTexture=null,y._releaseTexture(l),B._swapAndDie(l),l._irradianceTexture=a}W&&W.dispose(),u&&(l._lodTextureHigh&&l._lodTextureHigh._texture&&(l._lodTextureHigh._texture.isReady=!0),l._lodTextureMid&&l._lodTextureMid._texture&&(l._lodTextureMid._texture.isReady=!0),l._lodTextureLow&&l._lodTextureLow._texture&&(l._lodTextureLow._texture.isReady=!0))}function b(l,a){const N=(a=W(a)).irradiance;if(!N)return;const U=new Z.g;c.ua.FromArrayToRef(N.x,0,U.x),c.ua.FromArrayToRef(N.y,0,U.y),c.ua.FromArrayToRef(N.z,0,U.z),c.ua.FromArrayToRef(N.xx,0,U.xx),c.ua.FromArrayToRef(N.yy,0,U.yy),c.ua.FromArrayToRef(N.zz,0,U.zz),c.ua.FromArrayToRef(N.yz,0,U.yz),c.ua.FromArrayToRef(N.zx,0,U.zx),c.ua.FromArrayToRef(N.xy,0,U.xy),l._sphericalPolynomial=U}function z(l,a,N,U,c){const K=A(l.getEngine().createRawCubeTexture(null,l.width,l.format,l.type,l.generateMipMaps,l.invertY,l.samplingMode,l._compression),a).then((()=>l));return l.onRebuildCallback=l=>({proxy:K,isReady:!0,isAsync:!0}),l._source=13,l._bufferViewArrayArray=a,l._lodGenerationScale=U,l._lodGenerationOffset=c,l._sphericalPolynomial=N,A(l,a).then((()=>(l.isReady=!0,l)))}}}]);