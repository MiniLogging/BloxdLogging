"use strict";(self.zy41qorie9=self.zy41qorie9||[]).push([[45],{13793:(Z,l,C)=>{C.d(l,{c:()=>q,e:()=>S,g:()=>c,j:()=>U});var B=C(12248),x=C(12442),b=C(12460),K=C(12652),f=C(12382),W=C(12463),J=(C(12704),C(12565)),d=C(12263);C(12921),C(12689),C(12935);const E="image/png",G=2,a=[134,22,135,150,246,214,150,54];function q(Z){const l=new DataView(Z.buffer,Z.byteOffset,Z.byteLength);let C=0;for(let K=0;K<a.length;K++)if(l.getUint8(C++)!==a[K])return d.e.Error("Not a babylon environment map"),null;let B="",x=0;for(;x=l.getUint8(C++);)B+=String.fromCharCode(x);let b=JSON.parse(B);return b=z(b),b.binaryDataPosition=C,b.FE&&(b.FE.lodGenerationScale=b.FE.lodGenerationScale||.8),b}function z(Z){if(Z.version>G)throw new Error(`Unsupported babylon environment map version "${Z.version}". Latest supported version is "${G}".`);return 2===Z.version?Z:Z={...Z,version:2,imageType:E}}function Y(Z,l){const C=(l=z(l)).FE;let B=Math.log2(l.width);if(B=Math.round(B)+1,C.mipmaps.length!==6*B)throw new Error(`Unsupported specular mipmaps number "${C.mipmaps.length}"`);const x=new Array(B);for(let b=0;b<B;b++){x[b]=new Array(6);for(let B=0;B<6;B++){const K=C.mipmaps[6*b+B];x[b][B]=new Uint8Array(Z.buffer,Z.byteOffset+l.binaryDataPosition+K.position,K.length)}}return x}function P(Z,l){var C;l=z(l);const B=new Array(6),x=null===(C=l.irradiance)||void 0===C?void 0:C.irradianceTexture;if(x){if(6!==x.faces.length)throw new Error(`Incorrect irradiance texture faces number "${x.faces.length}"`);for(let C=0;C<6;C++){const b=x.faces[C];B[C]=new Uint8Array(Z.buffer,Z.byteOffset+l.binaryDataPosition+b.position,b.length)}}return B}function S(Z,l,C){var B;const b=(C=z(C)).FE;if(!b)return Promise.resolve([]);Z._lodGenerationScale=b.lodGenerationScale;const K=[],f=Y(l,C);K.push(s(Z,f,C.imageType));const W=null===(B=C.irradiance)||void 0===B?void 0:B.irradianceTexture;if(W){var J,d;const B=P(l,C);let b=null;null!==(J=C.irradiance)&&void 0!==J&&null!==(d=J.irradianceTexture)&&void 0!==d&&d.dominantDirection&&(b=x.ql.il(C.irradiance.irradianceTexture.dominantDirection)),K.push(F(Z,B,W.size,C.imageType,b))}return Promise.all(K)}async function i(Z,l,C,B,x,b,K,f,W,J,d){return await new Promise(((E,G)=>{if(C){const C=l.createTexture(null,!0,!0,null,1,null,(Z=>{G(Z)}),Z);null===B||void 0===B||B.onEffectCreatedObservable.addOnce((f=>{f.executeWhenCompiled((()=>{B.externalTextureSamplerBinding=!0,B.onApply=B=>{B._bindTexture("textureSampler",C),B.setFloat2("scale",1,l._features.needsInvertingBitmap&&Z instanceof ImageBitmap?-1:1)},l.scenes.length&&(l.scenes[0].postProcessManager.directRender([B],J,!0,b,K),l.restoreDefaultFramebuffer(),C.dispose(),URL.revokeObjectURL(x),E())}))}))}else{if(l._uploadImageToTexture(d,Z,b,K),f){const C=W[K];C&&l._uploadImageToTexture(C._texture,Z,b,0)}E()}}))}async function s(Z,l){let C=arguments.length>2&&void 0!==arguments[2]?arguments[2]:E;const B=Z.getEngine();Z.format=5,Z.type=0,Z.generateMipMaps=!0,Z._cachedAnisotropicFilteringLevel=null,B.updateTextureSamplingMode(3,Z),await n(Z,l,!0,C),Z.isReady=!0}async function F(Z,l,C){let B=arguments.length>3&&void 0!==arguments[3]?arguments[3]:E,x=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const b=Z.getEngine(),K=new f.c(b,5),J=new W.d(b,K);Z._irradianceTexture=J,J._dominantDirection=x,K.isCube=!0,K.format=5,K.type=0,K.generateMipMaps=!0,K._cachedAnisotropicFilteringLevel=null,K.generateMipMaps=!0,K.width=C,K.height=C,b.updateTextureSamplingMode(3,K),await n(K,[l],!1,B),b.generateMipMapsForCubemap(K),K.isReady=!0}async function n(Z,l,x){let K=arguments.length>3&&void 0!==arguments[3]?arguments[3]:E;if(!B.Tools.IsExponentOfTwo(Z.width))throw new Error("Texture size must be a power of two");const d=(0,b.ILog2)(Z.width)+1,G=Z.getEngine();let a=!1,q=!1,z=null,Y=null,P=null;const S=G.getCaps();S.textureLOD?G._features.supportRenderAndCopyToLodForFloatTextures?S.textureHalfFloatRender&&S.textureHalfFloatLinearFiltering?(a=!0,Z.type=2):S.textureFloatRender&&S.textureFloatLinearFiltering&&(a=!0,Z.type=1):a=!1:(a=!1,q=x);let s=0;if(a)G.isWebGPU?(s=1,await C.e(42).then(C.bind(C,15166))):await C.e(35).then(C.bind(C,15175)),z=new J.b("rgbdDecode","rgbdDecode",null,null,1,null,3,G,!1,void 0,Z.type,void 0,null,!1,void 0,s),Z._isRGBD=!1,Z.invertY=!1,Y=G.createRenderTargetCubeTexture(Z.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:Z.type,format:5});else if(Z._isRGBD=!0,Z.invertY=!0,q){const l=3;P={};const C=Z._lodGenerationScale,B=Z._lodGenerationOffset;for(let x=0;x<l;x++){const b=(d-1)*C+B,K=B+(b-B)*(1-x/(l-1)),J=Math.round(Math.min(Math.max(K,0),b)),E=new f.c(G,2);E.isCube=!0,E.invertY=!0,E.generateMipMaps=!1,G.updateTextureSamplingMode(2,E);const a=new W.d(null);switch(a._isCube=!0,a._texture=E,P[J]=a,x){case 0:Z._lodTextureLow=a;break;case 1:Z._lodTextureMid=a;break;case 2:Z._lodTextureHigh=a}}}const F=[];for(let C=0;C<l.length;C++)for(let B=0;B<6;B++){const x=l[C][B],b=new Blob([x],{type:K}),f=URL.createObjectURL(b);let W;if(G._features.forceBitmapOverHTMLImageElement)W=G.createImageBitmap(b,{premultiplyAlpha:"none"}).then((async l=>await i(l,G,a,z,f,B,C,q,P,Y,Z)));else{const l=new Image;l.src=f,W=new Promise(((x,b)=>{l.onload=()=>{i(l,G,a,z,f,B,C,q,P,Y,Z).then((()=>x())).catch((Z=>{b(Z)}))},l.onerror=Z=>{b(Z)}}))}F.push(W)}if(await Promise.all(F),l.length<d){let C;const B=Math.pow(2,d-1-l.length),x=B*B*4;switch(Z.type){case 0:C=new Uint8Array(x);break;case 2:C=new Uint16Array(x);break;case 1:C=new Float32Array(x)}for(let b=l.length;b<d;b++)for(let l=0;l<6;l++){var n;G._uploadArrayBufferViewToTexture((null===(n=Y)||void 0===n?void 0:n.texture)||Z,C,l,b)}}if(Y){const l=Z._irradianceTexture;Z._irradianceTexture=null,G._releaseTexture(Z),Y._swapAndDie(Z),Z._irradianceTexture=l}z&&z.dispose(),q&&(Z._lodTextureHigh&&Z._lodTextureHigh._texture&&(Z._lodTextureHigh._texture.isReady=!0),Z._lodTextureMid&&Z._lodTextureMid._texture&&(Z._lodTextureMid._texture.isReady=!0),Z._lodTextureLow&&Z._lodTextureLow._texture&&(Z._lodTextureLow._texture.isReady=!0))}function c(Z,l){const C=(l=z(l)).irradiance;if(!C)return;const B=new K.g;x.ql.FromArrayToRef(C.x,0,B.x),x.ql.FromArrayToRef(C.y,0,B.y),x.ql.FromArrayToRef(C.z,0,B.z),x.ql.FromArrayToRef(C.xx,0,B.xx),x.ql.FromArrayToRef(C.yy,0,B.yy),x.ql.FromArrayToRef(C.zz,0,B.zz),x.ql.FromArrayToRef(C.yz,0,B.yz),x.ql.FromArrayToRef(C.zx,0,B.zx),x.ql.FromArrayToRef(C.xy,0,B.xy),Z._sphericalPolynomial=B}function U(Z,l,C,B,x){const b=s(Z.getEngine().createRawCubeTexture(null,Z.width,Z.format,Z.type,Z.generateMipMaps,Z.invertY,Z.samplingMode,Z._compression),l).then((()=>Z));return Z.onRebuildCallback=Z=>({proxy:b,isReady:!0,isAsync:!0}),Z._source=13,Z._bufferViewArrayArray=l,Z._lodGenerationScale=B,Z._lodGenerationOffset=x,Z._sphericalPolynomial=C,s(Z,l).then((()=>(Z.isReady=!0,Z)))}}}]);