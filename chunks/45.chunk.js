"use strict";(self["9d4d30r2sf"]=self["9d4d30r2sf"]||[]).push([[45],{14199:(o,v,V)=>{V.d(v,{d:()=>S,g:()=>j,j:()=>u,n:()=>mo});var g=V(12291),E=V(12488),I=V(12511),Q=V(12692),U=V(12418),n=V(12518),O=(V(12747),V(12597)),h=V(12308);V(13018),V(12728),V(13027);const x="image/png",f=2,l=[134,22,135,150,246,214,150,54];function S(o){const v=new DataView(o.buffer,o.byteOffset,o.byteLength);let V=0;for(let Q=0;Q<l.length;Q++)if(v.getUint8(V++)!==l[Q])return h.b.Error("Not a babylon environment map"),null;let g="",E=0;for(;E=v.getUint8(V++);)g+=String.fromCharCode(E);let I=JSON.parse(g);return I=T(I),I.binaryDataPosition=V,I.th&&(I.th.lodGenerationScale=I.th.lodGenerationScale||.8),I}function T(o){if(o.version>f)throw new Error(`Unsupported babylon environment map version "${o.version}". Latest supported version is "${f}".`);return 2===o.version?o:o={...o,version:2,imageType:x}}function c(o,v){const V=(v=T(v)).th;let g=Math.log2(v.width);if(g=Math.round(g)+1,V.mipmaps.length!==6*g)throw new Error(`Unsupported specular mipmaps number "${V.mipmaps.length}"`);const E=new Array(g);for(let I=0;I<g;I++){E[I]=new Array(6);for(let g=0;g<6;g++){const Q=V.mipmaps[6*I+g];E[I][g]=new Uint8Array(o.buffer,o.byteOffset+v.binaryDataPosition+Q.position,Q.length)}}return E}function R(o,v){var V;v=T(v);const g=new Array(6),E=null===(V=v.irradiance)||void 0===V?void 0:V.irradianceTexture;if(E){if(6!==E.faces.length)throw new Error(`Incorrect irradiance texture faces number "${E.faces.length}"`);for(let V=0;V<6;V++){const I=E.faces[V];g[V]=new Uint8Array(o.buffer,o.byteOffset+v.binaryDataPosition+I.position,I.length)}}return g}function j(o,v,V){var g;const I=(V=T(V)).th;if(!I)return Promise.resolve([]);o._lodGenerationScale=I.lodGenerationScale;const Q=[],U=c(v,V);Q.push(s(o,U,V.imageType));const n=null===(g=V.irradiance)||void 0===g?void 0:g.irradianceTexture;if(n){var O,h;const g=R(v,V);let I=null;null!==(O=V.irradiance)&&void 0!==O&&null!==(h=O.irradianceTexture)&&void 0!==h&&h.dominantDirection&&(I=E.cv.bv(V.irradiance.irradianceTexture.dominantDirection)),Q.push(L(o,g,n.size,V.imageType,I))}return Promise.all(Q)}async function t(o,v,V,g,E,I,Q,U,n,O,h){return await new Promise(((x,f)=>{if(V){const V=v.createTexture(null,!0,!0,null,1,null,(o=>{f(o)}),o);null===g||void 0===g||g.onEffectCreatedObservable.addOnce((U=>{U.executeWhenCompiled((()=>{g.externalTextureSamplerBinding=!0,g.onApply=g=>{g._bindTexture("textureSampler",V),g.setFloat2("scale",1,v._features.needsInvertingBitmap&&o instanceof ImageBitmap?-1:1)},v.scenes.length&&(v.scenes[0].postProcessManager.directRender([g],O,!0,I,Q),v.restoreDefaultFramebuffer(),V.dispose(),URL.revokeObjectURL(E),x())}))}))}else{if(v._uploadImageToTexture(h,o,I,Q),U){const V=n[Q];V&&v._uploadImageToTexture(V._texture,o,I,0)}x()}}))}async function s(o,v){let V=arguments.length>2&&void 0!==arguments[2]?arguments[2]:x;const g=o.getEngine();o.format=5,o.type=0,o.generateMipMaps=!0,o._cachedAnisotropicFilteringLevel=null,g.updateTextureSamplingMode(3,o),await b(o,v,!0,V),o.isReady=!0}async function L(o,v,V){let g=arguments.length>3&&void 0!==arguments[3]?arguments[3]:x,E=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const I=o.getEngine(),Q=new U.c(I,5),O=new n.b(I,Q);o._irradianceTexture=O,O._dominantDirection=E,Q.isCube=!0,Q.format=5,Q.type=0,Q.generateMipMaps=!0,Q._cachedAnisotropicFilteringLevel=null,Q.generateMipMaps=!0,Q.width=V,Q.height=V,I.updateTextureSamplingMode(3,Q),await b(Q,[v],!1,g),I.generateMipMapsForCubemap(Q),Q.isReady=!0}async function b(o,v,E){let Q=arguments.length>3&&void 0!==arguments[3]?arguments[3]:x;if(!g.Tools.IsExponentOfTwo(o.width))throw new Error("Texture size must be a power of two");const h=(0,I.ILog2)(o.width)+1,f=o.getEngine();let l=!1,S=!1,T=null,c=null,R=null;const j=f.getCaps();j.textureLOD?f._features.supportRenderAndCopyToLodForFloatTextures?j.textureHalfFloatRender&&j.textureHalfFloatLinearFiltering?(l=!0,o.type=2):j.textureFloatRender&&j.textureFloatLinearFiltering&&(l=!0,o.type=1):l=!1:(l=!1,S=E);let s=0;if(l)f.isWebGPU?(s=1,await V.e(42).then(V.bind(V,15548))):await V.e(35).then(V.bind(V,15555)),T=new O.b("rgbdDecode","rgbdDecode",null,null,1,null,3,f,!1,void 0,o.type,void 0,null,!1,void 0,s),o._isRGBD=!1,o.invertY=!1,c=f.createRenderTargetCubeTexture(o.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:o.type,format:5});else if(o._isRGBD=!0,o.invertY=!0,S){const v=3;R={};const V=o._lodGenerationScale,g=o._lodGenerationOffset;for(let E=0;E<v;E++){const I=(h-1)*V+g,Q=g+(I-g)*(1-E/(v-1)),O=Math.round(Math.min(Math.max(Q,0),I)),x=new U.c(f,2);x.isCube=!0,x.invertY=!0,x.generateMipMaps=!1,f.updateTextureSamplingMode(2,x);const l=new n.b(null);switch(l._isCube=!0,l._texture=x,R[O]=l,E){case 0:o._lodTextureLow=l;break;case 1:o._lodTextureMid=l;break;case 2:o._lodTextureHigh=l}}}const L=[];for(let V=0;V<v.length;V++)for(let g=0;g<6;g++){const E=v[V][g],I=new Blob([E],{type:Q}),U=URL.createObjectURL(I);let n;if(f._features.forceBitmapOverHTMLImageElement)n=f.createImageBitmap(I,{premultiplyAlpha:"none"}).then((async v=>await t(v,f,l,T,U,g,V,S,R,c,o)));else{const v=new Image;v.src=U,n=new Promise(((E,I)=>{v.onload=()=>{t(v,f,l,T,U,g,V,S,R,c,o).then((()=>E())).catch((o=>{I(o)}))},v.onerror=o=>{I(o)}}))}L.push(n)}if(await Promise.all(L),v.length<h){let V;const g=Math.pow(2,h-1-v.length),E=g*g*4;switch(o.type){case 0:V=new Uint8Array(E);break;case 2:V=new Uint16Array(E);break;case 1:V=new Float32Array(E)}for(let I=v.length;I<h;I++)for(let v=0;v<6;v++){var b;f._uploadArrayBufferViewToTexture((null===(b=c)||void 0===b?void 0:b.texture)||o,V,v,I)}}if(c){const v=o._irradianceTexture;o._irradianceTexture=null,f._releaseTexture(o),c._swapAndDie(o),o._irradianceTexture=v}T&&T.dispose(),S&&(o._lodTextureHigh&&o._lodTextureHigh._texture&&(o._lodTextureHigh._texture.isReady=!0),o._lodTextureMid&&o._lodTextureMid._texture&&(o._lodTextureMid._texture.isReady=!0),o._lodTextureLow&&o._lodTextureLow._texture&&(o._lodTextureLow._texture.isReady=!0))}function u(o,v){const V=(v=T(v)).irradiance;if(!V)return;const g=new Q.c;E.cv.FromArrayToRef(V.x,0,g.x),E.cv.FromArrayToRef(V.y,0,g.y),E.cv.FromArrayToRef(V.z,0,g.z),E.cv.FromArrayToRef(V.xx,0,g.xx),E.cv.FromArrayToRef(V.yy,0,g.yy),E.cv.FromArrayToRef(V.zz,0,g.zz),E.cv.FromArrayToRef(V.yz,0,g.yz),E.cv.FromArrayToRef(V.zx,0,g.zx),E.cv.FromArrayToRef(V.xy,0,g.xy),o._sphericalPolynomial=g}function mo(o,v,V,g,E){const I=s(o.getEngine().createRawCubeTexture(null,o.width,o.format,o.type,o.generateMipMaps,o.invertY,o.samplingMode,o._compression),v).then((()=>o));return o.onRebuildCallback=o=>({proxy:I,isReady:!0,isAsync:!0}),o._source=13,o._bufferViewArrayArray=v,o._lodGenerationScale=g,o._lodGenerationOffset=E,o._sphericalPolynomial=V,s(o,v).then((()=>(o.isReady=!0,o)))}}}]);