"use strict";(self.u4k1rqylno=self.u4k1rqylno||[]).push([[45],{13365:(e,E,H)=>{H.d(E,{d:()=>j,g:()=>X,h:()=>f,k:()=>w});var N=H(11532),u=H(11738),z=H(11756),P=H(11924),M=H(11660),D=H(11765),A=(H(11967),H(11840)),C=H(11548);H(12219),H(11946),H(12226);const i="image/png",V=2,U=[134,22,135,150,246,214,150,54];function j(e){const E=new DataView(e.buffer,e.byteOffset,e.byteLength);let H=0;for(let P=0;P<U.length;P++)if(E.getUint8(H++)!==U[P])return C.d.Error("Not a babylon environment map"),null;let N="",u=0;for(;u=E.getUint8(H++);)N+=String.fromCharCode(u);let z=JSON.parse(N);return z=F(z),z.binaryDataPosition=H,z.NC&&(z.NC.lodGenerationScale=z.NC.lodGenerationScale||.8),z}function F(e){if(e.version>V)throw new Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "${V}".`);return 2===e.version?e:e={...e,version:2,imageType:i}}function h(e,E){const H=(E=F(E)).NC;let N=Math.log2(E.width);if(N=Math.round(N)+1,H.mipmaps.length!==6*N)throw new Error(`Unsupported specular mipmaps number "${H.mipmaps.length}"`);const u=new Array(N);for(let z=0;z<N;z++){u[z]=new Array(6);for(let N=0;N<6;N++){const P=H.mipmaps[6*z+N];u[z][N]=new Uint8Array(e.buffer,e.byteOffset+E.binaryDataPosition+P.position,P.length)}}return u}function S(e,E){var H;E=F(E);const N=new Array(6),u=null===(H=E.irradiance)||void 0===H?void 0:H.irradianceTexture;if(u){if(6!==u.faces.length)throw new Error(`Incorrect irradiance texture faces number "${u.faces.length}"`);for(let H=0;H<6;H++){const z=u.faces[H];N[H]=new Uint8Array(e.buffer,e.byteOffset+E.binaryDataPosition+z.position,z.length)}}return N}function X(e,E,H){var N;const z=(H=F(H)).NC;if(!z)return Promise.resolve([]);e._lodGenerationScale=z.lodGenerationScale;const P=[],M=h(E,H);P.push(W(e,M,H.imageType));const D=null===(N=H.irradiance)||void 0===N?void 0:N.irradianceTexture;if(D){var A,C;const N=S(E,H);let z=null;null!==(A=H.irradiance)&&void 0!==A&&null!==(C=A.irradianceTexture)&&void 0!==C&&C.dominantDirection&&(z=u.jE.aE(H.irradiance.irradianceTexture.dominantDirection)),P.push(r(e,N,D.size,H.imageType,z))}return Promise.all(P)}async function a(e,E,H,N,u,z,P,M,D,A,C){return await new Promise(((i,V)=>{if(H){const H=E.createTexture(null,!0,!0,null,1,null,(e=>{V(e)}),e);null===N||void 0===N||N.onEffectCreatedObservable.addOnce((M=>{M.executeWhenCompiled((()=>{N.externalTextureSamplerBinding=!0,N.onApply=N=>{N._bindTexture("textureSampler",H),N.setFloat2("scale",1,E._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},E.scenes.length&&(E.scenes[0].postProcessManager.directRender([N],A,!0,z,P),E.restoreDefaultFramebuffer(),H.dispose(),URL.revokeObjectURL(u),i())}))}))}else{if(E._uploadImageToTexture(C,e,z,P),M){const H=D[P];H&&E._uploadImageToTexture(H._texture,e,z,0)}i()}}))}async function W(e,E){let H=arguments.length>2&&void 0!==arguments[2]?arguments[2]:i;const N=e.getEngine();e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,N.updateTextureSamplingMode(3,e),await Y(e,E,!0,H),e.isReady=!0}async function r(e,E,H){let N=arguments.length>3&&void 0!==arguments[3]?arguments[3]:i,u=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const z=e.getEngine(),P=new M.e(z,5),A=new D.c(z,P);e._irradianceTexture=A,A._dominantDirection=u,P.isCube=!0,P.format=5,P.type=0,P.generateMipMaps=!0,P._cachedAnisotropicFilteringLevel=null,P.generateMipMaps=!0,P.width=H,P.height=H,z.updateTextureSamplingMode(3,P),await Y(P,[E],!1,N),z.generateMipMapsForCubemap(P),P.isReady=!0}async function Y(e,E,u){let P=arguments.length>3&&void 0!==arguments[3]?arguments[3]:i;if(!N.Tools.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");const C=(0,z.ILog2)(e.width)+1,V=e.getEngine();let U=!1,j=!1,F=null,h=null,S=null;const X=V.getCaps();X.textureLOD?V._features.supportRenderAndCopyToLodForFloatTextures?X.textureHalfFloatRender&&X.textureHalfFloatLinearFiltering?(U=!0,e.type=2):X.textureFloatRender&&X.textureFloatLinearFiltering&&(U=!0,e.type=1):U=!1:(U=!1,j=u);let W=0;if(U)V.isWebGPU?(W=1,await H.e(42).then(H.bind(H,14721))):await H.e(35).then(H.bind(H,14724)),F=new A.c("rgbdDecode","rgbdDecode",null,null,1,null,3,V,!1,void 0,e.type,void 0,null,!1,void 0,W),e._isRGBD=!1,e.invertY=!1,h=V.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,j){const E=3;S={};const H=e._lodGenerationScale,N=e._lodGenerationOffset;for(let u=0;u<E;u++){const z=(C-1)*H+N,P=N+(z-N)*(1-u/(E-1)),A=Math.round(Math.min(Math.max(P,0),z)),i=new M.e(V,2);i.isCube=!0,i.invertY=!0,i.generateMipMaps=!1,V.updateTextureSamplingMode(2,i);const U=new D.c(null);switch(U._isCube=!0,U._texture=i,S[A]=U,u){case 0:e._lodTextureLow=U;break;case 1:e._lodTextureMid=U;break;case 2:e._lodTextureHigh=U}}}const r=[];for(let H=0;H<E.length;H++)for(let N=0;N<6;N++){const u=E[H][N],z=new Blob([u],{type:P}),M=URL.createObjectURL(z);let D;if(V._features.forceBitmapOverHTMLImageElement)D=V.createImageBitmap(z,{premultiplyAlpha:"none"}).then((async E=>await a(E,V,U,F,M,N,H,j,S,h,e)));else{const E=new Image;E.src=M,D=new Promise(((u,z)=>{E.onload=()=>{a(E,V,U,F,M,N,H,j,S,h,e).then((()=>u())).catch((e=>{z(e)}))},E.onerror=e=>{z(e)}}))}r.push(D)}if(await Promise.all(r),E.length<C){let H;const N=Math.pow(2,C-1-E.length),u=N*N*4;switch(e.type){case 0:H=new Uint8Array(u);break;case 2:H=new Uint16Array(u);break;case 1:H=new Float32Array(u)}for(let z=E.length;z<C;z++)for(let E=0;E<6;E++){var Y;V._uploadArrayBufferViewToTexture((null===(Y=h)||void 0===Y?void 0:Y.texture)||e,H,E,z)}}if(h){const E=e._irradianceTexture;e._irradianceTexture=null,V._releaseTexture(e),h._swapAndDie(e),e._irradianceTexture=E}F&&F.dispose(),j&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))}function f(e,E){const H=(E=F(E)).irradiance;if(!H)return;const N=new P.f;u.jE.FromArrayToRef(H.x,0,N.x),u.jE.FromArrayToRef(H.y,0,N.y),u.jE.FromArrayToRef(H.z,0,N.z),u.jE.FromArrayToRef(H.xx,0,N.xx),u.jE.FromArrayToRef(H.yy,0,N.yy),u.jE.FromArrayToRef(H.zz,0,N.zz),u.jE.FromArrayToRef(H.yz,0,N.yz),u.jE.FromArrayToRef(H.zx,0,N.zx),u.jE.FromArrayToRef(H.xy,0,N.xy),e._sphericalPolynomial=N}function w(e,E,H,N,u){const z=W(e.getEngine().createRawCubeTexture(null,e.width,e.format,e.type,e.generateMipMaps,e.invertY,e.samplingMode,e._compression),E).then((()=>e));return e.onRebuildCallback=e=>({proxy:z,isReady:!0,isAsync:!0}),e._source=13,e._bufferViewArrayArray=E,e._lodGenerationScale=N,e._lodGenerationOffset=u,e._sphericalPolynomial=H,W(e,E).then((()=>(e.isReady=!0,e)))}}}]);