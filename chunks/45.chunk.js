"use strict";(self.ex92n20nlz8=self.ex92n20nlz8||[]).push([[45],{14234:(I,g,b)=>{b.d(g,{e:()=>Z,f:()=>V,j:()=>E,l:()=>mI});var e=b(12409),c=b(12590),z=b(12610),M=b(12769),J=b(12529),o=b(12614),n=(b(12814),b(12690)),G=b(12420);b(13081),b(12796),b(13089);const D="image/png",p=2,x=[134,22,135,150,246,214,150,54];function Z(I){const g=new DataView(I.buffer,I.byteOffset,I.byteLength);let b=0;for(let M=0;M<x.length;M++)if(g.getUint8(b++)!==x[M])return G.b.Error("Not a babylon environment map"),null;let e="",c=0;for(;c=g.getUint8(b++);)e+=String.fromCharCode(c);let z=JSON.parse(e);return z=k(z),z.binaryDataPosition=b,z.PD&&(z.PD.lodGenerationScale=z.PD.lodGenerationScale||.8),z}function k(I){if(I.version>p)throw new Error(`Unsupported babylon environment map version "${I.version}". Latest supported version is "${p}".`);return 2===I.version?I:I={...I,version:2,imageType:D}}function S(I,g){const b=(g=k(g)).PD;let e=Math.log2(g.width);if(e=Math.round(e)+1,b.mipmaps.length!==6*e)throw new Error(`Unsupported specular mipmaps number "${b.mipmaps.length}"`);const c=new Array(e);for(let z=0;z<e;z++){c[z]=new Array(6);for(let e=0;e<6;e++){const M=b.mipmaps[6*z+e];c[z][e]=new Uint8Array(I.buffer,I.byteOffset+g.binaryDataPosition+M.position,M.length)}}return c}function f(I,g){var b;g=k(g);const e=new Array(6),c=null===(b=g.irradiance)||void 0===b?void 0:b.irradianceTexture;if(c){if(6!==c.faces.length)throw new Error(`Incorrect irradiance texture faces number "${c.faces.length}"`);for(let b=0;b<6;b++){const z=c.faces[b];e[b]=new Uint8Array(I.buffer,I.byteOffset+g.binaryDataPosition+z.position,z.length)}}return e}function V(I,g,b){var e;const z=(b=k(b)).PD;if(!z)return Promise.resolve([]);I._lodGenerationScale=z.lodGenerationScale;const M=[],J=S(g,b);M.push(v(I,J,b.imageType));const o=null===(e=b.irradiance)||void 0===e?void 0:e.irradianceTexture;if(o){var n,G;const e=f(g,b);let z=null;null!==(n=b.irradiance)&&void 0!==n&&null!==(G=n.irradianceTexture)&&void 0!==G&&G.dominantDirection&&(z=c.Vg.mb(b.irradiance.irradianceTexture.dominantDirection)),M.push(X(I,e,o.size,b.imageType,z))}return Promise.all(M)}async function a(I,g,b,e,c,z,M,J,o,n,G){return await new Promise(((D,p)=>{if(b){const b=g.createTexture(null,!0,!0,null,1,null,(I=>{p(I)}),I);null===e||void 0===e||e.onEffectCreatedObservable.addOnce((J=>{J.executeWhenCompiled((()=>{e.externalTextureSamplerBinding=!0,e.onApply=e=>{e._bindTexture("textureSampler",b),e.setFloat2("scale",1,g._features.needsInvertingBitmap&&I instanceof ImageBitmap?-1:1)},g.scenes.length&&(g.scenes[0].postProcessManager.directRender([e],n,!0,z,M),g.restoreDefaultFramebuffer(),b.dispose(),URL.revokeObjectURL(c),D())}))}))}else{if(g._uploadImageToTexture(G,I,z,M),J){const b=o[M];b&&g._uploadImageToTexture(b._texture,I,z,0)}D()}}))}async function v(I,g){let b=arguments.length>2&&void 0!==arguments[2]?arguments[2]:D;const e=I.getEngine();I.format=5,I.type=0,I.generateMipMaps=!0,I._cachedAnisotropicFilteringLevel=null,e.updateTextureSamplingMode(3,I),await R(I,g,!0,b),I.isReady=!0}async function X(I,g,b){let e=arguments.length>3&&void 0!==arguments[3]?arguments[3]:D,c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const z=I.getEngine(),M=new J.e(z,5),n=new o.b(z,M);I._irradianceTexture=n,n._dominantDirection=c,M.isCube=!0,M.format=5,M.type=0,M.generateMipMaps=!0,M._cachedAnisotropicFilteringLevel=null,M.generateMipMaps=!0,M.width=b,M.height=b,z.updateTextureSamplingMode(3,M),await R(M,[g],!1,e),z.generateMipMapsForCubemap(M),M.isReady=!0}async function R(I,g,c){let M=arguments.length>3&&void 0!==arguments[3]?arguments[3]:D;if(!e.Tools.IsExponentOfTwo(I.width))throw new Error("Texture size must be a power of two");const G=(0,z.ILog2)(I.width)+1,p=I.getEngine();let x=!1,Z=!1,k=null,S=null,f=null;const V=p.getCaps();V.textureLOD?p._features.supportRenderAndCopyToLodForFloatTextures?V.textureHalfFloatRender&&V.textureHalfFloatLinearFiltering?(x=!0,I.type=2):V.textureFloatRender&&V.textureFloatLinearFiltering&&(x=!0,I.type=1):x=!1:(x=!1,Z=c);let v=0;if(x)p.isWebGPU?(v=1,await b.e(42).then(b.bind(b,15551))):await b.e(35).then(b.bind(b,15558)),k=new n.d("rgbdDecode","rgbdDecode",null,null,1,null,3,p,!1,void 0,I.type,void 0,null,!1,void 0,v),I._isRGBD=!1,I.invertY=!1,S=p.createRenderTargetCubeTexture(I.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:I.type,format:5});else if(I._isRGBD=!0,I.invertY=!0,Z){const g=3;f={};const b=I._lodGenerationScale,e=I._lodGenerationOffset;for(let c=0;c<g;c++){const z=(G-1)*b+e,M=e+(z-e)*(1-c/(g-1)),n=Math.round(Math.min(Math.max(M,0),z)),D=new J.e(p,2);D.isCube=!0,D.invertY=!0,D.generateMipMaps=!1,p.updateTextureSamplingMode(2,D);const x=new o.b(null);switch(x._isCube=!0,x._texture=D,f[n]=x,c){case 0:I._lodTextureLow=x;break;case 1:I._lodTextureMid=x;break;case 2:I._lodTextureHigh=x}}}const X=[];for(let b=0;b<g.length;b++)for(let e=0;e<6;e++){const c=g[b][e],z=new Blob([c],{type:M}),J=URL.createObjectURL(z);let o;if(p._features.forceBitmapOverHTMLImageElement)o=p.createImageBitmap(z,{premultiplyAlpha:"none"}).then((async g=>await a(g,p,x,k,J,e,b,Z,f,S,I)));else{const g=new Image;g.src=J,o=new Promise(((c,z)=>{g.onload=()=>{a(g,p,x,k,J,e,b,Z,f,S,I).then((()=>c())).catch((I=>{z(I)}))},g.onerror=I=>{z(I)}}))}X.push(o)}if(await Promise.all(X),g.length<G){let b;const e=Math.pow(2,G-1-g.length),c=e*e*4;switch(I.type){case 0:b=new Uint8Array(c);break;case 2:b=new Uint16Array(c);break;case 1:b=new Float32Array(c)}for(let z=g.length;z<G;z++)for(let g=0;g<6;g++){var R;p._uploadArrayBufferViewToTexture((null===(R=S)||void 0===R?void 0:R.texture)||I,b,g,z)}}if(S){const g=I._irradianceTexture;I._irradianceTexture=null,p._releaseTexture(I),S._swapAndDie(I),I._irradianceTexture=g}k&&k.dispose(),Z&&(I._lodTextureHigh&&I._lodTextureHigh._texture&&(I._lodTextureHigh._texture.isReady=!0),I._lodTextureMid&&I._lodTextureMid._texture&&(I._lodTextureMid._texture.isReady=!0),I._lodTextureLow&&I._lodTextureLow._texture&&(I._lodTextureLow._texture.isReady=!0))}function E(I,g){const b=(g=k(g)).irradiance;if(!b)return;const e=new M.f;c.Vg.FromArrayToRef(b.x,0,e.x),c.Vg.FromArrayToRef(b.y,0,e.y),c.Vg.FromArrayToRef(b.z,0,e.z),c.Vg.FromArrayToRef(b.xx,0,e.xx),c.Vg.FromArrayToRef(b.yy,0,e.yy),c.Vg.FromArrayToRef(b.zz,0,e.zz),c.Vg.FromArrayToRef(b.yz,0,e.yz),c.Vg.FromArrayToRef(b.zx,0,e.zx),c.Vg.FromArrayToRef(b.xy,0,e.xy),I._sphericalPolynomial=e}function mI(I,g,b,e,c){const z=v(I.getEngine().createRawCubeTexture(null,I.width,I.format,I.type,I.generateMipMaps,I.invertY,I.samplingMode,I._compression),g).then((()=>I));return I.onRebuildCallback=I=>({proxy:z,isReady:!0,isAsync:!0}),I._source=13,I._bufferViewArrayArray=g,I._lodGenerationScale=e,I._lodGenerationOffset=c,I._sphericalPolynomial=b,v(I,g).then((()=>(I.isReady=!0,I)))}}}]);