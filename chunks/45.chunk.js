"use strict";(self.fjf2z1c8il8=self.fjf2z1c8il8||[]).push([[45],{14159:(g,i,a)=>{a.d(i,{e:()=>B,i:()=>R,k:()=>P,n:()=>Y});var n=a(12277),L=a(12452),d=a(12466),b=a(12648),k=a(12392),e=a(12475),N=(a(12692),a(12548)),F=a(12292);a(12974),a(12681),a(12986);const I="image/png",j=2,y=[134,22,135,150,246,214,150,54];function B(g){const i=new DataView(g.buffer,g.byteOffset,g.byteLength);let a=0;for(let b=0;b<y.length;b++)if(i.getUint8(a++)!==y[b])return F.b.Error("Not a babylon environment map"),null;let n="",L=0;for(;L=i.getUint8(a++);)n+=String.fromCharCode(L);let d=JSON.parse(n);return d=c(d),d.binaryDataPosition=a,d.jI&&(d.jI.lodGenerationScale=d.jI.lodGenerationScale||.8),d}function c(g){if(g.version>j)throw new Error(`Unsupported babylon environment map version "${g.version}". Latest supported version is "${j}".`);return 2===g.version?g:g={...g,version:2,imageType:I}}function D(g,i){const a=(i=c(i)).jI;let n=Math.log2(i.width);if(n=Math.round(n)+1,a.mipmaps.length!==6*n)throw new Error(`Unsupported specular mipmaps number "${a.mipmaps.length}"`);const L=new Array(n);for(let d=0;d<n;d++){L[d]=new Array(6);for(let n=0;n<6;n++){const b=a.mipmaps[6*d+n];L[d][n]=new Uint8Array(g.buffer,g.byteOffset+i.binaryDataPosition+b.position,b.length)}}return L}function p(g,i){var a;i=c(i);const n=new Array(6),L=null===(a=i.irradiance)||void 0===a?void 0:a.irradianceTexture;if(L){if(6!==L.faces.length)throw new Error(`Incorrect irradiance texture faces number "${L.faces.length}"`);for(let a=0;a<6;a++){const d=L.faces[a];n[a]=new Uint8Array(g.buffer,g.byteOffset+i.binaryDataPosition+d.position,d.length)}}return n}function R(g,i,a){var n;const d=(a=c(a)).jI;if(!d)return Promise.resolve([]);g._lodGenerationScale=d.lodGenerationScale;const b=[],k=D(i,a);b.push(E(g,k,a.imageType));const e=null===(n=a.irradiance)||void 0===n?void 0:n.irradianceTexture;if(e){var N,F;const n=p(i,a);let d=null;null!==(N=a.irradiance)&&void 0!==N&&null!==(F=N.irradianceTexture)&&void 0!==F&&F.dominantDirection&&(d=L.Bi.xi(a.irradiance.irradianceTexture.dominantDirection)),b.push(X(g,n,e.size,a.imageType,d))}return Promise.all(b)}async function x(g,i,a,n,L,d,b,k,e,N,F){return await new Promise(((I,j)=>{if(a){const a=i.createTexture(null,!0,!0,null,1,null,(g=>{j(g)}),g);null===n||void 0===n||n.onEffectCreatedObservable.addOnce((k=>{k.executeWhenCompiled((()=>{n.externalTextureSamplerBinding=!0,n.onApply=n=>{n._bindTexture("textureSampler",a),n.setFloat2("scale",1,i._features.needsInvertingBitmap&&g instanceof ImageBitmap?-1:1)},i.scenes.length&&(i.scenes[0].postProcessManager.directRender([n],N,!0,d,b),i.restoreDefaultFramebuffer(),a.dispose(),URL.revokeObjectURL(L),I())}))}))}else{if(i._uploadImageToTexture(F,g,d,b),k){const a=e[b];a&&i._uploadImageToTexture(a._texture,g,d,0)}I()}}))}async function E(g,i){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:I;const n=g.getEngine();g.format=5,g.type=0,g.generateMipMaps=!0,g._cachedAnisotropicFilteringLevel=null,n.updateTextureSamplingMode(3,g),await v(g,i,!0,a),g.isReady=!0}async function X(g,i,a){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:I,L=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const d=g.getEngine(),b=new k.d(d,5),N=new e.c(d,b);g._irradianceTexture=N,N._dominantDirection=L,b.isCube=!0,b.format=5,b.type=0,b.generateMipMaps=!0,b._cachedAnisotropicFilteringLevel=null,b.generateMipMaps=!0,b.width=a,b.height=a,d.updateTextureSamplingMode(3,b),await v(b,[i],!1,n),d.generateMipMapsForCubemap(b),b.isReady=!0}async function v(g,i,L){let b=arguments.length>3&&void 0!==arguments[3]?arguments[3]:I;if(!n.Tools.IsExponentOfTwo(g.width))throw new Error("Texture size must be a power of two");const F=(0,d.ILog2)(g.width)+1,j=g.getEngine();let y=!1,B=!1,c=null,D=null,p=null;const R=j.getCaps();R.textureLOD?j._features.supportRenderAndCopyToLodForFloatTextures?R.textureHalfFloatRender&&R.textureHalfFloatLinearFiltering?(y=!0,g.type=2):R.textureFloatRender&&R.textureFloatLinearFiltering&&(y=!0,g.type=1):y=!1:(y=!1,B=L);let E=0;if(y)j.isWebGPU?(E=1,await a.e(42).then(a.bind(a,15573))):await a.e(35).then(a.bind(a,15577)),c=new N.e("rgbdDecode","rgbdDecode",null,null,1,null,3,j,!1,void 0,g.type,void 0,null,!1,void 0,E),g._isRGBD=!1,g.invertY=!1,D=j.createRenderTargetCubeTexture(g.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:g.type,format:5});else if(g._isRGBD=!0,g.invertY=!0,B){const i=3;p={};const a=g._lodGenerationScale,n=g._lodGenerationOffset;for(let L=0;L<i;L++){const d=(F-1)*a+n,b=n+(d-n)*(1-L/(i-1)),N=Math.round(Math.min(Math.max(b,0),d)),I=new k.d(j,2);I.isCube=!0,I.invertY=!0,I.generateMipMaps=!1,j.updateTextureSamplingMode(2,I);const y=new e.c(null);switch(y._isCube=!0,y._texture=I,p[N]=y,L){case 0:g._lodTextureLow=y;break;case 1:g._lodTextureMid=y;break;case 2:g._lodTextureHigh=y}}}const X=[];for(let a=0;a<i.length;a++)for(let n=0;n<6;n++){const L=i[a][n],d=new Blob([L],{type:b}),k=URL.createObjectURL(d);let e;if(j._features.forceBitmapOverHTMLImageElement)e=j.createImageBitmap(d,{premultiplyAlpha:"none"}).then((async i=>await x(i,j,y,c,k,n,a,B,p,D,g)));else{const i=new Image;i.src=k,e=new Promise(((L,d)=>{i.onload=()=>{x(i,j,y,c,k,n,a,B,p,D,g).then((()=>L())).catch((g=>{d(g)}))},i.onerror=g=>{d(g)}}))}X.push(e)}if(await Promise.all(X),i.length<F){let a;const n=Math.pow(2,F-1-i.length),L=n*n*4;switch(g.type){case 0:a=new Uint8Array(L);break;case 2:a=new Uint16Array(L);break;case 1:a=new Float32Array(L)}for(let d=i.length;d<F;d++)for(let i=0;i<6;i++){var v;j._uploadArrayBufferViewToTexture((null===(v=D)||void 0===v?void 0:v.texture)||g,a,i,d)}}if(D){const i=g._irradianceTexture;g._irradianceTexture=null,j._releaseTexture(g),D._swapAndDie(g),g._irradianceTexture=i}c&&c.dispose(),B&&(g._lodTextureHigh&&g._lodTextureHigh._texture&&(g._lodTextureHigh._texture.isReady=!0),g._lodTextureMid&&g._lodTextureMid._texture&&(g._lodTextureMid._texture.isReady=!0),g._lodTextureLow&&g._lodTextureLow._texture&&(g._lodTextureLow._texture.isReady=!0))}function P(g,i){const a=(i=c(i)).irradiance;if(!a)return;const n=new b.c;L.Bi.FromArrayToRef(a.x,0,n.x),L.Bi.FromArrayToRef(a.y,0,n.y),L.Bi.FromArrayToRef(a.z,0,n.z),L.Bi.FromArrayToRef(a.xx,0,n.xx),L.Bi.FromArrayToRef(a.yy,0,n.yy),L.Bi.FromArrayToRef(a.zz,0,n.zz),L.Bi.FromArrayToRef(a.yz,0,n.yz),L.Bi.FromArrayToRef(a.zx,0,n.zx),L.Bi.FromArrayToRef(a.xy,0,n.xy),g._sphericalPolynomial=n}function Y(g,i,a,n,L){const d=E(g.getEngine().createRawCubeTexture(null,g.width,g.format,g.type,g.generateMipMaps,g.invertY,g.samplingMode,g._compression),i).then((()=>g));return g.onRebuildCallback=g=>({proxy:d,isReady:!0,isAsync:!0}),g._source=13,g._bufferViewArrayArray=i,g._lodGenerationScale=n,g._lodGenerationOffset=L,g._sphericalPolynomial=a,E(g,i).then((()=>(g.isReady=!0,g)))}}}]);