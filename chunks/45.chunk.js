"use strict";(self.vfdo5lmva5i=self.vfdo5lmva5i||[]).push([[45],{13404:(w,o,H)=>{H.d(o,{d:()=>Q,f:()=>V,g:()=>O,k:()=>T});var h=H(11531),E=H(11720),e=H(11729),D=H(11902),t=H(11640),X=H(11734),L=(H(11957),H(11813)),A=H(11551);H(12217),H(11936),H(12232);const y="image/png",z=2,C=[134,22,135,150,246,214,150,54];function Q(w){const o=new DataView(w.buffer,w.byteOffset,w.byteLength);let H=0;for(let D=0;D<C.length;D++)if(o.getUint8(H++)!==C[D])return A.d.Error("Not a babylon environment map"),null;let h="",E=0;for(;E=o.getUint8(H++);)h+=String.fromCharCode(E);let e=JSON.parse(h);return e=M(e),e.binaryDataPosition=H,e.zA&&(e.zA.lodGenerationScale=e.zA.lodGenerationScale||.8),e}function M(w){if(w.version>z)throw new Error(`Unsupported babylon environment map version "${w.version}". Latest supported version is "${z}".`);return 2===w.version?w:w={...w,version:2,imageType:y}}function i(w,o){const H=(o=M(o)).zA;let h=Math.log2(o.width);if(h=Math.round(h)+1,H.mipmaps.length!==6*h)throw new Error(`Unsupported specular mipmaps number "${H.mipmaps.length}"`);const E=new Array(h);for(let e=0;e<h;e++){E[e]=new Array(6);for(let h=0;h<6;h++){const D=H.mipmaps[6*e+h];E[e][h]=new Uint8Array(w.buffer,w.byteOffset+o.binaryDataPosition+D.position,D.length)}}return E}function s(w,o){var H;o=M(o);const h=new Array(6),E=null===(H=o.irradiance)||void 0===H?void 0:H.irradianceTexture;if(E){if(6!==E.faces.length)throw new Error(`Incorrect irradiance texture faces number "${E.faces.length}"`);for(let H=0;H<6;H++){const e=E.faces[H];h[H]=new Uint8Array(w.buffer,w.byteOffset+o.binaryDataPosition+e.position,e.length)}}return h}function V(w,o,H){var h;const e=(H=M(H)).zA;if(!e)return Promise.resolve([]);w._lodGenerationScale=e.lodGenerationScale;const D=[],t=i(o,H);D.push(k(w,t,H.imageType));const X=null===(h=H.irradiance)||void 0===h?void 0:h.irradianceTexture;if(X){var L,A;const h=s(o,H);let e=null;null!==(L=H.irradiance)&&void 0!==L&&null!==(A=L.irradianceTexture)&&void 0!==A&&A.dominantDirection&&(e=E.io.Po(H.irradiance.irradianceTexture.dominantDirection)),D.push(P(w,h,X.size,H.imageType,e))}return Promise.all(D)}async function r(w,o,H,h,E,e,D,t,X,L,A){return await new Promise(((y,z)=>{if(H){const H=o.createTexture(null,!0,!0,null,1,null,(w=>{z(w)}),w);null===h||void 0===h||h.onEffectCreatedObservable.addOnce((t=>{t.executeWhenCompiled((()=>{h.externalTextureSamplerBinding=!0,h.onApply=h=>{h._bindTexture("textureSampler",H),h.setFloat2("scale",1,o._features.needsInvertingBitmap&&w instanceof ImageBitmap?-1:1)},o.scenes.length&&(o.scenes[0].postProcessManager.directRender([h],L,!0,e,D),o.restoreDefaultFramebuffer(),H.dispose(),URL.revokeObjectURL(E),y())}))}))}else{if(o._uploadImageToTexture(A,w,e,D),t){const H=X[D];H&&o._uploadImageToTexture(H._texture,w,e,0)}y()}}))}async function k(w,o){let H=arguments.length>2&&void 0!==arguments[2]?arguments[2]:y;const h=w.getEngine();w.format=5,w.type=0,w.generateMipMaps=!0,w._cachedAnisotropicFilteringLevel=null,h.updateTextureSamplingMode(3,w),await l(w,o,!0,H),w.isReady=!0}async function P(w,o,H){let h=arguments.length>3&&void 0!==arguments[3]?arguments[3]:y,E=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const e=w.getEngine(),D=new t.c(e,5),L=new X.c(e,D);w._irradianceTexture=L,L._dominantDirection=E,D.isCube=!0,D.format=5,D.type=0,D.generateMipMaps=!0,D._cachedAnisotropicFilteringLevel=null,D.generateMipMaps=!0,D.width=H,D.height=H,e.updateTextureSamplingMode(3,D),await l(D,[o],!1,h),e.generateMipMapsForCubemap(D),D.isReady=!0}async function l(w,o,E){let D=arguments.length>3&&void 0!==arguments[3]?arguments[3]:y;if(!h.Tools.IsExponentOfTwo(w.width))throw new Error("Texture size must be a power of two");const A=(0,e.ILog2)(w.width)+1,z=w.getEngine();let C=!1,Q=!1,M=null,i=null,s=null;const V=z.getCaps();V.textureLOD?z._features.supportRenderAndCopyToLodForFloatTextures?V.textureHalfFloatRender&&V.textureHalfFloatLinearFiltering?(C=!0,w.type=2):V.textureFloatRender&&V.textureFloatLinearFiltering&&(C=!0,w.type=1):C=!1:(C=!1,Q=E);let k=0;if(C)z.isWebGPU?(k=1,await H.e(42).then(H.bind(H,14860))):await H.e(35).then(H.bind(H,14864)),M=new L.e("rgbdDecode","rgbdDecode",null,null,1,null,3,z,!1,void 0,w.type,void 0,null,!1,void 0,k),w._isRGBD=!1,w.invertY=!1,i=z.createRenderTargetCubeTexture(w.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:w.type,format:5});else if(w._isRGBD=!0,w.invertY=!0,Q){const o=3;s={};const H=w._lodGenerationScale,h=w._lodGenerationOffset;for(let E=0;E<o;E++){const e=(A-1)*H+h,D=h+(e-h)*(1-E/(o-1)),L=Math.round(Math.min(Math.max(D,0),e)),y=new t.c(z,2);y.isCube=!0,y.invertY=!0,y.generateMipMaps=!1,z.updateTextureSamplingMode(2,y);const C=new X.c(null);switch(C._isCube=!0,C._texture=y,s[L]=C,E){case 0:w._lodTextureLow=C;break;case 1:w._lodTextureMid=C;break;case 2:w._lodTextureHigh=C}}}const P=[];for(let H=0;H<o.length;H++)for(let h=0;h<6;h++){const E=o[H][h],e=new Blob([E],{type:D}),t=URL.createObjectURL(e);let X;if(z._features.forceBitmapOverHTMLImageElement)X=z.createImageBitmap(e,{premultiplyAlpha:"none"}).then((async o=>await r(o,z,C,M,t,h,H,Q,s,i,w)));else{const o=new Image;o.src=t,X=new Promise(((E,e)=>{o.onload=()=>{r(o,z,C,M,t,h,H,Q,s,i,w).then((()=>E())).catch((w=>{e(w)}))},o.onerror=w=>{e(w)}}))}P.push(X)}if(await Promise.all(P),o.length<A){let H;const h=Math.pow(2,A-1-o.length),E=h*h*4;switch(w.type){case 0:H=new Uint8Array(E);break;case 2:H=new Uint16Array(E);break;case 1:H=new Float32Array(E)}for(let e=o.length;e<A;e++)for(let o=0;o<6;o++){var l;z._uploadArrayBufferViewToTexture((null===(l=i)||void 0===l?void 0:l.texture)||w,H,o,e)}}if(i){const o=w._irradianceTexture;w._irradianceTexture=null,z._releaseTexture(w),i._swapAndDie(w),w._irradianceTexture=o}M&&M.dispose(),Q&&(w._lodTextureHigh&&w._lodTextureHigh._texture&&(w._lodTextureHigh._texture.isReady=!0),w._lodTextureMid&&w._lodTextureMid._texture&&(w._lodTextureMid._texture.isReady=!0),w._lodTextureLow&&w._lodTextureLow._texture&&(w._lodTextureLow._texture.isReady=!0))}function O(w,o){const H=(o=M(o)).irradiance;if(!H)return;const h=new D.h;E.io.FromArrayToRef(H.x,0,h.x),E.io.FromArrayToRef(H.y,0,h.y),E.io.FromArrayToRef(H.z,0,h.z),E.io.FromArrayToRef(H.xx,0,h.xx),E.io.FromArrayToRef(H.yy,0,h.yy),E.io.FromArrayToRef(H.zz,0,h.zz),E.io.FromArrayToRef(H.yz,0,h.yz),E.io.FromArrayToRef(H.zx,0,h.zx),E.io.FromArrayToRef(H.xy,0,h.xy),w._sphericalPolynomial=h}function T(w,o,H,h,E){const e=k(w.getEngine().createRawCubeTexture(null,w.width,w.format,w.type,w.generateMipMaps,w.invertY,w.samplingMode,w._compression),o).then((()=>w));return w.onRebuildCallback=w=>({proxy:e,isReady:!0,isAsync:!0}),w._source=13,w._bufferViewArrayArray=o,w._lodGenerationScale=h,w._lodGenerationOffset=E,w._sphericalPolynomial=H,k(w,o).then((()=>(w.isReady=!0,w)))}}}]);