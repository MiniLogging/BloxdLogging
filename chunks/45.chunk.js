"use strict";(self.kdlk57exiqh=self.kdlk57exiqh||[]).push([[45],{13827:(i,x,e)=>{e.d(x,{e:()=>o,g:()=>Q,i:()=>w,k:()=>O});var j=e(12061),E=e(12250),a=e(12264),Y=e(12413),J=e(12181),u=e(12272),b=(e(12452),e(12342)),g=e(12072);e(12730),e(12439),e(12740);const A="image/png",K=2,L=[134,22,135,150,246,214,150,54];function o(i){const x=new DataView(i.buffer,i.byteOffset,i.byteLength);let e=0;for(let Y=0;Y<L.length;Y++)if(x.getUint8(e++)!==L[Y])return g.c.Error("Not a babylon environment map"),null;let j="",E=0;for(;E=x.getUint8(e++);)j+=String.fromCharCode(E);let a=JSON.parse(j);return a=M(a),a.binaryDataPosition=e,a.MA&&(a.MA.lodGenerationScale=a.MA.lodGenerationScale||.8),a}function M(i){if(i.version>K)throw new Error(`Unsupported babylon environment map version "${i.version}". Latest supported version is "${K}".`);return 2===i.version?i:i={...i,version:2,imageType:A}}function z(i,x){const e=(x=M(x)).MA;let j=Math.log2(x.width);if(j=Math.round(j)+1,e.mipmaps.length!==6*j)throw new Error(`Unsupported specular mipmaps number "${e.mipmaps.length}"`);const E=new Array(j);for(let a=0;a<j;a++){E[a]=new Array(6);for(let j=0;j<6;j++){const Y=e.mipmaps[6*a+j];E[a][j]=new Uint8Array(i.buffer,i.byteOffset+x.binaryDataPosition+Y.position,Y.length)}}return E}function T(i,x){var e;x=M(x);const j=new Array(6),E=null===(e=x.irradiance)||void 0===e?void 0:e.irradianceTexture;if(E){if(6!==E.faces.length)throw new Error(`Incorrect irradiance texture faces number "${E.faces.length}"`);for(let e=0;e<6;e++){const a=E.faces[e];j[e]=new Uint8Array(i.buffer,i.byteOffset+x.binaryDataPosition+a.position,a.length)}}return j}function Q(i,x,e){var j;const a=(e=M(e)).MA;if(!a)return Promise.resolve([]);i._lodGenerationScale=a.lodGenerationScale;const Y=[],J=z(x,e);Y.push(V(i,J,e.imageType));const u=null===(j=e.irradiance)||void 0===j?void 0:j.irradianceTexture;if(u){var b,g;const j=T(x,e);let a=null;null!==(b=e.irradiance)&&void 0!==b&&null!==(g=b.irradianceTexture)&&void 0!==g&&g.dominantDirection&&(a=E.KJ.zJ(e.irradiance.irradianceTexture.dominantDirection)),Y.push(S(i,j,u.size,e.imageType,a))}return Promise.all(Y)}async function t(i,x,e,j,E,a,Y,J,u,b,g){return await new Promise(((A,K)=>{if(e){const e=x.createTexture(null,!0,!0,null,1,null,(i=>{K(i)}),i);null===j||void 0===j||j.onEffectCreatedObservable.addOnce((J=>{J.executeWhenCompiled((()=>{j.externalTextureSamplerBinding=!0,j.onApply=j=>{j._bindTexture("textureSampler",e),j.setFloat2("scale",1,x._features.needsInvertingBitmap&&i instanceof ImageBitmap?-1:1)},x.scenes.length&&(x.scenes[0].postProcessManager.directRender([j],b,!0,a,Y),x.restoreDefaultFramebuffer(),e.dispose(),URL.revokeObjectURL(E),A())}))}))}else{if(x._uploadImageToTexture(g,i,a,Y),J){const e=u[Y];e&&x._uploadImageToTexture(e._texture,i,a,0)}A()}}))}async function V(i,x){let e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:A;const j=i.getEngine();i.format=5,i.type=0,i.generateMipMaps=!0,i._cachedAnisotropicFilteringLevel=null,j.updateTextureSamplingMode(3,i),await f(i,x,!0,e),i.isReady=!0}async function S(i,x,e){let j=arguments.length>3&&void 0!==arguments[3]?arguments[3]:A,E=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const a=i.getEngine(),Y=new J.b(a,5),b=new u.b(a,Y);i._irradianceTexture=b,b._dominantDirection=E,Y.isCube=!0,Y.format=5,Y.type=0,Y.generateMipMaps=!0,Y._cachedAnisotropicFilteringLevel=null,Y.generateMipMaps=!0,Y.width=e,Y.height=e,a.updateTextureSamplingMode(3,Y),await f(Y,[x],!1,j),a.generateMipMapsForCubemap(Y),Y.isReady=!0}async function f(i,x,E){let Y=arguments.length>3&&void 0!==arguments[3]?arguments[3]:A;if(!j.Tools.IsExponentOfTwo(i.width))throw new Error("Texture size must be a power of two");const g=(0,a.ILog2)(i.width)+1,K=i.getEngine();let L=!1,o=!1,M=null,z=null,T=null;const Q=K.getCaps();Q.textureLOD?K._features.supportRenderAndCopyToLodForFloatTextures?Q.textureHalfFloatRender&&Q.textureHalfFloatLinearFiltering?(L=!0,i.type=2):Q.textureFloatRender&&Q.textureFloatLinearFiltering&&(L=!0,i.type=1):L=!1:(L=!1,o=E);let V=0;if(L)K.isWebGPU?(V=1,await e.e(42).then(e.bind(e,15188))):await e.e(35).then(e.bind(e,15191)),M=new b.e("rgbdDecode","rgbdDecode",null,null,1,null,3,K,!1,void 0,i.type,void 0,null,!1,void 0,V),i._isRGBD=!1,i.invertY=!1,z=K.createRenderTargetCubeTexture(i.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:i.type,format:5});else if(i._isRGBD=!0,i.invertY=!0,o){const x=3;T={};const e=i._lodGenerationScale,j=i._lodGenerationOffset;for(let E=0;E<x;E++){const a=(g-1)*e+j,Y=j+(a-j)*(1-E/(x-1)),b=Math.round(Math.min(Math.max(Y,0),a)),A=new J.b(K,2);A.isCube=!0,A.invertY=!0,A.generateMipMaps=!1,K.updateTextureSamplingMode(2,A);const L=new u.b(null);switch(L._isCube=!0,L._texture=A,T[b]=L,E){case 0:i._lodTextureLow=L;break;case 1:i._lodTextureMid=L;break;case 2:i._lodTextureHigh=L}}}const S=[];for(let e=0;e<x.length;e++)for(let j=0;j<6;j++){const E=x[e][j],a=new Blob([E],{type:Y}),J=URL.createObjectURL(a);let u;if(K._features.forceBitmapOverHTMLImageElement)u=K.createImageBitmap(a,{premultiplyAlpha:"none"}).then((async x=>await t(x,K,L,M,J,j,e,o,T,z,i)));else{const x=new Image;x.src=J,u=new Promise(((E,a)=>{x.onload=()=>{t(x,K,L,M,J,j,e,o,T,z,i).then((()=>E())).catch((i=>{a(i)}))},x.onerror=i=>{a(i)}}))}S.push(u)}if(await Promise.all(S),x.length<g){let e;const j=Math.pow(2,g-1-x.length),E=j*j*4;switch(i.type){case 0:e=new Uint8Array(E);break;case 2:e=new Uint16Array(E);break;case 1:e=new Float32Array(E)}for(let a=x.length;a<g;a++)for(let x=0;x<6;x++){var f;K._uploadArrayBufferViewToTexture((null===(f=z)||void 0===f?void 0:f.texture)||i,e,x,a)}}if(z){const x=i._irradianceTexture;i._irradianceTexture=null,K._releaseTexture(i),z._swapAndDie(i),i._irradianceTexture=x}M&&M.dispose(),o&&(i._lodTextureHigh&&i._lodTextureHigh._texture&&(i._lodTextureHigh._texture.isReady=!0),i._lodTextureMid&&i._lodTextureMid._texture&&(i._lodTextureMid._texture.isReady=!0),i._lodTextureLow&&i._lodTextureLow._texture&&(i._lodTextureLow._texture.isReady=!0))}function w(i,x){const e=(x=M(x)).irradiance;if(!e)return;const j=new Y.g;E.KJ.FromArrayToRef(e.x,0,j.x),E.KJ.FromArrayToRef(e.y,0,j.y),E.KJ.FromArrayToRef(e.z,0,j.z),E.KJ.FromArrayToRef(e.xx,0,j.xx),E.KJ.FromArrayToRef(e.yy,0,j.yy),E.KJ.FromArrayToRef(e.zz,0,j.zz),E.KJ.FromArrayToRef(e.yz,0,j.yz),E.KJ.FromArrayToRef(e.zx,0,j.zx),E.KJ.FromArrayToRef(e.xy,0,j.xy),i._sphericalPolynomial=j}function O(i,x,e,j,E){const a=V(i.getEngine().createRawCubeTexture(null,i.width,i.format,i.type,i.generateMipMaps,i.invertY,i.samplingMode,i._compression),x).then((()=>i));return i.onRebuildCallback=i=>({proxy:a,isReady:!0,isAsync:!0}),i._source=13,i._bufferViewArrayArray=x,i._lodGenerationScale=j,i._lodGenerationOffset=E,i._sphericalPolynomial=e,V(i,x).then((()=>(i.isReady=!0,i)))}}}]);