"use strict";(self.ozi0exxand9=self.ozi0exxand9||[]).push([[45],{13080:(f,v,Z)=>{Z.d(v,{e:()=>b,f:()=>K,j:()=>Y,k:()=>y});var V=Z(11230),h=Z(11421),J=Z(11440),l=Z(11599),e=Z(11360),C=Z(11446),H=(Z(11646),Z(11516)),O=Z(11247);Z(11903),Z(11621),Z(11908);const u="image/png",W=2,a=[134,22,135,150,246,214,150,54];function b(f){const v=new DataView(f.buffer,f.byteOffset,f.byteLength);let Z=0;for(let l=0;l<a.length;l++)if(v.getUint8(Z++)!==a[l])return O.e.Error("Not a babylon environment map"),null;let V="",h=0;for(;h=v.getUint8(Z++);)V+=String.fromCharCode(h);let J=JSON.parse(V);return J=X(J),J.binaryDataPosition=Z,J.FO&&(J.FO.lodGenerationScale=J.FO.lodGenerationScale||.8),J}function X(f){if(f.version>W)throw new Error(`Unsupported babylon environment map version "${f.version}". Latest supported version is "${W}".`);return 2===f.version?f:f={...f,version:2,imageType:u}}function F(f,v){const Z=(v=X(v)).FO;let V=Math.log2(v.width);if(V=Math.round(V)+1,Z.mipmaps.length!==6*V)throw new Error(`Unsupported specular mipmaps number "${Z.mipmaps.length}"`);const h=new Array(V);for(let J=0;J<V;J++){h[J]=new Array(6);for(let V=0;V<6;V++){const l=Z.mipmaps[6*J+V];h[J][V]=new Uint8Array(f.buffer,f.byteOffset+v.binaryDataPosition+l.position,l.length)}}return h}function U(f,v){var Z;v=X(v);const V=new Array(6),h=null===(Z=v.irradiance)||void 0===Z?void 0:Z.irradianceTexture;if(h){if(6!==h.faces.length)throw new Error(`Incorrect irradiance texture faces number "${h.faces.length}"`);for(let Z=0;Z<6;Z++){const J=h.faces[Z];V[Z]=new Uint8Array(f.buffer,f.byteOffset+v.binaryDataPosition+J.position,J.length)}}return V}function K(f,v,Z){var V;const J=(Z=X(Z)).FO;if(!J)return Promise.resolve([]);f._lodGenerationScale=J.lodGenerationScale;const l=[],e=F(v,Z);l.push(A(f,e,Z.imageType));const C=null===(V=Z.irradiance)||void 0===V?void 0:V.irradianceTexture;if(C){var H,O;const V=U(v,Z);let J=null;null!==(H=Z.irradiance)&&void 0!==H&&null!==(O=H.irradianceTexture)&&void 0!==O&&O.dominantDirection&&(J=h.Xv.Av(Z.irradiance.irradianceTexture.dominantDirection)),l.push(s(f,V,C.size,Z.imageType,J))}return Promise.all(l)}async function M(f,v,Z,V,h,J,l,e,C,H,O){return await new Promise(((u,W)=>{if(Z){const Z=v.createTexture(null,!0,!0,null,1,null,(f=>{W(f)}),f);null===V||void 0===V||V.onEffectCreatedObservable.addOnce((e=>{e.executeWhenCompiled((()=>{V.externalTextureSamplerBinding=!0,V.onApply=V=>{V._bindTexture("textureSampler",Z),V.setFloat2("scale",1,v._features.needsInvertingBitmap&&f instanceof ImageBitmap?-1:1)},v.scenes.length&&(v.scenes[0].postProcessManager.directRender([V],H,!0,J,l),v.restoreDefaultFramebuffer(),Z.dispose(),URL.revokeObjectURL(h),u())}))}))}else{if(v._uploadImageToTexture(O,f,J,l),e){const Z=C[l];Z&&v._uploadImageToTexture(Z._texture,f,J,0)}u()}}))}async function A(f,v){let Z=arguments.length>2&&void 0!==arguments[2]?arguments[2]:u;const V=f.getEngine();f.format=5,f.type=0,f.generateMipMaps=!0,f._cachedAnisotropicFilteringLevel=null,V.updateTextureSamplingMode(3,f),await z(f,v,!0,Z),f.isReady=!0}async function s(f,v,Z){let V=arguments.length>3&&void 0!==arguments[3]?arguments[3]:u,h=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const J=f.getEngine(),l=new e.c(J,5),H=new C.b(J,l);f._irradianceTexture=H,H._dominantDirection=h,l.isCube=!0,l.format=5,l.type=0,l.generateMipMaps=!0,l._cachedAnisotropicFilteringLevel=null,l.generateMipMaps=!0,l.width=Z,l.height=Z,J.updateTextureSamplingMode(3,l),await z(l,[v],!1,V),J.generateMipMapsForCubemap(l),l.isReady=!0}async function z(f,v,h){let l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:u;if(!V.Tools.IsExponentOfTwo(f.width))throw new Error("Texture size must be a power of two");const O=(0,J.ILog2)(f.width)+1,W=f.getEngine();let a=!1,b=!1,X=null,F=null,U=null;const K=W.getCaps();K.textureLOD?W._features.supportRenderAndCopyToLodForFloatTextures?K.textureHalfFloatRender&&K.textureHalfFloatLinearFiltering?(a=!0,f.type=2):K.textureFloatRender&&K.textureFloatLinearFiltering&&(a=!0,f.type=1):a=!1:(a=!1,b=h);let A=0;if(a)W.isWebGPU?(A=1,await Z.e(42).then(Z.bind(Z,14383))):await Z.e(35).then(Z.bind(Z,14389)),X=new H.d("rgbdDecode","rgbdDecode",null,null,1,null,3,W,!1,void 0,f.type,void 0,null,!1,void 0,A),f._isRGBD=!1,f.invertY=!1,F=W.createRenderTargetCubeTexture(f.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:f.type,format:5});else if(f._isRGBD=!0,f.invertY=!0,b){const v=3;U={};const Z=f._lodGenerationScale,V=f._lodGenerationOffset;for(let h=0;h<v;h++){const J=(O-1)*Z+V,l=V+(J-V)*(1-h/(v-1)),H=Math.round(Math.min(Math.max(l,0),J)),u=new e.c(W,2);u.isCube=!0,u.invertY=!0,u.generateMipMaps=!1,W.updateTextureSamplingMode(2,u);const a=new C.b(null);switch(a._isCube=!0,a._texture=u,U[H]=a,h){case 0:f._lodTextureLow=a;break;case 1:f._lodTextureMid=a;break;case 2:f._lodTextureHigh=a}}}const s=[];for(let Z=0;Z<v.length;Z++)for(let V=0;V<6;V++){const h=v[Z][V],J=new Blob([h],{type:l}),e=URL.createObjectURL(J);let C;if(W._features.forceBitmapOverHTMLImageElement)C=W.createImageBitmap(J,{premultiplyAlpha:"none"}).then((async v=>await M(v,W,a,X,e,V,Z,b,U,F,f)));else{const v=new Image;v.src=e,C=new Promise(((h,J)=>{v.onload=()=>{M(v,W,a,X,e,V,Z,b,U,F,f).then((()=>h())).catch((f=>{J(f)}))},v.onerror=f=>{J(f)}}))}s.push(C)}if(await Promise.all(s),v.length<O){let Z;const V=Math.pow(2,O-1-v.length),h=V*V*4;switch(f.type){case 0:Z=new Uint8Array(h);break;case 2:Z=new Uint16Array(h);break;case 1:Z=new Float32Array(h)}for(let J=v.length;J<O;J++)for(let v=0;v<6;v++){var z;W._uploadArrayBufferViewToTexture((null===(z=F)||void 0===z?void 0:z.texture)||f,Z,v,J)}}if(F){const v=f._irradianceTexture;f._irradianceTexture=null,W._releaseTexture(f),F._swapAndDie(f),f._irradianceTexture=v}X&&X.dispose(),b&&(f._lodTextureHigh&&f._lodTextureHigh._texture&&(f._lodTextureHigh._texture.isReady=!0),f._lodTextureMid&&f._lodTextureMid._texture&&(f._lodTextureMid._texture.isReady=!0),f._lodTextureLow&&f._lodTextureLow._texture&&(f._lodTextureLow._texture.isReady=!0))}function Y(f,v){const Z=(v=X(v)).irradiance;if(!Z)return;const V=new l.g;h.Xv.FromArrayToRef(Z.x,0,V.x),h.Xv.FromArrayToRef(Z.y,0,V.y),h.Xv.FromArrayToRef(Z.z,0,V.z),h.Xv.FromArrayToRef(Z.xx,0,V.xx),h.Xv.FromArrayToRef(Z.yy,0,V.yy),h.Xv.FromArrayToRef(Z.zz,0,V.zz),h.Xv.FromArrayToRef(Z.yz,0,V.yz),h.Xv.FromArrayToRef(Z.zx,0,V.zx),h.Xv.FromArrayToRef(Z.xy,0,V.xy),f._sphericalPolynomial=V}function y(f,v,Z,V,h){const J=A(f.getEngine().createRawCubeTexture(null,f.width,f.format,f.type,f.generateMipMaps,f.invertY,f.samplingMode,f._compression),v).then((()=>f));return f.onRebuildCallback=f=>({proxy:J,isReady:!0,isAsync:!0}),f._source=13,f._bufferViewArrayArray=v,f._lodGenerationScale=V,f._lodGenerationOffset=h,f._sphericalPolynomial=Z,A(f,v).then((()=>(f.isReady=!0,f)))}}}]);