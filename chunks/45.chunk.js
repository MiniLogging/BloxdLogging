"use strict";(self.gpkvekif0vo=self.gpkvekif0vo||[]).push([[45],{14078:(a,O,i)=>{i.d(O,{e:()=>Z,f:()=>ma,i:()=>U,k:()=>y});var H=i(12184),b=i(12395),G=i(12412),q=i(12593),Q=i(12317),k=i(12417),I=(i(12648),i(12496)),P=i(12209);i(12895),i(12631),i(12910);const e="image/png",h=2,j=[134,22,135,150,246,214,150,54];function Z(a){const O=new DataView(a.buffer,a.byteOffset,a.byteLength);let i=0;for(let q=0;q<j.length;q++)if(O.getUint8(i++)!==j[q])return P.c.Error("Not a babylon environment map"),null;let H="",b=0;for(;b=O.getUint8(i++);)H+=String.fromCharCode(b);let G=JSON.parse(H);return G=F(G),G.binaryDataPosition=i,G.DP&&(G.DP.lodGenerationScale=G.DP.lodGenerationScale||.8),G}function F(a){if(a.version>h)throw new Error(`Unsupported babylon environment map version "${a.version}". Latest supported version is "${h}".`);return 2===a.version?a:a={...a,version:2,imageType:e}}function r(a,O){const i=(O=F(O)).DP;let H=Math.log2(O.width);if(H=Math.round(H)+1,i.mipmaps.length!==6*H)throw new Error(`Unsupported specular mipmaps number "${i.mipmaps.length}"`);const b=new Array(H);for(let G=0;G<H;G++){b[G]=new Array(6);for(let H=0;H<6;H++){const q=i.mipmaps[6*G+H];b[G][H]=new Uint8Array(a.buffer,a.byteOffset+O.binaryDataPosition+q.position,q.length)}}return b}function J(a,O){var i;O=F(O);const H=new Array(6),b=null===(i=O.irradiance)||void 0===i?void 0:i.irradianceTexture;if(b){if(6!==b.faces.length)throw new Error(`Incorrect irradiance texture faces number "${b.faces.length}"`);for(let i=0;i<6;i++){const G=b.faces[i];H[i]=new Uint8Array(a.buffer,a.byteOffset+O.binaryDataPosition+G.position,G.length)}}return H}function ma(a,O,i){var H;const G=(i=F(i)).DP;if(!G)return Promise.resolve([]);a._lodGenerationScale=G.lodGenerationScale;const q=[],Q=r(O,i);q.push(C(a,Q,i.imageType));const k=null===(H=i.irradiance)||void 0===H?void 0:H.irradianceTexture;if(k){var I,P;const H=J(O,i);let G=null;null!==(I=i.irradiance)&&void 0!==I&&null!==(P=I.irradianceTexture)&&void 0!==P&&P.dominantDirection&&(G=b.ZO.MO(i.irradiance.irradianceTexture.dominantDirection)),q.push(n(a,H,k.size,i.imageType,G))}return Promise.all(q)}async function M(a,O,i,H,b,G,q,Q,k,I,P){return await new Promise(((e,h)=>{if(i){const i=O.createTexture(null,!0,!0,null,1,null,(a=>{h(a)}),a);null===H||void 0===H||H.onEffectCreatedObservable.addOnce((Q=>{Q.executeWhenCompiled((()=>{H.externalTextureSamplerBinding=!0,H.onApply=H=>{H._bindTexture("textureSampler",i),H.setFloat2("scale",1,O._features.needsInvertingBitmap&&a instanceof ImageBitmap?-1:1)},O.scenes.length&&(O.scenes[0].postProcessManager.directRender([H],I,!0,G,q),O.restoreDefaultFramebuffer(),i.dispose(),URL.revokeObjectURL(b),e())}))}))}else{if(O._uploadImageToTexture(P,a,G,q),Q){const i=k[q];i&&O._uploadImageToTexture(i._texture,a,G,0)}e()}}))}async function C(a,O){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e;const H=a.getEngine();a.format=5,a.type=0,a.generateMipMaps=!0,a._cachedAnisotropicFilteringLevel=null,H.updateTextureSamplingMode(3,a),await D(a,O,!0,i),a.isReady=!0}async function n(a,O,i){let H=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e,b=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const G=a.getEngine(),q=new Q.c(G,5),I=new k.c(G,q);a._irradianceTexture=I,I._dominantDirection=b,q.isCube=!0,q.format=5,q.type=0,q.generateMipMaps=!0,q._cachedAnisotropicFilteringLevel=null,q.generateMipMaps=!0,q.width=i,q.height=i,G.updateTextureSamplingMode(3,q),await D(q,[O],!1,H),G.generateMipMapsForCubemap(q),q.isReady=!0}async function D(a,O,b){let q=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e;if(!H.Tools.IsExponentOfTwo(a.width))throw new Error("Texture size must be a power of two");const P=(0,G.ILog2)(a.width)+1,h=a.getEngine();let j=!1,Z=!1,F=null,r=null,J=null;const ma=h.getCaps();ma.textureLOD?h._features.supportRenderAndCopyToLodForFloatTextures?ma.textureHalfFloatRender&&ma.textureHalfFloatLinearFiltering?(j=!0,a.type=2):ma.textureFloatRender&&ma.textureFloatLinearFiltering&&(j=!0,a.type=1):j=!1:(j=!1,Z=b);let C=0;if(j)h.isWebGPU?(C=1,await i.e(42).then(i.bind(i,15439))):await i.e(35).then(i.bind(i,15443)),F=new I.e("rgbdDecode","rgbdDecode",null,null,1,null,3,h,!1,void 0,a.type,void 0,null,!1,void 0,C),a._isRGBD=!1,a.invertY=!1,r=h.createRenderTargetCubeTexture(a.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:a.type,format:5});else if(a._isRGBD=!0,a.invertY=!0,Z){const O=3;J={};const i=a._lodGenerationScale,H=a._lodGenerationOffset;for(let b=0;b<O;b++){const G=(P-1)*i+H,q=H+(G-H)*(1-b/(O-1)),I=Math.round(Math.min(Math.max(q,0),G)),e=new Q.c(h,2);e.isCube=!0,e.invertY=!0,e.generateMipMaps=!1,h.updateTextureSamplingMode(2,e);const j=new k.c(null);switch(j._isCube=!0,j._texture=e,J[I]=j,b){case 0:a._lodTextureLow=j;break;case 1:a._lodTextureMid=j;break;case 2:a._lodTextureHigh=j}}}const n=[];for(let i=0;i<O.length;i++)for(let H=0;H<6;H++){const b=O[i][H],G=new Blob([b],{type:q}),Q=URL.createObjectURL(G);let k;if(h._features.forceBitmapOverHTMLImageElement)k=h.createImageBitmap(G,{premultiplyAlpha:"none"}).then((async O=>await M(O,h,j,F,Q,H,i,Z,J,r,a)));else{const O=new Image;O.src=Q,k=new Promise(((b,G)=>{O.onload=()=>{M(O,h,j,F,Q,H,i,Z,J,r,a).then((()=>b())).catch((a=>{G(a)}))},O.onerror=a=>{G(a)}}))}n.push(k)}if(await Promise.all(n),O.length<P){let i;const H=Math.pow(2,P-1-O.length),b=H*H*4;switch(a.type){case 0:i=new Uint8Array(b);break;case 2:i=new Uint16Array(b);break;case 1:i=new Float32Array(b)}for(let G=O.length;G<P;G++)for(let O=0;O<6;O++){var D;h._uploadArrayBufferViewToTexture((null===(D=r)||void 0===D?void 0:D.texture)||a,i,O,G)}}if(r){const O=a._irradianceTexture;a._irradianceTexture=null,h._releaseTexture(a),r._swapAndDie(a),a._irradianceTexture=O}F&&F.dispose(),Z&&(a._lodTextureHigh&&a._lodTextureHigh._texture&&(a._lodTextureHigh._texture.isReady=!0),a._lodTextureMid&&a._lodTextureMid._texture&&(a._lodTextureMid._texture.isReady=!0),a._lodTextureLow&&a._lodTextureLow._texture&&(a._lodTextureLow._texture.isReady=!0))}function U(a,O){const i=(O=F(O)).irradiance;if(!i)return;const H=new q.d;b.ZO.FromArrayToRef(i.x,0,H.x),b.ZO.FromArrayToRef(i.y,0,H.y),b.ZO.FromArrayToRef(i.z,0,H.z),b.ZO.FromArrayToRef(i.xx,0,H.xx),b.ZO.FromArrayToRef(i.yy,0,H.yy),b.ZO.FromArrayToRef(i.zz,0,H.zz),b.ZO.FromArrayToRef(i.yz,0,H.yz),b.ZO.FromArrayToRef(i.zx,0,H.zx),b.ZO.FromArrayToRef(i.xy,0,H.xy),a._sphericalPolynomial=H}function y(a,O,i,H,b){const G=C(a.getEngine().createRawCubeTexture(null,a.width,a.format,a.type,a.generateMipMaps,a.invertY,a.samplingMode,a._compression),O).then((()=>a));return a.onRebuildCallback=a=>({proxy:G,isReady:!0,isAsync:!0}),a._source=13,a._bufferViewArrayArray=O,a._lodGenerationScale=H,a._lodGenerationOffset=b,a._sphericalPolynomial=i,C(a,O).then((()=>(a.isReady=!0,a)))}}}]);