"use strict";(self.zjjkhojdx1=self.zjjkhojdx1||[]).push([[45],{12900:(k,h,o)=>{o.d(h,{d:()=>X,e:()=>M,i:()=>V,l:()=>i});var x=o(11078),I=o(11239),q=o(11260),Y=o(11428),J=o(11180),G=o(11266),l=(o(11472),o(11335)),A=o(11098);o(11759),o(11456),o(11772);const K="image/png",a=2,N=[134,22,135,150,246,214,150,54];function X(k){const h=new DataView(k.buffer,k.byteOffset,k.byteLength);let o=0;for(let Y=0;Y<N.length;Y++)if(h.getUint8(o++)!==N[Y])return A.c.Error("Not a babylon environment map"),null;let x="",I=0;for(;I=h.getUint8(o++);)x+=String.fromCharCode(I);let q=JSON.parse(x);return q=c(q),q.binaryDataPosition=o,q.cA&&(q.cA.lodGenerationScale=q.cA.lodGenerationScale||.8),q}function c(k){if(k.version>a)throw new Error(`Unsupported babylon environment map version "${k.version}". Latest supported version is "${a}".`);return 2===k.version?k:k={...k,version:2,imageType:K}}function W(k,h){const o=(h=c(h)).cA;let x=Math.log2(h.width);if(x=Math.round(x)+1,o.mipmaps.length!==6*x)throw new Error(`Unsupported specular mipmaps number "${o.mipmaps.length}"`);const I=new Array(x);for(let q=0;q<x;q++){I[q]=new Array(6);for(let x=0;x<6;x++){const Y=o.mipmaps[6*q+x];I[q][x]=new Uint8Array(k.buffer,k.byteOffset+h.binaryDataPosition+Y.position,Y.length)}}return I}function f(k,h){var o;h=c(h);const x=new Array(6),I=null===(o=h.irradiance)||void 0===o?void 0:o.irradianceTexture;if(I){if(6!==I.faces.length)throw new Error(`Incorrect irradiance texture faces number "${I.faces.length}"`);for(let o=0;o<6;o++){const q=I.faces[o];x[o]=new Uint8Array(k.buffer,k.byteOffset+h.binaryDataPosition+q.position,q.length)}}return x}function M(k,h,o){var x;const q=(o=c(o)).cA;if(!q)return Promise.resolve([]);k._lodGenerationScale=q.lodGenerationScale;const Y=[],J=W(h,o);Y.push(j(k,J,o.imageType));const G=null===(x=o.irradiance)||void 0===x?void 0:x.irradianceTexture;if(G){var l,A;const x=f(h,o);let q=null;null!==(l=o.irradiance)&&void 0!==l&&null!==(A=l.irradianceTexture)&&void 0!==A&&A.dominantDirection&&(q=I.Vh.Uh(o.irradiance.irradianceTexture.dominantDirection)),Y.push(d(k,x,G.size,o.imageType,q))}return Promise.all(Y)}async function T(k,h,o,x,I,q,Y,J,G,l,A){return await new Promise(((K,a)=>{if(o){const o=h.createTexture(null,!0,!0,null,1,null,(k=>{a(k)}),k);null===x||void 0===x||x.onEffectCreatedObservable.addOnce((J=>{J.executeWhenCompiled((()=>{x.externalTextureSamplerBinding=!0,x.onApply=x=>{x._bindTexture("textureSampler",o),x.setFloat2("scale",1,h._features.needsInvertingBitmap&&k instanceof ImageBitmap?-1:1)},h.scenes.length&&(h.scenes[0].postProcessManager.directRender([x],l,!0,q,Y),h.restoreDefaultFramebuffer(),o.dispose(),URL.revokeObjectURL(I),K())}))}))}else{if(h._uploadImageToTexture(A,k,q,Y),J){const o=G[Y];o&&h._uploadImageToTexture(o._texture,k,q,0)}K()}}))}async function j(k,h){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:K;const x=k.getEngine();k.format=5,k.type=0,k.generateMipMaps=!0,k._cachedAnisotropicFilteringLevel=null,x.updateTextureSamplingMode(3,k),await b(k,h,!0,o),k.isReady=!0}async function d(k,h,o){let x=arguments.length>3&&void 0!==arguments[3]?arguments[3]:K,I=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const q=k.getEngine(),Y=new J.c(q,5),l=new G.c(q,Y);k._irradianceTexture=l,l._dominantDirection=I,Y.isCube=!0,Y.format=5,Y.type=0,Y.generateMipMaps=!0,Y._cachedAnisotropicFilteringLevel=null,Y.generateMipMaps=!0,Y.width=o,Y.height=o,q.updateTextureSamplingMode(3,Y),await b(Y,[h],!1,x),q.generateMipMapsForCubemap(Y),Y.isReady=!0}async function b(k,h,I){let Y=arguments.length>3&&void 0!==arguments[3]?arguments[3]:K;if(!x.Tools.IsExponentOfTwo(k.width))throw new Error("Texture size must be a power of two");const A=(0,q.ILog2)(k.width)+1,a=k.getEngine();let N=!1,X=!1,c=null,W=null,f=null;const M=a.getCaps();M.textureLOD?a._features.supportRenderAndCopyToLodForFloatTextures?M.textureHalfFloatRender&&M.textureHalfFloatLinearFiltering?(N=!0,k.type=2):M.textureFloatRender&&M.textureFloatLinearFiltering&&(N=!0,k.type=1):N=!1:(N=!1,X=I);let j=0;if(N)a.isWebGPU?(j=1,await o.e(42).then(o.bind(o,14240))):await o.e(35).then(o.bind(o,14242)),c=new l.b("rgbdDecode","rgbdDecode",null,null,1,null,3,a,!1,void 0,k.type,void 0,null,!1,void 0,j),k._isRGBD=!1,k.invertY=!1,W=a.createRenderTargetCubeTexture(k.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:k.type,format:5});else if(k._isRGBD=!0,k.invertY=!0,X){const h=3;f={};const o=k._lodGenerationScale,x=k._lodGenerationOffset;for(let I=0;I<h;I++){const q=(A-1)*o+x,Y=x+(q-x)*(1-I/(h-1)),l=Math.round(Math.min(Math.max(Y,0),q)),K=new J.c(a,2);K.isCube=!0,K.invertY=!0,K.generateMipMaps=!1,a.updateTextureSamplingMode(2,K);const N=new G.c(null);switch(N._isCube=!0,N._texture=K,f[l]=N,I){case 0:k._lodTextureLow=N;break;case 1:k._lodTextureMid=N;break;case 2:k._lodTextureHigh=N}}}const d=[];for(let o=0;o<h.length;o++)for(let x=0;x<6;x++){const I=h[o][x],q=new Blob([I],{type:Y}),J=URL.createObjectURL(q);let G;if(a._features.forceBitmapOverHTMLImageElement)G=a.createImageBitmap(q,{premultiplyAlpha:"none"}).then((async h=>await T(h,a,N,c,J,x,o,X,f,W,k)));else{const h=new Image;h.src=J,G=new Promise(((I,q)=>{h.onload=()=>{T(h,a,N,c,J,x,o,X,f,W,k).then((()=>I())).catch((k=>{q(k)}))},h.onerror=k=>{q(k)}}))}d.push(G)}if(await Promise.all(d),h.length<A){let o;const x=Math.pow(2,A-1-h.length),I=x*x*4;switch(k.type){case 0:o=new Uint8Array(I);break;case 2:o=new Uint16Array(I);break;case 1:o=new Float32Array(I)}for(let q=h.length;q<A;q++)for(let h=0;h<6;h++){var b;a._uploadArrayBufferViewToTexture((null===(b=W)||void 0===b?void 0:b.texture)||k,o,h,q)}}if(W){const h=k._irradianceTexture;k._irradianceTexture=null,a._releaseTexture(k),W._swapAndDie(k),k._irradianceTexture=h}c&&c.dispose(),X&&(k._lodTextureHigh&&k._lodTextureHigh._texture&&(k._lodTextureHigh._texture.isReady=!0),k._lodTextureMid&&k._lodTextureMid._texture&&(k._lodTextureMid._texture.isReady=!0),k._lodTextureLow&&k._lodTextureLow._texture&&(k._lodTextureLow._texture.isReady=!0))}function V(k,h){const o=(h=c(h)).irradiance;if(!o)return;const x=new Y.e;I.Vh.FromArrayToRef(o.x,0,x.x),I.Vh.FromArrayToRef(o.y,0,x.y),I.Vh.FromArrayToRef(o.z,0,x.z),I.Vh.FromArrayToRef(o.xx,0,x.xx),I.Vh.FromArrayToRef(o.yy,0,x.yy),I.Vh.FromArrayToRef(o.zz,0,x.zz),I.Vh.FromArrayToRef(o.yz,0,x.yz),I.Vh.FromArrayToRef(o.zx,0,x.zx),I.Vh.FromArrayToRef(o.xy,0,x.xy),k._sphericalPolynomial=x}function i(k,h,o,x,I){const q=j(k.getEngine().createRawCubeTexture(null,k.width,k.format,k.type,k.generateMipMaps,k.invertY,k.samplingMode,k._compression),h).then((()=>k));return k.onRebuildCallback=k=>({proxy:q,isReady:!0,isAsync:!0}),k._source=13,k._bufferViewArrayArray=h,k._lodGenerationScale=x,k._lodGenerationOffset=I,k._sphericalPolynomial=o,j(k,h).then((()=>(k.isReady=!0,k)))}}}]);