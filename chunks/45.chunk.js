"use strict";(self.nyfa010khv=self.nyfa010khv||[]).push([[45],{13814:(L,r,p)=>{p.d(r,{c:()=>g,d:()=>O,f:()=>F,g:()=>Q});var J=p(11957),i=p(12136),n=p(12154),j=p(12299),z=p(12060),G=p(12156),C=(p(12355),p(12228)),t=p(11975);p(12625),p(12336),p(12634);const E="image/png",x=2,w=[134,22,135,150,246,214,150,54];function g(L){const r=new DataView(L.buffer,L.byteOffset,L.byteLength);let p=0;for(let j=0;j<w.length;j++)if(r.getUint8(p++)!==w[j])return t.d.Error("Not a babylon environment map"),null;let J="",i=0;for(;i=r.getUint8(p++);)J+=String.fromCharCode(i);let n=JSON.parse(J);return n=b(n),n.binaryDataPosition=p,n.gt&&(n.gt.lodGenerationScale=n.gt.lodGenerationScale||.8),n}function b(L){if(L.version>x)throw new Error(`Unsupported babylon environment map version "${L.version}". Latest supported version is "${x}".`);return 2===L.version?L:L={...L,version:2,imageType:E}}function c(L,r){const p=(r=b(r)).gt;let J=Math.log2(r.width);if(J=Math.round(J)+1,p.mipmaps.length!==6*J)throw new Error(`Unsupported specular mipmaps number "${p.mipmaps.length}"`);const i=new Array(J);for(let n=0;n<J;n++){i[n]=new Array(6);for(let J=0;J<6;J++){const j=p.mipmaps[6*n+J];i[n][J]=new Uint8Array(L.buffer,L.byteOffset+r.binaryDataPosition+j.position,j.length)}}return i}function P(L,r){var p;r=b(r);const J=new Array(6),i=null===(p=r.irradiance)||void 0===p?void 0:p.irradianceTexture;if(i){if(6!==i.faces.length)throw new Error(`Incorrect irradiance texture faces number "${i.faces.length}"`);for(let p=0;p<6;p++){const n=i.faces[p];J[p]=new Uint8Array(L.buffer,L.byteOffset+r.binaryDataPosition+n.position,n.length)}}return J}function O(L,r,p){var J;const n=(p=b(p)).gt;if(!n)return Promise.resolve([]);L._lodGenerationScale=n.lodGenerationScale;const j=[],z=c(r,p);j.push(U(L,z,p.imageType));const G=null===(J=p.irradiance)||void 0===J?void 0:J.irradianceTexture;if(G){var C,t;const J=P(r,p);let n=null;null!==(C=p.irradiance)&&void 0!==C&&null!==(t=C.irradianceTexture)&&void 0!==t&&t.dominantDirection&&(n=i.cr.Br(p.irradiance.irradianceTexture.dominantDirection)),j.push(W(L,J,G.size,p.imageType,n))}return Promise.all(j)}async function h(L,r,p,J,i,n,j,z,G,C,t){return await new Promise(((E,x)=>{if(p){const p=r.createTexture(null,!0,!0,null,1,null,(L=>{x(L)}),L);null===J||void 0===J||J.onEffectCreatedObservable.addOnce((z=>{z.executeWhenCompiled((()=>{J.externalTextureSamplerBinding=!0,J.onApply=J=>{J._bindTexture("textureSampler",p),J.setFloat2("scale",1,r._features.needsInvertingBitmap&&L instanceof ImageBitmap?-1:1)},r.scenes.length&&(r.scenes[0].postProcessManager.directRender([J],C,!0,n,j),r.restoreDefaultFramebuffer(),p.dispose(),URL.revokeObjectURL(i),E())}))}))}else{if(r._uploadImageToTexture(t,L,n,j),z){const p=G[j];p&&r._uploadImageToTexture(p._texture,L,n,0)}E()}}))}async function U(L,r){let p=arguments.length>2&&void 0!==arguments[2]?arguments[2]:E;const J=L.getEngine();L.format=5,L.type=0,L.generateMipMaps=!0,L._cachedAnisotropicFilteringLevel=null,J.updateTextureSamplingMode(3,L),await B(L,r,!0,p),L.isReady=!0}async function W(L,r,p){let J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:E,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const n=L.getEngine(),j=new z.b(n,5),C=new G.e(n,j);L._irradianceTexture=C,C._dominantDirection=i,j.isCube=!0,j.format=5,j.type=0,j.generateMipMaps=!0,j._cachedAnisotropicFilteringLevel=null,j.generateMipMaps=!0,j.width=p,j.height=p,n.updateTextureSamplingMode(3,j),await B(j,[r],!1,J),n.generateMipMapsForCubemap(j),j.isReady=!0}async function B(L,r,i){let j=arguments.length>3&&void 0!==arguments[3]?arguments[3]:E;if(!J.Tools.IsExponentOfTwo(L.width))throw new Error("Texture size must be a power of two");const t=(0,n.ILog2)(L.width)+1,x=L.getEngine();let w=!1,g=!1,b=null,c=null,P=null;const O=x.getCaps();O.textureLOD?x._features.supportRenderAndCopyToLodForFloatTextures?O.textureHalfFloatRender&&O.textureHalfFloatLinearFiltering?(w=!0,L.type=2):O.textureFloatRender&&O.textureFloatLinearFiltering&&(w=!0,L.type=1):w=!1:(w=!1,g=i);let U=0;if(w)x.isWebGPU?(U=1,await p.e(42).then(p.bind(p,15142))):await p.e(35).then(p.bind(p,15149)),b=new C.d("rgbdDecode","rgbdDecode",null,null,1,null,3,x,!1,void 0,L.type,void 0,null,!1,void 0,U),L._isRGBD=!1,L.invertY=!1,c=x.createRenderTargetCubeTexture(L.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:L.type,format:5});else if(L._isRGBD=!0,L.invertY=!0,g){const r=3;P={};const p=L._lodGenerationScale,J=L._lodGenerationOffset;for(let i=0;i<r;i++){const n=(t-1)*p+J,j=J+(n-J)*(1-i/(r-1)),C=Math.round(Math.min(Math.max(j,0),n)),E=new z.b(x,2);E.isCube=!0,E.invertY=!0,E.generateMipMaps=!1,x.updateTextureSamplingMode(2,E);const w=new G.e(null);switch(w._isCube=!0,w._texture=E,P[C]=w,i){case 0:L._lodTextureLow=w;break;case 1:L._lodTextureMid=w;break;case 2:L._lodTextureHigh=w}}}const W=[];for(let p=0;p<r.length;p++)for(let J=0;J<6;J++){const i=r[p][J],n=new Blob([i],{type:j}),z=URL.createObjectURL(n);let G;if(x._features.forceBitmapOverHTMLImageElement)G=x.createImageBitmap(n,{premultiplyAlpha:"none"}).then((async r=>await h(r,x,w,b,z,J,p,g,P,c,L)));else{const r=new Image;r.src=z,G=new Promise(((i,n)=>{r.onload=()=>{h(r,x,w,b,z,J,p,g,P,c,L).then((()=>i())).catch((L=>{n(L)}))},r.onerror=L=>{n(L)}}))}W.push(G)}if(await Promise.all(W),r.length<t){let p;const J=Math.pow(2,t-1-r.length),i=J*J*4;switch(L.type){case 0:p=new Uint8Array(i);break;case 2:p=new Uint16Array(i);break;case 1:p=new Float32Array(i)}for(let n=r.length;n<t;n++)for(let r=0;r<6;r++){var B;x._uploadArrayBufferViewToTexture((null===(B=c)||void 0===B?void 0:B.texture)||L,p,r,n)}}if(c){const r=L._irradianceTexture;L._irradianceTexture=null,x._releaseTexture(L),c._swapAndDie(L),L._irradianceTexture=r}b&&b.dispose(),g&&(L._lodTextureHigh&&L._lodTextureHigh._texture&&(L._lodTextureHigh._texture.isReady=!0),L._lodTextureMid&&L._lodTextureMid._texture&&(L._lodTextureMid._texture.isReady=!0),L._lodTextureLow&&L._lodTextureLow._texture&&(L._lodTextureLow._texture.isReady=!0))}function F(L,r){const p=(r=b(r)).irradiance;if(!p)return;const J=new j.h;i.cr.FromArrayToRef(p.x,0,J.x),i.cr.FromArrayToRef(p.y,0,J.y),i.cr.FromArrayToRef(p.z,0,J.z),i.cr.FromArrayToRef(p.xx,0,J.xx),i.cr.FromArrayToRef(p.yy,0,J.yy),i.cr.FromArrayToRef(p.zz,0,J.zz),i.cr.FromArrayToRef(p.yz,0,J.yz),i.cr.FromArrayToRef(p.zx,0,J.zx),i.cr.FromArrayToRef(p.xy,0,J.xy),L._sphericalPolynomial=J}function Q(L,r,p,J,i){const n=U(L.getEngine().createRawCubeTexture(null,L.width,L.format,L.type,L.generateMipMaps,L.invertY,L.samplingMode,L._compression),r).then((()=>L));return L.onRebuildCallback=L=>({proxy:n,isReady:!0,isAsync:!0}),L._source=13,L._bufferViewArrayArray=r,L._lodGenerationScale=J,L._lodGenerationOffset=i,L._sphericalPolynomial=p,U(L,r).then((()=>(L.isReady=!0,L)))}}}]);