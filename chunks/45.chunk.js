"use strict";(self["9s4i8ue3jq"]=self["9s4i8ue3jq"]||[]).push([[45],{14353:(a,c,o)=>{o.d(c,{c:()=>g,d:()=>k,e:()=>Z,g:()=>h});var s=o(12637),q=o(12810),t=o(12824),i=o(12993),p=o(12757),G=o(12833),T=(o(13045),o(12904)),C=o(12649);o(13293),o(13027),o(13305);const j="image/png",L=2,e=[134,22,135,150,246,214,150,54];function g(a){const c=new DataView(a.buffer,a.byteOffset,a.byteLength);let o=0;for(let i=0;i<e.length;i++)if(c.getUint8(o++)!==e[i])return C.c.Error("Not a babylon environment map"),null;let s="",q=0;for(;q=c.getUint8(o++);)s+=String.fromCharCode(q);let t=JSON.parse(s);return t=M(t),t.binaryDataPosition=o,t.ij&&(t.ij.lodGenerationScale=t.ij.lodGenerationScale||.8),t}function M(a){if(a.version>L)throw new Error(`Unsupported babylon environment map version "${a.version}". Latest supported version is "${L}".`);return 2===a.version?a:a={...a,version:2,imageType:j}}function N(a,c){const o=(c=M(c)).ij;let s=Math.log2(c.width);if(s=Math.round(s)+1,o.mipmaps.length!==6*s)throw new Error(`Unsupported specular mipmaps number "${o.mipmaps.length}"`);const q=new Array(s);for(let t=0;t<s;t++){q[t]=new Array(6);for(let s=0;s<6;s++){const i=o.mipmaps[6*t+s];q[t][s]=new Uint8Array(a.buffer,a.byteOffset+c.binaryDataPosition+i.position,i.length)}}return q}function y(a,c){var o;c=M(c);const s=new Array(6),q=null===(o=c.irradiance)||void 0===o?void 0:o.irradianceTexture;if(q){if(6!==q.faces.length)throw new Error(`Incorrect irradiance texture faces number "${q.faces.length}"`);for(let o=0;o<6;o++){const t=q.faces[o];s[o]=new Uint8Array(a.buffer,a.byteOffset+c.binaryDataPosition+t.position,t.length)}}return s}function k(a,c,o){var s;const t=(o=M(o)).ij;if(!t)return Promise.resolve([]);a._lodGenerationScale=t.lodGenerationScale;const i=[],p=N(c,o);i.push(f(a,p,o.imageType));const G=null===(s=o.irradiance)||void 0===s?void 0:s.irradianceTexture;if(G){var T,C;const s=y(c,o);let t=null;null!==(T=o.irradiance)&&void 0!==T&&null!==(C=T.irradianceTexture)&&void 0!==C&&C.dominantDirection&&(t=q.Hc.qo(o.irradiance.irradianceTexture.dominantDirection)),i.push(J(a,s,G.size,o.imageType,t))}return Promise.all(i)}async function n(a,c,o,s,q,t,i,p,G,T,C){return await new Promise(((j,L)=>{if(o){const o=c.createTexture(null,!0,!0,null,1,null,(a=>{L(a)}),a);null===s||void 0===s||s.onEffectCreatedObservable.addOnce((p=>{p.executeWhenCompiled((()=>{s.externalTextureSamplerBinding=!0,s.onApply=s=>{s._bindTexture("textureSampler",o),s.setFloat2("scale",1,c._features.needsInvertingBitmap&&a instanceof ImageBitmap?-1:1)},c.scenes.length&&(c.scenes[0].postProcessManager.directRender([s],T,!0,t,i),c.restoreDefaultFramebuffer(),o.dispose(),URL.revokeObjectURL(q),j())}))}))}else{if(c._uploadImageToTexture(C,a,t,i),p){const o=G[i];o&&c._uploadImageToTexture(o._texture,a,t,0)}j()}}))}async function f(a,c){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:j;const s=a.getEngine();a.format=5,a.type=0,a.generateMipMaps=!0,a._cachedAnisotropicFilteringLevel=null,s.updateTextureSamplingMode(3,a),await w(a,c,!0,o),a.isReady=!0}async function J(a,c,o){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:j,q=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const t=a.getEngine(),i=new p.b(t,5),T=new G.e(t,i);a._irradianceTexture=T,T._dominantDirection=q,i.isCube=!0,i.format=5,i.type=0,i.generateMipMaps=!0,i._cachedAnisotropicFilteringLevel=null,i.generateMipMaps=!0,i.width=o,i.height=o,t.updateTextureSamplingMode(3,i),await w(i,[c],!1,s),t.generateMipMapsForCubemap(i),i.isReady=!0}async function w(a,c,q){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:j;if(!s.Tools.IsExponentOfTwo(a.width))throw new Error("Texture size must be a power of two");const C=(0,t.ILog2)(a.width)+1,L=a.getEngine();let e=!1,g=!1,M=null,N=null,y=null;const k=L.getCaps();k.textureLOD?L._features.supportRenderAndCopyToLodForFloatTextures?k.textureHalfFloatRender&&k.textureHalfFloatLinearFiltering?(e=!0,a.type=2):k.textureFloatRender&&k.textureFloatLinearFiltering&&(e=!0,a.type=1):e=!1:(e=!1,g=q);let f=0;if(e)L.isWebGPU?(f=1,await o.e(42).then(o.bind(o,15810))):await o.e(35).then(o.bind(o,15812)),M=new T.c("rgbdDecode","rgbdDecode",null,null,1,null,3,L,!1,void 0,a.type,void 0,null,!1,void 0,f),a._isRGBD=!1,a.invertY=!1,N=L.createRenderTargetCubeTexture(a.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:a.type,format:5});else if(a._isRGBD=!0,a.invertY=!0,g){const c=3;y={};const o=a._lodGenerationScale,s=a._lodGenerationOffset;for(let q=0;q<c;q++){const t=(C-1)*o+s,i=s+(t-s)*(1-q/(c-1)),T=Math.round(Math.min(Math.max(i,0),t)),j=new p.b(L,2);j.isCube=!0,j.invertY=!0,j.generateMipMaps=!1,L.updateTextureSamplingMode(2,j);const e=new G.e(null);switch(e._isCube=!0,e._texture=j,y[T]=e,q){case 0:a._lodTextureLow=e;break;case 1:a._lodTextureMid=e;break;case 2:a._lodTextureHigh=e}}}const J=[];for(let o=0;o<c.length;o++)for(let s=0;s<6;s++){const q=c[o][s],t=new Blob([q],{type:i}),p=URL.createObjectURL(t);let G;if(L._features.forceBitmapOverHTMLImageElement)G=L.createImageBitmap(t,{premultiplyAlpha:"none"}).then((async c=>await n(c,L,e,M,p,s,o,g,y,N,a)));else{const c=new Image;c.src=p,G=new Promise(((q,t)=>{c.onload=()=>{n(c,L,e,M,p,s,o,g,y,N,a).then((()=>q())).catch((a=>{t(a)}))},c.onerror=a=>{t(a)}}))}J.push(G)}if(await Promise.all(J),c.length<C){let o;const s=Math.pow(2,C-1-c.length),q=s*s*4;switch(a.type){case 0:o=new Uint8Array(q);break;case 2:o=new Uint16Array(q);break;case 1:o=new Float32Array(q)}for(let t=c.length;t<C;t++)for(let c=0;c<6;c++){var w;L._uploadArrayBufferViewToTexture((null===(w=N)||void 0===w?void 0:w.texture)||a,o,c,t)}}if(N){const c=a._irradianceTexture;a._irradianceTexture=null,L._releaseTexture(a),N._swapAndDie(a),a._irradianceTexture=c}M&&M.dispose(),g&&(a._lodTextureHigh&&a._lodTextureHigh._texture&&(a._lodTextureHigh._texture.isReady=!0),a._lodTextureMid&&a._lodTextureMid._texture&&(a._lodTextureMid._texture.isReady=!0),a._lodTextureLow&&a._lodTextureLow._texture&&(a._lodTextureLow._texture.isReady=!0))}function Z(a,c){const o=(c=M(c)).irradiance;if(!o)return;const s=new i.e;q.Hc.FromArrayToRef(o.x,0,s.x),q.Hc.FromArrayToRef(o.y,0,s.y),q.Hc.FromArrayToRef(o.z,0,s.z),q.Hc.FromArrayToRef(o.xx,0,s.xx),q.Hc.FromArrayToRef(o.yy,0,s.yy),q.Hc.FromArrayToRef(o.zz,0,s.zz),q.Hc.FromArrayToRef(o.yz,0,s.yz),q.Hc.FromArrayToRef(o.zx,0,s.zx),q.Hc.FromArrayToRef(o.xy,0,s.xy),a._sphericalPolynomial=s}function h(a,c,o,s,q){const t=f(a.getEngine().createRawCubeTexture(null,a.width,a.format,a.type,a.generateMipMaps,a.invertY,a.samplingMode,a._compression),c).then((()=>a));return a.onRebuildCallback=a=>({proxy:t,isReady:!0,isAsync:!0}),a._source=13,a._bufferViewArrayArray=c,a._lodGenerationScale=s,a._lodGenerationOffset=q,a._sphericalPolynomial=o,f(a,c).then((()=>(a.isReady=!0,a)))}}}]);