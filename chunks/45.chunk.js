"use strict";(self.i6szn8jgzh=self.i6szn8jgzh||[]).push([[45],{13477:(b,n,i)=>{i.d(n,{b:()=>z,e:()=>u,f:()=>j,h:()=>a});var e=i(11605),V=i(11778),Q=i(11796),U=i(11960),Y=i(11706),L=i(11803),B=(i(12005),i(11868)),mb=i(11621);i(12278),i(11989),i(12290);const N="image/png",Z=2,T=[134,22,135,150,246,214,150,54];function z(b){const n=new DataView(b.buffer,b.byteOffset,b.byteLength);let i=0;for(let U=0;U<T.length;U++)if(n.getUint8(i++)!==T[U])return mb.b.Error("Not a babylon environment map"),null;let e="",V=0;for(;V=n.getUint8(i++);)e+=String.fromCharCode(V);let Q=JSON.parse(e);return Q=K(Q),Q.binaryDataPosition=i,Q.Um&&(Q.Um.lodGenerationScale=Q.Um.lodGenerationScale||.8),Q}function K(b){if(b.version>Z)throw new Error(`Unsupported babylon environment map version "${b.version}". Latest supported version is "${Z}".`);return 2===b.version?b:b={...b,version:2,imageType:N}}function I(b,n){const i=(n=K(n)).Um;let e=Math.log2(n.width);if(e=Math.round(e)+1,i.mipmaps.length!==6*e)throw new Error(`Unsupported specular mipmaps number "${i.mipmaps.length}"`);const V=new Array(e);for(let Q=0;Q<e;Q++){V[Q]=new Array(6);for(let e=0;e<6;e++){const U=i.mipmaps[6*Q+e];V[Q][e]=new Uint8Array(b.buffer,b.byteOffset+n.binaryDataPosition+U.position,U.length)}}return V}function O(b,n){var i;n=K(n);const e=new Array(6),V=null===(i=n.irradiance)||void 0===i?void 0:i.irradianceTexture;if(V){if(6!==V.faces.length)throw new Error(`Incorrect irradiance texture faces number "${V.faces.length}"`);for(let i=0;i<6;i++){const Q=V.faces[i];e[i]=new Uint8Array(b.buffer,b.byteOffset+n.binaryDataPosition+Q.position,Q.length)}}return e}function u(b,n,i){var e;const Q=(i=K(i)).Um;if(!Q)return Promise.resolve([]);b._lodGenerationScale=Q.lodGenerationScale;const U=[],Y=I(n,i);U.push(G(b,Y,i.imageType));const L=null===(e=i.irradiance)||void 0===e?void 0:e.irradianceTexture;if(L){var B,mb;const e=O(n,i);let Q=null;null!==(B=i.irradiance)&&void 0!==B&&null!==(mb=B.irradianceTexture)&&void 0!==mb&&mb.dominantDirection&&(Q=V.On.jn(i.irradiance.irradianceTexture.dominantDirection)),U.push(o(b,e,L.size,i.imageType,Q))}return Promise.all(U)}async function d(b,n,i,e,V,Q,U,Y,L,B,mb){return await new Promise(((N,Z)=>{if(i){const i=n.createTexture(null,!0,!0,null,1,null,(b=>{Z(b)}),b);null===e||void 0===e||e.onEffectCreatedObservable.addOnce((Y=>{Y.executeWhenCompiled((()=>{e.externalTextureSamplerBinding=!0,e.onApply=e=>{e._bindTexture("textureSampler",i),e.setFloat2("scale",1,n._features.needsInvertingBitmap&&b instanceof ImageBitmap?-1:1)},n.scenes.length&&(n.scenes[0].postProcessManager.directRender([e],B,!0,Q,U),n.restoreDefaultFramebuffer(),i.dispose(),URL.revokeObjectURL(V),N())}))}))}else{if(n._uploadImageToTexture(mb,b,Q,U),Y){const i=L[U];i&&n._uploadImageToTexture(i._texture,b,Q,0)}N()}}))}async function G(b,n){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:N;const e=b.getEngine();b.format=5,b.type=0,b.generateMipMaps=!0,b._cachedAnisotropicFilteringLevel=null,e.updateTextureSamplingMode(3,b),await M(b,n,!0,i),b.isReady=!0}async function o(b,n,i){let e=arguments.length>3&&void 0!==arguments[3]?arguments[3]:N,V=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const Q=b.getEngine(),U=new Y.e(Q,5),B=new L.e(Q,U);b._irradianceTexture=B,B._dominantDirection=V,U.isCube=!0,U.format=5,U.type=0,U.generateMipMaps=!0,U._cachedAnisotropicFilteringLevel=null,U.generateMipMaps=!0,U.width=i,U.height=i,Q.updateTextureSamplingMode(3,U),await M(U,[n],!1,e),Q.generateMipMapsForCubemap(U),U.isReady=!0}async function M(b,n,V){let U=arguments.length>3&&void 0!==arguments[3]?arguments[3]:N;if(!e.Tools.IsExponentOfTwo(b.width))throw new Error("Texture size must be a power of two");const mb=(0,Q.ILog2)(b.width)+1,Z=b.getEngine();let T=!1,z=!1,K=null,I=null,O=null;const u=Z.getCaps();u.textureLOD?Z._features.supportRenderAndCopyToLodForFloatTextures?u.textureHalfFloatRender&&u.textureHalfFloatLinearFiltering?(T=!0,b.type=2):u.textureFloatRender&&u.textureFloatLinearFiltering&&(T=!0,b.type=1):T=!1:(T=!1,z=V);let G=0;if(T)Z.isWebGPU?(G=1,await i.e(42).then(i.bind(i,14918))):await i.e(35).then(i.bind(i,14922)),K=new B.d("rgbdDecode","rgbdDecode",null,null,1,null,3,Z,!1,void 0,b.type,void 0,null,!1,void 0,G),b._isRGBD=!1,b.invertY=!1,I=Z.createRenderTargetCubeTexture(b.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:b.type,format:5});else if(b._isRGBD=!0,b.invertY=!0,z){const n=3;O={};const i=b._lodGenerationScale,e=b._lodGenerationOffset;for(let V=0;V<n;V++){const Q=(mb-1)*i+e,U=e+(Q-e)*(1-V/(n-1)),B=Math.round(Math.min(Math.max(U,0),Q)),N=new Y.e(Z,2);N.isCube=!0,N.invertY=!0,N.generateMipMaps=!1,Z.updateTextureSamplingMode(2,N);const T=new L.e(null);switch(T._isCube=!0,T._texture=N,O[B]=T,V){case 0:b._lodTextureLow=T;break;case 1:b._lodTextureMid=T;break;case 2:b._lodTextureHigh=T}}}const o=[];for(let i=0;i<n.length;i++)for(let e=0;e<6;e++){const V=n[i][e],Q=new Blob([V],{type:U}),Y=URL.createObjectURL(Q);let L;if(Z._features.forceBitmapOverHTMLImageElement)L=Z.createImageBitmap(Q,{premultiplyAlpha:"none"}).then((async n=>await d(n,Z,T,K,Y,e,i,z,O,I,b)));else{const n=new Image;n.src=Y,L=new Promise(((V,Q)=>{n.onload=()=>{d(n,Z,T,K,Y,e,i,z,O,I,b).then((()=>V())).catch((b=>{Q(b)}))},n.onerror=b=>{Q(b)}}))}o.push(L)}if(await Promise.all(o),n.length<mb){let i;const e=Math.pow(2,mb-1-n.length),V=e*e*4;switch(b.type){case 0:i=new Uint8Array(V);break;case 2:i=new Uint16Array(V);break;case 1:i=new Float32Array(V)}for(let Q=n.length;Q<mb;Q++)for(let n=0;n<6;n++){var M;Z._uploadArrayBufferViewToTexture((null===(M=I)||void 0===M?void 0:M.texture)||b,i,n,Q)}}if(I){const n=b._irradianceTexture;b._irradianceTexture=null,Z._releaseTexture(b),I._swapAndDie(b),b._irradianceTexture=n}K&&K.dispose(),z&&(b._lodTextureHigh&&b._lodTextureHigh._texture&&(b._lodTextureHigh._texture.isReady=!0),b._lodTextureMid&&b._lodTextureMid._texture&&(b._lodTextureMid._texture.isReady=!0),b._lodTextureLow&&b._lodTextureLow._texture&&(b._lodTextureLow._texture.isReady=!0))}function j(b,n){const i=(n=K(n)).irradiance;if(!i)return;const e=new U.h;V.On.FromArrayToRef(i.x,0,e.x),V.On.FromArrayToRef(i.y,0,e.y),V.On.FromArrayToRef(i.z,0,e.z),V.On.FromArrayToRef(i.xx,0,e.xx),V.On.FromArrayToRef(i.yy,0,e.yy),V.On.FromArrayToRef(i.zz,0,e.zz),V.On.FromArrayToRef(i.yz,0,e.yz),V.On.FromArrayToRef(i.zx,0,e.zx),V.On.FromArrayToRef(i.xy,0,e.xy),b._sphericalPolynomial=e}function a(b,n,i,e,V){const Q=G(b.getEngine().createRawCubeTexture(null,b.width,b.format,b.type,b.generateMipMaps,b.invertY,b.samplingMode,b._compression),n).then((()=>b));return b.onRebuildCallback=b=>({proxy:Q,isReady:!0,isAsync:!0}),b._source=13,b._bufferViewArrayArray=n,b._lodGenerationScale=e,b._lodGenerationOffset=V,b._sphericalPolynomial=i,G(b,n).then((()=>(b.isReady=!0,b)))}}}]);