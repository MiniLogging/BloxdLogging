"use strict";(self.ipz2em9uj1g=self.ipz2em9uj1g||[]).push([[45],{14228:(r,O,W)=>{W.d(O,{e:()=>U,f:()=>Y,i:()=>N,j:()=>D});var q=W(12428),Q=W(12591),C=W(12602),T=W(12768),h=W(12540),J=W(12604),mr=(W(12802),W(12686)),d=W(12453);W(13041),W(12791),W(13051);const v="image/png",g=2,K=[134,22,135,150,246,214,150,54];function U(r){const O=new DataView(r.buffer,r.byteOffset,r.byteLength);let W=0;for(let T=0;T<K.length;T++)if(O.getUint8(W++)!==K[T])return d.b.Error("Not a babylon environment map"),null;let q="",Q=0;for(;Q=O.getUint8(W++);)q+=String.fromCharCode(Q);let C=JSON.parse(q);return C=P(C),C.binaryDataPosition=W,C.rv&&(C.rv.lodGenerationScale=C.rv.lodGenerationScale||.8),C}function P(r){if(r.version>g)throw new Error(`Unsupported babylon environment map version "${r.version}". Latest supported version is "${g}".`);return 2===r.version?r:r={...r,version:2,imageType:v}}function b(r,O){const W=(O=P(O)).rv;let q=Math.log2(O.width);if(q=Math.round(q)+1,W.mipmaps.length!==6*q)throw new Error(`Unsupported specular mipmaps number "${W.mipmaps.length}"`);const Q=new Array(q);for(let C=0;C<q;C++){Q[C]=new Array(6);for(let q=0;q<6;q++){const T=W.mipmaps[6*C+q];Q[C][q]=new Uint8Array(r.buffer,r.byteOffset+O.binaryDataPosition+T.position,T.length)}}return Q}function e(r,O){var W;O=P(O);const q=new Array(6),Q=null===(W=O.irradiance)||void 0===W?void 0:W.irradianceTexture;if(Q){if(6!==Q.faces.length)throw new Error(`Incorrect irradiance texture faces number "${Q.faces.length}"`);for(let W=0;W<6;W++){const C=Q.faces[W];q[W]=new Uint8Array(r.buffer,r.byteOffset+O.binaryDataPosition+C.position,C.length)}}return q}function Y(r,O,W){var q;const C=(W=P(W)).rv;if(!C)return Promise.resolve([]);r._lodGenerationScale=C.lodGenerationScale;const T=[],h=b(O,W);T.push(X(r,h,W.imageType));const J=null===(q=W.irradiance)||void 0===q?void 0:q.irradianceTexture;if(J){var mr,d;const q=e(O,W);let C=null;null!==(mr=W.irradiance)&&void 0!==mr&&null!==(d=mr.irradianceTexture)&&void 0!==d&&d.dominantDirection&&(C=Q.eO.oO(W.irradiance.irradianceTexture.dominantDirection)),T.push(S(r,q,J.size,W.imageType,C))}return Promise.all(T)}async function G(r,O,W,q,Q,C,T,h,J,mr,d){return await new Promise(((v,g)=>{if(W){const W=O.createTexture(null,!0,!0,null,1,null,(r=>{g(r)}),r);null===q||void 0===q||q.onEffectCreatedObservable.addOnce((h=>{h.executeWhenCompiled((()=>{q.externalTextureSamplerBinding=!0,q.onApply=q=>{q._bindTexture("textureSampler",W),q.setFloat2("scale",1,O._features.needsInvertingBitmap&&r instanceof ImageBitmap?-1:1)},O.scenes.length&&(O.scenes[0].postProcessManager.directRender([q],mr,!0,C,T),O.restoreDefaultFramebuffer(),W.dispose(),URL.revokeObjectURL(Q),v())}))}))}else{if(O._uploadImageToTexture(d,r,C,T),h){const W=J[T];W&&O._uploadImageToTexture(W._texture,r,C,0)}v()}}))}async function X(r,O){let W=arguments.length>2&&void 0!==arguments[2]?arguments[2]:v;const q=r.getEngine();r.format=5,r.type=0,r.generateMipMaps=!0,r._cachedAnisotropicFilteringLevel=null,q.updateTextureSamplingMode(3,r),await o(r,O,!0,W),r.isReady=!0}async function S(r,O,W){let q=arguments.length>3&&void 0!==arguments[3]?arguments[3]:v,Q=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const C=r.getEngine(),T=new h.e(C,5),mr=new J.d(C,T);r._irradianceTexture=mr,mr._dominantDirection=Q,T.isCube=!0,T.format=5,T.type=0,T.generateMipMaps=!0,T._cachedAnisotropicFilteringLevel=null,T.generateMipMaps=!0,T.width=W,T.height=W,C.updateTextureSamplingMode(3,T),await o(T,[O],!1,q),C.generateMipMapsForCubemap(T),T.isReady=!0}async function o(r,O,Q){let T=arguments.length>3&&void 0!==arguments[3]?arguments[3]:v;if(!q.Tools.IsExponentOfTwo(r.width))throw new Error("Texture size must be a power of two");const d=(0,C.ILog2)(r.width)+1,g=r.getEngine();let K=!1,U=!1,P=null,b=null,e=null;const Y=g.getCaps();Y.textureLOD?g._features.supportRenderAndCopyToLodForFloatTextures?Y.textureHalfFloatRender&&Y.textureHalfFloatLinearFiltering?(K=!0,r.type=2):Y.textureFloatRender&&Y.textureFloatLinearFiltering&&(K=!0,r.type=1):K=!1:(K=!1,U=Q);let X=0;if(K)g.isWebGPU?(X=1,await W.e(42).then(W.bind(W,15682))):await W.e(35).then(W.bind(W,15686)),P=new mr.d("rgbdDecode","rgbdDecode",null,null,1,null,3,g,!1,void 0,r.type,void 0,null,!1,void 0,X),r._isRGBD=!1,r.invertY=!1,b=g.createRenderTargetCubeTexture(r.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:r.type,format:5});else if(r._isRGBD=!0,r.invertY=!0,U){const O=3;e={};const W=r._lodGenerationScale,q=r._lodGenerationOffset;for(let Q=0;Q<O;Q++){const C=(d-1)*W+q,T=q+(C-q)*(1-Q/(O-1)),mr=Math.round(Math.min(Math.max(T,0),C)),v=new h.e(g,2);v.isCube=!0,v.invertY=!0,v.generateMipMaps=!1,g.updateTextureSamplingMode(2,v);const K=new J.d(null);switch(K._isCube=!0,K._texture=v,e[mr]=K,Q){case 0:r._lodTextureLow=K;break;case 1:r._lodTextureMid=K;break;case 2:r._lodTextureHigh=K}}}const S=[];for(let W=0;W<O.length;W++)for(let q=0;q<6;q++){const Q=O[W][q],C=new Blob([Q],{type:T}),h=URL.createObjectURL(C);let J;if(g._features.forceBitmapOverHTMLImageElement)J=g.createImageBitmap(C,{premultiplyAlpha:"none"}).then((async O=>await G(O,g,K,P,h,q,W,U,e,b,r)));else{const O=new Image;O.src=h,J=new Promise(((Q,C)=>{O.onload=()=>{G(O,g,K,P,h,q,W,U,e,b,r).then((()=>Q())).catch((r=>{C(r)}))},O.onerror=r=>{C(r)}}))}S.push(J)}if(await Promise.all(S),O.length<d){let W;const q=Math.pow(2,d-1-O.length),Q=q*q*4;switch(r.type){case 0:W=new Uint8Array(Q);break;case 2:W=new Uint16Array(Q);break;case 1:W=new Float32Array(Q)}for(let C=O.length;C<d;C++)for(let O=0;O<6;O++){var o;g._uploadArrayBufferViewToTexture((null===(o=b)||void 0===o?void 0:o.texture)||r,W,O,C)}}if(b){const O=r._irradianceTexture;r._irradianceTexture=null,g._releaseTexture(r),b._swapAndDie(r),r._irradianceTexture=O}P&&P.dispose(),U&&(r._lodTextureHigh&&r._lodTextureHigh._texture&&(r._lodTextureHigh._texture.isReady=!0),r._lodTextureMid&&r._lodTextureMid._texture&&(r._lodTextureMid._texture.isReady=!0),r._lodTextureLow&&r._lodTextureLow._texture&&(r._lodTextureLow._texture.isReady=!0))}function N(r,O){const W=(O=P(O)).irradiance;if(!W)return;const q=new T.g;Q.eO.FromArrayToRef(W.x,0,q.x),Q.eO.FromArrayToRef(W.y,0,q.y),Q.eO.FromArrayToRef(W.z,0,q.z),Q.eO.FromArrayToRef(W.xx,0,q.xx),Q.eO.FromArrayToRef(W.yy,0,q.yy),Q.eO.FromArrayToRef(W.zz,0,q.zz),Q.eO.FromArrayToRef(W.yz,0,q.yz),Q.eO.FromArrayToRef(W.zx,0,q.zx),Q.eO.FromArrayToRef(W.xy,0,q.xy),r._sphericalPolynomial=q}function D(r,O,W,q,Q){const C=X(r.getEngine().createRawCubeTexture(null,r.width,r.format,r.type,r.generateMipMaps,r.invertY,r.samplingMode,r._compression),O).then((()=>r));return r.onRebuildCallback=r=>({proxy:C,isReady:!0,isAsync:!0}),r._source=13,r._bufferViewArrayArray=O,r._lodGenerationScale=q,r._lodGenerationOffset=Q,r._sphericalPolynomial=W,X(r,O).then((()=>(r.isReady=!0,r)))}}}]);