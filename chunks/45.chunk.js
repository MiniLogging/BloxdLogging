"use strict";(self["9jl1vn4ei5r"]=self["9jl1vn4ei5r"]||[]).push([[45],{13419:(M,p,b)=>{b.d(p,{b:()=>i,e:()=>D,f:()=>R,i:()=>y});var Q=b(11621),q=b(11796),B=b(11806),k=b(11976),u=b(11729),T=b(11809),O=(b(12033),b(11882)),H=b(11637);b(12316),b(12016),b(12329);const F="image/png",o=2,W=[134,22,135,150,246,214,150,54];function i(M){const p=new DataView(M.buffer,M.byteOffset,M.byteLength);let b=0;for(let k=0;k<W.length;k++)if(p.getUint8(b++)!==W[k])return H.c.Error("Not a babylon environment map"),null;let Q="",q=0;for(;q=p.getUint8(b++);)Q+=String.fromCharCode(q);let B=JSON.parse(Q);return B=A(B),B.binaryDataPosition=b,B.sH&&(B.sH.lodGenerationScale=B.sH.lodGenerationScale||.8),B}function A(M){if(M.version>o)throw new Error(`Unsupported babylon environment map version "${M.version}". Latest supported version is "${o}".`);return 2===M.version?M:M={...M,version:2,imageType:F}}function j(M,p){const b=(p=A(p)).sH;let Q=Math.log2(p.width);if(Q=Math.round(Q)+1,b.mipmaps.length!==6*Q)throw new Error(`Unsupported specular mipmaps number "${b.mipmaps.length}"`);const q=new Array(Q);for(let B=0;B<Q;B++){q[B]=new Array(6);for(let Q=0;Q<6;Q++){const k=b.mipmaps[6*B+Q];q[B][Q]=new Uint8Array(M.buffer,M.byteOffset+p.binaryDataPosition+k.position,k.length)}}return q}function K(M,p){var b;p=A(p);const Q=new Array(6),q=null===(b=p.irradiance)||void 0===b?void 0:b.irradianceTexture;if(q){if(6!==q.faces.length)throw new Error(`Incorrect irradiance texture faces number "${q.faces.length}"`);for(let b=0;b<6;b++){const B=q.faces[b];Q[b]=new Uint8Array(M.buffer,M.byteOffset+p.binaryDataPosition+B.position,B.length)}}return Q}function D(M,p,b){var Q;const B=(b=A(b)).sH;if(!B)return Promise.resolve([]);M._lodGenerationScale=B.lodGenerationScale;const k=[],u=j(p,b);k.push(s(M,u,b.imageType));const T=null===(Q=b.irradiance)||void 0===Q?void 0:Q.irradianceTexture;if(T){var O,H;const Q=K(p,b);let B=null;null!==(O=b.irradiance)&&void 0!==O&&null!==(H=O.irradianceTexture)&&void 0!==H&&H.dominantDirection&&(B=q.Ap.sp(b.irradiance.irradianceTexture.dominantDirection)),k.push(S(M,Q,T.size,b.imageType,B))}return Promise.all(k)}async function a(M,p,b,Q,q,B,k,u,T,O,H){return await new Promise(((F,o)=>{if(b){const b=p.createTexture(null,!0,!0,null,1,null,(M=>{o(M)}),M);null===Q||void 0===Q||Q.onEffectCreatedObservable.addOnce((u=>{u.executeWhenCompiled((()=>{Q.externalTextureSamplerBinding=!0,Q.onApply=Q=>{Q._bindTexture("textureSampler",b),Q.setFloat2("scale",1,p._features.needsInvertingBitmap&&M instanceof ImageBitmap?-1:1)},p.scenes.length&&(p.scenes[0].postProcessManager.directRender([Q],O,!0,B,k),p.restoreDefaultFramebuffer(),b.dispose(),URL.revokeObjectURL(q),F())}))}))}else{if(p._uploadImageToTexture(H,M,B,k),u){const b=T[k];b&&p._uploadImageToTexture(b._texture,M,B,0)}F()}}))}async function s(M,p){let b=arguments.length>2&&void 0!==arguments[2]?arguments[2]:F;const Q=M.getEngine();M.format=5,M.type=0,M.generateMipMaps=!0,M._cachedAnisotropicFilteringLevel=null,Q.updateTextureSamplingMode(3,M),await f(M,p,!0,b),M.isReady=!0}async function S(M,p,b){let Q=arguments.length>3&&void 0!==arguments[3]?arguments[3]:F,q=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const B=M.getEngine(),k=new u.b(B,5),O=new T.d(B,k);M._irradianceTexture=O,O._dominantDirection=q,k.isCube=!0,k.format=5,k.type=0,k.generateMipMaps=!0,k._cachedAnisotropicFilteringLevel=null,k.generateMipMaps=!0,k.width=b,k.height=b,B.updateTextureSamplingMode(3,k),await f(k,[p],!1,Q),B.generateMipMapsForCubemap(k),k.isReady=!0}async function f(M,p,q){let k=arguments.length>3&&void 0!==arguments[3]?arguments[3]:F;if(!Q.Tools.IsExponentOfTwo(M.width))throw new Error("Texture size must be a power of two");const H=(0,B.ILog2)(M.width)+1,o=M.getEngine();let W=!1,i=!1,A=null,j=null,K=null;const D=o.getCaps();D.textureLOD?o._features.supportRenderAndCopyToLodForFloatTextures?D.textureHalfFloatRender&&D.textureHalfFloatLinearFiltering?(W=!0,M.type=2):D.textureFloatRender&&D.textureFloatLinearFiltering&&(W=!0,M.type=1):W=!1:(W=!1,i=q);let s=0;if(W)o.isWebGPU?(s=1,await b.e(42).then(b.bind(b,14783))):await b.e(35).then(b.bind(b,14792)),A=new O.b("rgbdDecode","rgbdDecode",null,null,1,null,3,o,!1,void 0,M.type,void 0,null,!1,void 0,s),M._isRGBD=!1,M.invertY=!1,j=o.createRenderTargetCubeTexture(M.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:M.type,format:5});else if(M._isRGBD=!0,M.invertY=!0,i){const p=3;K={};const b=M._lodGenerationScale,Q=M._lodGenerationOffset;for(let q=0;q<p;q++){const B=(H-1)*b+Q,k=Q+(B-Q)*(1-q/(p-1)),O=Math.round(Math.min(Math.max(k,0),B)),F=new u.b(o,2);F.isCube=!0,F.invertY=!0,F.generateMipMaps=!1,o.updateTextureSamplingMode(2,F);const W=new T.d(null);switch(W._isCube=!0,W._texture=F,K[O]=W,q){case 0:M._lodTextureLow=W;break;case 1:M._lodTextureMid=W;break;case 2:M._lodTextureHigh=W}}}const S=[];for(let b=0;b<p.length;b++)for(let Q=0;Q<6;Q++){const q=p[b][Q],B=new Blob([q],{type:k}),u=URL.createObjectURL(B);let T;if(o._features.forceBitmapOverHTMLImageElement)T=o.createImageBitmap(B,{premultiplyAlpha:"none"}).then((async p=>await a(p,o,W,A,u,Q,b,i,K,j,M)));else{const p=new Image;p.src=u,T=new Promise(((q,B)=>{p.onload=()=>{a(p,o,W,A,u,Q,b,i,K,j,M).then((()=>q())).catch((M=>{B(M)}))},p.onerror=M=>{B(M)}}))}S.push(T)}if(await Promise.all(S),p.length<H){let b;const Q=Math.pow(2,H-1-p.length),q=Q*Q*4;switch(M.type){case 0:b=new Uint8Array(q);break;case 2:b=new Uint16Array(q);break;case 1:b=new Float32Array(q)}for(let B=p.length;B<H;B++)for(let p=0;p<6;p++){var f;o._uploadArrayBufferViewToTexture((null===(f=j)||void 0===f?void 0:f.texture)||M,b,p,B)}}if(j){const p=M._irradianceTexture;M._irradianceTexture=null,o._releaseTexture(M),j._swapAndDie(M),M._irradianceTexture=p}A&&A.dispose(),i&&(M._lodTextureHigh&&M._lodTextureHigh._texture&&(M._lodTextureHigh._texture.isReady=!0),M._lodTextureMid&&M._lodTextureMid._texture&&(M._lodTextureMid._texture.isReady=!0),M._lodTextureLow&&M._lodTextureLow._texture&&(M._lodTextureLow._texture.isReady=!0))}function R(M,p){const b=(p=A(p)).irradiance;if(!b)return;const Q=new k.f;q.Ap.FromArrayToRef(b.x,0,Q.x),q.Ap.FromArrayToRef(b.y,0,Q.y),q.Ap.FromArrayToRef(b.z,0,Q.z),q.Ap.FromArrayToRef(b.xx,0,Q.xx),q.Ap.FromArrayToRef(b.yy,0,Q.yy),q.Ap.FromArrayToRef(b.zz,0,Q.zz),q.Ap.FromArrayToRef(b.yz,0,Q.yz),q.Ap.FromArrayToRef(b.zx,0,Q.zx),q.Ap.FromArrayToRef(b.xy,0,Q.xy),M._sphericalPolynomial=Q}function y(M,p,b,Q,q){const B=s(M.getEngine().createRawCubeTexture(null,M.width,M.format,M.type,M.generateMipMaps,M.invertY,M.samplingMode,M._compression),p).then((()=>M));return M.onRebuildCallback=M=>({proxy:B,isReady:!0,isAsync:!0}),M._source=13,M._bufferViewArrayArray=p,M._lodGenerationScale=Q,M._lodGenerationOffset=q,M._sphericalPolynomial=b,s(M,p).then((()=>(M.isReady=!0,M)))}}}]);