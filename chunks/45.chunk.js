"use strict";(self["3nlrbof8msu"]=self["3nlrbof8msu"]||[]).push([[45],{14355:(t,b,Z)=>{Z.d(b,{c:()=>T,d:()=>l,g:()=>o,i:()=>O});var J=Z(12549),S=Z(12735),P=Z(12745),v=Z(12923),h=Z(12663),C=Z(12748),Y=(Z(12975),Z(12829)),g=Z(12557);Z(13234),Z(12955),Z(13245);const I="image/png",r=2,M=[134,22,135,150,246,214,150,54];function T(t){const b=new DataView(t.buffer,t.byteOffset,t.byteLength);let Z=0;for(let v=0;v<M.length;v++)if(b.getUint8(Z++)!==M[v])return g.c.Error("Not a babylon environment map"),null;let J="",S=0;for(;S=b.getUint8(Z++);)J+=String.fromCharCode(S);let P=JSON.parse(J);return P=a(P),P.binaryDataPosition=Z,P.bI&&(P.bI.lodGenerationScale=P.bI.lodGenerationScale||.8),P}function a(t){if(t.version>r)throw new Error(`Unsupported babylon environment map version "${t.version}". Latest supported version is "${r}".`);return 2===t.version?t:t={...t,version:2,imageType:I}}function k(t,b){const Z=(b=a(b)).bI;let J=Math.log2(b.width);if(J=Math.round(J)+1,Z.mipmaps.length!==6*J)throw new Error(`Unsupported specular mipmaps number "${Z.mipmaps.length}"`);const S=new Array(J);for(let P=0;P<J;P++){S[P]=new Array(6);for(let J=0;J<6;J++){const v=Z.mipmaps[6*P+J];S[P][J]=new Uint8Array(t.buffer,t.byteOffset+b.binaryDataPosition+v.position,v.length)}}return S}function u(t,b){var Z;b=a(b);const J=new Array(6),S=null===(Z=b.irradiance)||void 0===Z?void 0:Z.irradianceTexture;if(S){if(6!==S.faces.length)throw new Error(`Incorrect irradiance texture faces number "${S.faces.length}"`);for(let Z=0;Z<6;Z++){const P=S.faces[Z];J[Z]=new Uint8Array(t.buffer,t.byteOffset+b.binaryDataPosition+P.position,P.length)}}return J}function l(t,b,Z){var J;const P=(Z=a(Z)).bI;if(!P)return Promise.resolve([]);t._lodGenerationScale=P.lodGenerationScale;const v=[],h=k(b,Z);v.push(E(t,h,Z.imageType));const C=null===(J=Z.irradiance)||void 0===J?void 0:J.irradianceTexture;if(C){var Y,g;const J=u(b,Z);let P=null;null!==(Y=Z.irradiance)&&void 0!==Y&&null!==(g=Y.irradianceTexture)&&void 0!==g&&g.dominantDirection&&(P=S.JZ.CZ(Z.irradiance.irradianceTexture.dominantDirection)),v.push(c(t,J,C.size,Z.imageType,P))}return Promise.all(v)}async function U(t,b,Z,J,S,P,v,h,C,Y,g){return await new Promise(((I,r)=>{if(Z){const Z=b.createTexture(null,!0,!0,null,1,null,(t=>{r(t)}),t);null===J||void 0===J||J.onEffectCreatedObservable.addOnce((h=>{h.executeWhenCompiled((()=>{J.externalTextureSamplerBinding=!0,J.onApply=J=>{J._bindTexture("textureSampler",Z),J.setFloat2("scale",1,b._features.needsInvertingBitmap&&t instanceof ImageBitmap?-1:1)},b.scenes.length&&(b.scenes[0].postProcessManager.directRender([J],Y,!0,P,v),b.restoreDefaultFramebuffer(),Z.dispose(),URL.revokeObjectURL(S),I())}))}))}else{if(b._uploadImageToTexture(g,t,P,v),h){const Z=C[v];Z&&b._uploadImageToTexture(Z._texture,t,P,0)}I()}}))}async function E(t,b){let Z=arguments.length>2&&void 0!==arguments[2]?arguments[2]:I;const J=t.getEngine();t.format=5,t.type=0,t.generateMipMaps=!0,t._cachedAnisotropicFilteringLevel=null,J.updateTextureSamplingMode(3,t),await H(t,b,!0,Z),t.isReady=!0}async function c(t,b,Z){let J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:I,S=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const P=t.getEngine(),v=new h.d(P,5),Y=new C.d(P,v);t._irradianceTexture=Y,Y._dominantDirection=S,v.isCube=!0,v.format=5,v.type=0,v.generateMipMaps=!0,v._cachedAnisotropicFilteringLevel=null,v.generateMipMaps=!0,v.width=Z,v.height=Z,P.updateTextureSamplingMode(3,v),await H(v,[b],!1,J),P.generateMipMapsForCubemap(v),v.isReady=!0}async function H(t,b,S){let v=arguments.length>3&&void 0!==arguments[3]?arguments[3]:I;if(!J.Tools.IsExponentOfTwo(t.width))throw new Error("Texture size must be a power of two");const g=(0,P.ILog2)(t.width)+1,r=t.getEngine();let M=!1,T=!1,a=null,k=null,u=null;const l=r.getCaps();l.textureLOD?r._features.supportRenderAndCopyToLodForFloatTextures?l.textureHalfFloatRender&&l.textureHalfFloatLinearFiltering?(M=!0,t.type=2):l.textureFloatRender&&l.textureFloatLinearFiltering&&(M=!0,t.type=1):M=!1:(M=!1,T=S);let E=0;if(M)r.isWebGPU?(E=1,await Z.e(42).then(Z.bind(Z,15773))):await Z.e(35).then(Z.bind(Z,15780)),a=new Y.c("rgbdDecode","rgbdDecode",null,null,1,null,3,r,!1,void 0,t.type,void 0,null,!1,void 0,E),t._isRGBD=!1,t.invertY=!1,k=r.createRenderTargetCubeTexture(t.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:t.type,format:5});else if(t._isRGBD=!0,t.invertY=!0,T){const b=3;u={};const Z=t._lodGenerationScale,J=t._lodGenerationOffset;for(let S=0;S<b;S++){const P=(g-1)*Z+J,v=J+(P-J)*(1-S/(b-1)),Y=Math.round(Math.min(Math.max(v,0),P)),I=new h.d(r,2);I.isCube=!0,I.invertY=!0,I.generateMipMaps=!1,r.updateTextureSamplingMode(2,I);const M=new C.d(null);switch(M._isCube=!0,M._texture=I,u[Y]=M,S){case 0:t._lodTextureLow=M;break;case 1:t._lodTextureMid=M;break;case 2:t._lodTextureHigh=M}}}const c=[];for(let Z=0;Z<b.length;Z++)for(let J=0;J<6;J++){const S=b[Z][J],P=new Blob([S],{type:v}),h=URL.createObjectURL(P);let C;if(r._features.forceBitmapOverHTMLImageElement)C=r.createImageBitmap(P,{premultiplyAlpha:"none"}).then((async b=>await U(b,r,M,a,h,J,Z,T,u,k,t)));else{const b=new Image;b.src=h,C=new Promise(((S,P)=>{b.onload=()=>{U(b,r,M,a,h,J,Z,T,u,k,t).then((()=>S())).catch((t=>{P(t)}))},b.onerror=t=>{P(t)}}))}c.push(C)}if(await Promise.all(c),b.length<g){let Z;const J=Math.pow(2,g-1-b.length),S=J*J*4;switch(t.type){case 0:Z=new Uint8Array(S);break;case 2:Z=new Uint16Array(S);break;case 1:Z=new Float32Array(S)}for(let P=b.length;P<g;P++)for(let b=0;b<6;b++){var H;r._uploadArrayBufferViewToTexture((null===(H=k)||void 0===H?void 0:H.texture)||t,Z,b,P)}}if(k){const b=t._irradianceTexture;t._irradianceTexture=null,r._releaseTexture(t),k._swapAndDie(t),t._irradianceTexture=b}a&&a.dispose(),T&&(t._lodTextureHigh&&t._lodTextureHigh._texture&&(t._lodTextureHigh._texture.isReady=!0),t._lodTextureMid&&t._lodTextureMid._texture&&(t._lodTextureMid._texture.isReady=!0),t._lodTextureLow&&t._lodTextureLow._texture&&(t._lodTextureLow._texture.isReady=!0))}function o(t,b){const Z=(b=a(b)).irradiance;if(!Z)return;const J=new v.f;S.JZ.FromArrayToRef(Z.x,0,J.x),S.JZ.FromArrayToRef(Z.y,0,J.y),S.JZ.FromArrayToRef(Z.z,0,J.z),S.JZ.FromArrayToRef(Z.xx,0,J.xx),S.JZ.FromArrayToRef(Z.yy,0,J.yy),S.JZ.FromArrayToRef(Z.zz,0,J.zz),S.JZ.FromArrayToRef(Z.yz,0,J.yz),S.JZ.FromArrayToRef(Z.zx,0,J.zx),S.JZ.FromArrayToRef(Z.xy,0,J.xy),t._sphericalPolynomial=J}function O(t,b,Z,J,S){const P=E(t.getEngine().createRawCubeTexture(null,t.width,t.format,t.type,t.generateMipMaps,t.invertY,t.samplingMode,t._compression),b).then((()=>t));return t.onRebuildCallback=t=>({proxy:P,isReady:!0,isAsync:!0}),t._source=13,t._bufferViewArrayArray=b,t._lodGenerationScale=J,t._lodGenerationOffset=S,t._sphericalPolynomial=Z,E(t,b).then((()=>(t.isReady=!0,t)))}}}]);