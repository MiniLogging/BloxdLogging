"use strict";(self["1kjc9ee3uyt"]=self["1kjc9ee3uyt"]||[]).push([[45],{13247:(w,E,G)=>{G.d(E,{c:()=>a,d:()=>J,g:()=>W,h:()=>T});var P=G(11498),h=G(11679),B=G(11689),y=G(11863),x=G(11626),U=G(11695),l=(G(11908),G(11774)),i=G(11518);G(12157),G(11886),G(12172);const O="image/png",u=2,V=[134,22,135,150,246,214,150,54];function a(w){const E=new DataView(w.buffer,w.byteOffset,w.byteLength);let G=0;for(let y=0;y<V.length;y++)if(E.getUint8(G++)!==V[y])return i.e.Error("Not a babylon environment map"),null;let P="",h=0;for(;h=E.getUint8(G++);)P+=String.fromCharCode(h);let B=JSON.parse(P);return B=Q(B),B.binaryDataPosition=G,B.Ji&&(B.Ji.lodGenerationScale=B.Ji.lodGenerationScale||.8),B}function Q(w){if(w.version>u)throw new Error(`Unsupported babylon environment map version "${w.version}". Latest supported version is "${u}".`);return 2===w.version?w:w={...w,version:2,imageType:O}}function c(w,E){const G=(E=Q(E)).Ji;let P=Math.log2(E.width);if(P=Math.round(P)+1,G.mipmaps.length!==6*P)throw new Error(`Unsupported specular mipmaps number "${G.mipmaps.length}"`);const h=new Array(P);for(let B=0;B<P;B++){h[B]=new Array(6);for(let P=0;P<6;P++){const y=G.mipmaps[6*B+P];h[B][P]=new Uint8Array(w.buffer,w.byteOffset+E.binaryDataPosition+y.position,y.length)}}return h}function Z(w,E){var G;E=Q(E);const P=new Array(6),h=null===(G=E.irradiance)||void 0===G?void 0:G.irradianceTexture;if(h){if(6!==h.faces.length)throw new Error(`Incorrect irradiance texture faces number "${h.faces.length}"`);for(let G=0;G<6;G++){const B=h.faces[G];P[G]=new Uint8Array(w.buffer,w.byteOffset+E.binaryDataPosition+B.position,B.length)}}return P}function J(w,E,G){var P;const B=(G=Q(G)).Ji;if(!B)return Promise.resolve([]);w._lodGenerationScale=B.lodGenerationScale;const y=[],x=c(E,G);y.push(K(w,x,G.imageType));const U=null===(P=G.irradiance)||void 0===P?void 0:P.irradianceTexture;if(U){var l,i;const P=Z(E,G);let B=null;null!==(l=G.irradiance)&&void 0!==l&&null!==(i=l.irradianceTexture)&&void 0!==i&&i.dominantDirection&&(B=h.QE.KE(G.irradiance.irradianceTexture.dominantDirection)),y.push(t(w,P,U.size,G.imageType,B))}return Promise.all(y)}async function d(w,E,G,P,h,B,y,x,U,l,i){return await new Promise(((O,u)=>{if(G){const G=E.createTexture(null,!0,!0,null,1,null,(w=>{u(w)}),w);null===P||void 0===P||P.onEffectCreatedObservable.addOnce((x=>{x.executeWhenCompiled((()=>{P.externalTextureSamplerBinding=!0,P.onApply=P=>{P._bindTexture("textureSampler",G),P.setFloat2("scale",1,E._features.needsInvertingBitmap&&w instanceof ImageBitmap?-1:1)},E.scenes.length&&(E.scenes[0].postProcessManager.directRender([P],l,!0,B,y),E.restoreDefaultFramebuffer(),G.dispose(),URL.revokeObjectURL(h),O())}))}))}else{if(E._uploadImageToTexture(i,w,B,y),x){const G=U[y];G&&E._uploadImageToTexture(G._texture,w,B,0)}O()}}))}async function K(w,E){let G=arguments.length>2&&void 0!==arguments[2]?arguments[2]:O;const P=w.getEngine();w.format=5,w.type=0,w.generateMipMaps=!0,w._cachedAnisotropicFilteringLevel=null,P.updateTextureSamplingMode(3,w),await q(w,E,!0,G),w.isReady=!0}async function t(w,E,G){let P=arguments.length>3&&void 0!==arguments[3]?arguments[3]:O,h=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const B=w.getEngine(),y=new x.e(B,5),l=new U.c(B,y);w._irradianceTexture=l,l._dominantDirection=h,y.isCube=!0,y.format=5,y.type=0,y.generateMipMaps=!0,y._cachedAnisotropicFilteringLevel=null,y.generateMipMaps=!0,y.width=G,y.height=G,B.updateTextureSamplingMode(3,y),await q(y,[E],!1,P),B.generateMipMapsForCubemap(y),y.isReady=!0}async function q(w,E,h){let y=arguments.length>3&&void 0!==arguments[3]?arguments[3]:O;if(!P.Tools.IsExponentOfTwo(w.width))throw new Error("Texture size must be a power of two");const i=(0,B.ILog2)(w.width)+1,u=w.getEngine();let V=!1,a=!1,Q=null,c=null,Z=null;const J=u.getCaps();J.textureLOD?u._features.supportRenderAndCopyToLodForFloatTextures?J.textureHalfFloatRender&&J.textureHalfFloatLinearFiltering?(V=!0,w.type=2):J.textureFloatRender&&J.textureFloatLinearFiltering&&(V=!0,w.type=1):V=!1:(V=!1,a=h);let K=0;if(V)u.isWebGPU?(K=1,await G.e(42).then(G.bind(G,14579))):await G.e(35).then(G.bind(G,14586)),Q=new l.e("rgbdDecode","rgbdDecode",null,null,1,null,3,u,!1,void 0,w.type,void 0,null,!1,void 0,K),w._isRGBD=!1,w.invertY=!1,c=u.createRenderTargetCubeTexture(w.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:w.type,format:5});else if(w._isRGBD=!0,w.invertY=!0,a){const E=3;Z={};const G=w._lodGenerationScale,P=w._lodGenerationOffset;for(let h=0;h<E;h++){const B=(i-1)*G+P,y=P+(B-P)*(1-h/(E-1)),l=Math.round(Math.min(Math.max(y,0),B)),O=new x.e(u,2);O.isCube=!0,O.invertY=!0,O.generateMipMaps=!1,u.updateTextureSamplingMode(2,O);const V=new U.c(null);switch(V._isCube=!0,V._texture=O,Z[l]=V,h){case 0:w._lodTextureLow=V;break;case 1:w._lodTextureMid=V;break;case 2:w._lodTextureHigh=V}}}const t=[];for(let G=0;G<E.length;G++)for(let P=0;P<6;P++){const h=E[G][P],B=new Blob([h],{type:y}),x=URL.createObjectURL(B);let U;if(u._features.forceBitmapOverHTMLImageElement)U=u.createImageBitmap(B,{premultiplyAlpha:"none"}).then((async E=>await d(E,u,V,Q,x,P,G,a,Z,c,w)));else{const E=new Image;E.src=x,U=new Promise(((h,B)=>{E.onload=()=>{d(E,u,V,Q,x,P,G,a,Z,c,w).then((()=>h())).catch((w=>{B(w)}))},E.onerror=w=>{B(w)}}))}t.push(U)}if(await Promise.all(t),E.length<i){let G;const P=Math.pow(2,i-1-E.length),h=P*P*4;switch(w.type){case 0:G=new Uint8Array(h);break;case 2:G=new Uint16Array(h);break;case 1:G=new Float32Array(h)}for(let B=E.length;B<i;B++)for(let E=0;E<6;E++){var q;u._uploadArrayBufferViewToTexture((null===(q=c)||void 0===q?void 0:q.texture)||w,G,E,B)}}if(c){const E=w._irradianceTexture;w._irradianceTexture=null,u._releaseTexture(w),c._swapAndDie(w),w._irradianceTexture=E}Q&&Q.dispose(),a&&(w._lodTextureHigh&&w._lodTextureHigh._texture&&(w._lodTextureHigh._texture.isReady=!0),w._lodTextureMid&&w._lodTextureMid._texture&&(w._lodTextureMid._texture.isReady=!0),w._lodTextureLow&&w._lodTextureLow._texture&&(w._lodTextureLow._texture.isReady=!0))}function W(w,E){const G=(E=Q(E)).irradiance;if(!G)return;const P=new y.d;h.QE.FromArrayToRef(G.x,0,P.x),h.QE.FromArrayToRef(G.y,0,P.y),h.QE.FromArrayToRef(G.z,0,P.z),h.QE.FromArrayToRef(G.xx,0,P.xx),h.QE.FromArrayToRef(G.yy,0,P.yy),h.QE.FromArrayToRef(G.zz,0,P.zz),h.QE.FromArrayToRef(G.yz,0,P.yz),h.QE.FromArrayToRef(G.zx,0,P.zx),h.QE.FromArrayToRef(G.xy,0,P.xy),w._sphericalPolynomial=P}function T(w,E,G,P,h){const B=K(w.getEngine().createRawCubeTexture(null,w.width,w.format,w.type,w.generateMipMaps,w.invertY,w.samplingMode,w._compression),E).then((()=>w));return w.onRebuildCallback=w=>({proxy:B,isReady:!0,isAsync:!0}),w._source=13,w._bufferViewArrayArray=E,w._lodGenerationScale=P,w._lodGenerationOffset=h,w._sphericalPolynomial=G,K(w,E).then((()=>(w.isReady=!0,w)))}}}]);