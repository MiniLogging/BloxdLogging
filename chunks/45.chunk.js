"use strict";(self.a14qw1h7fq=self.a14qw1h7fq||[]).push([[45],{12851:(R,J,B)=>{B.d(J,{e:()=>n,g:()=>S,h:()=>I,l:()=>V});var Q=B(11030),h=B(11186),y=B(11201),N=B(11370),r=B(11124),q=B(11209),e=(B(11419),B(11291)),D=B(11043);B(11694),B(11402),B(11704);const l="image/png",E=2,O=[134,22,135,150,246,214,150,54];function n(R){const J=new DataView(R.buffer,R.byteOffset,R.byteLength);let B=0;for(let N=0;N<O.length;N++)if(J.getUint8(B++)!==O[N])return D.d.Error("Not a babylon environment map"),null;let Q="",h=0;for(;h=J.getUint8(B++);)Q+=String.fromCharCode(h);let y=JSON.parse(Q);return y=P(y),y.binaryDataPosition=B,y.XD&&(y.XD.lodGenerationScale=y.XD.lodGenerationScale||.8),y}function P(R){if(R.version>E)throw new Error(`Unsupported babylon environment map version "${R.version}". Latest supported version is "${E}".`);return 2===R.version?R:R={...R,version:2,imageType:l}}function A(R,J){const B=(J=P(J)).XD;let Q=Math.log2(J.width);if(Q=Math.round(Q)+1,B.mipmaps.length!==6*Q)throw new Error(`Unsupported specular mipmaps number "${B.mipmaps.length}"`);const h=new Array(Q);for(let y=0;y<Q;y++){h[y]=new Array(6);for(let Q=0;Q<6;Q++){const N=B.mipmaps[6*y+Q];h[y][Q]=new Uint8Array(R.buffer,R.byteOffset+J.binaryDataPosition+N.position,N.length)}}return h}function u(R,J){var B;J=P(J);const Q=new Array(6),h=null===(B=J.irradiance)||void 0===B?void 0:B.irradianceTexture;if(h){if(6!==h.faces.length)throw new Error(`Incorrect irradiance texture faces number "${h.faces.length}"`);for(let B=0;B<6;B++){const y=h.faces[B];Q[B]=new Uint8Array(R.buffer,R.byteOffset+J.binaryDataPosition+y.position,y.length)}}return Q}function S(R,J,B){var Q;const y=(B=P(B)).XD;if(!y)return Promise.resolve([]);R._lodGenerationScale=y.lodGenerationScale;const N=[],r=A(J,B);N.push(a(R,r,B.imageType));const q=null===(Q=B.irradiance)||void 0===Q?void 0:Q.irradianceTexture;if(q){var e,D;const Q=u(J,B);let y=null;null!==(e=B.irradiance)&&void 0!==e&&null!==(D=e.irradianceTexture)&&void 0!==D&&D.dominantDirection&&(y=h.nJ.fJ(B.irradiance.irradianceTexture.dominantDirection)),N.push(s(R,Q,q.size,B.imageType,y))}return Promise.all(N)}async function f(R,J,B,Q,h,y,N,r,q,e,D){return await new Promise(((l,E)=>{if(B){const B=J.createTexture(null,!0,!0,null,1,null,(R=>{E(R)}),R);null===Q||void 0===Q||Q.onEffectCreatedObservable.addOnce((r=>{r.executeWhenCompiled((()=>{Q.externalTextureSamplerBinding=!0,Q.onApply=Q=>{Q._bindTexture("textureSampler",B),Q.setFloat2("scale",1,J._features.needsInvertingBitmap&&R instanceof ImageBitmap?-1:1)},J.scenes.length&&(J.scenes[0].postProcessManager.directRender([Q],e,!0,y,N),J.restoreDefaultFramebuffer(),B.dispose(),URL.revokeObjectURL(h),l())}))}))}else{if(J._uploadImageToTexture(D,R,y,N),r){const B=q[N];B&&J._uploadImageToTexture(B._texture,R,y,0)}l()}}))}async function a(R,J){let B=arguments.length>2&&void 0!==arguments[2]?arguments[2]:l;const Q=R.getEngine();R.format=5,R.type=0,R.generateMipMaps=!0,R._cachedAnisotropicFilteringLevel=null,Q.updateTextureSamplingMode(3,R),await x(R,J,!0,B),R.isReady=!0}async function s(R,J,B){let Q=arguments.length>3&&void 0!==arguments[3]?arguments[3]:l,h=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const y=R.getEngine(),N=new r.c(y,5),e=new q.c(y,N);R._irradianceTexture=e,e._dominantDirection=h,N.isCube=!0,N.format=5,N.type=0,N.generateMipMaps=!0,N._cachedAnisotropicFilteringLevel=null,N.generateMipMaps=!0,N.width=B,N.height=B,y.updateTextureSamplingMode(3,N),await x(N,[J],!1,Q),y.generateMipMapsForCubemap(N),N.isReady=!0}async function x(R,J,h){let N=arguments.length>3&&void 0!==arguments[3]?arguments[3]:l;if(!Q.Tools.IsExponentOfTwo(R.width))throw new Error("Texture size must be a power of two");const D=(0,y.ILog2)(R.width)+1,E=R.getEngine();let O=!1,n=!1,P=null,A=null,u=null;const S=E.getCaps();S.textureLOD?E._features.supportRenderAndCopyToLodForFloatTextures?S.textureHalfFloatRender&&S.textureHalfFloatLinearFiltering?(O=!0,R.type=2):S.textureFloatRender&&S.textureFloatLinearFiltering&&(O=!0,R.type=1):O=!1:(O=!1,n=h);let a=0;if(O)E.isWebGPU?(a=1,await B.e(42).then(B.bind(B,14216))):await B.e(35).then(B.bind(B,14219)),P=new e.d("rgbdDecode","rgbdDecode",null,null,1,null,3,E,!1,void 0,R.type,void 0,null,!1,void 0,a),R._isRGBD=!1,R.invertY=!1,A=E.createRenderTargetCubeTexture(R.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:R.type,format:5});else if(R._isRGBD=!0,R.invertY=!0,n){const J=3;u={};const B=R._lodGenerationScale,Q=R._lodGenerationOffset;for(let h=0;h<J;h++){const y=(D-1)*B+Q,N=Q+(y-Q)*(1-h/(J-1)),e=Math.round(Math.min(Math.max(N,0),y)),l=new r.c(E,2);l.isCube=!0,l.invertY=!0,l.generateMipMaps=!1,E.updateTextureSamplingMode(2,l);const O=new q.c(null);switch(O._isCube=!0,O._texture=l,u[e]=O,h){case 0:R._lodTextureLow=O;break;case 1:R._lodTextureMid=O;break;case 2:R._lodTextureHigh=O}}}const s=[];for(let B=0;B<J.length;B++)for(let Q=0;Q<6;Q++){const h=J[B][Q],y=new Blob([h],{type:N}),r=URL.createObjectURL(y);let q;if(E._features.forceBitmapOverHTMLImageElement)q=E.createImageBitmap(y,{premultiplyAlpha:"none"}).then((async J=>await f(J,E,O,P,r,Q,B,n,u,A,R)));else{const J=new Image;J.src=r,q=new Promise(((h,y)=>{J.onload=()=>{f(J,E,O,P,r,Q,B,n,u,A,R).then((()=>h())).catch((R=>{y(R)}))},J.onerror=R=>{y(R)}}))}s.push(q)}if(await Promise.all(s),J.length<D){let B;const Q=Math.pow(2,D-1-J.length),h=Q*Q*4;switch(R.type){case 0:B=new Uint8Array(h);break;case 2:B=new Uint16Array(h);break;case 1:B=new Float32Array(h)}for(let y=J.length;y<D;y++)for(let J=0;J<6;J++){var x;E._uploadArrayBufferViewToTexture((null===(x=A)||void 0===x?void 0:x.texture)||R,B,J,y)}}if(A){const J=R._irradianceTexture;R._irradianceTexture=null,E._releaseTexture(R),A._swapAndDie(R),R._irradianceTexture=J}P&&P.dispose(),n&&(R._lodTextureHigh&&R._lodTextureHigh._texture&&(R._lodTextureHigh._texture.isReady=!0),R._lodTextureMid&&R._lodTextureMid._texture&&(R._lodTextureMid._texture.isReady=!0),R._lodTextureLow&&R._lodTextureLow._texture&&(R._lodTextureLow._texture.isReady=!0))}function I(R,J){const B=(J=P(J)).irradiance;if(!B)return;const Q=new N.d;h.nJ.FromArrayToRef(B.x,0,Q.x),h.nJ.FromArrayToRef(B.y,0,Q.y),h.nJ.FromArrayToRef(B.z,0,Q.z),h.nJ.FromArrayToRef(B.xx,0,Q.xx),h.nJ.FromArrayToRef(B.yy,0,Q.yy),h.nJ.FromArrayToRef(B.zz,0,Q.zz),h.nJ.FromArrayToRef(B.yz,0,Q.yz),h.nJ.FromArrayToRef(B.zx,0,Q.zx),h.nJ.FromArrayToRef(B.xy,0,Q.xy),R._sphericalPolynomial=Q}function V(R,J,B,Q,h){const y=a(R.getEngine().createRawCubeTexture(null,R.width,R.format,R.type,R.generateMipMaps,R.invertY,R.samplingMode,R._compression),J).then((()=>R));return R.onRebuildCallback=R=>({proxy:y,isReady:!0,isAsync:!0}),R._source=13,R._bufferViewArrayArray=J,R._lodGenerationScale=Q,R._lodGenerationOffset=h,R._sphericalPolynomial=B,a(R,J).then((()=>(R.isReady=!0,R)))}}}]);