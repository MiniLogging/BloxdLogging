"use strict";(self.rsqbdnwe5e=self.rsqbdnwe5e||[]).push([[45],{14041:(N,p,T)=>{T.d(p,{e:()=>k,h:()=>n,i:()=>K,k:()=>F});var A=T(12190),a=T(12371),C=T(12390),U=T(12564),X=T(12302),y=T(12398),e=(T(12617),T(12477)),H=T(12205);T(12890),T(12606),T(12899);const M="image/png",b=2,l=[134,22,135,150,246,214,150,54];function k(N){const p=new DataView(N.buffer,N.byteOffset,N.byteLength);let T=0;for(let U=0;U<l.length;U++)if(p.getUint8(T++)!==l[U])return H.d.Error("Not a babylon environment map"),null;let A="",a=0;for(;a=p.getUint8(T++);)A+=String.fromCharCode(a);let C=JSON.parse(A);return C=x(C),C.binaryDataPosition=T,C.mM&&(C.mM.lodGenerationScale=C.mM.lodGenerationScale||.8),C}function x(N){if(N.version>b)throw new Error(`Unsupported babylon environment map version "${N.version}". Latest supported version is "${b}".`);return 2===N.version?N:N={...N,version:2,imageType:M}}function I(N,p){const T=(p=x(p)).mM;let A=Math.log2(p.width);if(A=Math.round(A)+1,T.mipmaps.length!==6*A)throw new Error(`Unsupported specular mipmaps number "${T.mipmaps.length}"`);const a=new Array(A);for(let C=0;C<A;C++){a[C]=new Array(6);for(let A=0;A<6;A++){const U=T.mipmaps[6*C+A];a[C][A]=new Uint8Array(N.buffer,N.byteOffset+p.binaryDataPosition+U.position,U.length)}}return a}function L(N,p){var T;p=x(p);const A=new Array(6),a=null===(T=p.irradiance)||void 0===T?void 0:T.irradianceTexture;if(a){if(6!==a.faces.length)throw new Error(`Incorrect irradiance texture faces number "${a.faces.length}"`);for(let T=0;T<6;T++){const C=a.faces[T];A[T]=new Uint8Array(N.buffer,N.byteOffset+p.binaryDataPosition+C.position,C.length)}}return A}function n(N,p,T){var A;const C=(T=x(T)).mM;if(!C)return Promise.resolve([]);N._lodGenerationScale=C.lodGenerationScale;const U=[],X=I(p,T);U.push(g(N,X,T.imageType));const y=null===(A=T.irradiance)||void 0===A?void 0:A.irradianceTexture;if(y){var e,H;const A=L(p,T);let C=null;null!==(e=T.irradiance)&&void 0!==e&&null!==(H=e.irradianceTexture)&&void 0!==H&&H.dominantDirection&&(C=a.xp.gp(T.irradiance.irradianceTexture.dominantDirection)),U.push(P(N,A,y.size,T.imageType,C))}return Promise.all(U)}async function w(N,p,T,A,a,C,U,X,y,e,H){return await new Promise(((M,b)=>{if(T){const T=p.createTexture(null,!0,!0,null,1,null,(N=>{b(N)}),N);null===A||void 0===A||A.onEffectCreatedObservable.addOnce((X=>{X.executeWhenCompiled((()=>{A.externalTextureSamplerBinding=!0,A.onApply=A=>{A._bindTexture("textureSampler",T),A.setFloat2("scale",1,p._features.needsInvertingBitmap&&N instanceof ImageBitmap?-1:1)},p.scenes.length&&(p.scenes[0].postProcessManager.directRender([A],e,!0,C,U),p.restoreDefaultFramebuffer(),T.dispose(),URL.revokeObjectURL(a),M())}))}))}else{if(p._uploadImageToTexture(H,N,C,U),X){const T=y[U];T&&p._uploadImageToTexture(T._texture,N,C,0)}M()}}))}async function g(N,p){let T=arguments.length>2&&void 0!==arguments[2]?arguments[2]:M;const A=N.getEngine();N.format=5,N.type=0,N.generateMipMaps=!0,N._cachedAnisotropicFilteringLevel=null,A.updateTextureSamplingMode(3,N),await i(N,p,!0,T),N.isReady=!0}async function P(N,p,T){let A=arguments.length>3&&void 0!==arguments[3]?arguments[3]:M,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const C=N.getEngine(),U=new X.d(C,5),e=new y.c(C,U);N._irradianceTexture=e,e._dominantDirection=a,U.isCube=!0,U.format=5,U.type=0,U.generateMipMaps=!0,U._cachedAnisotropicFilteringLevel=null,U.generateMipMaps=!0,U.width=T,U.height=T,C.updateTextureSamplingMode(3,U),await i(U,[p],!1,A),C.generateMipMapsForCubemap(U),U.isReady=!0}async function i(N,p,a){let U=arguments.length>3&&void 0!==arguments[3]?arguments[3]:M;if(!A.Tools.IsExponentOfTwo(N.width))throw new Error("Texture size must be a power of two");const H=(0,C.ILog2)(N.width)+1,b=N.getEngine();let l=!1,k=!1,x=null,I=null,L=null;const n=b.getCaps();n.textureLOD?b._features.supportRenderAndCopyToLodForFloatTextures?n.textureHalfFloatRender&&n.textureHalfFloatLinearFiltering?(l=!0,N.type=2):n.textureFloatRender&&n.textureFloatLinearFiltering&&(l=!0,N.type=1):l=!1:(l=!1,k=a);let g=0;if(l)b.isWebGPU?(g=1,await T.e(42).then(T.bind(T,15352))):await T.e(35).then(T.bind(T,15355)),x=new e.d("rgbdDecode","rgbdDecode",null,null,1,null,3,b,!1,void 0,N.type,void 0,null,!1,void 0,g),N._isRGBD=!1,N.invertY=!1,I=b.createRenderTargetCubeTexture(N.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:N.type,format:5});else if(N._isRGBD=!0,N.invertY=!0,k){const p=3;L={};const T=N._lodGenerationScale,A=N._lodGenerationOffset;for(let a=0;a<p;a++){const C=(H-1)*T+A,U=A+(C-A)*(1-a/(p-1)),e=Math.round(Math.min(Math.max(U,0),C)),M=new X.d(b,2);M.isCube=!0,M.invertY=!0,M.generateMipMaps=!1,b.updateTextureSamplingMode(2,M);const l=new y.c(null);switch(l._isCube=!0,l._texture=M,L[e]=l,a){case 0:N._lodTextureLow=l;break;case 1:N._lodTextureMid=l;break;case 2:N._lodTextureHigh=l}}}const P=[];for(let T=0;T<p.length;T++)for(let A=0;A<6;A++){const a=p[T][A],C=new Blob([a],{type:U}),X=URL.createObjectURL(C);let y;if(b._features.forceBitmapOverHTMLImageElement)y=b.createImageBitmap(C,{premultiplyAlpha:"none"}).then((async p=>await w(p,b,l,x,X,A,T,k,L,I,N)));else{const p=new Image;p.src=X,y=new Promise(((a,C)=>{p.onload=()=>{w(p,b,l,x,X,A,T,k,L,I,N).then((()=>a())).catch((N=>{C(N)}))},p.onerror=N=>{C(N)}}))}P.push(y)}if(await Promise.all(P),p.length<H){let T;const A=Math.pow(2,H-1-p.length),a=A*A*4;switch(N.type){case 0:T=new Uint8Array(a);break;case 2:T=new Uint16Array(a);break;case 1:T=new Float32Array(a)}for(let C=p.length;C<H;C++)for(let p=0;p<6;p++){var i;b._uploadArrayBufferViewToTexture((null===(i=I)||void 0===i?void 0:i.texture)||N,T,p,C)}}if(I){const p=N._irradianceTexture;N._irradianceTexture=null,b._releaseTexture(N),I._swapAndDie(N),N._irradianceTexture=p}x&&x.dispose(),k&&(N._lodTextureHigh&&N._lodTextureHigh._texture&&(N._lodTextureHigh._texture.isReady=!0),N._lodTextureMid&&N._lodTextureMid._texture&&(N._lodTextureMid._texture.isReady=!0),N._lodTextureLow&&N._lodTextureLow._texture&&(N._lodTextureLow._texture.isReady=!0))}function K(N,p){const T=(p=x(p)).irradiance;if(!T)return;const A=new U.f;a.xp.FromArrayToRef(T.x,0,A.x),a.xp.FromArrayToRef(T.y,0,A.y),a.xp.FromArrayToRef(T.z,0,A.z),a.xp.FromArrayToRef(T.xx,0,A.xx),a.xp.FromArrayToRef(T.yy,0,A.yy),a.xp.FromArrayToRef(T.zz,0,A.zz),a.xp.FromArrayToRef(T.yz,0,A.yz),a.xp.FromArrayToRef(T.zx,0,A.zx),a.xp.FromArrayToRef(T.xy,0,A.xy),N._sphericalPolynomial=A}function F(N,p,T,A,a){const C=g(N.getEngine().createRawCubeTexture(null,N.width,N.format,N.type,N.generateMipMaps,N.invertY,N.samplingMode,N._compression),p).then((()=>N));return N.onRebuildCallback=N=>({proxy:C,isReady:!0,isAsync:!0}),N._source=13,N._bufferViewArrayArray=p,N._lodGenerationScale=A,N._lodGenerationOffset=a,N._sphericalPolynomial=T,g(N,p).then((()=>(N.isReady=!0,N)))}}}]);