"use strict";(self.hmihoa2fs98=self.hmihoa2fs98||[]).push([[45],{13333:(b,d,P)=>{P.d(d,{b:()=>w,c:()=>n,g:()=>g,k:()=>X});var G=P(11484),W=P(11681),i=P(11700),q=P(11858),C=P(11619),J=P(11707),L=(P(11909),P(11784)),x=P(11504);P(12184),P(11890),P(12193);const Y="image/png",s=2,E=[134,22,135,150,246,214,150,54];function w(b){const d=new DataView(b.buffer,b.byteOffset,b.byteLength);let P=0;for(let q=0;q<E.length;q++)if(d.getUint8(P++)!==E[q])return x.e.Error("Not a babylon environment map"),null;let G="",W=0;for(;W=d.getUint8(P++);)G+=String.fromCharCode(W);let i=JSON.parse(G);return i=t(i),i.binaryDataPosition=P,i.Cx&&(i.Cx.lodGenerationScale=i.Cx.lodGenerationScale||.8),i}function t(b){if(b.version>s)throw new Error(`Unsupported babylon environment map version "${b.version}". Latest supported version is "${s}".`);return 2===b.version?b:b={...b,version:2,imageType:Y}}function r(b,d){const P=(d=t(d)).Cx;let G=Math.log2(d.width);if(G=Math.round(G)+1,P.mipmaps.length!==6*G)throw new Error(`Unsupported specular mipmaps number "${P.mipmaps.length}"`);const W=new Array(G);for(let i=0;i<G;i++){W[i]=new Array(6);for(let G=0;G<6;G++){const q=P.mipmaps[6*i+G];W[i][G]=new Uint8Array(b.buffer,b.byteOffset+d.binaryDataPosition+q.position,q.length)}}return W}function B(b,d){var P;d=t(d);const G=new Array(6),W=null===(P=d.irradiance)||void 0===P?void 0:P.irradianceTexture;if(W){if(6!==W.faces.length)throw new Error(`Incorrect irradiance texture faces number "${W.faces.length}"`);for(let P=0;P<6;P++){const i=W.faces[P];G[P]=new Uint8Array(b.buffer,b.byteOffset+d.binaryDataPosition+i.position,i.length)}}return G}function n(b,d,P){var G;const i=(P=t(P)).Cx;if(!i)return Promise.resolve([]);b._lodGenerationScale=i.lodGenerationScale;const q=[],C=r(d,P);q.push(o(b,C,P.imageType));const J=null===(G=P.irradiance)||void 0===G?void 0:G.irradianceTexture;if(J){var L,x;const G=B(d,P);let i=null;null!==(L=P.irradiance)&&void 0!==L&&null!==(x=L.irradianceTexture)&&void 0!==x&&x.dominantDirection&&(i=W.ed.Od(P.irradiance.irradianceTexture.dominantDirection)),q.push(A(b,G,J.size,P.imageType,i))}return Promise.all(q)}async function Z(b,d,P,G,W,i,q,C,J,L,x){return await new Promise(((Y,s)=>{if(P){const P=d.createTexture(null,!0,!0,null,1,null,(b=>{s(b)}),b);null===G||void 0===G||G.onEffectCreatedObservable.addOnce((C=>{C.executeWhenCompiled((()=>{G.externalTextureSamplerBinding=!0,G.onApply=G=>{G._bindTexture("textureSampler",P),G.setFloat2("scale",1,d._features.needsInvertingBitmap&&b instanceof ImageBitmap?-1:1)},d.scenes.length&&(d.scenes[0].postProcessManager.directRender([G],L,!0,i,q),d.restoreDefaultFramebuffer(),P.dispose(),URL.revokeObjectURL(W),Y())}))}))}else{if(d._uploadImageToTexture(x,b,i,q),C){const P=J[q];P&&d._uploadImageToTexture(P._texture,b,i,0)}Y()}}))}async function o(b,d){let P=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Y;const G=b.getEngine();b.format=5,b.type=0,b.generateMipMaps=!0,b._cachedAnisotropicFilteringLevel=null,G.updateTextureSamplingMode(3,b),await f(b,d,!0,P),b.isReady=!0}async function A(b,d,P){let G=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Y,W=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const i=b.getEngine(),q=new C.e(i,5),L=new J.b(i,q);b._irradianceTexture=L,L._dominantDirection=W,q.isCube=!0,q.format=5,q.type=0,q.generateMipMaps=!0,q._cachedAnisotropicFilteringLevel=null,q.generateMipMaps=!0,q.width=P,q.height=P,i.updateTextureSamplingMode(3,q),await f(q,[d],!1,G),i.generateMipMapsForCubemap(q),q.isReady=!0}async function f(b,d,W){let q=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Y;if(!G.Tools.IsExponentOfTwo(b.width))throw new Error("Texture size must be a power of two");const x=(0,i.ILog2)(b.width)+1,s=b.getEngine();let E=!1,w=!1,t=null,r=null,B=null;const n=s.getCaps();n.textureLOD?s._features.supportRenderAndCopyToLodForFloatTextures?n.textureHalfFloatRender&&n.textureHalfFloatLinearFiltering?(E=!0,b.type=2):n.textureFloatRender&&n.textureFloatLinearFiltering&&(E=!0,b.type=1):E=!1:(E=!1,w=W);let o=0;if(E)s.isWebGPU?(o=1,await P.e(42).then(P.bind(P,14705))):await P.e(35).then(P.bind(P,14708)),t=new L.e("rgbdDecode","rgbdDecode",null,null,1,null,3,s,!1,void 0,b.type,void 0,null,!1,void 0,o),b._isRGBD=!1,b.invertY=!1,r=s.createRenderTargetCubeTexture(b.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:b.type,format:5});else if(b._isRGBD=!0,b.invertY=!0,w){const d=3;B={};const P=b._lodGenerationScale,G=b._lodGenerationOffset;for(let W=0;W<d;W++){const i=(x-1)*P+G,q=G+(i-G)*(1-W/(d-1)),L=Math.round(Math.min(Math.max(q,0),i)),Y=new C.e(s,2);Y.isCube=!0,Y.invertY=!0,Y.generateMipMaps=!1,s.updateTextureSamplingMode(2,Y);const E=new J.b(null);switch(E._isCube=!0,E._texture=Y,B[L]=E,W){case 0:b._lodTextureLow=E;break;case 1:b._lodTextureMid=E;break;case 2:b._lodTextureHigh=E}}}const A=[];for(let P=0;P<d.length;P++)for(let G=0;G<6;G++){const W=d[P][G],i=new Blob([W],{type:q}),C=URL.createObjectURL(i);let J;if(s._features.forceBitmapOverHTMLImageElement)J=s.createImageBitmap(i,{premultiplyAlpha:"none"}).then((async d=>await Z(d,s,E,t,C,G,P,w,B,r,b)));else{const d=new Image;d.src=C,J=new Promise(((W,i)=>{d.onload=()=>{Z(d,s,E,t,C,G,P,w,B,r,b).then((()=>W())).catch((b=>{i(b)}))},d.onerror=b=>{i(b)}}))}A.push(J)}if(await Promise.all(A),d.length<x){let P;const G=Math.pow(2,x-1-d.length),W=G*G*4;switch(b.type){case 0:P=new Uint8Array(W);break;case 2:P=new Uint16Array(W);break;case 1:P=new Float32Array(W)}for(let i=d.length;i<x;i++)for(let d=0;d<6;d++){var f;s._uploadArrayBufferViewToTexture((null===(f=r)||void 0===f?void 0:f.texture)||b,P,d,i)}}if(r){const d=b._irradianceTexture;b._irradianceTexture=null,s._releaseTexture(b),r._swapAndDie(b),b._irradianceTexture=d}t&&t.dispose(),w&&(b._lodTextureHigh&&b._lodTextureHigh._texture&&(b._lodTextureHigh._texture.isReady=!0),b._lodTextureMid&&b._lodTextureMid._texture&&(b._lodTextureMid._texture.isReady=!0),b._lodTextureLow&&b._lodTextureLow._texture&&(b._lodTextureLow._texture.isReady=!0))}function g(b,d){const P=(d=t(d)).irradiance;if(!P)return;const G=new q.g;W.ed.FromArrayToRef(P.x,0,G.x),W.ed.FromArrayToRef(P.y,0,G.y),W.ed.FromArrayToRef(P.z,0,G.z),W.ed.FromArrayToRef(P.xx,0,G.xx),W.ed.FromArrayToRef(P.yy,0,G.yy),W.ed.FromArrayToRef(P.zz,0,G.zz),W.ed.FromArrayToRef(P.yz,0,G.yz),W.ed.FromArrayToRef(P.zx,0,G.zx),W.ed.FromArrayToRef(P.xy,0,G.xy),b._sphericalPolynomial=G}function X(b,d,P,G,W){const i=o(b.getEngine().createRawCubeTexture(null,b.width,b.format,b.type,b.generateMipMaps,b.invertY,b.samplingMode,b._compression),d).then((()=>b));return b.onRebuildCallback=b=>({proxy:i,isReady:!0,isAsync:!0}),b._source=13,b._bufferViewArrayArray=d,b._lodGenerationScale=G,b._lodGenerationOffset=W,b._sphericalPolynomial=P,o(b,d).then((()=>(b.isReady=!0,b)))}}}]);