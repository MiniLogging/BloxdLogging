"use strict";(self.h66iwo8dvgq=self.h66iwo8dvgq||[]).push([[45],{13583:(b,X,P)=>{P.d(X,{b:()=>D,d:()=>W,g:()=>Z,h:()=>v});var Q=P(11689),S=P(11834),d=P(11844),N=P(12032),a=P(11787),u=P(11846),w=(P(12093),P(11936)),f=P(11700);P(12363),P(12072),P(12375);const O="image/png",e=2,Y=[134,22,135,150,246,214,150,54];function D(b){const X=new DataView(b.buffer,b.byteOffset,b.byteLength);let P=0;for(let N=0;N<Y.length;N++)if(X.getUint8(P++)!==Y[N])return f.b.Error("Not a babylon environment map"),null;let Q="",S=0;for(;S=X.getUint8(P++);)Q+=String.fromCharCode(S);let d=JSON.parse(Q);return d=E(d),d.binaryDataPosition=P,d.uf&&(d.uf.lodGenerationScale=d.uf.lodGenerationScale||.8),d}function E(b){if(b.version>e)throw new Error(`Unsupported babylon environment map version "${b.version}". Latest supported version is "${e}".`);return 2===b.version?b:b={...b,version:2,imageType:O}}function t(b,X){const P=(X=E(X)).uf;let Q=Math.log2(X.width);if(Q=Math.round(Q)+1,P.mipmaps.length!==6*Q)throw new Error(`Unsupported specular mipmaps number "${P.mipmaps.length}"`);const S=new Array(Q);for(let d=0;d<Q;d++){S[d]=new Array(6);for(let Q=0;Q<6;Q++){const N=P.mipmaps[6*d+Q];S[d][Q]=new Uint8Array(b.buffer,b.byteOffset+X.binaryDataPosition+N.position,N.length)}}return S}function B(b,X){var P;X=E(X);const Q=new Array(6),S=null===(P=X.irradiance)||void 0===P?void 0:P.irradianceTexture;if(S){if(6!==S.faces.length)throw new Error(`Incorrect irradiance texture faces number "${S.faces.length}"`);for(let P=0;P<6;P++){const d=S.faces[P];Q[P]=new Uint8Array(b.buffer,b.byteOffset+X.binaryDataPosition+d.position,d.length)}}return Q}function W(b,X,P){var Q;const d=(P=E(P)).uf;if(!d)return Promise.resolve([]);b._lodGenerationScale=d.lodGenerationScale;const N=[],a=t(X,P);N.push(y(b,a,P.imageType));const u=null===(Q=P.irradiance)||void 0===Q?void 0:Q.irradianceTexture;if(u){var w,f;const Q=B(X,P);let d=null;null!==(w=P.irradiance)&&void 0!==w&&null!==(f=w.irradianceTexture)&&void 0!==f&&f.dominantDirection&&(d=S.tX.hX(P.irradiance.irradianceTexture.dominantDirection)),N.push(h(b,Q,u.size,P.imageType,d))}return Promise.all(N)}async function n(b,X,P,Q,S,d,N,a,u,w,f){return await new Promise(((O,e)=>{if(P){const P=X.createTexture(null,!0,!0,null,1,null,(b=>{e(b)}),b);null===Q||void 0===Q||Q.onEffectCreatedObservable.addOnce((a=>{a.executeWhenCompiled((()=>{Q.externalTextureSamplerBinding=!0,Q.onApply=Q=>{Q._bindTexture("textureSampler",P),Q.setFloat2("scale",1,X._features.needsInvertingBitmap&&b instanceof ImageBitmap?-1:1)},X.scenes.length&&(X.scenes[0].postProcessManager.directRender([Q],w,!0,d,N),X.restoreDefaultFramebuffer(),P.dispose(),URL.revokeObjectURL(S),O())}))}))}else{if(X._uploadImageToTexture(f,b,d,N),a){const P=u[N];P&&X._uploadImageToTexture(P._texture,b,d,0)}O()}}))}async function y(b,X){let P=arguments.length>2&&void 0!==arguments[2]?arguments[2]:O;const Q=b.getEngine();b.format=5,b.type=0,b.generateMipMaps=!0,b._cachedAnisotropicFilteringLevel=null,Q.updateTextureSamplingMode(3,b),await L(b,X,!0,P),b.isReady=!0}async function h(b,X,P){let Q=arguments.length>3&&void 0!==arguments[3]?arguments[3]:O,S=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const d=b.getEngine(),N=new a.e(d,5),w=new u.e(d,N);b._irradianceTexture=w,w._dominantDirection=S,N.isCube=!0,N.format=5,N.type=0,N.generateMipMaps=!0,N._cachedAnisotropicFilteringLevel=null,N.generateMipMaps=!0,N.width=P,N.height=P,d.updateTextureSamplingMode(3,N),await L(N,[X],!1,Q),d.generateMipMapsForCubemap(N),N.isReady=!0}async function L(b,X,S){let N=arguments.length>3&&void 0!==arguments[3]?arguments[3]:O;if(!Q.Tools.IsExponentOfTwo(b.width))throw new Error("Texture size must be a power of two");const f=(0,d.ILog2)(b.width)+1,e=b.getEngine();let Y=!1,D=!1,E=null,t=null,B=null;const W=e.getCaps();W.textureLOD?e._features.supportRenderAndCopyToLodForFloatTextures?W.textureHalfFloatRender&&W.textureHalfFloatLinearFiltering?(Y=!0,b.type=2):W.textureFloatRender&&W.textureFloatLinearFiltering&&(Y=!0,b.type=1):Y=!1:(Y=!1,D=S);let y=0;if(Y)e.isWebGPU?(y=1,await P.e(42).then(P.bind(P,14980))):await P.e(35).then(P.bind(P,14988)),E=new w.b("rgbdDecode","rgbdDecode",null,null,1,null,3,e,!1,void 0,b.type,void 0,null,!1,void 0,y),b._isRGBD=!1,b.invertY=!1,t=e.createRenderTargetCubeTexture(b.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:b.type,format:5});else if(b._isRGBD=!0,b.invertY=!0,D){const X=3;B={};const P=b._lodGenerationScale,Q=b._lodGenerationOffset;for(let S=0;S<X;S++){const d=(f-1)*P+Q,N=Q+(d-Q)*(1-S/(X-1)),w=Math.round(Math.min(Math.max(N,0),d)),O=new a.e(e,2);O.isCube=!0,O.invertY=!0,O.generateMipMaps=!1,e.updateTextureSamplingMode(2,O);const Y=new u.e(null);switch(Y._isCube=!0,Y._texture=O,B[w]=Y,S){case 0:b._lodTextureLow=Y;break;case 1:b._lodTextureMid=Y;break;case 2:b._lodTextureHigh=Y}}}const h=[];for(let P=0;P<X.length;P++)for(let Q=0;Q<6;Q++){const S=X[P][Q],d=new Blob([S],{type:N}),a=URL.createObjectURL(d);let u;if(e._features.forceBitmapOverHTMLImageElement)u=e.createImageBitmap(d,{premultiplyAlpha:"none"}).then((async X=>await n(X,e,Y,E,a,Q,P,D,B,t,b)));else{const X=new Image;X.src=a,u=new Promise(((S,d)=>{X.onload=()=>{n(X,e,Y,E,a,Q,P,D,B,t,b).then((()=>S())).catch((b=>{d(b)}))},X.onerror=b=>{d(b)}}))}h.push(u)}if(await Promise.all(h),X.length<f){let P;const Q=Math.pow(2,f-1-X.length),S=Q*Q*4;switch(b.type){case 0:P=new Uint8Array(S);break;case 2:P=new Uint16Array(S);break;case 1:P=new Float32Array(S)}for(let d=X.length;d<f;d++)for(let X=0;X<6;X++){var L;e._uploadArrayBufferViewToTexture((null===(L=t)||void 0===L?void 0:L.texture)||b,P,X,d)}}if(t){const X=b._irradianceTexture;b._irradianceTexture=null,e._releaseTexture(b),t._swapAndDie(b),b._irradianceTexture=X}E&&E.dispose(),D&&(b._lodTextureHigh&&b._lodTextureHigh._texture&&(b._lodTextureHigh._texture.isReady=!0),b._lodTextureMid&&b._lodTextureMid._texture&&(b._lodTextureMid._texture.isReady=!0),b._lodTextureLow&&b._lodTextureLow._texture&&(b._lodTextureLow._texture.isReady=!0))}function Z(b,X){const P=(X=E(X)).irradiance;if(!P)return;const Q=new N.d;S.tX.FromArrayToRef(P.x,0,Q.x),S.tX.FromArrayToRef(P.y,0,Q.y),S.tX.FromArrayToRef(P.z,0,Q.z),S.tX.FromArrayToRef(P.xx,0,Q.xx),S.tX.FromArrayToRef(P.yy,0,Q.yy),S.tX.FromArrayToRef(P.zz,0,Q.zz),S.tX.FromArrayToRef(P.yz,0,Q.yz),S.tX.FromArrayToRef(P.zx,0,Q.zx),S.tX.FromArrayToRef(P.xy,0,Q.xy),b._sphericalPolynomial=Q}function v(b,X,P,Q,S){const d=y(b.getEngine().createRawCubeTexture(null,b.width,b.format,b.type,b.generateMipMaps,b.invertY,b.samplingMode,b._compression),X).then((()=>b));return b.onRebuildCallback=b=>({proxy:d,isReady:!0,isAsync:!0}),b._source=13,b._bufferViewArrayArray=X,b._lodGenerationScale=Q,b._lodGenerationOffset=S,b._sphericalPolynomial=P,y(b,X).then((()=>(b.isReady=!0,b)))}}}]);