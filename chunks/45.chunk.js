"use strict";(self["3b8bnhi4gzj"]=self["3b8bnhi4gzj"]||[]).push([[45],{13421:(Z,h,V)=>{V.d(h,{d:()=>u,h:()=>q,l:()=>C,n:()=>l});var v=V(11564),A=V(11729),H=V(11748),K=V(11925),d=V(11673),a=V(11754),n=(V(11983),V(11842)),x=V(11580);V(12243),V(11971),V(12254);const N="image/png",D=2,k=[134,22,135,150,246,214,150,54];function u(Z){const h=new DataView(Z.buffer,Z.byteOffset,Z.byteLength);let V=0;for(let K=0;K<k.length;K++)if(h.getUint8(V++)!==k[K])return x.b.Error("Not a babylon environment map"),null;let v="",A=0;for(;A=h.getUint8(V++);)v+=String.fromCharCode(A);let H=JSON.parse(v);return H=F(H),H.binaryDataPosition=V,H.Lx&&(H.Lx.lodGenerationScale=H.Lx.lodGenerationScale||.8),H}function F(Z){if(Z.version>D)throw new Error(`Unsupported babylon environment map version "${Z.version}". Latest supported version is "${D}".`);return 2===Z.version?Z:Z={...Z,version:2,imageType:N}}function b(Z,h){const V=(h=F(h)).Lx;let v=Math.log2(h.width);if(v=Math.round(v)+1,V.mipmaps.length!==6*v)throw new Error(`Unsupported specular mipmaps number "${V.mipmaps.length}"`);const A=new Array(v);for(let H=0;H<v;H++){A[H]=new Array(6);for(let v=0;v<6;v++){const K=V.mipmaps[6*H+v];A[H][v]=new Uint8Array(Z.buffer,Z.byteOffset+h.binaryDataPosition+K.position,K.length)}}return A}function o(Z,h){var V;h=F(h);const v=new Array(6),A=null===(V=h.irradiance)||void 0===V?void 0:V.irradianceTexture;if(A){if(6!==A.faces.length)throw new Error(`Incorrect irradiance texture faces number "${A.faces.length}"`);for(let V=0;V<6;V++){const H=A.faces[V];v[V]=new Uint8Array(Z.buffer,Z.byteOffset+h.binaryDataPosition+H.position,H.length)}}return v}function q(Z,h,V){var v;const H=(V=F(V)).Lx;if(!H)return Promise.resolve([]);Z._lodGenerationScale=H.lodGenerationScale;const K=[],d=b(h,V);K.push(E(Z,d,V.imageType));const a=null===(v=V.irradiance)||void 0===v?void 0:v.irradianceTexture;if(a){var n,x;const v=o(h,V);let H=null;null!==(n=V.irradiance)&&void 0!==n&&null!==(x=n.irradianceTexture)&&void 0!==x&&x.dominantDirection&&(H=A.Ch.eh(V.irradiance.irradianceTexture.dominantDirection)),K.push(j(Z,v,a.size,V.imageType,H))}return Promise.all(K)}async function X(Z,h,V,v,A,H,K,d,a,n,x){return await new Promise(((N,D)=>{if(V){const V=h.createTexture(null,!0,!0,null,1,null,(Z=>{D(Z)}),Z);null===v||void 0===v||v.onEffectCreatedObservable.addOnce((d=>{d.executeWhenCompiled((()=>{v.externalTextureSamplerBinding=!0,v.onApply=v=>{v._bindTexture("textureSampler",V),v.setFloat2("scale",1,h._features.needsInvertingBitmap&&Z instanceof ImageBitmap?-1:1)},h.scenes.length&&(h.scenes[0].postProcessManager.directRender([v],n,!0,H,K),h.restoreDefaultFramebuffer(),V.dispose(),URL.revokeObjectURL(A),N())}))}))}else{if(h._uploadImageToTexture(x,Z,H,K),d){const V=a[K];V&&h._uploadImageToTexture(V._texture,Z,H,0)}N()}}))}async function E(Z,h){let V=arguments.length>2&&void 0!==arguments[2]?arguments[2]:N;const v=Z.getEngine();Z.format=5,Z.type=0,Z.generateMipMaps=!0,Z._cachedAnisotropicFilteringLevel=null,v.updateTextureSamplingMode(3,Z),await P(Z,h,!0,V),Z.isReady=!0}async function j(Z,h,V){let v=arguments.length>3&&void 0!==arguments[3]?arguments[3]:N,A=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const H=Z.getEngine(),K=new d.c(H,5),n=new a.e(H,K);Z._irradianceTexture=n,n._dominantDirection=A,K.isCube=!0,K.format=5,K.type=0,K.generateMipMaps=!0,K._cachedAnisotropicFilteringLevel=null,K.generateMipMaps=!0,K.width=V,K.height=V,H.updateTextureSamplingMode(3,K),await P(K,[h],!1,v),H.generateMipMapsForCubemap(K),K.isReady=!0}async function P(Z,h,A){let K=arguments.length>3&&void 0!==arguments[3]?arguments[3]:N;if(!v.Tools.IsExponentOfTwo(Z.width))throw new Error("Texture size must be a power of two");const x=(0,H.ILog2)(Z.width)+1,D=Z.getEngine();let k=!1,u=!1,F=null,b=null,o=null;const q=D.getCaps();q.textureLOD?D._features.supportRenderAndCopyToLodForFloatTextures?q.textureHalfFloatRender&&q.textureHalfFloatLinearFiltering?(k=!0,Z.type=2):q.textureFloatRender&&q.textureFloatLinearFiltering&&(k=!0,Z.type=1):k=!1:(k=!1,u=A);let E=0;if(k)D.isWebGPU?(E=1,await V.e(42).then(V.bind(V,14817))):await V.e(35).then(V.bind(V,14826)),F=new n.d("rgbdDecode","rgbdDecode",null,null,1,null,3,D,!1,void 0,Z.type,void 0,null,!1,void 0,E),Z._isRGBD=!1,Z.invertY=!1,b=D.createRenderTargetCubeTexture(Z.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:Z.type,format:5});else if(Z._isRGBD=!0,Z.invertY=!0,u){const h=3;o={};const V=Z._lodGenerationScale,v=Z._lodGenerationOffset;for(let A=0;A<h;A++){const H=(x-1)*V+v,K=v+(H-v)*(1-A/(h-1)),n=Math.round(Math.min(Math.max(K,0),H)),N=new d.c(D,2);N.isCube=!0,N.invertY=!0,N.generateMipMaps=!1,D.updateTextureSamplingMode(2,N);const k=new a.e(null);switch(k._isCube=!0,k._texture=N,o[n]=k,A){case 0:Z._lodTextureLow=k;break;case 1:Z._lodTextureMid=k;break;case 2:Z._lodTextureHigh=k}}}const j=[];for(let V=0;V<h.length;V++)for(let v=0;v<6;v++){const A=h[V][v],H=new Blob([A],{type:K}),d=URL.createObjectURL(H);let a;if(D._features.forceBitmapOverHTMLImageElement)a=D.createImageBitmap(H,{premultiplyAlpha:"none"}).then((async h=>await X(h,D,k,F,d,v,V,u,o,b,Z)));else{const h=new Image;h.src=d,a=new Promise(((A,H)=>{h.onload=()=>{X(h,D,k,F,d,v,V,u,o,b,Z).then((()=>A())).catch((Z=>{H(Z)}))},h.onerror=Z=>{H(Z)}}))}j.push(a)}if(await Promise.all(j),h.length<x){let V;const v=Math.pow(2,x-1-h.length),A=v*v*4;switch(Z.type){case 0:V=new Uint8Array(A);break;case 2:V=new Uint16Array(A);break;case 1:V=new Float32Array(A)}for(let H=h.length;H<x;H++)for(let h=0;h<6;h++){var P;D._uploadArrayBufferViewToTexture((null===(P=b)||void 0===P?void 0:P.texture)||Z,V,h,H)}}if(b){const h=Z._irradianceTexture;Z._irradianceTexture=null,D._releaseTexture(Z),b._swapAndDie(Z),Z._irradianceTexture=h}F&&F.dispose(),u&&(Z._lodTextureHigh&&Z._lodTextureHigh._texture&&(Z._lodTextureHigh._texture.isReady=!0),Z._lodTextureMid&&Z._lodTextureMid._texture&&(Z._lodTextureMid._texture.isReady=!0),Z._lodTextureLow&&Z._lodTextureLow._texture&&(Z._lodTextureLow._texture.isReady=!0))}function C(Z,h){const V=(h=F(h)).irradiance;if(!V)return;const v=new K.g;A.Ch.FromArrayToRef(V.x,0,v.x),A.Ch.FromArrayToRef(V.y,0,v.y),A.Ch.FromArrayToRef(V.z,0,v.z),A.Ch.FromArrayToRef(V.xx,0,v.xx),A.Ch.FromArrayToRef(V.yy,0,v.yy),A.Ch.FromArrayToRef(V.zz,0,v.zz),A.Ch.FromArrayToRef(V.yz,0,v.yz),A.Ch.FromArrayToRef(V.zx,0,v.zx),A.Ch.FromArrayToRef(V.xy,0,v.xy),Z._sphericalPolynomial=v}function l(Z,h,V,v,A){const H=E(Z.getEngine().createRawCubeTexture(null,Z.width,Z.format,Z.type,Z.generateMipMaps,Z.invertY,Z.samplingMode,Z._compression),h).then((()=>Z));return Z.onRebuildCallback=Z=>({proxy:H,isReady:!0,isAsync:!0}),Z._source=13,Z._bufferViewArrayArray=h,Z._lodGenerationScale=v,Z._lodGenerationOffset=A,Z._sphericalPolynomial=V,E(Z,h).then((()=>(Z.isReady=!0,Z)))}}}]);