"use strict";(self.wx5iyvo7rvn=self.wx5iyvo7rvn||[]).push([[45],{12771:(P,e,n)=>{n.d(e,{e:()=>Y,i:()=>J,l:()=>B,n:()=>l});var H=n(10972),S=n(11133),p=n(11148),k=n(11338),m=n(11079),t=n(11156),C=(n(11379),n(11241)),R=n(10988);n(11615),n(11360),n(11630);const q="image/png",A=2,F=[134,22,135,150,246,214,150,54];function Y(P){const e=new DataView(P.buffer,P.byteOffset,P.byteLength);let n=0;for(let k=0;k<F.length;k++)if(e.getUint8(n++)!==F[k])return R.c.Error("Not a babylon environment map"),null;let H="",S=0;for(;S=e.getUint8(n++);)H+=String.fromCharCode(S);let p=JSON.parse(H);return p=j(p),p.binaryDataPosition=n,p.tR&&(p.tR.lodGenerationScale=p.tR.lodGenerationScale||.8),p}function j(P){if(P.version>A)throw new Error(`Unsupported babylon environment map version "${P.version}". Latest supported version is "${A}".`);return 2===P.version?P:P={...P,version:2,imageType:q}}function z(P,e){const n=(e=j(e)).tR;let H=Math.log2(e.width);if(H=Math.round(H)+1,n.mipmaps.length!==6*H)throw new Error(`Unsupported specular mipmaps number "${n.mipmaps.length}"`);const S=new Array(H);for(let p=0;p<H;p++){S[p]=new Array(6);for(let H=0;H<6;H++){const k=n.mipmaps[6*p+H];S[p][H]=new Uint8Array(P.buffer,P.byteOffset+e.binaryDataPosition+k.position,k.length)}}return S}function w(P,e){var n;e=j(e);const H=new Array(6),S=null===(n=e.irradiance)||void 0===n?void 0:n.irradianceTexture;if(S){if(6!==S.faces.length)throw new Error(`Incorrect irradiance texture faces number "${S.faces.length}"`);for(let n=0;n<6;n++){const p=S.faces[n];H[n]=new Uint8Array(P.buffer,P.byteOffset+e.binaryDataPosition+p.position,p.length)}}return H}function J(P,e,n){var H;const p=(n=j(n)).tR;if(!p)return Promise.resolve([]);P._lodGenerationScale=p.lodGenerationScale;const k=[],m=z(e,n);k.push(O(P,m,n.imageType));const t=null===(H=n.irradiance)||void 0===H?void 0:H.irradianceTexture;if(t){var C,R;const H=w(e,n);let p=null;null!==(C=n.irradiance)&&void 0!==C&&null!==(R=C.irradianceTexture)&&void 0!==R&&R.dominantDirection&&(p=S.Ie.Qe(n.irradiance.irradianceTexture.dominantDirection)),k.push(V(P,H,t.size,n.imageType,p))}return Promise.all(k)}async function I(P,e,n,H,S,p,k,m,t,C,R){return await new Promise(((q,A)=>{if(n){const n=e.createTexture(null,!0,!0,null,1,null,(P=>{A(P)}),P);null===H||void 0===H||H.onEffectCreatedObservable.addOnce((m=>{m.executeWhenCompiled((()=>{H.externalTextureSamplerBinding=!0,H.onApply=H=>{H._bindTexture("textureSampler",n),H.setFloat2("scale",1,e._features.needsInvertingBitmap&&P instanceof ImageBitmap?-1:1)},e.scenes.length&&(e.scenes[0].postProcessManager.directRender([H],C,!0,p,k),e.restoreDefaultFramebuffer(),n.dispose(),URL.revokeObjectURL(S),q())}))}))}else{if(e._uploadImageToTexture(R,P,p,k),m){const n=t[k];n&&e._uploadImageToTexture(n._texture,P,p,0)}q()}}))}async function O(P,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:q;const H=P.getEngine();P.format=5,P.type=0,P.generateMipMaps=!0,P._cachedAnisotropicFilteringLevel=null,H.updateTextureSamplingMode(3,P),await i(P,e,!0,n),P.isReady=!0}async function V(P,e,n){let H=arguments.length>3&&void 0!==arguments[3]?arguments[3]:q,S=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const p=P.getEngine(),k=new m.b(p,5),C=new t.c(p,k);P._irradianceTexture=C,C._dominantDirection=S,k.isCube=!0,k.format=5,k.type=0,k.generateMipMaps=!0,k._cachedAnisotropicFilteringLevel=null,k.generateMipMaps=!0,k.width=n,k.height=n,p.updateTextureSamplingMode(3,k),await i(k,[e],!1,H),p.generateMipMapsForCubemap(k),k.isReady=!0}async function i(P,e,S){let k=arguments.length>3&&void 0!==arguments[3]?arguments[3]:q;if(!H.Tools.IsExponentOfTwo(P.width))throw new Error("Texture size must be a power of two");const R=(0,p.ILog2)(P.width)+1,A=P.getEngine();let F=!1,Y=!1,j=null,z=null,w=null;const J=A.getCaps();J.textureLOD?A._features.supportRenderAndCopyToLodForFloatTextures?J.textureHalfFloatRender&&J.textureHalfFloatLinearFiltering?(F=!0,P.type=2):J.textureFloatRender&&J.textureFloatLinearFiltering&&(F=!0,P.type=1):F=!1:(F=!1,Y=S);let O=0;if(F)A.isWebGPU?(O=1,await n.e(42).then(n.bind(n,14105))):await n.e(35).then(n.bind(n,14107)),j=new C.e("rgbdDecode","rgbdDecode",null,null,1,null,3,A,!1,void 0,P.type,void 0,null,!1,void 0,O),P._isRGBD=!1,P.invertY=!1,z=A.createRenderTargetCubeTexture(P.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:P.type,format:5});else if(P._isRGBD=!0,P.invertY=!0,Y){const e=3;w={};const n=P._lodGenerationScale,H=P._lodGenerationOffset;for(let S=0;S<e;S++){const p=(R-1)*n+H,k=H+(p-H)*(1-S/(e-1)),C=Math.round(Math.min(Math.max(k,0),p)),q=new m.b(A,2);q.isCube=!0,q.invertY=!0,q.generateMipMaps=!1,A.updateTextureSamplingMode(2,q);const F=new t.c(null);switch(F._isCube=!0,F._texture=q,w[C]=F,S){case 0:P._lodTextureLow=F;break;case 1:P._lodTextureMid=F;break;case 2:P._lodTextureHigh=F}}}const V=[];for(let n=0;n<e.length;n++)for(let H=0;H<6;H++){const S=e[n][H],p=new Blob([S],{type:k}),m=URL.createObjectURL(p);let t;if(A._features.forceBitmapOverHTMLImageElement)t=A.createImageBitmap(p,{premultiplyAlpha:"none"}).then((async e=>await I(e,A,F,j,m,H,n,Y,w,z,P)));else{const e=new Image;e.src=m,t=new Promise(((S,p)=>{e.onload=()=>{I(e,A,F,j,m,H,n,Y,w,z,P).then((()=>S())).catch((P=>{p(P)}))},e.onerror=P=>{p(P)}}))}V.push(t)}if(await Promise.all(V),e.length<R){let n;const H=Math.pow(2,R-1-e.length),S=H*H*4;switch(P.type){case 0:n=new Uint8Array(S);break;case 2:n=new Uint16Array(S);break;case 1:n=new Float32Array(S)}for(let p=e.length;p<R;p++)for(let e=0;e<6;e++){var i;A._uploadArrayBufferViewToTexture((null===(i=z)||void 0===i?void 0:i.texture)||P,n,e,p)}}if(z){const e=P._irradianceTexture;P._irradianceTexture=null,A._releaseTexture(P),z._swapAndDie(P),P._irradianceTexture=e}j&&j.dispose(),Y&&(P._lodTextureHigh&&P._lodTextureHigh._texture&&(P._lodTextureHigh._texture.isReady=!0),P._lodTextureMid&&P._lodTextureMid._texture&&(P._lodTextureMid._texture.isReady=!0),P._lodTextureLow&&P._lodTextureLow._texture&&(P._lodTextureLow._texture.isReady=!0))}function B(P,e){const n=(e=j(e)).irradiance;if(!n)return;const H=new k.d;S.Ie.FromArrayToRef(n.x,0,H.x),S.Ie.FromArrayToRef(n.y,0,H.y),S.Ie.FromArrayToRef(n.z,0,H.z),S.Ie.FromArrayToRef(n.xx,0,H.xx),S.Ie.FromArrayToRef(n.yy,0,H.yy),S.Ie.FromArrayToRef(n.zz,0,H.zz),S.Ie.FromArrayToRef(n.yz,0,H.yz),S.Ie.FromArrayToRef(n.zx,0,H.zx),S.Ie.FromArrayToRef(n.xy,0,H.xy),P._sphericalPolynomial=H}function l(P,e,n,H,S){const p=O(P.getEngine().createRawCubeTexture(null,P.width,P.format,P.type,P.generateMipMaps,P.invertY,P.samplingMode,P._compression),e).then((()=>P));return P.onRebuildCallback=P=>({proxy:p,isReady:!0,isAsync:!0}),P._source=13,P._bufferViewArrayArray=e,P._lodGenerationScale=H,P._lodGenerationOffset=S,P._sphericalPolynomial=n,O(P,e).then((()=>(P.isReady=!0,P)))}}}]);