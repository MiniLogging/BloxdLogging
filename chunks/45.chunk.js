"use strict";(self.xeuzlpp225k=self.xeuzlpp225k||[]).push([[45],{13016:(k,Q,i)=>{i.d(Q,{b:()=>F,f:()=>h,h:()=>L,k:()=>s});var Z=i(11119),U=i(11298),C=i(11311),B=i(11481),o=i(11235),m=i(11320),O=(i(11538),i(11400)),J=i(11134);i(11781),i(11522),i(11789);const G="image/png",H=2,e=[134,22,135,150,246,214,150,54];function F(k){const Q=new DataView(k.buffer,k.byteOffset,k.byteLength);let i=0;for(let B=0;B<e.length;B++)if(Q.getUint8(i++)!==e[B])return J.c.Error("Not a babylon environment map"),null;let Z="",U=0;for(;U=Q.getUint8(i++);)Z+=String.fromCharCode(U);let C=JSON.parse(Z);return C=z(C),C.binaryDataPosition=i,C.BJ&&(C.BJ.lodGenerationScale=C.BJ.lodGenerationScale||.8),C}function z(k){if(k.version>H)throw new Error(`Unsupported babylon environment map version "${k.version}". Latest supported version is "${H}".`);return 2===k.version?k:k={...k,version:2,imageType:G}}function E(k,Q){const i=(Q=z(Q)).BJ;let Z=Math.log2(Q.width);if(Z=Math.round(Z)+1,i.mipmaps.length!==6*Z)throw new Error(`Unsupported specular mipmaps number "${i.mipmaps.length}"`);const U=new Array(Z);for(let C=0;C<Z;C++){U[C]=new Array(6);for(let Z=0;Z<6;Z++){const B=i.mipmaps[6*C+Z];U[C][Z]=new Uint8Array(k.buffer,k.byteOffset+Q.binaryDataPosition+B.position,B.length)}}return U}function l(k,Q){var i;Q=z(Q);const Z=new Array(6),U=null===(i=Q.irradiance)||void 0===i?void 0:i.irradianceTexture;if(U){if(6!==U.faces.length)throw new Error(`Incorrect irradiance texture faces number "${U.faces.length}"`);for(let i=0;i<6;i++){const C=U.faces[i];Z[i]=new Uint8Array(k.buffer,k.byteOffset+Q.binaryDataPosition+C.position,C.length)}}return Z}function h(k,Q,i){var Z;const C=(i=z(i)).BJ;if(!C)return Promise.resolve([]);k._lodGenerationScale=C.lodGenerationScale;const B=[],o=E(Q,i);B.push(f(k,o,i.imageType));const m=null===(Z=i.irradiance)||void 0===Z?void 0:Z.irradianceTexture;if(m){var O,J;const Z=l(Q,i);let C=null;null!==(O=i.irradiance)&&void 0!==O&&null!==(J=O.irradianceTexture)&&void 0!==J&&J.dominantDirection&&(C=U.zQ.fQ(i.irradiance.irradianceTexture.dominantDirection)),B.push(Y(k,Z,m.size,i.imageType,C))}return Promise.all(B)}async function c(k,Q,i,Z,U,C,B,o,m,O,J){return await new Promise(((G,H)=>{if(i){const i=Q.createTexture(null,!0,!0,null,1,null,(k=>{H(k)}),k);null===Z||void 0===Z||Z.onEffectCreatedObservable.addOnce((o=>{o.executeWhenCompiled((()=>{Z.externalTextureSamplerBinding=!0,Z.onApply=Z=>{Z._bindTexture("textureSampler",i),Z.setFloat2("scale",1,Q._features.needsInvertingBitmap&&k instanceof ImageBitmap?-1:1)},Q.scenes.length&&(Q.scenes[0].postProcessManager.directRender([Z],O,!0,C,B),Q.restoreDefaultFramebuffer(),i.dispose(),URL.revokeObjectURL(U),G())}))}))}else{if(Q._uploadImageToTexture(J,k,C,B),o){const i=m[B];i&&Q._uploadImageToTexture(i._texture,k,C,0)}G()}}))}async function f(k,Q){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:G;const Z=k.getEngine();k.format=5,k.type=0,k.generateMipMaps=!0,k._cachedAnisotropicFilteringLevel=null,Z.updateTextureSamplingMode(3,k),await y(k,Q,!0,i),k.isReady=!0}async function Y(k,Q,i){let Z=arguments.length>3&&void 0!==arguments[3]?arguments[3]:G,U=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const C=k.getEngine(),B=new o.c(C,5),O=new m.c(C,B);k._irradianceTexture=O,O._dominantDirection=U,B.isCube=!0,B.format=5,B.type=0,B.generateMipMaps=!0,B._cachedAnisotropicFilteringLevel=null,B.generateMipMaps=!0,B.width=i,B.height=i,C.updateTextureSamplingMode(3,B),await y(B,[Q],!1,Z),C.generateMipMapsForCubemap(B),B.isReady=!0}async function y(k,Q,U){let B=arguments.length>3&&void 0!==arguments[3]?arguments[3]:G;if(!Z.Tools.IsExponentOfTwo(k.width))throw new Error("Texture size must be a power of two");const J=(0,C.ILog2)(k.width)+1,H=k.getEngine();let e=!1,F=!1,z=null,E=null,l=null;const h=H.getCaps();h.textureLOD?H._features.supportRenderAndCopyToLodForFloatTextures?h.textureHalfFloatRender&&h.textureHalfFloatLinearFiltering?(e=!0,k.type=2):h.textureFloatRender&&h.textureFloatLinearFiltering&&(e=!0,k.type=1):e=!1:(e=!1,F=U);let f=0;if(e)H.isWebGPU?(f=1,await i.e(42).then(i.bind(i,14358))):await i.e(35).then(i.bind(i,14365)),z=new O.c("rgbdDecode","rgbdDecode",null,null,1,null,3,H,!1,void 0,k.type,void 0,null,!1,void 0,f),k._isRGBD=!1,k.invertY=!1,E=H.createRenderTargetCubeTexture(k.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:k.type,format:5});else if(k._isRGBD=!0,k.invertY=!0,F){const Q=3;l={};const i=k._lodGenerationScale,Z=k._lodGenerationOffset;for(let U=0;U<Q;U++){const C=(J-1)*i+Z,B=Z+(C-Z)*(1-U/(Q-1)),O=Math.round(Math.min(Math.max(B,0),C)),G=new o.c(H,2);G.isCube=!0,G.invertY=!0,G.generateMipMaps=!1,H.updateTextureSamplingMode(2,G);const e=new m.c(null);switch(e._isCube=!0,e._texture=G,l[O]=e,U){case 0:k._lodTextureLow=e;break;case 1:k._lodTextureMid=e;break;case 2:k._lodTextureHigh=e}}}const Y=[];for(let i=0;i<Q.length;i++)for(let Z=0;Z<6;Z++){const U=Q[i][Z],C=new Blob([U],{type:B}),o=URL.createObjectURL(C);let m;if(H._features.forceBitmapOverHTMLImageElement)m=H.createImageBitmap(C,{premultiplyAlpha:"none"}).then((async Q=>await c(Q,H,e,z,o,Z,i,F,l,E,k)));else{const Q=new Image;Q.src=o,m=new Promise(((U,C)=>{Q.onload=()=>{c(Q,H,e,z,o,Z,i,F,l,E,k).then((()=>U())).catch((k=>{C(k)}))},Q.onerror=k=>{C(k)}}))}Y.push(m)}if(await Promise.all(Y),Q.length<J){let i;const Z=Math.pow(2,J-1-Q.length),U=Z*Z*4;switch(k.type){case 0:i=new Uint8Array(U);break;case 2:i=new Uint16Array(U);break;case 1:i=new Float32Array(U)}for(let C=Q.length;C<J;C++)for(let Q=0;Q<6;Q++){var y;H._uploadArrayBufferViewToTexture((null===(y=E)||void 0===y?void 0:y.texture)||k,i,Q,C)}}if(E){const Q=k._irradianceTexture;k._irradianceTexture=null,H._releaseTexture(k),E._swapAndDie(k),k._irradianceTexture=Q}z&&z.dispose(),F&&(k._lodTextureHigh&&k._lodTextureHigh._texture&&(k._lodTextureHigh._texture.isReady=!0),k._lodTextureMid&&k._lodTextureMid._texture&&(k._lodTextureMid._texture.isReady=!0),k._lodTextureLow&&k._lodTextureLow._texture&&(k._lodTextureLow._texture.isReady=!0))}function L(k,Q){const i=(Q=z(Q)).irradiance;if(!i)return;const Z=new B.h;U.zQ.FromArrayToRef(i.x,0,Z.x),U.zQ.FromArrayToRef(i.y,0,Z.y),U.zQ.FromArrayToRef(i.z,0,Z.z),U.zQ.FromArrayToRef(i.xx,0,Z.xx),U.zQ.FromArrayToRef(i.yy,0,Z.yy),U.zQ.FromArrayToRef(i.zz,0,Z.zz),U.zQ.FromArrayToRef(i.yz,0,Z.yz),U.zQ.FromArrayToRef(i.zx,0,Z.zx),U.zQ.FromArrayToRef(i.xy,0,Z.xy),k._sphericalPolynomial=Z}function s(k,Q,i,Z,U){const C=f(k.getEngine().createRawCubeTexture(null,k.width,k.format,k.type,k.generateMipMaps,k.invertY,k.samplingMode,k._compression),Q).then((()=>k));return k.onRebuildCallback=k=>({proxy:C,isReady:!0,isAsync:!0}),k._source=13,k._bufferViewArrayArray=Q,k._lodGenerationScale=Z,k._lodGenerationOffset=U,k._sphericalPolynomial=i,f(k,Q).then((()=>(k.isReady=!0,k)))}}}]);