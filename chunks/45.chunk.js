"use strict";(self.n52dyox90qa=self.n52dyox90qa||[]).push([[45],{13424:(E,t,z)=>{z.d(t,{c:()=>O,e:()=>mE,f:()=>S,i:()=>l});var A=z(11630),X=z(11812),R=z(11834),u=z(11999),p=z(11751),C=z(11840),Z=(z(12051),z(11929)),H=z(11640);z(12316),z(12036),z(12328);const h="image/png",d=2,y=[134,22,135,150,246,214,150,54];function O(E){const t=new DataView(E.buffer,E.byteOffset,E.byteLength);let z=0;for(let u=0;u<y.length;u++)if(t.getUint8(z++)!==y[u])return H.d.Error("Not a babylon environment map"),null;let A="",X=0;for(;X=t.getUint8(z++);)A+=String.fromCharCode(X);let R=JSON.parse(A);return R=c(R),R.binaryDataPosition=z,R.uH&&(R.uH.lodGenerationScale=R.uH.lodGenerationScale||.8),R}function c(E){if(E.version>d)throw new Error(`Unsupported babylon environment map version "${E.version}". Latest supported version is "${d}".`);return 2===E.version?E:E={...E,version:2,imageType:h}}function a(E,t){const z=(t=c(t)).uH;let A=Math.log2(t.width);if(A=Math.round(A)+1,z.mipmaps.length!==6*A)throw new Error(`Unsupported specular mipmaps number "${z.mipmaps.length}"`);const X=new Array(A);for(let R=0;R<A;R++){X[R]=new Array(6);for(let A=0;A<6;A++){const u=z.mipmaps[6*R+A];X[R][A]=new Uint8Array(E.buffer,E.byteOffset+t.binaryDataPosition+u.position,u.length)}}return X}function L(E,t){var z;t=c(t);const A=new Array(6),X=null===(z=t.irradiance)||void 0===z?void 0:z.irradianceTexture;if(X){if(6!==X.faces.length)throw new Error(`Incorrect irradiance texture faces number "${X.faces.length}"`);for(let z=0;z<6;z++){const R=X.faces[z];A[z]=new Uint8Array(E.buffer,E.byteOffset+t.binaryDataPosition+R.position,R.length)}}return A}function mE(E,t,z){var A;const R=(z=c(z)).uH;if(!R)return Promise.resolve([]);E._lodGenerationScale=R.lodGenerationScale;const u=[],p=a(t,z);u.push(I(E,p,z.imageType));const C=null===(A=z.irradiance)||void 0===A?void 0:A.irradianceTexture;if(C){var Z,H;const A=L(t,z);let R=null;null!==(Z=z.irradiance)&&void 0!==Z&&null!==(H=Z.irradianceTexture)&&void 0!==H&&H.dominantDirection&&(R=X.Lt.St(z.irradiance.irradianceTexture.dominantDirection)),u.push(e(E,A,C.size,z.imageType,R))}return Promise.all(u)}async function W(E,t,z,A,X,R,u,p,C,Z,H){return await new Promise(((h,d)=>{if(z){const z=t.createTexture(null,!0,!0,null,1,null,(E=>{d(E)}),E);null===A||void 0===A||A.onEffectCreatedObservable.addOnce((p=>{p.executeWhenCompiled((()=>{A.externalTextureSamplerBinding=!0,A.onApply=A=>{A._bindTexture("textureSampler",z),A.setFloat2("scale",1,t._features.needsInvertingBitmap&&E instanceof ImageBitmap?-1:1)},t.scenes.length&&(t.scenes[0].postProcessManager.directRender([A],Z,!0,R,u),t.restoreDefaultFramebuffer(),z.dispose(),URL.revokeObjectURL(X),h())}))}))}else{if(t._uploadImageToTexture(H,E,R,u),p){const z=C[u];z&&t._uploadImageToTexture(z._texture,E,R,0)}h()}}))}async function I(E,t){let z=arguments.length>2&&void 0!==arguments[2]?arguments[2]:h;const A=E.getEngine();E.format=5,E.type=0,E.generateMipMaps=!0,E._cachedAnisotropicFilteringLevel=null,A.updateTextureSamplingMode(3,E),await D(E,t,!0,z),E.isReady=!0}async function e(E,t,z){let A=arguments.length>3&&void 0!==arguments[3]?arguments[3]:h,X=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const R=E.getEngine(),u=new p.e(R,5),Z=new C.b(R,u);E._irradianceTexture=Z,Z._dominantDirection=X,u.isCube=!0,u.format=5,u.type=0,u.generateMipMaps=!0,u._cachedAnisotropicFilteringLevel=null,u.generateMipMaps=!0,u.width=z,u.height=z,R.updateTextureSamplingMode(3,u),await D(u,[t],!1,A),R.generateMipMapsForCubemap(u),u.isReady=!0}async function D(E,t,X){let u=arguments.length>3&&void 0!==arguments[3]?arguments[3]:h;if(!A.Tools.IsExponentOfTwo(E.width))throw new Error("Texture size must be a power of two");const H=(0,R.ILog2)(E.width)+1,d=E.getEngine();let y=!1,O=!1,c=null,a=null,L=null;const mE=d.getCaps();mE.textureLOD?d._features.supportRenderAndCopyToLodForFloatTextures?mE.textureHalfFloatRender&&mE.textureHalfFloatLinearFiltering?(y=!0,E.type=2):mE.textureFloatRender&&mE.textureFloatLinearFiltering&&(y=!0,E.type=1):y=!1:(y=!1,O=X);let I=0;if(y)d.isWebGPU?(I=1,await z.e(42).then(z.bind(z,14775))):await z.e(35).then(z.bind(z,14783)),c=new Z.b("rgbdDecode","rgbdDecode",null,null,1,null,3,d,!1,void 0,E.type,void 0,null,!1,void 0,I),E._isRGBD=!1,E.invertY=!1,a=d.createRenderTargetCubeTexture(E.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:E.type,format:5});else if(E._isRGBD=!0,E.invertY=!0,O){const t=3;L={};const z=E._lodGenerationScale,A=E._lodGenerationOffset;for(let X=0;X<t;X++){const R=(H-1)*z+A,u=A+(R-A)*(1-X/(t-1)),Z=Math.round(Math.min(Math.max(u,0),R)),h=new p.e(d,2);h.isCube=!0,h.invertY=!0,h.generateMipMaps=!1,d.updateTextureSamplingMode(2,h);const y=new C.b(null);switch(y._isCube=!0,y._texture=h,L[Z]=y,X){case 0:E._lodTextureLow=y;break;case 1:E._lodTextureMid=y;break;case 2:E._lodTextureHigh=y}}}const e=[];for(let z=0;z<t.length;z++)for(let A=0;A<6;A++){const X=t[z][A],R=new Blob([X],{type:u}),p=URL.createObjectURL(R);let C;if(d._features.forceBitmapOverHTMLImageElement)C=d.createImageBitmap(R,{premultiplyAlpha:"none"}).then((async t=>await W(t,d,y,c,p,A,z,O,L,a,E)));else{const t=new Image;t.src=p,C=new Promise(((X,R)=>{t.onload=()=>{W(t,d,y,c,p,A,z,O,L,a,E).then((()=>X())).catch((E=>{R(E)}))},t.onerror=E=>{R(E)}}))}e.push(C)}if(await Promise.all(e),t.length<H){let z;const A=Math.pow(2,H-1-t.length),X=A*A*4;switch(E.type){case 0:z=new Uint8Array(X);break;case 2:z=new Uint16Array(X);break;case 1:z=new Float32Array(X)}for(let R=t.length;R<H;R++)for(let t=0;t<6;t++){var D;d._uploadArrayBufferViewToTexture((null===(D=a)||void 0===D?void 0:D.texture)||E,z,t,R)}}if(a){const t=E._irradianceTexture;E._irradianceTexture=null,d._releaseTexture(E),a._swapAndDie(E),E._irradianceTexture=t}c&&c.dispose(),O&&(E._lodTextureHigh&&E._lodTextureHigh._texture&&(E._lodTextureHigh._texture.isReady=!0),E._lodTextureMid&&E._lodTextureMid._texture&&(E._lodTextureMid._texture.isReady=!0),E._lodTextureLow&&E._lodTextureLow._texture&&(E._lodTextureLow._texture.isReady=!0))}function S(E,t){const z=(t=c(t)).irradiance;if(!z)return;const A=new u.i;X.Lt.FromArrayToRef(z.x,0,A.x),X.Lt.FromArrayToRef(z.y,0,A.y),X.Lt.FromArrayToRef(z.z,0,A.z),X.Lt.FromArrayToRef(z.xx,0,A.xx),X.Lt.FromArrayToRef(z.yy,0,A.yy),X.Lt.FromArrayToRef(z.zz,0,A.zz),X.Lt.FromArrayToRef(z.yz,0,A.yz),X.Lt.FromArrayToRef(z.zx,0,A.zx),X.Lt.FromArrayToRef(z.xy,0,A.xy),E._sphericalPolynomial=A}function l(E,t,z,A,X){const R=I(E.getEngine().createRawCubeTexture(null,E.width,E.format,E.type,E.generateMipMaps,E.invertY,E.samplingMode,E._compression),t).then((()=>E));return E.onRebuildCallback=E=>({proxy:R,isReady:!0,isAsync:!0}),E._source=13,E._bufferViewArrayArray=t,E._lodGenerationScale=A,E._lodGenerationOffset=X,E._sphericalPolynomial=z,I(E,t).then((()=>(E.isReady=!0,E)))}}}]);