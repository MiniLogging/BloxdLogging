"use strict";(self.fkqm0epoq5=self.fkqm0epoq5||[]).push([[45],{13386:(D,l,G)=>{G.d(l,{c:()=>K,g:()=>h,i:()=>u,j:()=>B});var V=G(11530),N=G(11710),M=G(11728),b=G(11904),X=G(11644),t=G(11732),R=(G(11963),G(11820)),n=G(11546);G(12223),G(11940),G(12236);const g="image/png",j=2,e=[134,22,135,150,246,214,150,54];function K(D){const l=new DataView(D.buffer,D.byteOffset,D.byteLength);let G=0;for(let b=0;b<e.length;b++)if(l.getUint8(G++)!==e[b])return n.d.Error("Not a babylon environment map"),null;let V="",N=0;for(;N=l.getUint8(G++);)V+=String.fromCharCode(N);let M=JSON.parse(V);return M=F(M),M.binaryDataPosition=G,M.Ln&&(M.Ln.lodGenerationScale=M.Ln.lodGenerationScale||.8),M}function F(D){if(D.version>j)throw new Error(`Unsupported babylon environment map version "${D.version}". Latest supported version is "${j}".`);return 2===D.version?D:D={...D,version:2,imageType:g}}function d(D,l){const G=(l=F(l)).Ln;let V=Math.log2(l.width);if(V=Math.round(V)+1,G.mipmaps.length!==6*V)throw new Error(`Unsupported specular mipmaps number "${G.mipmaps.length}"`);const N=new Array(V);for(let M=0;M<V;M++){N[M]=new Array(6);for(let V=0;V<6;V++){const b=G.mipmaps[6*M+V];N[M][V]=new Uint8Array(D.buffer,D.byteOffset+l.binaryDataPosition+b.position,b.length)}}return N}function H(D,l){var G;l=F(l);const V=new Array(6),N=null===(G=l.irradiance)||void 0===G?void 0:G.irradianceTexture;if(N){if(6!==N.faces.length)throw new Error(`Incorrect irradiance texture faces number "${N.faces.length}"`);for(let G=0;G<6;G++){const M=N.faces[G];V[G]=new Uint8Array(D.buffer,D.byteOffset+l.binaryDataPosition+M.position,M.length)}}return V}function h(D,l,G){var V;const M=(G=F(G)).Ln;if(!M)return Promise.resolve([]);D._lodGenerationScale=M.lodGenerationScale;const b=[],X=d(l,G);b.push(r(D,X,G.imageType));const t=null===(V=G.irradiance)||void 0===V?void 0:V.irradianceTexture;if(t){var R,n;const V=H(l,G);let M=null;null!==(R=G.irradiance)&&void 0!==R&&null!==(n=R.irradianceTexture)&&void 0!==n&&n.dominantDirection&&(M=N.Kl.xl(G.irradiance.irradianceTexture.dominantDirection)),b.push(o(D,V,t.size,G.imageType,M))}return Promise.all(b)}async function x(D,l,G,V,N,M,b,X,t,R,n){return await new Promise(((g,j)=>{if(G){const G=l.createTexture(null,!0,!0,null,1,null,(D=>{j(D)}),D);null===V||void 0===V||V.onEffectCreatedObservable.addOnce((X=>{X.executeWhenCompiled((()=>{V.externalTextureSamplerBinding=!0,V.onApply=V=>{V._bindTexture("textureSampler",G),V.setFloat2("scale",1,l._features.needsInvertingBitmap&&D instanceof ImageBitmap?-1:1)},l.scenes.length&&(l.scenes[0].postProcessManager.directRender([V],R,!0,M,b),l.restoreDefaultFramebuffer(),G.dispose(),URL.revokeObjectURL(N),g())}))}))}else{if(l._uploadImageToTexture(n,D,M,b),X){const G=t[b];G&&l._uploadImageToTexture(G._texture,D,M,0)}g()}}))}async function r(D,l){let G=arguments.length>2&&void 0!==arguments[2]?arguments[2]:g;const V=D.getEngine();D.format=5,D.type=0,D.generateMipMaps=!0,D._cachedAnisotropicFilteringLevel=null,V.updateTextureSamplingMode(3,D),await L(D,l,!0,G),D.isReady=!0}async function o(D,l,G){let V=arguments.length>3&&void 0!==arguments[3]?arguments[3]:g,N=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const M=D.getEngine(),b=new X.b(M,5),R=new t.c(M,b);D._irradianceTexture=R,R._dominantDirection=N,b.isCube=!0,b.format=5,b.type=0,b.generateMipMaps=!0,b._cachedAnisotropicFilteringLevel=null,b.generateMipMaps=!0,b.width=G,b.height=G,M.updateTextureSamplingMode(3,b),await L(b,[l],!1,V),M.generateMipMapsForCubemap(b),b.isReady=!0}async function L(D,l,N){let b=arguments.length>3&&void 0!==arguments[3]?arguments[3]:g;if(!V.Tools.IsExponentOfTwo(D.width))throw new Error("Texture size must be a power of two");const n=(0,M.ILog2)(D.width)+1,j=D.getEngine();let e=!1,K=!1,F=null,d=null,H=null;const h=j.getCaps();h.textureLOD?j._features.supportRenderAndCopyToLodForFloatTextures?h.textureHalfFloatRender&&h.textureHalfFloatLinearFiltering?(e=!0,D.type=2):h.textureFloatRender&&h.textureFloatLinearFiltering&&(e=!0,D.type=1):e=!1:(e=!1,K=N);let r=0;if(e)j.isWebGPU?(r=1,await G.e(42).then(G.bind(G,14680))):await G.e(35).then(G.bind(G,14687)),F=new R.c("rgbdDecode","rgbdDecode",null,null,1,null,3,j,!1,void 0,D.type,void 0,null,!1,void 0,r),D._isRGBD=!1,D.invertY=!1,d=j.createRenderTargetCubeTexture(D.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:D.type,format:5});else if(D._isRGBD=!0,D.invertY=!0,K){const l=3;H={};const G=D._lodGenerationScale,V=D._lodGenerationOffset;for(let N=0;N<l;N++){const M=(n-1)*G+V,b=V+(M-V)*(1-N/(l-1)),R=Math.round(Math.min(Math.max(b,0),M)),g=new X.b(j,2);g.isCube=!0,g.invertY=!0,g.generateMipMaps=!1,j.updateTextureSamplingMode(2,g);const e=new t.c(null);switch(e._isCube=!0,e._texture=g,H[R]=e,N){case 0:D._lodTextureLow=e;break;case 1:D._lodTextureMid=e;break;case 2:D._lodTextureHigh=e}}}const o=[];for(let G=0;G<l.length;G++)for(let V=0;V<6;V++){const N=l[G][V],M=new Blob([N],{type:b}),X=URL.createObjectURL(M);let t;if(j._features.forceBitmapOverHTMLImageElement)t=j.createImageBitmap(M,{premultiplyAlpha:"none"}).then((async l=>await x(l,j,e,F,X,V,G,K,H,d,D)));else{const l=new Image;l.src=X,t=new Promise(((N,M)=>{l.onload=()=>{x(l,j,e,F,X,V,G,K,H,d,D).then((()=>N())).catch((D=>{M(D)}))},l.onerror=D=>{M(D)}}))}o.push(t)}if(await Promise.all(o),l.length<n){let G;const V=Math.pow(2,n-1-l.length),N=V*V*4;switch(D.type){case 0:G=new Uint8Array(N);break;case 2:G=new Uint16Array(N);break;case 1:G=new Float32Array(N)}for(let M=l.length;M<n;M++)for(let l=0;l<6;l++){var L;j._uploadArrayBufferViewToTexture((null===(L=d)||void 0===L?void 0:L.texture)||D,G,l,M)}}if(d){const l=D._irradianceTexture;D._irradianceTexture=null,j._releaseTexture(D),d._swapAndDie(D),D._irradianceTexture=l}F&&F.dispose(),K&&(D._lodTextureHigh&&D._lodTextureHigh._texture&&(D._lodTextureHigh._texture.isReady=!0),D._lodTextureMid&&D._lodTextureMid._texture&&(D._lodTextureMid._texture.isReady=!0),D._lodTextureLow&&D._lodTextureLow._texture&&(D._lodTextureLow._texture.isReady=!0))}function u(D,l){const G=(l=F(l)).irradiance;if(!G)return;const V=new b.h;N.Kl.FromArrayToRef(G.x,0,V.x),N.Kl.FromArrayToRef(G.y,0,V.y),N.Kl.FromArrayToRef(G.z,0,V.z),N.Kl.FromArrayToRef(G.xx,0,V.xx),N.Kl.FromArrayToRef(G.yy,0,V.yy),N.Kl.FromArrayToRef(G.zz,0,V.zz),N.Kl.FromArrayToRef(G.yz,0,V.yz),N.Kl.FromArrayToRef(G.zx,0,V.zx),N.Kl.FromArrayToRef(G.xy,0,V.xy),D._sphericalPolynomial=V}function B(D,l,G,V,N){const M=r(D.getEngine().createRawCubeTexture(null,D.width,D.format,D.type,D.generateMipMaps,D.invertY,D.samplingMode,D._compression),l).then((()=>D));return D.onRebuildCallback=D=>({proxy:M,isReady:!0,isAsync:!0}),D._source=13,D._bufferViewArrayArray=l,D._lodGenerationScale=V,D._lodGenerationOffset=N,D._sphericalPolynomial=G,r(D,l).then((()=>(D.isReady=!0,D)))}}}]);