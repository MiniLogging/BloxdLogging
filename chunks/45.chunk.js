"use strict";(self.r00gjvkwa6=self.r00gjvkwa6||[]).push([[45],{12996:(H,O,S)=>{S.d(O,{e:()=>e,f:()=>T,i:()=>Y,m:()=>l});var t=S(11131),q=S(11301),p=S(11317),G=S(11509),U=S(11239),V=S(11322),w=(S(11541),S(11407)),o=S(11151);S(11809),S(11532),S(11820);const h="image/png",a=2,j=[134,22,135,150,246,214,150,54];function e(H){const O=new DataView(H.buffer,H.byteOffset,H.byteLength);let S=0;for(let G=0;G<j.length;G++)if(O.getUint8(S++)!==j[G])return o.b.Error("Not a babylon environment map"),null;let t="",q=0;for(;q=O.getUint8(S++);)t+=String.fromCharCode(q);let p=JSON.parse(t);return p=X(p),p.binaryDataPosition=S,p.po&&(p.po.lodGenerationScale=p.po.lodGenerationScale||.8),p}function X(H){if(H.version>a)throw new Error(`Unsupported babylon environment map version "${H.version}". Latest supported version is "${a}".`);return 2===H.version?H:H={...H,version:2,imageType:h}}function E(H,O){const S=(O=X(O)).po;let t=Math.log2(O.width);if(t=Math.round(t)+1,S.mipmaps.length!==6*t)throw new Error(`Unsupported specular mipmaps number "${S.mipmaps.length}"`);const q=new Array(t);for(let p=0;p<t;p++){q[p]=new Array(6);for(let t=0;t<6;t++){const G=S.mipmaps[6*p+t];q[p][t]=new Uint8Array(H.buffer,H.byteOffset+O.binaryDataPosition+G.position,G.length)}}return q}function y(H,O){var S;O=X(O);const t=new Array(6),q=null===(S=O.irradiance)||void 0===S?void 0:S.irradianceTexture;if(q){if(6!==q.faces.length)throw new Error(`Incorrect irradiance texture faces number "${q.faces.length}"`);for(let S=0;S<6;S++){const p=q.faces[S];t[S]=new Uint8Array(H.buffer,H.byteOffset+O.binaryDataPosition+p.position,p.length)}}return t}function T(H,O,S){var t;const p=(S=X(S)).po;if(!p)return Promise.resolve([]);H._lodGenerationScale=p.lodGenerationScale;const G=[],U=E(O,S);G.push(b(H,U,S.imageType));const V=null===(t=S.irradiance)||void 0===t?void 0:t.irradianceTexture;if(V){var w,o;const t=y(O,S);let p=null;null!==(w=S.irradiance)&&void 0!==w&&null!==(o=w.irradianceTexture)&&void 0!==o&&o.dominantDirection&&(p=q.eO.KO(S.irradiance.irradianceTexture.dominantDirection)),G.push(D(H,t,V.size,S.imageType,p))}return Promise.all(G)}async function K(H,O,S,t,q,p,G,U,V,w,o){return await new Promise(((h,a)=>{if(S){const S=O.createTexture(null,!0,!0,null,1,null,(H=>{a(H)}),H);null===t||void 0===t||t.onEffectCreatedObservable.addOnce((U=>{U.executeWhenCompiled((()=>{t.externalTextureSamplerBinding=!0,t.onApply=t=>{t._bindTexture("textureSampler",S),t.setFloat2("scale",1,O._features.needsInvertingBitmap&&H instanceof ImageBitmap?-1:1)},O.scenes.length&&(O.scenes[0].postProcessManager.directRender([t],w,!0,p,G),O.restoreDefaultFramebuffer(),S.dispose(),URL.revokeObjectURL(q),h())}))}))}else{if(O._uploadImageToTexture(o,H,p,G),U){const S=V[G];S&&O._uploadImageToTexture(S._texture,H,p,0)}h()}}))}async function b(H,O){let S=arguments.length>2&&void 0!==arguments[2]?arguments[2]:h;const t=H.getEngine();H.format=5,H.type=0,H.generateMipMaps=!0,H._cachedAnisotropicFilteringLevel=null,t.updateTextureSamplingMode(3,H),await F(H,O,!0,S),H.isReady=!0}async function D(H,O,S){let t=arguments.length>3&&void 0!==arguments[3]?arguments[3]:h,q=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const p=H.getEngine(),G=new U.d(p,5),w=new V.e(p,G);H._irradianceTexture=w,w._dominantDirection=q,G.isCube=!0,G.format=5,G.type=0,G.generateMipMaps=!0,G._cachedAnisotropicFilteringLevel=null,G.generateMipMaps=!0,G.width=S,G.height=S,p.updateTextureSamplingMode(3,G),await F(G,[O],!1,t),p.generateMipMapsForCubemap(G),G.isReady=!0}async function F(H,O,q){let G=arguments.length>3&&void 0!==arguments[3]?arguments[3]:h;if(!t.Tools.IsExponentOfTwo(H.width))throw new Error("Texture size must be a power of two");const o=(0,p.ILog2)(H.width)+1,a=H.getEngine();let j=!1,e=!1,X=null,E=null,y=null;const T=a.getCaps();T.textureLOD?a._features.supportRenderAndCopyToLodForFloatTextures?T.textureHalfFloatRender&&T.textureHalfFloatLinearFiltering?(j=!0,H.type=2):T.textureFloatRender&&T.textureFloatLinearFiltering&&(j=!0,H.type=1):j=!1:(j=!1,e=q);let b=0;if(j)a.isWebGPU?(b=1,await S.e(42).then(S.bind(S,14333))):await S.e(35).then(S.bind(S,14335)),X=new w.e("rgbdDecode","rgbdDecode",null,null,1,null,3,a,!1,void 0,H.type,void 0,null,!1,void 0,b),H._isRGBD=!1,H.invertY=!1,E=a.createRenderTargetCubeTexture(H.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:H.type,format:5});else if(H._isRGBD=!0,H.invertY=!0,e){const O=3;y={};const S=H._lodGenerationScale,t=H._lodGenerationOffset;for(let q=0;q<O;q++){const p=(o-1)*S+t,G=t+(p-t)*(1-q/(O-1)),w=Math.round(Math.min(Math.max(G,0),p)),h=new U.d(a,2);h.isCube=!0,h.invertY=!0,h.generateMipMaps=!1,a.updateTextureSamplingMode(2,h);const j=new V.e(null);switch(j._isCube=!0,j._texture=h,y[w]=j,q){case 0:H._lodTextureLow=j;break;case 1:H._lodTextureMid=j;break;case 2:H._lodTextureHigh=j}}}const D=[];for(let S=0;S<O.length;S++)for(let t=0;t<6;t++){const q=O[S][t],p=new Blob([q],{type:G}),U=URL.createObjectURL(p);let V;if(a._features.forceBitmapOverHTMLImageElement)V=a.createImageBitmap(p,{premultiplyAlpha:"none"}).then((async O=>await K(O,a,j,X,U,t,S,e,y,E,H)));else{const O=new Image;O.src=U,V=new Promise(((q,p)=>{O.onload=()=>{K(O,a,j,X,U,t,S,e,y,E,H).then((()=>q())).catch((H=>{p(H)}))},O.onerror=H=>{p(H)}}))}D.push(V)}if(await Promise.all(D),O.length<o){let S;const t=Math.pow(2,o-1-O.length),q=t*t*4;switch(H.type){case 0:S=new Uint8Array(q);break;case 2:S=new Uint16Array(q);break;case 1:S=new Float32Array(q)}for(let p=O.length;p<o;p++)for(let O=0;O<6;O++){var F;a._uploadArrayBufferViewToTexture((null===(F=E)||void 0===F?void 0:F.texture)||H,S,O,p)}}if(E){const O=H._irradianceTexture;H._irradianceTexture=null,a._releaseTexture(H),E._swapAndDie(H),H._irradianceTexture=O}X&&X.dispose(),e&&(H._lodTextureHigh&&H._lodTextureHigh._texture&&(H._lodTextureHigh._texture.isReady=!0),H._lodTextureMid&&H._lodTextureMid._texture&&(H._lodTextureMid._texture.isReady=!0),H._lodTextureLow&&H._lodTextureLow._texture&&(H._lodTextureLow._texture.isReady=!0))}function Y(H,O){const S=(O=X(O)).irradiance;if(!S)return;const t=new G.h;q.eO.FromArrayToRef(S.x,0,t.x),q.eO.FromArrayToRef(S.y,0,t.y),q.eO.FromArrayToRef(S.z,0,t.z),q.eO.FromArrayToRef(S.xx,0,t.xx),q.eO.FromArrayToRef(S.yy,0,t.yy),q.eO.FromArrayToRef(S.zz,0,t.zz),q.eO.FromArrayToRef(S.yz,0,t.yz),q.eO.FromArrayToRef(S.zx,0,t.zx),q.eO.FromArrayToRef(S.xy,0,t.xy),H._sphericalPolynomial=t}function l(H,O,S,t,q){const p=b(H.getEngine().createRawCubeTexture(null,H.width,H.format,H.type,H.generateMipMaps,H.invertY,H.samplingMode,H._compression),O).then((()=>H));return H.onRebuildCallback=H=>({proxy:p,isReady:!0,isAsync:!0}),H._source=13,H._bufferViewArrayArray=O,H._lodGenerationScale=t,H._lodGenerationOffset=q,H._sphericalPolynomial=S,b(H,O).then((()=>(H.isReady=!0,H)))}}}]);