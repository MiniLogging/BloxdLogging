"use strict";(self.hwpa2z1pqte=self.hwpa2z1pqte||[]).push([[45],{14561:(h,R,l)=>{l.d(R,{e:()=>Q,f:()=>f,i:()=>p,k:()=>O});var j=l(12689),a=l(12900),D=l(12917),U=l(13075),F=l(12835),w=l(12925),mh=(l(13126),l(13002)),u=l(12711);l(13376),l(13110),l(13389);const c="image/png",J=2,q=[134,22,135,150,246,214,150,54];function Q(h){const R=new DataView(h.buffer,h.byteOffset,h.byteLength);let l=0;for(let U=0;U<q.length;U++)if(R.getUint8(l++)!==q[U])return u.c.Error("Not a babylon environment map"),null;let j="",a=0;for(;a=R.getUint8(l++);)j+=String.fromCharCode(a);let D=JSON.parse(j);return D=Y(D),D.binaryDataPosition=l,D.Tu&&(D.Tu.lodGenerationScale=D.Tu.lodGenerationScale||.8),D}function Y(h){if(h.version>J)throw new Error(`Unsupported babylon environment map version "${h.version}". Latest supported version is "${J}".`);return 2===h.version?h:h={...h,version:2,imageType:c}}function s(h,R){const l=(R=Y(R)).Tu;let j=Math.log2(R.width);if(j=Math.round(j)+1,l.mipmaps.length!==6*j)throw new Error(`Unsupported specular mipmaps number "${l.mipmaps.length}"`);const a=new Array(j);for(let D=0;D<j;D++){a[D]=new Array(6);for(let j=0;j<6;j++){const U=l.mipmaps[6*D+j];a[D][j]=new Uint8Array(h.buffer,h.byteOffset+R.binaryDataPosition+U.position,U.length)}}return a}function t(h,R){var l;R=Y(R);const j=new Array(6),a=null===(l=R.irradiance)||void 0===l?void 0:l.irradianceTexture;if(a){if(6!==a.faces.length)throw new Error(`Incorrect irradiance texture faces number "${a.faces.length}"`);for(let l=0;l<6;l++){const D=a.faces[l];j[l]=new Uint8Array(h.buffer,h.byteOffset+R.binaryDataPosition+D.position,D.length)}}return j}function f(h,R,l){var j;const D=(l=Y(l)).Tu;if(!D)return Promise.resolve([]);h._lodGenerationScale=D.lodGenerationScale;const U=[],F=s(R,l);U.push(E(h,F,l.imageType));const w=null===(j=l.irradiance)||void 0===j?void 0:j.irradianceTexture;if(w){var mh,u;const j=t(R,l);let D=null;null!==(mh=l.irradiance)&&void 0!==mh&&null!==(u=mh.irradianceTexture)&&void 0!==u&&u.dominantDirection&&(D=a.tR.GR(l.irradiance.irradianceTexture.dominantDirection)),U.push(x(h,j,w.size,l.imageType,D))}return Promise.all(U)}async function T(h,R,l,j,a,D,U,F,w,mh,u){return await new Promise(((c,J)=>{if(l){const l=R.createTexture(null,!0,!0,null,1,null,(h=>{J(h)}),h);null===j||void 0===j||j.onEffectCreatedObservable.addOnce((F=>{F.executeWhenCompiled((()=>{j.externalTextureSamplerBinding=!0,j.onApply=j=>{j._bindTexture("textureSampler",l),j.setFloat2("scale",1,R._features.needsInvertingBitmap&&h instanceof ImageBitmap?-1:1)},R.scenes.length&&(R.scenes[0].postProcessManager.directRender([j],mh,!0,D,U),R.restoreDefaultFramebuffer(),l.dispose(),URL.revokeObjectURL(a),c())}))}))}else{if(R._uploadImageToTexture(u,h,D,U),F){const l=w[U];l&&R._uploadImageToTexture(l._texture,h,D,0)}c()}}))}async function E(h,R){let l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:c;const j=h.getEngine();h.format=5,h.type=0,h.generateMipMaps=!0,h._cachedAnisotropicFilteringLevel=null,j.updateTextureSamplingMode(3,h),await G(h,R,!0,l),h.isReady=!0}async function x(h,R,l){let j=arguments.length>3&&void 0!==arguments[3]?arguments[3]:c,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const D=h.getEngine(),U=new F.e(D,5),mh=new w.e(D,U);h._irradianceTexture=mh,mh._dominantDirection=a,U.isCube=!0,U.format=5,U.type=0,U.generateMipMaps=!0,U._cachedAnisotropicFilteringLevel=null,U.generateMipMaps=!0,U.width=l,U.height=l,D.updateTextureSamplingMode(3,U),await G(U,[R],!1,j),D.generateMipMapsForCubemap(U),U.isReady=!0}async function G(h,R,a){let U=arguments.length>3&&void 0!==arguments[3]?arguments[3]:c;if(!j.Tools.IsExponentOfTwo(h.width))throw new Error("Texture size must be a power of two");const u=(0,D.ILog2)(h.width)+1,J=h.getEngine();let q=!1,Q=!1,Y=null,s=null,t=null;const f=J.getCaps();f.textureLOD?J._features.supportRenderAndCopyToLodForFloatTextures?f.textureHalfFloatRender&&f.textureHalfFloatLinearFiltering?(q=!0,h.type=2):f.textureFloatRender&&f.textureFloatLinearFiltering&&(q=!0,h.type=1):q=!1:(q=!1,Q=a);let E=0;if(q)J.isWebGPU?(E=1,await l.e(42).then(l.bind(l,15964))):await l.e(35).then(l.bind(l,15971)),Y=new mh.e("rgbdDecode","rgbdDecode",null,null,1,null,3,J,!1,void 0,h.type,void 0,null,!1,void 0,E),h._isRGBD=!1,h.invertY=!1,s=J.createRenderTargetCubeTexture(h.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:h.type,format:5});else if(h._isRGBD=!0,h.invertY=!0,Q){const R=3;t={};const l=h._lodGenerationScale,j=h._lodGenerationOffset;for(let a=0;a<R;a++){const D=(u-1)*l+j,U=j+(D-j)*(1-a/(R-1)),mh=Math.round(Math.min(Math.max(U,0),D)),c=new F.e(J,2);c.isCube=!0,c.invertY=!0,c.generateMipMaps=!1,J.updateTextureSamplingMode(2,c);const q=new w.e(null);switch(q._isCube=!0,q._texture=c,t[mh]=q,a){case 0:h._lodTextureLow=q;break;case 1:h._lodTextureMid=q;break;case 2:h._lodTextureHigh=q}}}const x=[];for(let l=0;l<R.length;l++)for(let j=0;j<6;j++){const a=R[l][j],D=new Blob([a],{type:U}),F=URL.createObjectURL(D);let w;if(J._features.forceBitmapOverHTMLImageElement)w=J.createImageBitmap(D,{premultiplyAlpha:"none"}).then((async R=>await T(R,J,q,Y,F,j,l,Q,t,s,h)));else{const R=new Image;R.src=F,w=new Promise(((a,D)=>{R.onload=()=>{T(R,J,q,Y,F,j,l,Q,t,s,h).then((()=>a())).catch((h=>{D(h)}))},R.onerror=h=>{D(h)}}))}x.push(w)}if(await Promise.all(x),R.length<u){let l;const j=Math.pow(2,u-1-R.length),a=j*j*4;switch(h.type){case 0:l=new Uint8Array(a);break;case 2:l=new Uint16Array(a);break;case 1:l=new Float32Array(a)}for(let D=R.length;D<u;D++)for(let R=0;R<6;R++){var G;J._uploadArrayBufferViewToTexture((null===(G=s)||void 0===G?void 0:G.texture)||h,l,R,D)}}if(s){const R=h._irradianceTexture;h._irradianceTexture=null,J._releaseTexture(h),s._swapAndDie(h),h._irradianceTexture=R}Y&&Y.dispose(),Q&&(h._lodTextureHigh&&h._lodTextureHigh._texture&&(h._lodTextureHigh._texture.isReady=!0),h._lodTextureMid&&h._lodTextureMid._texture&&(h._lodTextureMid._texture.isReady=!0),h._lodTextureLow&&h._lodTextureLow._texture&&(h._lodTextureLow._texture.isReady=!0))}function p(h,R){const l=(R=Y(R)).irradiance;if(!l)return;const j=new U.f;a.tR.FromArrayToRef(l.x,0,j.x),a.tR.FromArrayToRef(l.y,0,j.y),a.tR.FromArrayToRef(l.z,0,j.z),a.tR.FromArrayToRef(l.xx,0,j.xx),a.tR.FromArrayToRef(l.yy,0,j.yy),a.tR.FromArrayToRef(l.zz,0,j.zz),a.tR.FromArrayToRef(l.yz,0,j.yz),a.tR.FromArrayToRef(l.zx,0,j.zx),a.tR.FromArrayToRef(l.xy,0,j.xy),h._sphericalPolynomial=j}function O(h,R,l,j,a){const D=E(h.getEngine().createRawCubeTexture(null,h.width,h.format,h.type,h.generateMipMaps,h.invertY,h.samplingMode,h._compression),R).then((()=>h));return h.onRebuildCallback=h=>({proxy:D,isReady:!0,isAsync:!0}),h._source=13,h._bufferViewArrayArray=R,h._lodGenerationScale=j,h._lodGenerationOffset=a,h._sphericalPolynomial=l,E(h,R).then((()=>(h.isReady=!0,h)))}}}]);