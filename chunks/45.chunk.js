"use strict";(self.dwifukwnts=self.dwifukwnts||[]).push([[45],{13235:(U,X,b)=>{b.d(X,{d:()=>J,g:()=>O,h:()=>f,i:()=>j});var F=b(11385),E=b(11593),w=b(11608),Q=b(11774),z=b(11528),q=b(11612),p=(b(11833),b(11688)),S=b(11408);b(12128),b(11815),b(12138);const R="image/png",n=2,a=[134,22,135,150,246,214,150,54];function J(U){const X=new DataView(U.buffer,U.byteOffset,U.byteLength);let b=0;for(let Q=0;Q<a.length;Q++)if(X.getUint8(b++)!==a[Q])return S.e.Error("Not a babylon environment map"),null;let F="",E=0;for(;E=X.getUint8(b++);)F+=String.fromCharCode(E);let w=JSON.parse(F);return w=m(w),w.binaryDataPosition=b,w.iS&&(w.iS.lodGenerationScale=w.iS.lodGenerationScale||.8),w}function m(U){if(U.version>n)throw new Error(`Unsupported babylon environment map version "${U.version}". Latest supported version is "${n}".`);return 2===U.version?U:U={...U,version:2,imageType:R}}function x(U,X){const b=(X=m(X)).iS;let F=Math.log2(X.width);if(F=Math.round(F)+1,b.mipmaps.length!==6*F)throw new Error(`Unsupported specular mipmaps number "${b.mipmaps.length}"`);const E=new Array(F);for(let w=0;w<F;w++){E[w]=new Array(6);for(let F=0;F<6;F++){const Q=b.mipmaps[6*w+F];E[w][F]=new Uint8Array(U.buffer,U.byteOffset+X.binaryDataPosition+Q.position,Q.length)}}return E}function I(U,X){var b;X=m(X);const F=new Array(6),E=null===(b=X.irradiance)||void 0===b?void 0:b.irradianceTexture;if(E){if(6!==E.faces.length)throw new Error(`Incorrect irradiance texture faces number "${E.faces.length}"`);for(let b=0;b<6;b++){const w=E.faces[b];F[b]=new Uint8Array(U.buffer,U.byteOffset+X.binaryDataPosition+w.position,w.length)}}return F}function O(U,X,b){var F;const w=(b=m(b)).iS;if(!w)return Promise.resolve([]);U._lodGenerationScale=w.lodGenerationScale;const Q=[],z=x(X,b);Q.push(u(U,z,b.imageType));const q=null===(F=b.irradiance)||void 0===F?void 0:F.irradianceTexture;if(q){var p,S;const F=I(X,b);let w=null;null!==(p=b.irradiance)&&void 0!==p&&null!==(S=p.irradianceTexture)&&void 0!==S&&S.dominantDirection&&(w=E.JX.uX(b.irradiance.irradianceTexture.dominantDirection)),Q.push(i(U,F,q.size,b.imageType,w))}return Promise.all(Q)}async function N(U,X,b,F,E,w,Q,z,q,p,S){return await new Promise(((R,n)=>{if(b){const b=X.createTexture(null,!0,!0,null,1,null,(U=>{n(U)}),U);null===F||void 0===F||F.onEffectCreatedObservable.addOnce((z=>{z.executeWhenCompiled((()=>{F.externalTextureSamplerBinding=!0,F.onApply=F=>{F._bindTexture("textureSampler",b),F.setFloat2("scale",1,X._features.needsInvertingBitmap&&U instanceof ImageBitmap?-1:1)},X.scenes.length&&(X.scenes[0].postProcessManager.directRender([F],p,!0,w,Q),X.restoreDefaultFramebuffer(),b.dispose(),URL.revokeObjectURL(E),R())}))}))}else{if(X._uploadImageToTexture(S,U,w,Q),z){const b=q[Q];b&&X._uploadImageToTexture(b._texture,U,w,0)}R()}}))}async function u(U,X){let b=arguments.length>2&&void 0!==arguments[2]?arguments[2]:R;const F=U.getEngine();U.format=5,U.type=0,U.generateMipMaps=!0,U._cachedAnisotropicFilteringLevel=null,F.updateTextureSamplingMode(3,U),await P(U,X,!0,b),U.isReady=!0}async function i(U,X,b){let F=arguments.length>3&&void 0!==arguments[3]?arguments[3]:R,E=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const w=U.getEngine(),Q=new z.e(w,5),p=new q.b(w,Q);U._irradianceTexture=p,p._dominantDirection=E,Q.isCube=!0,Q.format=5,Q.type=0,Q.generateMipMaps=!0,Q._cachedAnisotropicFilteringLevel=null,Q.generateMipMaps=!0,Q.width=b,Q.height=b,w.updateTextureSamplingMode(3,Q),await P(Q,[X],!1,F),w.generateMipMapsForCubemap(Q),Q.isReady=!0}async function P(U,X,E){let Q=arguments.length>3&&void 0!==arguments[3]?arguments[3]:R;if(!F.Tools.IsExponentOfTwo(U.width))throw new Error("Texture size must be a power of two");const S=(0,w.ILog2)(U.width)+1,n=U.getEngine();let a=!1,J=!1,m=null,x=null,I=null;const O=n.getCaps();O.textureLOD?n._features.supportRenderAndCopyToLodForFloatTextures?O.textureHalfFloatRender&&O.textureHalfFloatLinearFiltering?(a=!0,U.type=2):O.textureFloatRender&&O.textureFloatLinearFiltering&&(a=!0,U.type=1):a=!1:(a=!1,J=E);let u=0;if(a)n.isWebGPU?(u=1,await b.e(42).then(b.bind(b,14658))):await b.e(35).then(b.bind(b,14660)),m=new p.b("rgbdDecode","rgbdDecode",null,null,1,null,3,n,!1,void 0,U.type,void 0,null,!1,void 0,u),U._isRGBD=!1,U.invertY=!1,x=n.createRenderTargetCubeTexture(U.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:U.type,format:5});else if(U._isRGBD=!0,U.invertY=!0,J){const X=3;I={};const b=U._lodGenerationScale,F=U._lodGenerationOffset;for(let E=0;E<X;E++){const w=(S-1)*b+F,Q=F+(w-F)*(1-E/(X-1)),p=Math.round(Math.min(Math.max(Q,0),w)),R=new z.e(n,2);R.isCube=!0,R.invertY=!0,R.generateMipMaps=!1,n.updateTextureSamplingMode(2,R);const a=new q.b(null);switch(a._isCube=!0,a._texture=R,I[p]=a,E){case 0:U._lodTextureLow=a;break;case 1:U._lodTextureMid=a;break;case 2:U._lodTextureHigh=a}}}const i=[];for(let b=0;b<X.length;b++)for(let F=0;F<6;F++){const E=X[b][F],w=new Blob([E],{type:Q}),z=URL.createObjectURL(w);let q;if(n._features.forceBitmapOverHTMLImageElement)q=n.createImageBitmap(w,{premultiplyAlpha:"none"}).then((async X=>await N(X,n,a,m,z,F,b,J,I,x,U)));else{const X=new Image;X.src=z,q=new Promise(((E,w)=>{X.onload=()=>{N(X,n,a,m,z,F,b,J,I,x,U).then((()=>E())).catch((U=>{w(U)}))},X.onerror=U=>{w(U)}}))}i.push(q)}if(await Promise.all(i),X.length<S){let b;const F=Math.pow(2,S-1-X.length),E=F*F*4;switch(U.type){case 0:b=new Uint8Array(E);break;case 2:b=new Uint16Array(E);break;case 1:b=new Float32Array(E)}for(let w=X.length;w<S;w++)for(let X=0;X<6;X++){var P;n._uploadArrayBufferViewToTexture((null===(P=x)||void 0===P?void 0:P.texture)||U,b,X,w)}}if(x){const X=U._irradianceTexture;U._irradianceTexture=null,n._releaseTexture(U),x._swapAndDie(U),U._irradianceTexture=X}m&&m.dispose(),J&&(U._lodTextureHigh&&U._lodTextureHigh._texture&&(U._lodTextureHigh._texture.isReady=!0),U._lodTextureMid&&U._lodTextureMid._texture&&(U._lodTextureMid._texture.isReady=!0),U._lodTextureLow&&U._lodTextureLow._texture&&(U._lodTextureLow._texture.isReady=!0))}function f(U,X){const b=(X=m(X)).irradiance;if(!b)return;const F=new Q.f;E.JX.FromArrayToRef(b.x,0,F.x),E.JX.FromArrayToRef(b.y,0,F.y),E.JX.FromArrayToRef(b.z,0,F.z),E.JX.FromArrayToRef(b.xx,0,F.xx),E.JX.FromArrayToRef(b.yy,0,F.yy),E.JX.FromArrayToRef(b.zz,0,F.zz),E.JX.FromArrayToRef(b.yz,0,F.yz),E.JX.FromArrayToRef(b.zx,0,F.zx),E.JX.FromArrayToRef(b.xy,0,F.xy),U._sphericalPolynomial=F}function j(U,X,b,F,E){const w=u(U.getEngine().createRawCubeTexture(null,U.width,U.format,U.type,U.generateMipMaps,U.invertY,U.samplingMode,U._compression),X).then((()=>U));return U.onRebuildCallback=U=>({proxy:w,isReady:!0,isAsync:!0}),U._source=13,U._bufferViewArrayArray=X,U._lodGenerationScale=F,U._lodGenerationOffset=E,U._sphericalPolynomial=b,u(U,X).then((()=>(U.isReady=!0,U)))}}}]);