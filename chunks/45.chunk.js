"use strict";(self["9x1utqq1axc"]=self["9x1utqq1axc"]||[]).push([[45],{13947:(y,c,A)=>{A.d(c,{b:()=>i,c:()=>t,f:()=>K,i:()=>my});var l=A(12144),w=A(12325),N=A(12340),p=A(12511),W=A(12255),h=A(12348),I=(A(12553),A(12427)),q=A(12161);A(12820),A(12545),A(12830);const o="image/png",O=2,L=[134,22,135,150,246,214,150,54];function i(y){const c=new DataView(y.buffer,y.byteOffset,y.byteLength);let A=0;for(let p=0;p<L.length;p++)if(c.getUint8(A++)!==L[p])return q.c.Error("Not a babylon environment map"),null;let l="",w=0;for(;w=c.getUint8(A++);)l+=String.fromCharCode(w);let N=JSON.parse(l);return N=H(N),N.binaryDataPosition=A,N.gq&&(N.gq.lodGenerationScale=N.gq.lodGenerationScale||.8),N}function H(y){if(y.version>O)throw new Error(`Unsupported babylon environment map version "${y.version}". Latest supported version is "${O}".`);return 2===y.version?y:y={...y,version:2,imageType:o}}function P(y,c){const A=(c=H(c)).gq;let l=Math.log2(c.width);if(l=Math.round(l)+1,A.mipmaps.length!==6*l)throw new Error(`Unsupported specular mipmaps number "${A.mipmaps.length}"`);const w=new Array(l);for(let N=0;N<l;N++){w[N]=new Array(6);for(let l=0;l<6;l++){const p=A.mipmaps[6*N+l];w[N][l]=new Uint8Array(y.buffer,y.byteOffset+c.binaryDataPosition+p.position,p.length)}}return w}function D(y,c){var A;c=H(c);const l=new Array(6),w=null===(A=c.irradiance)||void 0===A?void 0:A.irradianceTexture;if(w){if(6!==w.faces.length)throw new Error(`Incorrect irradiance texture faces number "${w.faces.length}"`);for(let A=0;A<6;A++){const N=w.faces[A];l[A]=new Uint8Array(y.buffer,y.byteOffset+c.binaryDataPosition+N.position,N.length)}}return l}function t(y,c,A){var l;const N=(A=H(A)).gq;if(!N)return Promise.resolve([]);y._lodGenerationScale=N.lodGenerationScale;const p=[],W=P(c,A);p.push(B(y,W,A.imageType));const h=null===(l=A.irradiance)||void 0===l?void 0:l.irradianceTexture;if(h){var I,q;const l=D(c,A);let N=null;null!==(I=A.irradiance)&&void 0!==I&&null!==(q=I.irradianceTexture)&&void 0!==q&&q.dominantDirection&&(N=w.gc.yA(A.irradiance.irradianceTexture.dominantDirection)),p.push(X(y,l,h.size,A.imageType,N))}return Promise.all(p)}async function s(y,c,A,l,w,N,p,W,h,I,q){return await new Promise(((o,O)=>{if(A){const A=c.createTexture(null,!0,!0,null,1,null,(y=>{O(y)}),y);null===l||void 0===l||l.onEffectCreatedObservable.addOnce((W=>{W.executeWhenCompiled((()=>{l.externalTextureSamplerBinding=!0,l.onApply=l=>{l._bindTexture("textureSampler",A),l.setFloat2("scale",1,c._features.needsInvertingBitmap&&y instanceof ImageBitmap?-1:1)},c.scenes.length&&(c.scenes[0].postProcessManager.directRender([l],I,!0,N,p),c.restoreDefaultFramebuffer(),A.dispose(),URL.revokeObjectURL(w),o())}))}))}else{if(c._uploadImageToTexture(q,y,N,p),W){const A=h[p];A&&c._uploadImageToTexture(A._texture,y,N,0)}o()}}))}async function B(y,c){let A=arguments.length>2&&void 0!==arguments[2]?arguments[2]:o;const l=y.getEngine();y.format=5,y.type=0,y.generateMipMaps=!0,y._cachedAnisotropicFilteringLevel=null,l.updateTextureSamplingMode(3,y),await C(y,c,!0,A),y.isReady=!0}async function X(y,c,A){let l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:o,w=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const N=y.getEngine(),p=new W.c(N,5),I=new h.d(N,p);y._irradianceTexture=I,I._dominantDirection=w,p.isCube=!0,p.format=5,p.type=0,p.generateMipMaps=!0,p._cachedAnisotropicFilteringLevel=null,p.generateMipMaps=!0,p.width=A,p.height=A,N.updateTextureSamplingMode(3,p),await C(p,[c],!1,l),N.generateMipMapsForCubemap(p),p.isReady=!0}async function C(y,c,w){let p=arguments.length>3&&void 0!==arguments[3]?arguments[3]:o;if(!l.Tools.IsExponentOfTwo(y.width))throw new Error("Texture size must be a power of two");const q=(0,N.ILog2)(y.width)+1,O=y.getEngine();let L=!1,i=!1,H=null,P=null,D=null;const t=O.getCaps();t.textureLOD?O._features.supportRenderAndCopyToLodForFloatTextures?t.textureHalfFloatRender&&t.textureHalfFloatLinearFiltering?(L=!0,y.type=2):t.textureFloatRender&&t.textureFloatLinearFiltering&&(L=!0,y.type=1):L=!1:(L=!1,i=w);let B=0;if(L)O.isWebGPU?(B=1,await A.e(42).then(A.bind(A,15318))):await A.e(35).then(A.bind(A,15327)),H=new I.c("rgbdDecode","rgbdDecode",null,null,1,null,3,O,!1,void 0,y.type,void 0,null,!1,void 0,B),y._isRGBD=!1,y.invertY=!1,P=O.createRenderTargetCubeTexture(y.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:y.type,format:5});else if(y._isRGBD=!0,y.invertY=!0,i){const c=3;D={};const A=y._lodGenerationScale,l=y._lodGenerationOffset;for(let w=0;w<c;w++){const N=(q-1)*A+l,p=l+(N-l)*(1-w/(c-1)),I=Math.round(Math.min(Math.max(p,0),N)),o=new W.c(O,2);o.isCube=!0,o.invertY=!0,o.generateMipMaps=!1,O.updateTextureSamplingMode(2,o);const L=new h.d(null);switch(L._isCube=!0,L._texture=o,D[I]=L,w){case 0:y._lodTextureLow=L;break;case 1:y._lodTextureMid=L;break;case 2:y._lodTextureHigh=L}}}const X=[];for(let A=0;A<c.length;A++)for(let l=0;l<6;l++){const w=c[A][l],N=new Blob([w],{type:p}),W=URL.createObjectURL(N);let h;if(O._features.forceBitmapOverHTMLImageElement)h=O.createImageBitmap(N,{premultiplyAlpha:"none"}).then((async c=>await s(c,O,L,H,W,l,A,i,D,P,y)));else{const c=new Image;c.src=W,h=new Promise(((w,N)=>{c.onload=()=>{s(c,O,L,H,W,l,A,i,D,P,y).then((()=>w())).catch((y=>{N(y)}))},c.onerror=y=>{N(y)}}))}X.push(h)}if(await Promise.all(X),c.length<q){let A;const l=Math.pow(2,q-1-c.length),w=l*l*4;switch(y.type){case 0:A=new Uint8Array(w);break;case 2:A=new Uint16Array(w);break;case 1:A=new Float32Array(w)}for(let N=c.length;N<q;N++)for(let c=0;c<6;c++){var C;O._uploadArrayBufferViewToTexture((null===(C=P)||void 0===C?void 0:C.texture)||y,A,c,N)}}if(P){const c=y._irradianceTexture;y._irradianceTexture=null,O._releaseTexture(y),P._swapAndDie(y),y._irradianceTexture=c}H&&H.dispose(),i&&(y._lodTextureHigh&&y._lodTextureHigh._texture&&(y._lodTextureHigh._texture.isReady=!0),y._lodTextureMid&&y._lodTextureMid._texture&&(y._lodTextureMid._texture.isReady=!0),y._lodTextureLow&&y._lodTextureLow._texture&&(y._lodTextureLow._texture.isReady=!0))}function K(y,c){const A=(c=H(c)).irradiance;if(!A)return;const l=new p.e;w.gc.FromArrayToRef(A.x,0,l.x),w.gc.FromArrayToRef(A.y,0,l.y),w.gc.FromArrayToRef(A.z,0,l.z),w.gc.FromArrayToRef(A.xx,0,l.xx),w.gc.FromArrayToRef(A.yy,0,l.yy),w.gc.FromArrayToRef(A.zz,0,l.zz),w.gc.FromArrayToRef(A.yz,0,l.yz),w.gc.FromArrayToRef(A.zx,0,l.zx),w.gc.FromArrayToRef(A.xy,0,l.xy),y._sphericalPolynomial=l}function my(y,c,A,l,w){const N=B(y.getEngine().createRawCubeTexture(null,y.width,y.format,y.type,y.generateMipMaps,y.invertY,y.samplingMode,y._compression),c).then((()=>y));return y.onRebuildCallback=y=>({proxy:N,isReady:!0,isAsync:!0}),y._source=13,y._bufferViewArrayArray=c,y._lodGenerationScale=l,y._lodGenerationOffset=w,y._sphericalPolynomial=A,B(y,c).then((()=>(y.isReady=!0,y)))}}}]);