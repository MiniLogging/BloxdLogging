"use strict";(self.n4ygn1cq9vg=self.n4ygn1cq9vg||[]).push([[45],{14142:(e,d,v)=>{v.d(d,{e:()=>w,g:()=>C,i:()=>A,k:()=>x});var P=v(12240),p=v(12420),L=v(12440),B=v(12609),X=v(12357),z=v(12446),W=(v(12653),v(12514)),V=v(12253);v(12925),v(12639),v(12934);const k="image/png",g=2,F=[134,22,135,150,246,214,150,54];function w(e){const d=new DataView(e.buffer,e.byteOffset,e.byteLength);let v=0;for(let B=0;B<F.length;B++)if(d.getUint8(v++)!==F[B])return V.c.Error("Not a babylon environment map"),null;let P="",p=0;for(;p=d.getUint8(v++);)P+=String.fromCharCode(p);let L=JSON.parse(P);return L=G(L),L.binaryDataPosition=v,L.VV&&(L.VV.lodGenerationScale=L.VV.lodGenerationScale||.8),L}function G(e){if(e.version>g)throw new Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "${g}".`);return 2===e.version?e:e={...e,version:2,imageType:k}}function U(e,d){const v=(d=G(d)).VV;let P=Math.log2(d.width);if(P=Math.round(P)+1,v.mipmaps.length!==6*P)throw new Error(`Unsupported specular mipmaps number "${v.mipmaps.length}"`);const p=new Array(P);for(let L=0;L<P;L++){p[L]=new Array(6);for(let P=0;P<6;P++){const B=v.mipmaps[6*L+P];p[L][P]=new Uint8Array(e.buffer,e.byteOffset+d.binaryDataPosition+B.position,B.length)}}return p}function D(e,d){var v;d=G(d);const P=new Array(6),p=null===(v=d.irradiance)||void 0===v?void 0:v.irradianceTexture;if(p){if(6!==p.faces.length)throw new Error(`Incorrect irradiance texture faces number "${p.faces.length}"`);for(let v=0;v<6;v++){const L=p.faces[v];P[v]=new Uint8Array(e.buffer,e.byteOffset+d.binaryDataPosition+L.position,L.length)}}return P}function C(e,d,v){var P;const L=(v=G(v)).VV;if(!L)return Promise.resolve([]);e._lodGenerationScale=L.lodGenerationScale;const B=[],X=U(d,v);B.push(h(e,X,v.imageType));const z=null===(P=v.irradiance)||void 0===P?void 0:P.irradianceTexture;if(z){var W,V;const P=D(d,v);let L=null;null!==(W=v.irradiance)&&void 0!==W&&null!==(V=W.irradianceTexture)&&void 0!==V&&V.dominantDirection&&(L=p.mv.Nd(v.irradiance.irradianceTexture.dominantDirection)),B.push(l(e,P,z.size,v.imageType,L))}return Promise.all(B)}async function q(e,d,v,P,p,L,B,X,z,W,V){return await new Promise(((k,g)=>{if(v){const v=d.createTexture(null,!0,!0,null,1,null,(e=>{g(e)}),e);null===P||void 0===P||P.onEffectCreatedObservable.addOnce((X=>{X.executeWhenCompiled((()=>{P.externalTextureSamplerBinding=!0,P.onApply=P=>{P._bindTexture("textureSampler",v),P.setFloat2("scale",1,d._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},d.scenes.length&&(d.scenes[0].postProcessManager.directRender([P],W,!0,L,B),d.restoreDefaultFramebuffer(),v.dispose(),URL.revokeObjectURL(p),k())}))}))}else{if(d._uploadImageToTexture(V,e,L,B),X){const v=z[B];v&&d._uploadImageToTexture(v._texture,e,L,0)}k()}}))}async function h(e,d){let v=arguments.length>2&&void 0!==arguments[2]?arguments[2]:k;const P=e.getEngine();e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,P.updateTextureSamplingMode(3,e),await n(e,d,!0,v),e.isReady=!0}async function l(e,d,v){let P=arguments.length>3&&void 0!==arguments[3]?arguments[3]:k,p=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const L=e.getEngine(),B=new X.b(L,5),W=new z.d(L,B);e._irradianceTexture=W,W._dominantDirection=p,B.isCube=!0,B.format=5,B.type=0,B.generateMipMaps=!0,B._cachedAnisotropicFilteringLevel=null,B.generateMipMaps=!0,B.width=v,B.height=v,L.updateTextureSamplingMode(3,B),await n(B,[d],!1,P),L.generateMipMapsForCubemap(B),B.isReady=!0}async function n(e,d,p){let B=arguments.length>3&&void 0!==arguments[3]?arguments[3]:k;if(!P.Tools.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");const V=(0,L.ILog2)(e.width)+1,g=e.getEngine();let F=!1,w=!1,G=null,U=null,D=null;const C=g.getCaps();C.textureLOD?g._features.supportRenderAndCopyToLodForFloatTextures?C.textureHalfFloatRender&&C.textureHalfFloatLinearFiltering?(F=!0,e.type=2):C.textureFloatRender&&C.textureFloatLinearFiltering&&(F=!0,e.type=1):F=!1:(F=!1,w=p);let h=0;if(F)g.isWebGPU?(h=1,await v.e(42).then(v.bind(v,15460))):await v.e(35).then(v.bind(v,15469)),G=new W.b("rgbdDecode","rgbdDecode",null,null,1,null,3,g,!1,void 0,e.type,void 0,null,!1,void 0,h),e._isRGBD=!1,e.invertY=!1,U=g.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,w){const d=3;D={};const v=e._lodGenerationScale,P=e._lodGenerationOffset;for(let p=0;p<d;p++){const L=(V-1)*v+P,B=P+(L-P)*(1-p/(d-1)),W=Math.round(Math.min(Math.max(B,0),L)),k=new X.b(g,2);k.isCube=!0,k.invertY=!0,k.generateMipMaps=!1,g.updateTextureSamplingMode(2,k);const F=new z.d(null);switch(F._isCube=!0,F._texture=k,D[W]=F,p){case 0:e._lodTextureLow=F;break;case 1:e._lodTextureMid=F;break;case 2:e._lodTextureHigh=F}}}const l=[];for(let v=0;v<d.length;v++)for(let P=0;P<6;P++){const p=d[v][P],L=new Blob([p],{type:B}),X=URL.createObjectURL(L);let z;if(g._features.forceBitmapOverHTMLImageElement)z=g.createImageBitmap(L,{premultiplyAlpha:"none"}).then((async d=>await q(d,g,F,G,X,P,v,w,D,U,e)));else{const d=new Image;d.src=X,z=new Promise(((p,L)=>{d.onload=()=>{q(d,g,F,G,X,P,v,w,D,U,e).then((()=>p())).catch((e=>{L(e)}))},d.onerror=e=>{L(e)}}))}l.push(z)}if(await Promise.all(l),d.length<V){let v;const P=Math.pow(2,V-1-d.length),p=P*P*4;switch(e.type){case 0:v=new Uint8Array(p);break;case 2:v=new Uint16Array(p);break;case 1:v=new Float32Array(p)}for(let L=d.length;L<V;L++)for(let d=0;d<6;d++){var n;g._uploadArrayBufferViewToTexture((null===(n=U)||void 0===n?void 0:n.texture)||e,v,d,L)}}if(U){const d=e._irradianceTexture;e._irradianceTexture=null,g._releaseTexture(e),U._swapAndDie(e),e._irradianceTexture=d}G&&G.dispose(),w&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))}function A(e,d){const v=(d=G(d)).irradiance;if(!v)return;const P=new B.f;p.mv.FromArrayToRef(v.x,0,P.x),p.mv.FromArrayToRef(v.y,0,P.y),p.mv.FromArrayToRef(v.z,0,P.z),p.mv.FromArrayToRef(v.xx,0,P.xx),p.mv.FromArrayToRef(v.yy,0,P.yy),p.mv.FromArrayToRef(v.zz,0,P.zz),p.mv.FromArrayToRef(v.yz,0,P.yz),p.mv.FromArrayToRef(v.zx,0,P.zx),p.mv.FromArrayToRef(v.xy,0,P.xy),e._sphericalPolynomial=P}function x(e,d,v,P,p){const L=h(e.getEngine().createRawCubeTexture(null,e.width,e.format,e.type,e.generateMipMaps,e.invertY,e.samplingMode,e._compression),d).then((()=>e));return e.onRebuildCallback=e=>({proxy:L,isReady:!0,isAsync:!0}),e._source=13,e._bufferViewArrayArray=d,e._lodGenerationScale=P,e._lodGenerationOffset=p,e._sphericalPolynomial=v,h(e,d).then((()=>(e.isReady=!0,e)))}}}]);