"use strict";(self.bbj0x35f849=self.bbj0x35f849||[]).push([[45],{12798:(N,q,C)=>{C.d(q,{c:()=>J,d:()=>O,f:()=>l,i:()=>T});var d=C(10945),U=C(11122),W=C(11142),a=C(11316),F=C(11055),w=C(11149),A=(C(11364),C(11228)),n=C(10962);C(11629),C(11354),C(11636);const t="image/png",V=2,Z=[134,22,135,150,246,214,150,54];function J(N){const q=new DataView(N.buffer,N.byteOffset,N.byteLength);let C=0;for(let a=0;a<Z.length;a++)if(q.getUint8(C++)!==Z[a])return n.c.Error("Not a babylon environment map"),null;let d="",U=0;for(;U=q.getUint8(C++);)d+=String.fromCharCode(U);let W=JSON.parse(d);return W=Q(W),W.binaryDataPosition=C,W.dn&&(W.dn.lodGenerationScale=W.dn.lodGenerationScale||.8),W}function Q(N){if(N.version>V)throw new Error(`Unsupported babylon environment map version "${N.version}". Latest supported version is "${V}".`);return 2===N.version?N:N={...N,version:2,imageType:t}}function v(N,q){const C=(q=Q(q)).dn;let d=Math.log2(q.width);if(d=Math.round(d)+1,C.mipmaps.length!==6*d)throw new Error(`Unsupported specular mipmaps number "${C.mipmaps.length}"`);const U=new Array(d);for(let W=0;W<d;W++){U[W]=new Array(6);for(let d=0;d<6;d++){const a=C.mipmaps[6*W+d];U[W][d]=new Uint8Array(N.buffer,N.byteOffset+q.binaryDataPosition+a.position,a.length)}}return U}function r(N,q){var C;q=Q(q);const d=new Array(6),U=null===(C=q.irradiance)||void 0===C?void 0:C.irradianceTexture;if(U){if(6!==U.faces.length)throw new Error(`Incorrect irradiance texture faces number "${U.faces.length}"`);for(let C=0;C<6;C++){const W=U.faces[C];d[C]=new Uint8Array(N.buffer,N.byteOffset+q.binaryDataPosition+W.position,W.length)}}return d}function O(N,q,C){var d;const W=(C=Q(C)).dn;if(!W)return Promise.resolve([]);N._lodGenerationScale=W.lodGenerationScale;const a=[],F=v(q,C);a.push(i(N,F,C.imageType));const w=null===(d=C.irradiance)||void 0===d?void 0:d.irradianceTexture;if(w){var A,n;const d=r(q,C);let W=null;null!==(A=C.irradiance)&&void 0!==A&&null!==(n=A.irradianceTexture)&&void 0!==n&&n.dominantDirection&&(W=U.Jq.Kq(C.irradiance.irradianceTexture.dominantDirection)),a.push(I(N,d,w.size,C.imageType,W))}return Promise.all(a)}async function K(N,q,C,d,U,W,a,F,w,A,n){return await new Promise(((t,V)=>{if(C){const C=q.createTexture(null,!0,!0,null,1,null,(N=>{V(N)}),N);null===d||void 0===d||d.onEffectCreatedObservable.addOnce((F=>{F.executeWhenCompiled((()=>{d.externalTextureSamplerBinding=!0,d.onApply=d=>{d._bindTexture("textureSampler",C),d.setFloat2("scale",1,q._features.needsInvertingBitmap&&N instanceof ImageBitmap?-1:1)},q.scenes.length&&(q.scenes[0].postProcessManager.directRender([d],A,!0,W,a),q.restoreDefaultFramebuffer(),C.dispose(),URL.revokeObjectURL(U),t())}))}))}else{if(q._uploadImageToTexture(n,N,W,a),F){const C=w[a];C&&q._uploadImageToTexture(C._texture,N,W,0)}t()}}))}async function i(N,q){let C=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t;const d=N.getEngine();N.format=5,N.type=0,N.generateMipMaps=!0,N._cachedAnisotropicFilteringLevel=null,d.updateTextureSamplingMode(3,N),await j(N,q,!0,C),N.isReady=!0}async function I(N,q,C){let d=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t,U=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const W=N.getEngine(),a=new F.e(W,5),A=new w.d(W,a);N._irradianceTexture=A,A._dominantDirection=U,a.isCube=!0,a.format=5,a.type=0,a.generateMipMaps=!0,a._cachedAnisotropicFilteringLevel=null,a.generateMipMaps=!0,a.width=C,a.height=C,W.updateTextureSamplingMode(3,a),await j(a,[q],!1,d),W.generateMipMapsForCubemap(a),a.isReady=!0}async function j(N,q,U){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t;if(!d.Tools.IsExponentOfTwo(N.width))throw new Error("Texture size must be a power of two");const n=(0,W.ILog2)(N.width)+1,V=N.getEngine();let Z=!1,J=!1,Q=null,v=null,r=null;const O=V.getCaps();O.textureLOD?V._features.supportRenderAndCopyToLodForFloatTextures?O.textureHalfFloatRender&&O.textureHalfFloatLinearFiltering?(Z=!0,N.type=2):O.textureFloatRender&&O.textureFloatLinearFiltering&&(Z=!0,N.type=1):Z=!1:(Z=!1,J=U);let i=0;if(Z)V.isWebGPU?(i=1,await C.e(42).then(C.bind(C,14132))):await C.e(35).then(C.bind(C,14141)),Q=new A.b("rgbdDecode","rgbdDecode",null,null,1,null,3,V,!1,void 0,N.type,void 0,null,!1,void 0,i),N._isRGBD=!1,N.invertY=!1,v=V.createRenderTargetCubeTexture(N.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:N.type,format:5});else if(N._isRGBD=!0,N.invertY=!0,J){const q=3;r={};const C=N._lodGenerationScale,d=N._lodGenerationOffset;for(let U=0;U<q;U++){const W=(n-1)*C+d,a=d+(W-d)*(1-U/(q-1)),A=Math.round(Math.min(Math.max(a,0),W)),t=new F.e(V,2);t.isCube=!0,t.invertY=!0,t.generateMipMaps=!1,V.updateTextureSamplingMode(2,t);const Z=new w.d(null);switch(Z._isCube=!0,Z._texture=t,r[A]=Z,U){case 0:N._lodTextureLow=Z;break;case 1:N._lodTextureMid=Z;break;case 2:N._lodTextureHigh=Z}}}const I=[];for(let C=0;C<q.length;C++)for(let d=0;d<6;d++){const U=q[C][d],W=new Blob([U],{type:a}),F=URL.createObjectURL(W);let w;if(V._features.forceBitmapOverHTMLImageElement)w=V.createImageBitmap(W,{premultiplyAlpha:"none"}).then((async q=>await K(q,V,Z,Q,F,d,C,J,r,v,N)));else{const q=new Image;q.src=F,w=new Promise(((U,W)=>{q.onload=()=>{K(q,V,Z,Q,F,d,C,J,r,v,N).then((()=>U())).catch((N=>{W(N)}))},q.onerror=N=>{W(N)}}))}I.push(w)}if(await Promise.all(I),q.length<n){let C;const d=Math.pow(2,n-1-q.length),U=d*d*4;switch(N.type){case 0:C=new Uint8Array(U);break;case 2:C=new Uint16Array(U);break;case 1:C=new Float32Array(U)}for(let W=q.length;W<n;W++)for(let q=0;q<6;q++){var j;V._uploadArrayBufferViewToTexture((null===(j=v)||void 0===j?void 0:j.texture)||N,C,q,W)}}if(v){const q=N._irradianceTexture;N._irradianceTexture=null,V._releaseTexture(N),v._swapAndDie(N),N._irradianceTexture=q}Q&&Q.dispose(),J&&(N._lodTextureHigh&&N._lodTextureHigh._texture&&(N._lodTextureHigh._texture.isReady=!0),N._lodTextureMid&&N._lodTextureMid._texture&&(N._lodTextureMid._texture.isReady=!0),N._lodTextureLow&&N._lodTextureLow._texture&&(N._lodTextureLow._texture.isReady=!0))}function l(N,q){const C=(q=Q(q)).irradiance;if(!C)return;const d=new a.g;U.Jq.FromArrayToRef(C.x,0,d.x),U.Jq.FromArrayToRef(C.y,0,d.y),U.Jq.FromArrayToRef(C.z,0,d.z),U.Jq.FromArrayToRef(C.xx,0,d.xx),U.Jq.FromArrayToRef(C.yy,0,d.yy),U.Jq.FromArrayToRef(C.zz,0,d.zz),U.Jq.FromArrayToRef(C.yz,0,d.yz),U.Jq.FromArrayToRef(C.zx,0,d.zx),U.Jq.FromArrayToRef(C.xy,0,d.xy),N._sphericalPolynomial=d}function T(N,q,C,d,U){const W=i(N.getEngine().createRawCubeTexture(null,N.width,N.format,N.type,N.generateMipMaps,N.invertY,N.samplingMode,N._compression),q).then((()=>N));return N.onRebuildCallback=N=>({proxy:W,isReady:!0,isAsync:!0}),N._source=13,N._bufferViewArrayArray=q,N._lodGenerationScale=d,N._lodGenerationOffset=U,N._sphericalPolynomial=C,i(N,q).then((()=>(N.isReady=!0,N)))}}}]);