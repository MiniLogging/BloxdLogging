"use strict";(self["2fwzcez286e"]=self["2fwzcez286e"]||[]).push([[45],{14660:(B,u,F)=>{F.d(u,{c:()=>D,f:()=>X,j:()=>y,k:()=>O});var Z=F(12802),V=F(12979),p=F(12994),G=F(13172),R=F(12925),e=F(13002),s=(F(13221),F(13080)),Y=F(12822);F(13469),F(13206),F(13480);const Q="image/png",t=2,v=[134,22,135,150,246,214,150,54];function D(B){const u=new DataView(B.buffer,B.byteOffset,B.byteLength);let F=0;for(let G=0;G<v.length;G++)if(u.getUint8(F++)!==v[G])return Y.d.Error("Not a babylon environment map"),null;let Z="",V=0;for(;V=u.getUint8(F++);)Z+=String.fromCharCode(V);let p=JSON.parse(Z);return p=L(p),p.binaryDataPosition=F,p.mQ&&(p.mQ.lodGenerationScale=p.mQ.lodGenerationScale||.8),p}function L(B){if(B.version>t)throw new Error(`Unsupported babylon environment map version "${B.version}". Latest supported version is "${t}".`);return 2===B.version?B:B={...B,version:2,imageType:Q}}function q(B,u){const F=(u=L(u)).mQ;let Z=Math.log2(u.width);if(Z=Math.round(Z)+1,F.mipmaps.length!==6*Z)throw new Error(`Unsupported specular mipmaps number "${F.mipmaps.length}"`);const V=new Array(Z);for(let p=0;p<Z;p++){V[p]=new Array(6);for(let Z=0;Z<6;Z++){const G=F.mipmaps[6*p+Z];V[p][Z]=new Uint8Array(B.buffer,B.byteOffset+u.binaryDataPosition+G.position,G.length)}}return V}function W(B,u){var F;u=L(u);const Z=new Array(6),V=null===(F=u.irradiance)||void 0===F?void 0:F.irradianceTexture;if(V){if(6!==V.faces.length)throw new Error(`Incorrect irradiance texture faces number "${V.faces.length}"`);for(let F=0;F<6;F++){const p=V.faces[F];Z[F]=new Uint8Array(B.buffer,B.byteOffset+u.binaryDataPosition+p.position,p.length)}}return Z}function X(B,u,F){var Z;const p=(F=L(F)).mQ;if(!p)return Promise.resolve([]);B._lodGenerationScale=p.lodGenerationScale;const G=[],R=q(u,F);G.push(C(B,R,F.imageType));const e=null===(Z=F.irradiance)||void 0===Z?void 0:Z.irradianceTexture;if(e){var s,Y;const Z=W(u,F);let p=null;null!==(s=F.irradiance)&&void 0!==s&&null!==(Y=s.irradianceTexture)&&void 0!==Y&&Y.dominantDirection&&(p=V.Du.fu(F.irradiance.irradianceTexture.dominantDirection)),G.push(x(B,Z,e.size,F.imageType,p))}return Promise.all(G)}async function f(B,u,F,Z,V,p,G,R,e,s,Y){return await new Promise(((Q,t)=>{if(F){const F=u.createTexture(null,!0,!0,null,1,null,(B=>{t(B)}),B);null===Z||void 0===Z||Z.onEffectCreatedObservable.addOnce((R=>{R.executeWhenCompiled((()=>{Z.externalTextureSamplerBinding=!0,Z.onApply=Z=>{Z._bindTexture("textureSampler",F),Z.setFloat2("scale",1,u._features.needsInvertingBitmap&&B instanceof ImageBitmap?-1:1)},u.scenes.length&&(u.scenes[0].postProcessManager.directRender([Z],s,!0,p,G),u.restoreDefaultFramebuffer(),F.dispose(),URL.revokeObjectURL(V),Q())}))}))}else{if(u._uploadImageToTexture(Y,B,p,G),R){const F=e[G];F&&u._uploadImageToTexture(F._texture,B,p,0)}Q()}}))}async function C(B,u){let F=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Q;const Z=B.getEngine();B.format=5,B.type=0,B.generateMipMaps=!0,B._cachedAnisotropicFilteringLevel=null,Z.updateTextureSamplingMode(3,B),await U(B,u,!0,F),B.isReady=!0}async function x(B,u,F){let Z=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Q,V=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const p=B.getEngine(),G=new R.b(p,5),s=new e.d(p,G);B._irradianceTexture=s,s._dominantDirection=V,G.isCube=!0,G.format=5,G.type=0,G.generateMipMaps=!0,G._cachedAnisotropicFilteringLevel=null,G.generateMipMaps=!0,G.width=F,G.height=F,p.updateTextureSamplingMode(3,G),await U(G,[u],!1,Z),p.generateMipMapsForCubemap(G),G.isReady=!0}async function U(B,u,V){let G=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Q;if(!Z.Tools.IsExponentOfTwo(B.width))throw new Error("Texture size must be a power of two");const Y=(0,p.ILog2)(B.width)+1,t=B.getEngine();let v=!1,D=!1,L=null,q=null,W=null;const X=t.getCaps();X.textureLOD?t._features.supportRenderAndCopyToLodForFloatTextures?X.textureHalfFloatRender&&X.textureHalfFloatLinearFiltering?(v=!0,B.type=2):X.textureFloatRender&&X.textureFloatLinearFiltering&&(v=!0,B.type=1):v=!1:(v=!1,D=V);let C=0;if(v)t.isWebGPU?(C=1,await F.e(42).then(F.bind(F,16052))):await F.e(35).then(F.bind(F,16060)),L=new s.c("rgbdDecode","rgbdDecode",null,null,1,null,3,t,!1,void 0,B.type,void 0,null,!1,void 0,C),B._isRGBD=!1,B.invertY=!1,q=t.createRenderTargetCubeTexture(B.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:B.type,format:5});else if(B._isRGBD=!0,B.invertY=!0,D){const u=3;W={};const F=B._lodGenerationScale,Z=B._lodGenerationOffset;for(let V=0;V<u;V++){const p=(Y-1)*F+Z,G=Z+(p-Z)*(1-V/(u-1)),s=Math.round(Math.min(Math.max(G,0),p)),Q=new R.b(t,2);Q.isCube=!0,Q.invertY=!0,Q.generateMipMaps=!1,t.updateTextureSamplingMode(2,Q);const v=new e.d(null);switch(v._isCube=!0,v._texture=Q,W[s]=v,V){case 0:B._lodTextureLow=v;break;case 1:B._lodTextureMid=v;break;case 2:B._lodTextureHigh=v}}}const x=[];for(let F=0;F<u.length;F++)for(let Z=0;Z<6;Z++){const V=u[F][Z],p=new Blob([V],{type:G}),R=URL.createObjectURL(p);let e;if(t._features.forceBitmapOverHTMLImageElement)e=t.createImageBitmap(p,{premultiplyAlpha:"none"}).then((async u=>await f(u,t,v,L,R,Z,F,D,W,q,B)));else{const u=new Image;u.src=R,e=new Promise(((V,p)=>{u.onload=()=>{f(u,t,v,L,R,Z,F,D,W,q,B).then((()=>V())).catch((B=>{p(B)}))},u.onerror=B=>{p(B)}}))}x.push(e)}if(await Promise.all(x),u.length<Y){let F;const Z=Math.pow(2,Y-1-u.length),V=Z*Z*4;switch(B.type){case 0:F=new Uint8Array(V);break;case 2:F=new Uint16Array(V);break;case 1:F=new Float32Array(V)}for(let p=u.length;p<Y;p++)for(let u=0;u<6;u++){var U;t._uploadArrayBufferViewToTexture((null===(U=q)||void 0===U?void 0:U.texture)||B,F,u,p)}}if(q){const u=B._irradianceTexture;B._irradianceTexture=null,t._releaseTexture(B),q._swapAndDie(B),B._irradianceTexture=u}L&&L.dispose(),D&&(B._lodTextureHigh&&B._lodTextureHigh._texture&&(B._lodTextureHigh._texture.isReady=!0),B._lodTextureMid&&B._lodTextureMid._texture&&(B._lodTextureMid._texture.isReady=!0),B._lodTextureLow&&B._lodTextureLow._texture&&(B._lodTextureLow._texture.isReady=!0))}function y(B,u){const F=(u=L(u)).irradiance;if(!F)return;const Z=new G.g;V.Du.FromArrayToRef(F.x,0,Z.x),V.Du.FromArrayToRef(F.y,0,Z.y),V.Du.FromArrayToRef(F.z,0,Z.z),V.Du.FromArrayToRef(F.xx,0,Z.xx),V.Du.FromArrayToRef(F.yy,0,Z.yy),V.Du.FromArrayToRef(F.zz,0,Z.zz),V.Du.FromArrayToRef(F.yz,0,Z.yz),V.Du.FromArrayToRef(F.zx,0,Z.zx),V.Du.FromArrayToRef(F.xy,0,Z.xy),B._sphericalPolynomial=Z}function O(B,u,F,Z,V){const p=C(B.getEngine().createRawCubeTexture(null,B.width,B.format,B.type,B.generateMipMaps,B.invertY,B.samplingMode,B._compression),u).then((()=>B));return B.onRebuildCallback=B=>({proxy:p,isReady:!0,isAsync:!0}),B._source=13,B._bufferViewArrayArray=u,B._lodGenerationScale=Z,B._lodGenerationOffset=V,B._sphericalPolynomial=F,C(B,u).then((()=>(B.isReady=!0,B)))}}}]);