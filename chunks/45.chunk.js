"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[45],{12891:(o,H,n)=>{n.d(H,{b:()=>x,d:()=>N,g:()=>m,j:()=>P});var E=n(11024),k=n(11189),g=n(11205),O=n(11380),Y=n(11120),y=n(11213),S=(n(11435),n(11292)),G=n(11038);n(11695),n(11420),n(11708);const c="image/png",A=2,l=[134,22,135,150,246,214,150,54];function x(o){const H=new DataView(o.buffer,o.byteOffset,o.byteLength);let n=0;for(let O=0;O<l.length;O++)if(H.getUint8(n++)!==l[O])return G.d.Error("Not a babylon environment map"),null;let E="",k=0;for(;k=H.getUint8(n++);)E+=String.fromCharCode(k);let g=JSON.parse(E);return g=z(g),g.binaryDataPosition=n,g.LS&&(g.LS.lodGenerationScale=g.LS.lodGenerationScale||.8),g}function z(o){if(o.version>A)throw new Error(`Unsupported babylon environment map version "${o.version}". Latest supported version is "${A}".`);return 2===o.version?o:o={...o,version:2,imageType:c}}function V(o,H){const n=(H=z(H)).LS;let E=Math.log2(H.width);if(E=Math.round(E)+1,n.mipmaps.length!==6*E)throw new Error(`Unsupported specular mipmaps number "${n.mipmaps.length}"`);const k=new Array(E);for(let g=0;g<E;g++){k[g]=new Array(6);for(let E=0;E<6;E++){const O=n.mipmaps[6*g+E];k[g][E]=new Uint8Array(o.buffer,o.byteOffset+H.binaryDataPosition+O.position,O.length)}}return k}function J(o,H){var n;H=z(H);const E=new Array(6),k=null===(n=H.irradiance)||void 0===n?void 0:n.irradianceTexture;if(k){if(6!==k.faces.length)throw new Error(`Incorrect irradiance texture faces number "${k.faces.length}"`);for(let n=0;n<6;n++){const g=k.faces[n];E[n]=new Uint8Array(o.buffer,o.byteOffset+H.binaryDataPosition+g.position,g.length)}}return E}function N(o,H,n){var E;const g=(n=z(n)).LS;if(!g)return Promise.resolve([]);o._lodGenerationScale=g.lodGenerationScale;const O=[],Y=V(H,n);O.push(Q(o,Y,n.imageType));const y=null===(E=n.irradiance)||void 0===E?void 0:E.irradianceTexture;if(y){var S,G;const E=J(H,n);let g=null;null!==(S=n.irradiance)&&void 0!==S&&null!==(G=S.irradianceTexture)&&void 0!==G&&G.dominantDirection&&(g=k.xH.Mg(n.irradiance.irradianceTexture.dominantDirection)),O.push(p(o,E,y.size,n.imageType,g))}return Promise.all(O)}async function h(o,H,n,E,k,g,O,Y,y,S,G){return await new Promise(((c,A)=>{if(n){const n=H.createTexture(null,!0,!0,null,1,null,(o=>{A(o)}),o);null===E||void 0===E||E.onEffectCreatedObservable.addOnce((Y=>{Y.executeWhenCompiled((()=>{E.externalTextureSamplerBinding=!0,E.onApply=E=>{E._bindTexture("textureSampler",n),E.setFloat2("scale",1,H._features.needsInvertingBitmap&&o instanceof ImageBitmap?-1:1)},H.scenes.length&&(H.scenes[0].postProcessManager.directRender([E],S,!0,g,O),H.restoreDefaultFramebuffer(),n.dispose(),URL.revokeObjectURL(k),c())}))}))}else{if(H._uploadImageToTexture(G,o,g,O),Y){const n=y[O];n&&H._uploadImageToTexture(n._texture,o,g,0)}c()}}))}async function Q(o,H){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:c;const E=o.getEngine();o.format=5,o.type=0,o.generateMipMaps=!0,o._cachedAnisotropicFilteringLevel=null,E.updateTextureSamplingMode(3,o),await j(o,H,!0,n),o.isReady=!0}async function p(o,H,n){let E=arguments.length>3&&void 0!==arguments[3]?arguments[3]:c,k=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const g=o.getEngine(),O=new Y.d(g,5),S=new y.e(g,O);o._irradianceTexture=S,S._dominantDirection=k,O.isCube=!0,O.format=5,O.type=0,O.generateMipMaps=!0,O._cachedAnisotropicFilteringLevel=null,O.generateMipMaps=!0,O.width=n,O.height=n,g.updateTextureSamplingMode(3,O),await j(O,[H],!1,E),g.generateMipMapsForCubemap(O),O.isReady=!0}async function j(o,H,k){let O=arguments.length>3&&void 0!==arguments[3]?arguments[3]:c;if(!E.Tools.IsExponentOfTwo(o.width))throw new Error("Texture size must be a power of two");const G=(0,g.ILog2)(o.width)+1,A=o.getEngine();let l=!1,x=!1,z=null,V=null,J=null;const N=A.getCaps();N.textureLOD?A._features.supportRenderAndCopyToLodForFloatTextures?N.textureHalfFloatRender&&N.textureHalfFloatLinearFiltering?(l=!0,o.type=2):N.textureFloatRender&&N.textureFloatLinearFiltering&&(l=!0,o.type=1):l=!1:(l=!1,x=k);let Q=0;if(l)A.isWebGPU?(Q=1,await n.e(42).then(n.bind(n,14277))):await n.e(35).then(n.bind(n,14284)),z=new S.e("rgbdDecode","rgbdDecode",null,null,1,null,3,A,!1,void 0,o.type,void 0,null,!1,void 0,Q),o._isRGBD=!1,o.invertY=!1,V=A.createRenderTargetCubeTexture(o.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:o.type,format:5});else if(o._isRGBD=!0,o.invertY=!0,x){const H=3;J={};const n=o._lodGenerationScale,E=o._lodGenerationOffset;for(let k=0;k<H;k++){const g=(G-1)*n+E,O=E+(g-E)*(1-k/(H-1)),S=Math.round(Math.min(Math.max(O,0),g)),c=new Y.d(A,2);c.isCube=!0,c.invertY=!0,c.generateMipMaps=!1,A.updateTextureSamplingMode(2,c);const l=new y.e(null);switch(l._isCube=!0,l._texture=c,J[S]=l,k){case 0:o._lodTextureLow=l;break;case 1:o._lodTextureMid=l;break;case 2:o._lodTextureHigh=l}}}const p=[];for(let n=0;n<H.length;n++)for(let E=0;E<6;E++){const k=H[n][E],g=new Blob([k],{type:O}),Y=URL.createObjectURL(g);let y;if(A._features.forceBitmapOverHTMLImageElement)y=A.createImageBitmap(g,{premultiplyAlpha:"none"}).then((async H=>await h(H,A,l,z,Y,E,n,x,J,V,o)));else{const H=new Image;H.src=Y,y=new Promise(((k,g)=>{H.onload=()=>{h(H,A,l,z,Y,E,n,x,J,V,o).then((()=>k())).catch((o=>{g(o)}))},H.onerror=o=>{g(o)}}))}p.push(y)}if(await Promise.all(p),H.length<G){let n;const E=Math.pow(2,G-1-H.length),k=E*E*4;switch(o.type){case 0:n=new Uint8Array(k);break;case 2:n=new Uint16Array(k);break;case 1:n=new Float32Array(k)}for(let g=H.length;g<G;g++)for(let H=0;H<6;H++){var j;A._uploadArrayBufferViewToTexture((null===(j=V)||void 0===j?void 0:j.texture)||o,n,H,g)}}if(V){const H=o._irradianceTexture;o._irradianceTexture=null,A._releaseTexture(o),V._swapAndDie(o),o._irradianceTexture=H}z&&z.dispose(),x&&(o._lodTextureHigh&&o._lodTextureHigh._texture&&(o._lodTextureHigh._texture.isReady=!0),o._lodTextureMid&&o._lodTextureMid._texture&&(o._lodTextureMid._texture.isReady=!0),o._lodTextureLow&&o._lodTextureLow._texture&&(o._lodTextureLow._texture.isReady=!0))}function m(o,H){const n=(H=z(H)).irradiance;if(!n)return;const E=new O.f;k.xH.FromArrayToRef(n.x,0,E.x),k.xH.FromArrayToRef(n.y,0,E.y),k.xH.FromArrayToRef(n.z,0,E.z),k.xH.FromArrayToRef(n.xx,0,E.xx),k.xH.FromArrayToRef(n.yy,0,E.yy),k.xH.FromArrayToRef(n.zz,0,E.zz),k.xH.FromArrayToRef(n.yz,0,E.yz),k.xH.FromArrayToRef(n.zx,0,E.zx),k.xH.FromArrayToRef(n.xy,0,E.xy),o._sphericalPolynomial=E}function P(o,H,n,E,k){const g=Q(o.getEngine().createRawCubeTexture(null,o.width,o.format,o.type,o.generateMipMaps,o.invertY,o.samplingMode,o._compression),H).then((()=>o));return o.onRebuildCallback=o=>({proxy:g,isReady:!0,isAsync:!0}),o._source=13,o._bufferViewArrayArray=H,o._lodGenerationScale=E,o._lodGenerationOffset=k,o._sphericalPolynomial=n,Q(o,H).then((()=>(o.isReady=!0,o)))}}}]);