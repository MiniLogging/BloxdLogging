"use strict";(self["6xhfpmwgjr5"]=self["6xhfpmwgjr5"]||[]).push([[45],{14486:(P,a,R)=>{R.d(a,{c:()=>O,d:()=>W,h:()=>G,i:()=>H});var S=R(12225),A=R(12415),Z=R(12430),p=R(12591),j=R(12359),U=R(12434),Q=(R(12636),R(12519)),h=R(12248);R(12877),R(12621),R(12891);const l="image/png",V=2,f=[134,22,135,150,246,214,150,54];function O(P){const a=new DataView(P.buffer,P.byteOffset,P.byteLength);let R=0;for(let p=0;p<f.length;p++)if(a.getUint8(R++)!==f[p])return h.c.Error("Not a babylon environment map"),null;let S="",A=0;for(;A=a.getUint8(R++);)S+=String.fromCharCode(A);let Z=JSON.parse(S);return Z=q(Z),Z.binaryDataPosition=R,Z.Zh&&(Z.Zh.lodGenerationScale=Z.Zh.lodGenerationScale||.8),Z}function q(P){if(P.version>V)throw new Error(`Unsupported babylon environment map version "${P.version}". Latest supported version is "${V}".`);return 2===P.version?P:P={...P,version:2,imageType:l}}function y(P,a){const R=(a=q(a)).Zh;let S=Math.log2(a.width);if(S=Math.round(S)+1,R.mipmaps.length!==6*S)throw new Error(`Unsupported specular mipmaps number "${R.mipmaps.length}"`);const A=new Array(S);for(let Z=0;Z<S;Z++){A[Z]=new Array(6);for(let S=0;S<6;S++){const p=R.mipmaps[6*Z+S];A[Z][S]=new Uint8Array(P.buffer,P.byteOffset+a.binaryDataPosition+p.position,p.length)}}return A}function t(P,a){var R;a=q(a);const S=new Array(6),A=null===(R=a.irradiance)||void 0===R?void 0:R.irradianceTexture;if(A){if(6!==A.faces.length)throw new Error(`Incorrect irradiance texture faces number "${A.faces.length}"`);for(let R=0;R<6;R++){const Z=A.faces[R];S[R]=new Uint8Array(P.buffer,P.byteOffset+a.binaryDataPosition+Z.position,Z.length)}}return S}function W(P,a,R){var S;const Z=(R=q(R)).Zh;if(!Z)return Promise.resolve([]);P._lodGenerationScale=Z.lodGenerationScale;const p=[],j=y(a,R);p.push(x(P,j,R.imageType));const U=null===(S=R.irradiance)||void 0===S?void 0:S.irradianceTexture;if(U){var Q,h;const S=t(a,R);let Z=null;null!==(Q=R.irradiance)&&void 0!==Q&&null!==(h=Q.irradianceTexture)&&void 0!==h&&h.dominantDirection&&(Z=A.Oa.ka(R.irradiance.irradianceTexture.dominantDirection)),p.push(s(P,S,U.size,R.imageType,Z))}return Promise.all(p)}async function k(P,a,R,S,A,Z,p,j,U,Q,h){return await new Promise(((l,V)=>{if(R){const R=a.createTexture(null,!0,!0,null,1,null,(P=>{V(P)}),P);null===S||void 0===S||S.onEffectCreatedObservable.addOnce((j=>{j.executeWhenCompiled((()=>{S.externalTextureSamplerBinding=!0,S.onApply=S=>{S._bindTexture("textureSampler",R),S.setFloat2("scale",1,a._features.needsInvertingBitmap&&P instanceof ImageBitmap?-1:1)},a.scenes.length&&(a.scenes[0].postProcessManager.directRender([S],Q,!0,Z,p),a.restoreDefaultFramebuffer(),R.dispose(),URL.revokeObjectURL(A),l())}))}))}else{if(a._uploadImageToTexture(h,P,Z,p),j){const R=U[p];R&&a._uploadImageToTexture(R._texture,P,Z,0)}l()}}))}async function x(P,a){let R=arguments.length>2&&void 0!==arguments[2]?arguments[2]:l;const S=P.getEngine();P.format=5,P.type=0,P.generateMipMaps=!0,P._cachedAnisotropicFilteringLevel=null,S.updateTextureSamplingMode(3,P),await d(P,a,!0,R),P.isReady=!0}async function s(P,a,R){let S=arguments.length>3&&void 0!==arguments[3]?arguments[3]:l,A=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const Z=P.getEngine(),p=new j.c(Z,5),Q=new U.b(Z,p);P._irradianceTexture=Q,Q._dominantDirection=A,p.isCube=!0,p.format=5,p.type=0,p.generateMipMaps=!0,p._cachedAnisotropicFilteringLevel=null,p.generateMipMaps=!0,p.width=R,p.height=R,Z.updateTextureSamplingMode(3,p),await d(p,[a],!1,S),Z.generateMipMapsForCubemap(p),p.isReady=!0}async function d(P,a,A){let p=arguments.length>3&&void 0!==arguments[3]?arguments[3]:l;if(!S.Tools.IsExponentOfTwo(P.width))throw new Error("Texture size must be a power of two");const h=(0,Z.ILog2)(P.width)+1,V=P.getEngine();let f=!1,O=!1,q=null,y=null,t=null;const W=V.getCaps();W.textureLOD?V._features.supportRenderAndCopyToLodForFloatTextures?W.textureHalfFloatRender&&W.textureHalfFloatLinearFiltering?(f=!0,P.type=2):W.textureFloatRender&&W.textureFloatLinearFiltering&&(f=!0,P.type=1):f=!1:(f=!1,O=A);let x=0;if(f)V.isWebGPU?(x=1,await R.e(42).then(R.bind(R,16302))):await R.e(35).then(R.bind(R,16310)),q=new Q.d("rgbdDecode","rgbdDecode",null,null,1,null,3,V,!1,void 0,P.type,void 0,null,!1,void 0,x),P._isRGBD=!1,P.invertY=!1,y=V.createRenderTargetCubeTexture(P.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:P.type,format:5});else if(P._isRGBD=!0,P.invertY=!0,O){const a=3;t={};const R=P._lodGenerationScale,S=P._lodGenerationOffset;for(let A=0;A<a;A++){const Z=(h-1)*R+S,p=S+(Z-S)*(1-A/(a-1)),Q=Math.round(Math.min(Math.max(p,0),Z)),l=new j.c(V,2);l.isCube=!0,l.invertY=!0,l.generateMipMaps=!1,V.updateTextureSamplingMode(2,l);const f=new U.b(null);switch(f._isCube=!0,f._texture=l,t[Q]=f,A){case 0:P._lodTextureLow=f;break;case 1:P._lodTextureMid=f;break;case 2:P._lodTextureHigh=f}}}const s=[];for(let R=0;R<a.length;R++)for(let S=0;S<6;S++){const A=a[R][S],Z=new Blob([A],{type:p}),j=URL.createObjectURL(Z);let U;if(V._features.forceBitmapOverHTMLImageElement)U=V.createImageBitmap(Z,{premultiplyAlpha:"none"}).then((async a=>await k(a,V,f,q,j,S,R,O,t,y,P)));else{const a=new Image;a.src=j,U=new Promise(((A,Z)=>{a.onload=()=>{k(a,V,f,q,j,S,R,O,t,y,P).then((()=>A())).catch((P=>{Z(P)}))},a.onerror=P=>{Z(P)}}))}s.push(U)}if(await Promise.all(s),a.length<h){let R;const S=Math.pow(2,h-1-a.length),A=S*S*4;switch(P.type){case 0:R=new Uint8Array(A);break;case 2:R=new Uint16Array(A);break;case 1:R=new Float32Array(A)}for(let Z=a.length;Z<h;Z++)for(let a=0;a<6;a++){var d;V._uploadArrayBufferViewToTexture((null===(d=y)||void 0===d?void 0:d.texture)||P,R,a,Z)}}if(y){const a=P._irradianceTexture;P._irradianceTexture=null,V._releaseTexture(P),y._swapAndDie(P),P._irradianceTexture=a}q&&q.dispose(),O&&(P._lodTextureHigh&&P._lodTextureHigh._texture&&(P._lodTextureHigh._texture.isReady=!0),P._lodTextureMid&&P._lodTextureMid._texture&&(P._lodTextureMid._texture.isReady=!0),P._lodTextureLow&&P._lodTextureLow._texture&&(P._lodTextureLow._texture.isReady=!0))}function G(P,a){const R=(a=q(a)).irradiance;if(!R)return;const S=new p.f;A.Oa.FromArrayToRef(R.x,0,S.x),A.Oa.FromArrayToRef(R.y,0,S.y),A.Oa.FromArrayToRef(R.z,0,S.z),A.Oa.FromArrayToRef(R.xx,0,S.xx),A.Oa.FromArrayToRef(R.yy,0,S.yy),A.Oa.FromArrayToRef(R.zz,0,S.zz),A.Oa.FromArrayToRef(R.yz,0,S.yz),A.Oa.FromArrayToRef(R.zx,0,S.zx),A.Oa.FromArrayToRef(R.xy,0,S.xy),P._sphericalPolynomial=S}function H(P,a,R,S,A){const Z=x(P.getEngine().createRawCubeTexture(null,P.width,P.format,P.type,P.generateMipMaps,P.invertY,P.samplingMode,P._compression),a).then((()=>P));return P.onRebuildCallback=P=>({proxy:Z,isReady:!0,isAsync:!0}),P._source=13,P._bufferViewArrayArray=a,P._lodGenerationScale=S,P._lodGenerationOffset=A,P._sphericalPolynomial=R,x(P,a).then((()=>(P.isReady=!0,P)))}}}]);