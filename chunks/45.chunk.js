"use strict";(self["686i8587bmi"]=self["686i8587bmi"]||[]).push([[45],{14485:(h,d,T)=>{T.d(d,{c:()=>O,e:()=>L,f:()=>s,g:()=>E});var Y=T(12574),y=T(12765),C=T(12787),n=T(12939),X=T(12684),F=T(12791),U=(T(12990),T(12864)),Z=T(12596);T(13277),T(12972),T(13287);const S="image/png",r=2,c=[134,22,135,150,246,214,150,54];function O(h){const d=new DataView(h.buffer,h.byteOffset,h.byteLength);let T=0;for(let n=0;n<c.length;n++)if(d.getUint8(T++)!==c[n])return Z.c.Error("Not a babylon environment map"),null;let Y="",y=0;for(;y=d.getUint8(T++);)Y+=String.fromCharCode(y);let C=JSON.parse(Y);return C=f(C),C.binaryDataPosition=T,C.EZ&&(C.EZ.lodGenerationScale=C.EZ.lodGenerationScale||.8),C}function f(h){if(h.version>r)throw new Error(`Unsupported babylon environment map version "${h.version}". Latest supported version is "${r}".`);return 2===h.version?h:h={...h,version:2,imageType:S}}function J(h,d){const T=(d=f(d)).EZ;let Y=Math.log2(d.width);if(Y=Math.round(Y)+1,T.mipmaps.length!==6*Y)throw new Error(`Unsupported specular mipmaps number "${T.mipmaps.length}"`);const y=new Array(Y);for(let C=0;C<Y;C++){y[C]=new Array(6);for(let Y=0;Y<6;Y++){const n=T.mipmaps[6*C+Y];y[C][Y]=new Uint8Array(h.buffer,h.byteOffset+d.binaryDataPosition+n.position,n.length)}}return y}function W(h,d){var T;d=f(d);const Y=new Array(6),y=null===(T=d.irradiance)||void 0===T?void 0:T.irradianceTexture;if(y){if(6!==y.faces.length)throw new Error(`Incorrect irradiance texture faces number "${y.faces.length}"`);for(let T=0;T<6;T++){const C=y.faces[T];Y[T]=new Uint8Array(h.buffer,h.byteOffset+d.binaryDataPosition+C.position,C.length)}}return Y}function L(h,d,T){var Y;const C=(T=f(T)).EZ;if(!C)return Promise.resolve([]);h._lodGenerationScale=C.lodGenerationScale;const n=[],X=J(d,T);n.push(V(h,X,T.imageType));const F=null===(Y=T.irradiance)||void 0===Y?void 0:Y.irradianceTexture;if(F){var U,Z;const Y=W(d,T);let C=null;null!==(U=T.irradiance)&&void 0!==U&&null!==(Z=U.irradianceTexture)&&void 0!==Z&&Z.dominantDirection&&(C=y.pd.Bd(T.irradiance.irradianceTexture.dominantDirection)),n.push(i(h,Y,F.size,T.imageType,C))}return Promise.all(n)}async function D(h,d,T,Y,y,C,n,X,F,U,Z){return await new Promise(((S,r)=>{if(T){const T=d.createTexture(null,!0,!0,null,1,null,(h=>{r(h)}),h);null===Y||void 0===Y||Y.onEffectCreatedObservable.addOnce((X=>{X.executeWhenCompiled((()=>{Y.externalTextureSamplerBinding=!0,Y.onApply=Y=>{Y._bindTexture("textureSampler",T),Y.setFloat2("scale",1,d._features.needsInvertingBitmap&&h instanceof ImageBitmap?-1:1)},d.scenes.length&&(d.scenes[0].postProcessManager.directRender([Y],U,!0,C,n),d.restoreDefaultFramebuffer(),T.dispose(),URL.revokeObjectURL(y),S())}))}))}else{if(d._uploadImageToTexture(Z,h,C,n),X){const T=F[n];T&&d._uploadImageToTexture(T._texture,h,C,0)}S()}}))}async function V(h,d){let T=arguments.length>2&&void 0!==arguments[2]?arguments[2]:S;const Y=h.getEngine();h.format=5,h.type=0,h.generateMipMaps=!0,h._cachedAnisotropicFilteringLevel=null,Y.updateTextureSamplingMode(3,h),await w(h,d,!0,T),h.isReady=!0}async function i(h,d,T){let Y=arguments.length>3&&void 0!==arguments[3]?arguments[3]:S,y=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const C=h.getEngine(),n=new X.e(C,5),U=new F.d(C,n);h._irradianceTexture=U,U._dominantDirection=y,n.isCube=!0,n.format=5,n.type=0,n.generateMipMaps=!0,n._cachedAnisotropicFilteringLevel=null,n.generateMipMaps=!0,n.width=T,n.height=T,C.updateTextureSamplingMode(3,n),await w(n,[d],!1,Y),C.generateMipMapsForCubemap(n),n.isReady=!0}async function w(h,d,y){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:S;if(!Y.Tools.IsExponentOfTwo(h.width))throw new Error("Texture size must be a power of two");const Z=(0,C.ILog2)(h.width)+1,r=h.getEngine();let c=!1,O=!1,f=null,J=null,W=null;const L=r.getCaps();L.textureLOD?r._features.supportRenderAndCopyToLodForFloatTextures?L.textureHalfFloatRender&&L.textureHalfFloatLinearFiltering?(c=!0,h.type=2):L.textureFloatRender&&L.textureFloatLinearFiltering&&(c=!0,h.type=1):c=!1:(c=!1,O=y);let V=0;if(c)r.isWebGPU?(V=1,await T.e(42).then(T.bind(T,15882))):await T.e(35).then(T.bind(T,15890)),f=new U.b("rgbdDecode","rgbdDecode",null,null,1,null,3,r,!1,void 0,h.type,void 0,null,!1,void 0,V),h._isRGBD=!1,h.invertY=!1,J=r.createRenderTargetCubeTexture(h.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:h.type,format:5});else if(h._isRGBD=!0,h.invertY=!0,O){const d=3;W={};const T=h._lodGenerationScale,Y=h._lodGenerationOffset;for(let y=0;y<d;y++){const C=(Z-1)*T+Y,n=Y+(C-Y)*(1-y/(d-1)),U=Math.round(Math.min(Math.max(n,0),C)),S=new X.e(r,2);S.isCube=!0,S.invertY=!0,S.generateMipMaps=!1,r.updateTextureSamplingMode(2,S);const c=new F.d(null);switch(c._isCube=!0,c._texture=S,W[U]=c,y){case 0:h._lodTextureLow=c;break;case 1:h._lodTextureMid=c;break;case 2:h._lodTextureHigh=c}}}const i=[];for(let T=0;T<d.length;T++)for(let Y=0;Y<6;Y++){const y=d[T][Y],C=new Blob([y],{type:n}),X=URL.createObjectURL(C);let F;if(r._features.forceBitmapOverHTMLImageElement)F=r.createImageBitmap(C,{premultiplyAlpha:"none"}).then((async d=>await D(d,r,c,f,X,Y,T,O,W,J,h)));else{const d=new Image;d.src=X,F=new Promise(((y,C)=>{d.onload=()=>{D(d,r,c,f,X,Y,T,O,W,J,h).then((()=>y())).catch((h=>{C(h)}))},d.onerror=h=>{C(h)}}))}i.push(F)}if(await Promise.all(i),d.length<Z){let T;const Y=Math.pow(2,Z-1-d.length),y=Y*Y*4;switch(h.type){case 0:T=new Uint8Array(y);break;case 2:T=new Uint16Array(y);break;case 1:T=new Float32Array(y)}for(let C=d.length;C<Z;C++)for(let d=0;d<6;d++){var w;r._uploadArrayBufferViewToTexture((null===(w=J)||void 0===w?void 0:w.texture)||h,T,d,C)}}if(J){const d=h._irradianceTexture;h._irradianceTexture=null,r._releaseTexture(h),J._swapAndDie(h),h._irradianceTexture=d}f&&f.dispose(),O&&(h._lodTextureHigh&&h._lodTextureHigh._texture&&(h._lodTextureHigh._texture.isReady=!0),h._lodTextureMid&&h._lodTextureMid._texture&&(h._lodTextureMid._texture.isReady=!0),h._lodTextureLow&&h._lodTextureLow._texture&&(h._lodTextureLow._texture.isReady=!0))}function s(h,d){const T=(d=f(d)).irradiance;if(!T)return;const Y=new n.g;y.pd.FromArrayToRef(T.x,0,Y.x),y.pd.FromArrayToRef(T.y,0,Y.y),y.pd.FromArrayToRef(T.z,0,Y.z),y.pd.FromArrayToRef(T.xx,0,Y.xx),y.pd.FromArrayToRef(T.yy,0,Y.yy),y.pd.FromArrayToRef(T.zz,0,Y.zz),y.pd.FromArrayToRef(T.yz,0,Y.yz),y.pd.FromArrayToRef(T.zx,0,Y.zx),y.pd.FromArrayToRef(T.xy,0,Y.xy),h._sphericalPolynomial=Y}function E(h,d,T,Y,y){const C=V(h.getEngine().createRawCubeTexture(null,h.width,h.format,h.type,h.generateMipMaps,h.invertY,h.samplingMode,h._compression),d).then((()=>h));return h.onRebuildCallback=h=>({proxy:C,isReady:!0,isAsync:!0}),h._source=13,h._bufferViewArrayArray=d,h._lodGenerationScale=Y,h._lodGenerationOffset=y,h._sphericalPolynomial=T,V(h,d).then((()=>(h.isReady=!0,h)))}}}]);