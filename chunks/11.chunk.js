"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[11],{2452:(K,Y,l)=>{l.r(Y),l.d(Y,{_KTXTextureLoader:()=>u});var v=l(492);class U{constructor(K,Y){if(this.data=K,this.isInvalid=!1,!U.IsValid(K))return this.isInvalid=!0,void v.e.Error("texture missing KTX identifier");const l=Uint32Array.BYTES_PER_ELEMENT,d=new DataView(this.data.buffer,this.data.byteOffset+12,13*l),A=67305985===d.getUint32(0,!0);return this.glType=d.getUint32(1*l,A),this.glTypeSize=d.getUint32(2*l,A),this.glFormat=d.getUint32(3*l,A),this.glInternalFormat=d.getUint32(4*l,A),this.glBaseInternalFormat=d.getUint32(5*l,A),this.pixelWidth=d.getUint32(6*l,A),this.pixelHeight=d.getUint32(7*l,A),this.pixelDepth=d.getUint32(8*l,A),this.numberOfArrayElements=d.getUint32(9*l,A),this.numberOfFaces=d.getUint32(10*l,A),this.numberOfMipmapLevels=d.getUint32(11*l,A),this.bytesOfKeyValueData=d.getUint32(12*l,A),0!==this.glType?(v.e.Error("only compressed formats currently supported"),void(this.isInvalid=!0)):(this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels),0===this.pixelHeight||0!==this.pixelDepth?(v.e.Error("only 2D textures currently supported"),void(this.isInvalid=!0)):0!==this.numberOfArrayElements?(v.e.Error("texture arrays not currently supported"),void(this.isInvalid=!0)):this.numberOfFaces!==Y?(v.e.Error("number of faces expected"+Y+", but found "+this.numberOfFaces),void(this.isInvalid=!0)):void(this.loadType=U.COMPRESSED_2D))}uploadLevels(K,Y){switch(this.loadType){case U.COMPRESSED_2D:this._upload2DCompressedLevels(K,Y);case U.TEX_2D:case U.COMPRESSED_3D:case U.TEX_3D:}}_upload2DCompressedLevels(K,Y){let l=U.HEADER_LEN+this.bytesOfKeyValueData,v=this.pixelWidth,d=this.pixelHeight;const A=Y?this.numberOfMipmapLevels:1;for(let U=0;U<A;U++){const Y=new Int32Array(this.data.buffer,this.data.byteOffset+l,1)[0];l+=4;for(let A=0;A<this.numberOfFaces;A++){const c=new Uint8Array(this.data.buffer,this.data.byteOffset+l,Y);K.getEngine()._uploadCompressedDataToTextureDirectly(K,K.format,v,d,c,A,U),l+=Y,l+=3-(Y+3)%4}v=Math.max(1,.5*v),d=Math.max(1,.5*d)}}static IsValid(K){if(K.byteLength>=12){const Y=new Uint8Array(K.buffer,K.byteOffset,12);if(171===Y[0]&&75===Y[1]&&84===Y[2]&&88===Y[3]&&32===Y[4]&&49===Y[5]&&49===Y[6]&&187===Y[7]&&13===Y[8]&&10===Y[9]&&26===Y[10]&&10===Y[11])return!0}return!1}}U.HEADER_LEN=64,U.COMPRESSED_2D=0,U.COMPRESSED_3D=1,U.TEX_2D=2,U.TEX_3D=3;var d,A,c,t=l(2457),Z=l(475);function m(K,Y){const l=(null===Y||void 0===Y?void 0:Y.jsDecoderModule)||KTX2DECODER;K&&(K.wasmUASTCToASTC&&(l.LiteTranscoder_UASTC_ASTC.WasmModuleURL=K.wasmUASTCToASTC),K.wasmUASTCToBC7&&(l.LiteTranscoder_UASTC_BC7.WasmModuleURL=K.wasmUASTCToBC7),K.wasmUASTCToRGBA_UNORM&&(l.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=K.wasmUASTCToRGBA_UNORM),K.wasmUASTCToRGBA_SRGB&&(l.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=K.wasmUASTCToRGBA_SRGB),K.wasmUASTCToR8_UNORM&&(l.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=K.wasmUASTCToR8_UNORM),K.wasmUASTCToRG8_UNORM&&(l.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=K.wasmUASTCToRG8_UNORM),K.jsMSCTranscoder&&(l.MSCTranscoder.JSModuleURL=K.jsMSCTranscoder),K.wasmMSCTranscoder&&(l.MSCTranscoder.WasmModuleURL=K.wasmMSCTranscoder),K.wasmZSTDDecoder&&(l.ZSTDDecoder.WasmModuleURL=K.wasmZSTDDecoder)),Y&&(Y.wasmUASTCToASTC&&(l.LiteTranscoder_UASTC_ASTC.WasmBinary=Y.wasmUASTCToASTC),Y.wasmUASTCToBC7&&(l.LiteTranscoder_UASTC_BC7.WasmBinary=Y.wasmUASTCToBC7),Y.wasmUASTCToRGBA_UNORM&&(l.LiteTranscoder_UASTC_RGBA_UNORM.WasmBinary=Y.wasmUASTCToRGBA_UNORM),Y.wasmUASTCToRGBA_SRGB&&(l.LiteTranscoder_UASTC_RGBA_SRGB.WasmBinary=Y.wasmUASTCToRGBA_SRGB),Y.wasmUASTCToR8_UNORM&&(l.LiteTranscoder_UASTC_R8_UNORM.WasmBinary=Y.wasmUASTCToR8_UNORM),Y.wasmUASTCToRG8_UNORM&&(l.LiteTranscoder_UASTC_RG8_UNORM.WasmBinary=Y.wasmUASTCToRG8_UNORM),Y.jsMSCTranscoder&&(l.MSCTranscoder.JSModule=Y.jsMSCTranscoder),Y.wasmMSCTranscoder&&(l.MSCTranscoder.WasmBinary=Y.wasmMSCTranscoder),Y.wasmZSTDDecoder&&(l.ZSTDDecoder.WasmBinary=Y.wasmZSTDDecoder))}function V(K){let Y;"undefined"===typeof K&&"undefined"!==typeof KTX2DECODER&&(K=KTX2DECODER),onmessage=l=>{if(l.data)switch(l.data.action){case"init":{const v=l.data.urls;v&&(v.jsDecoderModule&&"undefined"===typeof K&&(importScripts(v.jsDecoderModule),K=KTX2DECODER),m(v)),l.data.wasmBinaries&&m(void 0,{...l.data.wasmBinaries,jsDecoderModule:K}),Y=new K.KTX2Decoder,postMessage({action:"init"});break}case"setDefaultDecoderOptions":K.KTX2Decoder.DefaultDecoderOptions=l.data.options;break;case"decode":Y.decode(l.data.data,l.data.caps,l.data.options).then((K=>{const Y=[];for(let l=0;l<K.mipmaps.length;++l){const v=K.mipmaps[l];v&&v.data&&Y.push(v.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:K},Y)})).catch((K=>{postMessage({action:"decoded",success:!1,msg:K})}))}}}!function(K){K[K.ETC1S=0]="ETC1S",K[K.UASTC4x4=1]="UASTC4x4"}(d||(d={})),function(K){K[K.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",K[K.BC7_RGBA=1]="BC7_RGBA",K[K.BC3_RGBA=2]="BC3_RGBA",K[K.BC1_RGB=3]="BC1_RGB",K[K.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",K[K.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",K[K.ETC2_RGBA=6]="ETC2_RGBA",K[K.ETC1_RGB=7]="ETC1_RGB",K[K.RGBA32=8]="RGBA32",K[K.R8=9]="R8",K[K.RG8=10]="RG8"}(A||(A={})),function(K){K[K.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",K[K.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",K[K.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",K[K.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",K[K.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",K[K.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",K[K.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",K[K.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",K[K.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",K[K.RGBA8Format=32856]="RGBA8Format",K[K.R8Format=33321]="R8Format",K[K.RG8Format=33323]="RG8Format"}(c||(c={}));class M{static GetDefaultNumWorkers(){return"object"===typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static _Initialize(K){if(M._WorkerPoolPromise||M._DecoderModulePromise)return;const Y={jsDecoderModule:Z.d.GetBabylonScriptURL(this.URLConfig.jsDecoderModule,!0),wasmUASTCToASTC:Z.d.GetBabylonScriptURL(this.URLConfig.wasmUASTCToASTC,!0),wasmUASTCToBC7:Z.d.GetBabylonScriptURL(this.URLConfig.wasmUASTCToBC7,!0),wasmUASTCToRGBA_UNORM:Z.d.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_UNORM,!0),wasmUASTCToRGBA_SRGB:Z.d.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_SRGB,!0),wasmUASTCToR8_UNORM:Z.d.GetBabylonScriptURL(this.URLConfig.wasmUASTCToR8_UNORM,!0),wasmUASTCToRG8_UNORM:Z.d.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRG8_UNORM,!0),jsMSCTranscoder:Z.d.GetBabylonScriptURL(this.URLConfig.jsMSCTranscoder,!0),wasmMSCTranscoder:Z.d.GetBabylonScriptURL(this.URLConfig.wasmMSCTranscoder,!0),wasmZSTDDecoder:Z.d.GetBabylonScriptURL(this.URLConfig.wasmZSTDDecoder,!0)};K&&"function"===typeof Worker&&"undefined"!==typeof URL?M._WorkerPoolPromise=new Promise((l=>{const v=`${m}(${V})()`,U=URL.createObjectURL(new Blob([v],{type:"application/javascript"}));l(new t.c(K,(()=>function(K,Y,l){return new Promise(((v,U)=>{const d=Y=>{K.removeEventListener("error",d),K.removeEventListener("message",A),U(Y)},A=Y=>{"init"===Y.data.action&&(K.removeEventListener("error",d),K.removeEventListener("message",A),v(K))};K.addEventListener("error",d),K.addEventListener("message",A),K.postMessage({action:"init",urls:l,wasmBinaries:Y})}))}(new Worker(U),void 0,Y))))})):"undefined"===typeof M._KTX2DecoderModule?M._DecoderModulePromise=Z.d.LoadBabylonScriptAsync(Y.jsDecoderModule).then((()=>(M._KTX2DecoderModule=KTX2DECODER,M._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,M._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,m(Y,M._KTX2DecoderModule),new M._KTX2DecoderModule.KTX2Decoder))):(M._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,M._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,M._DecoderModulePromise=Promise.resolve(new M._KTX2DecoderModule.KTX2Decoder))}constructor(K){let Y=arguments.length>1&&void 0!==arguments[1]?arguments[1]:M.DefaultNumWorkers;this._engine=K;const l="object"===typeof Y&&Y.workerPool||M.WorkerPool;if(l)M._WorkerPoolPromise=Promise.resolve(l);else{var v;if("object"===typeof Y)M._KTX2DecoderModule=null===Y||void 0===Y||null===(v=Y.binariesAndModulesContainer)||void 0===v?void 0:v.jsDecoderModule;else"undefined"!==typeof KTX2DECODER&&(M._KTX2DecoderModule=KTX2DECODER);const K="number"===typeof Y?Y:Y.numWorkers??M.DefaultNumWorkers;M._Initialize(K)}}_uploadAsync(K,Y,l){const v=this._engine.getCaps(),U={astc:!!v.astc,bptc:!!v.bptc,s3tc:!!v.s3tc,pvrtc:!!v.pvrtc,etc2:!!v.etc2,etc1:!!v.etc1};if(M._WorkerPoolPromise)return M._WorkerPoolPromise.then((v=>new Promise(((d,A)=>{v.push(((v,c)=>{const t=K=>{v.removeEventListener("error",t),v.removeEventListener("message",Z),A(K),c()},Z=K=>{if("decoded"===K.data.action){if(v.removeEventListener("error",t),v.removeEventListener("message",Z),K.data.success)try{this._createTexture(K.data.decodedData,Y,l),d()}catch(U){A({message:U})}else A({message:K.data.msg});c()}};v.addEventListener("error",t),v.addEventListener("message",Z),v.postMessage({action:"setDefaultDecoderOptions",options:M.DefaultDecoderOptions._getKTX2DecoderOptions()});const m=new Uint8Array(K.byteLength);m.set(new Uint8Array(K.buffer,K.byteOffset,K.byteLength)),v.postMessage({action:"decode",data:m,caps:U,options:l},[m.buffer])}))}))));if(M._DecoderModulePromise)return M._DecoderModulePromise.then((l=>(M.DefaultDecoderOptions.isDirty&&(M._KTX2DecoderModule.KTX2Decoder.DefaultDecoderOptions=M.DefaultDecoderOptions._getKTX2DecoderOptions()),new Promise(((U,d)=>{l.decode(K,v).then((K=>{this._createTexture(K,Y),U()})).catch((K=>{d({message:K})}))})))));throw new Error("KTX2 decoder module is not available")}_createTexture(K,Y,l){this._engine._bindTextureDirectly(3553,Y),l&&(l.transcodedFormat=K.transcodedFormat,l.isInGammaSpace=K.isInGammaSpace,l.Cj=K.Cj,l.transcoderName=K.transcoderName);let v=!0;switch(K.transcodedFormat){case 32856:Y.type=0,Y.format=5;break;case 33321:Y.type=0,Y.format=6;break;case 33323:Y.type=0,Y.format=7;break;default:Y.format=K.transcodedFormat,v=!1}if(Y._gammaSpace=K.isInGammaSpace,Y.generateMipMaps=K.mipmaps.length>1,K.errors)throw new Error("KTX2 container - could not transcode the data. "+K.errors);for(let U=0;U<K.mipmaps.length;++U){const l=K.mipmaps[U];if(!l||!l.data)throw new Error("KTX2 container - could not transcode one of the image");v?(Y.width=l.width,Y.height=l.height,this._engine._uploadDataToTextureDirectly(Y,l.data,0,U,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(Y,K.transcodedFormat,l.width,l.height,l.data,0,U)}Y._extension=".ktx2",Y.width=K.mipmaps[0].width,Y.height=K.mipmaps[0].height,Y.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static IsValid(K){if(K.byteLength>=12){const Y=new Uint8Array(K.buffer,K.byteOffset,12);if(171===Y[0]&&75===Y[1]&&84===Y[2]&&88===Y[3]&&32===Y[4]&&50===Y[5]&&48===Y[6]&&187===Y[7]&&13===Y[8]&&10===Y[9]&&26===Y[10]&&10===Y[11])return!0}return!1}}M.URLConfig={jsDecoderModule:"https://cdn.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null},M.DefaultNumWorkers=M.GetDefaultNumWorkers(),M.DefaultDecoderOptions=new class{constructor(){this._isDirty=!0,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=!0,this._ktx2DecoderOptions={}}get isDirty(){return this._isDirty}get useRGBAIfASTCBC7NotAvailableWhenUASTC(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set useRGBAIfASTCBC7NotAvailableWhenUASTC(K){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==K&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=K,this._isDirty=!0)}get useRGBAIfOnlyBC1BC3AvailableWhenUASTC(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set useRGBAIfOnlyBC1BC3AvailableWhenUASTC(K){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==K&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=K,this._isDirty=!0)}get forceRGBA(){return this._forceRGBA}set forceRGBA(K){this._forceRGBA!==K&&(this._forceRGBA=K,this._isDirty=!0)}get forceR8(){return this._forceR8}set forceR8(K){this._forceR8!==K&&(this._forceR8=K,this._isDirty=!0)}get forceRG8(){return this._forceRG8}set forceRG8(K){this._forceRG8!==K&&(this._forceRG8=K,this._isDirty=!0)}get bypassTranscoders(){return this._bypassTranscoders}set bypassTranscoders(K){this._bypassTranscoders!==K&&(this._bypassTranscoders=K,this._isDirty=!0)}_getKTX2DecoderOptions(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=!1;const K={useRGBAIfASTCBC7NotAvailableWhenUASTC:this._useRGBAIfASTCBC7NotAvailableWhenUASTC,forceRGBA:this._forceRGBA,forceR8:this._forceR8,forceRG8:this._forceRG8,bypassTranscoders:this._bypassTranscoders};return this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(K.transcodeFormatDecisionTree={UASTC:{transcodeFormat:[A.BC1_RGB,A.BC3_RGBA],yes:{transcodeFormat:A.RGBA32,engineFormat:32856,roundToMultiple4:!1}}}),this._ktx2DecoderOptions=K,K}};class u{constructor(){this.supportCascades=!1}loadCubeData(K,Y,l,v){if(Array.isArray(K))return;Y._invertVScale=!Y.invertY;const d=Y.getEngine(),A=new U(K,6),c=A.numberOfMipmapLevels>1&&Y.generateMipMaps;d._unpackFlipY(!0),A.uploadLevels(Y,Y.generateMipMaps),Y.width=A.pixelWidth,Y.height=A.pixelHeight,d._setCubeMapTextureParams(Y,c,A.numberOfMipmapLevels-1),Y.isReady=!0,Y.onLoadedObservable.notifyObservers(Y),Y.onLoadedObservable.clear(),v&&v()}loadData(K,Y,l,d){if(U.IsValid(K)){Y._invertVScale=!Y.invertY;const v=new U(K,1),d=function(K){switch(K){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}(v.glInternalFormat);d?(Y.format=d,Y._useSRGBBuffer=Y.getEngine()._getUseSRGBBuffer(!0,Y.generateMipMaps),Y._gammaSpace=!0):Y.format=v.glInternalFormat,l(v.pixelWidth,v.pixelHeight,Y.generateMipMaps,!0,(()=>{v.uploadLevels(Y,Y.generateMipMaps)}),v.isInvalid)}else if(M.IsValid(K)){new M(Y.getEngine())._uploadAsync(K,Y,d).then((()=>{l(Y.width,Y.height,Y.generateMipMaps,!0,(()=>{}),!1)}),(K=>{v.e.Warn(`Failed to load KTX2 texture data: ${K.message}`),l(0,0,!1,!1,(()=>{}),!0)}))}else v.e.Error("texture missing KTX identifier"),l(0,0,!1,!1,(()=>{}),!0)}}},2457:(K,Y,l)=>{l.d(Y,{c:()=>U});class v{constructor(K){this._pendingActions=new Array,this._workerInfos=K.map((K=>({workerPromise:Promise.resolve(K),idle:!0})))}dispose(){for(const K of this._workerInfos)K.workerPromise.then((K=>{K.terminate()}));this._workerInfos.length=0,this._pendingActions.length=0}push(K){this._executeOnIdleWorker(K)||this._pendingActions.push(K)}_executeOnIdleWorker(K){for(const Y of this._workerInfos)if(Y.idle)return this._execute(Y,K),!0;return!1}_execute(K,Y){K.idle=!1,K.workerPromise.then((l=>{Y(l,(()=>{const Y=this._pendingActions.shift();Y?this._execute(K,Y):K.idle=!0}))}))}}class U extends v{constructor(K,Y){let l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:U.DefaultOptions;super([]),this._maxWorkers=K,this._createWorkerAsync=Y,this._options=l}push(K){if(!this._executeOnIdleWorker(K))if(this._workerInfos.length<this._maxWorkers){const Y={workerPromise:this._createWorkerAsync(),idle:!1};this._workerInfos.push(Y),this._execute(Y,K)}else this._pendingActions.push(K)}_execute(K,Y){K.timeoutId&&(clearTimeout(K.timeoutId),delete K.timeoutId),super._execute(K,((l,v)=>{Y(l,(()=>{v(),K.idle&&(K.timeoutId=setTimeout((()=>{K.workerPromise.then((K=>{K.terminate()}));const Y=this._workerInfos.indexOf(K);-1!==Y&&this._workerInfos.splice(Y,1)}),this._options.idleTimeElapsedBeforeRelease))}))}))}}U.DefaultOptions={idleTimeElapsedBeforeRelease:1e3}}}]);