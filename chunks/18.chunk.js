"use strict";(self.fkqm0epoq5=self.fkqm0epoq5||[]).push([[18],{11898:(D,l,G)=>{G(11613).e.prototype.createDepthStencilTexture=function(D,l,G){if(l.isCube){const G=D.width||D;return this._createDepthStencilCubeTexture(G,l)}return this._createDepthStencilTexture(D,l,G)}},11879:(D,l,G)=>{G(11851).ThinEngine.prototype.setAlphaMode=function(D){let l=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._alphaMode!==D){switch(D){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0}l||(this.depthCullingState.depthMask=0===D),this._alphaMode=D}else if(!l){const l=0===D;this.depthCullingState.depthMask!==l&&(this.depthCullingState.depthMask=l)}}},11881:(D,l,G)=>{var V=G(11851);V.ThinEngine.prototype.updateDynamicIndexBuffer=function(D,l){let G;this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(D),G=D.is32Bits?l instanceof Uint32Array?l:new Uint32Array(l):l instanceof Uint16Array?l:new Uint16Array(l),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,G,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()},V.ThinEngine.prototype.updateDynamicVertexBuffer=function(D,l,G,V){this.bindArrayBuffer(D),void 0===G&&(G=0);const N=l.byteLength||l.length;void 0===V||V>=N&&0===G?l instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,G,new Float32Array(l)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,G,l):l instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,G,new Float32Array(l).subarray(0,V/4)):(l=l instanceof ArrayBuffer?new Uint8Array(l,0,V):new Uint8Array(l.buffer,l.byteOffset,V),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,G,l)),this._resetVertexBufferBinding()}},11890:(D,l,G)=>{var V=G(11644),N=G(11546),M=G(11851),b=G(11892),X=G(11870);class t extends b.c{setDepthStencilTexture(D){let l=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(super.setDepthStencilTexture(D,l),!D)return;const G=this._engine,V=this._context,N=D._hardwareTexture;if(N&&D._autoMSAAManagement&&this._MSAAFramebuffer){const l=G._currentFramebuffer;G._bindUnboundFramebuffer(this._MSAAFramebuffer),V.framebufferRenderbuffer(V.FRAMEBUFFER,(0,X.e)(D.format)?V.DEPTH_STENCIL_ATTACHMENT:V.DEPTH_ATTACHMENT,V.RENDERBUFFER,N.getMSAARenderBuffer()),G._bindUnboundFramebuffer(l)}}constructor(D,l,G,V,N){super(D,l,G,V),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._disposeOnlyFramebuffers=!1,this._currentLOD=0,this._context=N}_cloneRenderTargetWrapper(){let D=null;return this._colorTextureArray&&this._depthStencilTextureArray?(D=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),D.texture.isReady=!0):D=super._cloneRenderTargetWrapper(),D}_swapRenderTargetWrapper(D){super._swapRenderTargetWrapper(D),D._framebuffer=this._framebuffer,D._depthStencilBuffer=this._depthStencilBuffer,D._MSAAFramebuffer=this._MSAAFramebuffer,D._colorTextureArray=this._colorTextureArray,D._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}createDepthStencilTexture(){let D=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,l=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],G=arguments.length>2&&void 0!==arguments[2]&&arguments[2],V=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,N=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14,M=arguments.length>5?arguments[5]:void 0;if(this._depthStencilBuffer){const D=this._engine,l=D._currentFramebuffer,G=this._context;D._bindUnboundFramebuffer(this._framebuffer),G.framebufferRenderbuffer(G.FRAMEBUFFER,G.DEPTH_STENCIL_ATTACHMENT,G.RENDERBUFFER,null),G.framebufferRenderbuffer(G.FRAMEBUFFER,G.DEPTH_ATTACHMENT,G.RENDERBUFFER,null),G.framebufferRenderbuffer(G.FRAMEBUFFER,G.STENCIL_ATTACHMENT,G.RENDERBUFFER,null),D._bindUnboundFramebuffer(l),G.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null}return super.createDepthStencilTexture(D,l,G,V,N,M)}shareDepth(D){super.shareDepth(D);const l=this._context,G=this._depthStencilBuffer,V=D._MSAAFramebuffer||D._framebuffer,N=this._engine;D._depthStencilBuffer&&D._depthStencilBuffer!==G&&l.deleteRenderbuffer(D._depthStencilBuffer),D._depthStencilBuffer=G;const M=D._generateStencilBuffer?l.DEPTH_STENCIL_ATTACHMENT:l.DEPTH_ATTACHMENT;N._bindUnboundFramebuffer(V),l.framebufferRenderbuffer(l.FRAMEBUFFER,M,l.RENDERBUFFER,G),N._bindUnboundFramebuffer(null)}_bindTextureRenderTarget(D){let l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,G=arguments.length>2?arguments[2]:void 0,V=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const N=D._hardwareTexture;if(!N)return;const M=this._framebuffer,b=this._engine,X=b._currentFramebuffer;let t;if(b._bindUnboundFramebuffer(M),b.webGLVersion>1){const M=this._context;var R;if(t=M["COLOR_ATTACHMENT"+l],D.is2DArray||D.is3D)G=G??(null===(R=this.layerIndices)||void 0===R?void 0:R[l])??0,M.framebufferTextureLayer(M.FRAMEBUFFER,t,N.underlyingResource,V,G);else if(D.isCube){var n;G=G??(null===(n=this.faceIndices)||void 0===n?void 0:n[l])??0,M.framebufferTexture2D(M.FRAMEBUFFER,t,M.TEXTURE_CUBE_MAP_POSITIVE_X+G,N.underlyingResource,V)}else M.framebufferTexture2D(M.FRAMEBUFFER,t,M.TEXTURE_2D,N.underlyingResource,V)}else{const D=this._context;t=D["COLOR_ATTACHMENT"+l+"_WEBGL"];const M=void 0!==G?D.TEXTURE_CUBE_MAP_POSITIVE_X+G:D.TEXTURE_2D;D.framebufferTexture2D(D.FRAMEBUFFER,t,M,N.underlyingResource,V)}if(D._autoMSAAManagement&&this._MSAAFramebuffer){const D=this._context;b._bindUnboundFramebuffer(this._MSAAFramebuffer),D.framebufferRenderbuffer(D.FRAMEBUFFER,t,D.RENDERBUFFER,N.getMSAARenderBuffer())}b._bindUnboundFramebuffer(X)}setTexture(D){let l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,G=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];super.setTexture(D,l,G),this._bindTextureRenderTarget(D,l)}setLayerAndFaceIndices(D,l){var G;if(super.setLayerAndFaceIndices(D,l),!this.textures||!this.layerIndices||!this.faceIndices)return;const V=(null===(G=this._attachments)||void 0===G?void 0:G.length)??this.textures.length;for(let N=0;N<V;N++){const D=this.textures[N];D&&(D.is2DArray||D.is3D?this._bindTextureRenderTarget(D,N,this.layerIndices[N]):D.isCube?this._bindTextureRenderTarget(D,N,this.faceIndices[N]):this._bindTextureRenderTarget(D,N))}}setLayerAndFaceIndex(){let D=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,l=arguments.length>1?arguments[1]:void 0,G=arguments.length>2?arguments[2]:void 0;if(super.setLayerAndFaceIndex(D,l,G),!this.textures||!this.layerIndices||!this.faceIndices)return;const V=this.textures[D];V.is2DArray||V.is3D?this._bindTextureRenderTarget(this.textures[D],D,this.layerIndices[D]):V.isCube&&this._bindTextureRenderTarget(this.textures[D],D,this.faceIndices[D])}resolveMSAATextures(){const D=this._engine,l=D._currentFramebuffer;D._bindUnboundFramebuffer(this._MSAAFramebuffer),super.resolveMSAATextures(),D._bindUnboundFramebuffer(l)}dispose(){let D=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._disposeOnlyFramebuffers;const l=this._context;D||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(l.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(l.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(l.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(D)}}G(11898);M.ThinEngine.prototype._createHardwareRenderTargetWrapper=function(D,l,G){const V=new t(D,l,G,this,this._gl);return this._renderTargetWrapperCache.push(V),V},M.ThinEngine.prototype.createRenderTargetTexture=function(D,l){const G=this._createHardwareRenderTargetWrapper(!1,!1,D);let V,N,M=!0,b=!1,X=!1,t=1;void 0!==l&&"object"===typeof l&&(M=l.generateDepthBuffer??!0,b=!!l.generateStencilBuffer,X=!!l.noColorAttachment,V=l.colorAttachment,t=l.samples??1,N=l.label);const R=V||(X?null:this._createInternalTexture(D,l,!0,5)),n=D.width||D,g=D.height||D,j=this._currentFramebuffer,e=this._gl,K=e.createFramebuffer();if(this._bindUnboundFramebuffer(K),G._depthStencilBuffer=this._setupFramebufferDepthAttachments(b,M,n,g),!R||R.is2DArray||R.is3D||e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,R._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(j),G.label=N??"RenderTargetWrapper",G._framebuffer=K,G._generateDepthBuffer=M,G._generateStencilBuffer=b,G.setTextures(R),V){if(G._samples=V.samples,V.samples>1){const D=V._hardwareTexture.getMSAARenderBuffer(0);G._MSAAFramebuffer=e.createFramebuffer(),this._bindUnboundFramebuffer(G._MSAAFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,D),this._bindUnboundFramebuffer(null)}}else this.updateRenderTargetTextureSampleCount(G,t);return G},M.ThinEngine.prototype._createDepthStencilTexture=function(D,l,G){const M=this._gl,b=D.layers||0,t=D.depth||0;let R=M.TEXTURE_2D;0!==b?R=M.TEXTURE_2D_ARRAY:0!==t&&(R=M.TEXTURE_3D);const n=new V.b(this,12);if(n.label=l.label,!this._caps.depthTextureExtension)return N.d.Error("Depth texture is not supported by your browser or hardware."),n;const g={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...l};if(this._bindTextureDirectly(R,n,!0),this._setupDepthStencilTexture(n,D,0!==g.comparisonFunction&&g.bilinearFiltering,g.comparisonFunction,g.samples),void 0!==g.depthTextureFormat){if(15!==g.depthTextureFormat&&16!==g.depthTextureFormat&&17!==g.depthTextureFormat&&13!==g.depthTextureFormat&&14!==g.depthTextureFormat&&18!==g.depthTextureFormat)return N.d.Error(`Depth texture ${g.depthTextureFormat} format is not supported.`),n;n.format=g.depthTextureFormat}else n.format=g.generateStencil?13:16;const j=(0,X.e)(n.format),e=this._getWebGLTextureTypeFromDepthTextureFormat(n.format),K=j?M.DEPTH_STENCIL:M.DEPTH_COMPONENT,F=this._getInternalFormatFromDepthTextureFormat(n.format,!0,j);return n.is2DArray?M.texImage3D(R,0,F,n.width,n.height,b,0,K,e,null):n.is3D?M.texImage3D(R,0,F,n.width,n.height,t,0,K,e,null):M.texImage2D(R,0,F,n.width,n.height,0,K,e,null),this._bindTextureDirectly(R,null),this._internalTexturesCache.push(n),G._depthStencilBuffer&&(M.deleteRenderbuffer(G._depthStencilBuffer),G._depthStencilBuffer=null),this._bindUnboundFramebuffer(G._MSAAFramebuffer??G._framebuffer),G._generateStencilBuffer=j,G._depthStencilTextureWithStencil=j,G._depthStencilBuffer=this._setupFramebufferDepthAttachments(G._generateStencilBuffer,G._generateDepthBuffer,G.width,G.height,G.samples,n.format),this._bindUnboundFramebuffer(null),n},M.ThinEngine.prototype.updateRenderTargetTextureSampleCount=function(D,l){var G;if(this.webGLVersion<2||!D)return 1;if(D.samples===l)return l;const V=this._gl;l=Math.min(l,this.getCaps().maxMSAASamples),D._depthStencilBuffer&&(V.deleteRenderbuffer(D._depthStencilBuffer),D._depthStencilBuffer=null),D._MSAAFramebuffer&&(V.deleteFramebuffer(D._MSAAFramebuffer),D._MSAAFramebuffer=null);const N=null===(G=D.texture)||void 0===G?void 0:G._hardwareTexture;if(null===N||void 0===N||N.releaseMSAARenderBuffers(),D.texture&&l>1&&"function"===typeof V.renderbufferStorageMultisample){const G=V.createFramebuffer();if(!G)throw new Error("Unable to create multi sampled framebuffer");D._MSAAFramebuffer=G,this._bindUnboundFramebuffer(D._MSAAFramebuffer);const M=this._createRenderBuffer(D.texture.width,D.texture.height,l,-1,this._getRGBABufferInternalSizedFormat(D.texture.type,D.texture.format,D.texture._useSRGBBuffer),V.COLOR_ATTACHMENT0,!1);if(!M)throw new Error("Unable to create multi sampled framebuffer");null===N||void 0===N||N.addMSAARenderBuffer(M)}this._bindUnboundFramebuffer(D._MSAAFramebuffer??D._framebuffer),D.texture&&(D.texture.samples=l),D._samples=l;const M=D._depthStencilTexture?D._depthStencilTexture.format:void 0;return D._depthStencilBuffer=this._setupFramebufferDepthAttachments(D._generateStencilBuffer,D._generateDepthBuffer,D.width,D.height,l,M),this._bindUnboundFramebuffer(null),l},M.ThinEngine.prototype._setupDepthStencilTexture=function(D,l,G,V){let N=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;const M=l.width??l,b=l.height??l,X=l.layers||0,t=l.depth||0;D.baseWidth=M,D.baseHeight=b,D.width=M,D.height=b,D.is2DArray=X>0,D.depth=X||t,D.isReady=!0,D.samples=N,D.generateMipMaps=!1,D.samplingMode=G?2:1,D.type=0,D._comparisonFunction=V;const R=this._gl,n=this._getTextureTarget(D),g=this._getSamplingParameters(D.samplingMode,!1);R.texParameteri(n,R.TEXTURE_MAG_FILTER,g.mag),R.texParameteri(n,R.TEXTURE_MIN_FILTER,g.min),R.texParameteri(n,R.TEXTURE_WRAP_S,R.CLAMP_TO_EDGE),R.texParameteri(n,R.TEXTURE_WRAP_T,R.CLAMP_TO_EDGE),this.webGLVersion>1&&(0===V?(R.texParameteri(n,R.TEXTURE_COMPARE_FUNC,515),R.texParameteri(n,R.TEXTURE_COMPARE_MODE,R.NONE)):(R.texParameteri(n,R.TEXTURE_COMPARE_FUNC,V),R.texParameteri(n,R.TEXTURE_COMPARE_MODE,R.COMPARE_REF_TO_TEXTURE)))}},11868:(D,l,G)=>{G.d(l,{e:()=>V});class V{get underlyingResource(){return this._webGLTexture}constructor(){let D=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,l=arguments.length>1?arguments[1]:void 0;if(this._MSAARenderBuffers=null,this._context=l,!D&&(D=l.createTexture(),!D))throw new Error("Unable to create webGL texture");this.set(D)}setUsage(){}set(D){this._webGLTexture=D}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(D){this._MSAARenderBuffers||(this._MSAARenderBuffers=[]),this._MSAARenderBuffers.push(D)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(const D of this._MSAARenderBuffers)this._context.deleteRenderbuffer(D);this._MSAARenderBuffers=null}}getMSAARenderBuffer(){var D;let l=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return(null===(D=this._MSAARenderBuffers)||void 0===D?void 0:D[l])??null}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}},11843:(D,l,G)=>{G.d(l,{e:()=>B});var V=G(11644),N=G(11571),M=G(11851),b=G(11554);class X{constructor(){let D=arguments.length>0&&void 0!==arguments[0]?arguments[0]:30;this._enabled=!0,this._rollingFrameTime=new t(D)}sampleFrame(){let D=arguments.length>0&&void 0!==arguments[0]?arguments[0]:b.c.Now;if(this._enabled){if(null!=this._lastFrameTimeMs){const l=D-this._lastFrameTimeMs;this._rollingFrameTime.add(l)}this._lastFrameTimeMs=D}}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){const D=this._rollingFrameTime.history(0);return 0===D?0:1e3/D}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}}class t{constructor(D){this._samples=new Array(D),this.reset()}add(D){let l;if(this.isSaturated()){const D=this._samples[this._pos];l=D-this.average,this.average-=l/(this._sampleCount-1),this._m2-=l*(D-this.average)}else this._sampleCount++;l=D-this.average,this.average+=l/this._sampleCount,this._m2+=l*(D-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=D,this._pos++,this._pos%=this._samples.length}history(D){if(D>=this._sampleCount||D>=this._samples.length)return 0;const l=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(l-D)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(D){const l=this._samples.length;return(D%l+l)%l}}var R=G(11865),n=G(11546),g=G(11868),j=(G(11879),G(11675));function e(D,l,G,V){let N,M=1;1===V?N=new Float32Array(l*G*4):2===V?(N=new Uint16Array(l*G*4),M=15360):N=7===V?new Uint32Array(l*G*4):new Uint8Array(l*G*4);for(let b=0;b<l;b++)for(let V=0;V<G;V++){const G=3*(V*l+b),X=4*(V*l+b);N[X+0]=D[G+0],N[X+1]=D[G+1],N[X+2]=D[G+2],N[X+3]=M}return N}function K(D){return function(l,G,N,M,b,X,t,R){let n=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,g=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;const j=D?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,e=D?10:11,K=new V.b(this,e);K.baseWidth=G,K.baseHeight=N,K.baseDepth=M,K.width=G,K.height=N,K.depth=M,K.format=b,K.type=g,K.generateMipMaps=X,K.samplingMode=R,D?K.is3D=!0:K.is2DArray=!0,this._doNotHandleContextLost||(K._bufferView=l),D?this.updateRawTexture3D(K,l,b,t,n,g):this.updateRawTexture2DArray(K,l,b,t,n,g),this._bindTextureDirectly(j,K,!0);const F=this._getSamplingParameters(R,X);return this._gl.texParameteri(j,this._gl.TEXTURE_MAG_FILTER,F.mag),this._gl.texParameteri(j,this._gl.TEXTURE_MIN_FILTER,F.min),X&&this._gl.generateMipmap(j),this._bindTextureDirectly(j,null),this._internalTexturesCache.push(K),K}}function F(D){return function(l,G,V,N){let M=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,b=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;const X=D?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,t=this._getWebGLTextureType(b),R=this._getInternalFormat(V),n=this._getRGBABufferInternalSizedFormat(b,V);this._bindTextureDirectly(X,l,!0),this._unpackFlipY(void 0===N||!!N),this._doNotHandleContextLost||(l._bufferView=G,l.format=V,l.invertY=N,l._compression=M),l.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),M&&G?this._gl.compressedTexImage3D(X,0,this.getCaps().s3tc[M],l.width,l.height,l.depth,0,G):this._gl.texImage3D(X,0,n,l.width,l.height,l.depth,0,R,t,G),l.generateMipMaps&&this._gl.generateMipmap(X),this._bindTextureDirectly(X,null),l.isReady=!0}}M.ThinEngine.prototype.updateRawTexture=function(D,l,G,V){let N=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,M=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,b=arguments.length>6&&void 0!==arguments[6]&&arguments[6];if(!D)return;const X=this._getRGBABufferInternalSizedFormat(M,G,b),t=this._getInternalFormat(G),R=this._getWebGLTextureType(M);this._bindTextureDirectly(this._gl.TEXTURE_2D,D,!0),this._unpackFlipY(void 0===V||!!V),this._doNotHandleContextLost||(D._bufferView=l,D.format=G,D.type=M,D.invertY=V,D._compression=N),D.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),N&&l?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[N],D.width,D.height,0,l):this._gl.texImage2D(this._gl.TEXTURE_2D,0,X,D.width,D.height,0,t,R,l),D.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),D.isReady=!0},M.ThinEngine.prototype.createRawTexture=function(D,l,G,N,M,b,X){let t=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,R=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,n=arguments.length>10&&void 0!==arguments[10]&&arguments[10];const g=new V.b(this,3);g.baseWidth=l,g.baseHeight=G,g.width=l,g.height=G,g.format=N,g.generateMipMaps=M,g.samplingMode=X,g.invertY=b,g._compression=t,g.type=R,g._useSRGBBuffer=this._getUseSRGBBuffer(n,!M),this._doNotHandleContextLost||(g._bufferView=D),this.updateRawTexture(g,D,N,b,t,R,g._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,g,!0);const j=this._getSamplingParameters(X,M);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,j.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,j.min),M&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(g),g},M.ThinEngine.prototype.createRawCubeTexture=function(D,l,G,N,M,b,X){let t=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;const R=this._gl,g=new V.b(this,8);g.isCube=!0,g.format=G,g.type=N,this._doNotHandleContextLost||(g._bufferViewArray=D);const e=this._getWebGLTextureType(N);let K=this._getInternalFormat(G);K===R.RGB&&(K=R.RGBA),e!==R.FLOAT||this._caps.textureFloatLinearFiltering?e!==this._gl.HALF_FLOAT_OES||this._caps.textureHalfFloatLinearFiltering?e!==R.FLOAT||this._caps.textureFloatRender?e!==R.HALF_FLOAT||this._caps.colorBufferFloat||(M=!1,n.d.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(M=!1,n.d.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(M=!1,X=1,n.d.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(M=!1,X=1,n.d.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively."));const F=l,d=F;g.width=F,g.height=d,g.invertY=b,g._compression=t;if(!this.needPOTTextures||(0,j.f)(g.width)&&(0,j.f)(g.height)||(M=!1),D)this.updateRawCubeTexture(g,D,G,N,b,t);else{const D=this._getRGBABufferInternalSizedFormat(N),l=0;this._bindTextureDirectly(R.TEXTURE_CUBE_MAP,g,!0);for(let G=0;G<6;G++)t?R.compressedTexImage2D(R.TEXTURE_CUBE_MAP_POSITIVE_X+G,l,this.getCaps().s3tc[t],g.width,g.height,0,void 0):R.texImage2D(R.TEXTURE_CUBE_MAP_POSITIVE_X+G,l,D,g.width,g.height,0,K,e,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,g,!0),D&&M&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);const H=this._getSamplingParameters(X,M);return R.texParameteri(R.TEXTURE_CUBE_MAP,R.TEXTURE_MAG_FILTER,H.mag),R.texParameteri(R.TEXTURE_CUBE_MAP,R.TEXTURE_MIN_FILTER,H.min),R.texParameteri(R.TEXTURE_CUBE_MAP,R.TEXTURE_WRAP_S,R.CLAMP_TO_EDGE),R.texParameteri(R.TEXTURE_CUBE_MAP,R.TEXTURE_WRAP_T,R.CLAMP_TO_EDGE),this._bindTextureDirectly(R.TEXTURE_CUBE_MAP,null),g.generateMipMaps=M,g.samplingMode=X,g.isReady=!0,g},M.ThinEngine.prototype.updateRawCubeTexture=function(D,l,G,V,N){let M=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,b=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;D._bufferViewArray=l,D.format=G,D.type=V,D.invertY=N,D._compression=M;const X=this._gl,t=this._getWebGLTextureType(V);let R=this._getInternalFormat(G);const n=this._getRGBABufferInternalSizedFormat(V);let g=!1;R===X.RGB&&(R=X.RGBA,g=!0),this._bindTextureDirectly(X.TEXTURE_CUBE_MAP,D,!0),this._unpackFlipY(void 0===N||!!N),D.width%4!==0&&X.pixelStorei(X.UNPACK_ALIGNMENT,1);for(let j=0;j<6;j++){let G=l[j];M?X.compressedTexImage2D(X.TEXTURE_CUBE_MAP_POSITIVE_X+j,b,this.getCaps().s3tc[M],D.width,D.height,0,G):(g&&(G=e(G,D.width,D.height,V)),X.texImage2D(X.TEXTURE_CUBE_MAP_POSITIVE_X+j,b,n,D.width,D.height,0,R,t,G))}(!this.needPOTTextures||(0,j.f)(D.width)&&(0,j.f)(D.height))&&D.generateMipMaps&&0===b&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),D.isReady=!0},M.ThinEngine.prototype.createRawCubeTextureFromUrl=function(D,l,G,V,N,M,b,X){let t=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,R=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,n=arguments.length>10&&void 0!==arguments[10]?arguments[10]:3,g=arguments.length>11&&void 0!==arguments[11]&&arguments[11];const j=this._gl,K=this.createRawCubeTexture(null,G,V,N,!M,g,n,null);null===l||void 0===l||l.addPendingData(K),K.url=D,K.isReady=!1,this._internalTexturesCache.push(K);const F=D=>{if(!K._hardwareTexture)return;const G=K.width,M=b(D);if(M){if(X){const D=this._getWebGLTextureType(N);let l=this._getInternalFormat(V);const b=this._getRGBABufferInternalSizedFormat(N);let t=!1;l===j.RGB&&(l=j.RGBA,t=!0),this._bindTextureDirectly(j.TEXTURE_CUBE_MAP,K,!0),this._unpackFlipY(!1);const R=X(M);for(let V=0;V<R.length;V++){const M=G>>V;for(let G=0;G<6;G++){let X=R[V][G];t&&(X=e(X,M,M,N)),j.texImage2D(G,V,b,M,M,0,l,D,X)}}this._bindTextureDirectly(j.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(K,M,V,N,g);K.isReady=!0,null===l||void 0===l||l.removePendingData(K),K.onLoadedObservable.notifyObservers(K),K.onLoadedObservable.clear(),t&&t()}};return this._loadFile(D,(D=>{F(D)}),void 0,null===l||void 0===l?void 0:l.offlineProvider,!0,((D,G)=>{null===l||void 0===l||l.removePendingData(K),R&&D&&R(D.status+" "+D.statusText,G)})),K},M.ThinEngine.prototype.createRawTexture2DArray=K(!1),M.ThinEngine.prototype.createRawTexture3D=K(!0),M.ThinEngine.prototype.updateRawTexture2DArray=F(!1),M.ThinEngine.prototype.updateRawTexture3D=F(!0);var d=G(11603);M.ThinEngine.prototype._readTexturePixelsSync=function(D,l,G){let V=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,N=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,M=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,b=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],X=arguments.length>7&&void 0!==arguments[7]&&arguments[7],t=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,R=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;const n=this._gl;if(!n)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){const D=n.createFramebuffer();if(!D)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=D}var g,j;(n.bindFramebuffer(n.FRAMEBUFFER,this._dummyFramebuffer),V>-1)?n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_CUBE_MAP_POSITIVE_X+V,null===(g=D._hardwareTexture)||void 0===g?void 0:g.underlyingResource,N):n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,null===(j=D._hardwareTexture)||void 0===j?void 0:j.underlyingResource,N);let e=void 0!==D.type?this._getWebGLTextureType(D.type):n.UNSIGNED_BYTE;if(X)M||(M=(0,d.n)(D.type,4*l*G));else if(e===n.UNSIGNED_BYTE)M||(M=new Uint8Array(4*l*G)),e=n.UNSIGNED_BYTE;else M||(M=new Float32Array(4*l*G)),e=n.FLOAT;return b&&this.flushFramebuffer(),n.readPixels(t,R,l,G,n.RGBA,e,M),n.bindFramebuffer(n.FRAMEBUFFER,this._currentFramebuffer),M},M.ThinEngine.prototype._readTexturePixels=function(D,l,G){let V=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,N=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,M=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,b=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],X=arguments.length>7&&void 0!==arguments[7]&&arguments[7],t=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,R=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;return Promise.resolve(this._readTexturePixelsSync(D,l,G,V,N,M,b,X,t,R))};G(11881);M.ThinEngine.prototype._createDepthStencilCubeTexture=function(D,l){const G=new V.b(this,12);if(G.isCube=!0,1===this.webGLVersion)return n.d.Error("Depth cube texture is not supported by WebGL 1."),G;const N={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...l},M=this._gl;this._bindTextureDirectly(M.TEXTURE_CUBE_MAP,G,!0),this._setupDepthStencilTexture(G,D,N.bilinearFiltering,N.comparisonFunction);for(let V=0;V<6;V++)N.generateStencil?M.texImage2D(M.TEXTURE_CUBE_MAP_POSITIVE_X+V,0,M.DEPTH24_STENCIL8,D,D,0,M.DEPTH_STENCIL,M.UNSIGNED_INT_24_8,null):M.texImage2D(M.TEXTURE_CUBE_MAP_POSITIVE_X+V,0,M.DEPTH_COMPONENT24,D,D,0,M.DEPTH_COMPONENT,M.UNSIGNED_INT,null);return this._bindTextureDirectly(M.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(G),G},M.ThinEngine.prototype._setCubeMapTextureParams=function(D,l,G){const V=this._gl;V.texParameteri(V.TEXTURE_CUBE_MAP,V.TEXTURE_MAG_FILTER,V.LINEAR),V.texParameteri(V.TEXTURE_CUBE_MAP,V.TEXTURE_MIN_FILTER,l?V.LINEAR_MIPMAP_LINEAR:V.LINEAR),V.texParameteri(V.TEXTURE_CUBE_MAP,V.TEXTURE_WRAP_S,V.CLAMP_TO_EDGE),V.texParameteri(V.TEXTURE_CUBE_MAP,V.TEXTURE_WRAP_T,V.CLAMP_TO_EDGE),D.samplingMode=l?3:2,l&&this.getCaps().textureMaxLevel&&void 0!==G&&G>0&&(V.texParameteri(V.TEXTURE_CUBE_MAP,V.TEXTURE_MAX_LEVEL,G),D._maxLodLevel=G),this._bindTextureDirectly(V.TEXTURE_CUBE_MAP,null)},M.ThinEngine.prototype.createCubeTexture=function(D,l,G,V){let N=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,M=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,b=arguments.length>6?arguments[6]:void 0,X=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,t=arguments.length>8&&void 0!==arguments[8]&&arguments[8],R=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,g=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0,e=arguments.length>11&&void 0!==arguments[11]?arguments[11]:null,K=arguments.length>13&&void 0!==arguments[13]&&arguments[13],F=arguments.length>14&&void 0!==arguments[14]?arguments[14]:null;const d=this._gl;return this.createCubeTextureBase(D,l,G,!!V,N,M,b,X,t,R,g,e,(D=>this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,D,!0)),((D,l)=>{const G=this.needPOTTextures?(0,j.e)(l[0].width,this._caps.maxCubemapTextureSize):l[0].width,M=G,X=[d.TEXTURE_CUBE_MAP_POSITIVE_X,d.TEXTURE_CUBE_MAP_POSITIVE_Y,d.TEXTURE_CUBE_MAP_POSITIVE_Z,d.TEXTURE_CUBE_MAP_NEGATIVE_X,d.TEXTURE_CUBE_MAP_NEGATIVE_Y,d.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,D,!0),this._unpackFlipY(!1);const t=b?this._getInternalFormat(b,D._useSRGBBuffer):D._useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:d.RGBA;let R=b?this._getInternalFormat(b):d.RGBA;D._useSRGBBuffer&&1===this.webGLVersion&&(R=t);for(let V=0;V<X.length;V++)if(l[V].width!==G||l[V].height!==M){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext)return void n.d.Warn("Cannot create canvas to resize texture.");this._workingCanvas.width=G,this._workingCanvas.height=M,this._workingContext.drawImage(l[V],0,0,l[V].width,l[V].height,0,0,G,M),d.texImage2D(X[V],0,t,R,d.UNSIGNED_BYTE,this._workingCanvas)}else d.texImage2D(X[V],0,t,R,d.UNSIGNED_BYTE,l[V]);V||d.generateMipmap(d.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(D,!V),D.width=G,D.height=M,D.isReady=!0,b&&(D.format=b),D.onLoadedObservable.notifyObservers(D),D.onLoadedObservable.clear(),N&&N()}),!!K,F)},M.ThinEngine.prototype.generateMipMapsForCubemap=function(D){let l=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(D.generateMipMaps){const G=this._gl;this._bindTextureDirectly(G.TEXTURE_CUBE_MAP,D,!0),G.generateMipmap(G.TEXTURE_CUBE_MAP),l&&this._bindTextureDirectly(G.TEXTURE_CUBE_MAP,null)}};G(11890);M.ThinEngine.prototype.setDepthStencilTexture=function(D,l,G,V){void 0!==D&&(l&&(this._boundUniforms[D]=l),G&&G.depthStencilTexture?this._setTexture(D,G,!1,!0,V):this._setTexture(D,null,void 0,void 0,V))},M.ThinEngine.prototype.createRenderTargetCubeTexture=function(D,l){const G=this._createHardwareRenderTargetWrapper(!1,!0,D),N={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,...l};N.generateStencilBuffer=N.generateDepthBuffer&&N.generateStencilBuffer,(1!==N.type||this._caps.textureFloatLinearFiltering)&&(2!==N.type||this._caps.textureHalfFloatLinearFiltering)||(N.samplingMode=1);const M=this._gl,b=new V.b(this,5);this._bindTextureDirectly(M.TEXTURE_CUBE_MAP,b,!0);const X=this._getSamplingParameters(N.samplingMode,N.generateMipMaps);1!==N.type||this._caps.textureFloat||(N.type=0,n.d.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),M.texParameteri(M.TEXTURE_CUBE_MAP,M.TEXTURE_MAG_FILTER,X.mag),M.texParameteri(M.TEXTURE_CUBE_MAP,M.TEXTURE_MIN_FILTER,X.min),M.texParameteri(M.TEXTURE_CUBE_MAP,M.TEXTURE_WRAP_S,M.CLAMP_TO_EDGE),M.texParameteri(M.TEXTURE_CUBE_MAP,M.TEXTURE_WRAP_T,M.CLAMP_TO_EDGE);for(let V=0;V<6;V++)M.texImage2D(M.TEXTURE_CUBE_MAP_POSITIVE_X+V,0,this._getRGBABufferInternalSizedFormat(N.type,N.format),D,D,0,this._getInternalFormat(N.format),this._getWebGLTextureType(N.type),null);const t=M.createFramebuffer();return this._bindUnboundFramebuffer(t),G._depthStencilBuffer=this._setupFramebufferDepthAttachments(N.generateStencilBuffer,N.generateDepthBuffer,D,D),N.generateMipMaps&&M.generateMipmap(M.TEXTURE_CUBE_MAP),this._bindTextureDirectly(M.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),G._framebuffer=t,G._generateDepthBuffer=N.generateDepthBuffer,G._generateStencilBuffer=N.generateStencilBuffer,b.width=D,b.height=D,b.isReady=!0,b.isCube=!0,b.samples=1,b.generateMipMaps=N.generateMipMaps,b.samplingMode=N.samplingMode,b.type=N.type,b.format=N.format,this._internalTexturesCache.push(b),G.setTextures(b),G};var H=G(11904),h=G(11732);M.ThinEngine.prototype.createPrefilteredCubeTexture=function(D,l,N,M){let b=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,X=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,t=arguments.length>6?arguments[6]:void 0,R=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,g=!(arguments.length>8&&void 0!==arguments[8])||arguments[8];return this.createCubeTexture(D,l,null,!1,(async D=>{if(!D)return void(b&&b(null));const X=D.texture;if(g?D.info.sphericalPolynomial&&(X._sphericalPolynomial=D.info.sphericalPolynomial):X._sphericalPolynomial=new H.h,X._source=9,this.getCaps().textureLOD)return void(b&&b(X));const t=this._gl,R=D.width;if(!R)return;const{DDSTools:j}=await G.e(29).then(G.bind(G,14124)),e=[];for(let G=0;G<3;G++){const b=1-G/2,g=M,K=Math.log2(R)*N+M,F=g+(K-g)*b,d=Math.round(Math.min(Math.max(F,0),K)),H=new V.b(this,2);if(H.type=X.type,H.format=X.format,H.width=Math.pow(2,Math.max(Math.log2(R)-d,0)),H.height=H.width,H.isCube=!0,H._cachedWrapU=0,H._cachedWrapV=0,this._bindTextureDirectly(t.TEXTURE_CUBE_MAP,H,!0),H.samplingMode=2,t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),D.isDDS){const l=D.info,G=D.data;this._unpackFlipY(l.isCompressed),j.UploadDDSLevels(this,H,G,l,!0,6,d)}else n.d.Warn("DDS is the only prefiltered cube map supported so far.");this._bindTextureDirectly(t.TEXTURE_CUBE_MAP,null);const x=new h.c(l);x._isCube=!0,x._texture=H,H.isReady=!0,e.push(x)}X._lodTextureHigh=e[2],X._lodTextureMid=e[1],X._lodTextureLow=e[0],b&&b(X)}),X,t,R,g,N,M)},M.ThinEngine.prototype.createUniformBuffer=function(D,l){const G=this._gl.createBuffer();if(!G)throw new Error("Unable to create uniform buffer");const V=new R.d(G);return this.bindUniformBuffer(V),D instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,D,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(D),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),V.references=1,V},M.ThinEngine.prototype.createDynamicUniformBuffer=function(D,l){const G=this._gl.createBuffer();if(!G)throw new Error("Unable to create dynamic uniform buffer");const V=new R.d(G);return this.bindUniformBuffer(V),D instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,D,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(D),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),V.references=1,V},M.ThinEngine.prototype.updateUniformBuffer=function(D,l,G,V){this.bindUniformBuffer(D),void 0===G&&(G=0),void 0===V?l instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,G,l):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,G,new Float32Array(l)):l instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,l.subarray(G,G+V)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(l).subarray(G,G+V)),this.bindUniformBuffer(null)},M.ThinEngine.prototype.bindUniformBuffer=function(D){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,D?D.underlyingResource:null)},M.ThinEngine.prototype.bindUniformBufferBase=function(D,l,G){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,l,D?D.underlyingResource:null)},M.ThinEngine.prototype.bindUniformBlock=function(D,l,G){const V=D.program,N=this._gl.getUniformBlockIndex(V,l);4294967295!==N&&this._gl.uniformBlockBinding(V,N,G)};var x=G(11538),r=G(11613);r.e.prototype.displayLoadingUI=function(){if(!(0,x.k)())return;const D=this.loadingScreen;D&&D.displayLoadingUI()},r.e.prototype.hideLoadingUI=function(){if(!(0,x.k)())return;const D=this._loadingScreen;D&&D.hideLoadingUI()},Object.defineProperty(r.e.prototype,"loadingScreen",{get:function(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=r.e.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen},set:function(D){this._loadingScreen=D},enumerable:!0,configurable:!0}),Object.defineProperty(r.e.prototype,"loadingUIText",{set:function(D){this.loadingScreen.loadingUIText=D},enumerable:!0,configurable:!0}),Object.defineProperty(r.e.prototype,"loadingUIBackgroundColor",{set:function(D){this.loadingScreen.loadingUIBackgroundColor=D},enumerable:!0,configurable:!0}),r.e.prototype.getInputElement=function(){return this._renderingCanvas},r.e.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null},r.e.prototype.getInputElementClientRect=function(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null},r.e.prototype.getAspectRatio=function(D){let l=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const G=D.viewport;return this.getRenderWidth(l)*G.width/(this.getRenderHeight(l)*G.height)},r.e.prototype.getScreenAspectRatio=function(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)},r.e.prototype._verifyPointerLock=function(){var D;null===(D=this._onPointerLockChange)||void 0===D||D.call(this)},r.e.prototype.setAlphaEquation=function(D){if(this._alphaEquation!==D){switch(D){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774)}this._alphaEquation=D}},r.e.prototype.getInputElement=function(){return this._renderingCanvas},r.e.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc},r.e.prototype.setDepthFunction=function(D){this._depthCullingState.depthFunc=D},r.e.prototype.setDepthFunctionToGreater=function(){this.setDepthFunction(516)},r.e.prototype.setDepthFunctionToGreaterOrEqual=function(){this.setDepthFunction(518)},r.e.prototype.setDepthFunctionToLess=function(){this.setDepthFunction(513)},r.e.prototype.setDepthFunctionToLessOrEqual=function(){this.setDepthFunction(515)},r.e.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask},r.e.prototype.setDepthWrite=function(D){this._depthCullingState.depthMask=D},r.e.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest},r.e.prototype.setStencilBuffer=function(D){this._stencilState.stencilTest=D},r.e.prototype.getStencilMask=function(){return this._stencilState.stencilMask},r.e.prototype.setStencilMask=function(D){this._stencilState.stencilMask=D},r.e.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc},r.e.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef},r.e.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask},r.e.prototype.setStencilFunction=function(D){this._stencilState.stencilFunc=D},r.e.prototype.setStencilFunctionReference=function(D){this._stencilState.stencilFuncRef=D},r.e.prototype.setStencilFunctionMask=function(D){this._stencilState.stencilFuncMask=D},r.e.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail},r.e.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail},r.e.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass},r.e.prototype.setStencilOperationFail=function(D){this._stencilState.stencilOpStencilFail=D},r.e.prototype.setStencilOperationDepthFail=function(D){this._stencilState.stencilOpDepthFail=D},r.e.prototype.setStencilOperationPass=function(D){this._stencilState.stencilOpStencilDepthPass=D},r.e.prototype.cacheStencilState=function(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()},r.e.prototype.restoreStencilState=function(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)},r.e.prototype.setAlphaConstants=function(D,l,G,V){this._alphaState.setAlphaBlendConstants(D,l,G,V)},r.e.prototype.getAlphaMode=function(){return this._alphaMode},r.e.prototype.getAlphaEquation=function(){return this._alphaEquation},r.e.prototype.getRenderPassNames=function(){return this._renderPassNames},r.e.prototype.getCurrentRenderPassName=function(){return this._renderPassNames[this.currentRenderPassId]},r.e.prototype.createRenderPassId=function(D){const l=++r.e._RenderPassIdCounter;return this._renderPassNames[l]=D??"NONAME",l},r.e.prototype.releaseRenderPassId=function(D){this._renderPassNames[D]=void 0;for(let l=0;l<this.scenes.length;++l){const G=this.scenes[l];for(let l=0;l<G.meshes.length;++l){const V=G.meshes[l];if(V.nb)for(let l=0;l<V.nb.length;++l){V.nb[l]._removeDrawWrapper(D)}}}};G(11898);function o(D){if(D.requestPointerLock){const l=D.requestPointerLock();l instanceof Promise?l.then((()=>{D.focus()})).catch((()=>{})):D.focus()}}var L=G(11934),u=G(11609);class B extends M.ThinEngine{static get NpmPackage(){return r.e.NpmPackage}static get Version(){return r.e.Version}static get Instances(){return N.d.Instances}static get LastCreatedEngine(){return N.d.LastCreatedEngine}static get LastCreatedScene(){return N.d.LastCreatedScene}static DefaultLoadingScreenFactory(D){return r.e.DefaultLoadingScreenFactory(D)}get _supportsHardwareTextureRescaling(){return!!B._RescalePostProcessFactory}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}get performanceMonitor(){return this._performanceMonitor}constructor(D,l,G){super(D,l,G,arguments.length>3&&void 0!==arguments[3]&&arguments[3]),this.customAnimationFrameRequester=null,this._performanceMonitor=new X,this._drawCalls=new L.c,D&&(this._features.supportRenderPasses=!0,G=this._creationOptions)}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(D){super._sharedInit(D),function(D,l,G){D._onCanvasFocus=()=>{D.onCanvasFocusObservable.notifyObservers(D)},D._onCanvasBlur=()=>{D.onCanvasBlurObservable.notifyObservers(D)},D._onCanvasContextMenu=l=>{D.disableContextMenu&&l.preventDefault()},l.addEventListener("focus",D._onCanvasFocus),l.addEventListener("blur",D._onCanvasBlur),l.addEventListener("contextmenu",D._onCanvasContextMenu),D._onBlur=()=>{D.disablePerformanceMonitorInBackground&&D.performanceMonitor.disable(),D._windowIsBackground=!0},D._onFocus=()=>{D.disablePerformanceMonitorInBackground&&D.performanceMonitor.enable(),D._windowIsBackground=!1},D._onCanvasPointerOut=G=>{document.elementFromPoint(G.clientX,G.clientY)!==l&&D.onCanvasPointerOutObservable.notifyObservers(G)};const V=D.getHostWindow();V&&"function"===typeof V.addEventListener&&(V.addEventListener("blur",D._onBlur),V.addEventListener("focus",D._onFocus)),l.addEventListener("pointerout",D._onCanvasPointerOut),G.doNotHandleTouchAction||function(D){D&&D.setAttribute&&(D.setAttribute("touch-action","none"),D.style.touchAction="none",D.style.webkitTapHighlightColor="transparent")}(l),!r.e.audioEngine&&G.audioEngine&&r.e.AudioEngineFactory&&(r.e.audioEngine=r.e.AudioEngineFactory(D.getRenderingCanvas(),D.getAudioContext(),D.getAudioDestination())),(0,x.f)()&&(D._onFullscreenChange=()=>{D.isFullscreen=!!document.fullscreenElement,D.isFullscreen&&D._pointerLockRequested&&l&&o(l)},document.addEventListener("fullscreenchange",D._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",D._onFullscreenChange,!1),D._onPointerLockChange=()=>{D.isPointerLock=document.pointerLockElement===l},document.addEventListener("pointerlockchange",D._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",D._onPointerLockChange,!1)),D.enableOfflineSupport=void 0!==r.e.OfflineProviderFactory,D._deterministicLockstep=!!G.deterministicLockstep,D._lockstepMaxSteps=G.lockstepMaxSteps||0,D._timeStep=G.timeStep||1/60}(this,D,this._creationOptions)}resizeImageBitmap(D,l,G){return function(D,l,G,V){const N=D.createCanvas(G,V).getContext("2d");if(!N)throw new Error("Unable to get 2d context for resizeImageBitmap");return N.drawImage(l,0,0),N.getImageData(0,0,G,V).data}(this,D,l,G)}async _createImageBitmapFromSource(D,l){return await async function(D,l,G){return await new Promise(((V,N)=>{const M=new Image;M.onload=()=>{M.decode().then((()=>{D.createImageBitmap(M,G).then((D=>{V(D)}))}))},M.onerror=()=>{N(`Error loading image ${M.src}`)},M.src=l}))}(this,D,l)}switchFullscreen(D){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(D)}enterFullscreen(D){this.isFullscreen||(this._pointerLockRequested=D,this._renderingCanvas&&function(D){const l=D.requestFullscreen||D.webkitRequestFullscreen;l&&l.call(D)}(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&function(){const D=document;document.exitFullscreen?document.exitFullscreen():D.webkitCancelFullScreen&&D.webkitCancelFullScreen()}()}setDitheringState(D){D?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(D){D?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}setDirectViewport(D,l,G,V){const N=this._cachedViewport;return this._cachedViewport=null,this._viewport(D,l,G,V),N}scissorClear(D,l,G,V,N){this.enableScissor(D,l,G,V),this.clear(N,!0,!0,!0),this.disableScissor()}enableScissor(D,l,G,V){const N=this._gl;N.enable(N.SCISSOR_TEST),N.scissor(D,l,G,V)}disableScissor(){const D=this._gl;D.disable(D.SCISSOR_TEST)}async _loadFileAsync(D,l,G){return await new Promise(((V,N)=>{this._loadFile(D,(D=>{V(D)}),void 0,l,G,((D,l)=>{N(l)}))}))}getVertexShaderSource(D){const l=this._gl.getAttachedShaders(D);return l?this._gl.getShaderSource(l[0]):null}getFragmentShaderSource(D){const l=this._gl.getAttachedShaders(D);return l?this._gl.getShaderSource(l[1]):null}set framebufferDimensionsObject(D){this._framebufferDimensionsObject=D,this._framebufferDimensionsObject&&this.onResizeObservable.notifyObservers(this)}_rebuildBuffers(){for(const D of this.scenes)D.resetCachedMaterial(),D._rebuildGeometries();for(const D of this._virtualScenes)D.resetCachedMaterial(),D._rebuildGeometries();super._rebuildBuffers()}getFontOffset(D){return function(D){const l=document.createElement("span");l.textContent="Hg",l.style.font=D;const G=document.createElement("div");G.style.display="inline-block",G.style.width="1px",G.style.height="0px",G.style.verticalAlign="bottom";const V=document.createElement("div");V.style.whiteSpace="nowrap",V.appendChild(l),V.appendChild(G),document.body.appendChild(V);let N=0,M=0;try{M=G.getBoundingClientRect().top-l.getBoundingClientRect().top,G.style.verticalAlign="baseline",N=G.getBoundingClientRect().top-l.getBoundingClientRect().top}finally{document.body.removeChild(V)}return{ascent:N,height:M,descent:M-N}}(D)}_cancelFrame(){if(this.customAnimationFrameRequester){if(0!==this._frameHandler){this._frameHandler=0;const{cancelAnimationFrame:D}=this.customAnimationFrameRequester;D&&D(this.customAnimationFrameRequester.t)}}else super._cancelFrame()}_renderLoop(D){this._processFrame(D),this._activeRenderLoops.length>0&&0===this._frameHandler&&(this.customAnimationFrameRequester?(this.customAnimationFrameRequester.t=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.t):this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()))}enterPointerlock(){this._renderingCanvas&&o(this._renderingCanvas)}exitPointerlock(){document.exitPointerLock&&document.exitPointerLock()}lb(){this._measureFps(),super.lb()}_deletePipelineContext(D){const l=D;l&&l.program&&l.transformFeedback&&(this.deleteTransformFeedback(l.transformFeedback),l.transformFeedback=null),super._deletePipelineContext(D)}createShaderProgram(D,l,G,V,N){let M=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;N=N||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);const b=super.createShaderProgram(D,l,G,V,N,M);return this.onAfterShaderCompilationObservable.notifyObservers(this),b}_createShaderProgram(D,l,G,V){let N=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const M=V.createProgram();if(D.program=M,!M)throw new Error("Unable to create program");if(V.attachShader(M,l),V.attachShader(M,G),this.webGLVersion>1&&N){const l=this.createTransformFeedback();this.bindTransformFeedback(l),this.setTranformFeedbackVaryings(M,N),D.transformFeedback=l}return V.linkProgram(M),this.webGLVersion>1&&N&&this.bindTransformFeedback(null),D.context=V,D.vertexShader=l,D.fragmentShader=G,D.isParallelCompiled||this._finalizePipelineContext(D),M}_releaseTexture(D){super._releaseTexture(D)}_releaseRenderTargetWrapper(D){super._releaseRenderTargetWrapper(D);for(const l of this.scenes){for(const G of l.postProcesses)G._outputTexture===D&&(G._outputTexture=null);for(const G of l.cameras)for(const l of G._postProcesses)l&&l._outputTexture===D&&(l._outputTexture=null)}}_rescaleTexture(D,l,G,V,N){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);const M=this.createRenderTargetTexture({width:l.width,height:l.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});if(!this._rescalePostProcess&&B._RescalePostProcessFactory&&(this._rescalePostProcess=B._RescalePostProcessFactory(this)),this._rescalePostProcess){this._rescalePostProcess.externalTextureSamplerBinding=!0;const b=()=>{this._rescalePostProcess.onApply=function(l){l._bindTexture("textureSampler",D)};let b=G;b||(b=this.scenes[this.scenes.length-1]),b.postProcessManager.directRender([this._rescalePostProcess],M,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,l,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,V,0,0,l.width,l.height,0),this.unBindFramebuffer(M),M.dispose(),N&&N()},X=this._rescalePostProcess.getEffect();X?X.executeWhenCompiled(b):this._rescalePostProcess.onEffectCreatedObservable.addOnce((D=>{D.executeWhenCompiled(b)}))}}wrapWebGLTexture(D){let l=arguments.length>1&&void 0!==arguments[1]&&arguments[1],G=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3,N=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,M=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;const b=new g.e(D,this._gl),X=new V.b(this,0,!0);return X._hardwareTexture=b,X.baseWidth=N,X.baseHeight=M,X.width=N,X.height=M,X.isReady=!0,X.useMipMaps=l,this.updateTextureSamplingMode(G,X),X}_uploadImageToTexture(D,l){let G=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,V=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const N=this._gl,M=this._getWebGLTextureType(D.type),b=this._getInternalFormat(D.format),X=this._getRGBABufferInternalSizedFormat(D.type,b),t=D.isCube?N.TEXTURE_CUBE_MAP:N.TEXTURE_2D;this._bindTextureDirectly(t,D,!0),this._unpackFlipY(D.invertY);let R=N.TEXTURE_2D;D.isCube&&(R=N.TEXTURE_CUBE_MAP_POSITIVE_X+G),N.texImage2D(R,V,X,b,M,l),this._bindTextureDirectly(t,null,!0)}updateTextureComparisonFunction(D,l){if(1===this.webGLVersion)return void n.d.Error("WebGL 1 does not support texture comparison.");const G=this._gl;D.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,D,!0),0===l?(G.texParameteri(G.TEXTURE_CUBE_MAP,G.TEXTURE_COMPARE_FUNC,515),G.texParameteri(G.TEXTURE_CUBE_MAP,G.TEXTURE_COMPARE_MODE,G.NONE)):(G.texParameteri(G.TEXTURE_CUBE_MAP,G.TEXTURE_COMPARE_FUNC,l),G.texParameteri(G.TEXTURE_CUBE_MAP,G.TEXTURE_COMPARE_MODE,G.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,D,!0),0===l?(G.texParameteri(G.TEXTURE_2D,G.TEXTURE_COMPARE_FUNC,515),G.texParameteri(G.TEXTURE_2D,G.TEXTURE_COMPARE_MODE,G.NONE)):(G.texParameteri(G.TEXTURE_2D,G.TEXTURE_COMPARE_FUNC,l),G.texParameteri(G.TEXTURE_2D,G.TEXTURE_COMPARE_MODE,G.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),D._comparisonFunction=l}createInstancesBuffer(D){const l=this._gl.createBuffer();if(!l)throw new Error("Unable to create instance buffer");const G=new R.d(l);return G.nG=D,this.bindArrayBuffer(G),this._gl.bufferData(this._gl.ARRAY_BUFFER,D,this._gl.DYNAMIC_DRAW),G.references=1,G}deleteInstancesBuffer(D){this._gl.deleteBuffer(D)}async _clientWaitAsync(D){let l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,G=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;const V=this._gl;return await new Promise(((N,M)=>{(0,u.g)((()=>{const G=V.clientWaitSync(D,l,0);if(G==V.WAIT_FAILED)throw new Error("clientWaitSync failed");return G!=V.TIMEOUT_EXPIRED}),N,M,G)}))}_readPixelsAsync(D,l,G,V,N,M,b){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");const X=this._gl,t=X.createBuffer();X.bindBuffer(X.PIXEL_PACK_BUFFER,t),X.bufferData(X.PIXEL_PACK_BUFFER,b.byteLength,X.STREAM_READ),X.readPixels(D,l,G,V,N,M,0),X.bindBuffer(X.PIXEL_PACK_BUFFER,null);const R=X.fenceSync(X.SYNC_GPU_COMMANDS_COMPLETE,0);return R?(X.flush(),this._clientWaitAsync(R,0,10).then((()=>(X.deleteSync(R),X.bindBuffer(X.PIXEL_PACK_BUFFER,t),X.getBufferSubData(X.PIXEL_PACK_BUFFER,0,b),X.bindBuffer(X.PIXEL_PACK_BUFFER,null),X.deleteBuffer(t),b)))):null}dispose(){this.hideLoadingUI(),this._rescalePostProcess&&this._rescalePostProcess.dispose(),function(D,l){1===N.d.Instances.length&&r.e.audioEngine&&(r.e.audioEngine.dispose(),r.e.audioEngine=null);const G=D.getHostWindow();G&&"function"===typeof G.removeEventListener&&(G.removeEventListener("blur",D._onBlur),G.removeEventListener("focus",D._onFocus)),l&&(l.removeEventListener("focus",D._onCanvasFocus),l.removeEventListener("blur",D._onCanvasBlur),l.removeEventListener("pointerout",D._onCanvasPointerOut),l.removeEventListener("contextmenu",D._onCanvasContextMenu)),(0,x.f)()&&(document.removeEventListener("fullscreenchange",D._onFullscreenChange),document.removeEventListener("mozfullscreenchange",D._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",D._onFullscreenChange),document.removeEventListener("msfullscreenchange",D._onFullscreenChange),document.removeEventListener("pointerlockchange",D._onPointerLockChange),document.removeEventListener("mspointerlockchange",D._onPointerLockChange),document.removeEventListener("mozpointerlockchange",D._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",D._onPointerLockChange))}(this,this._renderingCanvas),super.dispose()}}B.ALPHA_DISABLE=0,B.ALPHA_ADD=1,B.ALPHA_COMBINE=2,B.ALPHA_SUBTRACT=3,B.ALPHA_MULTIPLY=4,B.ALPHA_MAXIMIZED=5,B.ALPHA_ONEONE=6,B.ALPHA_PREMULTIPLIED=7,B.ALPHA_PREMULTIPLIED_PORTERDUFF=8,B.ALPHA_INTERPOLATE=9,B.ALPHA_SCREENMODE=10,B.DELAYLOADSTATE_NONE=0,B.DELAYLOADSTATE_LOADED=1,B.DELAYLOADSTATE_LOADING=2,B.DELAYLOADSTATE_NOTLOADED=4,B.NEVER=512,B.ALWAYS=519,B.LESS=513,B.EQUAL=514,B.LEQUAL=515,B.GREATER=516,B.GEQUAL=518,B.NOTEQUAL=517,B.KEEP=7680,B.REPLACE=7681,B.INCR=7682,B.DECR=7683,B.INVERT=5386,B.INCR_WRAP=34055,B.DECR_WRAP=34056,B.TEXTURE_CLAMP_ADDRESSMODE=0,B.TEXTURE_WRAP_ADDRESSMODE=1,B.TEXTURE_MIRROR_ADDRESSMODE=2,B.TEXTUREFORMAT_ALPHA=0,B.TEXTUREFORMAT_LUMINANCE=1,B.TEXTUREFORMAT_LUMINANCE_ALPHA=2,B.TEXTUREFORMAT_RGB=4,B.TEXTUREFORMAT_RGBA=5,B.TEXTUREFORMAT_RED=6,B.TEXTUREFORMAT_R=6,B.TEXTUREFORMAT_R16_UNORM=33322,B.TEXTUREFORMAT_RG16_UNORM=33324,B.TEXTUREFORMAT_RGB16_UNORM=32852,B.TEXTUREFORMAT_RGBA16_UNORM=32859,B.TEXTUREFORMAT_R16_SNORM=36760,B.TEXTUREFORMAT_RG16_SNORM=36761,B.TEXTUREFORMAT_RGB16_SNORM=36762,B.TEXTUREFORMAT_RGBA16_SNORM=36763,B.TEXTUREFORMAT_RG=7,B.TEXTUREFORMAT_RED_INTEGER=8,B.TEXTUREFORMAT_R_INTEGER=8,B.TEXTUREFORMAT_RG_INTEGER=9,B.TEXTUREFORMAT_RGB_INTEGER=10,B.TEXTUREFORMAT_RGBA_INTEGER=11,B.TEXTURETYPE_UNSIGNED_BYTE=0,B.TEXTURETYPE_UNSIGNED_INT=0,B.TEXTURETYPE_FLOAT=1,B.TEXTURETYPE_HALF_FLOAT=2,B.TEXTURETYPE_BYTE=3,B.TEXTURETYPE_SHORT=4,B.TEXTURETYPE_UNSIGNED_SHORT=5,B.TEXTURETYPE_INT=6,B.TEXTURETYPE_UNSIGNED_INTEGER=7,B.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,B.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,B.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,B.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,B.TEXTURETYPE_UNSIGNED_INT_24_8=12,B.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,B.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,B.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,B.TEXTURE_NEAREST_SAMPLINGMODE=1,B.TEXTURE_BILINEAR_SAMPLINGMODE=2,B.TEXTURE_TRILINEAR_SAMPLINGMODE=3,B.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,B.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,B.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,B.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,B.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,B.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,B.TEXTURE_NEAREST_LINEAR=7,B.TEXTURE_NEAREST_NEAREST=1,B.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,B.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,B.TEXTURE_LINEAR_LINEAR=2,B.TEXTURE_LINEAR_NEAREST=12,B.TEXTURE_EXPLICIT_MODE=0,B.TEXTURE_SPHERICAL_MODE=1,B.TEXTURE_PLANAR_MODE=2,B.TEXTURE_CUBIC_MODE=3,B.TEXTURE_PROJECTION_MODE=4,B.TEXTURE_SKYBOX_MODE=5,B.TEXTURE_INVCUBIC_MODE=6,B.TEXTURE_EQUIRECTANGULAR_MODE=7,B.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,B.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,B.SCALEMODE_FLOOR=1,B.SCALEMODE_NEAREST=2,B.SCALEMODE_CEILING=3},11892:(D,l,G)=>{G.d(l,{c:()=>N});var V=G(11870);class N{get depthStencilTexture(){return this._depthStencilTexture}setDepthStencilTexture(D){(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&this._depthStencilTexture&&this._depthStencilTexture.dispose(),this._depthStencilTexture=D,this._generateDepthBuffer=this._generateStencilBuffer=this._depthStencilTextureWithStencil=!1,D&&(this._generateDepthBuffer=!0,this._generateStencilBuffer=this._depthStencilTextureWithStencil=(0,V.e)(D.format))}get depthStencilTextureWithStencil(){return this._depthStencilTextureWithStencil}get isCube(){return this._isCube}get isMulti(){return this._isMulti}get is2DArray(){return this.layers>0}get is3D(){return this.depth>0}get size(){return this.width}get width(){return this._size.width??this._size}get height(){return this._size.height??this._size}get layers(){return this._size.layers||0}get depth(){return this._size.depth||0}get texture(){var D;return(null===(D=this._textures)||void 0===D?void 0:D[0])??null}get textures(){return this._textures}get faceIndices(){return this._faceIndices}get layerIndices(){return this._layerIndices}getBaseArrayLayer(D){var l,G;if(!this._textures)return-1;const V=this._textures[D],N=(null===(l=this._layerIndices)||void 0===l?void 0:l[D])??0,M=(null===(G=this._faceIndices)||void 0===G?void 0:G[D])??0;return V.isCube?6*N+M:V.is3D?0:N}get samples(){return this._samples}setSamples(D){let l=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],G=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this.samples===D&&!G)return D;const V=this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,D,l):this._engine.updateRenderTargetTextureSampleCount(this,D);return this._samples=D,V}resolveMSAATextures(){this.isMulti?this._engine.resolveMultiFramebuffer(this):this._engine.resolveFramebuffer(this)}generateMipMaps(){this._engine._currentRenderTarget===this&&this._engine.unBindFramebuffer(this,!0),this.isMulti?this._engine.generateMipMapsMultiFramebuffer(this):this._engine.generateMipMapsFramebuffer(this)}constructor(D,l,G,V,N){this._textures=null,this._faceIndices=null,this._layerIndices=null,this._samples=1,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this.disableAutomaticMSAAResolve=!1,this.resolveMSAAColors=!0,this.resolveMSAADepth=!1,this.resolveMSAAStencil=!1,this._isMulti=D,this._isCube=l,this._size=G,this._engine=V,this._depthStencilTexture=null,this.label=N}setTextures(D){Array.isArray(D)?this._textures=D:this._textures=D?[D]:null}setTexture(D){let l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,G=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._textures||(this._textures=[]),this._textures[l]!==D&&(this._textures[l]&&G&&this._textures[l].dispose(),this._textures[l]=D)}setLayerAndFaceIndices(D,l){this._layerIndices=D,this._faceIndices=l}setLayerAndFaceIndex(){let D=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,l=arguments.length>1?arguments[1]:void 0,G=arguments.length>2?arguments[2]:void 0;this._layerIndices||(this._layerIndices=[]),this._faceIndices||(this._faceIndices=[]),void 0!==l&&l>=0&&(this._layerIndices[D]=l),void 0!==G&&G>=0&&(this._faceIndices[D]=G)}createDepthStencilTexture(){var D;let l=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,G=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],V=arguments.length>2&&void 0!==arguments[2]&&arguments[2],N=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,M=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14,b=arguments.length>5?arguments[5]:void 0;return null===(D=this._depthStencilTexture)||void 0===D||D.dispose(),this._depthStencilTextureWithStencil=V,this._depthStencilTextureLabel=b,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:G,comparisonFunction:l,generateStencil:V,isCube:this._isCube,samples:N,depthTextureFormat:M,label:b},this),this._depthStencilTexture}_shareDepth(D){this.shareDepth(D)}shareDepth(D){this._depthStencilTexture&&(D._depthStencilTexture&&D._depthStencilTexture.dispose(),D._depthStencilTexture=this._depthStencilTexture,D._depthStencilTextureWithStencil=this._depthStencilTextureWithStencil,this._depthStencilTexture.incrementReferences())}_swapAndDie(D){this.texture&&this.texture._swapAndDie(D),this._textures=null,this.dispose(!0)}_cloneRenderTargetWrapper(){let D=null;if(this._isMulti){const l=this.textures;if(l&&l.length>0){let G=!1,V=l.length,N=-1;const M=l[l.length-1]._source;14!==M&&12!==M||(G=!0,N=l[l.length-1].format,V--);const b=[],X=[],t=[],R=[],n=[],g=[],j=[],e={};for(let D=0;D<V;++D){const G=l[D];b.push(G.samplingMode),X.push(G.type),t.push(G.format);void 0!==e[G.uniqueId]?(R.push(-1),j.push(0)):(e[G.uniqueId]=D,G.is2DArray?(R.push(35866),j.push(G.depth)):G.isCube?(R.push(34067),j.push(0)):G.is3D?(R.push(32879),j.push(G.depth)):(R.push(3553),j.push(0))),this._faceIndices&&n.push(this._faceIndices[D]??0),this._layerIndices&&g.push(this._layerIndices[D]??0)}const K={samplingModes:b,generateMipMaps:l[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:G,depthTextureFormat:N,types:X,formats:t,textureCount:V,targetTypes:R,faceIndex:n,layerIndex:g,layerCounts:j,label:this.label},F={width:this.width,height:this.height,depth:this.depth};D=this._engine.createMultipleRenderTarget(F,K);for(let d=0;d<V;++d){if(-1!==R[d])continue;const G=e[l[d].uniqueId];D.setTexture(D.textures[G],d)}}}else{var l,G,V,N;const b={};if(b.generateDepthBuffer=this._generateDepthBuffer,b.generateMipMaps=(null===(l=this.texture)||void 0===l?void 0:l.generateMipMaps)??!1,b.generateStencilBuffer=this._generateStencilBuffer,b.samplingMode=null===(G=this.texture)||void 0===G?void 0:G.samplingMode,b.type=null===(V=this.texture)||void 0===V?void 0:V.type,b.format=null===(N=this.texture)||void 0===N?void 0:N.format,b.noColorAttachment=!this._textures,b.label=this.label,this.isCube)D=this._engine.createRenderTargetCubeTexture(this.width,b);else{var M;const l={width:this.width,height:this.height,layers:this.is2DArray||this.is3D?null===(M=this.texture)||void 0===M?void 0:M.depth:void 0};D=this._engine.createRenderTargetTexture(l,b)}D.texture&&(D.texture.isReady=!0)}return D}_swapRenderTargetWrapper(D){if(this._textures&&D._textures)for(let l=0;l<this._textures.length;++l)this._textures[l]._swapAndDie(D._textures[l],!1),D._textures[l].isReady=!0;this._depthStencilTexture&&D._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(D._depthStencilTexture),D._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null}_rebuild(){const D=this._cloneRenderTargetWrapper();if(D){if(this._depthStencilTexture){const l=this._depthStencilTexture.samplingMode,G=this._depthStencilTexture.format,V=2===l||3===l||11===l;D.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,V,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples,G,this._depthStencilTextureLabel)}this.samples>1&&D.setSamples(this.samples),D._swapRenderTargetWrapper(this),D.dispose()}}releaseTextures(){if(this._textures)for(let D=0;D<this._textures.length;++D)this._textures[D].dispose();this._textures=null}dispose(){var D;arguments.length>0&&void 0!==arguments[0]&&arguments[0]||(null===(D=this._depthStencilTexture)||void 0===D||D.dispose(),this._depthStencilTexture=null,this.releaseTextures());this._engine._releaseRenderTargetWrapper(this)}}},11851:(D,l,G)=>{G.r(l),G.d(l,{ThinEngine:()=>r});var V=G(11629),N=G(11856),M=G(11546),b=G(11538);class X{constructor(){this.shaderLanguage=0}postProcessor(D,l,G,V,N){if(N.drawBuffersExtensionDisabled){const l=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;D=D.replace(l,"")}return D}}const t=/(flat\s)?\s*varying\s*.*/;class R{constructor(){this.shaderLanguage=0}attributeProcessor(D){return D.replace("attribute","in")}varyingCheck(D,l){return t.test(D)}varyingProcessor(D,l){return D.replace("varying",l?"in":"out")}postProcessor(D,l,G){const V=-1!==D.search(/#extension.+GL_EXT_draw_buffers.+require/);if(D=(D=D.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),G){const l=-1!==D.search(/layout *\(location *= *0\) *out/g);D=(D=(D=(D=(D=(D=(D=D.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/void\s+?main\s*\(/g,(V||l?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(")}else{if(-1!==l.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+D}return D}}var n=G(11865),g=G(11675),j=G(11613),e=G(11868),K=G(11644),F=G(11617),d=G(11603),H=G(11623),h=G(11870);class x{}class r extends j.e{get name(){return this._name}set name(D){this._name=D}get version(){return this._webGLVersion}static get ShadersRepository(){return F.Effect.ShadersRepository}static set ShadersRepository(D){F.Effect.ShadersRepository=D}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(D){this._framebufferDimensionsObject=D}snapshotRenderingReset(){this.snapshotRendering=!1}constructor(D,l,G,N){if(G=G||{},super(l??G.antialias,G,N),this._name="WebGL",this.forcePOTTextures=!1,this.validateShaderPrograms=!1,this.disableUniformBuffers=!1,this._webGLVersion=1,this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},!D)return;let b=null;if(D.getContext){if(b=D,void 0===G.Xb&&(G.Xb=!1),void 0===G.xrCompatible&&(G.xrCompatible=!1),navigator&&navigator.userAgent){this._setupMobileChecks();const D=navigator.userAgent;for(const l of r.ExceptionList){const V=l.key,N=l.targets;if(new RegExp(V).test(D)){if(l.capture&&l.captureConstraint){const G=l.capture,V=l.captureConstraint,N=new RegExp(G).exec(D);if(N&&N.length>0){if(parseInt(N[N.length-1])>=V)continue}}for(const D of N)switch(D){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":G.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1}}}}if(this._doNotHandleContextLost?this._onContextLost=()=>{(0,V.w)(this._gl)}:(this._onContextLost=D=>{D.preventDefault(),this._contextWasLost=!0,(0,V.w)(this._gl),M.d.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost((()=>this._initGLContext()))},b.addEventListener("webglcontextrestored",this._onContextRestored,!1),G.powerPreference=G.powerPreference||"high-performance"),b.addEventListener("webglcontextlost",this._onContextLost,!1),this._badDesktopOS&&(G.xrCompatible=!1),!G.disableWebGL2Support)try{this._gl=b.getContext("webgl2",G)||b.getContext("experimental-webgl2",G),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch(g){}if(!this._gl){if(!b)throw new Error("The provided canvas is null or undefined.");try{this._gl=b.getContext("webgl",G)||b.getContext("experimental-webgl",G)}catch(g){throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=D,b=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const l=this._gl.getContextAttributes();l&&(G.stencil=l.stencil)}this._sharedInit(b),this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),void 0!==G.useHighPrecisionFloats&&(this._highPrecisionShadersAllowed=G.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let V=0;V<this._caps.maxVertexAttribs;V++)this._currentBufferPointers[V]=new x;this._shaderProcessor=this.webGLVersion>1?new R:new X;const t=`Babylon.js v${r.Version}`;M.d.Log(t+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",t);const n=(0,V.A)(this._gl);n.validateShaderPrograms=this.validateShaderPrograms,n.parallelShaderCompile=this._caps.parallelShaderCompile}_clearEmptyResources(){this._dummyFramebuffer=null,super._clearEmptyResources()}_getShaderProcessingContext(D){return null}areAllEffectsReady(){for(const D in this._compiledEffects){if(!this._compiledEffects[D].isReady())return!1}return!0}_initGLContext(){this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||null!==this._gl.getExtension("OES_standard_derivatives"),maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||null!==this._gl.getExtension("OES_element_index_uint"),fragmentDepthSupported:this._webGLVersion>1||null!==this._gl.getExtension("EXT_frag_depth"),highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,colorBufferHalfFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_half_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:1!==this._webGLVersion,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1,textureNorm16:!!this._gl.getExtension("EXT_texture_norm16")},this._caps.supportFloatTexturesResolve=this._caps.colorBufferFloat,this._caps.rg11b10ufColorRenderable=this._caps.colorBufferFloat,this._glVersion=this._gl.getParameter(this._gl.VERSION);const D=this._gl.getExtension("WEBGL_debug_renderer_info");if(null!=D&&(this._glRenderer=this._gl.getParameter(D.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(D.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),36193!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=36193),34842!==this._gl.RGBA16F&&(this._gl.RGBA16F=34842),34836!==this._gl.RGBA32F&&(this._gl.RGBA32F=34836),35056!==this._gl.DEPTH24_STENCIL8&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(1===this._webGLVersion&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=(this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)??0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!(!this._caps.textureFloat||!this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!(!this._caps.textureFloat||!this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.textureNorm16&&(this._gl.R16_EXT=33322,this._gl.RG16_EXT=33324,this._gl.RGB16_EXT=32852,this._gl.RGBA16_EXT=32859,this._gl.R16_SNORM_EXT=36760,this._gl.RG16_SNORM_EXT=36761,this._gl.RGB16_SNORM_EXT=36762,this._gl.RGBA16_SNORM_EXT=36763),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&5131!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=null!==this._maxMSAASamplesOverride?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES),this._caps.maxDrawBuffers=this._gl.getParameter(this._gl.MAX_DRAW_BUFFERS);else{const D=this._gl.getExtension("WEBGL_draw_buffers");if(null!==D){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=D.drawBuffersWEBGL.bind(D),this._caps.maxDrawBuffers=this._gl.getParameter(D.MAX_DRAW_BUFFERS_WEBGL),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let l=0;l<16;l++)this._gl["COLOR_ATTACHMENT"+l+"_WEBGL"]=D["COLOR_ATTACHMENT"+l+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{const D=this._gl.getExtension("WEBGL_depth_texture");null!=D&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=D.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{const D=this._gl.getExtension("OES_vertex_array_object");null!=D&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=D.createVertexArrayOES.bind(D),this._gl.bindVertexArray=D.bindVertexArrayOES.bind(D),this._gl.deleteVertexArray=D.deleteVertexArrayOES.bind(D))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{const D=this._gl.getExtension("ANGLE_instanced_arrays");null!=D?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=D.drawArraysInstancedANGLE.bind(D),this._gl.drawElementsInstanced=D.drawElementsInstancedANGLE.bind(D),this._gl.vertexAttribDivisor=D.vertexAttribDivisorANGLE.bind(D)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){const D=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),l=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);D&&l&&(this._caps.highPrecisionShaderSupported=0!==D.precision&&0!==l.precision)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{const D=this._gl.getExtension("EXT_blend_minmax");null!=D&&(this._caps.blendMinMax=!0,this._gl.MAX=D.MAX_EXT,this._gl.MIN=D.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:WebGL2RenderingContext.SRGB,SRGB8:WebGL2RenderingContext.SRGB8,SRGB8_ALPHA8:WebGL2RenderingContext.SRGB8_ALPHA8};else{const D=this._gl.getExtension("EXT_sRGB");null!=D&&(this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:D.SRGB_EXT,SRGB8:D.SRGB_ALPHA_EXT,SRGB8_ALPHA8:D.SRGB_ALPHA_EXT})}if(this._creationOptions){const D=this._creationOptions.forceSRGBBufferSupportState;void 0!==D&&(this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&D)}}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let l=0;l<this._maxSimultaneousTextures;l++)this._nextFreeTextureSlots.push(l);"Mali-G72"===this._glRenderer&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:"undefined"===typeof HTMLImageElement,supportRenderAndCopyToLodForFloatTextures:1!==this._webGLVersion,supportDepthStencilTexture:1!==this._webGLVersion,supportShadowSamplers:1!==this._webGLVersion,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:1!==this._webGLVersion,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:1!==this._webGLVersion,basisNeedsPOT:1===this._webGLVersion,support3DTextures:1!==this._webGLVersion,needTypeSuffixInShaderConstants:1!==this._webGLVersion,supportMSAA:1!==this._webGLVersion,supportSSAO2:1!==this._webGLVersion,supportIBLShadows:1!==this._webGLVersion,supportExtendedTextureFormats:1!==this._webGLVersion,supportSwitchCaseInShader:1!==this._webGLVersion,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,forceVertexBufferStrideAndOffsetMultiple4Bytes:!1,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const D=this._workingCanvas.getContext("2d");D&&(this._workingContext=D)}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}extractDriverInfo(){const D=this.getGlInfo();return D&&D.renderer?D.renderer:""}getRenderWidth(){return!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(){return!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}clear(D,l,G){let V=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const N=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=N;let M=0;if(l&&D){let l=!0;if(this._currentRenderTarget){var b;const G=null===(b=this._currentRenderTarget.texture)||void 0===b?void 0:b.format;if(8===G||9===G||10===G||11===G){var X;const G=null===(X=this._currentRenderTarget.texture)||void 0===X?void 0:X.type;7===G||5===G?(r._TempClearColorUint32[0]=255*D.r,r._TempClearColorUint32[1]=255*D.g,r._TempClearColorUint32[2]=255*D.b,r._TempClearColorUint32[3]=255*D.a,this._gl.clearBufferuiv(this._gl.COLOR,0,r._TempClearColorUint32),l=!1):(r._TempClearColorInt32[0]=255*D.r,r._TempClearColorInt32[1]=255*D.g,r._TempClearColorInt32[2]=255*D.b,r._TempClearColorInt32[3]=255*D.a,this._gl.clearBufferiv(this._gl.COLOR,0,r._TempClearColorInt32),l=!1)}}l&&(this._gl.clearColor(D.r,D.g,D.b,void 0!==D.a?D.a:1),M|=this._gl.COLOR_BUFFER_BIT)}G&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),M|=this._gl.DEPTH_BUFFER_BIT),V&&(this._gl.clearStencil(0),M|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(M)}_viewport(D,l,G,V){D===this._viewportCached.x&&l===this._viewportCached.y&&G===this._viewportCached.z&&V===this._viewportCached.w||(this._viewportCached.x=D,this._viewportCached.y=l,this._viewportCached.z=G,this._viewportCached.w=V,this._gl.viewport(D,l,G,V))}Gb(){super.Gb(),this._badOS&&this.flushFramebuffer()}get performanceMonitor(){throw new Error("Not Supported by ThinEngine")}bindFramebuffer(D){let l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,G=arguments.length>2?arguments[2]:void 0,V=arguments.length>3?arguments[3]:void 0,N=arguments.length>4?arguments[4]:void 0,b=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,X=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;const t=D;this._currentRenderTarget&&this._resolveAndGenerateMipMapsFramebuffer(this._currentRenderTarget),this._currentRenderTarget=D,this._bindUnboundFramebuffer(t._framebuffer);const R=this._gl;var n;if(!D.isMulti)if(D.is2DArray||D.is3D)R.framebufferTextureLayer(R.FRAMEBUFFER,R.COLOR_ATTACHMENT0,null===(n=D.texture._hardwareTexture)||void 0===n?void 0:n.underlyingResource,b,X),t._currentLOD=b;else if(D.isCube){var g;R.framebufferTexture2D(R.FRAMEBUFFER,R.COLOR_ATTACHMENT0,R.TEXTURE_CUBE_MAP_POSITIVE_X+l,null===(g=D.texture._hardwareTexture)||void 0===g?void 0:g.underlyingResource,b)}else if(t._currentLOD!==b){var j;R.framebufferTexture2D(R.FRAMEBUFFER,R.COLOR_ATTACHMENT0,R.TEXTURE_2D,null===(j=D.texture._hardwareTexture)||void 0===j?void 0:j.underlyingResource,b),t._currentLOD=b}const e=D._depthStencilTexture;if(e){D.is3D&&(D.texture.width===e.width&&D.texture.height===e.height&&D.texture.depth===e.depth||M.d.Warn("Depth/Stencil attachment for 3D target must have same dimensions as color attachment"));const G=D._depthStencilTextureWithStencil?R.DEPTH_STENCIL_ATTACHMENT:R.DEPTH_ATTACHMENT;var K;if(D.is2DArray||D.is3D)R.framebufferTextureLayer(R.FRAMEBUFFER,G,null===(K=e._hardwareTexture)||void 0===K?void 0:K.underlyingResource,b,X);else if(D.isCube){var F;R.framebufferTexture2D(R.FRAMEBUFFER,G,R.TEXTURE_CUBE_MAP_POSITIVE_X+l,null===(F=e._hardwareTexture)||void 0===F?void 0:F.underlyingResource,b)}else{var d;R.framebufferTexture2D(R.FRAMEBUFFER,G,R.TEXTURE_2D,null===(d=e._hardwareTexture)||void 0===d?void 0:d.underlyingResource,b)}}t._MSAAFramebuffer&&this._bindUnboundFramebuffer(t._MSAAFramebuffer),this._cachedViewport&&!N?this.setViewport(this._cachedViewport,G,V):(G||(G=D.width,b&&(G/=Math.pow(2,b))),V||(V=D.height,b&&(V/=Math.pow(2,b))),this._viewport(0,0,G,V)),this.wipeCaches()}setStateCullFaceType(D,l){const G=this.cullBackFaces??D??1?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==G||l)&&(this._depthCullingState.cullFace=G)}setState(D){let l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,G=arguments.length>2?arguments[2]:void 0,V=arguments.length>3&&void 0!==arguments[3]&&arguments[3],N=arguments.length>4?arguments[4]:void 0,M=arguments.length>5?arguments[5]:void 0,b=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;(this._depthCullingState.cull!==D||G)&&(this._depthCullingState.cull=D),this.setStateCullFaceType(N,G),this.setZOffset(l),this.setZOffsetUnits(b);const X=V?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==X||G)&&(this._depthCullingState.frontFace=X),this._stencilStateComposer.stencilMaterial=M}_resolveAndGenerateMipMapsFramebuffer(D){let l=arguments.length>1&&void 0!==arguments[1]&&arguments[1];D.disableAutomaticMSAAResolve||(D.isMulti?this.resolveMultiFramebuffer(D):this.resolveFramebuffer(D)),l||(D.isMulti?this.generateMipMapsMultiFramebuffer(D):this.generateMipMapsFramebuffer(D))}_bindUnboundFramebuffer(D){this._currentFramebuffer!==D&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,D),this._currentFramebuffer=D)}_currentFrameBufferIsDefaultFrameBuffer(){return null===this._currentFramebuffer}generateMipmaps(D){const l=this._getTextureTarget(D);this._bindTextureDirectly(l,D,!0),this._gl.generateMipmap(l),this._bindTextureDirectly(l,null)}unBindFramebuffer(D,l,G){const V=D;this._currentRenderTarget=null,this._resolveAndGenerateMipMapsFramebuffer(D,l),G&&(V._MSAAFramebuffer&&this._bindUnboundFramebuffer(V._framebuffer),G()),this._bindUnboundFramebuffer(null)}generateMipMapsFramebuffer(D){var l;D.isMulti||null===(l=D.texture)||void 0===l||!l.generateMipMaps||D.isCube||this.generateMipmaps(D.texture)}resolveFramebuffer(D){const l=D,G=this._gl;if(!l._MSAAFramebuffer||l.isMulti)return;let V=l.resolveMSAAColors?G.COLOR_BUFFER_BIT:0;V|=l._generateDepthBuffer&&l.resolveMSAADepth?G.DEPTH_BUFFER_BIT:0,V|=l._generateStencilBuffer&&l.resolveMSAAStencil?G.STENCIL_BUFFER_BIT:0,G.bindFramebuffer(G.READ_FRAMEBUFFER,l._MSAAFramebuffer),G.bindFramebuffer(G.DRAW_FRAMEBUFFER,l._framebuffer),G.blitFramebuffer(0,0,D.width,D.height,0,0,D.width,D.height,V,G.NEAREST)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(D,l,G){return this._createVertexBuffer(D,this._gl.STATIC_DRAW)}_createVertexBuffer(D,l){const G=this._gl.createBuffer();if(!G)throw new Error("Unable to create vertex buffer");const V=new n.d(G);return this.bindArrayBuffer(V),"number"!==typeof D?D instanceof Array?(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(D),l),V.nG=4*D.length):(this._gl.bufferData(this._gl.ARRAY_BUFFER,D,l),V.nG=D.byteLength):(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Uint8Array(D),l),V.nG=D),this._resetVertexBufferBinding(),V.references=1,V}createDynamicVertexBuffer(D,l){return this._createVertexBuffer(D,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(D,l,G){const V=this._gl.createBuffer(),N=new n.d(V);if(!V)throw new Error("Unable to create index buffer");this.bindIndexBuffer(N);const M=this._normalizeIndexData(D);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,M,l?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),N.references=1,N.is32Bits=4===M.BYTES_PER_ELEMENT,N}_normalizeIndexData(D){if(2===D.BYTES_PER_ELEMENT)return D;if(this._caps.uintIndices){if(D instanceof Uint32Array)return D;for(let l=0;l<D.length;l++)if(D[l]>=65535)return new Uint32Array(D);return new Uint16Array(D)}return new Uint16Array(D)}bindArrayBuffer(D){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(D,this._gl.ARRAY_BUFFER)}bindUniformBlock(D,l,G){const V=D.program,N=this._gl.getUniformBlockIndex(V,l);this._gl.uniformBlockBinding(V,N,G)}bindIndexBuffer(D){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(D,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(D,l){(this._vaoRecordInProgress||this._currentBoundBuffer[l]!==D)&&(this._gl.bindBuffer(l,D?D.underlyingResource:null),this._currentBoundBuffer[l]=D)}updateArrayBuffer(D){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,D)}_vertexAttribPointer(D,l,G,V,N,M,b){const X=this._currentBufferPointers[l];if(!X)return;let t=!1;X.active?(X.buffer!==D&&(X.buffer=D,t=!0),X.size!==G&&(X.size=G,t=!0),X.type!==V&&(X.type=V,t=!0),X.normalized!==N&&(X.normalized=N,t=!0),X.stride!==M&&(X.stride=M,t=!0),X.offset!==b&&(X.offset=b,t=!0)):(t=!0,X.active=!0,X.index=l,X.size=G,X.type=V,X.normalized=N,X.stride=M,X.offset=b,X.buffer=D),(t||this._vaoRecordInProgress)&&(this.bindArrayBuffer(D),V===this._gl.UNSIGNED_INT||V===this._gl.INT?this._gl.vertexAttribIPointer(l,G,V,M,b):this._gl.vertexAttribPointer(l,G,V,N,M,b))}_bindIndexBufferWithCache(D){null!=D&&this._cachedIndexBuffer!==D&&(this._cachedIndexBuffer=D,this.bindIndexBuffer(D),this._uintIndicesCurrentlySet=D.is32Bits)}_bindVertexBuffersAttributes(D,l,G){const V=l.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let N=0;N<V.length;N++){const M=l.getAttributeLocation(N);if(M>=0){const l=V[N];let b=null;if(G&&(b=G[l]),b||(b=D[l]),!b)continue;this._gl.enableVertexAttribArray(M),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[M]=!0);const X=b.getBuffer();X&&(this._vertexAttribPointer(X,M,b.getSize(),b.type,b.normalized,b.byteStride,b.byteOffset),b.getIsInstanced()&&(this._gl.vertexAttribDivisor(M,b.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(M),this._currentInstanceBuffers.push(X))))}}}recordVertexArrayObject(D,l,G,V){const N=this._gl.createVertexArray();if(!N)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(N),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(D,G,V),this.bindIndexBuffer(l),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),N}bindVertexArrayObject(D,l){this._cachedVertexArrayObject!==D&&(this._cachedVertexArrayObject=D,this._gl.bindVertexArray(D),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=null!=l&&l.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(D,l,G,V,N){if(this._cachedVertexBuffers!==D||this._cachedEffectForVertexBuffers!==N){this._cachedVertexBuffers=D,this._cachedEffectForVertexBuffers=N;const l=N.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let M=0;for(let b=0;b<l;b++)if(b<G.length){const l=N.getAttributeLocation(b);l>=0&&(this._gl.enableVertexAttribArray(l),this._vertexAttribArraysEnabled[l]=!0,this._vertexAttribPointer(D,l,G[b],this._gl.FLOAT,!1,V,M)),M+=4*G[b]}}this._bindIndexBufferWithCache(l)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(D,l,G,V){this._cachedVertexBuffers===D&&this._cachedEffectForVertexBuffers===G||(this._cachedVertexBuffers=D,this._cachedEffectForVertexBuffers=G,this._bindVertexBuffersAttributes(D,G,V)),this._bindIndexBufferWithCache(l)}unbindInstanceAttributes(){let D;for(let l=0,G=this._currentInstanceLocations.length;l<G;l++){const G=this._currentInstanceBuffers[l];D!=G&&G.references&&(D=G,this.bindArrayBuffer(G));const V=this._currentInstanceLocations[l];this._gl.vertexAttribDivisor(V,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(D){this._gl.deleteVertexArray(D)}_releaseBuffer(D){return D.references--,0===D.references&&(this._deleteBuffer(D),!0)}_deleteBuffer(D){this._gl.deleteBuffer(D.underlyingResource)}updateAndBindInstancesBuffer(D,l,G){if(this.bindArrayBuffer(D),l&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,l),void 0!==G[0].index)this.bindInstancesBuffer(D,G,!0);else for(let V=0;V<4;V++){const l=G[V];this._vertexAttribArraysEnabled[l]||(this._gl.enableVertexAttribArray(l),this._vertexAttribArraysEnabled[l]=!0),this._vertexAttribPointer(D,l,4,this._gl.FLOAT,!1,64,16*V),this._gl.vertexAttribDivisor(l,1),this._currentInstanceLocations.push(l),this._currentInstanceBuffers.push(D)}}bindInstancesBuffer(D,l){let G=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.bindArrayBuffer(D);let V=0;if(G)for(let N=0;N<l.length;N++){V+=4*l[N].attributeSize}for(let N=0;N<l.length;N++){const G=l[N];void 0===G.index&&(G.index=this._currentEffect.getAttributeLocationByName(G.attributeName)),G.index<0||(this._vertexAttribArraysEnabled[G.index]||(this._gl.enableVertexAttribArray(G.index),this._vertexAttribArraysEnabled[G.index]=!0),this._vertexAttribPointer(D,G.index,G.attributeSize,G.attributeType||this._gl.FLOAT,G.normalized||!1,V,G.offset),this._gl.vertexAttribDivisor(G.index,void 0===G.divisor?1:G.divisor),this._currentInstanceLocations.push(G.index),this._currentInstanceBuffers.push(D))}}disableInstanceAttributeByName(D){if(!this._currentEffect)return;const l=this._currentEffect.getAttributeLocationByName(D);this.disableInstanceAttribute(l)}disableInstanceAttribute(D){let l,G=!1;for(;-1!==(l=this._currentInstanceLocations.indexOf(D));)this._currentInstanceLocations.splice(l,1),this._currentInstanceBuffers.splice(l,1),G=!0,l=this._currentInstanceLocations.indexOf(D);G&&(this._gl.vertexAttribDivisor(D,0),this.disableAttributeByIndex(D))}disableAttributeByIndex(D){this._gl.disableVertexAttribArray(D),this._vertexAttribArraysEnabled[D]=!1,this._currentBufferPointers[D].active=!1}draw(D,l,G,V){this.drawElementsType(D?0:1,l,G,V)}drawPointClouds(D,l,G){this.drawArraysType(2,D,l,G)}drawUnIndexed(D,l,G,V){this.drawArraysType(D?0:1,l,G,V)}drawElementsType(D,l,G,V){this.applyStates(),this._reportDrawCall();const N=this._drawMode(D),M=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,b=this._uintIndicesCurrentlySet?4:2;V?this._gl.drawElementsInstanced(N,G,M,l*b,V):this._gl.drawElements(N,G,M,l*b)}drawArraysType(D,l,G,V){this.applyStates(),this._reportDrawCall();const N=this._drawMode(D);V?this._gl.drawArraysInstanced(N,l,G,V):this._gl.drawArrays(N,l,G)}_drawMode(D){switch(D){case 0:default:return this._gl.TRIANGLES;case 2:case 3:return this._gl.POINTS;case 1:case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN}}_releaseEffect(D){this._compiledEffects[D._key]&&delete this._compiledEffects[D._key];const l=D.getPipelineContext();l&&this._deletePipelineContext(l)}_deletePipelineContext(D){const l=D;l&&l.program&&(l.program.__SPECTOR_rebuildProgram=null,(0,H.i)(l),this._gl&&(this._currentProgram===l.program&&this._setProgram(null),this._gl.deleteProgram(l.program)))}_getGlobalDefines(D){return(0,d.i)(D,this.isNDCHalfZRange,this.useReverseDepthBuffer,this.useExactSrgbConversions)}createEffect(D,l,G,N,M,b,X,t,R){let n=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,g=arguments.length>10?arguments[10]:void 0;const j="string"===typeof D?D:D.vertexToken||D.vertexSource||D.vertexElement||D.vertex,e="string"===typeof D?D:D.fragmentToken||D.fragmentSource||D.fragmentElement||D.fragment,K=this._getGlobalDefines(),d=void 0!==l.attributes;let H=M??l.defines??"";K&&(H+=K);const h=j+"+"+e+"@"+H;if(this._compiledEffects[h]){const D=this._compiledEffects[h];return X&&D.isReady()&&X(D),D._refCount++,D}this._gl&&(0,V.A)(this._gl);const x=new F.Effect(D,l,d?this:G,N,this,M,b,X,t,R,h,l.shaderLanguage??n,l.extraInitializationsAsync??g);return this._compiledEffects[h]=x,x}_getShaderSource(D){return this._gl.getShaderSource(D)}createRawShaderProgram(D,l,G,N){let M=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const b=(0,V.A)(this._gl);return b._contextWasLost=this._contextWasLost,b.validateShaderPrograms=this.validateShaderPrograms,(0,V.s)(D,l,G,N||this._gl,M)}createShaderProgram(D,l,G,N,M){let b=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;const X=(0,V.A)(this._gl);return X._contextWasLost=this._contextWasLost,X.validateShaderPrograms=this.validateShaderPrograms,(0,V.t)(D,l,G,N,M||this._gl,b)}inlineShaderCode(D){return D}createPipelineContext(D){if(this._gl){(0,V.A)(this._gl).parallelShaderCompile=this._caps.parallelShaderCompile}const l=(0,V.p)(this._gl,D);return l.el=this,l}createMaterialContext(){}createDrawContext(){}_finalizePipelineContext(D){return(0,V.i)(D,this._gl,this.validateShaderPrograms)}_preparePipelineContextAsync(D,l,G,N,M,b,X,t,R,n,g){const j=(0,V.A)(this._gl);return j._contextWasLost=this._contextWasLost,j.validateShaderPrograms=this.validateShaderPrograms,j._createShaderProgramInjection=this._createShaderProgram.bind(this),j.createRawShaderProgramInjection=this.createRawShaderProgram.bind(this),j.createShaderProgramInjection=this.createShaderProgram.bind(this),j.loadFileInjection=this._loadFile.bind(this),(0,V.m)(D,l,G,N,M,b,X,t,R,n,g)}_createShaderProgram(D,l,G,N){let M=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return(0,V.c)(D,l,G,N,M)}_isRenderingStateCompiled(D){return!this._isDisposed&&(0,V.j)(D,this._gl,this.validateShaderPrograms)}_executeWhenRenderingStateIsCompiled(D,l){(0,V.e)(D,l)}getUniforms(D,l){const G=new Array,V=D;for(let N=0;N<l.length;N++)G.push(this._gl.getUniformLocation(V.program,l[N]));return G}getAttributes(D,l){const G=[],V=D;for(let M=0;M<l.length;M++)try{G.push(this._gl.getAttribLocation(V.program,l[M]))}catch(N){G.push(-1)}return G}enableEffect(D){(D=null!==D&&(0,N.e)(D)?D.effect:D)&&D!==this._currentEffect&&(this._stencilStateComposer.stencilMaterial=void 0,this.bindSamplers(D),this._currentEffect=D,D.onBind&&D.onBind(D),D._onBindObservable&&D._onBindObservable.notifyObservers(D))}setInt(D,l){return!!D&&(this._gl.uniform1i(D,l),!0)}setInt2(D,l,G){return!!D&&(this._gl.uniform2i(D,l,G),!0)}setInt3(D,l,G,V){return!!D&&(this._gl.uniform3i(D,l,G,V),!0)}setInt4(D,l,G,V,N){return!!D&&(this._gl.uniform4i(D,l,G,V,N),!0)}setIntArray(D,l){return!!D&&(this._gl.uniform1iv(D,l),!0)}setIntArray2(D,l){return!(!D||l.length%2!==0)&&(this._gl.uniform2iv(D,l),!0)}setIntArray3(D,l){return!(!D||l.length%3!==0)&&(this._gl.uniform3iv(D,l),!0)}setIntArray4(D,l){return!(!D||l.length%4!==0)&&(this._gl.uniform4iv(D,l),!0)}setUInt(D,l){return!!D&&(this._gl.uniform1ui(D,l),!0)}setUInt2(D,l,G){return!!D&&(this._gl.uniform2ui(D,l,G),!0)}setUInt3(D,l,G,V){return!!D&&(this._gl.uniform3ui(D,l,G,V),!0)}setUInt4(D,l,G,V,N){return!!D&&(this._gl.uniform4ui(D,l,G,V,N),!0)}setUIntArray(D,l){return!!D&&(this._gl.uniform1uiv(D,l),!0)}setUIntArray2(D,l){return!(!D||l.length%2!==0)&&(this._gl.uniform2uiv(D,l),!0)}setUIntArray3(D,l){return!(!D||l.length%3!==0)&&(this._gl.uniform3uiv(D,l),!0)}setUIntArray4(D,l){return!(!D||l.length%4!==0)&&(this._gl.uniform4uiv(D,l),!0)}setArray(D,l){return!!D&&(!(l.length<1)&&(this._gl.uniform1fv(D,l),!0))}setArray2(D,l){return!(!D||l.length%2!==0)&&(this._gl.uniform2fv(D,l),!0)}setArray3(D,l){return!(!D||l.length%3!==0)&&(this._gl.uniform3fv(D,l),!0)}setArray4(D,l){return!(!D||l.length%4!==0)&&(this._gl.uniform4fv(D,l),!0)}setMatrices(D,l){return!!D&&(this._gl.uniformMatrix4fv(D,!1,l),!0)}setMatrix3x3(D,l){return!!D&&(this._gl.uniformMatrix3fv(D,!1,l),!0)}setMatrix2x2(D,l){return!!D&&(this._gl.uniformMatrix2fv(D,!1,l),!0)}setFloat(D,l){return!!D&&(this._gl.uniform1f(D,l),!0)}setFloat2(D,l,G){return!!D&&(this._gl.uniform2f(D,l,G),!0)}setFloat3(D,l,G,V){return!!D&&(this._gl.uniform3f(D,l,G,V),!0)}setFloat4(D,l,G,V,N){return!!D&&(this._gl.uniform4f(D,l,G,V,N),!0)}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;const D=this._colorWrite;this._gl.colorMask(D,D,D,D)}}wipeCaches(D){this.preventCacheWipeBetweenFrames&&!D||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),D&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(D,l){const G=this._gl;let V=G.NEAREST,N=G.NEAREST,M=!1;switch(D){case 11:V=G.LINEAR,N=l?G.LINEAR_MIPMAP_NEAREST:G.LINEAR;break;case 3:V=G.LINEAR,M=!0,N=l?G.LINEAR_MIPMAP_LINEAR:G.LINEAR;break;case 8:M=!0,V=G.NEAREST,N=l?G.NEAREST_MIPMAP_LINEAR:G.NEAREST;break;case 4:V=G.NEAREST,N=l?G.NEAREST_MIPMAP_NEAREST:G.NEAREST;break;case 5:V=G.NEAREST,N=l?G.LINEAR_MIPMAP_NEAREST:G.LINEAR;break;case 6:M=!0,V=G.NEAREST,N=l?G.LINEAR_MIPMAP_LINEAR:G.LINEAR;break;case 7:V=G.NEAREST,N=G.LINEAR;break;case 1:V=G.NEAREST,N=G.NEAREST;break;case 9:V=G.LINEAR,N=l?G.NEAREST_MIPMAP_NEAREST:G.NEAREST;break;case 10:M=!0,V=G.LINEAR,N=l?G.NEAREST_MIPMAP_LINEAR:G.NEAREST;break;case 2:V=G.LINEAR,N=G.LINEAR;break;case 12:V=G.LINEAR,N=G.NEAREST}return{min:N,mag:V,hasMipMaps:M}}_createTexture(){const D=this._gl.createTexture();if(!D)throw new Error("Unable to create texture");return D}_createHardwareTexture(){return new e.e(this._createTexture(),this._gl)}_createInternalTexture(D,l){let G,V=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,N=!1,b=!1,X=0,t=3,R=5,n=!1,g=1,j=!1,e=0;void 0!==l&&"object"===typeof l?(N=!!l.generateMipMaps,b=!!l.createMipMaps,X=void 0===l.type?0:l.type,t=void 0===l.samplingMode?3:l.samplingMode,R=void 0===l.format?5:l.format,n=void 0!==l.useSRGBBuffer&&l.useSRGBBuffer,g=l.samples??1,G=l.label,j=!!l.createMSAATexture,e=l.comparisonFunction||0):N=!!l,n&&(n=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(1!==X||this._caps.textureFloatLinearFiltering)&&(2!==X||this._caps.textureHalfFloatLinearFiltering)||(t=1),1!==X||this._caps.textureFloat||(X=0,M.d.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const F=(0,h.g)(R),d=(0,h.e)(R),H=this._gl,x=new K.b(this,V),r=D.width||D,o=D.height||D,L=D.depth||0,u=D.layers||0,B=this._getSamplingParameters(t,(N||b)&&!F),I=0!==u?H.TEXTURE_2D_ARRAY:0!==L?H.TEXTURE_3D:H.TEXTURE_2D,W=F?this._getInternalFormatFromDepthTextureFormat(R,!0,d):this._getRGBABufferInternalSizedFormat(X,R,n),i=F?d?H.DEPTH_STENCIL:H.DEPTH_COMPONENT:this._getInternalFormat(R),y=F?this._getWebGLTextureTypeFromDepthTextureFormat(R):this._getWebGLTextureType(X);if(this._bindTextureDirectly(I,x),0!==u?(x.is2DArray=!0,H.texImage3D(I,0,W,r,o,u,0,i,y,null)):0!==L?(x.is3D=!0,H.texImage3D(I,0,W,r,o,L,0,i,y,null)):H.texImage2D(I,0,W,r,o,0,i,y,null),H.texParameteri(I,H.TEXTURE_MAG_FILTER,B.mag),H.texParameteri(I,H.TEXTURE_MIN_FILTER,B.min),H.texParameteri(I,H.TEXTURE_WRAP_S,H.CLAMP_TO_EDGE),H.texParameteri(I,H.TEXTURE_WRAP_T,H.CLAMP_TO_EDGE),F&&this.webGLVersion>1&&(0===e?(H.texParameteri(I,H.TEXTURE_COMPARE_FUNC,515),H.texParameteri(I,H.TEXTURE_COMPARE_MODE,H.NONE)):(H.texParameteri(I,H.TEXTURE_COMPARE_FUNC,e),H.texParameteri(I,H.TEXTURE_COMPARE_MODE,H.COMPARE_REF_TO_TEXTURE))),(N||b)&&this._gl.generateMipmap(I),this._bindTextureDirectly(I,null),x._useSRGBBuffer=n,x.baseWidth=r,x.baseHeight=o,x.width=r,x.height=o,x.depth=u||L,x.isReady=!0,x.samples=g,x.generateMipMaps=N,x.samplingMode=t,x.type=X,x.format=R,x.label=G,x.comparisonFunction=e,this._internalTexturesCache.push(x),j){let D=null;if(D=(0,h.g)(x.format)?this._setupFramebufferDepthAttachments((0,h.e)(x.format),19!==x.format,x.width,x.height,g,x.format,!0):this._createRenderBuffer(x.width,x.height,g,-1,this._getRGBABufferInternalSizedFormat(x.type,x.format,x._useSRGBBuffer),-1),!D)throw new Error("Unable to create render buffer");x._autoMSAAManagement=!0;let l=x._hardwareTexture;l||(l=x._hardwareTexture=this._createHardwareTexture()),l.addMSAARenderBuffer(D)}return x}_getUseSRGBBuffer(D,l){return D&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||l)}createTexture(D,l,G,V){var N=this;let M=arguments.length>4&&void 0!==arguments[4]?arguments[4]:3,b=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,X=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,t=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,R=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,n=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,g=arguments.length>10&&void 0!==arguments[10]?arguments[10]:null,j=arguments.length>11?arguments[11]:void 0,e=arguments.length>12?arguments[12]:void 0,F=arguments.length>13?arguments[13]:void 0,d=arguments.length>14?arguments[14]:void 0;return this._createTextureBase(D,l,G,V,M,b,X,(function(){for(var D=arguments.length,l=new Array(D),G=0;G<D;G++)l[G]=arguments[G];return N._prepareWebGLTexture(...l,n)}),((D,l,G,N,M,b)=>{const X=this._gl,t=G.width===D&&G.height===l;M._creationFlags=F??0;const R=this._getTexImageParametersForCreateTexture(M.format,M._useSRGBBuffer);if(t)return X.texImage2D(X.TEXTURE_2D,0,R.internalFormat,R.format,R.type,G),!1;const n=this._caps.maxTextureSize;if(G.width>n||G.height>n||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!(!this._workingCanvas||!this._workingContext)&&(this._workingCanvas.width=D,this._workingCanvas.height=l,this._workingContext.drawImage(G,0,0,G.width,G.height,0,0,D,l),X.texImage2D(X.TEXTURE_2D,0,R.internalFormat,R.format,R.type,this._workingCanvas),M.width=D,M.height=l,!1);{const D=new K.b(this,2);this._bindTextureDirectly(X.TEXTURE_2D,D,!0),X.texImage2D(X.TEXTURE_2D,0,R.internalFormat,R.format,R.type,G),this._rescaleTexture(D,M,V,R.format,(()=>{this._releaseTexture(D),this._bindTextureDirectly(X.TEXTURE_2D,M,!0),b()}))}return!0}),t,R,n,g,j,e,d)}_getTexImageParametersForCreateTexture(D,l){let G,V;return 1===this.webGLVersion?(G=this._getInternalFormat(D,l),V=G):(G=this._getInternalFormat(D,!1),V=this._getRGBABufferInternalSizedFormat(0,D,l)),{internalFormat:V,format:G,type:this._gl.UNSIGNED_BYTE}}_rescaleTexture(D,l,G,V,N){}_unpackFlipY(D){this._unpackFlipYCached!==D&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,D?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=D))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(D){return D.isCube?this._gl.TEXTURE_CUBE_MAP:D.is3D?this._gl.TEXTURE_3D:D.is2DArray||D.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(D,l){let G=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const V=this._getTextureTarget(l),N=this._getSamplingParameters(D,l.useMipMaps||G);this._setTextureParameterInteger(V,this._gl.TEXTURE_MAG_FILTER,N.mag,l),this._setTextureParameterInteger(V,this._gl.TEXTURE_MIN_FILTER,N.min),G&&N.hasMipMaps&&(l.generateMipMaps=!0,this._gl.generateMipmap(V)),this._bindTextureDirectly(V,null),l.samplingMode=D}updateTextureDimensions(D,l,G){}updateTextureWrappingMode(D,l){let G=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,V=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;const N=this._getTextureTarget(D);null!==l&&(this._setTextureParameterInteger(N,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(l),D),D._cachedWrapU=l),null!==G&&(this._setTextureParameterInteger(N,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(G),D),D._cachedWrapV=G),(D.is2DArray||D.is3D)&&null!==V&&(this._setTextureParameterInteger(N,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(V),D),D._cachedWrapR=V),this._bindTextureDirectly(N,null)}_uploadCompressedDataToTextureDirectly(D,l,G,V,N){let M=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,b=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;const X=this._gl;let t=X.TEXTURE_2D;if(D.isCube&&(t=X.TEXTURE_CUBE_MAP_POSITIVE_X+M),D._useSRGBBuffer)switch(l){case 37492:case 36196:this._caps.etc2?l=X.COMPRESSED_SRGB8_ETC2:D._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?l=X.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:D._useSRGBBuffer=!1;break;case 36492:l=X.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:l=X.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?l=X.COMPRESSED_SRGB_S3TC_DXT1_EXT:D._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?l=X.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:D._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?l=X.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:D._useSRGBBuffer=!1;break;default:D._useSRGBBuffer=!1}this._gl.compressedTexImage2D(t,b,l,G,V,0,N)}_uploadDataToTextureDirectly(D,l){let G=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,V=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,N=arguments.length>4?arguments[4]:void 0,M=arguments.length>5&&void 0!==arguments[5]&&arguments[5];const b=this._gl,X=this._getWebGLTextureType(D.type),t=this._getInternalFormat(D.format),R=void 0===N?this._getRGBABufferInternalSizedFormat(D.type,D.format,D._useSRGBBuffer):this._getInternalFormat(N,D._useSRGBBuffer);this._unpackFlipY(D.invertY);let n=b.TEXTURE_2D;D.isCube&&(n=b.TEXTURE_CUBE_MAP_POSITIVE_X+G);const g=Math.round(Math.log(D.width)*Math.LOG2E),j=Math.round(Math.log(D.height)*Math.LOG2E),e=M?D.width:Math.pow(2,Math.max(g-V,0)),K=M?D.height:Math.pow(2,Math.max(j-V,0));b.texImage2D(n,V,R,e,K,0,t,X,l)}updateTextureData(D,l,G,V,N,M){let b=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,X=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,t=arguments.length>8&&void 0!==arguments[8]&&arguments[8];const R=this._gl,n=this._getWebGLTextureType(D.type),g=this._getInternalFormat(D.format);this._unpackFlipY(D.invertY);let j=R.TEXTURE_2D,e=R.TEXTURE_2D;D.isCube&&(e=R.TEXTURE_CUBE_MAP_POSITIVE_X+b,j=R.TEXTURE_CUBE_MAP),this._bindTextureDirectly(j,D,!0),R.texSubImage2D(e,X,G,V,N,M,g,n,l),t&&this._gl.generateMipmap(e),this._bindTextureDirectly(j,null)}_uploadArrayBufferViewToTexture(D,l){let G=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,V=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const N=this._gl,M=D.isCube?N.TEXTURE_CUBE_MAP:N.TEXTURE_2D;this._bindTextureDirectly(M,D,!0),this._uploadDataToTextureDirectly(D,l,G,V),this._bindTextureDirectly(M,null,!0)}_prepareWebGLTextureContinuation(D,l,G,V,N){const M=this._gl;if(!M)return;const b=this._getSamplingParameters(N,!G);M.texParameteri(M.TEXTURE_2D,M.TEXTURE_MAG_FILTER,b.mag),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_MIN_FILTER,b.min),G||V||M.generateMipmap(M.TEXTURE_2D),this._bindTextureDirectly(M.TEXTURE_2D,null),l&&l.removePendingData(D),D.onLoadedObservable.notifyObservers(D),D.onLoadedObservable.clear()}_prepareWebGLTexture(D,l,G,V,N,M,b,X,t,R){const n=this.getCaps().maxTextureSize,j=Math.min(n,this.needPOTTextures?(0,g.e)(V.width,n):V.width),e=Math.min(n,this.needPOTTextures?(0,g.e)(V.height,n):V.height),K=this._gl;K&&(D._hardwareTexture?(this._bindTextureDirectly(K.TEXTURE_2D,D,!0),this._unpackFlipY(void 0===N||!!N),D.baseWidth=V.width,D.baseHeight=V.height,D.width=j,D.height=e,D.isReady=!0,D.type=-1!==D.type?D.type:0,D.format=-1!==D.format?D.format:R??(".jpg"!==l||D._useSRGBBuffer?5:4),X(j,e,V,l,D,(()=>{this._prepareWebGLTextureContinuation(D,G,M,b,t)}))||this._prepareWebGLTextureContinuation(D,G,M,b,t)):G&&G.removePendingData(D))}_getInternalFormatFromDepthTextureFormat(D,l,G){const V=this._gl;if(!l)return V.STENCIL_INDEX8;let N=G?V.DEPTH_STENCIL:V.DEPTH_COMPONENT;return this.webGLVersion>1?15===D?N=V.DEPTH_COMPONENT16:16===D?N=V.DEPTH_COMPONENT24:17===D||13===D?N=G?V.DEPTH24_STENCIL8:V.DEPTH_COMPONENT24:14===D?N=V.DEPTH_COMPONENT32F:18===D&&(N=G?V.DEPTH32F_STENCIL8:V.DEPTH_COMPONENT32F):N=V.DEPTH_COMPONENT16,N}_getWebGLTextureTypeFromDepthTextureFormat(D){const l=this._gl;let G=l.UNSIGNED_INT;return 15===D?G=l.UNSIGNED_SHORT:17===D||13===D?G=l.UNSIGNED_INT_24_8:14===D?G=l.FLOAT:18===D?G=l.FLOAT_32_UNSIGNED_INT_24_8_REV:19===D&&(G=l.UNSIGNED_BYTE),G}_setupFramebufferDepthAttachments(D,l,G,V){let N=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,M=arguments.length>5?arguments[5]:void 0,b=arguments.length>6&&void 0!==arguments[6]&&arguments[6];const X=this._gl;M=M??(D?13:14);const t=this._getInternalFormatFromDepthTextureFormat(M,l,D);return D&&l?this._createRenderBuffer(G,V,N,X.DEPTH_STENCIL,t,b?-1:X.DEPTH_STENCIL_ATTACHMENT):l?this._createRenderBuffer(G,V,N,t,t,b?-1:X.DEPTH_ATTACHMENT):D?this._createRenderBuffer(G,V,N,t,t,b?-1:X.STENCIL_ATTACHMENT):null}_createRenderBuffer(D,l,G,V,N,M){let b=!(arguments.length>6&&void 0!==arguments[6])||arguments[6];const X=this._gl.createRenderbuffer();return this._updateRenderBuffer(X,D,l,G,V,N,M,b)}_updateRenderBuffer(D,l,G,V,N,M,b){let X=!(arguments.length>7&&void 0!==arguments[7])||arguments[7];const t=this._gl;return t.bindRenderbuffer(t.RENDERBUFFER,D),V>1&&t.renderbufferStorageMultisample?t.renderbufferStorageMultisample(t.RENDERBUFFER,V,M,l,G):t.renderbufferStorage(t.RENDERBUFFER,N,l,G),-1!==b&&t.framebufferRenderbuffer(t.FRAMEBUFFER,b,t.RENDERBUFFER,D),X&&t.bindRenderbuffer(t.RENDERBUFFER,null),D}_releaseTexture(D){this._deleteTexture(D._hardwareTexture),this.unbindAllTextures();const l=this._internalTexturesCache.indexOf(D);-1!==l&&this._internalTexturesCache.splice(l,1),D._lodTextureHigh&&D._lodTextureHigh.dispose(),D._lodTextureMid&&D._lodTextureMid.dispose(),D._lodTextureLow&&D._lodTextureLow.dispose(),D._irradianceTexture&&D._irradianceTexture.dispose()}_deleteTexture(D){null===D||void 0===D||D.release()}_setProgram(D){this._currentProgram!==D&&((0,V.o)(D,this._gl),this._currentProgram=D)}bindSamplers(D){const l=D.getPipelineContext();this._setProgram(l.program);const G=D.getSamplers();for(let V=0;V<G.length;V++){const l=D.getUniform(G[V]);l&&(this._boundUniforms[V]=l)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(D,l){let G=arguments.length>2&&void 0!==arguments[2]&&arguments[2],V=arguments.length>3&&void 0!==arguments[3]&&arguments[3],N=!1;const b=l&&l._associatedChannel>-1;G&&b&&(this._activeChannel=l._associatedChannel);if(this._boundTexturesCache[this._activeChannel]!==l||V){if(this._activateCurrentTexture(),l&&l.isMultiview)throw M.d.Error(["_bindTextureDirectly called with a multiview texture!",D,l]),"_bindTextureDirectly called with a multiview texture!";var X;this._gl.bindTexture(D,(null===l||void 0===l||null===(X=l._hardwareTexture)||void 0===X?void 0:X.underlyingResource)??null),this._boundTexturesCache[this._activeChannel]=l,l&&(l._associatedChannel=this._activeChannel)}else G&&(N=!0,this._activateCurrentTexture());return b&&!G&&this._bindSamplerUniformToChannel(l._associatedChannel,this._activeChannel),N}_bindTexture(D,l,G){if(void 0===D)return;l&&(l._associatedChannel=D),this._activeChannel=D;const V=l?this._getTextureTarget(l):this._gl.TEXTURE_2D;this._bindTextureDirectly(V,l)}unbindAllTextures(){for(let D=0;D<this._maxSimultaneousTextures;D++)this._activeChannel=D,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(D,l,G,V){void 0!==D&&(l&&(this._boundUniforms[D]=l),this._setTexture(D,G))}_bindSamplerUniformToChannel(D,l){const G=this._boundUniforms[D];G&&G._currentState!==l&&(this._gl.uniform1i(G,l),G._currentState=l)}_getTextureWrapMode(D){switch(D){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(D,l){let G,V=arguments.length>2&&void 0!==arguments[2]&&arguments[2],N=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!l)return null!=this._boundTexturesCache[D]&&(this._activeChannel=D,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(l.video){this._activeChannel=D;const G=l.getInternalTexture();G&&(G._associatedChannel=D),l.update()}else if(4===l.delayLoadState)return l.delayLoad(),!1;G=N?l.depthStencilTexture:l.isReady()?l.getInternalTexture():l.isCube?this.emptyCubeTexture:l.is3D?this.emptyTexture3D:l.is2DArray?this.emptyTexture2DArray:this.emptyTexture,!V&&G&&(G._associatedChannel=D);let M=!0;this._boundTexturesCache[D]===G&&(V||this._bindSamplerUniformToChannel(G._associatedChannel,D),M=!1),this._activeChannel=D;const b=this._getTextureTarget(G);if(M&&this._bindTextureDirectly(b,G,V),G&&!G.isMultiview){if(G.isCube&&G._cachedCoordinatesMode!==l.coordinatesMode){G._cachedCoordinatesMode=l.coordinatesMode;const D=3!==l.coordinatesMode&&5!==l.coordinatesMode?1:0;l.wrapU=D,l.wrapV=D}G._cachedWrapU!==l.wrapU&&(G._cachedWrapU=l.wrapU,this._setTextureParameterInteger(b,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(l.wrapU),G)),G._cachedWrapV!==l.wrapV&&(G._cachedWrapV=l.wrapV,this._setTextureParameterInteger(b,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(l.wrapV),G)),G.is3D&&G._cachedWrapR!==l.wrapR&&(G._cachedWrapR=l.wrapR,this._setTextureParameterInteger(b,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(l.wrapR),G)),this._setAnisotropicLevel(b,G,l.anisotropicFilteringLevel)}return!0}setTextureArray(D,l,G,V){if(void 0!==D&&l){this._textureUnits&&this._textureUnits.length===G.length||(this._textureUnits=new Int32Array(G.length));for(let l=0;l<G.length;l++){const V=G[l].getInternalTexture();V?(this._textureUnits[l]=D+l,V._associatedChannel=D+l):this._textureUnits[l]=-1}this._gl.uniform1iv(l,this._textureUnits);for(let D=0;D<G.length;D++)this._setTexture(this._textureUnits[D],G[D],!0)}}_setAnisotropicLevel(D,l,G){const V=this._caps.textureAnisotropicFilterExtension;11!==l.samplingMode&&3!==l.samplingMode&&2!==l.samplingMode&&(G=1),V&&l._cachedAnisotropicFilteringLevel!==G&&(this._setTextureParameterFloat(D,V.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(G,this._caps.maxAnisotropy),l),l._cachedAnisotropicFilteringLevel=G)}_setTextureParameterFloat(D,l,G,V){this._bindTextureDirectly(D,V,!0,!0),this._gl.texParameterf(D,l,G)}_setTextureParameterInteger(D,l,G,V){V&&this._bindTextureDirectly(D,V,!0,!0),this._gl.texParameteri(D,l,G)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let D=0;D<this._caps.maxVertexAttribs;D++)this.disableAttributeByIndex(D)}else for(let D=0,l=this._vertexAttribArraysEnabled.length;D<l;D++)D>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[D]||this.disableAttributeByIndex(D)}releaseEffects(){this._compiledEffects={},this.onReleaseEffectsObservable.notifyObservers(this)}dispose(){var D;((0,b.k)()&&this._renderingCanvas&&(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._onContextRestored&&this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),super.dispose(),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.unbindAllAttributes(),this._boundUniforms={},this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._currentProgram=null,this._creationOptions.loseContextOnDispose)&&(null===(D=this._gl.getExtension("WEBGL_lose_context"))||void 0===D||D.loseContext());(0,V.w)(this._gl)}attachContextLostEvent(D){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",D,!1)}attachContextRestoredEvent(D){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",D,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(D){const l=this._gl;for(;l.getError()!==l.NO_ERROR;);let G=!0;const V=l.createTexture();l.bindTexture(l.TEXTURE_2D,V),l.texImage2D(l.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(D),1,1,0,l.RGBA,this._getWebGLTextureType(D),null),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,l.NEAREST),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,l.NEAREST);const N=l.createFramebuffer();l.bindFramebuffer(l.FRAMEBUFFER,N),l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,V,0);const M=l.checkFramebufferStatus(l.FRAMEBUFFER);if(G=G&&M===l.FRAMEBUFFER_COMPLETE,G=G&&l.getError()===l.NO_ERROR,G&&(l.clear(l.COLOR_BUFFER_BIT),G=G&&l.getError()===l.NO_ERROR),G){l.bindFramebuffer(l.FRAMEBUFFER,null);const D=l.RGBA,V=l.UNSIGNED_BYTE,N=new Uint8Array(4);l.readPixels(0,0,1,1,D,V,N),G=G&&l.getError()===l.NO_ERROR}for(l.deleteTexture(V),l.deleteFramebuffer(N),l.bindFramebuffer(l.FRAMEBUFFER,null);!G&&l.getError()!==l.NO_ERROR;);return G}_getWebGLTextureType(D){if(1===this._webGLVersion){switch(D){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(D){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(D){let l=arguments.length>1&&void 0!==arguments[1]&&arguments[1],G=l?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;switch(D){case 0:G=this._gl.ALPHA;break;case 1:G=this._gl.LUMINANCE;break;case 2:G=this._gl.LUMINANCE_ALPHA;break;case 6:case 33322:case 36760:G=this._gl.RED;break;case 7:case 33324:case 36761:G=this._gl.RG;break;case 4:case 32852:case 36762:G=l?this._glSRGBExtensionValues.SRGB:this._gl.RGB;break;case 5:case 32859:case 36763:G=l?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA}if(this._webGLVersion>1)switch(D){case 8:G=this._gl.RED_INTEGER;break;case 9:G=this._gl.RG_INTEGER;break;case 10:G=this._gl.RGB_INTEGER;break;case 11:G=this._gl.RGBA_INTEGER}return G}_getRGBABufferInternalSizedFormat(D,l){let G=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(1===this._webGLVersion){if(void 0!==l)switch(l){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return G?this._glSRGBExtensionValues.SRGB:this._gl.RGB}return this._gl.RGBA}switch(D){case 3:switch(l){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(l){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return G?this._glSRGBExtensionValues.SRGB8:this._gl.RGB8;case 5:return G?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(l){case 8:return this._gl.R16I;case 36760:return this._gl.R16_SNORM_EXT;case 36761:return this._gl.RG16_SNORM_EXT;case 36762:return this._gl.RGB16_SNORM_EXT;case 36763:return this._gl.RGBA16_SNORM_EXT;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;default:return this._gl.RGBA16I}case 5:switch(l){case 8:return this._gl.R16UI;case 33322:return this._gl.R16_EXT;case 33324:return this._gl.RG16_EXT;case 32852:return this._gl.RGB16_EXT;case 32859:return this._gl.RGBA16_EXT;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;default:return this._gl.RGBA16UI}case 6:switch(l){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;default:return this._gl.RGBA32I}case 7:switch(l){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;default:return this._gl.RGBA32UI}case 1:switch(l){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;default:return this._gl.RGBA32F}case 2:switch(l){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(l){case 5:default:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI}}return G?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8}readPixels(D,l,G,V){let N=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],b=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],X=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;const t=N?4:3,R=N?this._gl.RGBA:this._gl.RGB,n=G*V*t;if(X){if(X.length<n)return M.d.Error(`Data buffer is too small to store the read pixels (${X.length} should be more than ${n})`),Promise.resolve(X)}else X=new Uint8Array(n);return b&&this.flushFramebuffer(),this._gl.readPixels(D,l,G,V,R,this._gl.UNSIGNED_BYTE,X),Promise.resolve(X)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(null!==this._HasMajorPerformanceCaveat)return!this._HasMajorPerformanceCaveat;if(null===this._IsSupported)try{const D=j.e._CreateCanvas(1,1),l=D.getContext("webgl")||D.getContext("experimental-webgl");this._IsSupported=null!=l&&!!window.WebGLRenderingContext}catch(D){this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(null===this._HasMajorPerformanceCaveat)try{const D=j.e._CreateCanvas(1,1),l=D.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||D.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!l}catch(D){this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}}r._TempClearColorUint32=new Uint32Array(4),r._TempClearColorInt32=new Int32Array(4),r.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/12\\d\\..+?Mobile",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}],r._ConcatenateShader=d.f,r._IsSupported=null,r._HasMajorPerformanceCaveat=null},11776:(D,l,G)=>{G.d(l,{d:()=>e});var V=G(11532),N=G(11710),M=G(11686),b=G(11784),X=G(11675),t=G(11617),R=G(11546),n=G(11805),g=G(11721);class j{get renderList(){return this._renderList}set renderList(D){this._renderList!==D&&(this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),D&&(this._unObserveRenderList=(0,g.f)(D,this._renderListHasChanged)),this._renderList=D)}get disableImageProcessing(){return this._disableImageProcessing}set disableImageProcessing(D){D!==this._disableImageProcessing&&(this._disableImageProcessing=D,this._scene.markAllMaterialsAsDirty(64))}get name(){return this._name}set name(D){if(this._name===D)return;if(this._name=D,!this._scene)return;const l=this._scene.getEngine();for(let G=0;G<this._renderPassIds.length;++G){const D=this._renderPassIds[G];l._renderPassNames[D]=`${this._name}#${G}`}}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}setMaterialForRendering(D,l){let G;G=Array.isArray(D)?D:[D];for(let V=0;V<G.length;++V)for(let D=0;D<this.options.numPasses;++D){let N=G[V];G[V].isAnInstance&&(N=G[V].sourceMesh),N.setMaterialForRenderPass(this._renderPassIds[D],void 0!==l?Array.isArray(l)?l[D]:l:void 0)}}constructor(D,l,G){this._unObserveRenderList=null,this._renderListHasChanged=(D,l)=>{const G=this._renderList?this._renderList.length:0;if(0===l&&G>0||0===G)for(const V of this._scene.meshes)V._markSubMeshesAsLightDirty()},this.particleSystemList=null,this.getCustomRenderList=null,this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this._disableImageProcessing=!1,this.onBeforeRenderObservable=new V.e,this.onAfterRenderObservable=new V.e,this.onBeforeRenderingManagerRenderObservable=new V.e,this.onAfterRenderingManagerRenderObservable=new V.e,this.onFastPathRenderObservable=new V.e,this._currentRefreshId=-1,this._refreshRate=1,this._currentApplyByPostProcessSetting=!1,this._currentSceneCamera=null,this.name=D,this._scene=l,this.renderList=[],this._renderPassIds=[],this.options={numPasses:1,doNotChangeAspectRatio:!0,...G},this._createRenderPassId(),this.renderPassId=this._renderPassIds[0],this._renderingManager=new n.d(l),this._renderingManager._useSceneAutoClearSetup=!0}_releaseRenderPassId(){const D=this._scene.getEngine();for(let l=0;l<this.options.numPasses;++l)D.releaseRenderPassId(this._renderPassIds[l]);this._renderPassIds.length=0}_createRenderPassId(){this._releaseRenderPassId();const D=this._scene.getEngine();for(let l=0;l<this.options.numPasses;++l)this._renderPassIds[l]=D.createRenderPassId(`${this.name}#${l}`)}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(D){this._refreshRate=D,this.resetRefreshCounter()}shouldRender(){return-1===this._currentRefreshId||this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}isReadyForRendering(D,l){this.prepareRenderList(),this.initRender(D,l);const G=this._checkReadiness();return this.finishRender(),G}prepareRenderList(){const D=this._scene;if(this._waitingRenderList){if(!this.renderListPredicate){this.renderList=[];for(let l=0;l<this._waitingRenderList.length;l++){const G=this._waitingRenderList[l],V=D.getMeshById(G);V&&this.renderList.push(V)}}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const D=this._scene.meshes;for(let l=0;l<D.length;l++){const G=D[l];this.renderListPredicate(G)&&this.renderList.push(G)}}this._currentApplyByPostProcessSetting=this._scene.imageProcessingConfiguration.applyByPostProcess,this._disableImageProcessing&&(this._scene.imageProcessingConfiguration._applyByPostProcess=this._disableImageProcessing)}initRender(D,l){const G=this._scene.getEngine(),V=this.activeCamera??this._scene.activeCamera;this._currentSceneCamera=this._scene.activeCamera,V&&(V!==this._scene.activeCamera&&(this._scene.setTransformMatrix(V.getViewMatrix(),V.getProjectionMatrix(!0)),this._scene.activeCamera=V),G.setViewport(V.rigParent?V.rigParent.viewport:V.viewport,D,l)),this._defaultRenderListPrepared=!1}finishRender(){const D=this._scene;this._disableImageProcessing&&(D.imageProcessingConfiguration._applyByPostProcess=this._currentApplyByPostProcessSetting),D.activeCamera=this._currentSceneCamera,this._currentSceneCamera&&(this.activeCamera&&this.activeCamera!==D.activeCamera&&D.setTransformMatrix(this._currentSceneCamera.getViewMatrix(),this._currentSceneCamera.getProjectionMatrix(!0)),D.getEngine().setViewport(this._currentSceneCamera.viewport)),D.resetCachedMaterial()}render(){let D=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,l=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const G=this._scene,V=G.getEngine(),N=V.currentRenderPassId;V.currentRenderPassId=this._renderPassIds[D],this.onBeforeRenderObservable.notifyObservers(D);if(V.snapshotRendering&&1===V.snapshotRenderingMode)this.onFastPathRenderObservable.notifyObservers(D);else{let l=null;const V=this.renderList?this.renderList:G.getActiveMeshes().data,N=this.renderList?this.renderList.length:G.getActiveMeshes().length;this.getCustomRenderList&&(l=this.getCustomRenderList(D,V,N)),l?this._prepareRenderingManager(l,l.length,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(V,N,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),l=V),this.onBeforeRenderingManagerRenderObservable.notifyObservers(D),this._renderingManager.render(this.customRenderFunction,l,this.renderParticles,this.renderSprites),this.onAfterRenderingManagerRenderObservable.notifyObservers(D)}l||this.onAfterRenderObservable.notifyObservers(D),V.currentRenderPassId=N}_checkReadiness(){const D=this._scene,l=D.getEngine(),G=l.currentRenderPassId;let V=!0;D.getViewMatrix()||D.updateTransformMatrix();const N=this.options.numPasses;for(let b=0;b<N&&V;b++){let G=null;const M=this.renderList?this.renderList:D.getActiveMeshes().data,X=this.renderList?this.renderList.length:D.getActiveMeshes().length;l.currentRenderPassId=this._renderPassIds[b],this.onBeforeRenderObservable.notifyObservers(b),this.getCustomRenderList&&(G=this.getCustomRenderList(b,M,X)),G||(G=M),this.options.doNotChangeAspectRatio||D.updateTransformMatrix(!0);for(let D=0;D<G.length&&V;++D){const l=G[D];if(l.isEnabled()&&!l.isBlocked&&l.isVisible&&l.nb)if(this.customIsReadyFunction){if(!this.customIsReadyFunction(l,this.refreshRate,!0)){V=!1;continue}}else if(!l.isReady(!0)){V=!1;continue}}this.onAfterRenderObservable.notifyObservers(b),N>1&&(D.incrementRenderId(),D.resetCachedMaterial())}const M=this.particleSystemList||D.xj;for(const b of M)b.isReady()||(V=!1);return l.currentRenderPassId=G,V}_prepareRenderingManager(D,l,G){const V=this._scene,N=V.activeCamera,M=this.cameraForLOD??N;this._renderingManager.reset();const b=V.getRenderId(),X=V.getFrameId();for(let R=0;R<l;R++){const l=D[R];if(l&&!l.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(l,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!l.isReady(0===this.refreshRate)){this.resetRefreshCounter();continue}let D,t=null;if(M){const D=l._internalAbstractMeshDataInfo._currentLOD.get(M);D&&D[1]===X?t=D[0]:(t=V.customLODSelector?V.customLODSelector(l,M):l.getLOD(M),D?(D[0]=t,D[1]=X):l._internalAbstractMeshDataInfo._currentLOD.set(M,[t,X]))}else t=l;if(!t)continue;if(t!==l&&0!==t.billboardMode&&t.hb(),t._preActivateForIntermediateRendering(b),D=!(!G||!N)&&0===(l.layerMask&N.layerMask),l.isEnabled()&&l.isVisible&&l.nb&&!D){if(t!==l&&t._activate(b,!0),l._activate(b,!0)&&l.nb.length){l.isAnInstance?l._internalAbstractMeshDataInfo._actAsRegularMesh&&(t=l):t._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,t._internalAbstractMeshDataInfo._isActiveIntermediate=!0,V._prepareSkeleton(t);for(let D=0;D<t.nb.length;D++){const l=t.nb[D];this._renderingManager.dispatch(l,t)}}l._postActivate()}}}const t=this.particleSystemList||V.xj;for(let R=0;R<t.length;R++){const D=t[R],l=D.Vl;D.isStarted()&&l&&(!l.position||l.isEnabled())&&this._renderingManager.dispatchParticles(D)}}setRenderingOrder(D){let l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,G=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,V=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this._renderingManager.setRenderingOrder(D,l,G,V)}setRenderingAutoClearDepthStencil(D,l){let G=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],V=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];this._renderingManager.setRenderingAutoClearDepthStencil(D,l,G,V),this._renderingManager._useSceneAutoClearSetup=!1}clone(){const D=new j(this.name,this._scene,this.options);return this.renderList&&(D.renderList=this.renderList.slice(0)),D}dispose(){const D=this.renderList?this.renderList:this._scene.getActiveMeshes().data,l=this.renderList?this.renderList.length:this._scene.getActiveMeshes().length;for(let G=0;G<l;G++){const l=D[G];l&&void 0!==l.getMaterialForRenderPass(this.renderPassId)&&l.setMaterialForRenderPass(this.renderPassId,void 0)}this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderingManagerRenderObservable.clear(),this.onAfterRenderingManagerRenderObservable.clear(),this.onFastPathRenderObservable.clear(),this._releaseRenderPassId(),this.renderList=null}_rebuild(){this.refreshRate===j.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=j.REFRESHRATE_RENDER_ONCE)}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}}j.REFRESHRATE_RENDER_ONCE=0,j.REFRESHRATE_RENDER_ONEVERYFRAME=1,j.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,t.Effect.prototype.setDepthStencilTexture=function(D,l){this._engine.setDepthStencilTexture(this._samplers[D],this._uniforms[D],l,D)};class e extends M.b{get renderListPredicate(){return this._objectRenderer.renderListPredicate}set renderListPredicate(D){this._objectRenderer.renderListPredicate=D}get renderList(){return this._objectRenderer.renderList}set renderList(D){this._objectRenderer.renderList=D}get particleSystemList(){return this._objectRenderer.particleSystemList}set particleSystemList(D){this._objectRenderer.particleSystemList=D}get getCustomRenderList(){return this._objectRenderer.getCustomRenderList}set getCustomRenderList(D){this._objectRenderer.getCustomRenderList=D}get renderParticles(){return this._objectRenderer.renderParticles}set renderParticles(D){this._objectRenderer.renderParticles=D}get renderSprites(){return this._objectRenderer.renderSprites}set renderSprites(D){this._objectRenderer.renderSprites=D}get forceLayerMaskCheck(){return this._objectRenderer.forceLayerMaskCheck}set forceLayerMaskCheck(D){this._objectRenderer.forceLayerMaskCheck=D}get activeCamera(){return this._objectRenderer.activeCamera}set activeCamera(D){this._objectRenderer.activeCamera=D}get cameraForLOD(){return this._objectRenderer.cameraForLOD}set cameraForLOD(D){this._objectRenderer.cameraForLOD=D}get disableImageProcessing(){return this._objectRenderer.disableImageProcessing}set disableImageProcessing(D){this._objectRenderer.disableImageProcessing=D}get customIsReadyFunction(){return this._objectRenderer.customIsReadyFunction}set customIsReadyFunction(D){this._objectRenderer.customIsReadyFunction=D}get customRenderFunction(){return this._objectRenderer.customRenderFunction}set customRenderFunction(D){this._objectRenderer.customRenderFunction=D}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(D){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(D)}get onBeforeRenderObservable(){return this._objectRenderer.onBeforeRenderObservable}set onBeforeRender(D){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(D)}get onAfterRenderObservable(){return this._objectRenderer.onAfterRenderObservable}set onAfterRender(D){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(D)}set onClear(D){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(D)}get _waitingRenderList(){return this._objectRenderer._waitingRenderList}set _waitingRenderList(D){this._objectRenderer._waitingRenderList=D}get renderPassId(){return this._objectRenderer.renderPassId}get renderPassIds(){return this._objectRenderer.renderPassIds}get currentRefreshId(){return this._objectRenderer.currentRefreshId}setMaterialForRendering(D,l){this._objectRenderer.setMaterialForRendering(D,l)}get isMulti(){var D;return(null===(D=this._renderTarget)||void 0===D?void 0:D.isMulti)??!1}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(D){if(this._boundingBoxSize&&this._boundingBoxSize.equals(D))return;this._boundingBoxSize=D;const l=this.uD();l&&l.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){var D;return(null===(D=this._renderTarget)||void 0===D?void 0:D._depthStencilTexture)??null}constructor(D,l,G){let b,X,t=arguments.length>3&&void 0!==arguments[3]&&arguments[3],n=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],g=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,e=arguments.length>6&&void 0!==arguments[6]&&arguments[6],K=arguments.length>7&&void 0!==arguments[7]?arguments[7]:M.b.TRILINEAR_SAMPLINGMODE,F=!(arguments.length>8&&void 0!==arguments[8])||arguments[8],d=arguments.length>9&&void 0!==arguments[9]&&arguments[9],H=arguments.length>10&&void 0!==arguments[10]&&arguments[10],h=arguments.length>11&&void 0!==arguments[11]?arguments[11]:5,x=arguments.length>12&&void 0!==arguments[12]&&arguments[12],r=arguments.length>13?arguments[13]:void 0,o=arguments.length>14?arguments[14]:void 0,L=arguments.length>15&&void 0!==arguments[15]&&arguments[15],u=arguments.length>16&&void 0!==arguments[16]&&arguments[16],B=!0;if("object"===typeof t){const D=t;t=!!D.generateMipMaps,n=D.doNotChangeAspectRatio??!0,g=D.type??0,e=!!D.isCube,K=D.samplingMode??M.b.TRILINEAR_SAMPLINGMODE,F=D.generateDepthBuffer??!0,d=!!D.generateStencilBuffer,H=!!D.isMulti,h=D.format??5,x=!!D.delayAllocation,r=D.samples,o=D.creationFlags,L=!!D.noColorAttachment,u=!!D.useSRGBBuffer,b=D.colorAttachment,B=D.gammaSpace??B,X=D.existingObjectRenderer}if(super(null,G,!t,void 0,K,void 0,void 0,void 0,void 0,h),this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new V.e,this.onAfterUnbindObservable=new V.e,this.onClearObservable=new V.e,this.onResizeObservable=new V.e,this._cleared=!1,this.skipInitialClear=!1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this._dontDisposeObjectRenderer=!1,this.boundingBoxPosition=N.Kl.Zero(),this._disableEngineStages=!1,this._dumpToolsLoading=!1,!(G=this.uD()))return;const I=this.uD().getEngine();this._gammaSpace=B,this._coordinatesMode=M.b.PROJECTION_MODE,this.name=D,this.isRenderTarget=!0,this._initialSizeParameter=l,this._dontDisposeObjectRenderer=!!X,this._processSizeParameter(l),this._objectRenderer=X??new j(D,G,{numPasses:e?6:this.getRenderLayers()||1,doNotChangeAspectRatio:n}),this._onBeforeRenderingManagerRenderObserver=this._objectRenderer.onBeforeRenderingManagerRenderObservable.add((()=>{if(!this._disableEngineStages)for(const D of this._scene._beforeRenderTargetClearStage)D.action(this,this._currentFaceIndex,this._currentLayer);if(this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(I):this.skipInitialClear||I.clear(this.clearColor||this._scene.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),!this._disableEngineStages)for(const D of this._scene._beforeRenderTargetDrawStage)D.action(this,this._currentFaceIndex,this._currentLayer)})),this._onAfterRenderingManagerRenderObserver=this._objectRenderer.onAfterRenderingManagerRenderObservable.add((()=>{var D;if(!this._disableEngineStages)for(const G of this._scene._afterRenderTargetDrawStage)G.action(this,this._currentFaceIndex,this._currentLayer);const l=(null===(D=this._texture)||void 0===D?void 0:D.generateMipMaps)??!1;if(this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex,this._postProcesses,this.ignoreCameraViewport):this._currentUseCameraPostProcess&&this._scene.postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex),!this._disableEngineStages)for(const G of this._scene._afterRenderTargetPostProcessStage)G.action(this,this._currentFaceIndex,this._currentLayer);this._texture&&(this._texture.generateMipMaps=l),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),this._currentDumpForDebug&&(this._dumpTools?this._dumpTools.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),I):R.d.Error("dumpTools module is still being loaded. To speed up the process import dump tools directly in your project"))})),this._onFastPathRenderObserver=this._objectRenderer.onFastPathRenderObservable.add((()=>{this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(I):this.skipInitialClear||I.clear(this.clearColor||this._scene.clearColor,!0,!0,!0)})),this._resizeObserver=I.onResizeObservable.add((()=>{})),this._generateMipMaps=!!t,this._doNotChangeAspectRatio=n,H||(this._renderTargetOptions={generateMipMaps:t,type:g,format:this._format??void 0,samplingMode:this.samplingMode,generateDepthBuffer:F,generateStencilBuffer:d,samples:r,creationFlags:o,noColorAttachment:L,useSRGBBuffer:u,colorAttachment:b,label:this.name},this.samplingMode===M.b.NEAREST_SAMPLINGMODE&&(this.wrapU=M.b.CLAMP_ADDRESSMODE,this.wrapV=M.b.CLAMP_ADDRESSMODE),x||(e?(this._renderTarget=G.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=M.b.INVCUBIC_MODE,this._textureMatrix=N.Matrix.Identity()):this._renderTarget=G.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==r&&(this.samples=r)))}createDepthStencilTexture(){var D;let l=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,G=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],V=arguments.length>2&&void 0!==arguments[2]&&arguments[2],N=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,M=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14,b=arguments.length>5?arguments[5]:void 0;null===(D=this._renderTarget)||void 0===D||D.createDepthStencilTexture(l,G,V,N,M,b)}_processSizeParameter(D){if(D.ratio){this._sizeRatio=D.ratio;const l=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(l.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(l.getRenderHeight(),this._sizeRatio)}}else this._size=D}get samples(){var D;return(null===(D=this._renderTarget)||void 0===D?void 0:D.samples)??this._samples}set samples(D){this._renderTarget&&(this._samples=this._renderTarget.setSamples(D))}addPostProcess(D){if(!this._postProcessManager){const D=this.uD();if(!D)return;this._postProcessManager=new b.c(D),this._postProcesses=new Array}this._postProcesses.push(D),this._postProcesses[0].Rb=!1}clearPostProcesses(){let D=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._postProcesses){if(D)for(const D of this._postProcesses)D.dispose();this._postProcesses=[]}}removePostProcess(D){if(!this._postProcesses)return;const l=this._postProcesses.indexOf(D);-1!==l&&(this._postProcesses.splice(l,1),this._postProcesses.length>0&&(this._postProcesses[0].Rb=!1))}resetRefreshCounter(){this._objectRenderer.resetRefreshCounter()}get refreshRate(){return this._objectRenderer.refreshRate}set refreshRate(D){this._objectRenderer.refreshRate=D}_shouldRender(){return this._objectRenderer.shouldRender()}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){const D=this._size.layers;if(D)return D;const l=this._size.depth;return l||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(D){const l=Math.max(1,this.getRenderSize()*D);this.resize(l)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(D){var l;const G=this.isCube;null===(l=this._renderTarget)||void 0===l||l.dispose(),this._renderTarget=null;const V=this.uD();V&&(this._processSizeParameter(D),this._renderTarget=G?V.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):V.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==this._renderTargetOptions.samples&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(){let D=arguments.length>0&&void 0!==arguments[0]&&arguments[0],l=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._render(D,l)}isReadyForRendering(){this._dumpToolsLoading||(this._dumpToolsLoading=!0,G.e(20).then(G.bind(G,11940)).then((D=>this._dumpTools=D))),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight());const D=this._objectRenderer._checkReadiness();return this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender(),D}_render(){let D=arguments.length>0&&void 0!==arguments[0]&&arguments[0],l=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const G=this.uD();if(G){if(void 0!==this.useCameraPostProcesses&&(D=this.useCameraPostProcesses),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight()),!this.is2DArray&&!this.is3D||this.isMulti)if(this.isCube&&!this.isMulti)for(let V=0;V<6;V++)this._renderToTarget(V,D,l),G.incrementRenderId(),G.resetCachedMaterial();else this._renderToTarget(0,D,l);else for(let V=0;V<this.getRenderLayers();V++)this._renderToTarget(0,D,l,V),G.incrementRenderId(),G.resetCachedMaterial();this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender()}}_bestReflectionRenderTargetDimension(D,l){const G=D*l,V=(0,X.h)(G+16384/(128+G));return Math.min((0,X.b)(D),V)}_bindFrameBuffer(){let D=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const G=this.uD();if(!G)return;const V=G.getEngine();this._renderTarget&&V.bindFramebuffer(this._renderTarget,this.isCube?D:void 0,void 0,void 0,this.ignoreCameraViewport,0,l)}_unbindFrameBuffer(D,l){this._renderTarget&&D.unBindFramebuffer(this._renderTarget,this.isCube,(()=>{this.onAfterRenderObservable.notifyObservers(l)}))}_prepareFrame(D,l,G,V){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses)||this._bindFrameBuffer(l,G):V&&D.postProcessManager._prepareFrame(this._texture)||this._bindFrameBuffer(l,G)}_renderToTarget(D,l,G){var V,N;let M=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const b=this.uD();if(!b)return;const X=b.getEngine();this._currentFaceIndex=D,this._currentLayer=M,this._currentUseCameraPostProcess=l,this._currentDumpForDebug=G,this._prepareFrame(b,D,M,l),null===(V=X._debugPushGroup)||void 0===V||V.call(X,`render to face #${D} layer #${M}`,2),this._objectRenderer.render(D+M,!0),null===(N=X._debugPopGroup)||void 0===N||N.call(X,2),this._unbindFrameBuffer(X,D),this._texture&&this.isCube&&5===D&&X.generateMipMapsForCubemap(this._texture,!0)}setRenderingOrder(D){let l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,G=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,V=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this._objectRenderer.setRenderingOrder(D,l,G,V)}setRenderingAutoClearDepthStencil(D,l){this._objectRenderer.setRenderingAutoClearDepthStencil(D,l)}clone(){const D=this.getSize(),l=new e(this.name,D,this.uD(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return l.eb=this.eb,l.level=this.level,l.coordinatesMode=this.coordinatesMode,this.renderList&&(l.renderList=this.renderList.slice(0)),l}serialize(){if(!this.name)return null;const D=super.serialize();if(D.renderTargetSize=this.getRenderSize(),D.renderList=[],this.renderList)for(let l=0;l<this.renderList.length;l++)D.renderList.push(this.renderList[l].id);return D}disposeFramebufferObjects(){var D;null===(D=this._renderTarget)||void 0===D||D.dispose(!0)}releaseInternalTexture(){var D;null===(D=this._renderTarget)||void 0===D||D.releaseTextures(),this._texture=null}dispose(){var D;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._objectRenderer.onBeforeRenderingManagerRenderObservable.remove(this._onBeforeRenderingManagerRenderObserver),this._objectRenderer.onAfterRenderingManagerRenderObservable.remove(this._onAfterRenderingManagerRenderObserver),this._objectRenderer.onFastPathRenderObservable.remove(this._onFastPathRenderObserver),this._dontDisposeObjectRenderer||this._objectRenderer.dispose(),this.clearPostProcesses(!0),this._resizeObserver&&(this.uD().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null);const l=this.uD();if(!l)return;let G=l.customRenderTargets.indexOf(this);G>=0&&l.customRenderTargets.splice(G,1);for(const V of l.cameras)G=V.customRenderTargets.indexOf(this),G>=0&&V.customRenderTargets.splice(G,1);null===(D=this._renderTarget)||void 0===D||D.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this._objectRenderer._rebuild(),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._objectRenderer.freeRenderingGroups()}getViewCount(){return 1}}e.REFRESHRATE_RENDER_ONCE=j.REFRESHRATE_RENDER_ONCE,e.REFRESHRATE_RENDER_ONEVERYFRAME=j.REFRESHRATE_RENDER_ONEVERYFRAME,e.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=j.REFRESHRATE_RENDER_ONEVERYTWOFRAMES,M.b._CreateRenderTargetTexture=(D,l,G,V,N)=>new e(D,l,G,V)},11870:(D,l,G)=>{function V(D){return 13===D||14===D||15===D||16===D||17===D||18===D||19===D}function N(D){return 13===D||17===D||18===D||19===D}G.d(l,{e:()=>N,g:()=>V})},11856:(D,l,G)=>{function V(D){return void 0===D.getPipelineContext}G.d(l,{e:()=>V})},11822:(D,l,G)=>{G.d(l,{b:()=>R,e:()=>n});var V=G(11788),N=G(11829),M=G(11532),b=G(11617),X=G(11833);G(11837);const t={ID:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class R{constructor(D){let l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t;this._fullscreenViewport=new N.e(0,0,1,1);const G=l.ID??t.ID,M=l.indices??t.indices;this.el=D,this._vertexBuffers={[V.e.PositionKind]:new V.e(D,G,V.e.PositionKind,!1,!1,2)},this._indexBuffer=D.createIndexBuffer(M),this._indexBufferLength=M.length,this._onContextRestoredObserver=D.onContextRestoredObservable.add((()=>{this._indexBuffer=D.createIndexBuffer(M);for(const D in this._vertexBuffers){this._vertexBuffers[D]._rebuild()}}))}setViewport(){let D=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._fullscreenViewport;this.el.setViewport(D)}bindBuffers(D){this.el.bindBuffers(this._vertexBuffers,this._indexBuffer,D)}applyEffectWrapper(D){this.el.setState(!0),this.el.depthCullingState.depthTest=!1,this.el.stencilState.stencilTest=!1,this.el.enableEffect(D.drawWrapper),this.bindBuffers(D.effect),D.onApplyObservable.notifyObservers({})}saveStates(){this._savedStateDepthTest=this.el.depthCullingState.depthTest,this._savedStateStencilTest=this.el.stencilState.stencilTest}restoreStates(){this.el.depthCullingState.depthTest=this._savedStateDepthTest,this.el.stencilState.stencilTest=this._savedStateStencilTest}draw(){this.el.drawElementsType(0,0,this._indexBufferLength)}_isRenderTargetTexture(D){return void 0!==D.renderTarget}render(D){let l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!D.effect.isReady())return;this.saveStates(),this.setViewport();const G=null===l?null:this._isRenderTargetTexture(l)?l.renderTarget:l;G&&this.el.bindFramebuffer(G),this.applyEffectWrapper(D),this.draw(),G&&this.el.unBindFramebuffer(G),this.restoreStates()}dispose(){const D=this._vertexBuffers[V.e.PositionKind];D&&(D.dispose(),delete this._vertexBuffers[V.e.PositionKind]),this._indexBuffer&&this.el._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.el.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}}class n{static RegisterShaderCodeProcessing(D,l){l?n._CustomShaderCodeProcessing[D??""]=l:delete n._CustomShaderCodeProcessing[D??""]}static _GetShaderCodeProcessing(D){return n._CustomShaderCodeProcessing[D]??n._CustomShaderCodeProcessing[""]}get name(){return this.options.name}set name(D){this.options.name=D}isReady(){var D;return(null===(D=this._drawWrapper.effect)||void 0===D?void 0:D.isReady())??!1}get drawWrapper(){return this._drawWrapper}get effect(){return this._drawWrapper.effect}set effect(D){this._drawWrapper.effect=D}constructor(D){this.alphaMode=0,this.onEffectCreatedObservable=new M.e(void 0,!0),this.onApplyObservable=new M.e,this._shadersLoaded=!1,this._webGPUReady=!1,this._importPromises=[],this.options={...D,name:D.name||"effectWrapper",el:D.el,uniforms:D.uniforms||D.uniformNames||[],uniformNames:void 0,samplers:D.samplers||D.samplerNames||[],samplerNames:void 0,attributeNames:D.attributeNames||["position"],uniformBuffers:D.uniformBuffers||[],defines:D.defines||"",useShaderStore:D.useShaderStore||!1,vertexUrl:D.vertexUrl||D.vertexShader||"postprocess",vertexShader:void 0,fragmentShader:D.fragmentShader||"pass",indexParameters:D.indexParameters,blockCompilation:D.blockCompilation||!1,shaderLanguage:D.shaderLanguage||0,onCompiled:D.onCompiled||void 0,extraInitializations:D.extraInitializations||void 0,extraInitializationsAsync:D.extraInitializationsAsync||void 0,useAsPostProcess:D.useAsPostProcess??!1},this.options.uniformNames=this.options.uniforms,this.options.samplerNames=this.options.samplers,this.options.vertexShader=this.options.vertexUrl,this.options.useAsPostProcess&&(-1===this.options.samplers.indexOf("textureSampler")&&this.options.samplers.push("textureSampler"),-1===this.options.uniforms.indexOf("scale")&&this.options.uniforms.push("scale")),D.vertexUrl||D.vertexShader?this._shaderPath={vertexSource:this.options.vertexShader}:(this.options.useAsPostProcess||(this.options.uniforms.push("scale"),this.onApplyObservable.add((()=>{this.effect.setFloat2("scale",1,1)}))),this._shaderPath={vertex:this.options.vertexShader}),this._shaderPath.fragmentSource=this.options.fragmentShader,this._shaderPath.spectorName=this.options.name,this.options.useShaderStore&&(this._shaderPath.fragment=this._shaderPath.fragmentSource,this._shaderPath.vertex||(this._shaderPath.vertex=this._shaderPath.vertexSource),delete this._shaderPath.fragmentSource,delete this._shaderPath.vertexSource),this.onApplyObservable.add((()=>{this.bind()})),this.options.useShaderStore||(this._onContextRestoredObserver=this.options.el.onContextRestoredObservable.add((()=>{this.effect._pipelineContext=null,this.effect._prepareEffect()}))),this._drawWrapper=new X.c(this.options.el),this._webGPUReady=1===this.options.shaderLanguage;const l=Array.isArray(this.options.defines)?this.options.defines.join("\n"):this.options.defines;this._postConstructor(this.options.blockCompilation,l,this.options.extraInitializations)}_gatherImports(){let D=arguments.length>0&&void 0!==arguments[0]&&arguments[0],l=arguments.length>1?arguments[1]:void 0;this.options.useAsPostProcess&&(D&&this._webGPUReady?l.push(Promise.all([G.e(53).then(G.bind(G,14175))])):l.push(Promise.all([Promise.resolve().then(G.bind(G,11837))])))}_postConstructor(D){let l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,G=arguments.length>2?arguments[2]:void 0,V=arguments.length>3?arguments[3]:void 0;this._importPromises.length=0,V&&this._importPromises.push(...V);const N=this.options.el.isWebGPU&&!n.ForceGLSL;this._gatherImports(N,this._importPromises),void 0!==G&&G(N,this._importPromises),N&&this._webGPUReady&&(this.options.shaderLanguage=1),D||this.updateEffect(l)}updateEffect(){let D=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,G=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,V=arguments.length>3?arguments[3]:void 0,N=arguments.length>4?arguments[4]:void 0,M=arguments.length>5?arguments[5]:void 0,X=arguments.length>6?arguments[6]:void 0,t=arguments.length>7?arguments[7]:void 0;const R=n._GetShaderCodeProcessing(this.name);if(null!==R&&void 0!==R&&R.defineCustomBindings){var g,j;const V=(null===(g=l)||void 0===g?void 0:g.slice())??[];V.push(...this.options.uniforms);const N=(null===(j=G)||void 0===j?void 0:j.slice())??[];N.push(...this.options.samplers),D=R.defineCustomBindings(this.name,D,V,N),l=V,G=N}this.options.defines=D||"";const e=this._shadersLoaded||0===this._importPromises.length?void 0:async()=>{await Promise.all(this._importPromises),this._shadersLoaded=!0};let K;K=this.options.extraInitializationsAsync?async()=>{null===e||void 0===e||e(),await this.options.extraInitializationsAsync()}:e,this.options.useShaderStore?this._drawWrapper.effect=this.options.el.createEffect({vertex:X??this._shaderPath.vertex,fragment:t??this._shaderPath.fragment},{attributes:this.options.attributeNames,uniformsNames:l||this.options.uniforms,uniformBuffersNames:this.options.uniformBuffers,samplers:G||this.options.samplers,defines:null!==D?D:"",fallbacks:null,onCompiled:N??this.options.onCompiled,onError:M??null,indexParameters:V||this.options.indexParameters,processCodeAfterIncludes:null!==R&&void 0!==R&&R.processCodeAfterIncludes?(D,l)=>R.processCodeAfterIncludes(this.name,D,l):null,processFinalCode:null!==R&&void 0!==R&&R.processFinalCode?(D,l)=>R.processFinalCode(this.name,D,l):null,shaderLanguage:this.options.shaderLanguage,extraInitializationsAsync:K},this.options.el):this._drawWrapper.effect=new b.Effect(this._shaderPath,this.options.attributeNames,l||this.options.uniforms,G||this.options.samplerNames,this.options.el,D,void 0,N||this.options.onCompiled,void 0,void 0,void 0,this.options.shaderLanguage,K),this.onEffectCreatedObservable.notifyObservers(this._drawWrapper.effect)}bind(){var D,l;let G=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.options.useAsPostProcess&&!G&&(this.options.el.setAlphaMode(this.alphaMode),this.drawWrapper.effect.setFloat2("scale",1,1)),null===(D=n._GetShaderCodeProcessing(this.name))||void 0===D||null===(l=D.bindCustomBindings)||void 0===l||l.call(D,this.name,this._drawWrapper.effect)}dispose(){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.onEffectCreatedObservable.clear(),this._drawWrapper.dispose(!0)}}n.ForceGLSL=!1,n._CustomShaderCodeProcessing={}},11915:(D,l,G)=>{G.d(l,{b:()=>b});var V,N,M=G(11710);!function(D){D[D.LOCAL=0]="LOCAL",D[D.WORLD=1]="WORLD",D[D.BONE=2]="BONE"}(V||(V={}));class b{}b.X=new M.Kl(1,0,0),b.Y=new M.Kl(0,1,0),b.Z=new M.Kl(0,0,1),function(D){D[D.X=0]="X",D[D.Y=1]="Y",D[D.Z=2]="Z"}(N||(N={}))},11906:(D,l,G)=>{G.d(l,{d:()=>V.Matrix,f:()=>V.Quaternion,g:()=>V.TmpVectors,i:()=>V.Kl});G(11915),G(11755),G(11713),G(11923),G(11925),G(11759),G(11734);var V=G(11710);G(11829)},11925:(D,l,G)=>{G.d(l,{c:()=>X,e:()=>j,i:()=>n,j:()=>g});var V,N=G(11728),M=G(11710),b=G(11713);!function(D){D[D.CW=0]="CW",D[D.CCW=1]="CCW"}(V||(V={}));class X{static Interpolate(D,l,G,V,N){if(0===D)return 0;const M=1-3*V+3*l,b=3*V-6*l,X=3*l;let t=D;for(let R=0;R<5;R++){const l=t*t;t-=(M*(l*t)+b*l+X*t-D)*(1/(3*M*l+2*b*t+X)),t=Math.min(1,Math.max(0,t))}return 3*Math.pow(1-t,2)*t*G+3*(1-t)*Math.pow(t,2)*N+Math.pow(t,3)}}class t{constructor(D){this._radians=D,this._radians<0&&(this._radians+=2*Math.PI)}degrees(){return 180*this._radians/Math.PI}radians(){return this._radians}static BetweenTwoPoints(D,l){const G=l.Fl(D),V=Math.atan2(G.y,G.x);return new t(V)}static BetweenTwoVectors(D,l){let G=D.lengthSquared()*l.lengthSquared();if(0===G)return new t(Math.PI/2);G=Math.sqrt(G);let V=D.dot(l)/G;V=(0,N.Clamp)(V,-1,1);const M=Math.acos(V);return new t(M)}static FromRadians(D){return new t(D)}static FromDegrees(D){return new t(D*Math.PI/180)}}class R{constructor(D,l,G){this.startPoint=D,this.midPoint=l,this.endPoint=G;const V=Math.pow(l.x,2)+Math.pow(l.y,2),N=(Math.pow(D.x,2)+Math.pow(D.y,2)-V)/2,b=(V-Math.pow(G.x,2)-Math.pow(G.y,2))/2,X=(D.x-l.x)*(l.y-G.y)-(l.x-G.x)*(D.y-l.y);this.centerPoint=new M.Vector2((N*(l.y-G.y)-b*(D.y-l.y))/X,((D.x-l.x)*b-(l.x-G.x)*N)/X),this.radius=this.centerPoint.Fl(this.startPoint).length(),this.startAngle=t.BetweenTwoPoints(this.centerPoint,this.startPoint);const R=this.startAngle.degrees();let n=t.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),g=t.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();n-R>180&&(n-=360),n-R<-180&&(n+=360),g-n>180&&(g-=360),g-n<-180&&(g+=360),this.orientation=n-R<0?0:1,this.angle=t.FromDegrees(0===this.orientation?R-g:g-R)}}class n{constructor(D,l){this._points=new Array,this._length=0,this.closed=!1,this._points.push(new M.Vector2(D,l))}addLineTo(D,l){if(this.closed)return this;const G=new M.Vector2(D,l),V=this._points[this._points.length-1];return this._points.push(G),this._length+=G.Fl(V).length(),this}addArcTo(D,l,G,V){let N=arguments.length>4&&void 0!==arguments[4]?arguments[4]:36;if(this.closed)return this;const b=this._points[this._points.length-1],X=new M.Vector2(D,l),t=new M.Vector2(G,V),n=new R(b,X,t);let g=n.angle.radians()/N;0===n.orientation&&(g*=-1);let j=n.startAngle.radians()+g;for(let M=0;M<N;M++){const D=Math.cos(j)*n.radius+n.centerPoint.x,l=Math.sin(j)*n.radius+n.centerPoint.y;this.addLineTo(D,l),j+=g}return this}addQuadraticCurveTo(D,l,G,V){let N=arguments.length>4&&void 0!==arguments[4]?arguments[4]:36;if(this.closed)return this;const M=(D,l,G,V)=>(1-D)*(1-D)*l+2*D*(1-D)*G+D*D*V,b=this._points[this._points.length-1];for(let X=0;X<=N;X++){const t=X/N,R=M(t,b.x,D,G),n=M(t,b.y,l,V);this.addLineTo(R,n)}return this}addBezierCurveTo(D,l,G,V,N,M){let b=arguments.length>6&&void 0!==arguments[6]?arguments[6]:36;if(this.closed)return this;const X=(D,l,G,V,N)=>(1-D)*(1-D)*(1-D)*l+3*D*(1-D)*(1-D)*G+3*D*D*(1-D)*V+D*D*D*N,t=this._points[this._points.length-1];for(let R=0;R<=b;R++){const n=R/b,g=X(n,t.x,D,G,N),j=X(n,t.y,l,V,M);this.addLineTo(g,j)}return this}isPointInside(D){let l=!1;const G=this._points.length;for(let V=G-1,N=0;N<G;V=N++){let G=this._points[V],M=this._points[N],b=M.x-G.x,X=M.y-G.y;if(Math.abs(X)>Number.EPSILON){if(X<0&&(G=this._points[N],b=-b,M=this._points[V],X=-X),D.y<G.y||D.y>M.y)continue;if(D.y===G.y&&D.x===G.x)return!0;{const V=X*(D.x-G.x)-b*(D.y-G.y);if(0===V)return!0;if(V<0)continue;l=!l}}else{if(D.y!==G.y)continue;if(M.x<=D.x&&D.x<=G.x||G.x<=D.x&&D.x<=M.x)return!0}}return l}close(){return this.closed=!0,this}length(){let D=this._length;if(this.closed){const l=this._points[this._points.length-1];D+=this._points[0].Fl(l).length()}return D}area(){const D=this._points.length;let l=0;for(let G=D-1,V=0;V<D;G=V++)l+=this._points[G].x*this._points[V].y-this._points[V].x*this._points[G].y;return.5*l}getPoints(){return this._points}getPointAtLengthPosition(D){if(D<0||D>1)return M.Vector2.Zero();const l=D*this.length();let G=0;for(let V=0;V<this._points.length;V++){const D=(V+1)%this._points.length,N=this._points[V],b=this._points[D].Fl(N),X=b.length()+G;if(l>=G&&l<=X){const D=b.normalize(),V=l-G;return new M.Vector2(N.x+D.x*V,N.y+D.y*V)}G=X}return M.Vector2.Zero()}static StartingAt(D,l){return new n(D,l)}}class g{constructor(D){let l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,G=arguments.length>2?arguments[2]:void 0,V=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.path=D,this._curve=new Array,this._distances=new Array,this._tangents=new Array,this._normals=new Array,this._binormals=new Array,this._pointAtData={id:0,point:M.Kl.Zero(),previousPointArrayIndex:0,position:0,subPosition:0,interpolateReady:!1,interpolationMatrix:M.Matrix.Identity()};for(let N=0;N<D.length;N++)this._curve[N]=D[N].clone();this._raw=G||!1,this._alignTangentsWithPath=V,this._compute(l,V)}getCurve(){return this._curve}getPoints(){return this._curve}length(){return this._distances[this._distances.length-1]}getTangents(){return this._tangents}getNormals(){return this._normals}getBinormals(){return this._binormals}getDistances(){return this._distances}getPointAt(D){return this._updatePointAtData(D).point}getTangentAt(D){let l=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(D,l),l?M.Kl.TransformCoordinates(M.Kl.Forward(),this._pointAtData.interpolationMatrix):this._tangents[this._pointAtData.previousPointArrayIndex]}getNormalAt(D){let l=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(D,l),l?M.Kl.TransformCoordinates(M.Kl.Right(),this._pointAtData.interpolationMatrix):this._normals[this._pointAtData.previousPointArrayIndex]}getBinormalAt(D){let l=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(D,l),l?M.Kl.TransformCoordinates(M.Kl.UpReadOnly,this._pointAtData.interpolationMatrix):this._binormals[this._pointAtData.previousPointArrayIndex]}getDistanceAt(D){return this.length()*D}getPreviousPointIndexAt(D){return this._updatePointAtData(D),this._pointAtData.previousPointArrayIndex}getSubPositionAt(D){return this._updatePointAtData(D),this._pointAtData.subPosition}getClosestPositionTo(D){let l=Number.MAX_VALUE,G=0;for(let V=0;V<this._curve.length-1;V++){const N=this._curve[V+0],b=this._curve[V+1].Fl(N).normalize(),X=this._distances[V+1]-this._distances[V+0],t=Math.min(Math.max(M.Kl.Dot(b,D.Fl(N).normalize()),0)*M.Kl.Distance(N,D)/X,1),R=M.Kl.Distance(N.add(b.scale(t*X)),D);R<l&&(l=R,G=(this._distances[V+0]+X*t)/this.length())}return G}slice(){let D=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(D<0&&(D=1- -1*D%1),l<0&&(l=1- -1*l%1),D>l){const G=D;D=l,l=G}const G=this.getCurve(),V=this.getPointAt(D);let N=this.getPreviousPointIndexAt(D);const M=this.getPointAt(l),b=this.getPreviousPointIndexAt(l)+1,X=[];return 0!==D&&(N++,X.push(V)),X.push(...G.slice(N,b)),1===l&&1!==D||X.push(M),new g(X,this.getNormalAt(D),this._raw,this._alignTangentsWithPath)}update(D){let l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,G=arguments.length>2&&void 0!==arguments[2]&&arguments[2];for(let V=0;V<D.length;V++)this._curve[V].x=D[V].x,this._curve[V].y=D[V].y,this._curve[V].z=D[V].z;return this._compute(l,G),this}_compute(D){let l=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const G=this._curve.length;if(G<2)return;this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[G-1]=this._curve[G-1].Fl(this._curve[G-2]),this._raw||this._tangents[G-1].normalize();const V=this._tangents[0],N=this._normalVector(V,D);let b,X,t,R,n;this._normals[0]=N,this._raw||this._normals[0].normalize(),this._binormals[0]=M.Kl.Cross(V,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;for(let g=1;g<G;g++)b=this._getLastNonNullVector(g),g<G-1&&(X=this._getFirstNonNullVector(g),this._tangents[g]=l?X:b.add(X),this._tangents[g].normalize()),this._distances[g]=this._distances[g-1]+this._curve[g].Fl(this._curve[g-1]).length(),t=this._tangents[g],n=this._binormals[g-1],this._normals[g]=M.Kl.Cross(n,t),this._raw||(0===this._normals[g].length()?(R=this._normals[g-1],this._normals[g]=R.clone()):this._normals[g].normalize()),this._binormals[g]=M.Kl.Cross(t,this._normals[g]),this._raw||this._binormals[g].normalize();this._pointAtData.id=NaN}_getFirstNonNullVector(D){let l=1,G=this._curve[D+l].Fl(this._curve[D]);for(;0===G.length()&&D+l+1<this._curve.length;)l++,G=this._curve[D+l].Fl(this._curve[D]);return G}_getLastNonNullVector(D){let l=1,G=this._curve[D].Fl(this._curve[D-l]);for(;0===G.length()&&D>l+1;)l++,G=this._curve[D].Fl(this._curve[D-l]);return G}_normalVector(D,l){let G,V=D.length();if(0===V&&(V=1),void 0===l||null===l){let l;l=(0,N.WithinEpsilon)(Math.abs(D.y)/V,1,b.b)?(0,N.WithinEpsilon)(Math.abs(D.x)/V,1,b.b)?(0,N.WithinEpsilon)(Math.abs(D.z)/V,1,b.b)?M.Kl.Zero():new M.Kl(0,0,1):new M.Kl(1,0,0):new M.Kl(0,-1,0),G=M.Kl.Cross(D,l)}else G=M.Kl.Cross(D,l),M.Kl.CrossToRef(G,D,G);return G.normalize(),G}_updatePointAtData(D){let l=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._pointAtData.id===D)return this._pointAtData.interpolateReady||this._updateInterpolationMatrix(),this._pointAtData;this._pointAtData.id=D;const G=this.getPoints();if(D<=0)return this._setPointAtData(0,0,G[0],0,l);if(D>=1)return this._setPointAtData(1,1,G[G.length-1],G.length-1,l);let V,N=G[0],b=0;const X=D*this.length();for(let t=1;t<G.length;t++){V=G[t];const R=M.Kl.Distance(N,V);if(b+=R,b===X)return this._setPointAtData(D,1,V,t,l);if(b>X){const G=(b-X)/R,M=N.Fl(V),n=V.add(M.scaleInPlace(G));return this._setPointAtData(D,1-G,n,t-1,l)}N=V}return this._pointAtData}_setPointAtData(D,l,G,V,N){return this._pointAtData.point=G,this._pointAtData.position=D,this._pointAtData.subPosition=l,this._pointAtData.previousPointArrayIndex=V,this._pointAtData.interpolateReady=N,N&&this._updateInterpolationMatrix(),this._pointAtData}_updateInterpolationMatrix(){this._pointAtData.interpolationMatrix=M.Matrix.Identity();const D=this._pointAtData.previousPointArrayIndex;if(D!==this._tangents.length-1){const l=D+1,G=this._tangents[D].clone(),V=this._normals[D].clone(),N=this._binormals[D].clone(),b=this._tangents[l].clone(),X=this._normals[l].clone(),t=this._binormals[l].clone(),R=M.Quaternion.RotationQuaternionFromAxis(V,N,G),n=M.Quaternion.RotationQuaternionFromAxis(X,t,b);M.Quaternion.Slerp(R,n,this._pointAtData.subPosition).toRotationMatrix(this._pointAtData.interpolationMatrix)}}}class j{static CreateQuadraticBezier(D,l,G,V){V=V>2?V:3;const N=[],b=(D,l,G,V)=>(1-D)*(1-D)*l+2*D*(1-D)*G+D*D*V;for(let X=0;X<=V;X++)N.push(new M.Kl(b(X/V,D.x,l.x,G.x),b(X/V,D.y,l.y,G.y),b(X/V,D.z,l.z,G.z)));return new j(N)}static CreateCubicBezier(D,l,G,V,N){N=N>3?N:4;const b=[],X=(D,l,G,V,N)=>(1-D)*(1-D)*(1-D)*l+3*D*(1-D)*(1-D)*G+3*D*D*(1-D)*V+D*D*D*N;for(let t=0;t<=N;t++)b.push(new M.Kl(X(t/N,D.x,l.x,G.x,V.x),X(t/N,D.y,l.y,G.y,V.y),X(t/N,D.z,l.z,G.z,V.z)));return new j(b)}static CreateHermiteSpline(D,l,G,V,N){const b=[],X=1/N;for(let t=0;t<=N;t++)b.push(M.Kl.Hermite(D,l,G,V,t*X));return new j(b)}static CreateCatmullRomSpline(D,l,G){const V=[],N=1/l;let b=0;if(G){const G=D.length;for(let X=0;X<G;X++){b=0;for(let t=0;t<l;t++)V.push(M.Kl.CatmullRom(D[X%G],D[(X+1)%G],D[(X+2)%G],D[(X+3)%G],b)),b+=N}V.push(V[0])}else{const G=[];G.push(D[0].clone()),Array.prototype.push.apply(G,D),G.push(D[D.length-1].clone());let X=0;for(;X<G.length-3;X++){b=0;for(let D=0;D<l;D++)V.push(M.Kl.CatmullRom(G[X],G[X+1],G[X+2],G[X+3],b)),b+=N}X--,V.push(M.Kl.CatmullRom(G[X],G[X+1],G[X+2],G[X+3],b))}return new j(V)}static ArcThru3Points(D,l,G){let V=arguments.length>3&&void 0!==arguments[3]?arguments[3]:32,N=arguments.length>4&&void 0!==arguments[4]&&arguments[4],b=arguments.length>5&&void 0!==arguments[5]&&arguments[5];const X=[],t=l.Fl(D),R=G.Fl(l),n=D.Fl(G),g=M.Kl.Cross(t,R),e=g.length();if(e<Math.pow(10,-8))return new j(X);const K=t.lengthSquared(),F=R.lengthSquared(),d=n.lengthSquared(),H=g.lengthSquared(),h=.5*t.length()*R.length()*n.length()/e,x=-.5*F*M.Kl.Dot(t,n)/H,r=-.5*d*M.Kl.Dot(t,R)/H,o=-.5*K*M.Kl.Dot(R,n)/H,L=D.scale(x).add(l.scale(r)).add(G.scale(o)),u=D.Fl(L).normalize(),B=M.Kl.Cross(g,u).normalize();if(b){const l=2*Math.PI/V;for(let D=0;D<=2*Math.PI;D+=l)X.push(L.add(u.scale(h*Math.cos(D)).add(B.scale(h*Math.sin(D)))));X.push(D)}else{const l=1/V;let b=0,t=M.Kl.Zero();do{t=L.add(u.scale(h*Math.cos(b)).add(B.scale(h*Math.sin(b)))),X.push(t),b+=l}while(!t.equalsWithEpsilon(G,h*l*1.1));X.push(G),N&&X.push(D)}return new j(X)}constructor(D){this._length=0,this._points=D,this._length=this._computeLength(D)}getPoints(){return this._points}length(){return this._length}continue(D){const l=this._points[this._points.length-1],G=this._points.slice(),V=D.getPoints();for(let N=1;N<V.length;N++)G.push(V[N].Fl(V[0]).add(l));return new j(G)}_computeLength(D){let l=0;for(let G=1;G<D.length;G++)l+=D[G].Fl(D[G-1]).length();return l}}},11829:(D,l,G)=>{G.d(l,{e:()=>V});class V{constructor(D,l,G,V){this.x=D,this.y=l,this.width=G,this.height=V}toGlobal(D,l){return new V(this.x*D,this.y*l,this.width*D,this.height*l)}toGlobalToRef(D,l,G){return G.x=this.x*D,G.y=this.y*l,G.width=this.width*D,G.height=this.height*l,this}clone(){return new V(this.x,this.y,this.width,this.height)}}},11904:(D,l,G)=>{G.d(l,{e:()=>R,h:()=>n});var V=G(11710),N=G(11906);const M=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],b=[()=>1,D=>D.y,D=>D.z,D=>D.x,D=>D.x*D.y,D=>D.y*D.z,D=>3*D.z*D.z-1,D=>D.x*D.z,D=>D.x*D.x-D.y*D.y],X=(D,l)=>M[D]*b[D](l),t=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4];class R{constructor(){this.preScaled=!1,this.l00=V.Kl.Zero(),this.l1_1=V.Kl.Zero(),this.l10=V.Kl.Zero(),this.l11=V.Kl.Zero(),this.l2_2=V.Kl.Zero(),this.l2_1=V.Kl.Zero(),this.l20=V.Kl.Zero(),this.l21=V.Kl.Zero(),this.l22=V.Kl.Zero()}addLight(D,l,G){N.g.Kl[0].set(l.r,l.g,l.b);const V=N.g.Kl[0],M=N.g.Kl[1];V.scaleToRef(G,M),M.scaleToRef(X(0,D),N.g.Kl[2]),this.l00.addInPlace(N.g.Kl[2]),M.scaleToRef(X(1,D),N.g.Kl[2]),this.l1_1.addInPlace(N.g.Kl[2]),M.scaleToRef(X(2,D),N.g.Kl[2]),this.l10.addInPlace(N.g.Kl[2]),M.scaleToRef(X(3,D),N.g.Kl[2]),this.l11.addInPlace(N.g.Kl[2]),M.scaleToRef(X(4,D),N.g.Kl[2]),this.l2_2.addInPlace(N.g.Kl[2]),M.scaleToRef(X(5,D),N.g.Kl[2]),this.l2_1.addInPlace(N.g.Kl[2]),M.scaleToRef(X(6,D),N.g.Kl[2]),this.l20.addInPlace(N.g.Kl[2]),M.scaleToRef(X(7,D),N.g.Kl[2]),this.l21.addInPlace(N.g.Kl[2]),M.scaleToRef(X(8,D),N.g.Kl[2]),this.l22.addInPlace(N.g.Kl[2])}scaleInPlace(D){this.l00.scaleInPlace(D),this.l1_1.scaleInPlace(D),this.l10.scaleInPlace(D),this.l11.scaleInPlace(D),this.l2_2.scaleInPlace(D),this.l2_1.scaleInPlace(D),this.l20.scaleInPlace(D),this.l21.scaleInPlace(D),this.l22.scaleInPlace(D)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(t[0]),this.l1_1.scaleInPlace(t[1]),this.l10.scaleInPlace(t[2]),this.l11.scaleInPlace(t[3]),this.l2_2.scaleInPlace(t[4]),this.l2_1.scaleInPlace(t[5]),this.l20.scaleInPlace(t[6]),this.l21.scaleInPlace(t[7]),this.l22.scaleInPlace(t[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(M[0]),this.l1_1.scaleInPlace(M[1]),this.l10.scaleInPlace(M[2]),this.l11.scaleInPlace(M[3]),this.l2_2.scaleInPlace(M[4]),this.l2_1.scaleInPlace(M[5]),this.l20.scaleInPlace(M[6]),this.l21.scaleInPlace(M[7]),this.l22.scaleInPlace(M[8])}updateFromArray(D){return V.Kl.FromArrayToRef(D[0],0,this.l00),V.Kl.FromArrayToRef(D[1],0,this.l1_1),V.Kl.FromArrayToRef(D[2],0,this.l10),V.Kl.FromArrayToRef(D[3],0,this.l11),V.Kl.FromArrayToRef(D[4],0,this.l2_2),V.Kl.FromArrayToRef(D[5],0,this.l2_1),V.Kl.FromArrayToRef(D[6],0,this.l20),V.Kl.FromArrayToRef(D[7],0,this.l21),V.Kl.FromArrayToRef(D[8],0,this.l22),this}updateFromFloatsArray(D){return V.Kl.FromFloatsToRef(D[0],D[1],D[2],this.l00),V.Kl.FromFloatsToRef(D[3],D[4],D[5],this.l1_1),V.Kl.FromFloatsToRef(D[6],D[7],D[8],this.l10),V.Kl.FromFloatsToRef(D[9],D[10],D[11],this.l11),V.Kl.FromFloatsToRef(D[12],D[13],D[14],this.l2_2),V.Kl.FromFloatsToRef(D[15],D[16],D[17],this.l2_1),V.Kl.FromFloatsToRef(D[18],D[19],D[20],this.l20),V.Kl.FromFloatsToRef(D[21],D[22],D[23],this.l21),V.Kl.FromFloatsToRef(D[24],D[25],D[26],this.l22),this}static xl(D){return(new R).updateFromArray(D)}static FromPolynomial(D){const l=new R;return l.l00=D.xx.scale(.376127).add(D.yy.scale(.376127)).add(D.zz.scale(.376126)),l.l1_1=D.y.scale(.977204),l.l10=D.z.scale(.977204),l.l11=D.x.scale(.977204),l.l2_2=D.xy.scale(1.16538),l.l2_1=D.yz.scale(1.16538),l.l20=D.zz.scale(1.34567).Fl(D.xx.scale(.672834)).Fl(D.yy.scale(.672834)),l.l21=D.zx.scale(1.16538),l.l22=D.xx.scale(1.16538).Fl(D.yy.scale(1.16538)),l.l1_1.scaleInPlace(-1),l.l11.scaleInPlace(-1),l.l2_1.scaleInPlace(-1),l.l21.scaleInPlace(-1),l.scaleInPlace(Math.PI),l}}class n{constructor(){this.x=V.Kl.Zero(),this.y=V.Kl.Zero(),this.z=V.Kl.Zero(),this.xx=V.Kl.Zero(),this.yy=V.Kl.Zero(),this.zz=V.Kl.Zero(),this.xy=V.Kl.Zero(),this.yz=V.Kl.Zero(),this.zx=V.Kl.Zero()}get preScaledHarmonics(){return this._harmonics||(this._harmonics=R.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(D){N.g.Kl[0].Lb(D.r,D.g,D.b);const l=N.g.Kl[0];this.xx.addInPlace(l),this.yy.addInPlace(l),this.zz.addInPlace(l)}scaleInPlace(D){this.x.scaleInPlace(D),this.y.scaleInPlace(D),this.z.scaleInPlace(D),this.xx.scaleInPlace(D),this.yy.scaleInPlace(D),this.zz.scaleInPlace(D),this.yz.scaleInPlace(D),this.zx.scaleInPlace(D),this.xy.scaleInPlace(D)}updateFromHarmonics(D){return this._harmonics=D,this.x.V(D.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.V(D.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.V(D.l10),this.z.scaleInPlace(1.02333),this.xx.V(D.l00),N.g.Kl[0].V(D.l20).scaleInPlace(.247708),N.g.Kl[1].V(D.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).Kg(N.g.Kl[0]).addInPlace(N.g.Kl[1]),this.yy.V(D.l00),this.yy.scaleInPlace(.886277).Kg(N.g.Kl[0]).Kg(N.g.Kl[1]),this.zz.V(D.l00),N.g.Kl[0].V(D.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(N.g.Kl[0]),this.yz.V(D.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.V(D.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.V(D.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(D){return(new n).updateFromHarmonics(D)}static xl(D){const l=new n;return V.Kl.FromArrayToRef(D[0],0,l.x),V.Kl.FromArrayToRef(D[1],0,l.y),V.Kl.FromArrayToRef(D[2],0,l.z),V.Kl.FromArrayToRef(D[3],0,l.xx),V.Kl.FromArrayToRef(D[4],0,l.yy),V.Kl.FromArrayToRef(D[5],0,l.zz),V.Kl.FromArrayToRef(D[6],0,l.yz),V.Kl.FromArrayToRef(D[7],0,l.zx),V.Kl.FromArrayToRef(D[8],0,l.xy),l}}},11865:(D,l,G)=>{G.d(l,{d:()=>N});var V=G(11793);class N extends V.b{constructor(D){super(),this._buffer=D}get underlyingResource(){return this._buffer}}},11948:(D,l,G)=>{G.d(l,{e:()=>H,f:()=>o,h:()=>u,i:()=>B,k:()=>r});var V=G(11686),N=G(11776),M=G(11695),b=G(11820),X=G(11613),t=G(11667),R=G(11739),n=G(11822),g=G(11843);class j extends n.e{_gatherImports(D,l){D?(this._webGPUReady=!0,l.push(Promise.all([G.e(51).then(G.bind(G,14160))]))):l.push(Promise.all([G.e(52).then(G.bind(G,14169))])),super._gatherImports(D,l)}constructor(D){super({...arguments.length>2?arguments[2]:void 0,name:D,el:(arguments.length>1&&void 0!==arguments[1]?arguments[1]:null)||g.e.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:j.FragmentUrl})}}j.FragmentUrl="pass";class e extends n.e{_gatherImports(D,l){D?(this._webGPUReady=!0,l.push(Promise.all([G.e(62).then(G.bind(G,14218))]))):l.push(Promise.all([G.e(63).then(G.bind(G,14225))])),super._gatherImports(D,l)}constructor(D){super({...arguments.length>2?arguments[2]:void 0,name:D,el:(arguments.length>1&&void 0!==arguments[1]?arguments[1]:null)||g.e.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:e.FragmentUrl,defines:"#define POSITIVEX"}),this._face=0}get face(){return this._face}set face(D){if(!(D<0||D>5))switch(this._face=D,this._face){case 0:this.updateEffect("#define POSITIVEX");break;case 1:this.updateEffect("#define NEGATIVEX");break;case 2:this.updateEffect("#define POSITIVEY");break;case 3:this.updateEffect("#define NEGATIVEY");break;case 4:this.updateEffect("#define POSITIVEZ");break;case 5:this.updateEffect("#define NEGATIVEZ")}}}e.FragmentUrl="passCube";var K=G(11703);class F extends b.c{getClassName(){return"PassPostProcess"}constructor(D,l){let G=arguments.length>4?arguments[4]:void 0;const V={size:"number"===typeof l?l:void 0,camera:arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,samplingMode:arguments.length>3?arguments[3]:void 0,el:G,reusable:arguments.length>5?arguments[5]:void 0,textureType:arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,blockCompilation:arguments.length>7&&void 0!==arguments[7]&&arguments[7],...l};super(D,j.FragmentUrl,{effectWrapper:"number"!==typeof l&&l.effectWrapper?void 0:new j(D,G,V),...V})}static _Parse(D,l,G,V){return R.c.Parse((()=>new F(D.name,D.options,l,D.renderTargetSamplingMode,D._engine,D.reusable)),D,G,V)}}(0,t.c)("BABYLON.PassPostProcess",F);class d extends b.c{get face(){return this._effectWrapper.face}set face(D){this._effectWrapper.face=D}getClassName(){return"PassCubePostProcess"}constructor(D,l){let G=arguments.length>4?arguments[4]:void 0;const V={size:"number"===typeof l?l:void 0,camera:arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,samplingMode:arguments.length>3?arguments[3]:void 0,el:G,reusable:arguments.length>5?arguments[5]:void 0,textureType:arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,blockCompilation:arguments.length>7&&void 0!==arguments[7]&&arguments[7],...l};super(D,j.FragmentUrl,{effectWrapper:"number"!==typeof l&&l.effectWrapper?void 0:new e(D,G,V),...V})}static _Parse(D,l,G,V){return R.c.Parse((()=>new d(D.name,D.options,l,D.renderTargetSamplingMode,D._engine,D.reusable)),D,G,V)}}function H(D,l,G,V,N,M,X,t){const R=l.getEngine();return l.isReady=!1,N=N??l.samplingMode,V=V??l.type,M=M??l.format,X=X??l.width,t=t??l.height,-1===V&&(V=0),new Promise((n=>{const g=new b.c("postprocess",D,null,null,1,null,N,R,!1,void 0,V,void 0,null,!1,M);g.externalTextureSamplerBinding=!0;const j=R.createRenderTargetTexture({width:X,height:t},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:N,type:V,format:M});g.onEffectCreatedObservable.addOnce((D=>{D.executeWhenCompiled((()=>{g.onApply=D=>{D._bindTexture("textureSampler",l),D.setFloat2("scale",1,1)},G.postProcessManager.directRender([g],j,!0),R.restoreDefaultFramebuffer(),R._releaseTexture(l),g&&g.dispose(),j._swapAndDie(l),l.type=V,l.format=5,l.isReady=!0,n(l)}))}))}))}let h,x;function r(D){h||(h=new Float32Array(1),x=new Int32Array(h.buffer)),h[0]=D;const l=x[0];let G=l>>16&32768,V=l>>12&2047;const N=l>>23&255;return N<103?G:N>142?(G|=31744,G|=(255==N?0:1)&&8388607&l,G):N<113?(V|=2048,G|=(V>>114-N)+(V>>113-N&1),G):(G|=N-112<<10|V>>1,G+=1&V,G)}function o(D){const l=(32768&D)>>15,G=(31744&D)>>10,V=1023&D;return 0===G?(l?-1:1)*Math.pow(2,-14)*(V/Math.pow(2,10)):31==G?V?NaN:1/0*(l?-1:1):(l?-1:1)*Math.pow(2,G-15)*(1+V/Math.pow(2,10))}(0,M.b)([(0,K.L)()],d.prototype,"face",null),X.e._RescalePostProcessFactory=D=>new F("rescale",1,null,2,D,!1,0);const L=async(D,l,M,X,t)=>{const R=D.uD(),n=R.getEngine();let g;if(n.isWebGPU?D.isCube?await G.e(60).then(G.bind(G,14209)):await G.e(61).then(G.bind(G,14211)):D.isCube?await G.e(58).then(G.bind(G,14202)):await G.e(59).then(G.bind(G,14207)),D.isCube){const D=["#define POSITIVEX","#define NEGATIVEX","#define POSITIVEY","#define NEGATIVEY","#define POSITIVEZ","#define NEGATIVEZ"];g=new b.c("lodCube","lodCube",{uniforms:["lod","gamma"],samplingMode:V.b.NEAREST_NEAREST_MIPNEAREST,el:n,defines:D[X],shaderLanguage:n.isWebGPU?1:0})}else g=new b.c("lod","lod",{uniforms:["lod","gamma"],samplingMode:V.b.NEAREST_NEAREST_MIPNEAREST,el:n,shaderLanguage:n.isWebGPU?1:0});await new Promise((D=>{g.onEffectCreatedObservable.addOnce((l=>{l.executeWhenCompiled((()=>{D(0)}))}))}));const j=new N.d("temp",{width:l,height:M},R,!1);g.onApply=function(l){l.setTexture("textureSampler",D),l.setFloat("lod",t),l.setInt("gamma",D.gammaSpace?1:0)};const e=D.getInternalTexture();try{if(j.renderTarget&&e){const G=e.samplingMode;0!==t?D.updateSamplingMode(V.b.NEAREST_NEAREST_MIPNEAREST):D.updateSamplingMode(V.b.NEAREST_NEAREST),R.postProcessManager.directRender([g],j.renderTarget,!0),D.updateSamplingMode(G);const N=await n.readPixels(0,0,l,M),b=new Uint8Array(N.buffer,0,N.byteLength);return n.unBindFramebuffer(j.renderTarget),b}throw Error("Render to texture failed.")}finally{j.dispose(),g.dispose()}};async function u(D,l,G){let V=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,N=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;return!D.isReady()&&D._texture&&await new Promise(((l,G)=>{null!==D._texture?D._texture.onLoadedObservable.addOnce((()=>{l(0)})):G(0)})),await L(D,l,G,V,N)}const B={CreateResizedCopy:function(D,l,G){let M=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const b=D.uD(),X=b.getEngine(),t=new N.d("resized"+D.name,{width:l,height:G},b,!D.noMipmap,!0,D._texture.type,!1,D.samplingMode,!1);t.wrapU=D.wrapU,t.wrapV=D.wrapV,t.uOffset=D.uOffset,t.vOffset=D.vOffset,t.uScale=D.uScale,t.vScale=D.vScale,t.uAng=D.uAng,t.vAng=D.vAng,t.wAng=D.wAng,t.coordinatesIndex=D.coordinatesIndex,t.level=D.level,t.anisotropicFilteringLevel=D.anisotropicFilteringLevel,t._texture.isReady=!1,D.wrapU=V.b.CLAMP_ADDRESSMODE,D.wrapV=V.b.CLAMP_ADDRESSMODE;const R=new F("pass",1,null,M?V.b.BILINEAR_SAMPLINGMODE:V.b.NEAREST_SAMPLINGMODE,X,!1,0);return R.externalTextureSamplerBinding=!0,R.onEffectCreatedObservable.addOnce((l=>{l.executeWhenCompiled((()=>{R.onApply=function(l){l.setTexture("textureSampler",D)};const l=t.renderTarget;l&&(b.postProcessManager.directRender([R],l),X.unBindFramebuffer(l),t.disposeFramebufferObjects(),R.dispose(),t.getInternalTexture().isReady=!0)}))})),t},ApplyPostProcess:H,ToHalfFloat:r,FromHalfFloat:o,GetTextureDataAsync:u}},11820:(D,l,G)=>{G.d(l,{c:()=>K});var V=G(11695),N=G(11811),M=G(11532),b=G(11710),X=G(11617),t=G(11703),R=G(11739),n=G(11667),g=G(11613),j=G(11675),e=G(11822);g.e.prototype.setTextureFromPostProcess=function(D,l,G){var V;let N=null;l&&(l._forcedOutputTexture?N=l._forcedOutputTexture:l._textures.data[l._currentRenderTextureInd]&&(N=l._textures.data[l._currentRenderTextureInd])),this._bindTexture(D,(null===(V=N)||void 0===V?void 0:V.texture)??null,G)},g.e.prototype.setTextureFromPostProcessOutput=function(D,l,G){var V;this._bindTexture(D,(null===l||void 0===l||null===(V=l._outputTexture)||void 0===V?void 0:V.texture)??null,G)},X.Effect.prototype.setTextureFromPostProcess=function(D,l){this._engine.setTextureFromPostProcess(this._samplers[D],l,D)},X.Effect.prototype.setTextureFromPostProcessOutput=function(D,l){this._engine.setTextureFromPostProcessOutput(this._samplers[D],l,D)};class K{static get ForceGLSL(){return e.e.ForceGLSL}static set ForceGLSL(D){e.e.ForceGLSL=D}static RegisterShaderCodeProcessing(D,l){e.e.RegisterShaderCodeProcessing(D,l)}get name(){return this._effectWrapper.name}set name(D){this._effectWrapper.name=D}get alphaMode(){return this._effectWrapper.alphaMode}set alphaMode(D){this._effectWrapper.alphaMode=D}get samples(){return this._samples}set samples(D){this._samples=Math.min(D,this._engine.getCaps().maxMSAASamples),this._textures.forEach((D=>{D.setSamples(this._samples)}))}get shaderLanguage(){return this._shaderLanguage}getEffectName(){return this._fragmentUrl}set onActivate(D){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),D&&(this._onActivateObserver=this.onActivateObservable.add(D))}set onSizeChanged(D){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(D)}set onApply(D){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(D)}set onBeforeRender(D){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(D)}set onAfterRender(D){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(D)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(D){this._forcedOutputTexture=D}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.Lb(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(D,l,G,V,X,t){var R;let n=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,g=arguments.length>7?arguments[7]:void 0,j=arguments.length>8?arguments[8]:void 0,F=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,d=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0,H=arguments.length>11&&void 0!==arguments[11]?arguments[11]:"postprocess",h=arguments.length>12?arguments[12]:void 0,x=arguments.length>13&&void 0!==arguments[13]&&arguments[13],r=arguments.length>14&&void 0!==arguments[14]?arguments[14]:5,o=arguments.length>15?arguments[15]:void 0,L=arguments.length>16?arguments[16]:void 0;this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.Rb=!0,this.forceAutoClearInAlphaMode=!1,this.animations=[],this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._webGPUReady=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new N.f(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new b.Vector2(1,1),this._texelSize=b.Vector2.Zero(),this.onActivateObservable=new M.e,this.onSizeChangedObservable=new M.e,this.onApplyObservable=new M.e,this.onBeforeRenderObservable=new M.e,this.onAfterRenderObservable=new M.e,this.Vb=new M.e;let u,B=1,I=null;if(G&&!Array.isArray(G)){const D=G;G=D.uniforms??null,V=D.samplers??null,B=D.size??1,t=D.camera??null,n=D.samplingMode??1,g=D.el,j=D.reusable,F=Array.isArray(D.defines)?D.defines.join("\n"):D.defines??null,d=D.textureType??0,H=D.vertexUrl??"postprocess",h=D.indexParameters,x=D.blockCompilation??!1,r=D.textureFormat??5,o=D.shaderLanguage??0,I=D.uniformBuffers??null,L=D.extraInitializations,u=D.effectWrapper}else X&&(B="number"===typeof X?X:{width:X.width,height:X.height});if(this._useExistingThinPostProcess=!!u,this._effectWrapper=u??new e.e({name:D,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:l,el:g||(null===(R=t)||void 0===R?void 0:R.uD().getEngine()),uniforms:G,samplers:V,uniformBuffers:I,defines:F,vertexUrl:H,indexParameters:h,blockCompilation:!0,shaderLanguage:o,extraInitializations:void 0}),this.name=D,this.onEffectCreatedObservable=this._effectWrapper.onEffectCreatedObservable,null!=t?(this._camera=t,this._scene=t.uD(),t.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):g&&(this._engine=g,this._engine.postProcesses.push(this)),this._options=B,this.renderTargetSamplingMode=n||1,this._reusable=j||!1,this._textureType=d,this._textureFormat=r,this._shaderLanguage=o||0,this._samplers=V||[],-1===this._samplers.indexOf("textureSampler")&&this._samplers.push("textureSampler"),this._fragmentUrl=l,this._vertexUrl=H,this._parameters=G||[],-1===this._parameters.indexOf("scale")&&this._parameters.push("scale"),this._uniformBuffers=I||[],this._indexParameters=h,!this._useExistingThinPostProcess){this._webGPUReady=1===this._shaderLanguage;const D=[];this._gatherImports(this._engine.isWebGPU&&!K.ForceGLSL,D),this._effectWrapper._webGPUReady=this._webGPUReady,this._effectWrapper._postConstructor(x,F,L,D)}}_gatherImports(){let D=arguments.length>1?arguments[1]:void 0;arguments.length>0&&void 0!==arguments[0]&&arguments[0]&&this._webGPUReady?D.push(Promise.all([G.e(53).then(G.bind(G,14175))])):D.push(Promise.all([Promise.resolve().then(G.bind(G,11837))]))}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._effectWrapper.drawWrapper.effect}shareOutputWith(D){return this._disposeTextures(),this._shareOutputWithPostProcess=D,this}useOwnOutput(){0==this._textures.length&&(this._textures=new N.f(2)),this._shareOutputWithPostProcess=null}updateEffect(){let D=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,G=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,V=arguments.length>3?arguments[3]:void 0,N=arguments.length>4?arguments[4]:void 0,M=arguments.length>5?arguments[5]:void 0,b=arguments.length>6?arguments[6]:void 0,X=arguments.length>7?arguments[7]:void 0;this._effectWrapper.updateEffect(D,l,G,V,N,M,b,X),this._postProcessDefines=Array.isArray(this._effectWrapper.options.defines)?this._effectWrapper.options.defines.join("\n"):this._effectWrapper.options.defines}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(D,l){let G=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;for(let N=0;N<this._textureCache.length;N++)if(this._textureCache[N].texture.width===D.width&&this._textureCache[N].texture.height===D.height&&this._textureCache[N].postProcessChannel===G&&this._textureCache[N].texture._generateDepthBuffer===l.generateDepthBuffer&&this._textureCache[N].texture.samples===l.samples)return this._textureCache[N].texture;const V=this._engine.createRenderTargetTexture(D,l);return this._textureCache.push({texture:V,postProcessChannel:G,lastUsedRenderId:-1}),V}_flushTextureCache(){const D=this._renderId;for(let l=this._textureCache.length-1;l>=0;l--)if(D-this._textureCache[l].lastUsedRenderId>100){let D=!1;for(let G=0;G<this._textures.length;G++)if(this._textures.data[G]===this._textureCache[l].texture){D=!0;break}D||(this._textureCache[l].texture.dispose(),this._textureCache.splice(l,1))}}resize(D,l){let G=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,V=arguments.length>3&&void 0!==arguments[3]&&arguments[3],N=arguments.length>4&&void 0!==arguments[4]&&arguments[4];this._textures.length>0&&this._textures.reset(),this.width=D,this.height=l;let M=null;if(G)for(let t=0;t<G._postProcesses.length;t++)if(null!==G._postProcesses[t]){M=G._postProcesses[t];break}const b={width:this.width,height:this.height},X={generateMipMaps:V,generateDepthBuffer:N||M===this,generateStencilBuffer:(N||M===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples,label:"PostProcessRTT-"+this.name};this._textures.push(this._createRenderTargetTexture(b,X,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(b,X,1)),this._texelSize.Lb(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}_getTarget(){let D;if(this._shareOutputWithPostProcess)D=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)D=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{let l;D=this.inputTexture;for(let G=0;G<this._textureCache.length;G++)if(this._textureCache[G].texture===D){l=this._textureCache[G];break}l&&(l.lastUsedRenderId=this._renderId)}return D}activate(D){var l,G;let V=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,N=arguments.length>2?arguments[2]:void 0;const M=null===D||void 0!==D.cameraRigMode?D||this._camera:null,b=(null===M||void 0===M?void 0:M.uD())??D,X=b.getEngine(),t=X.getCaps().maxTextureSize,R=(V?V.width:this._engine.getRenderWidth(!0))*this._options|0,n=(V?V.height:this._engine.getRenderHeight(!0))*this._options|0;let g=this._options.width||R,e=this._options.height||n;const K=7!==this.renderTargetSamplingMode&&1!==this.renderTargetSamplingMode&&2!==this.renderTargetSamplingMode;let F=null;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const D=X.currentViewport;D&&(g*=D.width,e*=D.height)}(K||this.alwaysForcePOT)&&(this._options.width||(g=X.needPOTTextures?(0,j.e)(g,t,this.scaleMode):g),this._options.height||(e=X.needPOTTextures?(0,j.e)(e,t,this.scaleMode):e)),this.width===g&&this.height===e&&(F=this._getTarget())||this.resize(g,e,M,K,N),this._textures.forEach((D=>{D.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(D,this.samples)})),this._flushTextureCache(),this._renderId++}return F||(F=this._getTarget()),this.enablePixelPerfectMode?(this._scaleRatio.Lb(R/g,n/e),this._engine.bindFramebuffer(F,0,R,n,this.forceFullscreenViewport)):(this._scaleRatio.Lb(1,1),this._engine.bindFramebuffer(F,0,void 0,void 0,this.forceFullscreenViewport)),null===(l=(G=this._engine)._debugInsertMarker)||void 0===l||l.call(G,`post process ${this.name} input`),this.onActivateObservable.notifyObservers(M),this.Rb&&(0===this.alphaMode||this.forceAutoClearInAlphaMode)&&this._engine.clear(this.clearColor?this.clearColor:b.clearColor,b._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),F}get isSupported(){return this._effectWrapper.drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){return this._effectWrapper.isReady()}apply(){if(!this._effectWrapper.isReady())return null;let D;var l;(this._engine.enableEffect(this._effectWrapper.drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a),this._engine.setAlphaMode(this.alphaMode),D=this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?this._forcedOutputTexture:this.inputTexture,this.externalTextureSamplerBinding)||this._effectWrapper.drawWrapper.effect._bindTexture("textureSampler",null===(l=D)||void 0===l?void 0:l.texture);return this._effectWrapper.drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._effectWrapper.drawWrapper.effect),this._effectWrapper.bind(!0),this._effectWrapper.drawWrapper.effect}_disposeTextures(){this._shareOutputWithPostProcess||this._forcedOutputTexture?this._disposeTextureCache():(this._disposeTextureCache(),this._textures.dispose())}_disposeTextureCache(){for(let D=this._textureCache.length-1;D>=0;D--)this._textureCache[D].texture.dispose();this._textureCache.length=0}setPrePassRenderer(D){return!!this._prePassEffectConfiguration&&(this._prePassEffectConfiguration=D.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0)}dispose(D){let l;if(D=D||this._camera,this._useExistingThinPostProcess||this._effectWrapper.dispose(),this._disposeTextures(),this._scene&&(l=this._scene.postProcesses.indexOf(this),-1!==l&&this._scene.postProcesses.splice(l,1)),this._parentContainer){const D=this._parentContainer.postProcesses.indexOf(this);D>-1&&this._parentContainer.postProcesses.splice(D,1),this._parentContainer=null}if(l=this._engine.postProcesses.indexOf(this),-1!==l&&this._engine.postProcesses.splice(l,1),this.Vb.notifyObservers(),D){if(D.detachPostProcess(this),l=D._postProcesses.indexOf(this),0===l&&D._postProcesses.length>0){const D=this._camera._getFirstPostProcess();D&&D.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear(),this.onEffectCreatedObservable.clear()}}serialize(){const D=R.c.Serialize(this),l=this.getCamera()||this._scene&&this._scene.activeCamera;return D.customType="BABYLON."+this.getClassName(),D.cameraId=l?l.id:null,D.reusable=this._reusable,D.textureType=this._textureType,D.fragmentUrl=this._fragmentUrl,D.parameters=this._parameters,D.samplers=this._samplers,D.uniformBuffers=this._uniformBuffers,D.options=this._options,D.defines=this._postProcessDefines,D.textureFormat=this._textureFormat,D.vertexUrl=this._vertexUrl,D.indexParameters=this._indexParameters,D}clone(){const D=this.serialize();D._engine=this._engine,D.cameraId=null;const l=K.Parse(D,this._scene,"");return l?(l.onActivateObservable=this.onActivateObservable.clone(),l.onSizeChangedObservable=this.onSizeChangedObservable.clone(),l.onApplyObservable=this.onApplyObservable.clone(),l.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),l.onAfterRenderObservable=this.onAfterRenderObservable.clone(),l._prePassEffectConfiguration=this._prePassEffectConfiguration,l):null}static Parse(D,l,G){const V=(0,n.b)(D.customType);if(!V||!V._Parse)return null;const N=l?l.getCameraById(D.cameraId):null;return V._Parse(D,N,l,G)}static _Parse(D,l,G,V){return R.c.Parse((()=>new K(D.name,D.fragmentUrl,D.parameters,D.samplers,D.options,l,D.renderTargetSamplingMode,D._engine,D.reusable,D.defines,D.textureType,D.vertexUrl,D.indexParameters,!1,D.textureFormat)),D,G,V)}}(0,V.b)([(0,t.L)()],K.prototype,"uniqueId",void 0),(0,V.b)([(0,t.L)()],K.prototype,"name",null),(0,V.b)([(0,t.L)()],K.prototype,"width",void 0),(0,V.b)([(0,t.L)()],K.prototype,"height",void 0),(0,V.b)([(0,t.L)()],K.prototype,"renderTargetSamplingMode",void 0),(0,V.b)([(0,t.n)()],K.prototype,"clearColor",void 0),(0,V.b)([(0,t.L)()],K.prototype,"Rb",void 0),(0,V.b)([(0,t.L)()],K.prototype,"forceAutoClearInAlphaMode",void 0),(0,V.b)([(0,t.L)()],K.prototype,"alphaMode",null),(0,V.b)([(0,t.L)()],K.prototype,"alphaConstants",void 0),(0,V.b)([(0,t.L)()],K.prototype,"enablePixelPerfectMode",void 0),(0,V.b)([(0,t.L)()],K.prototype,"forceFullscreenViewport",void 0),(0,V.b)([(0,t.L)()],K.prototype,"scaleMode",void 0),(0,V.b)([(0,t.L)()],K.prototype,"alwaysForcePOT",void 0),(0,V.b)([(0,t.L)("samples")],K.prototype,"_samples",void 0),(0,V.b)([(0,t.L)()],K.prototype,"adaptScaleToCurrentViewport",void 0),(0,n.c)("BABYLON.PostProcess",K)},11837:(D,l,G)=>{G.r(l),G.d(l,{postprocessVertexShader:()=>b});var V=G(11621);const N="postprocessVertexShader",M="attribute vec2 position;uniform vec2 scale;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=(position*madd+madd)*scale;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";V.b.ShadersStore[N]||(V.b.ShadersStore[N]=M);const b={name:N,shader:M}}}]);