"use strict";(self.c2c3ycupenc=self.c2c3ycupenc||[]).push([[18],{11860:(c,r,D)=>{D(11584).b.prototype.createDepthStencilTexture=function(c,r,D){if(r.isCube){const D=c.width||c;return this._createDepthStencilCubeTexture(D,r)}return this._createDepthStencilTexture(c,r,D)}},11831:(c,r,D)=>{D(11797).ThinEngine.prototype.setAlphaMode=function(c){let r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._alphaMode!==c){switch(c){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0}r||(this.depthCullingState.depthMask=0===c),this._alphaMode=c}else if(!r){const r=0===c;this.depthCullingState.depthMask!==r&&(this.depthCullingState.depthMask=r)}}},11839:(c,r,D)=>{var W=D(11797);W.ThinEngine.prototype.updateDynamicIndexBuffer=function(c,r){let D;this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(c),D=c.is32Bits?r instanceof Uint32Array?r:new Uint32Array(r):r instanceof Uint16Array?r:new Uint16Array(r),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,D,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()},W.ThinEngine.prototype.updateDynamicVertexBuffer=function(c,r,D,W){this.bindArrayBuffer(c),void 0===D&&(D=0);const B=r.byteLength||r.length;void 0===W||W>=B&&0===D?r instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,D,new Float32Array(r)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,D,r):r instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,D,new Float32Array(r).subarray(0,W/4)):(r=r instanceof ArrayBuffer?new Uint8Array(r,0,W):new Uint8Array(r.buffer,r.byteOffset,W),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,D,r)),this._resetVertexBufferBinding()}},11847:(c,r,D)=>{var W=D(11615),B=D(11509),t=D(11797),u=D(11855),a=D(11825);class H extends u.c{setDepthStencilTexture(c){let r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(super.setDepthStencilTexture(c,r),!c)return;const D=this._engine,W=this._context,B=c._hardwareTexture;if(B&&c._autoMSAAManagement&&this._MSAAFramebuffer){const r=D._currentFramebuffer;D._bindUnboundFramebuffer(this._MSAAFramebuffer),W.framebufferRenderbuffer(W.FRAMEBUFFER,(0,a.e)(c.format)?W.DEPTH_STENCIL_ATTACHMENT:W.DEPTH_ATTACHMENT,W.RENDERBUFFER,B.getMSAARenderBuffer()),D._bindUnboundFramebuffer(r)}}constructor(c,r,D,W,B){super(c,r,D,W),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._disposeOnlyFramebuffers=!1,this._currentLOD=0,this._context=B}_cloneRenderTargetWrapper(){let c=null;return this._colorTextureArray&&this._depthStencilTextureArray?(c=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),c.texture.isReady=!0):c=super._cloneRenderTargetWrapper(),c}_swapRenderTargetWrapper(c){super._swapRenderTargetWrapper(c),c._framebuffer=this._framebuffer,c._depthStencilBuffer=this._depthStencilBuffer,c._MSAAFramebuffer=this._MSAAFramebuffer,c._colorTextureArray=this._colorTextureArray,c._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}createDepthStencilTexture(){let c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],D=arguments.length>2&&void 0!==arguments[2]&&arguments[2],W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,B=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14,t=arguments.length>5?arguments[5]:void 0;if(this._depthStencilBuffer){const c=this._engine,r=c._currentFramebuffer,D=this._context;c._bindUnboundFramebuffer(this._framebuffer),D.framebufferRenderbuffer(D.FRAMEBUFFER,D.DEPTH_STENCIL_ATTACHMENT,D.RENDERBUFFER,null),D.framebufferRenderbuffer(D.FRAMEBUFFER,D.DEPTH_ATTACHMENT,D.RENDERBUFFER,null),D.framebufferRenderbuffer(D.FRAMEBUFFER,D.STENCIL_ATTACHMENT,D.RENDERBUFFER,null),c._bindUnboundFramebuffer(r),D.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null}return super.createDepthStencilTexture(c,r,D,W,B,t)}shareDepth(c){super.shareDepth(c);const r=this._context,D=this._depthStencilBuffer,W=c._MSAAFramebuffer||c._framebuffer,B=this._engine;c._depthStencilBuffer&&c._depthStencilBuffer!==D&&r.deleteRenderbuffer(c._depthStencilBuffer),c._depthStencilBuffer=D;const t=c._generateStencilBuffer?r.DEPTH_STENCIL_ATTACHMENT:r.DEPTH_ATTACHMENT;B._bindUnboundFramebuffer(W),r.framebufferRenderbuffer(r.FRAMEBUFFER,t,r.RENDERBUFFER,D),B._bindUnboundFramebuffer(null)}_bindTextureRenderTarget(c){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,D=arguments.length>2?arguments[2]:void 0,W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const B=c._hardwareTexture;if(!B)return;const t=this._framebuffer,u=this._engine,a=u._currentFramebuffer;let H;if(u._bindUnboundFramebuffer(t),u.webGLVersion>1){const t=this._context;var x;if(H=t["COLOR_ATTACHMENT"+r],c.is2DArray||c.is3D)D=D??(null===(x=this.layerIndices)||void 0===x?void 0:x[r])??0,t.framebufferTextureLayer(t.FRAMEBUFFER,H,B.underlyingResource,W,D);else if(c.isCube){var M;D=D??(null===(M=this.faceIndices)||void 0===M?void 0:M[r])??0,t.framebufferTexture2D(t.FRAMEBUFFER,H,t.TEXTURE_CUBE_MAP_POSITIVE_X+D,B.underlyingResource,W)}else t.framebufferTexture2D(t.FRAMEBUFFER,H,t.TEXTURE_2D,B.underlyingResource,W)}else{const c=this._context;H=c["COLOR_ATTACHMENT"+r+"_WEBGL"];const t=void 0!==D?c.TEXTURE_CUBE_MAP_POSITIVE_X+D:c.TEXTURE_2D;c.framebufferTexture2D(c.FRAMEBUFFER,H,t,B.underlyingResource,W)}if(c._autoMSAAManagement&&this._MSAAFramebuffer){const c=this._context;u._bindUnboundFramebuffer(this._MSAAFramebuffer),c.framebufferRenderbuffer(c.FRAMEBUFFER,H,c.RENDERBUFFER,B.getMSAARenderBuffer())}u._bindUnboundFramebuffer(a)}setTexture(c){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,D=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];super.setTexture(c,r,D),this._bindTextureRenderTarget(c,r)}setLayerAndFaceIndices(c,r){var D;if(super.setLayerAndFaceIndices(c,r),!this.textures||!this.layerIndices||!this.faceIndices)return;const W=(null===(D=this._attachments)||void 0===D?void 0:D.length)??this.textures.length;for(let B=0;B<W;B++){const c=this.textures[B];c&&(c.is2DArray||c.is3D?this._bindTextureRenderTarget(c,B,this.layerIndices[B]):c.isCube?this._bindTextureRenderTarget(c,B,this.faceIndices[B]):this._bindTextureRenderTarget(c,B))}}setLayerAndFaceIndex(){let c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1?arguments[1]:void 0,D=arguments.length>2?arguments[2]:void 0;if(super.setLayerAndFaceIndex(c,r,D),!this.textures||!this.layerIndices||!this.faceIndices)return;const W=this.textures[c];W.is2DArray||W.is3D?this._bindTextureRenderTarget(this.textures[c],c,this.layerIndices[c]):W.isCube&&this._bindTextureRenderTarget(this.textures[c],c,this.faceIndices[c])}resolveMSAATextures(){const c=this._engine,r=c._currentFramebuffer;c._bindUnboundFramebuffer(this._MSAAFramebuffer),super.resolveMSAATextures(),c._bindUnboundFramebuffer(r)}dispose(){let c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._disposeOnlyFramebuffers;const r=this._context;c||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(r.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(r.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(r.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(c)}}D(11860);t.ThinEngine.prototype._createHardwareRenderTargetWrapper=function(c,r,D){const W=new H(c,r,D,this,this._gl);return this._renderTargetWrapperCache.push(W),W},t.ThinEngine.prototype.createRenderTargetTexture=function(c,r){const D=this._createHardwareRenderTargetWrapper(!1,!1,c);let W,B,t=!0,u=!1,a=!1,H=1;void 0!==r&&"object"===typeof r&&(t=r.generateDepthBuffer??!0,u=!!r.generateStencilBuffer,a=!!r.noColorAttachment,W=r.colorAttachment,H=r.samples??1,B=r.label);const x=W||(a?null:this._createInternalTexture(c,r,!0,5)),M=c.width||c,E=c.height||c,m=this._currentFramebuffer,Y=this._gl,v=Y.createFramebuffer();if(this._bindUnboundFramebuffer(v),D._depthStencilBuffer=this._setupFramebufferDepthAttachments(u,t,M,E),!x||x.is2DArray||x.is3D||Y.framebufferTexture2D(Y.FRAMEBUFFER,Y.COLOR_ATTACHMENT0,Y.TEXTURE_2D,x._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(m),D.label=B??"RenderTargetWrapper",D._framebuffer=v,D._generateDepthBuffer=t,D._generateStencilBuffer=u,D.setTextures(x),W){if(D._samples=W.samples,W.samples>1){const c=W._hardwareTexture.getMSAARenderBuffer(0);D._MSAAFramebuffer=Y.createFramebuffer(),this._bindUnboundFramebuffer(D._MSAAFramebuffer),Y.framebufferRenderbuffer(Y.FRAMEBUFFER,Y.COLOR_ATTACHMENT0,Y.RENDERBUFFER,c),this._bindUnboundFramebuffer(null)}}else this.updateRenderTargetTextureSampleCount(D,H);return D},t.ThinEngine.prototype._createDepthStencilTexture=function(c,r,D){const t=this._gl,u=c.layers||0,H=c.depth||0;let x=t.TEXTURE_2D;0!==u?x=t.TEXTURE_2D_ARRAY:0!==H&&(x=t.TEXTURE_3D);const M=new W.e(this,12);if(M.label=r.label,!this._caps.depthTextureExtension)return B.e.Error("Depth texture is not supported by your browser or hardware."),M;const E={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...r};if(this._bindTextureDirectly(x,M,!0),this._setupDepthStencilTexture(M,c,0!==E.comparisonFunction&&E.bilinearFiltering,E.comparisonFunction,E.samples),void 0!==E.depthTextureFormat){if(15!==E.depthTextureFormat&&16!==E.depthTextureFormat&&17!==E.depthTextureFormat&&13!==E.depthTextureFormat&&14!==E.depthTextureFormat&&18!==E.depthTextureFormat)return B.e.Error(`Depth texture ${E.depthTextureFormat} format is not supported.`),M;M.format=E.depthTextureFormat}else M.format=E.generateStencil?13:16;const m=(0,a.e)(M.format),Y=this._getWebGLTextureTypeFromDepthTextureFormat(M.format),v=m?t.DEPTH_STENCIL:t.DEPTH_COMPONENT,k=this._getInternalFormatFromDepthTextureFormat(M.format,!0,m);return M.is2DArray?t.texImage3D(x,0,k,M.width,M.height,u,0,v,Y,null):M.is3D?t.texImage3D(x,0,k,M.width,M.height,H,0,v,Y,null):t.texImage2D(x,0,k,M.width,M.height,0,v,Y,null),this._bindTextureDirectly(x,null),this._internalTexturesCache.push(M),D._depthStencilBuffer&&(t.deleteRenderbuffer(D._depthStencilBuffer),D._depthStencilBuffer=null),this._bindUnboundFramebuffer(D._MSAAFramebuffer??D._framebuffer),D._generateStencilBuffer=m,D._depthStencilTextureWithStencil=m,D._depthStencilBuffer=this._setupFramebufferDepthAttachments(D._generateStencilBuffer,D._generateDepthBuffer,D.width,D.height,D.samples,M.format),this._bindUnboundFramebuffer(null),M},t.ThinEngine.prototype.updateRenderTargetTextureSampleCount=function(c,r){var D;if(this.webGLVersion<2||!c)return 1;if(c.samples===r)return r;const W=this._gl;r=Math.min(r,this.getCaps().maxMSAASamples),c._depthStencilBuffer&&(W.deleteRenderbuffer(c._depthStencilBuffer),c._depthStencilBuffer=null),c._MSAAFramebuffer&&(W.deleteFramebuffer(c._MSAAFramebuffer),c._MSAAFramebuffer=null);const B=null===(D=c.texture)||void 0===D?void 0:D._hardwareTexture;if(null===B||void 0===B||B.releaseMSAARenderBuffers(),c.texture&&r>1&&"function"===typeof W.renderbufferStorageMultisample){const D=W.createFramebuffer();if(!D)throw new Error("Unable to create multi sampled framebuffer");c._MSAAFramebuffer=D,this._bindUnboundFramebuffer(c._MSAAFramebuffer);const t=this._createRenderBuffer(c.texture.width,c.texture.height,r,-1,this._getRGBABufferInternalSizedFormat(c.texture.type,c.texture.format,c.texture._useSRGBBuffer),W.COLOR_ATTACHMENT0,!1);if(!t)throw new Error("Unable to create multi sampled framebuffer");null===B||void 0===B||B.addMSAARenderBuffer(t)}this._bindUnboundFramebuffer(c._MSAAFramebuffer??c._framebuffer),c.texture&&(c.texture.samples=r),c._samples=r;const t=c._depthStencilTexture?c._depthStencilTexture.format:void 0;return c._depthStencilBuffer=this._setupFramebufferDepthAttachments(c._generateStencilBuffer,c._generateDepthBuffer,c.width,c.height,r,t),this._bindUnboundFramebuffer(null),r},t.ThinEngine.prototype._setupDepthStencilTexture=function(c,r,D,W){let B=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;const t=r.width??r,u=r.height??r,a=r.layers||0,H=r.depth||0;c.baseWidth=t,c.baseHeight=u,c.width=t,c.height=u,c.is2DArray=a>0,c.depth=a||H,c.isReady=!0,c.samples=B,c.generateMipMaps=!1,c.samplingMode=D?2:1,c.type=0,c._comparisonFunction=W;const x=this._gl,M=this._getTextureTarget(c),E=this._getSamplingParameters(c.samplingMode,!1);x.texParameteri(M,x.TEXTURE_MAG_FILTER,E.mag),x.texParameteri(M,x.TEXTURE_MIN_FILTER,E.min),x.texParameteri(M,x.TEXTURE_WRAP_S,x.CLAMP_TO_EDGE),x.texParameteri(M,x.TEXTURE_WRAP_T,x.CLAMP_TO_EDGE),this.webGLVersion>1&&(0===W?(x.texParameteri(M,x.TEXTURE_COMPARE_FUNC,515),x.texParameteri(M,x.TEXTURE_COMPARE_MODE,x.NONE)):(x.texParameteri(M,x.TEXTURE_COMPARE_FUNC,W),x.texParameteri(M,x.TEXTURE_COMPARE_MODE,x.COMPARE_REF_TO_TEXTURE)))}},11817:(c,r,D)=>{D.d(r,{b:()=>W});class W{get underlyingResource(){return this._webGLTexture}constructor(){let c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,r=arguments.length>1?arguments[1]:void 0;if(this._MSAARenderBuffers=null,this._context=r,!c&&(c=r.createTexture(),!c))throw new Error("Unable to create webGL texture");this.set(c)}setUsage(){}set(c){this._webGLTexture=c}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(c){this._MSAARenderBuffers||(this._MSAARenderBuffers=[]),this._MSAARenderBuffers.push(c)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(const c of this._MSAARenderBuffers)this._context.deleteRenderbuffer(c);this._MSAARenderBuffers=null}}getMSAARenderBuffer(){var c;let r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return(null===(c=this._MSAARenderBuffers)||void 0===c?void 0:c[r])??null}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}},11792:(c,r,D)=>{D.d(r,{b:()=>U});var W=D(11615),B=D(11538),t=D(11797),u=D(11517);class a{constructor(){let c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:30;this._enabled=!0,this._rollingFrameTime=new H(c)}sampleFrame(){let c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:u.e.Now;if(this._enabled){if(null!=this._lastFrameTimeMs){const r=c-this._lastFrameTimeMs;this._rollingFrameTime.add(r)}this._lastFrameTimeMs=c}}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){const c=this._rollingFrameTime.history(0);return 0===c?0:1e3/c}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}}class H{constructor(c){this._samples=new Array(c),this.reset()}add(c){let r;if(this.isSaturated()){const c=this._samples[this._pos];r=c-this.average,this.average-=r/(this._sampleCount-1),this._m2-=r*(c-this.average)}else this._sampleCount++;r=c-this.average,this.average+=r/this._sampleCount,this._m2+=r*(c-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=c,this._pos++,this._pos%=this._samples.length}history(c){if(c>=this._sampleCount||c>=this._samples.length)return 0;const r=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(r-c)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(c){const r=this._samples.length;return(c%r+r)%r}}var x=D(11808),M=D(11509),E=D(11817),m=(D(11831),D(11648));function Y(c,r,D,W){let B,t=1;1===W?B=new Float32Array(r*D*4):2===W?(B=new Uint16Array(r*D*4),t=15360):B=7===W?new Uint32Array(r*D*4):new Uint8Array(r*D*4);for(let u=0;u<r;u++)for(let W=0;W<D;W++){const D=3*(W*r+u),a=4*(W*r+u);B[a+0]=c[D+0],B[a+1]=c[D+1],B[a+2]=c[D+2],B[a+3]=t}return B}function v(c){return function(r,D,B,t,u,a,H,x){let M=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,E=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;const m=c?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,Y=c?10:11,v=new W.e(this,Y);v.baseWidth=D,v.baseHeight=B,v.baseDepth=t,v.width=D,v.height=B,v.depth=t,v.format=u,v.type=E,v.generateMipMaps=a,v.samplingMode=x,c?v.is3D=!0:v.is2DArray=!0,this._doNotHandleContextLost||(v._bufferView=r),c?this.updateRawTexture3D(v,r,u,H,M,E):this.updateRawTexture2DArray(v,r,u,H,M,E),this._bindTextureDirectly(m,v,!0);const k=this._getSamplingParameters(x,a);return this._gl.texParameteri(m,this._gl.TEXTURE_MAG_FILTER,k.mag),this._gl.texParameteri(m,this._gl.TEXTURE_MIN_FILTER,k.min),a&&this._gl.generateMipmap(m),this._bindTextureDirectly(m,null),this._internalTexturesCache.push(v),v}}function k(c){return function(r,D,W,B){let t=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,u=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;const a=c?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,H=this._getWebGLTextureType(u),x=this._getInternalFormat(W),M=this._getRGBABufferInternalSizedFormat(u,W);this._bindTextureDirectly(a,r,!0),this._unpackFlipY(void 0===B||!!B),this._doNotHandleContextLost||(r._bufferView=D,r.format=W,r.invertY=B,r._compression=t),r.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),t&&D?this._gl.compressedTexImage3D(a,0,this.getCaps().s3tc[t],r.width,r.height,r.depth,0,D):this._gl.texImage3D(a,0,M,r.width,r.height,r.depth,0,x,H,D),r.generateMipMaps&&this._gl.generateMipmap(a),this._bindTextureDirectly(a,null),r.isReady=!0}}t.ThinEngine.prototype.updateRawTexture=function(c,r,D,W){let B=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,t=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,u=arguments.length>6&&void 0!==arguments[6]&&arguments[6];if(!c)return;const a=this._getRGBABufferInternalSizedFormat(t,D,u),H=this._getInternalFormat(D),x=this._getWebGLTextureType(t);this._bindTextureDirectly(this._gl.TEXTURE_2D,c,!0),this._unpackFlipY(void 0===W||!!W),this._doNotHandleContextLost||(c._bufferView=r,c.format=D,c.type=t,c.invertY=W,c._compression=B),c.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),B&&r?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[B],c.width,c.height,0,r):this._gl.texImage2D(this._gl.TEXTURE_2D,0,a,c.width,c.height,0,H,x,r),c.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),c.isReady=!0},t.ThinEngine.prototype.createRawTexture=function(c,r,D,B,t,u,a){let H=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,x=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,M=arguments.length>10&&void 0!==arguments[10]&&arguments[10];const E=new W.e(this,3);E.baseWidth=r,E.baseHeight=D,E.width=r,E.height=D,E.format=B,E.generateMipMaps=t,E.samplingMode=a,E.invertY=u,E._compression=H,E.type=x,E._useSRGBBuffer=this._getUseSRGBBuffer(M,!t),this._doNotHandleContextLost||(E._bufferView=c),this.updateRawTexture(E,c,B,u,H,x,E._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,E,!0);const m=this._getSamplingParameters(a,t);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,m.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,m.min),t&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(E),E},t.ThinEngine.prototype.createRawCubeTexture=function(c,r,D,B,t,u,a){let H=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;const x=this._gl,E=new W.e(this,8);E.isCube=!0,E.format=D,E.type=B,this._doNotHandleContextLost||(E._bufferViewArray=c);const Y=this._getWebGLTextureType(B);let v=this._getInternalFormat(D);v===x.RGB&&(v=x.RGBA),Y!==x.FLOAT||this._caps.textureFloatLinearFiltering?Y!==this._gl.HALF_FLOAT_OES||this._caps.textureHalfFloatLinearFiltering?Y!==x.FLOAT||this._caps.textureFloatRender?Y!==x.HALF_FLOAT||this._caps.colorBufferFloat||(t=!1,M.e.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(t=!1,M.e.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(t=!1,a=1,M.e.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(t=!1,a=1,M.e.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively."));const k=r,w=k;E.width=k,E.height=w,E.invertY=u,E._compression=H;if(!this.needPOTTextures||(0,m.h)(E.width)&&(0,m.h)(E.height)||(t=!1),c)this.updateRawCubeTexture(E,c,D,B,u,H);else{const c=this._getRGBABufferInternalSizedFormat(B),r=0;this._bindTextureDirectly(x.TEXTURE_CUBE_MAP,E,!0);for(let D=0;D<6;D++)H?x.compressedTexImage2D(x.TEXTURE_CUBE_MAP_POSITIVE_X+D,r,this.getCaps().s3tc[H],E.width,E.height,0,void 0):x.texImage2D(x.TEXTURE_CUBE_MAP_POSITIVE_X+D,r,c,E.width,E.height,0,v,Y,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,E,!0),c&&t&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);const Z=this._getSamplingParameters(a,t);return x.texParameteri(x.TEXTURE_CUBE_MAP,x.TEXTURE_MAG_FILTER,Z.mag),x.texParameteri(x.TEXTURE_CUBE_MAP,x.TEXTURE_MIN_FILTER,Z.min),x.texParameteri(x.TEXTURE_CUBE_MAP,x.TEXTURE_WRAP_S,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_CUBE_MAP,x.TEXTURE_WRAP_T,x.CLAMP_TO_EDGE),this._bindTextureDirectly(x.TEXTURE_CUBE_MAP,null),E.generateMipMaps=t,E.samplingMode=a,E.isReady=!0,E},t.ThinEngine.prototype.updateRawCubeTexture=function(c,r,D,W,B){let t=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;c._bufferViewArray=r,c.format=D,c.type=W,c.invertY=B,c._compression=t;const a=this._gl,H=this._getWebGLTextureType(W);let x=this._getInternalFormat(D);const M=this._getRGBABufferInternalSizedFormat(W);let E=!1;x===a.RGB&&(x=a.RGBA,E=!0),this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,c,!0),this._unpackFlipY(void 0===B||!!B),c.width%4!==0&&a.pixelStorei(a.UNPACK_ALIGNMENT,1);for(let m=0;m<6;m++){let D=r[m];t?a.compressedTexImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+m,u,this.getCaps().s3tc[t],c.width,c.height,0,D):(E&&(D=Y(D,c.width,c.height,W)),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+m,u,M,c.width,c.height,0,x,H,D))}(!this.needPOTTextures||(0,m.h)(c.width)&&(0,m.h)(c.height))&&c.generateMipMaps&&0===u&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),c.isReady=!0},t.ThinEngine.prototype.createRawCubeTextureFromUrl=function(c,r,D,W,B,t,u,a){let H=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,x=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,M=arguments.length>10&&void 0!==arguments[10]?arguments[10]:3,E=arguments.length>11&&void 0!==arguments[11]&&arguments[11];const m=this._gl,v=this.createRawCubeTexture(null,D,W,B,!t,E,M,null);null===r||void 0===r||r.addPendingData(v),v.url=c,v.isReady=!1,this._internalTexturesCache.push(v);const k=c=>{if(!v._hardwareTexture)return;const D=v.width,t=u(c);if(t){if(a){const c=this._getWebGLTextureType(B);let r=this._getInternalFormat(W);const u=this._getRGBABufferInternalSizedFormat(B);let H=!1;r===m.RGB&&(r=m.RGBA,H=!0),this._bindTextureDirectly(m.TEXTURE_CUBE_MAP,v,!0),this._unpackFlipY(!1);const x=a(t);for(let W=0;W<x.length;W++){const t=D>>W;for(let D=0;D<6;D++){let a=x[W][D];H&&(a=Y(a,t,t,B)),m.texImage2D(D,W,u,t,t,0,r,c,a)}}this._bindTextureDirectly(m.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(v,t,W,B,E);v.isReady=!0,null===r||void 0===r||r.removePendingData(v),v.onLoadedObservable.notifyObservers(v),v.onLoadedObservable.clear(),H&&H()}};return this._loadFile(c,(c=>{k(c)}),void 0,null===r||void 0===r?void 0:r.offlineProvider,!0,((c,D)=>{null===r||void 0===r||r.removePendingData(v),x&&c&&x(c.status+" "+c.statusText,D)})),v},t.ThinEngine.prototype.createRawTexture2DArray=v(!1),t.ThinEngine.prototype.createRawTexture3D=v(!0),t.ThinEngine.prototype.updateRawTexture2DArray=k(!1),t.ThinEngine.prototype.updateRawTexture3D=k(!0);var w=D(11572);t.ThinEngine.prototype._readTexturePixelsSync=function(c,r,D){let W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,B=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,t=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,u=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],a=arguments.length>7&&void 0!==arguments[7]&&arguments[7],H=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,x=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;const M=this._gl;if(!M)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){const c=M.createFramebuffer();if(!c)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=c}var E,m;(M.bindFramebuffer(M.FRAMEBUFFER,this._dummyFramebuffer),W>-1)?M.framebufferTexture2D(M.FRAMEBUFFER,M.COLOR_ATTACHMENT0,M.TEXTURE_CUBE_MAP_POSITIVE_X+W,null===(E=c._hardwareTexture)||void 0===E?void 0:E.underlyingResource,B):M.framebufferTexture2D(M.FRAMEBUFFER,M.COLOR_ATTACHMENT0,M.TEXTURE_2D,null===(m=c._hardwareTexture)||void 0===m?void 0:m.underlyingResource,B);let Y=void 0!==c.type?this._getWebGLTextureType(c.type):M.UNSIGNED_BYTE;if(a)t||(t=(0,w.j)(c.type,4*r*D));else if(Y===M.UNSIGNED_BYTE)t||(t=new Uint8Array(4*r*D)),Y=M.UNSIGNED_BYTE;else t||(t=new Float32Array(4*r*D)),Y=M.FLOAT;return u&&this.flushFramebuffer(),M.readPixels(H,x,r,D,M.RGBA,Y,t),M.bindFramebuffer(M.FRAMEBUFFER,this._currentFramebuffer),t},t.ThinEngine.prototype._readTexturePixels=function(c,r,D){let W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,B=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,t=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,u=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],a=arguments.length>7&&void 0!==arguments[7]&&arguments[7],H=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,x=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;return Promise.resolve(this._readTexturePixelsSync(c,r,D,W,B,t,u,a,H,x))};D(11839);t.ThinEngine.prototype._createDepthStencilCubeTexture=function(c,r){const D=new W.e(this,12);if(D.isCube=!0,1===this.webGLVersion)return M.e.Error("Depth cube texture is not supported by WebGL 1."),D;const B={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...r},t=this._gl;this._bindTextureDirectly(t.TEXTURE_CUBE_MAP,D,!0),this._setupDepthStencilTexture(D,c,B.bilinearFiltering,B.comparisonFunction);for(let W=0;W<6;W++)B.generateStencil?t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+W,0,t.DEPTH24_STENCIL8,c,c,0,t.DEPTH_STENCIL,t.UNSIGNED_INT_24_8,null):t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+W,0,t.DEPTH_COMPONENT24,c,c,0,t.DEPTH_COMPONENT,t.UNSIGNED_INT,null);return this._bindTextureDirectly(t.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(D),D},t.ThinEngine.prototype._setCubeMapTextureParams=function(c,r,D){const W=this._gl;W.texParameteri(W.TEXTURE_CUBE_MAP,W.TEXTURE_MAG_FILTER,W.LINEAR),W.texParameteri(W.TEXTURE_CUBE_MAP,W.TEXTURE_MIN_FILTER,r?W.LINEAR_MIPMAP_LINEAR:W.LINEAR),W.texParameteri(W.TEXTURE_CUBE_MAP,W.TEXTURE_WRAP_S,W.CLAMP_TO_EDGE),W.texParameteri(W.TEXTURE_CUBE_MAP,W.TEXTURE_WRAP_T,W.CLAMP_TO_EDGE),c.samplingMode=r?3:2,r&&this.getCaps().textureMaxLevel&&void 0!==D&&D>0&&(W.texParameteri(W.TEXTURE_CUBE_MAP,W.TEXTURE_MAX_LEVEL,D),c._maxLodLevel=D),this._bindTextureDirectly(W.TEXTURE_CUBE_MAP,null)},t.ThinEngine.prototype.createCubeTexture=function(c,r,D,W){let B=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,t=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,u=arguments.length>6?arguments[6]:void 0,a=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,H=arguments.length>8&&void 0!==arguments[8]&&arguments[8],x=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,E=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0,Y=arguments.length>11&&void 0!==arguments[11]?arguments[11]:null,v=arguments.length>13&&void 0!==arguments[13]&&arguments[13],k=arguments.length>14&&void 0!==arguments[14]?arguments[14]:null;const w=this._gl;return this.createCubeTextureBase(c,r,D,!!W,B,t,u,a,H,x,E,Y,(c=>this._bindTextureDirectly(w.TEXTURE_CUBE_MAP,c,!0)),((c,r)=>{const D=this.needPOTTextures?(0,m.e)(r[0].width,this._caps.maxCubemapTextureSize):r[0].width,t=D,a=[w.TEXTURE_CUBE_MAP_POSITIVE_X,w.TEXTURE_CUBE_MAP_POSITIVE_Y,w.TEXTURE_CUBE_MAP_POSITIVE_Z,w.TEXTURE_CUBE_MAP_NEGATIVE_X,w.TEXTURE_CUBE_MAP_NEGATIVE_Y,w.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(w.TEXTURE_CUBE_MAP,c,!0),this._unpackFlipY(!1);const H=u?this._getInternalFormat(u,c._useSRGBBuffer):c._useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:w.RGBA;let x=u?this._getInternalFormat(u):w.RGBA;c._useSRGBBuffer&&1===this.webGLVersion&&(x=H);for(let W=0;W<a.length;W++)if(r[W].width!==D||r[W].height!==t){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext)return void M.e.Warn("Cannot create canvas to resize texture.");this._workingCanvas.width=D,this._workingCanvas.height=t,this._workingContext.drawImage(r[W],0,0,r[W].width,r[W].height,0,0,D,t),w.texImage2D(a[W],0,H,x,w.UNSIGNED_BYTE,this._workingCanvas)}else w.texImage2D(a[W],0,H,x,w.UNSIGNED_BYTE,r[W]);W||w.generateMipmap(w.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(c,!W),c.width=D,c.height=t,c.isReady=!0,u&&(c.format=u),c.onLoadedObservable.notifyObservers(c),c.onLoadedObservable.clear(),B&&B()}),!!v,k)},t.ThinEngine.prototype.generateMipMapsForCubemap=function(c){let r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(c.generateMipMaps){const D=this._gl;this._bindTextureDirectly(D.TEXTURE_CUBE_MAP,c,!0),D.generateMipmap(D.TEXTURE_CUBE_MAP),r&&this._bindTextureDirectly(D.TEXTURE_CUBE_MAP,null)}};D(11847);t.ThinEngine.prototype.setDepthStencilTexture=function(c,r,D,W){void 0!==c&&(r&&(this._boundUniforms[c]=r),D&&D.depthStencilTexture?this._setTexture(c,D,!1,!0,W):this._setTexture(c,null,void 0,void 0,W))},t.ThinEngine.prototype.createRenderTargetCubeTexture=function(c,r){const D=this._createHardwareRenderTargetWrapper(!1,!0,c),B={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,...r};B.generateStencilBuffer=B.generateDepthBuffer&&B.generateStencilBuffer,(1!==B.type||this._caps.textureFloatLinearFiltering)&&(2!==B.type||this._caps.textureHalfFloatLinearFiltering)||(B.samplingMode=1);const t=this._gl,u=new W.e(this,5);this._bindTextureDirectly(t.TEXTURE_CUBE_MAP,u,!0);const a=this._getSamplingParameters(B.samplingMode,B.generateMipMaps);1!==B.type||this._caps.textureFloat||(B.type=0,M.e.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,a.mag),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,a.min),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);for(let W=0;W<6;W++)t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+W,0,this._getRGBABufferInternalSizedFormat(B.type,B.format),c,c,0,this._getInternalFormat(B.format),this._getWebGLTextureType(B.type),null);const H=t.createFramebuffer();return this._bindUnboundFramebuffer(H),D._depthStencilBuffer=this._setupFramebufferDepthAttachments(B.generateStencilBuffer,B.generateDepthBuffer,c,c),B.generateMipMaps&&t.generateMipmap(t.TEXTURE_CUBE_MAP),this._bindTextureDirectly(t.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),D._framebuffer=H,D._generateDepthBuffer=B.generateDepthBuffer,D._generateStencilBuffer=B.generateStencilBuffer,u.width=c,u.height=c,u.isReady=!0,u.isCube=!0,u.samples=1,u.generateMipMaps=B.generateMipMaps,u.samplingMode=B.samplingMode,u.type=B.type,u.format=B.format,this._internalTexturesCache.push(u),D.setTextures(u),D};var Z=D(11868),J=D(11705);t.ThinEngine.prototype.createPrefilteredCubeTexture=function(c,r,B,t){let u=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,H=arguments.length>6?arguments[6]:void 0,x=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,E=!(arguments.length>8&&void 0!==arguments[8])||arguments[8];return this.createCubeTexture(c,r,null,!1,(async c=>{if(!c)return void(u&&u(null));const a=c.texture;if(E?c.info.sphericalPolynomial&&(a._sphericalPolynomial=c.info.sphericalPolynomial):a._sphericalPolynomial=new Z.e,a._source=9,this.getCaps().textureLOD)return void(u&&u(a));const H=this._gl,x=c.width;if(!x)return;const{DDSTools:m}=await D.e(29).then(D.bind(D,14117)),Y=[];for(let D=0;D<3;D++){const u=1-D/2,E=t,v=Math.log2(x)*B+t,k=E+(v-E)*u,w=Math.round(Math.min(Math.max(k,0),v)),Z=new W.e(this,2);if(Z.type=a.type,Z.format=a.format,Z.width=Math.pow(2,Math.max(Math.log2(x)-w,0)),Z.height=Z.width,Z.isCube=!0,Z._cachedWrapU=0,Z._cachedWrapV=0,this._bindTextureDirectly(H.TEXTURE_CUBE_MAP,Z,!0),Z.samplingMode=2,H.texParameteri(H.TEXTURE_CUBE_MAP,H.TEXTURE_MAG_FILTER,H.LINEAR),H.texParameteri(H.TEXTURE_CUBE_MAP,H.TEXTURE_MIN_FILTER,H.LINEAR),H.texParameteri(H.TEXTURE_CUBE_MAP,H.TEXTURE_WRAP_S,H.CLAMP_TO_EDGE),H.texParameteri(H.TEXTURE_CUBE_MAP,H.TEXTURE_WRAP_T,H.CLAMP_TO_EDGE),c.isDDS){const r=c.info,D=c.data;this._unpackFlipY(r.isCompressed),m.UploadDDSLevels(this,Z,D,r,!0,6,w)}else M.e.Warn("DDS is the only prefiltered cube map supported so far.");this._bindTextureDirectly(H.TEXTURE_CUBE_MAP,null);const q=new J.c(r);q._isCube=!0,q._texture=Z,Z.isReady=!0,Y.push(q)}a._lodTextureHigh=Y[2],a._lodTextureMid=Y[1],a._lodTextureLow=Y[0],u&&u(a)}),a,H,x,E,B,t)},t.ThinEngine.prototype.createUniformBuffer=function(c,r){const D=this._gl.createBuffer();if(!D)throw new Error("Unable to create uniform buffer");const W=new x.d(D);return this.bindUniformBuffer(W),c instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,c,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(c),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),W.references=1,W},t.ThinEngine.prototype.createDynamicUniformBuffer=function(c,r){const D=this._gl.createBuffer();if(!D)throw new Error("Unable to create dynamic uniform buffer");const W=new x.d(D);return this.bindUniformBuffer(W),c instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,c,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(c),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),W.references=1,W},t.ThinEngine.prototype.updateUniformBuffer=function(c,r,D,W){this.bindUniformBuffer(c),void 0===D&&(D=0),void 0===W?r instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,D,r):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,D,new Float32Array(r)):r instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,r.subarray(D,D+W)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(r).subarray(D,D+W)),this.bindUniformBuffer(null)},t.ThinEngine.prototype.bindUniformBuffer=function(c){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,c?c.underlyingResource:null)},t.ThinEngine.prototype.bindUniformBufferBase=function(c,r,D){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,r,c?c.underlyingResource:null)},t.ThinEngine.prototype.bindUniformBlock=function(c,r,D){const W=c.program,B=this._gl.getUniformBlockIndex(W,r);4294967295!==B&&this._gl.uniformBlockBinding(W,B,D)};var q=D(11501),j=D(11584);j.b.prototype.displayLoadingUI=function(){if(!(0,q.f)())return;const c=this.loadingScreen;c&&c.displayLoadingUI()},j.b.prototype.hideLoadingUI=function(){if(!(0,q.f)())return;const c=this._loadingScreen;c&&c.hideLoadingUI()},Object.defineProperty(j.b.prototype,"loadingScreen",{get:function(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=j.b.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen},set:function(c){this._loadingScreen=c},enumerable:!0,configurable:!0}),Object.defineProperty(j.b.prototype,"loadingUIText",{set:function(c){this.loadingScreen.loadingUIText=c},enumerable:!0,configurable:!0}),Object.defineProperty(j.b.prototype,"loadingUIBackgroundColor",{set:function(c){this.loadingScreen.loadingUIBackgroundColor=c},enumerable:!0,configurable:!0}),j.b.prototype.getInputElement=function(){return this._renderingCanvas},j.b.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null},j.b.prototype.getInputElementClientRect=function(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null},j.b.prototype.getAspectRatio=function(c){let r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const D=c.viewport;return this.getRenderWidth(r)*D.width/(this.getRenderHeight(r)*D.height)},j.b.prototype.getScreenAspectRatio=function(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)},j.b.prototype._verifyPointerLock=function(){var c;null===(c=this._onPointerLockChange)||void 0===c||c.call(this)},j.b.prototype.setAlphaEquation=function(c){if(this._alphaEquation!==c){switch(c){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774)}this._alphaEquation=c}},j.b.prototype.getInputElement=function(){return this._renderingCanvas},j.b.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc},j.b.prototype.setDepthFunction=function(c){this._depthCullingState.depthFunc=c},j.b.prototype.setDepthFunctionToGreater=function(){this.setDepthFunction(516)},j.b.prototype.setDepthFunctionToGreaterOrEqual=function(){this.setDepthFunction(518)},j.b.prototype.setDepthFunctionToLess=function(){this.setDepthFunction(513)},j.b.prototype.setDepthFunctionToLessOrEqual=function(){this.setDepthFunction(515)},j.b.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask},j.b.prototype.setDepthWrite=function(c){this._depthCullingState.depthMask=c},j.b.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest},j.b.prototype.setStencilBuffer=function(c){this._stencilState.stencilTest=c},j.b.prototype.getStencilMask=function(){return this._stencilState.stencilMask},j.b.prototype.setStencilMask=function(c){this._stencilState.stencilMask=c},j.b.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc},j.b.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef},j.b.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask},j.b.prototype.setStencilFunction=function(c){this._stencilState.stencilFunc=c},j.b.prototype.setStencilFunctionReference=function(c){this._stencilState.stencilFuncRef=c},j.b.prototype.setStencilFunctionMask=function(c){this._stencilState.stencilFuncMask=c},j.b.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail},j.b.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail},j.b.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass},j.b.prototype.setStencilOperationFail=function(c){this._stencilState.stencilOpStencilFail=c},j.b.prototype.setStencilOperationDepthFail=function(c){this._stencilState.stencilOpDepthFail=c},j.b.prototype.setStencilOperationPass=function(c){this._stencilState.stencilOpStencilDepthPass=c},j.b.prototype.cacheStencilState=function(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()},j.b.prototype.restoreStencilState=function(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)},j.b.prototype.setAlphaConstants=function(c,r,D,W){this._alphaState.setAlphaBlendConstants(c,r,D,W)},j.b.prototype.getAlphaMode=function(){return this._alphaMode},j.b.prototype.getAlphaEquation=function(){return this._alphaEquation},j.b.prototype.getRenderPassNames=function(){return this._renderPassNames},j.b.prototype.getCurrentRenderPassName=function(){return this._renderPassNames[this.currentRenderPassId]},j.b.prototype.createRenderPassId=function(c){const r=++j.b._RenderPassIdCounter;return this._renderPassNames[r]=c??"NONAME",r},j.b.prototype.releaseRenderPassId=function(c){this._renderPassNames[c]=void 0;for(let r=0;r<this.scenes.length;++r){const D=this.scenes[r];for(let r=0;r<D.meshes.length;++r){const W=D.meshes[r];if(W.xa)for(let r=0;r<W.xa.length;++r){W.xa[r]._removeDrawWrapper(c)}}}};D(11860);function X(c){if(c.requestPointerLock){const r=c.requestPointerLock();r instanceof Promise?r.then((()=>{c.focus()})).catch((()=>{})):c.focus()}}var e=D(11902),y=D(11581);class U extends t.ThinEngine{static get NpmPackage(){return j.b.NpmPackage}static get Version(){return j.b.Version}static get Instances(){return B.c.Instances}static get LastCreatedEngine(){return B.c.LastCreatedEngine}static get LastCreatedScene(){return B.c.LastCreatedScene}static DefaultLoadingScreenFactory(c){return j.b.DefaultLoadingScreenFactory(c)}get _supportsHardwareTextureRescaling(){return!!U._RescalePostProcessFactory}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}get performanceMonitor(){return this._performanceMonitor}constructor(c,r,D){super(c,r,D,arguments.length>3&&void 0!==arguments[3]&&arguments[3]),this.customAnimationFrameRequester=null,this._performanceMonitor=new a,this._drawCalls=new e.b,c&&(this._features.supportRenderPasses=!0,D=this._creationOptions)}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(c){super._sharedInit(c),function(c,r,D){c._onCanvasFocus=()=>{c.onCanvasFocusObservable.notifyObservers(c)},c._onCanvasBlur=()=>{c.onCanvasBlurObservable.notifyObservers(c)},c._onCanvasContextMenu=r=>{c.disableContextMenu&&r.preventDefault()},r.addEventListener("focus",c._onCanvasFocus),r.addEventListener("blur",c._onCanvasBlur),r.addEventListener("contextmenu",c._onCanvasContextMenu),c._onBlur=()=>{c.disablePerformanceMonitorInBackground&&c.performanceMonitor.disable(),c._windowIsBackground=!0},c._onFocus=()=>{c.disablePerformanceMonitorInBackground&&c.performanceMonitor.enable(),c._windowIsBackground=!1},c._onCanvasPointerOut=D=>{document.elementFromPoint(D.clientX,D.clientY)!==r&&c.onCanvasPointerOutObservable.notifyObservers(D)};const W=c.getHostWindow();W&&"function"===typeof W.addEventListener&&(W.addEventListener("blur",c._onBlur),W.addEventListener("focus",c._onFocus)),r.addEventListener("pointerout",c._onCanvasPointerOut),D.doNotHandleTouchAction||function(c){c&&c.setAttribute&&(c.setAttribute("touch-action","none"),c.style.touchAction="none",c.style.webkitTapHighlightColor="transparent")}(r),!j.b.audioEngine&&D.audioEngine&&j.b.AudioEngineFactory&&(j.b.audioEngine=j.b.AudioEngineFactory(c.getRenderingCanvas(),c.getAudioContext(),c.getAudioDestination())),(0,q.d)()&&(c._onFullscreenChange=()=>{c.isFullscreen=!!document.fullscreenElement,c.isFullscreen&&c._pointerLockRequested&&r&&X(r)},document.addEventListener("fullscreenchange",c._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",c._onFullscreenChange,!1),c._onPointerLockChange=()=>{c.isPointerLock=document.pointerLockElement===r},document.addEventListener("pointerlockchange",c._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",c._onPointerLockChange,!1)),c.enableOfflineSupport=void 0!==j.b.OfflineProviderFactory,c._deterministicLockstep=!!D.deterministicLockstep,c._lockstepMaxSteps=D.lockstepMaxSteps||0,c._timeStep=D.timeStep||1/60}(this,c,this._creationOptions)}resizeImageBitmap(c,r,D){return function(c,r,D,W){const B=c.createCanvas(D,W).getContext("2d");if(!B)throw new Error("Unable to get 2d context for resizeImageBitmap");return B.drawImage(r,0,0),B.getImageData(0,0,D,W).data}(this,c,r,D)}async _createImageBitmapFromSource(c,r){return await async function(c,r,D){return await new Promise(((W,B)=>{const t=new Image;t.onload=()=>{t.decode().then((()=>{c.createImageBitmap(t,D).then((c=>{W(c)}))}))},t.onerror=()=>{B(`Error loading image ${t.src}`)},t.src=r}))}(this,c,r)}switchFullscreen(c){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(c)}enterFullscreen(c){this.isFullscreen||(this._pointerLockRequested=c,this._renderingCanvas&&function(c){const r=c.requestFullscreen||c.webkitRequestFullscreen;r&&r.call(c)}(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&function(){const c=document;document.exitFullscreen?document.exitFullscreen():c.webkitCancelFullScreen&&c.webkitCancelFullScreen()}()}setDitheringState(c){c?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(c){c?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}setDirectViewport(c,r,D,W){const B=this._cachedViewport;return this._cachedViewport=null,this._viewport(c,r,D,W),B}scissorClear(c,r,D,W,B){this.enableScissor(c,r,D,W),this.clear(B,!0,!0,!0),this.disableScissor()}enableScissor(c,r,D,W){const B=this._gl;B.enable(B.SCISSOR_TEST),B.scissor(c,r,D,W)}disableScissor(){const c=this._gl;c.disable(c.SCISSOR_TEST)}async _loadFileAsync(c,r,D){return await new Promise(((W,B)=>{this._loadFile(c,(c=>{W(c)}),void 0,r,D,((c,r)=>{B(r)}))}))}getVertexShaderSource(c){const r=this._gl.getAttachedShaders(c);return r?this._gl.getShaderSource(r[0]):null}getFragmentShaderSource(c){const r=this._gl.getAttachedShaders(c);return r?this._gl.getShaderSource(r[1]):null}set framebufferDimensionsObject(c){this._framebufferDimensionsObject=c,this._framebufferDimensionsObject&&this.onResizeObservable.notifyObservers(this)}_rebuildBuffers(){for(const c of this.scenes)c.resetCachedMaterial(),c._rebuildGeometries();for(const c of this._virtualScenes)c.resetCachedMaterial(),c._rebuildGeometries();super._rebuildBuffers()}getFontOffset(c){return function(c){const r=document.createElement("span");r.textContent="Hg",r.style.font=c;const D=document.createElement("div");D.style.display="inline-block",D.style.width="1px",D.style.height="0px",D.style.verticalAlign="bottom";const W=document.createElement("div");W.style.whiteSpace="nowrap",W.appendChild(r),W.appendChild(D),document.body.appendChild(W);let B=0,t=0;try{t=D.getBoundingClientRect().top-r.getBoundingClientRect().top,D.style.verticalAlign="baseline",B=D.getBoundingClientRect().top-r.getBoundingClientRect().top}finally{document.body.removeChild(W)}return{ascent:B,height:t,descent:t-B}}(c)}_cancelFrame(){if(this.customAnimationFrameRequester){if(0!==this._frameHandler){this._frameHandler=0;const{cancelAnimationFrame:c}=this.customAnimationFrameRequester;c&&c(this.customAnimationFrameRequester.m)}}else super._cancelFrame()}_renderLoop(c){this._processFrame(c),this._activeRenderLoops.length>0&&0===this._frameHandler&&(this.customAnimationFrameRequester?(this.customAnimationFrameRequester.m=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.m):this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()))}enterPointerlock(){this._renderingCanvas&&X(this._renderingCanvas)}exitPointerlock(){document.exitPointerLock&&document.exitPointerLock()}lt(){this._measureFps(),super.lt()}_deletePipelineContext(c){const r=c;r&&r.program&&r.transformFeedback&&(this.deleteTransformFeedback(r.transformFeedback),r.transformFeedback=null),super._deletePipelineContext(c)}createShaderProgram(c,r,D,W,B){let t=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;B=B||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);const u=super.createShaderProgram(c,r,D,W,B,t);return this.onAfterShaderCompilationObservable.notifyObservers(this),u}_createShaderProgram(c,r,D,W){let B=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const t=W.createProgram();if(c.program=t,!t)throw new Error("Unable to create program");if(W.attachShader(t,r),W.attachShader(t,D),this.webGLVersion>1&&B){const r=this.createTransformFeedback();this.bindTransformFeedback(r),this.setTranformFeedbackVaryings(t,B),c.transformFeedback=r}return W.linkProgram(t),this.webGLVersion>1&&B&&this.bindTransformFeedback(null),c.context=W,c.vertexShader=r,c.fragmentShader=D,c.isParallelCompiled||this._finalizePipelineContext(c),t}_releaseTexture(c){super._releaseTexture(c)}_releaseRenderTargetWrapper(c){super._releaseRenderTargetWrapper(c);for(const r of this.scenes){for(const D of r.postProcesses)D._outputTexture===c&&(D._outputTexture=null);for(const D of r.cameras)for(const r of D._postProcesses)r&&r._outputTexture===c&&(r._outputTexture=null)}}_rescaleTexture(c,r,D,W,B){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);const t=this.createRenderTargetTexture({width:r.width,height:r.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});if(!this._rescalePostProcess&&U._RescalePostProcessFactory&&(this._rescalePostProcess=U._RescalePostProcessFactory(this)),this._rescalePostProcess){this._rescalePostProcess.externalTextureSamplerBinding=!0;const u=()=>{this._rescalePostProcess.onApply=function(r){r._bindTexture("textureSampler",c)};let u=D;u||(u=this.scenes[this.scenes.length-1]),u.postProcessManager.directRender([this._rescalePostProcess],t,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,r,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,W,0,0,r.width,r.height,0),this.unBindFramebuffer(t),t.dispose(),B&&B()},a=this._rescalePostProcess.getEffect();a?a.executeWhenCompiled(u):this._rescalePostProcess.onEffectCreatedObservable.addOnce((c=>{c.executeWhenCompiled(u)}))}}wrapWebGLTexture(c){let r=arguments.length>1&&void 0!==arguments[1]&&arguments[1],D=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3,B=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,t=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;const u=new E.b(c,this._gl),a=new W.e(this,0,!0);return a._hardwareTexture=u,a.baseWidth=B,a.baseHeight=t,a.width=B,a.height=t,a.isReady=!0,a.useMipMaps=r,this.updateTextureSamplingMode(D,a),a}_uploadImageToTexture(c,r){let D=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const B=this._gl,t=this._getWebGLTextureType(c.type),u=this._getInternalFormat(c.format),a=this._getRGBABufferInternalSizedFormat(c.type,u),H=c.isCube?B.TEXTURE_CUBE_MAP:B.TEXTURE_2D;this._bindTextureDirectly(H,c,!0),this._unpackFlipY(c.invertY);let x=B.TEXTURE_2D;c.isCube&&(x=B.TEXTURE_CUBE_MAP_POSITIVE_X+D),B.texImage2D(x,W,a,u,t,r),this._bindTextureDirectly(H,null,!0)}updateTextureComparisonFunction(c,r){if(1===this.webGLVersion)return void M.e.Error("WebGL 1 does not support texture comparison.");const D=this._gl;c.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,c,!0),0===r?(D.texParameteri(D.TEXTURE_CUBE_MAP,D.TEXTURE_COMPARE_FUNC,515),D.texParameteri(D.TEXTURE_CUBE_MAP,D.TEXTURE_COMPARE_MODE,D.NONE)):(D.texParameteri(D.TEXTURE_CUBE_MAP,D.TEXTURE_COMPARE_FUNC,r),D.texParameteri(D.TEXTURE_CUBE_MAP,D.TEXTURE_COMPARE_MODE,D.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,c,!0),0===r?(D.texParameteri(D.TEXTURE_2D,D.TEXTURE_COMPARE_FUNC,515),D.texParameteri(D.TEXTURE_2D,D.TEXTURE_COMPARE_MODE,D.NONE)):(D.texParameteri(D.TEXTURE_2D,D.TEXTURE_COMPARE_FUNC,r),D.texParameteri(D.TEXTURE_2D,D.TEXTURE_COMPARE_MODE,D.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),c._comparisonFunction=r}createInstancesBuffer(c){const r=this._gl.createBuffer();if(!r)throw new Error("Unable to create instance buffer");const D=new x.d(r);return D.wD=c,this.bindArrayBuffer(D),this._gl.bufferData(this._gl.ARRAY_BUFFER,c,this._gl.DYNAMIC_DRAW),D.references=1,D}deleteInstancesBuffer(c){this._gl.deleteBuffer(c)}async _clientWaitAsync(c){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,D=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;const W=this._gl;return await new Promise(((B,t)=>{(0,y.f)((()=>{const D=W.clientWaitSync(c,r,0);if(D==W.WAIT_FAILED)throw new Error("clientWaitSync failed");return D!=W.TIMEOUT_EXPIRED}),B,t,D)}))}_readPixelsAsync(c,r,D,W,B,t,u){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");const a=this._gl,H=a.createBuffer();a.bindBuffer(a.PIXEL_PACK_BUFFER,H),a.bufferData(a.PIXEL_PACK_BUFFER,u.byteLength,a.STREAM_READ),a.readPixels(c,r,D,W,B,t,0),a.bindBuffer(a.PIXEL_PACK_BUFFER,null);const x=a.fenceSync(a.SYNC_GPU_COMMANDS_COMPLETE,0);return x?(a.flush(),this._clientWaitAsync(x,0,10).then((()=>(a.deleteSync(x),a.bindBuffer(a.PIXEL_PACK_BUFFER,H),a.getBufferSubData(a.PIXEL_PACK_BUFFER,0,u),a.bindBuffer(a.PIXEL_PACK_BUFFER,null),a.deleteBuffer(H),u)))):null}dispose(){this.hideLoadingUI(),this._rescalePostProcess&&this._rescalePostProcess.dispose(),function(c,r){1===B.c.Instances.length&&j.b.audioEngine&&(j.b.audioEngine.dispose(),j.b.audioEngine=null);const D=c.getHostWindow();D&&"function"===typeof D.removeEventListener&&(D.removeEventListener("blur",c._onBlur),D.removeEventListener("focus",c._onFocus)),r&&(r.removeEventListener("focus",c._onCanvasFocus),r.removeEventListener("blur",c._onCanvasBlur),r.removeEventListener("pointerout",c._onCanvasPointerOut),r.removeEventListener("contextmenu",c._onCanvasContextMenu)),(0,q.d)()&&(document.removeEventListener("fullscreenchange",c._onFullscreenChange),document.removeEventListener("mozfullscreenchange",c._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",c._onFullscreenChange),document.removeEventListener("msfullscreenchange",c._onFullscreenChange),document.removeEventListener("pointerlockchange",c._onPointerLockChange),document.removeEventListener("mspointerlockchange",c._onPointerLockChange),document.removeEventListener("mozpointerlockchange",c._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",c._onPointerLockChange))}(this,this._renderingCanvas),super.dispose()}}U.ALPHA_DISABLE=0,U.ALPHA_ADD=1,U.ALPHA_COMBINE=2,U.ALPHA_SUBTRACT=3,U.ALPHA_MULTIPLY=4,U.ALPHA_MAXIMIZED=5,U.ALPHA_ONEONE=6,U.ALPHA_PREMULTIPLIED=7,U.ALPHA_PREMULTIPLIED_PORTERDUFF=8,U.ALPHA_INTERPOLATE=9,U.ALPHA_SCREENMODE=10,U.DELAYLOADSTATE_NONE=0,U.DELAYLOADSTATE_LOADED=1,U.DELAYLOADSTATE_LOADING=2,U.DELAYLOADSTATE_NOTLOADED=4,U.NEVER=512,U.ALWAYS=519,U.LESS=513,U.EQUAL=514,U.LEQUAL=515,U.GREATER=516,U.GEQUAL=518,U.NOTEQUAL=517,U.KEEP=7680,U.REPLACE=7681,U.INCR=7682,U.DECR=7683,U.INVERT=5386,U.INCR_WRAP=34055,U.DECR_WRAP=34056,U.TEXTURE_CLAMP_ADDRESSMODE=0,U.TEXTURE_WRAP_ADDRESSMODE=1,U.TEXTURE_MIRROR_ADDRESSMODE=2,U.TEXTUREFORMAT_ALPHA=0,U.TEXTUREFORMAT_LUMINANCE=1,U.TEXTUREFORMAT_LUMINANCE_ALPHA=2,U.TEXTUREFORMAT_RGB=4,U.TEXTUREFORMAT_RGBA=5,U.TEXTUREFORMAT_RED=6,U.TEXTUREFORMAT_R=6,U.TEXTUREFORMAT_R16_UNORM=33322,U.TEXTUREFORMAT_RG16_UNORM=33324,U.TEXTUREFORMAT_RGB16_UNORM=32852,U.TEXTUREFORMAT_RGBA16_UNORM=32859,U.TEXTUREFORMAT_R16_SNORM=36760,U.TEXTUREFORMAT_RG16_SNORM=36761,U.TEXTUREFORMAT_RGB16_SNORM=36762,U.TEXTUREFORMAT_RGBA16_SNORM=36763,U.TEXTUREFORMAT_RG=7,U.TEXTUREFORMAT_RED_INTEGER=8,U.TEXTUREFORMAT_R_INTEGER=8,U.TEXTUREFORMAT_RG_INTEGER=9,U.TEXTUREFORMAT_RGB_INTEGER=10,U.TEXTUREFORMAT_RGBA_INTEGER=11,U.TEXTURETYPE_UNSIGNED_BYTE=0,U.TEXTURETYPE_UNSIGNED_INT=0,U.TEXTURETYPE_FLOAT=1,U.TEXTURETYPE_HALF_FLOAT=2,U.TEXTURETYPE_BYTE=3,U.TEXTURETYPE_SHORT=4,U.TEXTURETYPE_UNSIGNED_SHORT=5,U.TEXTURETYPE_INT=6,U.TEXTURETYPE_UNSIGNED_INTEGER=7,U.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,U.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,U.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,U.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,U.TEXTURETYPE_UNSIGNED_INT_24_8=12,U.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,U.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,U.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,U.TEXTURE_NEAREST_SAMPLINGMODE=1,U.TEXTURE_BILINEAR_SAMPLINGMODE=2,U.TEXTURE_TRILINEAR_SAMPLINGMODE=3,U.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,U.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,U.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,U.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,U.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,U.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,U.TEXTURE_NEAREST_LINEAR=7,U.TEXTURE_NEAREST_NEAREST=1,U.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,U.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,U.TEXTURE_LINEAR_LINEAR=2,U.TEXTURE_LINEAR_NEAREST=12,U.TEXTURE_EXPLICIT_MODE=0,U.TEXTURE_SPHERICAL_MODE=1,U.TEXTURE_PLANAR_MODE=2,U.TEXTURE_CUBIC_MODE=3,U.TEXTURE_PROJECTION_MODE=4,U.TEXTURE_SKYBOX_MODE=5,U.TEXTURE_INVCUBIC_MODE=6,U.TEXTURE_EQUIRECTANGULAR_MODE=7,U.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,U.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,U.SCALEMODE_FLOOR=1,U.SCALEMODE_NEAREST=2,U.SCALEMODE_CEILING=3},11855:(c,r,D)=>{D.d(r,{c:()=>B});var W=D(11825);class B{get depthStencilTexture(){return this._depthStencilTexture}setDepthStencilTexture(c){(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&this._depthStencilTexture&&this._depthStencilTexture.dispose(),this._depthStencilTexture=c,this._generateDepthBuffer=this._generateStencilBuffer=this._depthStencilTextureWithStencil=!1,c&&(this._generateDepthBuffer=!0,this._generateStencilBuffer=this._depthStencilTextureWithStencil=(0,W.e)(c.format))}get depthStencilTextureWithStencil(){return this._depthStencilTextureWithStencil}get isCube(){return this._isCube}get isMulti(){return this._isMulti}get is2DArray(){return this.layers>0}get is3D(){return this.depth>0}get size(){return this.width}get width(){return this._size.width??this._size}get height(){return this._size.height??this._size}get layers(){return this._size.layers||0}get depth(){return this._size.depth||0}get texture(){var c;return(null===(c=this._textures)||void 0===c?void 0:c[0])??null}get textures(){return this._textures}get faceIndices(){return this._faceIndices}get layerIndices(){return this._layerIndices}getBaseArrayLayer(c){var r,D;if(!this._textures)return-1;const W=this._textures[c],B=(null===(r=this._layerIndices)||void 0===r?void 0:r[c])??0,t=(null===(D=this._faceIndices)||void 0===D?void 0:D[c])??0;return W.isCube?6*B+t:W.is3D?0:B}get samples(){return this._samples}setSamples(c){let r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],D=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this.samples===c&&!D)return c;const W=this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,c,r):this._engine.updateRenderTargetTextureSampleCount(this,c);return this._samples=c,W}resolveMSAATextures(){this.isMulti?this._engine.resolveMultiFramebuffer(this):this._engine.resolveFramebuffer(this)}generateMipMaps(){this._engine._currentRenderTarget===this&&this._engine.unBindFramebuffer(this,!0),this.isMulti?this._engine.generateMipMapsMultiFramebuffer(this):this._engine.generateMipMapsFramebuffer(this)}constructor(c,r,D,W,B){this._textures=null,this._faceIndices=null,this._layerIndices=null,this._samples=1,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this.disableAutomaticMSAAResolve=!1,this.resolveMSAAColors=!0,this.resolveMSAADepth=!1,this.resolveMSAAStencil=!1,this._isMulti=c,this._isCube=r,this._size=D,this._engine=W,this._depthStencilTexture=null,this.label=B}setTextures(c){Array.isArray(c)?this._textures=c:this._textures=c?[c]:null}setTexture(c){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,D=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._textures||(this._textures=[]),this._textures[r]!==c&&(this._textures[r]&&D&&this._textures[r].dispose(),this._textures[r]=c)}setLayerAndFaceIndices(c,r){this._layerIndices=c,this._faceIndices=r}setLayerAndFaceIndex(){let c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1?arguments[1]:void 0,D=arguments.length>2?arguments[2]:void 0;this._layerIndices||(this._layerIndices=[]),this._faceIndices||(this._faceIndices=[]),void 0!==r&&r>=0&&(this._layerIndices[c]=r),void 0!==D&&D>=0&&(this._faceIndices[c]=D)}createDepthStencilTexture(){var c;let r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,D=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],W=arguments.length>2&&void 0!==arguments[2]&&arguments[2],B=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,t=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14,u=arguments.length>5?arguments[5]:void 0;return null===(c=this._depthStencilTexture)||void 0===c||c.dispose(),this._depthStencilTextureWithStencil=W,this._depthStencilTextureLabel=u,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:D,comparisonFunction:r,generateStencil:W,isCube:this._isCube,samples:B,depthTextureFormat:t,label:u},this),this._depthStencilTexture}_shareDepth(c){this.shareDepth(c)}shareDepth(c){this._depthStencilTexture&&(c._depthStencilTexture&&c._depthStencilTexture.dispose(),c._depthStencilTexture=this._depthStencilTexture,c._depthStencilTextureWithStencil=this._depthStencilTextureWithStencil,this._depthStencilTexture.incrementReferences())}_swapAndDie(c){this.texture&&this.texture._swapAndDie(c),this._textures=null,this.dispose(!0)}_cloneRenderTargetWrapper(){let c=null;if(this._isMulti){const r=this.textures;if(r&&r.length>0){let D=!1,W=r.length,B=-1;const t=r[r.length-1]._source;14!==t&&12!==t||(D=!0,B=r[r.length-1].format,W--);const u=[],a=[],H=[],x=[],M=[],E=[],m=[],Y={};for(let c=0;c<W;++c){const D=r[c];u.push(D.samplingMode),a.push(D.type),H.push(D.format);void 0!==Y[D.uniqueId]?(x.push(-1),m.push(0)):(Y[D.uniqueId]=c,D.is2DArray?(x.push(35866),m.push(D.depth)):D.isCube?(x.push(34067),m.push(0)):D.is3D?(x.push(32879),m.push(D.depth)):(x.push(3553),m.push(0))),this._faceIndices&&M.push(this._faceIndices[c]??0),this._layerIndices&&E.push(this._layerIndices[c]??0)}const v={samplingModes:u,generateMipMaps:r[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:D,depthTextureFormat:B,types:a,formats:H,textureCount:W,targetTypes:x,faceIndex:M,layerIndex:E,layerCounts:m,label:this.label},k={width:this.width,height:this.height,depth:this.depth};c=this._engine.createMultipleRenderTarget(k,v);for(let w=0;w<W;++w){if(-1!==x[w])continue;const D=Y[r[w].uniqueId];c.setTexture(c.textures[D],w)}}}else{var r,D,W,B;const u={};if(u.generateDepthBuffer=this._generateDepthBuffer,u.generateMipMaps=(null===(r=this.texture)||void 0===r?void 0:r.generateMipMaps)??!1,u.generateStencilBuffer=this._generateStencilBuffer,u.samplingMode=null===(D=this.texture)||void 0===D?void 0:D.samplingMode,u.type=null===(W=this.texture)||void 0===W?void 0:W.type,u.format=null===(B=this.texture)||void 0===B?void 0:B.format,u.noColorAttachment=!this._textures,u.label=this.label,this.isCube)c=this._engine.createRenderTargetCubeTexture(this.width,u);else{var t;const r={width:this.width,height:this.height,layers:this.is2DArray||this.is3D?null===(t=this.texture)||void 0===t?void 0:t.depth:void 0};c=this._engine.createRenderTargetTexture(r,u)}c.texture&&(c.texture.isReady=!0)}return c}_swapRenderTargetWrapper(c){if(this._textures&&c._textures)for(let r=0;r<this._textures.length;++r)this._textures[r]._swapAndDie(c._textures[r],!1),c._textures[r].isReady=!0;this._depthStencilTexture&&c._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(c._depthStencilTexture),c._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null}_rebuild(){const c=this._cloneRenderTargetWrapper();if(c){if(this._depthStencilTexture){const r=this._depthStencilTexture.samplingMode,D=this._depthStencilTexture.format,W=2===r||3===r||11===r;c.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,W,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples,D,this._depthStencilTextureLabel)}this.samples>1&&c.setSamples(this.samples),c._swapRenderTargetWrapper(this),c.dispose()}}releaseTextures(){if(this._textures)for(let c=0;c<this._textures.length;++c)this._textures[c].dispose();this._textures=null}dispose(){var c;arguments.length>0&&void 0!==arguments[0]&&arguments[0]||(null===(c=this._depthStencilTexture)||void 0===c||c.dispose(),this._depthStencilTexture=null,this.releaseTextures());this._engine._releaseRenderTargetWrapper(this)}}},11797:(c,r,D)=>{D.r(r),D.d(r,{ThinEngine:()=>j});var W=D(11601),B=D(11799),t=D(11509),u=D(11501);class a{constructor(){this.shaderLanguage=0}postProcessor(c,r,D,W,B){if(B.drawBuffersExtensionDisabled){const r=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;c=c.replace(r,"")}return c}}const H=/(flat\s)?\s*varying\s*.*/;class x{constructor(){this.shaderLanguage=0}attributeProcessor(c){return c.replace("attribute","in")}varyingCheck(c,r){return H.test(c)}varyingProcessor(c,r){return c.replace("varying",r?"in":"out")}postProcessor(c,r,D){const W=-1!==c.search(/#extension.+GL_EXT_draw_buffers.+require/);if(c=(c=c.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),D){const r=-1!==c.search(/layout *\(location *= *0\) *out/g);c=(c=(c=(c=(c=(c=(c=c.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/void\s+?main\s*\(/g,(W||r?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(")}else{if(-1!==r.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+c}return c}}var M=D(11808),E=D(11648),m=D(11584),Y=D(11817),v=D(11615),k=D(11586),w=D(11572),Z=D(11597),J=D(11825);class q{}class j extends m.b{get name(){return this._name}set name(c){this._name=c}get version(){return this._webGLVersion}static get ShadersRepository(){return k.Effect.ShadersRepository}static set ShadersRepository(c){k.Effect.ShadersRepository=c}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(c){this._framebufferDimensionsObject=c}snapshotRenderingReset(){this.snapshotRendering=!1}constructor(c,r,D,B){if(D=D||{},super(r??D.antialias,D,B),this._name="WebGL",this.forcePOTTextures=!1,this.validateShaderPrograms=!1,this.disableUniformBuffers=!1,this._webGLVersion=1,this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},!c)return;let u=null;if(c.getContext){if(u=c,void 0===D.aa&&(D.aa=!1),void 0===D.xrCompatible&&(D.xrCompatible=!1),navigator&&navigator.userAgent){this._setupMobileChecks();const c=navigator.userAgent;for(const r of j.ExceptionList){const W=r.key,B=r.targets;if(new RegExp(W).test(c)){if(r.capture&&r.captureConstraint){const D=r.capture,W=r.captureConstraint,B=new RegExp(D).exec(c);if(B&&B.length>0){if(parseInt(B[B.length-1])>=W)continue}}for(const c of B)switch(c){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":D.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1}}}}if(this._doNotHandleContextLost?this._onContextLost=()=>{(0,W.A)(this._gl)}:(this._onContextLost=c=>{c.preventDefault(),this._contextWasLost=!0,(0,W.A)(this._gl),t.e.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost((()=>this._initGLContext()))},u.addEventListener("webglcontextrestored",this._onContextRestored,!1),D.powerPreference=D.powerPreference||"high-performance"),u.addEventListener("webglcontextlost",this._onContextLost,!1),this._badDesktopOS&&(D.xrCompatible=!1),!D.disableWebGL2Support)try{this._gl=u.getContext("webgl2",D)||u.getContext("experimental-webgl2",D),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch(E){}if(!this._gl){if(!u)throw new Error("The provided canvas is null or undefined.");try{this._gl=u.getContext("webgl",D)||u.getContext("experimental-webgl",D)}catch(E){throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=c,u=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const r=this._gl.getContextAttributes();r&&(D.stencil=r.stencil)}this._sharedInit(u),this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),void 0!==D.useHighPrecisionFloats&&(this._highPrecisionShadersAllowed=D.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let W=0;W<this._caps.maxVertexAttribs;W++)this._currentBufferPointers[W]=new q;this._shaderProcessor=this.webGLVersion>1?new x:new a;const H=`Babylon.js v${j.Version}`;t.e.Log(H+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",H);const M=(0,W.C)(this._gl);M.validateShaderPrograms=this.validateShaderPrograms,M.parallelShaderCompile=this._caps.parallelShaderCompile}_clearEmptyResources(){this._dummyFramebuffer=null,super._clearEmptyResources()}_getShaderProcessingContext(c){return null}areAllEffectsReady(){for(const c in this._compiledEffects){if(!this._compiledEffects[c].isReady())return!1}return!0}_initGLContext(){this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||null!==this._gl.getExtension("OES_standard_derivatives"),maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||null!==this._gl.getExtension("OES_element_index_uint"),fragmentDepthSupported:this._webGLVersion>1||null!==this._gl.getExtension("EXT_frag_depth"),highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,colorBufferHalfFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_half_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:1!==this._webGLVersion,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1,textureNorm16:!!this._gl.getExtension("EXT_texture_norm16")},this._caps.supportFloatTexturesResolve=this._caps.colorBufferFloat,this._caps.rg11b10ufColorRenderable=this._caps.colorBufferFloat,this._glVersion=this._gl.getParameter(this._gl.VERSION);const c=this._gl.getExtension("WEBGL_debug_renderer_info");if(null!=c&&(this._glRenderer=this._gl.getParameter(c.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(c.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),36193!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=36193),34842!==this._gl.RGBA16F&&(this._gl.RGBA16F=34842),34836!==this._gl.RGBA32F&&(this._gl.RGBA32F=34836),35056!==this._gl.DEPTH24_STENCIL8&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(1===this._webGLVersion&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=(this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)??0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!(!this._caps.textureFloat||!this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!(!this._caps.textureFloat||!this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.textureNorm16&&(this._gl.R16_EXT=33322,this._gl.RG16_EXT=33324,this._gl.RGB16_EXT=32852,this._gl.RGBA16_EXT=32859,this._gl.R16_SNORM_EXT=36760,this._gl.RG16_SNORM_EXT=36761,this._gl.RGB16_SNORM_EXT=36762,this._gl.RGBA16_SNORM_EXT=36763),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&5131!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=null!==this._maxMSAASamplesOverride?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES),this._caps.maxDrawBuffers=this._gl.getParameter(this._gl.MAX_DRAW_BUFFERS);else{const c=this._gl.getExtension("WEBGL_draw_buffers");if(null!==c){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=c.drawBuffersWEBGL.bind(c),this._caps.maxDrawBuffers=this._gl.getParameter(c.MAX_DRAW_BUFFERS_WEBGL),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let r=0;r<16;r++)this._gl["COLOR_ATTACHMENT"+r+"_WEBGL"]=c["COLOR_ATTACHMENT"+r+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{const c=this._gl.getExtension("WEBGL_depth_texture");null!=c&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=c.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{const c=this._gl.getExtension("OES_vertex_array_object");null!=c&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=c.createVertexArrayOES.bind(c),this._gl.bindVertexArray=c.bindVertexArrayOES.bind(c),this._gl.deleteVertexArray=c.deleteVertexArrayOES.bind(c))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{const c=this._gl.getExtension("ANGLE_instanced_arrays");null!=c?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=c.drawArraysInstancedANGLE.bind(c),this._gl.drawElementsInstanced=c.drawElementsInstancedANGLE.bind(c),this._gl.vertexAttribDivisor=c.vertexAttribDivisorANGLE.bind(c)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){const c=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),r=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);c&&r&&(this._caps.highPrecisionShaderSupported=0!==c.precision&&0!==r.precision)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{const c=this._gl.getExtension("EXT_blend_minmax");null!=c&&(this._caps.blendMinMax=!0,this._gl.MAX=c.MAX_EXT,this._gl.MIN=c.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:WebGL2RenderingContext.SRGB,SRGB8:WebGL2RenderingContext.SRGB8,SRGB8_ALPHA8:WebGL2RenderingContext.SRGB8_ALPHA8};else{const c=this._gl.getExtension("EXT_sRGB");null!=c&&(this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:c.SRGB_EXT,SRGB8:c.SRGB_ALPHA_EXT,SRGB8_ALPHA8:c.SRGB_ALPHA_EXT})}if(this._creationOptions){const c=this._creationOptions.forceSRGBBufferSupportState;void 0!==c&&(this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&c)}}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let r=0;r<this._maxSimultaneousTextures;r++)this._nextFreeTextureSlots.push(r);"Mali-G72"===this._glRenderer&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:"undefined"===typeof HTMLImageElement,supportRenderAndCopyToLodForFloatTextures:1!==this._webGLVersion,supportDepthStencilTexture:1!==this._webGLVersion,supportShadowSamplers:1!==this._webGLVersion,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:1!==this._webGLVersion,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:1!==this._webGLVersion,basisNeedsPOT:1===this._webGLVersion,support3DTextures:1!==this._webGLVersion,needTypeSuffixInShaderConstants:1!==this._webGLVersion,supportMSAA:1!==this._webGLVersion,supportSSAO2:1!==this._webGLVersion,supportIBLShadows:1!==this._webGLVersion,supportExtendedTextureFormats:1!==this._webGLVersion,supportSwitchCaseInShader:1!==this._webGLVersion,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,forceVertexBufferStrideAndOffsetMultiple4Bytes:!1,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const c=this._workingCanvas.getContext("2d");c&&(this._workingContext=c)}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}extractDriverInfo(){const c=this.getGlInfo();return c&&c.renderer?c.renderer:""}getRenderWidth(){return!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(){return!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}clear(c,r,D){let W=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const B=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=B;let t=0;if(r&&c){let r=!0;if(this._currentRenderTarget){var u;const D=null===(u=this._currentRenderTarget.texture)||void 0===u?void 0:u.format;if(8===D||9===D||10===D||11===D){var a;const D=null===(a=this._currentRenderTarget.texture)||void 0===a?void 0:a.type;7===D||5===D?(j._TempClearColorUint32[0]=255*c.r,j._TempClearColorUint32[1]=255*c.g,j._TempClearColorUint32[2]=255*c.b,j._TempClearColorUint32[3]=255*c.a,this._gl.clearBufferuiv(this._gl.COLOR,0,j._TempClearColorUint32),r=!1):(j._TempClearColorInt32[0]=255*c.r,j._TempClearColorInt32[1]=255*c.g,j._TempClearColorInt32[2]=255*c.b,j._TempClearColorInt32[3]=255*c.a,this._gl.clearBufferiv(this._gl.COLOR,0,j._TempClearColorInt32),r=!1)}}r&&(this._gl.clearColor(c.r,c.g,c.b,void 0!==c.a?c.a:1),t|=this._gl.COLOR_BUFFER_BIT)}D&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),t|=this._gl.DEPTH_BUFFER_BIT),W&&(this._gl.clearStencil(0),t|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(t)}_viewport(c,r,D,W){c===this._viewportCached.x&&r===this._viewportCached.y&&D===this._viewportCached.z&&W===this._viewportCached.w||(this._viewportCached.x=c,this._viewportCached.y=r,this._viewportCached.z=D,this._viewportCached.w=W,this._gl.viewport(c,r,D,W))}Da(){super.Da(),this._badOS&&this.flushFramebuffer()}get performanceMonitor(){throw new Error("Not Supported by ThinEngine")}bindFramebuffer(c){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,D=arguments.length>2?arguments[2]:void 0,W=arguments.length>3?arguments[3]:void 0,B=arguments.length>4?arguments[4]:void 0,u=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;const H=c;this._currentRenderTarget&&this._resolveAndGenerateMipMapsFramebuffer(this._currentRenderTarget),this._currentRenderTarget=c,this._bindUnboundFramebuffer(H._framebuffer);const x=this._gl;var M;if(!c.isMulti)if(c.is2DArray||c.is3D)x.framebufferTextureLayer(x.FRAMEBUFFER,x.COLOR_ATTACHMENT0,null===(M=c.texture._hardwareTexture)||void 0===M?void 0:M.underlyingResource,u,a),H._currentLOD=u;else if(c.isCube){var E;x.framebufferTexture2D(x.FRAMEBUFFER,x.COLOR_ATTACHMENT0,x.TEXTURE_CUBE_MAP_POSITIVE_X+r,null===(E=c.texture._hardwareTexture)||void 0===E?void 0:E.underlyingResource,u)}else if(H._currentLOD!==u){var m;x.framebufferTexture2D(x.FRAMEBUFFER,x.COLOR_ATTACHMENT0,x.TEXTURE_2D,null===(m=c.texture._hardwareTexture)||void 0===m?void 0:m.underlyingResource,u),H._currentLOD=u}const Y=c._depthStencilTexture;if(Y){c.is3D&&(c.texture.width===Y.width&&c.texture.height===Y.height&&c.texture.depth===Y.depth||t.e.Warn("Depth/Stencil attachment for 3D target must have same dimensions as color attachment"));const D=c._depthStencilTextureWithStencil?x.DEPTH_STENCIL_ATTACHMENT:x.DEPTH_ATTACHMENT;var v;if(c.is2DArray||c.is3D)x.framebufferTextureLayer(x.FRAMEBUFFER,D,null===(v=Y._hardwareTexture)||void 0===v?void 0:v.underlyingResource,u,a);else if(c.isCube){var k;x.framebufferTexture2D(x.FRAMEBUFFER,D,x.TEXTURE_CUBE_MAP_POSITIVE_X+r,null===(k=Y._hardwareTexture)||void 0===k?void 0:k.underlyingResource,u)}else{var w;x.framebufferTexture2D(x.FRAMEBUFFER,D,x.TEXTURE_2D,null===(w=Y._hardwareTexture)||void 0===w?void 0:w.underlyingResource,u)}}H._MSAAFramebuffer&&this._bindUnboundFramebuffer(H._MSAAFramebuffer),this._cachedViewport&&!B?this.setViewport(this._cachedViewport,D,W):(D||(D=c.width,u&&(D/=Math.pow(2,u))),W||(W=c.height,u&&(W/=Math.pow(2,u))),this._viewport(0,0,D,W)),this.wipeCaches()}setStateCullFaceType(c,r){const D=this.cullBackFaces??c??1?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==D||r)&&(this._depthCullingState.cullFace=D)}setState(c){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,D=arguments.length>2?arguments[2]:void 0,W=arguments.length>3&&void 0!==arguments[3]&&arguments[3],B=arguments.length>4?arguments[4]:void 0,t=arguments.length>5?arguments[5]:void 0,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;(this._depthCullingState.cull!==c||D)&&(this._depthCullingState.cull=c),this.setStateCullFaceType(B,D),this.setZOffset(r),this.setZOffsetUnits(u);const a=W?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==a||D)&&(this._depthCullingState.frontFace=a),this._stencilStateComposer.stencilMaterial=t}_resolveAndGenerateMipMapsFramebuffer(c){let r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];c.disableAutomaticMSAAResolve||(c.isMulti?this.resolveMultiFramebuffer(c):this.resolveFramebuffer(c)),r||(c.isMulti?this.generateMipMapsMultiFramebuffer(c):this.generateMipMapsFramebuffer(c))}_bindUnboundFramebuffer(c){this._currentFramebuffer!==c&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,c),this._currentFramebuffer=c)}_currentFrameBufferIsDefaultFrameBuffer(){return null===this._currentFramebuffer}generateMipmaps(c){const r=this._getTextureTarget(c);this._bindTextureDirectly(r,c,!0),this._gl.generateMipmap(r),this._bindTextureDirectly(r,null)}unBindFramebuffer(c,r,D){const W=c;this._currentRenderTarget=null,this._resolveAndGenerateMipMapsFramebuffer(c,r),D&&(W._MSAAFramebuffer&&this._bindUnboundFramebuffer(W._framebuffer),D()),this._bindUnboundFramebuffer(null)}generateMipMapsFramebuffer(c){var r;c.isMulti||null===(r=c.texture)||void 0===r||!r.generateMipMaps||c.isCube||this.generateMipmaps(c.texture)}resolveFramebuffer(c){const r=c,D=this._gl;if(!r._MSAAFramebuffer||r.isMulti)return;let W=r.resolveMSAAColors?D.COLOR_BUFFER_BIT:0;W|=r._generateDepthBuffer&&r.resolveMSAADepth?D.DEPTH_BUFFER_BIT:0,W|=r._generateStencilBuffer&&r.resolveMSAAStencil?D.STENCIL_BUFFER_BIT:0,D.bindFramebuffer(D.READ_FRAMEBUFFER,r._MSAAFramebuffer),D.bindFramebuffer(D.DRAW_FRAMEBUFFER,r._framebuffer),D.blitFramebuffer(0,0,c.width,c.height,0,0,c.width,c.height,W,D.NEAREST)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(c,r,D){return this._createVertexBuffer(c,this._gl.STATIC_DRAW)}_createVertexBuffer(c,r){const D=this._gl.createBuffer();if(!D)throw new Error("Unable to create vertex buffer");const W=new M.d(D);return this.bindArrayBuffer(W),"number"!==typeof c?c instanceof Array?(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(c),r),W.wD=4*c.length):(this._gl.bufferData(this._gl.ARRAY_BUFFER,c,r),W.wD=c.byteLength):(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Uint8Array(c),r),W.wD=c),this._resetVertexBufferBinding(),W.references=1,W}createDynamicVertexBuffer(c,r){return this._createVertexBuffer(c,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(c,r,D){const W=this._gl.createBuffer(),B=new M.d(W);if(!W)throw new Error("Unable to create index buffer");this.bindIndexBuffer(B);const t=this._normalizeIndexData(c);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,t,r?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),B.references=1,B.is32Bits=4===t.BYTES_PER_ELEMENT,B}_normalizeIndexData(c){if(2===c.BYTES_PER_ELEMENT)return c;if(this._caps.uintIndices){if(c instanceof Uint32Array)return c;for(let r=0;r<c.length;r++)if(c[r]>=65535)return new Uint32Array(c);return new Uint16Array(c)}return new Uint16Array(c)}bindArrayBuffer(c){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(c,this._gl.ARRAY_BUFFER)}bindUniformBlock(c,r,D){const W=c.program,B=this._gl.getUniformBlockIndex(W,r);this._gl.uniformBlockBinding(W,B,D)}bindIndexBuffer(c){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(c,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(c,r){(this._vaoRecordInProgress||this._currentBoundBuffer[r]!==c)&&(this._gl.bindBuffer(r,c?c.underlyingResource:null),this._currentBoundBuffer[r]=c)}updateArrayBuffer(c){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,c)}_vertexAttribPointer(c,r,D,W,B,t,u){const a=this._currentBufferPointers[r];if(!a)return;let H=!1;a.active?(a.buffer!==c&&(a.buffer=c,H=!0),a.size!==D&&(a.size=D,H=!0),a.type!==W&&(a.type=W,H=!0),a.normalized!==B&&(a.normalized=B,H=!0),a.stride!==t&&(a.stride=t,H=!0),a.offset!==u&&(a.offset=u,H=!0)):(H=!0,a.active=!0,a.index=r,a.size=D,a.type=W,a.normalized=B,a.stride=t,a.offset=u,a.buffer=c),(H||this._vaoRecordInProgress)&&(this.bindArrayBuffer(c),W===this._gl.UNSIGNED_INT||W===this._gl.INT?this._gl.vertexAttribIPointer(r,D,W,t,u):this._gl.vertexAttribPointer(r,D,W,B,t,u))}_bindIndexBufferWithCache(c){null!=c&&this._cachedIndexBuffer!==c&&(this._cachedIndexBuffer=c,this.bindIndexBuffer(c),this._uintIndicesCurrentlySet=c.is32Bits)}_bindVertexBuffersAttributes(c,r,D){const W=r.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let B=0;B<W.length;B++){const t=r.getAttributeLocation(B);if(t>=0){const r=W[B];let u=null;if(D&&(u=D[r]),u||(u=c[r]),!u)continue;this._gl.enableVertexAttribArray(t),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[t]=!0);const a=u.getBuffer();a&&(this._vertexAttribPointer(a,t,u.getSize(),u.type,u.normalized,u.byteStride,u.byteOffset),u.getIsInstanced()&&(this._gl.vertexAttribDivisor(t,u.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(t),this._currentInstanceBuffers.push(a))))}}}recordVertexArrayObject(c,r,D,W){const B=this._gl.createVertexArray();if(!B)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(B),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(c,D,W),this.bindIndexBuffer(r),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),B}bindVertexArrayObject(c,r){this._cachedVertexArrayObject!==c&&(this._cachedVertexArrayObject=c,this._gl.bindVertexArray(c),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=null!=r&&r.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(c,r,D,W,B){if(this._cachedVertexBuffers!==c||this._cachedEffectForVertexBuffers!==B){this._cachedVertexBuffers=c,this._cachedEffectForVertexBuffers=B;const r=B.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let t=0;for(let u=0;u<r;u++)if(u<D.length){const r=B.getAttributeLocation(u);r>=0&&(this._gl.enableVertexAttribArray(r),this._vertexAttribArraysEnabled[r]=!0,this._vertexAttribPointer(c,r,D[u],this._gl.FLOAT,!1,W,t)),t+=4*D[u]}}this._bindIndexBufferWithCache(r)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(c,r,D,W){this._cachedVertexBuffers===c&&this._cachedEffectForVertexBuffers===D||(this._cachedVertexBuffers=c,this._cachedEffectForVertexBuffers=D,this._bindVertexBuffersAttributes(c,D,W)),this._bindIndexBufferWithCache(r)}unbindInstanceAttributes(){let c;for(let r=0,D=this._currentInstanceLocations.length;r<D;r++){const D=this._currentInstanceBuffers[r];c!=D&&D.references&&(c=D,this.bindArrayBuffer(D));const W=this._currentInstanceLocations[r];this._gl.vertexAttribDivisor(W,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(c){this._gl.deleteVertexArray(c)}_releaseBuffer(c){return c.references--,0===c.references&&(this._deleteBuffer(c),!0)}_deleteBuffer(c){this._gl.deleteBuffer(c.underlyingResource)}updateAndBindInstancesBuffer(c,r,D){if(this.bindArrayBuffer(c),r&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,r),void 0!==D[0].index)this.bindInstancesBuffer(c,D,!0);else for(let W=0;W<4;W++){const r=D[W];this._vertexAttribArraysEnabled[r]||(this._gl.enableVertexAttribArray(r),this._vertexAttribArraysEnabled[r]=!0),this._vertexAttribPointer(c,r,4,this._gl.FLOAT,!1,64,16*W),this._gl.vertexAttribDivisor(r,1),this._currentInstanceLocations.push(r),this._currentInstanceBuffers.push(c)}}bindInstancesBuffer(c,r){let D=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.bindArrayBuffer(c);let W=0;if(D)for(let B=0;B<r.length;B++){W+=4*r[B].attributeSize}for(let B=0;B<r.length;B++){const D=r[B];void 0===D.index&&(D.index=this._currentEffect.getAttributeLocationByName(D.attributeName)),D.index<0||(this._vertexAttribArraysEnabled[D.index]||(this._gl.enableVertexAttribArray(D.index),this._vertexAttribArraysEnabled[D.index]=!0),this._vertexAttribPointer(c,D.index,D.attributeSize,D.attributeType||this._gl.FLOAT,D.normalized||!1,W,D.offset),this._gl.vertexAttribDivisor(D.index,void 0===D.divisor?1:D.divisor),this._currentInstanceLocations.push(D.index),this._currentInstanceBuffers.push(c))}}disableInstanceAttributeByName(c){if(!this._currentEffect)return;const r=this._currentEffect.getAttributeLocationByName(c);this.disableInstanceAttribute(r)}disableInstanceAttribute(c){let r,D=!1;for(;-1!==(r=this._currentInstanceLocations.indexOf(c));)this._currentInstanceLocations.splice(r,1),this._currentInstanceBuffers.splice(r,1),D=!0,r=this._currentInstanceLocations.indexOf(c);D&&(this._gl.vertexAttribDivisor(c,0),this.disableAttributeByIndex(c))}disableAttributeByIndex(c){this._gl.disableVertexAttribArray(c),this._vertexAttribArraysEnabled[c]=!1,this._currentBufferPointers[c].active=!1}draw(c,r,D,W){this.drawElementsType(c?0:1,r,D,W)}drawPointClouds(c,r,D){this.drawArraysType(2,c,r,D)}drawUnIndexed(c,r,D,W){this.drawArraysType(c?0:1,r,D,W)}drawElementsType(c,r,D,W){this.applyStates(),this._reportDrawCall();const B=this._drawMode(c),t=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,u=this._uintIndicesCurrentlySet?4:2;W?this._gl.drawElementsInstanced(B,D,t,r*u,W):this._gl.drawElements(B,D,t,r*u)}drawArraysType(c,r,D,W){this.applyStates(),this._reportDrawCall();const B=this._drawMode(c);W?this._gl.drawArraysInstanced(B,r,D,W):this._gl.drawArrays(B,r,D)}_drawMode(c){switch(c){case 0:default:return this._gl.TRIANGLES;case 2:case 3:return this._gl.POINTS;case 1:case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN}}_releaseEffect(c){this._compiledEffects[c._key]&&delete this._compiledEffects[c._key];const r=c.getPipelineContext();r&&this._deletePipelineContext(r)}_deletePipelineContext(c){const r=c;r&&r.program&&(r.program.__SPECTOR_rebuildProgram=null,(0,Z.l)(r),this._gl&&(this._currentProgram===r.program&&this._setProgram(null),this._gl.deleteProgram(r.program)))}_getGlobalDefines(c){return(0,w.g)(c,this.isNDCHalfZRange,this.useReverseDepthBuffer,this.useExactSrgbConversions)}createEffect(c,r,D,B,t,u,a,H,x){let M=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,E=arguments.length>10?arguments[10]:void 0;const m="string"===typeof c?c:c.vertexToken||c.vertexSource||c.vertexElement||c.vertex,Y="string"===typeof c?c:c.fragmentToken||c.fragmentSource||c.fragmentElement||c.fragment,v=this._getGlobalDefines(),w=void 0!==r.attributes;let Z=t??r.defines??"";v&&(Z+=v);const J=m+"+"+Y+"@"+Z;if(this._compiledEffects[J]){const c=this._compiledEffects[J];return a&&c.isReady()&&a(c),c._refCount++,c}this._gl&&(0,W.C)(this._gl);const q=new k.Effect(c,r,w?this:D,B,this,t,u,a,H,x,J,r.shaderLanguage??M,r.extraInitializationsAsync??E);return this._compiledEffects[J]=q,q}_getShaderSource(c){return this._gl.getShaderSource(c)}createRawShaderProgram(c,r,D,B){let t=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const u=(0,W.C)(this._gl);return u._contextWasLost=this._contextWasLost,u.validateShaderPrograms=this.validateShaderPrograms,(0,W.u)(c,r,D,B||this._gl,t)}createShaderProgram(c,r,D,B,t){let u=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;const a=(0,W.C)(this._gl);return a._contextWasLost=this._contextWasLost,a.validateShaderPrograms=this.validateShaderPrograms,(0,W.w)(c,r,D,B,t||this._gl,u)}inlineShaderCode(c){return c}createPipelineContext(c){if(this._gl){(0,W.C)(this._gl).parallelShaderCompile=this._caps.parallelShaderCompile}const r=(0,W.q)(this._gl,c);return r.wr=this,r}createMaterialContext(){}createDrawContext(){}_finalizePipelineContext(c){return(0,W.f)(c,this._gl,this.validateShaderPrograms)}_preparePipelineContextAsync(c,r,D,B,t,u,a,H,x,M,E){const m=(0,W.C)(this._gl);return m._contextWasLost=this._contextWasLost,m.validateShaderPrograms=this.validateShaderPrograms,m._createShaderProgramInjection=this._createShaderProgram.bind(this),m.createRawShaderProgramInjection=this.createRawShaderProgram.bind(this),m.createShaderProgramInjection=this.createShaderProgram.bind(this),m.loadFileInjection=this._loadFile.bind(this),(0,W.m)(c,r,D,B,t,u,a,H,x,M,E)}_createShaderProgram(c,r,D,B){let t=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return(0,W.b)(c,r,D,B,t)}_isRenderingStateCompiled(c){return!this._isDisposed&&(0,W.j)(c,this._gl,this.validateShaderPrograms)}_executeWhenRenderingStateIsCompiled(c,r){(0,W.c)(c,r)}getUniforms(c,r){const D=new Array,W=c;for(let B=0;B<r.length;B++)D.push(this._gl.getUniformLocation(W.program,r[B]));return D}getAttributes(c,r){const D=[],W=c;for(let t=0;t<r.length;t++)try{D.push(this._gl.getAttribLocation(W.program,r[t]))}catch(B){D.push(-1)}return D}enableEffect(c){(c=null!==c&&(0,B.b)(c)?c.effect:c)&&c!==this._currentEffect&&(this._stencilStateComposer.stencilMaterial=void 0,this.bindSamplers(c),this._currentEffect=c,c.onBind&&c.onBind(c),c._onBindObservable&&c._onBindObservable.notifyObservers(c))}setInt(c,r){return!!c&&(this._gl.uniform1i(c,r),!0)}setInt2(c,r,D){return!!c&&(this._gl.uniform2i(c,r,D),!0)}setInt3(c,r,D,W){return!!c&&(this._gl.uniform3i(c,r,D,W),!0)}setInt4(c,r,D,W,B){return!!c&&(this._gl.uniform4i(c,r,D,W,B),!0)}setIntArray(c,r){return!!c&&(this._gl.uniform1iv(c,r),!0)}setIntArray2(c,r){return!(!c||r.length%2!==0)&&(this._gl.uniform2iv(c,r),!0)}setIntArray3(c,r){return!(!c||r.length%3!==0)&&(this._gl.uniform3iv(c,r),!0)}setIntArray4(c,r){return!(!c||r.length%4!==0)&&(this._gl.uniform4iv(c,r),!0)}setUInt(c,r){return!!c&&(this._gl.uniform1ui(c,r),!0)}setUInt2(c,r,D){return!!c&&(this._gl.uniform2ui(c,r,D),!0)}setUInt3(c,r,D,W){return!!c&&(this._gl.uniform3ui(c,r,D,W),!0)}setUInt4(c,r,D,W,B){return!!c&&(this._gl.uniform4ui(c,r,D,W,B),!0)}setUIntArray(c,r){return!!c&&(this._gl.uniform1uiv(c,r),!0)}setUIntArray2(c,r){return!(!c||r.length%2!==0)&&(this._gl.uniform2uiv(c,r),!0)}setUIntArray3(c,r){return!(!c||r.length%3!==0)&&(this._gl.uniform3uiv(c,r),!0)}setUIntArray4(c,r){return!(!c||r.length%4!==0)&&(this._gl.uniform4uiv(c,r),!0)}setArray(c,r){return!!c&&(!(r.length<1)&&(this._gl.uniform1fv(c,r),!0))}setArray2(c,r){return!(!c||r.length%2!==0)&&(this._gl.uniform2fv(c,r),!0)}setArray3(c,r){return!(!c||r.length%3!==0)&&(this._gl.uniform3fv(c,r),!0)}setArray4(c,r){return!(!c||r.length%4!==0)&&(this._gl.uniform4fv(c,r),!0)}setMatrices(c,r){return!!c&&(this._gl.uniformMatrix4fv(c,!1,r),!0)}setMatrix3x3(c,r){return!!c&&(this._gl.uniformMatrix3fv(c,!1,r),!0)}setMatrix2x2(c,r){return!!c&&(this._gl.uniformMatrix2fv(c,!1,r),!0)}setFloat(c,r){return!!c&&(this._gl.uniform1f(c,r),!0)}setFloat2(c,r,D){return!!c&&(this._gl.uniform2f(c,r,D),!0)}setFloat3(c,r,D,W){return!!c&&(this._gl.uniform3f(c,r,D,W),!0)}setFloat4(c,r,D,W,B){return!!c&&(this._gl.uniform4f(c,r,D,W,B),!0)}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;const c=this._colorWrite;this._gl.colorMask(c,c,c,c)}}wipeCaches(c){this.preventCacheWipeBetweenFrames&&!c||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),c&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(c,r){const D=this._gl;let W=D.NEAREST,B=D.NEAREST,t=!1;switch(c){case 11:W=D.LINEAR,B=r?D.LINEAR_MIPMAP_NEAREST:D.LINEAR;break;case 3:W=D.LINEAR,t=!0,B=r?D.LINEAR_MIPMAP_LINEAR:D.LINEAR;break;case 8:t=!0,W=D.NEAREST,B=r?D.NEAREST_MIPMAP_LINEAR:D.NEAREST;break;case 4:W=D.NEAREST,B=r?D.NEAREST_MIPMAP_NEAREST:D.NEAREST;break;case 5:W=D.NEAREST,B=r?D.LINEAR_MIPMAP_NEAREST:D.LINEAR;break;case 6:t=!0,W=D.NEAREST,B=r?D.LINEAR_MIPMAP_LINEAR:D.LINEAR;break;case 7:W=D.NEAREST,B=D.LINEAR;break;case 1:W=D.NEAREST,B=D.NEAREST;break;case 9:W=D.LINEAR,B=r?D.NEAREST_MIPMAP_NEAREST:D.NEAREST;break;case 10:t=!0,W=D.LINEAR,B=r?D.NEAREST_MIPMAP_LINEAR:D.NEAREST;break;case 2:W=D.LINEAR,B=D.LINEAR;break;case 12:W=D.LINEAR,B=D.NEAREST}return{min:B,mag:W,hasMipMaps:t}}_createTexture(){const c=this._gl.createTexture();if(!c)throw new Error("Unable to create texture");return c}_createHardwareTexture(){return new Y.b(this._createTexture(),this._gl)}_createInternalTexture(c,r){let D,W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,B=!1,u=!1,a=0,H=3,x=5,M=!1,E=1,m=!1,Y=0;void 0!==r&&"object"===typeof r?(B=!!r.generateMipMaps,u=!!r.createMipMaps,a=void 0===r.type?0:r.type,H=void 0===r.samplingMode?3:r.samplingMode,x=void 0===r.format?5:r.format,M=void 0!==r.useSRGBBuffer&&r.useSRGBBuffer,E=r.samples??1,D=r.label,m=!!r.createMSAATexture,Y=r.comparisonFunction||0):B=!!r,M&&(M=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(1!==a||this._caps.textureFloatLinearFiltering)&&(2!==a||this._caps.textureHalfFloatLinearFiltering)||(H=1),1!==a||this._caps.textureFloat||(a=0,t.e.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const k=(0,J.i)(x),w=(0,J.e)(x),Z=this._gl,q=new v.e(this,W),j=c.width||c,X=c.height||c,e=c.depth||0,y=c.layers||0,U=this._getSamplingParameters(H,(B||u)&&!k),N=0!==y?Z.TEXTURE_2D_ARRAY:0!==e?Z.TEXTURE_3D:Z.TEXTURE_2D,g=k?this._getInternalFormatFromDepthTextureFormat(x,!0,w):this._getRGBABufferInternalSizedFormat(a,x,M),z=k?w?Z.DEPTH_STENCIL:Z.DEPTH_COMPONENT:this._getInternalFormat(x),S=k?this._getWebGLTextureTypeFromDepthTextureFormat(x):this._getWebGLTextureType(a);if(this._bindTextureDirectly(N,q),0!==y?(q.is2DArray=!0,Z.texImage3D(N,0,g,j,X,y,0,z,S,null)):0!==e?(q.is3D=!0,Z.texImage3D(N,0,g,j,X,e,0,z,S,null)):Z.texImage2D(N,0,g,j,X,0,z,S,null),Z.texParameteri(N,Z.TEXTURE_MAG_FILTER,U.mag),Z.texParameteri(N,Z.TEXTURE_MIN_FILTER,U.min),Z.texParameteri(N,Z.TEXTURE_WRAP_S,Z.CLAMP_TO_EDGE),Z.texParameteri(N,Z.TEXTURE_WRAP_T,Z.CLAMP_TO_EDGE),k&&this.webGLVersion>1&&(0===Y?(Z.texParameteri(N,Z.TEXTURE_COMPARE_FUNC,515),Z.texParameteri(N,Z.TEXTURE_COMPARE_MODE,Z.NONE)):(Z.texParameteri(N,Z.TEXTURE_COMPARE_FUNC,Y),Z.texParameteri(N,Z.TEXTURE_COMPARE_MODE,Z.COMPARE_REF_TO_TEXTURE))),(B||u)&&this._gl.generateMipmap(N),this._bindTextureDirectly(N,null),q._useSRGBBuffer=M,q.baseWidth=j,q.baseHeight=X,q.width=j,q.height=X,q.depth=y||e,q.isReady=!0,q.samples=E,q.generateMipMaps=B,q.samplingMode=H,q.type=a,q.format=x,q.label=D,q.comparisonFunction=Y,this._internalTexturesCache.push(q),m){let c=null;if(c=(0,J.i)(q.format)?this._setupFramebufferDepthAttachments((0,J.e)(q.format),19!==q.format,q.width,q.height,E,q.format,!0):this._createRenderBuffer(q.width,q.height,E,-1,this._getRGBABufferInternalSizedFormat(q.type,q.format,q._useSRGBBuffer),-1),!c)throw new Error("Unable to create render buffer");q._autoMSAAManagement=!0;let r=q._hardwareTexture;r||(r=q._hardwareTexture=this._createHardwareTexture()),r.addMSAARenderBuffer(c)}return q}_getUseSRGBBuffer(c,r){return c&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||r)}createTexture(c,r,D,W){var B=this;let t=arguments.length>4&&void 0!==arguments[4]?arguments[4]:3,u=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,H=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,x=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,M=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,E=arguments.length>10&&void 0!==arguments[10]?arguments[10]:null,m=arguments.length>11?arguments[11]:void 0,Y=arguments.length>12?arguments[12]:void 0,k=arguments.length>13?arguments[13]:void 0,w=arguments.length>14?arguments[14]:void 0;return this._createTextureBase(c,r,D,W,t,u,a,(function(){for(var c=arguments.length,r=new Array(c),D=0;D<c;D++)r[D]=arguments[D];return B._prepareWebGLTexture(...r,M)}),((c,r,D,B,t,u)=>{const a=this._gl,H=D.width===c&&D.height===r;t._creationFlags=k??0;const x=this._getTexImageParametersForCreateTexture(t.format,t._useSRGBBuffer);if(H)return a.texImage2D(a.TEXTURE_2D,0,x.internalFormat,x.format,x.type,D),!1;const M=this._caps.maxTextureSize;if(D.width>M||D.height>M||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!(!this._workingCanvas||!this._workingContext)&&(this._workingCanvas.width=c,this._workingCanvas.height=r,this._workingContext.drawImage(D,0,0,D.width,D.height,0,0,c,r),a.texImage2D(a.TEXTURE_2D,0,x.internalFormat,x.format,x.type,this._workingCanvas),t.width=c,t.height=r,!1);{const c=new v.e(this,2);this._bindTextureDirectly(a.TEXTURE_2D,c,!0),a.texImage2D(a.TEXTURE_2D,0,x.internalFormat,x.format,x.type,D),this._rescaleTexture(c,t,W,x.format,(()=>{this._releaseTexture(c),this._bindTextureDirectly(a.TEXTURE_2D,t,!0),u()}))}return!0}),H,x,M,E,m,Y,w)}_getTexImageParametersForCreateTexture(c,r){let D,W;return 1===this.webGLVersion?(D=this._getInternalFormat(c,r),W=D):(D=this._getInternalFormat(c,!1),W=this._getRGBABufferInternalSizedFormat(0,c,r)),{internalFormat:W,format:D,type:this._gl.UNSIGNED_BYTE}}_rescaleTexture(c,r,D,W,B){}_unpackFlipY(c){this._unpackFlipYCached!==c&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,c?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=c))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(c){return c.isCube?this._gl.TEXTURE_CUBE_MAP:c.is3D?this._gl.TEXTURE_3D:c.is2DArray||c.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(c,r){let D=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const W=this._getTextureTarget(r),B=this._getSamplingParameters(c,r.useMipMaps||D);this._setTextureParameterInteger(W,this._gl.TEXTURE_MAG_FILTER,B.mag,r),this._setTextureParameterInteger(W,this._gl.TEXTURE_MIN_FILTER,B.min),D&&B.hasMipMaps&&(r.generateMipMaps=!0,this._gl.generateMipmap(W)),this._bindTextureDirectly(W,null),r.samplingMode=c}updateTextureDimensions(c,r,D){}updateTextureWrappingMode(c,r){let D=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;const B=this._getTextureTarget(c);null!==r&&(this._setTextureParameterInteger(B,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(r),c),c._cachedWrapU=r),null!==D&&(this._setTextureParameterInteger(B,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(D),c),c._cachedWrapV=D),(c.is2DArray||c.is3D)&&null!==W&&(this._setTextureParameterInteger(B,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(W),c),c._cachedWrapR=W),this._bindTextureDirectly(B,null)}_uploadCompressedDataToTextureDirectly(c,r,D,W,B){let t=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;const a=this._gl;let H=a.TEXTURE_2D;if(c.isCube&&(H=a.TEXTURE_CUBE_MAP_POSITIVE_X+t),c._useSRGBBuffer)switch(r){case 37492:case 36196:this._caps.etc2?r=a.COMPRESSED_SRGB8_ETC2:c._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?r=a.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:c._useSRGBBuffer=!1;break;case 36492:r=a.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:r=a.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?r=a.COMPRESSED_SRGB_S3TC_DXT1_EXT:c._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?r=a.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:c._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?r=a.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:c._useSRGBBuffer=!1;break;default:c._useSRGBBuffer=!1}this._gl.compressedTexImage2D(H,u,r,D,W,0,B)}_uploadDataToTextureDirectly(c,r){let D=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,B=arguments.length>4?arguments[4]:void 0,t=arguments.length>5&&void 0!==arguments[5]&&arguments[5];const u=this._gl,a=this._getWebGLTextureType(c.type),H=this._getInternalFormat(c.format),x=void 0===B?this._getRGBABufferInternalSizedFormat(c.type,c.format,c._useSRGBBuffer):this._getInternalFormat(B,c._useSRGBBuffer);this._unpackFlipY(c.invertY);let M=u.TEXTURE_2D;c.isCube&&(M=u.TEXTURE_CUBE_MAP_POSITIVE_X+D);const E=Math.round(Math.log(c.width)*Math.LOG2E),m=Math.round(Math.log(c.height)*Math.LOG2E),Y=t?c.width:Math.pow(2,Math.max(E-W,0)),v=t?c.height:Math.pow(2,Math.max(m-W,0));u.texImage2D(M,W,x,Y,v,0,H,a,r)}updateTextureData(c,r,D,W,B,t){let u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,a=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,H=arguments.length>8&&void 0!==arguments[8]&&arguments[8];const x=this._gl,M=this._getWebGLTextureType(c.type),E=this._getInternalFormat(c.format);this._unpackFlipY(c.invertY);let m=x.TEXTURE_2D,Y=x.TEXTURE_2D;c.isCube&&(Y=x.TEXTURE_CUBE_MAP_POSITIVE_X+u,m=x.TEXTURE_CUBE_MAP),this._bindTextureDirectly(m,c,!0),x.texSubImage2D(Y,a,D,W,B,t,E,M,r),H&&this._gl.generateMipmap(Y),this._bindTextureDirectly(m,null)}_uploadArrayBufferViewToTexture(c,r){let D=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const B=this._gl,t=c.isCube?B.TEXTURE_CUBE_MAP:B.TEXTURE_2D;this._bindTextureDirectly(t,c,!0),this._uploadDataToTextureDirectly(c,r,D,W),this._bindTextureDirectly(t,null,!0)}_prepareWebGLTextureContinuation(c,r,D,W,B){const t=this._gl;if(!t)return;const u=this._getSamplingParameters(B,!D);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,u.mag),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,u.min),D||W||t.generateMipmap(t.TEXTURE_2D),this._bindTextureDirectly(t.TEXTURE_2D,null),r&&r.removePendingData(c),c.onLoadedObservable.notifyObservers(c),c.onLoadedObservable.clear()}_prepareWebGLTexture(c,r,D,W,B,t,u,a,H,x){const M=this.getCaps().maxTextureSize,m=Math.min(M,this.needPOTTextures?(0,E.e)(W.width,M):W.width),Y=Math.min(M,this.needPOTTextures?(0,E.e)(W.height,M):W.height),v=this._gl;v&&(c._hardwareTexture?(this._bindTextureDirectly(v.TEXTURE_2D,c,!0),this._unpackFlipY(void 0===B||!!B),c.baseWidth=W.width,c.baseHeight=W.height,c.width=m,c.height=Y,c.isReady=!0,c.type=-1!==c.type?c.type:0,c.format=-1!==c.format?c.format:x??(".jpg"!==r||c._useSRGBBuffer?5:4),a(m,Y,W,r,c,(()=>{this._prepareWebGLTextureContinuation(c,D,t,u,H)}))||this._prepareWebGLTextureContinuation(c,D,t,u,H)):D&&D.removePendingData(c))}_getInternalFormatFromDepthTextureFormat(c,r,D){const W=this._gl;if(!r)return W.STENCIL_INDEX8;let B=D?W.DEPTH_STENCIL:W.DEPTH_COMPONENT;return this.webGLVersion>1?15===c?B=W.DEPTH_COMPONENT16:16===c?B=W.DEPTH_COMPONENT24:17===c||13===c?B=D?W.DEPTH24_STENCIL8:W.DEPTH_COMPONENT24:14===c?B=W.DEPTH_COMPONENT32F:18===c&&(B=D?W.DEPTH32F_STENCIL8:W.DEPTH_COMPONENT32F):B=W.DEPTH_COMPONENT16,B}_getWebGLTextureTypeFromDepthTextureFormat(c){const r=this._gl;let D=r.UNSIGNED_INT;return 15===c?D=r.UNSIGNED_SHORT:17===c||13===c?D=r.UNSIGNED_INT_24_8:14===c?D=r.FLOAT:18===c?D=r.FLOAT_32_UNSIGNED_INT_24_8_REV:19===c&&(D=r.UNSIGNED_BYTE),D}_setupFramebufferDepthAttachments(c,r,D,W){let B=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,t=arguments.length>5?arguments[5]:void 0,u=arguments.length>6&&void 0!==arguments[6]&&arguments[6];const a=this._gl;t=t??(c?13:14);const H=this._getInternalFormatFromDepthTextureFormat(t,r,c);return c&&r?this._createRenderBuffer(D,W,B,a.DEPTH_STENCIL,H,u?-1:a.DEPTH_STENCIL_ATTACHMENT):r?this._createRenderBuffer(D,W,B,H,H,u?-1:a.DEPTH_ATTACHMENT):c?this._createRenderBuffer(D,W,B,H,H,u?-1:a.STENCIL_ATTACHMENT):null}_createRenderBuffer(c,r,D,W,B,t){let u=!(arguments.length>6&&void 0!==arguments[6])||arguments[6];const a=this._gl.createRenderbuffer();return this._updateRenderBuffer(a,c,r,D,W,B,t,u)}_updateRenderBuffer(c,r,D,W,B,t,u){let a=!(arguments.length>7&&void 0!==arguments[7])||arguments[7];const H=this._gl;return H.bindRenderbuffer(H.RENDERBUFFER,c),W>1&&H.renderbufferStorageMultisample?H.renderbufferStorageMultisample(H.RENDERBUFFER,W,t,r,D):H.renderbufferStorage(H.RENDERBUFFER,B,r,D),-1!==u&&H.framebufferRenderbuffer(H.FRAMEBUFFER,u,H.RENDERBUFFER,c),a&&H.bindRenderbuffer(H.RENDERBUFFER,null),c}_releaseTexture(c){this._deleteTexture(c._hardwareTexture),this.unbindAllTextures();const r=this._internalTexturesCache.indexOf(c);-1!==r&&this._internalTexturesCache.splice(r,1),c._lodTextureHigh&&c._lodTextureHigh.dispose(),c._lodTextureMid&&c._lodTextureMid.dispose(),c._lodTextureLow&&c._lodTextureLow.dispose(),c._irradianceTexture&&c._irradianceTexture.dispose()}_deleteTexture(c){null===c||void 0===c||c.release()}_setProgram(c){this._currentProgram!==c&&((0,W.p)(c,this._gl),this._currentProgram=c)}bindSamplers(c){const r=c.getPipelineContext();this._setProgram(r.program);const D=c.getSamplers();for(let W=0;W<D.length;W++){const r=c.getUniform(D[W]);r&&(this._boundUniforms[W]=r)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(c,r){let D=arguments.length>2&&void 0!==arguments[2]&&arguments[2],W=arguments.length>3&&void 0!==arguments[3]&&arguments[3],B=!1;const u=r&&r._associatedChannel>-1;D&&u&&(this._activeChannel=r._associatedChannel);if(this._boundTexturesCache[this._activeChannel]!==r||W){if(this._activateCurrentTexture(),r&&r.isMultiview)throw t.e.Error(["_bindTextureDirectly called with a multiview texture!",c,r]),"_bindTextureDirectly called with a multiview texture!";var a;this._gl.bindTexture(c,(null===r||void 0===r||null===(a=r._hardwareTexture)||void 0===a?void 0:a.underlyingResource)??null),this._boundTexturesCache[this._activeChannel]=r,r&&(r._associatedChannel=this._activeChannel)}else D&&(B=!0,this._activateCurrentTexture());return u&&!D&&this._bindSamplerUniformToChannel(r._associatedChannel,this._activeChannel),B}_bindTexture(c,r,D){if(void 0===c)return;r&&(r._associatedChannel=c),this._activeChannel=c;const W=r?this._getTextureTarget(r):this._gl.TEXTURE_2D;this._bindTextureDirectly(W,r)}unbindAllTextures(){for(let c=0;c<this._maxSimultaneousTextures;c++)this._activeChannel=c,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(c,r,D,W){void 0!==c&&(r&&(this._boundUniforms[c]=r),this._setTexture(c,D))}_bindSamplerUniformToChannel(c,r){const D=this._boundUniforms[c];D&&D._currentState!==r&&(this._gl.uniform1i(D,r),D._currentState=r)}_getTextureWrapMode(c){switch(c){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(c,r){let D,W=arguments.length>2&&void 0!==arguments[2]&&arguments[2],B=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!r)return null!=this._boundTexturesCache[c]&&(this._activeChannel=c,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(r.video){this._activeChannel=c;const D=r.getInternalTexture();D&&(D._associatedChannel=c),r.update()}else if(4===r.delayLoadState)return r.delayLoad(),!1;D=B?r.depthStencilTexture:r.isReady()?r.getInternalTexture():r.isCube?this.emptyCubeTexture:r.is3D?this.emptyTexture3D:r.is2DArray?this.emptyTexture2DArray:this.emptyTexture,!W&&D&&(D._associatedChannel=c);let t=!0;this._boundTexturesCache[c]===D&&(W||this._bindSamplerUniformToChannel(D._associatedChannel,c),t=!1),this._activeChannel=c;const u=this._getTextureTarget(D);if(t&&this._bindTextureDirectly(u,D,W),D&&!D.isMultiview){if(D.isCube&&D._cachedCoordinatesMode!==r.coordinatesMode){D._cachedCoordinatesMode=r.coordinatesMode;const c=3!==r.coordinatesMode&&5!==r.coordinatesMode?1:0;r.wrapU=c,r.wrapV=c}D._cachedWrapU!==r.wrapU&&(D._cachedWrapU=r.wrapU,this._setTextureParameterInteger(u,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(r.wrapU),D)),D._cachedWrapV!==r.wrapV&&(D._cachedWrapV=r.wrapV,this._setTextureParameterInteger(u,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(r.wrapV),D)),D.is3D&&D._cachedWrapR!==r.wrapR&&(D._cachedWrapR=r.wrapR,this._setTextureParameterInteger(u,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(r.wrapR),D)),this._setAnisotropicLevel(u,D,r.anisotropicFilteringLevel)}return!0}setTextureArray(c,r,D,W){if(void 0!==c&&r){this._textureUnits&&this._textureUnits.length===D.length||(this._textureUnits=new Int32Array(D.length));for(let r=0;r<D.length;r++){const W=D[r].getInternalTexture();W?(this._textureUnits[r]=c+r,W._associatedChannel=c+r):this._textureUnits[r]=-1}this._gl.uniform1iv(r,this._textureUnits);for(let c=0;c<D.length;c++)this._setTexture(this._textureUnits[c],D[c],!0)}}_setAnisotropicLevel(c,r,D){const W=this._caps.textureAnisotropicFilterExtension;11!==r.samplingMode&&3!==r.samplingMode&&2!==r.samplingMode&&(D=1),W&&r._cachedAnisotropicFilteringLevel!==D&&(this._setTextureParameterFloat(c,W.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(D,this._caps.maxAnisotropy),r),r._cachedAnisotropicFilteringLevel=D)}_setTextureParameterFloat(c,r,D,W){this._bindTextureDirectly(c,W,!0,!0),this._gl.texParameterf(c,r,D)}_setTextureParameterInteger(c,r,D,W){W&&this._bindTextureDirectly(c,W,!0,!0),this._gl.texParameteri(c,r,D)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let c=0;c<this._caps.maxVertexAttribs;c++)this.disableAttributeByIndex(c)}else for(let c=0,r=this._vertexAttribArraysEnabled.length;c<r;c++)c>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[c]||this.disableAttributeByIndex(c)}releaseEffects(){this._compiledEffects={},this.onReleaseEffectsObservable.notifyObservers(this)}dispose(){var c;((0,u.f)()&&this._renderingCanvas&&(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._onContextRestored&&this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),super.dispose(),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.unbindAllAttributes(),this._boundUniforms={},this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._currentProgram=null,this._creationOptions.loseContextOnDispose)&&(null===(c=this._gl.getExtension("WEBGL_lose_context"))||void 0===c||c.loseContext());(0,W.A)(this._gl)}attachContextLostEvent(c){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",c,!1)}attachContextRestoredEvent(c){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",c,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(c){const r=this._gl;for(;r.getError()!==r.NO_ERROR;);let D=!0;const W=r.createTexture();r.bindTexture(r.TEXTURE_2D,W),r.texImage2D(r.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(c),1,1,0,r.RGBA,this._getWebGLTextureType(c),null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST);const B=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,B),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,W,0);const t=r.checkFramebufferStatus(r.FRAMEBUFFER);if(D=D&&t===r.FRAMEBUFFER_COMPLETE,D=D&&r.getError()===r.NO_ERROR,D&&(r.clear(r.COLOR_BUFFER_BIT),D=D&&r.getError()===r.NO_ERROR),D){r.bindFramebuffer(r.FRAMEBUFFER,null);const c=r.RGBA,W=r.UNSIGNED_BYTE,B=new Uint8Array(4);r.readPixels(0,0,1,1,c,W,B),D=D&&r.getError()===r.NO_ERROR}for(r.deleteTexture(W),r.deleteFramebuffer(B),r.bindFramebuffer(r.FRAMEBUFFER,null);!D&&r.getError()!==r.NO_ERROR;);return D}_getWebGLTextureType(c){if(1===this._webGLVersion){switch(c){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(c){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(c){let r=arguments.length>1&&void 0!==arguments[1]&&arguments[1],D=r?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;switch(c){case 0:D=this._gl.ALPHA;break;case 1:D=this._gl.LUMINANCE;break;case 2:D=this._gl.LUMINANCE_ALPHA;break;case 6:case 33322:case 36760:D=this._gl.RED;break;case 7:case 33324:case 36761:D=this._gl.RG;break;case 4:case 32852:case 36762:D=r?this._glSRGBExtensionValues.SRGB:this._gl.RGB;break;case 5:case 32859:case 36763:D=r?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA}if(this._webGLVersion>1)switch(c){case 8:D=this._gl.RED_INTEGER;break;case 9:D=this._gl.RG_INTEGER;break;case 10:D=this._gl.RGB_INTEGER;break;case 11:D=this._gl.RGBA_INTEGER}return D}_getRGBABufferInternalSizedFormat(c,r){let D=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(1===this._webGLVersion){if(void 0!==r)switch(r){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return D?this._glSRGBExtensionValues.SRGB:this._gl.RGB}return this._gl.RGBA}switch(c){case 3:switch(r){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(r){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return D?this._glSRGBExtensionValues.SRGB8:this._gl.RGB8;case 5:return D?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(r){case 8:return this._gl.R16I;case 36760:return this._gl.R16_SNORM_EXT;case 36761:return this._gl.RG16_SNORM_EXT;case 36762:return this._gl.RGB16_SNORM_EXT;case 36763:return this._gl.RGBA16_SNORM_EXT;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;default:return this._gl.RGBA16I}case 5:switch(r){case 8:return this._gl.R16UI;case 33322:return this._gl.R16_EXT;case 33324:return this._gl.RG16_EXT;case 32852:return this._gl.RGB16_EXT;case 32859:return this._gl.RGBA16_EXT;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;default:return this._gl.RGBA16UI}case 6:switch(r){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;default:return this._gl.RGBA32I}case 7:switch(r){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;default:return this._gl.RGBA32UI}case 1:switch(r){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;default:return this._gl.RGBA32F}case 2:switch(r){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(r){case 5:default:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI}}return D?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8}readPixels(c,r,D,W){let B=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],u=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;const H=B?4:3,x=B?this._gl.RGBA:this._gl.RGB,M=D*W*H;if(a){if(a.length<M)return t.e.Error(`Data buffer is too small to store the read pixels (${a.length} should be more than ${M})`),Promise.resolve(a)}else a=new Uint8Array(M);return u&&this.flushFramebuffer(),this._gl.readPixels(c,r,D,W,x,this._gl.UNSIGNED_BYTE,a),Promise.resolve(a)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(null!==this._HasMajorPerformanceCaveat)return!this._HasMajorPerformanceCaveat;if(null===this._IsSupported)try{const c=m.b._CreateCanvas(1,1),r=c.getContext("webgl")||c.getContext("experimental-webgl");this._IsSupported=null!=r&&!!window.WebGLRenderingContext}catch(c){this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(null===this._HasMajorPerformanceCaveat)try{const c=m.b._CreateCanvas(1,1),r=c.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||c.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!r}catch(c){this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}}j._TempClearColorUint32=new Uint32Array(4),j._TempClearColorInt32=new Int32Array(4),j.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/12\\d\\..+?Mobile",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}],j._ConcatenateShader=w.e,j._IsSupported=null,j._HasMajorPerformanceCaveat=null},11737:(c,r,D)=>{D.d(r,{b:()=>Y});var W=D(11494),B=D(11683),t=D(11656),u=D(11744),a=D(11648),H=D(11586),x=D(11509),M=D(11763),E=D(11694);class m{get renderList(){return this._renderList}set renderList(c){this._renderList!==c&&(this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),c&&(this._unObserveRenderList=(0,E.h)(c,this._renderListHasChanged)),this._renderList=c)}get disableImageProcessing(){return this._disableImageProcessing}set disableImageProcessing(c){c!==this._disableImageProcessing&&(this._disableImageProcessing=c,this._scene.markAllMaterialsAsDirty(64))}get name(){return this._name}set name(c){if(this._name===c)return;if(this._name=c,!this._scene)return;const r=this._scene.getEngine();for(let D=0;D<this._renderPassIds.length;++D){const c=this._renderPassIds[D];r._renderPassNames[c]=`${this._name}#${D}`}}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}setMaterialForRendering(c,r){let D;D=Array.isArray(c)?c:[c];for(let W=0;W<D.length;++W)for(let c=0;c<this.options.numPasses;++c){let B=D[W];D[W].isAnInstance&&(B=D[W].sourceMesh),B.setMaterialForRenderPass(this._renderPassIds[c],void 0!==r?Array.isArray(r)?r[c]:r:void 0)}}constructor(c,r,D){this._unObserveRenderList=null,this._renderListHasChanged=(c,r)=>{const D=this._renderList?this._renderList.length:0;if(0===r&&D>0||0===D)for(const W of this._scene.meshes)W._markSubMeshesAsLightDirty()},this.particleSystemList=null,this.getCustomRenderList=null,this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this._disableImageProcessing=!1,this.onBeforeRenderObservable=new W.c,this.onAfterRenderObservable=new W.c,this.onBeforeRenderingManagerRenderObservable=new W.c,this.onAfterRenderingManagerRenderObservable=new W.c,this.onFastPathRenderObservable=new W.c,this._currentRefreshId=-1,this._refreshRate=1,this._currentApplyByPostProcessSetting=!1,this._currentSceneCamera=null,this.name=c,this._scene=r,this.renderList=[],this._renderPassIds=[],this.options={numPasses:1,doNotChangeAspectRatio:!0,...D},this._createRenderPassId(),this.renderPassId=this._renderPassIds[0],this._renderingManager=new M.e(r),this._renderingManager._useSceneAutoClearSetup=!0}_releaseRenderPassId(){const c=this._scene.getEngine();for(let r=0;r<this.options.numPasses;++r)c.releaseRenderPassId(this._renderPassIds[r]);this._renderPassIds.length=0}_createRenderPassId(){this._releaseRenderPassId();const c=this._scene.getEngine();for(let r=0;r<this.options.numPasses;++r)this._renderPassIds[r]=c.createRenderPassId(`${this.name}#${r}`)}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(c){this._refreshRate=c,this.resetRefreshCounter()}shouldRender(){return-1===this._currentRefreshId||this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}isReadyForRendering(c,r){this.prepareRenderList(),this.initRender(c,r);const D=this._checkReadiness();return this.finishRender(),D}prepareRenderList(){const c=this._scene;if(this._waitingRenderList){if(!this.renderListPredicate){this.renderList=[];for(let r=0;r<this._waitingRenderList.length;r++){const D=this._waitingRenderList[r],W=c.getMeshById(D);W&&this.renderList.push(W)}}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const c=this._scene.meshes;for(let r=0;r<c.length;r++){const D=c[r];this.renderListPredicate(D)&&this.renderList.push(D)}}this._currentApplyByPostProcessSetting=this._scene.imageProcessingConfiguration.applyByPostProcess,this._disableImageProcessing&&(this._scene.imageProcessingConfiguration._applyByPostProcess=this._disableImageProcessing)}initRender(c,r){const D=this._scene.getEngine(),W=this.activeCamera??this._scene.activeCamera;this._currentSceneCamera=this._scene.activeCamera,W&&(W!==this._scene.activeCamera&&(this._scene.setTransformMatrix(W.getViewMatrix(),W.getProjectionMatrix(!0)),this._scene.activeCamera=W),D.setViewport(W.rigParent?W.rigParent.viewport:W.viewport,c,r)),this._defaultRenderListPrepared=!1}finishRender(){const c=this._scene;this._disableImageProcessing&&(c.imageProcessingConfiguration._applyByPostProcess=this._currentApplyByPostProcessSetting),c.activeCamera=this._currentSceneCamera,this._currentSceneCamera&&(this.activeCamera&&this.activeCamera!==c.activeCamera&&c.setTransformMatrix(this._currentSceneCamera.getViewMatrix(),this._currentSceneCamera.getProjectionMatrix(!0)),c.getEngine().setViewport(this._currentSceneCamera.viewport)),c.resetCachedMaterial()}render(){let c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const D=this._scene,W=D.getEngine(),B=W.currentRenderPassId;W.currentRenderPassId=this._renderPassIds[c],this.onBeforeRenderObservable.notifyObservers(c);if(W.snapshotRendering&&1===W.snapshotRenderingMode)this.onFastPathRenderObservable.notifyObservers(c);else{let r=null;const W=this.renderList?this.renderList:D.getActiveMeshes().data,B=this.renderList?this.renderList.length:D.getActiveMeshes().length;this.getCustomRenderList&&(r=this.getCustomRenderList(c,W,B)),r?this._prepareRenderingManager(r,r.length,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(W,B,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),r=W),this.onBeforeRenderingManagerRenderObservable.notifyObservers(c),this._renderingManager.render(this.customRenderFunction,r,this.renderParticles,this.renderSprites),this.onAfterRenderingManagerRenderObservable.notifyObservers(c)}r||this.onAfterRenderObservable.notifyObservers(c),W.currentRenderPassId=B}_checkReadiness(){const c=this._scene,r=c.getEngine(),D=r.currentRenderPassId;let W=!0;c.getViewMatrix()||c.updateTransformMatrix();const B=this.options.numPasses;for(let u=0;u<B&&W;u++){let D=null;const t=this.renderList?this.renderList:c.getActiveMeshes().data,a=this.renderList?this.renderList.length:c.getActiveMeshes().length;r.currentRenderPassId=this._renderPassIds[u],this.onBeforeRenderObservable.notifyObservers(u),this.getCustomRenderList&&(D=this.getCustomRenderList(u,t,a)),D||(D=t),this.options.doNotChangeAspectRatio||c.updateTransformMatrix(!0);for(let c=0;c<D.length&&W;++c){const r=D[c];if(r.isEnabled()&&!r.isBlocked&&r.isVisible&&r.xa)if(this.customIsReadyFunction){if(!this.customIsReadyFunction(r,this.refreshRate,!0)){W=!1;continue}}else if(!r.isReady(!0)){W=!1;continue}}this.onAfterRenderObservable.notifyObservers(u),B>1&&(c.incrementRenderId(),c.resetCachedMaterial())}const t=this.particleSystemList||c.rm;for(const u of t)u.isReady()||(W=!1);return r.currentRenderPassId=D,W}_prepareRenderingManager(c,r,D){const W=this._scene,B=W.activeCamera,t=this.cameraForLOD??B;this._renderingManager.reset();const u=W.getRenderId(),a=W.getFrameId();for(let x=0;x<r;x++){const r=c[x];if(r&&!r.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(r,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!r.isReady(0===this.refreshRate)){this.resetRefreshCounter();continue}let c,H=null;if(t){const c=r._internalAbstractMeshDataInfo._currentLOD.get(t);c&&c[1]===a?H=c[0]:(H=W.customLODSelector?W.customLODSelector(r,t):r.getLOD(t),c?(c[0]=H,c[1]=a):r._internalAbstractMeshDataInfo._currentLOD.set(t,[H,a]))}else H=r;if(!H)continue;if(H!==r&&0!==H.billboardMode&&H.va(),H._preActivateForIntermediateRendering(u),c=!(!D||!B)&&0===(r.layerMask&B.layerMask),r.isEnabled()&&r.isVisible&&r.xa&&!c){if(H!==r&&H._activate(u,!0),r._activate(u,!0)&&r.xa.length){r.isAnInstance?r._internalAbstractMeshDataInfo._actAsRegularMesh&&(H=r):H._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,H._internalAbstractMeshDataInfo._isActiveIntermediate=!0,W._prepareSkeleton(H);for(let c=0;c<H.xa.length;c++){const r=H.xa[c];this._renderingManager.dispatch(r,H)}}r._postActivate()}}}const H=this.particleSystemList||W.rm;for(let x=0;x<H.length;x++){const c=H[x],r=c.tr;c.isStarted()&&r&&(!r.position||r.isEnabled())&&this._renderingManager.dispatchParticles(c)}}setRenderingOrder(c){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,D=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this._renderingManager.setRenderingOrder(c,r,D,W)}setRenderingAutoClearDepthStencil(c,r){let D=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],W=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];this._renderingManager.setRenderingAutoClearDepthStencil(c,r,D,W),this._renderingManager._useSceneAutoClearSetup=!1}clone(){const c=new m(this.name,this._scene,this.options);return this.renderList&&(c.renderList=this.renderList.slice(0)),c}dispose(){const c=this.renderList?this.renderList:this._scene.getActiveMeshes().data,r=this.renderList?this.renderList.length:this._scene.getActiveMeshes().length;for(let D=0;D<r;D++){const r=c[D];r&&void 0!==r.getMaterialForRenderPass(this.renderPassId)&&r.setMaterialForRenderPass(this.renderPassId,void 0)}this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderingManagerRenderObservable.clear(),this.onAfterRenderingManagerRenderObservable.clear(),this.onFastPathRenderObservable.clear(),this._releaseRenderPassId(),this.renderList=null}_rebuild(){this.refreshRate===m.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=m.REFRESHRATE_RENDER_ONCE)}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}}m.REFRESHRATE_RENDER_ONCE=0,m.REFRESHRATE_RENDER_ONEVERYFRAME=1,m.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,H.Effect.prototype.setDepthStencilTexture=function(c,r){this._engine.setDepthStencilTexture(this._samplers[c],this._uniforms[c],r,c)};class Y extends t.b{get renderListPredicate(){return this._objectRenderer.renderListPredicate}set renderListPredicate(c){this._objectRenderer.renderListPredicate=c}get renderList(){return this._objectRenderer.renderList}set renderList(c){this._objectRenderer.renderList=c}get particleSystemList(){return this._objectRenderer.particleSystemList}set particleSystemList(c){this._objectRenderer.particleSystemList=c}get getCustomRenderList(){return this._objectRenderer.getCustomRenderList}set getCustomRenderList(c){this._objectRenderer.getCustomRenderList=c}get renderParticles(){return this._objectRenderer.renderParticles}set renderParticles(c){this._objectRenderer.renderParticles=c}get renderSprites(){return this._objectRenderer.renderSprites}set renderSprites(c){this._objectRenderer.renderSprites=c}get forceLayerMaskCheck(){return this._objectRenderer.forceLayerMaskCheck}set forceLayerMaskCheck(c){this._objectRenderer.forceLayerMaskCheck=c}get activeCamera(){return this._objectRenderer.activeCamera}set activeCamera(c){this._objectRenderer.activeCamera=c}get cameraForLOD(){return this._objectRenderer.cameraForLOD}set cameraForLOD(c){this._objectRenderer.cameraForLOD=c}get disableImageProcessing(){return this._objectRenderer.disableImageProcessing}set disableImageProcessing(c){this._objectRenderer.disableImageProcessing=c}get customIsReadyFunction(){return this._objectRenderer.customIsReadyFunction}set customIsReadyFunction(c){this._objectRenderer.customIsReadyFunction=c}get customRenderFunction(){return this._objectRenderer.customRenderFunction}set customRenderFunction(c){this._objectRenderer.customRenderFunction=c}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(c){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(c)}get onBeforeRenderObservable(){return this._objectRenderer.onBeforeRenderObservable}set onBeforeRender(c){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(c)}get onAfterRenderObservable(){return this._objectRenderer.onAfterRenderObservable}set onAfterRender(c){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(c)}set onClear(c){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(c)}get _waitingRenderList(){return this._objectRenderer._waitingRenderList}set _waitingRenderList(c){this._objectRenderer._waitingRenderList=c}get renderPassId(){return this._objectRenderer.renderPassId}get renderPassIds(){return this._objectRenderer.renderPassIds}get currentRefreshId(){return this._objectRenderer.currentRefreshId}setMaterialForRendering(c,r){this._objectRenderer.setMaterialForRendering(c,r)}get isMulti(){var c;return(null===(c=this._renderTarget)||void 0===c?void 0:c.isMulti)??!1}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(c){if(this._boundingBoxSize&&this._boundingBoxSize.equals(c))return;this._boundingBoxSize=c;const r=this.yc();r&&r.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){var c;return(null===(c=this._renderTarget)||void 0===c?void 0:c._depthStencilTexture)??null}constructor(c,r,D){let u,a,H=arguments.length>3&&void 0!==arguments[3]&&arguments[3],M=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],E=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,Y=arguments.length>6&&void 0!==arguments[6]&&arguments[6],v=arguments.length>7&&void 0!==arguments[7]?arguments[7]:t.b.TRILINEAR_SAMPLINGMODE,k=!(arguments.length>8&&void 0!==arguments[8])||arguments[8],w=arguments.length>9&&void 0!==arguments[9]&&arguments[9],Z=arguments.length>10&&void 0!==arguments[10]&&arguments[10],J=arguments.length>11&&void 0!==arguments[11]?arguments[11]:5,q=arguments.length>12&&void 0!==arguments[12]&&arguments[12],j=arguments.length>13?arguments[13]:void 0,X=arguments.length>14?arguments[14]:void 0,e=arguments.length>15&&void 0!==arguments[15]&&arguments[15],y=arguments.length>16&&void 0!==arguments[16]&&arguments[16],U=!0;if("object"===typeof H){const c=H;H=!!c.generateMipMaps,M=c.doNotChangeAspectRatio??!0,E=c.type??0,Y=!!c.isCube,v=c.samplingMode??t.b.TRILINEAR_SAMPLINGMODE,k=c.generateDepthBuffer??!0,w=!!c.generateStencilBuffer,Z=!!c.isMulti,J=c.format??5,q=!!c.delayAllocation,j=c.samples,X=c.creationFlags,e=!!c.noColorAttachment,y=!!c.useSRGBBuffer,u=c.colorAttachment,U=c.gammaSpace??U,a=c.existingObjectRenderer}if(super(null,D,!H,void 0,v,void 0,void 0,void 0,void 0,J),this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new W.c,this.onAfterUnbindObservable=new W.c,this.onClearObservable=new W.c,this.onResizeObservable=new W.c,this._cleared=!1,this.skipInitialClear=!1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this._dontDisposeObjectRenderer=!1,this.boundingBoxPosition=B.Zr.Zero(),this._disableEngineStages=!1,this._dumpToolsLoading=!1,!(D=this.yc()))return;const N=this.yc().getEngine();this._gammaSpace=U,this._coordinatesMode=t.b.PROJECTION_MODE,this.name=c,this.isRenderTarget=!0,this._initialSizeParameter=r,this._dontDisposeObjectRenderer=!!a,this._processSizeParameter(r),this._objectRenderer=a??new m(c,D,{numPasses:Y?6:this.getRenderLayers()||1,doNotChangeAspectRatio:M}),this._onBeforeRenderingManagerRenderObserver=this._objectRenderer.onBeforeRenderingManagerRenderObservable.add((()=>{if(!this._disableEngineStages)for(const c of this._scene._beforeRenderTargetClearStage)c.action(this,this._currentFaceIndex,this._currentLayer);if(this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(N):this.skipInitialClear||N.clear(this.clearColor||this._scene.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),!this._disableEngineStages)for(const c of this._scene._beforeRenderTargetDrawStage)c.action(this,this._currentFaceIndex,this._currentLayer)})),this._onAfterRenderingManagerRenderObserver=this._objectRenderer.onAfterRenderingManagerRenderObservable.add((()=>{var c;if(!this._disableEngineStages)for(const D of this._scene._afterRenderTargetDrawStage)D.action(this,this._currentFaceIndex,this._currentLayer);const r=(null===(c=this._texture)||void 0===c?void 0:c.generateMipMaps)??!1;if(this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex,this._postProcesses,this.ignoreCameraViewport):this._currentUseCameraPostProcess&&this._scene.postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex),!this._disableEngineStages)for(const D of this._scene._afterRenderTargetPostProcessStage)D.action(this,this._currentFaceIndex,this._currentLayer);this._texture&&(this._texture.generateMipMaps=r),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),this._currentDumpForDebug&&(this._dumpTools?this._dumpTools.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),N):x.e.Error("dumpTools module is still being loaded. To speed up the process import dump tools directly in your project"))})),this._onFastPathRenderObserver=this._objectRenderer.onFastPathRenderObservable.add((()=>{this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(N):this.skipInitialClear||N.clear(this.clearColor||this._scene.clearColor,!0,!0,!0)})),this._resizeObserver=N.onResizeObservable.add((()=>{})),this._generateMipMaps=!!H,this._doNotChangeAspectRatio=M,Z||(this._renderTargetOptions={generateMipMaps:H,type:E,format:this._format??void 0,samplingMode:this.samplingMode,generateDepthBuffer:k,generateStencilBuffer:w,samples:j,creationFlags:X,noColorAttachment:e,useSRGBBuffer:y,colorAttachment:u,label:this.name},this.samplingMode===t.b.NEAREST_SAMPLINGMODE&&(this.wrapU=t.b.CLAMP_ADDRESSMODE,this.wrapV=t.b.CLAMP_ADDRESSMODE),q||(Y?(this._renderTarget=D.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=t.b.INVCUBIC_MODE,this._textureMatrix=B.Matrix.Identity()):this._renderTarget=D.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==j&&(this.samples=j)))}createDepthStencilTexture(){var c;let r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,D=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],W=arguments.length>2&&void 0!==arguments[2]&&arguments[2],B=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,t=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14,u=arguments.length>5?arguments[5]:void 0;null===(c=this._renderTarget)||void 0===c||c.createDepthStencilTexture(r,D,W,B,t,u)}_processSizeParameter(c){if(c.ratio){this._sizeRatio=c.ratio;const r=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(r.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(r.getRenderHeight(),this._sizeRatio)}}else this._size=c}get samples(){var c;return(null===(c=this._renderTarget)||void 0===c?void 0:c.samples)??this._samples}set samples(c){this._renderTarget&&(this._samples=this._renderTarget.setSamples(c))}addPostProcess(c){if(!this._postProcessManager){const c=this.yc();if(!c)return;this._postProcessManager=new u.e(c),this._postProcesses=new Array}this._postProcesses.push(c),this._postProcesses[0].Ha=!1}clearPostProcesses(){let c=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._postProcesses){if(c)for(const c of this._postProcesses)c.dispose();this._postProcesses=[]}}removePostProcess(c){if(!this._postProcesses)return;const r=this._postProcesses.indexOf(c);-1!==r&&(this._postProcesses.splice(r,1),this._postProcesses.length>0&&(this._postProcesses[0].Ha=!1))}resetRefreshCounter(){this._objectRenderer.resetRefreshCounter()}get refreshRate(){return this._objectRenderer.refreshRate}set refreshRate(c){this._objectRenderer.refreshRate=c}_shouldRender(){return this._objectRenderer.shouldRender()}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){const c=this._size.layers;if(c)return c;const r=this._size.depth;return r||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(c){const r=Math.max(1,this.getRenderSize()*c);this.resize(r)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(c){var r;const D=this.isCube;null===(r=this._renderTarget)||void 0===r||r.dispose(),this._renderTarget=null;const W=this.yc();W&&(this._processSizeParameter(c),this._renderTarget=D?W.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):W.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==this._renderTargetOptions.samples&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(){let c=arguments.length>0&&void 0!==arguments[0]&&arguments[0],r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._render(c,r)}isReadyForRendering(){this._dumpToolsLoading||(this._dumpToolsLoading=!0,D.e(20).then(D.bind(D,11905)).then((c=>this._dumpTools=c))),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight());const c=this._objectRenderer._checkReadiness();return this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender(),c}_render(){let c=arguments.length>0&&void 0!==arguments[0]&&arguments[0],r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const D=this.yc();if(D){if(void 0!==this.useCameraPostProcesses&&(c=this.useCameraPostProcesses),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight()),!this.is2DArray&&!this.is3D||this.isMulti)if(this.isCube&&!this.isMulti)for(let W=0;W<6;W++)this._renderToTarget(W,c,r),D.incrementRenderId(),D.resetCachedMaterial();else this._renderToTarget(0,c,r);else for(let W=0;W<this.getRenderLayers();W++)this._renderToTarget(0,c,r,W),D.incrementRenderId(),D.resetCachedMaterial();this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender()}}_bestReflectionRenderTargetDimension(c,r){const D=c*r,W=(0,a.m)(D+16384/(128+D));return Math.min((0,a.b)(c),W)}_bindFrameBuffer(){let c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const D=this.yc();if(!D)return;const W=D.getEngine();this._renderTarget&&W.bindFramebuffer(this._renderTarget,this.isCube?c:void 0,void 0,void 0,this.ignoreCameraViewport,0,r)}_unbindFrameBuffer(c,r){this._renderTarget&&c.unBindFramebuffer(this._renderTarget,this.isCube,(()=>{this.onAfterRenderObservable.notifyObservers(r)}))}_prepareFrame(c,r,D,W){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses)||this._bindFrameBuffer(r,D):W&&c.postProcessManager._prepareFrame(this._texture)||this._bindFrameBuffer(r,D)}_renderToTarget(c,r,D){var W,B;let t=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const u=this.yc();if(!u)return;const a=u.getEngine();this._currentFaceIndex=c,this._currentLayer=t,this._currentUseCameraPostProcess=r,this._currentDumpForDebug=D,this._prepareFrame(u,c,t,r),null===(W=a._debugPushGroup)||void 0===W||W.call(a,`render to face #${c} layer #${t}`,2),this._objectRenderer.render(c+t,!0),null===(B=a._debugPopGroup)||void 0===B||B.call(a,2),this._unbindFrameBuffer(a,c),this._texture&&this.isCube&&5===c&&a.generateMipMapsForCubemap(this._texture,!0)}setRenderingOrder(c){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,D=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this._objectRenderer.setRenderingOrder(c,r,D,W)}setRenderingAutoClearDepthStencil(c,r){this._objectRenderer.setRenderingAutoClearDepthStencil(c,r)}clone(){const c=this.getSize(),r=new Y(this.name,c,this.yc(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return r.Ea=this.Ea,r.level=this.level,r.coordinatesMode=this.coordinatesMode,this.renderList&&(r.renderList=this.renderList.slice(0)),r}serialize(){if(!this.name)return null;const c=super.serialize();if(c.renderTargetSize=this.getRenderSize(),c.renderList=[],this.renderList)for(let r=0;r<this.renderList.length;r++)c.renderList.push(this.renderList[r].id);return c}disposeFramebufferObjects(){var c;null===(c=this._renderTarget)||void 0===c||c.dispose(!0)}releaseInternalTexture(){var c;null===(c=this._renderTarget)||void 0===c||c.releaseTextures(),this._texture=null}dispose(){var c;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._objectRenderer.onBeforeRenderingManagerRenderObservable.remove(this._onBeforeRenderingManagerRenderObserver),this._objectRenderer.onAfterRenderingManagerRenderObservable.remove(this._onAfterRenderingManagerRenderObserver),this._objectRenderer.onFastPathRenderObservable.remove(this._onFastPathRenderObserver),this._dontDisposeObjectRenderer||this._objectRenderer.dispose(),this.clearPostProcesses(!0),this._resizeObserver&&(this.yc().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null);const r=this.yc();if(!r)return;let D=r.customRenderTargets.indexOf(this);D>=0&&r.customRenderTargets.splice(D,1);for(const W of r.cameras)D=W.customRenderTargets.indexOf(this),D>=0&&W.customRenderTargets.splice(D,1);null===(c=this._renderTarget)||void 0===c||c.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this._objectRenderer._rebuild(),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._objectRenderer.freeRenderingGroups()}getViewCount(){return 1}}Y.REFRESHRATE_RENDER_ONCE=m.REFRESHRATE_RENDER_ONCE,Y.REFRESHRATE_RENDER_ONEVERYFRAME=m.REFRESHRATE_RENDER_ONEVERYFRAME,Y.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=m.REFRESHRATE_RENDER_ONEVERYTWOFRAMES,t.b._CreateRenderTargetTexture=(c,r,D,W,B)=>new Y(c,r,D,W)},11825:(c,r,D)=>{function W(c){return 13===c||14===c||15===c||16===c||17===c||18===c||19===c}function B(c){return 13===c||17===c||18===c||19===c}D.d(r,{e:()=>B,i:()=>W})},11799:(c,r,D)=>{function W(c){return void 0===c.getPipelineContext}D.d(r,{b:()=>W})},11771:(c,r,D)=>{D.d(r,{d:()=>x,e:()=>M});var W=D(11750),B=D(11774),t=D(11494),u=D(11586),a=D(11782);D(11787);const H={Nc:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class x{constructor(c){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:H;this._fullscreenViewport=new B.e(0,0,1,1);const D=r.Nc??H.Nc,t=r.indices??H.indices;this.wr=c,this._vertexBuffers={[W.d.PositionKind]:new W.d(c,D,W.d.PositionKind,!1,!1,2)},this._indexBuffer=c.createIndexBuffer(t),this._indexBufferLength=t.length,this._onContextRestoredObserver=c.onContextRestoredObservable.add((()=>{this._indexBuffer=c.createIndexBuffer(t);for(const c in this._vertexBuffers){this._vertexBuffers[c]._rebuild()}}))}setViewport(){let c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._fullscreenViewport;this.wr.setViewport(c)}bindBuffers(c){this.wr.bindBuffers(this._vertexBuffers,this._indexBuffer,c)}applyEffectWrapper(c){this.wr.setState(!0),this.wr.depthCullingState.depthTest=!1,this.wr.stencilState.stencilTest=!1,this.wr.enableEffect(c.drawWrapper),this.bindBuffers(c.effect),c.onApplyObservable.notifyObservers({})}saveStates(){this._savedStateDepthTest=this.wr.depthCullingState.depthTest,this._savedStateStencilTest=this.wr.stencilState.stencilTest}restoreStates(){this.wr.depthCullingState.depthTest=this._savedStateDepthTest,this.wr.stencilState.stencilTest=this._savedStateStencilTest}draw(){this.wr.drawElementsType(0,0,this._indexBufferLength)}_isRenderTargetTexture(c){return void 0!==c.renderTarget}render(c){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!c.effect.isReady())return;this.saveStates(),this.setViewport();const D=null===r?null:this._isRenderTargetTexture(r)?r.renderTarget:r;D&&this.wr.bindFramebuffer(D),this.applyEffectWrapper(c),this.draw(),D&&this.wr.unBindFramebuffer(D),this.restoreStates()}dispose(){const c=this._vertexBuffers[W.d.PositionKind];c&&(c.dispose(),delete this._vertexBuffers[W.d.PositionKind]),this._indexBuffer&&this.wr._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.wr.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}}class M{static RegisterShaderCodeProcessing(c,r){r?M._CustomShaderCodeProcessing[c??""]=r:delete M._CustomShaderCodeProcessing[c??""]}static _GetShaderCodeProcessing(c){return M._CustomShaderCodeProcessing[c]??M._CustomShaderCodeProcessing[""]}get name(){return this.options.name}set name(c){this.options.name=c}isReady(){var c;return(null===(c=this._drawWrapper.effect)||void 0===c?void 0:c.isReady())??!1}get drawWrapper(){return this._drawWrapper}get effect(){return this._drawWrapper.effect}set effect(c){this._drawWrapper.effect=c}constructor(c){this.alphaMode=0,this.onEffectCreatedObservable=new t.c(void 0,!0),this.onApplyObservable=new t.c,this._shadersLoaded=!1,this._webGPUReady=!1,this._importPromises=[],this.options={...c,name:c.name||"effectWrapper",wr:c.wr,uniforms:c.uniforms||c.uniformNames||[],uniformNames:void 0,samplers:c.samplers||c.samplerNames||[],samplerNames:void 0,attributeNames:c.attributeNames||["position"],uniformBuffers:c.uniformBuffers||[],defines:c.defines||"",useShaderStore:c.useShaderStore||!1,vertexUrl:c.vertexUrl||c.vertexShader||"postprocess",vertexShader:void 0,fragmentShader:c.fragmentShader||"pass",indexParameters:c.indexParameters,blockCompilation:c.blockCompilation||!1,shaderLanguage:c.shaderLanguage||0,onCompiled:c.onCompiled||void 0,extraInitializations:c.extraInitializations||void 0,extraInitializationsAsync:c.extraInitializationsAsync||void 0,useAsPostProcess:c.useAsPostProcess??!1},this.options.uniformNames=this.options.uniforms,this.options.samplerNames=this.options.samplers,this.options.vertexShader=this.options.vertexUrl,this.options.useAsPostProcess&&(-1===this.options.samplers.indexOf("textureSampler")&&this.options.samplers.push("textureSampler"),-1===this.options.uniforms.indexOf("scale")&&this.options.uniforms.push("scale")),c.vertexUrl||c.vertexShader?this._shaderPath={vertexSource:this.options.vertexShader}:(this.options.useAsPostProcess||(this.options.uniforms.push("scale"),this.onApplyObservable.add((()=>{this.effect.setFloat2("scale",1,1)}))),this._shaderPath={vertex:this.options.vertexShader}),this._shaderPath.fragmentSource=this.options.fragmentShader,this._shaderPath.spectorName=this.options.name,this.options.useShaderStore&&(this._shaderPath.fragment=this._shaderPath.fragmentSource,this._shaderPath.vertex||(this._shaderPath.vertex=this._shaderPath.vertexSource),delete this._shaderPath.fragmentSource,delete this._shaderPath.vertexSource),this.onApplyObservable.add((()=>{this.bind()})),this.options.useShaderStore||(this._onContextRestoredObserver=this.options.wr.onContextRestoredObservable.add((()=>{this.effect._pipelineContext=null,this.effect._prepareEffect()}))),this._drawWrapper=new a.c(this.options.wr),this._webGPUReady=1===this.options.shaderLanguage;const r=Array.isArray(this.options.defines)?this.options.defines.join("\n"):this.options.defines;this._postConstructor(this.options.blockCompilation,r,this.options.extraInitializations)}_gatherImports(){let c=arguments.length>0&&void 0!==arguments[0]&&arguments[0],r=arguments.length>1?arguments[1]:void 0;this.options.useAsPostProcess&&(c&&this._webGPUReady?r.push(Promise.all([D.e(53).then(D.bind(D,14157))])):r.push(Promise.all([Promise.resolve().then(D.bind(D,11787))])))}_postConstructor(c){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,D=arguments.length>2?arguments[2]:void 0,W=arguments.length>3?arguments[3]:void 0;this._importPromises.length=0,W&&this._importPromises.push(...W);const B=this.options.wr.isWebGPU&&!M.ForceGLSL;this._gatherImports(B,this._importPromises),void 0!==D&&D(B,this._importPromises),B&&this._webGPUReady&&(this.options.shaderLanguage=1),c||this.updateEffect(r)}updateEffect(){let c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,D=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,W=arguments.length>3?arguments[3]:void 0,B=arguments.length>4?arguments[4]:void 0,t=arguments.length>5?arguments[5]:void 0,a=arguments.length>6?arguments[6]:void 0,H=arguments.length>7?arguments[7]:void 0;const x=M._GetShaderCodeProcessing(this.name);if(null!==x&&void 0!==x&&x.defineCustomBindings){var E,m;const W=(null===(E=r)||void 0===E?void 0:E.slice())??[];W.push(...this.options.uniforms);const B=(null===(m=D)||void 0===m?void 0:m.slice())??[];B.push(...this.options.samplers),c=x.defineCustomBindings(this.name,c,W,B),r=W,D=B}this.options.defines=c||"";const Y=this._shadersLoaded||0===this._importPromises.length?void 0:async()=>{await Promise.all(this._importPromises),this._shadersLoaded=!0};let v;v=this.options.extraInitializationsAsync?async()=>{null===Y||void 0===Y||Y(),await this.options.extraInitializationsAsync()}:Y,this.options.useShaderStore?this._drawWrapper.effect=this.options.wr.createEffect({vertex:a??this._shaderPath.vertex,fragment:H??this._shaderPath.fragment},{attributes:this.options.attributeNames,uniformsNames:r||this.options.uniforms,uniformBuffersNames:this.options.uniformBuffers,samplers:D||this.options.samplers,defines:null!==c?c:"",fallbacks:null,onCompiled:B??this.options.onCompiled,onError:t??null,indexParameters:W||this.options.indexParameters,processCodeAfterIncludes:null!==x&&void 0!==x&&x.processCodeAfterIncludes?(c,r)=>x.processCodeAfterIncludes(this.name,c,r):null,processFinalCode:null!==x&&void 0!==x&&x.processFinalCode?(c,r)=>x.processFinalCode(this.name,c,r):null,shaderLanguage:this.options.shaderLanguage,extraInitializationsAsync:v},this.options.wr):this._drawWrapper.effect=new u.Effect(this._shaderPath,this.options.attributeNames,r||this.options.uniforms,D||this.options.samplerNames,this.options.wr,c,void 0,B||this.options.onCompiled,void 0,void 0,void 0,this.options.shaderLanguage,v),this.onEffectCreatedObservable.notifyObservers(this._drawWrapper.effect)}bind(){var c,r;let D=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.options.useAsPostProcess&&!D&&(this.options.wr.setAlphaMode(this.alphaMode),this.drawWrapper.effect.setFloat2("scale",1,1)),null===(c=M._GetShaderCodeProcessing(this.name))||void 0===c||null===(r=c.bindCustomBindings)||void 0===r||r.call(c,this.name,this._drawWrapper.effect)}dispose(){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.onEffectCreatedObservable.clear(),this._drawWrapper.dispose(!0)}}M.ForceGLSL=!1,M._CustomShaderCodeProcessing={}},11886:(c,r,D)=>{D.d(r,{b:()=>u});var W,B,t=D(11683);!function(c){c[c.LOCAL=0]="LOCAL",c[c.WORLD=1]="WORLD",c[c.BONE=2]="BONE"}(W||(W={}));class u{}u.X=new t.Zr(1,0,0),u.Y=new t.Zr(0,1,0),u.Z=new t.Zr(0,0,1),function(c){c[c.X=0]="X",c[c.Y=1]="Y",c[c.Z=2]="Z"}(B||(B={}))},11877:(c,r,D)=>{D.d(r,{c:()=>W.Matrix,d:()=>W.Quaternion,f:()=>W.TmpVectors,j:()=>W.Zr});D(11886),D(11722),D(11687),D(11894),D(11899),D(11729),D(11710);var W=D(11683);D(11774)},11899:(c,r,D)=>{D.d(r,{c:()=>a,d:()=>m,e:()=>M,f:()=>E});var W,B=D(11696),t=D(11683),u=D(11687);!function(c){c[c.CW=0]="CW",c[c.CCW=1]="CCW"}(W||(W={}));class a{static Interpolate(c,r,D,W,B){if(0===c)return 0;const t=1-3*W+3*r,u=3*W-6*r,a=3*r;let H=c;for(let x=0;x<5;x++){const r=H*H;H-=(t*(r*H)+u*r+a*H-c)*(1/(3*t*r+2*u*H+a)),H=Math.min(1,Math.max(0,H))}return 3*Math.pow(1-H,2)*H*D+3*(1-H)*Math.pow(H,2)*B+Math.pow(H,3)}}class H{constructor(c){this._radians=c,this._radians<0&&(this._radians+=2*Math.PI)}degrees(){return 180*this._radians/Math.PI}radians(){return this._radians}static BetweenTwoPoints(c,r){const D=r.Jr(c),W=Math.atan2(D.y,D.x);return new H(W)}static BetweenTwoVectors(c,r){let D=c.lengthSquared()*r.lengthSquared();if(0===D)return new H(Math.PI/2);D=Math.sqrt(D);let W=c.dot(r)/D;W=(0,B.Clamp)(W,-1,1);const t=Math.acos(W);return new H(t)}static FromRadians(c){return new H(c)}static FromDegrees(c){return new H(c*Math.PI/180)}}class x{constructor(c,r,D){this.startPoint=c,this.midPoint=r,this.endPoint=D;const W=Math.pow(r.x,2)+Math.pow(r.y,2),B=(Math.pow(c.x,2)+Math.pow(c.y,2)-W)/2,u=(W-Math.pow(D.x,2)-Math.pow(D.y,2))/2,a=(c.x-r.x)*(r.y-D.y)-(r.x-D.x)*(c.y-r.y);this.centerPoint=new t.Vector2((B*(r.y-D.y)-u*(c.y-r.y))/a,((c.x-r.x)*u-(r.x-D.x)*B)/a),this.radius=this.centerPoint.Jr(this.startPoint).length(),this.startAngle=H.BetweenTwoPoints(this.centerPoint,this.startPoint);const x=this.startAngle.degrees();let M=H.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),E=H.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();M-x>180&&(M-=360),M-x<-180&&(M+=360),E-M>180&&(E-=360),E-M<-180&&(E+=360),this.orientation=M-x<0?0:1,this.angle=H.FromDegrees(0===this.orientation?x-E:E-x)}}class M{constructor(c,r){this._points=new Array,this._length=0,this.closed=!1,this._points.push(new t.Vector2(c,r))}addLineTo(c,r){if(this.closed)return this;const D=new t.Vector2(c,r),W=this._points[this._points.length-1];return this._points.push(D),this._length+=D.Jr(W).length(),this}addArcTo(c,r,D,W){let B=arguments.length>4&&void 0!==arguments[4]?arguments[4]:36;if(this.closed)return this;const u=this._points[this._points.length-1],a=new t.Vector2(c,r),H=new t.Vector2(D,W),M=new x(u,a,H);let E=M.angle.radians()/B;0===M.orientation&&(E*=-1);let m=M.startAngle.radians()+E;for(let t=0;t<B;t++){const c=Math.cos(m)*M.radius+M.centerPoint.x,r=Math.sin(m)*M.radius+M.centerPoint.y;this.addLineTo(c,r),m+=E}return this}addQuadraticCurveTo(c,r,D,W){let B=arguments.length>4&&void 0!==arguments[4]?arguments[4]:36;if(this.closed)return this;const t=(c,r,D,W)=>(1-c)*(1-c)*r+2*c*(1-c)*D+c*c*W,u=this._points[this._points.length-1];for(let a=0;a<=B;a++){const H=a/B,x=t(H,u.x,c,D),M=t(H,u.y,r,W);this.addLineTo(x,M)}return this}addBezierCurveTo(c,r,D,W,B,t){let u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:36;if(this.closed)return this;const a=(c,r,D,W,B)=>(1-c)*(1-c)*(1-c)*r+3*c*(1-c)*(1-c)*D+3*c*c*(1-c)*W+c*c*c*B,H=this._points[this._points.length-1];for(let x=0;x<=u;x++){const M=x/u,E=a(M,H.x,c,D,B),m=a(M,H.y,r,W,t);this.addLineTo(E,m)}return this}isPointInside(c){let r=!1;const D=this._points.length;for(let W=D-1,B=0;B<D;W=B++){let D=this._points[W],t=this._points[B],u=t.x-D.x,a=t.y-D.y;if(Math.abs(a)>Number.EPSILON){if(a<0&&(D=this._points[B],u=-u,t=this._points[W],a=-a),c.y<D.y||c.y>t.y)continue;if(c.y===D.y&&c.x===D.x)return!0;{const W=a*(c.x-D.x)-u*(c.y-D.y);if(0===W)return!0;if(W<0)continue;r=!r}}else{if(c.y!==D.y)continue;if(t.x<=c.x&&c.x<=D.x||D.x<=c.x&&c.x<=t.x)return!0}}return r}close(){return this.closed=!0,this}length(){let c=this._length;if(this.closed){const r=this._points[this._points.length-1];c+=this._points[0].Jr(r).length()}return c}area(){const c=this._points.length;let r=0;for(let D=c-1,W=0;W<c;D=W++)r+=this._points[D].x*this._points[W].y-this._points[W].x*this._points[D].y;return.5*r}getPoints(){return this._points}getPointAtLengthPosition(c){if(c<0||c>1)return t.Vector2.Zero();const r=c*this.length();let D=0;for(let W=0;W<this._points.length;W++){const c=(W+1)%this._points.length,B=this._points[W],u=this._points[c].Jr(B),a=u.length()+D;if(r>=D&&r<=a){const c=u.normalize(),W=r-D;return new t.Vector2(B.x+c.x*W,B.y+c.y*W)}D=a}return t.Vector2.Zero()}static StartingAt(c,r){return new M(c,r)}}class E{constructor(c){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,D=arguments.length>2?arguments[2]:void 0,W=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.path=c,this._curve=new Array,this._distances=new Array,this._tangents=new Array,this._normals=new Array,this._binormals=new Array,this._pointAtData={id:0,point:t.Zr.Zero(),previousPointArrayIndex:0,position:0,subPosition:0,interpolateReady:!1,interpolationMatrix:t.Matrix.Identity()};for(let B=0;B<c.length;B++)this._curve[B]=c[B].clone();this._raw=D||!1,this._alignTangentsWithPath=W,this._compute(r,W)}getCurve(){return this._curve}getPoints(){return this._curve}length(){return this._distances[this._distances.length-1]}getTangents(){return this._tangents}getNormals(){return this._normals}getBinormals(){return this._binormals}getDistances(){return this._distances}getPointAt(c){return this._updatePointAtData(c).point}getTangentAt(c){let r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(c,r),r?t.Zr.TransformCoordinates(t.Zr.Forward(),this._pointAtData.interpolationMatrix):this._tangents[this._pointAtData.previousPointArrayIndex]}getNormalAt(c){let r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(c,r),r?t.Zr.TransformCoordinates(t.Zr.Right(),this._pointAtData.interpolationMatrix):this._normals[this._pointAtData.previousPointArrayIndex]}getBinormalAt(c){let r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(c,r),r?t.Zr.TransformCoordinates(t.Zr.UpReadOnly,this._pointAtData.interpolationMatrix):this._binormals[this._pointAtData.previousPointArrayIndex]}getDistanceAt(c){return this.length()*c}getPreviousPointIndexAt(c){return this._updatePointAtData(c),this._pointAtData.previousPointArrayIndex}getSubPositionAt(c){return this._updatePointAtData(c),this._pointAtData.subPosition}getClosestPositionTo(c){let r=Number.MAX_VALUE,D=0;for(let W=0;W<this._curve.length-1;W++){const B=this._curve[W+0],u=this._curve[W+1].Jr(B).normalize(),a=this._distances[W+1]-this._distances[W+0],H=Math.min(Math.max(t.Zr.Dot(u,c.Jr(B).normalize()),0)*t.Zr.Distance(B,c)/a,1),x=t.Zr.Distance(B.add(u.scale(H*a)),c);x<r&&(r=x,D=(this._distances[W+0]+a*H)/this.length())}return D}slice(){let c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(c<0&&(c=1- -1*c%1),r<0&&(r=1- -1*r%1),c>r){const D=c;c=r,r=D}const D=this.getCurve(),W=this.getPointAt(c);let B=this.getPreviousPointIndexAt(c);const t=this.getPointAt(r),u=this.getPreviousPointIndexAt(r)+1,a=[];return 0!==c&&(B++,a.push(W)),a.push(...D.slice(B,u)),1===r&&1!==c||a.push(t),new E(a,this.getNormalAt(c),this._raw,this._alignTangentsWithPath)}update(c){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,D=arguments.length>2&&void 0!==arguments[2]&&arguments[2];for(let W=0;W<c.length;W++)this._curve[W].x=c[W].x,this._curve[W].y=c[W].y,this._curve[W].z=c[W].z;return this._compute(r,D),this}_compute(c){let r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const D=this._curve.length;if(D<2)return;this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[D-1]=this._curve[D-1].Jr(this._curve[D-2]),this._raw||this._tangents[D-1].normalize();const W=this._tangents[0],B=this._normalVector(W,c);let u,a,H,x,M;this._normals[0]=B,this._raw||this._normals[0].normalize(),this._binormals[0]=t.Zr.Cross(W,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;for(let E=1;E<D;E++)u=this._getLastNonNullVector(E),E<D-1&&(a=this._getFirstNonNullVector(E),this._tangents[E]=r?a:u.add(a),this._tangents[E].normalize()),this._distances[E]=this._distances[E-1]+this._curve[E].Jr(this._curve[E-1]).length(),H=this._tangents[E],M=this._binormals[E-1],this._normals[E]=t.Zr.Cross(M,H),this._raw||(0===this._normals[E].length()?(x=this._normals[E-1],this._normals[E]=x.clone()):this._normals[E].normalize()),this._binormals[E]=t.Zr.Cross(H,this._normals[E]),this._raw||this._binormals[E].normalize();this._pointAtData.id=NaN}_getFirstNonNullVector(c){let r=1,D=this._curve[c+r].Jr(this._curve[c]);for(;0===D.length()&&c+r+1<this._curve.length;)r++,D=this._curve[c+r].Jr(this._curve[c]);return D}_getLastNonNullVector(c){let r=1,D=this._curve[c].Jr(this._curve[c-r]);for(;0===D.length()&&c>r+1;)r++,D=this._curve[c].Jr(this._curve[c-r]);return D}_normalVector(c,r){let D,W=c.length();if(0===W&&(W=1),void 0===r||null===r){let r;r=(0,B.WithinEpsilon)(Math.abs(c.y)/W,1,u.c)?(0,B.WithinEpsilon)(Math.abs(c.x)/W,1,u.c)?(0,B.WithinEpsilon)(Math.abs(c.z)/W,1,u.c)?t.Zr.Zero():new t.Zr(0,0,1):new t.Zr(1,0,0):new t.Zr(0,-1,0),D=t.Zr.Cross(c,r)}else D=t.Zr.Cross(c,r),t.Zr.CrossToRef(D,c,D);return D.normalize(),D}_updatePointAtData(c){let r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._pointAtData.id===c)return this._pointAtData.interpolateReady||this._updateInterpolationMatrix(),this._pointAtData;this._pointAtData.id=c;const D=this.getPoints();if(c<=0)return this._setPointAtData(0,0,D[0],0,r);if(c>=1)return this._setPointAtData(1,1,D[D.length-1],D.length-1,r);let W,B=D[0],u=0;const a=c*this.length();for(let H=1;H<D.length;H++){W=D[H];const x=t.Zr.Distance(B,W);if(u+=x,u===a)return this._setPointAtData(c,1,W,H,r);if(u>a){const D=(u-a)/x,t=B.Jr(W),M=W.add(t.scaleInPlace(D));return this._setPointAtData(c,1-D,M,H-1,r)}B=W}return this._pointAtData}_setPointAtData(c,r,D,W,B){return this._pointAtData.point=D,this._pointAtData.position=c,this._pointAtData.subPosition=r,this._pointAtData.previousPointArrayIndex=W,this._pointAtData.interpolateReady=B,B&&this._updateInterpolationMatrix(),this._pointAtData}_updateInterpolationMatrix(){this._pointAtData.interpolationMatrix=t.Matrix.Identity();const c=this._pointAtData.previousPointArrayIndex;if(c!==this._tangents.length-1){const r=c+1,D=this._tangents[c].clone(),W=this._normals[c].clone(),B=this._binormals[c].clone(),u=this._tangents[r].clone(),a=this._normals[r].clone(),H=this._binormals[r].clone(),x=t.Quaternion.RotationQuaternionFromAxis(W,B,D),M=t.Quaternion.RotationQuaternionFromAxis(a,H,u);t.Quaternion.Slerp(x,M,this._pointAtData.subPosition).toRotationMatrix(this._pointAtData.interpolationMatrix)}}}class m{static CreateQuadraticBezier(c,r,D,W){W=W>2?W:3;const B=[],u=(c,r,D,W)=>(1-c)*(1-c)*r+2*c*(1-c)*D+c*c*W;for(let a=0;a<=W;a++)B.push(new t.Zr(u(a/W,c.x,r.x,D.x),u(a/W,c.y,r.y,D.y),u(a/W,c.z,r.z,D.z)));return new m(B)}static CreateCubicBezier(c,r,D,W,B){B=B>3?B:4;const u=[],a=(c,r,D,W,B)=>(1-c)*(1-c)*(1-c)*r+3*c*(1-c)*(1-c)*D+3*c*c*(1-c)*W+c*c*c*B;for(let H=0;H<=B;H++)u.push(new t.Zr(a(H/B,c.x,r.x,D.x,W.x),a(H/B,c.y,r.y,D.y,W.y),a(H/B,c.z,r.z,D.z,W.z)));return new m(u)}static CreateHermiteSpline(c,r,D,W,B){const u=[],a=1/B;for(let H=0;H<=B;H++)u.push(t.Zr.Hermite(c,r,D,W,H*a));return new m(u)}static CreateCatmullRomSpline(c,r,D){const W=[],B=1/r;let u=0;if(D){const D=c.length;for(let a=0;a<D;a++){u=0;for(let H=0;H<r;H++)W.push(t.Zr.CatmullRom(c[a%D],c[(a+1)%D],c[(a+2)%D],c[(a+3)%D],u)),u+=B}W.push(W[0])}else{const D=[];D.push(c[0].clone()),Array.prototype.push.apply(D,c),D.push(c[c.length-1].clone());let a=0;for(;a<D.length-3;a++){u=0;for(let c=0;c<r;c++)W.push(t.Zr.CatmullRom(D[a],D[a+1],D[a+2],D[a+3],u)),u+=B}a--,W.push(t.Zr.CatmullRom(D[a],D[a+1],D[a+2],D[a+3],u))}return new m(W)}static ArcThru3Points(c,r,D){let W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:32,B=arguments.length>4&&void 0!==arguments[4]&&arguments[4],u=arguments.length>5&&void 0!==arguments[5]&&arguments[5];const a=[],H=r.Jr(c),x=D.Jr(r),M=c.Jr(D),E=t.Zr.Cross(H,x),Y=E.length();if(Y<Math.pow(10,-8))return new m(a);const v=H.lengthSquared(),k=x.lengthSquared(),w=M.lengthSquared(),Z=E.lengthSquared(),J=.5*H.length()*x.length()*M.length()/Y,q=-.5*k*t.Zr.Dot(H,M)/Z,j=-.5*w*t.Zr.Dot(H,x)/Z,X=-.5*v*t.Zr.Dot(x,M)/Z,e=c.scale(q).add(r.scale(j)).add(D.scale(X)),y=c.Jr(e).normalize(),U=t.Zr.Cross(E,y).normalize();if(u){const r=2*Math.PI/W;for(let c=0;c<=2*Math.PI;c+=r)a.push(e.add(y.scale(J*Math.cos(c)).add(U.scale(J*Math.sin(c)))));a.push(c)}else{const r=1/W;let u=0,H=t.Zr.Zero();do{H=e.add(y.scale(J*Math.cos(u)).add(U.scale(J*Math.sin(u)))),a.push(H),u+=r}while(!H.equalsWithEpsilon(D,J*r*1.1));a.push(D),B&&a.push(c)}return new m(a)}constructor(c){this._length=0,this._points=c,this._length=this._computeLength(c)}getPoints(){return this._points}length(){return this._length}continue(c){const r=this._points[this._points.length-1],D=this._points.slice(),W=c.getPoints();for(let B=1;B<W.length;B++)D.push(W[B].Jr(W[0]).add(r));return new m(D)}_computeLength(c){let r=0;for(let D=1;D<c.length;D++)r+=c[D].Jr(c[D-1]).length();return r}}},11774:(c,r,D)=>{D.d(r,{e:()=>W});class W{constructor(c,r,D,W){this.x=c,this.y=r,this.width=D,this.height=W}toGlobal(c,r){return new W(this.x*c,this.y*r,this.width*c,this.height*r)}toGlobalToRef(c,r,D){return D.x=this.x*c,D.y=this.y*r,D.width=this.width*c,D.height=this.height*r,this}clone(){return new W(this.x,this.y,this.width,this.height)}}},11868:(c,r,D)=>{D.d(r,{c:()=>x,e:()=>M});var W=D(11683),B=D(11877);const t=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],u=[()=>1,c=>c.y,c=>c.z,c=>c.x,c=>c.x*c.y,c=>c.y*c.z,c=>3*c.z*c.z-1,c=>c.x*c.z,c=>c.x*c.x-c.y*c.y],a=(c,r)=>t[c]*u[c](r),H=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4];class x{constructor(){this.preScaled=!1,this.l00=W.Zr.Zero(),this.l1_1=W.Zr.Zero(),this.l10=W.Zr.Zero(),this.l11=W.Zr.Zero(),this.l2_2=W.Zr.Zero(),this.l2_1=W.Zr.Zero(),this.l20=W.Zr.Zero(),this.l21=W.Zr.Zero(),this.l22=W.Zr.Zero()}addLight(c,r,D){B.f.Zr[0].set(r.r,r.g,r.b);const W=B.f.Zr[0],t=B.f.Zr[1];W.scaleToRef(D,t),t.scaleToRef(a(0,c),B.f.Zr[2]),this.l00.addInPlace(B.f.Zr[2]),t.scaleToRef(a(1,c),B.f.Zr[2]),this.l1_1.addInPlace(B.f.Zr[2]),t.scaleToRef(a(2,c),B.f.Zr[2]),this.l10.addInPlace(B.f.Zr[2]),t.scaleToRef(a(3,c),B.f.Zr[2]),this.l11.addInPlace(B.f.Zr[2]),t.scaleToRef(a(4,c),B.f.Zr[2]),this.l2_2.addInPlace(B.f.Zr[2]),t.scaleToRef(a(5,c),B.f.Zr[2]),this.l2_1.addInPlace(B.f.Zr[2]),t.scaleToRef(a(6,c),B.f.Zr[2]),this.l20.addInPlace(B.f.Zr[2]),t.scaleToRef(a(7,c),B.f.Zr[2]),this.l21.addInPlace(B.f.Zr[2]),t.scaleToRef(a(8,c),B.f.Zr[2]),this.l22.addInPlace(B.f.Zr[2])}scaleInPlace(c){this.l00.scaleInPlace(c),this.l1_1.scaleInPlace(c),this.l10.scaleInPlace(c),this.l11.scaleInPlace(c),this.l2_2.scaleInPlace(c),this.l2_1.scaleInPlace(c),this.l20.scaleInPlace(c),this.l21.scaleInPlace(c),this.l22.scaleInPlace(c)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(H[0]),this.l1_1.scaleInPlace(H[1]),this.l10.scaleInPlace(H[2]),this.l11.scaleInPlace(H[3]),this.l2_2.scaleInPlace(H[4]),this.l2_1.scaleInPlace(H[5]),this.l20.scaleInPlace(H[6]),this.l21.scaleInPlace(H[7]),this.l22.scaleInPlace(H[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(t[0]),this.l1_1.scaleInPlace(t[1]),this.l10.scaleInPlace(t[2]),this.l11.scaleInPlace(t[3]),this.l2_2.scaleInPlace(t[4]),this.l2_1.scaleInPlace(t[5]),this.l20.scaleInPlace(t[6]),this.l21.scaleInPlace(t[7]),this.l22.scaleInPlace(t[8])}updateFromArray(c){return W.Zr.FromArrayToRef(c[0],0,this.l00),W.Zr.FromArrayToRef(c[1],0,this.l1_1),W.Zr.FromArrayToRef(c[2],0,this.l10),W.Zr.FromArrayToRef(c[3],0,this.l11),W.Zr.FromArrayToRef(c[4],0,this.l2_2),W.Zr.FromArrayToRef(c[5],0,this.l2_1),W.Zr.FromArrayToRef(c[6],0,this.l20),W.Zr.FromArrayToRef(c[7],0,this.l21),W.Zr.FromArrayToRef(c[8],0,this.l22),this}updateFromFloatsArray(c){return W.Zr.FromFloatsToRef(c[0],c[1],c[2],this.l00),W.Zr.FromFloatsToRef(c[3],c[4],c[5],this.l1_1),W.Zr.FromFloatsToRef(c[6],c[7],c[8],this.l10),W.Zr.FromFloatsToRef(c[9],c[10],c[11],this.l11),W.Zr.FromFloatsToRef(c[12],c[13],c[14],this.l2_2),W.Zr.FromFloatsToRef(c[15],c[16],c[17],this.l2_1),W.Zr.FromFloatsToRef(c[18],c[19],c[20],this.l20),W.Zr.FromFloatsToRef(c[21],c[22],c[23],this.l21),W.Zr.FromFloatsToRef(c[24],c[25],c[26],this.l22),this}static er(c){return(new x).updateFromArray(c)}static FromPolynomial(c){const r=new x;return r.l00=c.xx.scale(.376127).add(c.yy.scale(.376127)).add(c.zz.scale(.376126)),r.l1_1=c.y.scale(.977204),r.l10=c.z.scale(.977204),r.l11=c.x.scale(.977204),r.l2_2=c.xy.scale(1.16538),r.l2_1=c.yz.scale(1.16538),r.l20=c.zz.scale(1.34567).Jr(c.xx.scale(.672834)).Jr(c.yy.scale(.672834)),r.l21=c.zx.scale(1.16538),r.l22=c.xx.scale(1.16538).Jr(c.yy.scale(1.16538)),r.l1_1.scaleInPlace(-1),r.l11.scaleInPlace(-1),r.l2_1.scaleInPlace(-1),r.l21.scaleInPlace(-1),r.scaleInPlace(Math.PI),r}}class M{constructor(){this.x=W.Zr.Zero(),this.y=W.Zr.Zero(),this.z=W.Zr.Zero(),this.xx=W.Zr.Zero(),this.yy=W.Zr.Zero(),this.zz=W.Zr.Zero(),this.xy=W.Zr.Zero(),this.yz=W.Zr.Zero(),this.zx=W.Zr.Zero()}get preScaledHarmonics(){return this._harmonics||(this._harmonics=x.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(c){B.f.Zr[0].Ja(c.r,c.g,c.b);const r=B.f.Zr[0];this.xx.addInPlace(r),this.yy.addInPlace(r),this.zz.addInPlace(r)}scaleInPlace(c){this.x.scaleInPlace(c),this.y.scaleInPlace(c),this.z.scaleInPlace(c),this.xx.scaleInPlace(c),this.yy.scaleInPlace(c),this.zz.scaleInPlace(c),this.yz.scaleInPlace(c),this.zx.scaleInPlace(c),this.xy.scaleInPlace(c)}updateFromHarmonics(c){return this._harmonics=c,this.x.t(c.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.t(c.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.t(c.l10),this.z.scaleInPlace(1.02333),this.xx.t(c.l00),B.f.Zr[0].t(c.l20).scaleInPlace(.247708),B.f.Zr[1].t(c.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).BE(B.f.Zr[0]).addInPlace(B.f.Zr[1]),this.yy.t(c.l00),this.yy.scaleInPlace(.886277).BE(B.f.Zr[0]).BE(B.f.Zr[1]),this.zz.t(c.l00),B.f.Zr[0].t(c.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(B.f.Zr[0]),this.yz.t(c.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.t(c.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.t(c.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(c){return(new M).updateFromHarmonics(c)}static er(c){const r=new M;return W.Zr.FromArrayToRef(c[0],0,r.x),W.Zr.FromArrayToRef(c[1],0,r.y),W.Zr.FromArrayToRef(c[2],0,r.z),W.Zr.FromArrayToRef(c[3],0,r.xx),W.Zr.FromArrayToRef(c[4],0,r.yy),W.Zr.FromArrayToRef(c[5],0,r.zz),W.Zr.FromArrayToRef(c[6],0,r.yz),W.Zr.FromArrayToRef(c[7],0,r.zx),W.Zr.FromArrayToRef(c[8],0,r.xy),r}}},11808:(c,r,D)=>{D.d(r,{d:()=>B});var W=D(11756);class B extends W.e{constructor(c){super(),this._buffer=c}get underlyingResource(){return this._buffer}}},11907:(c,r,D)=>{D.d(r,{e:()=>Z,f:()=>X,j:()=>y,m:()=>U,q:()=>j});var W=D(11656),B=D(11737),t=D(11664),u=D(11768),a=D(11584),H=D(11637),x=D(11717),M=D(11771),E=D(11792);class m extends M.e{_gatherImports(c,r){c?(this._webGPUReady=!0,r.push(Promise.all([D.e(51).then(D.bind(D,14151))]))):r.push(Promise.all([D.e(52).then(D.bind(D,14155))])),super._gatherImports(c,r)}constructor(c){super({...arguments.length>2?arguments[2]:void 0,name:c,wr:(arguments.length>1&&void 0!==arguments[1]?arguments[1]:null)||E.b.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:m.FragmentUrl})}}m.FragmentUrl="pass";class Y extends M.e{_gatherImports(c,r){c?(this._webGPUReady=!0,r.push(Promise.all([D.e(62).then(D.bind(D,14216))]))):r.push(Promise.all([D.e(63).then(D.bind(D,14222))])),super._gatherImports(c,r)}constructor(c){super({...arguments.length>2?arguments[2]:void 0,name:c,wr:(arguments.length>1&&void 0!==arguments[1]?arguments[1]:null)||E.b.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Y.FragmentUrl,defines:"#define POSITIVEX"}),this._face=0}get face(){return this._face}set face(c){if(!(c<0||c>5))switch(this._face=c,this._face){case 0:this.updateEffect("#define POSITIVEX");break;case 1:this.updateEffect("#define NEGATIVEX");break;case 2:this.updateEffect("#define POSITIVEY");break;case 3:this.updateEffect("#define NEGATIVEY");break;case 4:this.updateEffect("#define POSITIVEZ");break;case 5:this.updateEffect("#define NEGATIVEZ")}}}Y.FragmentUrl="passCube";var v=D(11669);class k extends u.e{getClassName(){return"PassPostProcess"}constructor(c,r){let D=arguments.length>4?arguments[4]:void 0;const W={size:"number"===typeof r?r:void 0,camera:arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,samplingMode:arguments.length>3?arguments[3]:void 0,wr:D,reusable:arguments.length>5?arguments[5]:void 0,textureType:arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,blockCompilation:arguments.length>7&&void 0!==arguments[7]&&arguments[7],...r};super(c,m.FragmentUrl,{effectWrapper:"number"!==typeof r&&r.effectWrapper?void 0:new m(c,D,W),...W})}static _Parse(c,r,D,W){return x.d.Parse((()=>new k(c.name,c.options,r,c.renderTargetSamplingMode,c._engine,c.reusable)),c,D,W)}}(0,H.e)("BABYLON.PassPostProcess",k);class w extends u.e{get face(){return this._effectWrapper.face}set face(c){this._effectWrapper.face=c}getClassName(){return"PassCubePostProcess"}constructor(c,r){let D=arguments.length>4?arguments[4]:void 0;const W={size:"number"===typeof r?r:void 0,camera:arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,samplingMode:arguments.length>3?arguments[3]:void 0,wr:D,reusable:arguments.length>5?arguments[5]:void 0,textureType:arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,blockCompilation:arguments.length>7&&void 0!==arguments[7]&&arguments[7],...r};super(c,m.FragmentUrl,{effectWrapper:"number"!==typeof r&&r.effectWrapper?void 0:new Y(c,D,W),...W})}static _Parse(c,r,D,W){return x.d.Parse((()=>new w(c.name,c.options,r,c.renderTargetSamplingMode,c._engine,c.reusable)),c,D,W)}}function Z(c,r,D,W,B,t,a,H){const x=r.getEngine();return r.isReady=!1,B=B??r.samplingMode,W=W??r.type,t=t??r.format,a=a??r.width,H=H??r.height,-1===W&&(W=0),new Promise((M=>{const E=new u.e("postprocess",c,null,null,1,null,B,x,!1,void 0,W,void 0,null,!1,t);E.externalTextureSamplerBinding=!0;const m=x.createRenderTargetTexture({width:a,height:H},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:B,type:W,format:t});E.onEffectCreatedObservable.addOnce((c=>{c.executeWhenCompiled((()=>{E.onApply=c=>{c._bindTexture("textureSampler",r),c.setFloat2("scale",1,1)},D.postProcessManager.directRender([E],m,!0),x.restoreDefaultFramebuffer(),x._releaseTexture(r),E&&E.dispose(),m._swapAndDie(r),r.type=W,r.format=5,r.isReady=!0,M(r)}))}))}))}let J,q;function j(c){J||(J=new Float32Array(1),q=new Int32Array(J.buffer)),J[0]=c;const r=q[0];let D=r>>16&32768,W=r>>12&2047;const B=r>>23&255;return B<103?D:B>142?(D|=31744,D|=(255==B?0:1)&&8388607&r,D):B<113?(W|=2048,D|=(W>>114-B)+(W>>113-B&1),D):(D|=B-112<<10|W>>1,D+=1&W,D)}function X(c){const r=(32768&c)>>15,D=(31744&c)>>10,W=1023&c;return 0===D?(r?-1:1)*Math.pow(2,-14)*(W/Math.pow(2,10)):31==D?W?NaN:1/0*(r?-1:1):(r?-1:1)*Math.pow(2,D-15)*(1+W/Math.pow(2,10))}(0,t.e)([(0,v.K)()],w.prototype,"face",null),a.b._RescalePostProcessFactory=c=>new k("rescale",1,null,2,c,!1,0);const e=async(c,r,t,a,H)=>{const x=c.yc(),M=x.getEngine();let E;if(M.isWebGPU?c.isCube?await D.e(60).then(D.bind(D,14201)):await D.e(61).then(D.bind(D,14209)):c.isCube?await D.e(58).then(D.bind(D,14186)):await D.e(59).then(D.bind(D,14194)),c.isCube){const c=["#define POSITIVEX","#define NEGATIVEX","#define POSITIVEY","#define NEGATIVEY","#define POSITIVEZ","#define NEGATIVEZ"];E=new u.e("lodCube","lodCube",{uniforms:["lod","gamma"],samplingMode:W.b.NEAREST_NEAREST_MIPNEAREST,wr:M,defines:c[a],shaderLanguage:M.isWebGPU?1:0})}else E=new u.e("lod","lod",{uniforms:["lod","gamma"],samplingMode:W.b.NEAREST_NEAREST_MIPNEAREST,wr:M,shaderLanguage:M.isWebGPU?1:0});await new Promise((c=>{E.onEffectCreatedObservable.addOnce((r=>{r.executeWhenCompiled((()=>{c(0)}))}))}));const m=new B.b("temp",{width:r,height:t},x,!1);E.onApply=function(r){r.setTexture("textureSampler",c),r.setFloat("lod",H),r.setInt("gamma",c.gammaSpace?1:0)};const Y=c.getInternalTexture();try{if(m.renderTarget&&Y){const D=Y.samplingMode;0!==H?c.updateSamplingMode(W.b.NEAREST_NEAREST_MIPNEAREST):c.updateSamplingMode(W.b.NEAREST_NEAREST),x.postProcessManager.directRender([E],m.renderTarget,!0),c.updateSamplingMode(D);const B=await M.readPixels(0,0,r,t),u=new Uint8Array(B.buffer,0,B.byteLength);return M.unBindFramebuffer(m.renderTarget),u}throw Error("Render to texture failed.")}finally{m.dispose(),E.dispose()}};async function y(c,r,D){let W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,B=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;return!c.isReady()&&c._texture&&await new Promise(((r,D)=>{null!==c._texture?c._texture.onLoadedObservable.addOnce((()=>{r(0)})):D(0)})),await e(c,r,D,W,B)}const U={CreateResizedCopy:function(c,r,D){let t=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const u=c.yc(),a=u.getEngine(),H=new B.b("resized"+c.name,{width:r,height:D},u,!c.noMipmap,!0,c._texture.type,!1,c.samplingMode,!1);H.wrapU=c.wrapU,H.wrapV=c.wrapV,H.uOffset=c.uOffset,H.vOffset=c.vOffset,H.uScale=c.uScale,H.vScale=c.vScale,H.uAng=c.uAng,H.vAng=c.vAng,H.wAng=c.wAng,H.coordinatesIndex=c.coordinatesIndex,H.level=c.level,H.anisotropicFilteringLevel=c.anisotropicFilteringLevel,H._texture.isReady=!1,c.wrapU=W.b.CLAMP_ADDRESSMODE,c.wrapV=W.b.CLAMP_ADDRESSMODE;const x=new k("pass",1,null,t?W.b.BILINEAR_SAMPLINGMODE:W.b.NEAREST_SAMPLINGMODE,a,!1,0);return x.externalTextureSamplerBinding=!0,x.onEffectCreatedObservable.addOnce((r=>{r.executeWhenCompiled((()=>{x.onApply=function(r){r.setTexture("textureSampler",c)};const r=H.renderTarget;r&&(u.postProcessManager.directRender([x],r),a.unBindFramebuffer(r),H.disposeFramebufferObjects(),x.dispose(),H.getInternalTexture().isReady=!0)}))})),H},ApplyPostProcess:Z,ToHalfFloat:j,FromHalfFloat:X,GetTextureDataAsync:y}},11768:(c,r,D)=>{D.d(r,{e:()=>v});var W=D(11664),B=D(11766),t=D(11494),u=D(11683),a=D(11586),H=D(11669),x=D(11717),M=D(11637),E=D(11584),m=D(11648),Y=D(11771);E.b.prototype.setTextureFromPostProcess=function(c,r,D){var W;let B=null;r&&(r._forcedOutputTexture?B=r._forcedOutputTexture:r._textures.data[r._currentRenderTextureInd]&&(B=r._textures.data[r._currentRenderTextureInd])),this._bindTexture(c,(null===(W=B)||void 0===W?void 0:W.texture)??null,D)},E.b.prototype.setTextureFromPostProcessOutput=function(c,r,D){var W;this._bindTexture(c,(null===r||void 0===r||null===(W=r._outputTexture)||void 0===W?void 0:W.texture)??null,D)},a.Effect.prototype.setTextureFromPostProcess=function(c,r){this._engine.setTextureFromPostProcess(this._samplers[c],r,c)},a.Effect.prototype.setTextureFromPostProcessOutput=function(c,r){this._engine.setTextureFromPostProcessOutput(this._samplers[c],r,c)};class v{static get ForceGLSL(){return Y.e.ForceGLSL}static set ForceGLSL(c){Y.e.ForceGLSL=c}static RegisterShaderCodeProcessing(c,r){Y.e.RegisterShaderCodeProcessing(c,r)}get name(){return this._effectWrapper.name}set name(c){this._effectWrapper.name=c}get alphaMode(){return this._effectWrapper.alphaMode}set alphaMode(c){this._effectWrapper.alphaMode=c}get samples(){return this._samples}set samples(c){this._samples=Math.min(c,this._engine.getCaps().maxMSAASamples),this._textures.forEach((c=>{c.setSamples(this._samples)}))}get shaderLanguage(){return this._shaderLanguage}getEffectName(){return this._fragmentUrl}set onActivate(c){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),c&&(this._onActivateObserver=this.onActivateObservable.add(c))}set onSizeChanged(c){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(c)}set onApply(c){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(c)}set onBeforeRender(c){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(c)}set onAfterRender(c){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(c)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(c){this._forcedOutputTexture=c}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.Ja(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(c,r,D,W,a,H){var x;let M=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,E=arguments.length>7?arguments[7]:void 0,m=arguments.length>8?arguments[8]:void 0,k=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,w=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0,Z=arguments.length>11&&void 0!==arguments[11]?arguments[11]:"postprocess",J=arguments.length>12?arguments[12]:void 0,q=arguments.length>13&&void 0!==arguments[13]&&arguments[13],j=arguments.length>14&&void 0!==arguments[14]?arguments[14]:5,X=arguments.length>15?arguments[15]:void 0,e=arguments.length>16?arguments[16]:void 0;this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.Ha=!0,this.forceAutoClearInAlphaMode=!1,this.animations=[],this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._webGPUReady=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new B.e(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new u.Vector2(1,1),this._texelSize=u.Vector2.Zero(),this.onActivateObservable=new t.c,this.onSizeChangedObservable=new t.c,this.onApplyObservable=new t.c,this.onBeforeRenderObservable=new t.c,this.onAfterRenderObservable=new t.c,this.Wa=new t.c;let y,U=1,N=null;if(D&&!Array.isArray(D)){const c=D;D=c.uniforms??null,W=c.samplers??null,U=c.size??1,H=c.camera??null,M=c.samplingMode??1,E=c.wr,m=c.reusable,k=Array.isArray(c.defines)?c.defines.join("\n"):c.defines??null,w=c.textureType??0,Z=c.vertexUrl??"postprocess",J=c.indexParameters,q=c.blockCompilation??!1,j=c.textureFormat??5,X=c.shaderLanguage??0,N=c.uniformBuffers??null,e=c.extraInitializations,y=c.effectWrapper}else a&&(U="number"===typeof a?a:{width:a.width,height:a.height});if(this._useExistingThinPostProcess=!!y,this._effectWrapper=y??new Y.e({name:c,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:r,wr:E||(null===(x=H)||void 0===x?void 0:x.yc().getEngine()),uniforms:D,samplers:W,uniformBuffers:N,defines:k,vertexUrl:Z,indexParameters:J,blockCompilation:!0,shaderLanguage:X,extraInitializations:void 0}),this.name=c,this.onEffectCreatedObservable=this._effectWrapper.onEffectCreatedObservable,null!=H?(this._camera=H,this._scene=H.yc(),H.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):E&&(this._engine=E,this._engine.postProcesses.push(this)),this._options=U,this.renderTargetSamplingMode=M||1,this._reusable=m||!1,this._textureType=w,this._textureFormat=j,this._shaderLanguage=X||0,this._samplers=W||[],-1===this._samplers.indexOf("textureSampler")&&this._samplers.push("textureSampler"),this._fragmentUrl=r,this._vertexUrl=Z,this._parameters=D||[],-1===this._parameters.indexOf("scale")&&this._parameters.push("scale"),this._uniformBuffers=N||[],this._indexParameters=J,!this._useExistingThinPostProcess){this._webGPUReady=1===this._shaderLanguage;const c=[];this._gatherImports(this._engine.isWebGPU&&!v.ForceGLSL,c),this._effectWrapper._webGPUReady=this._webGPUReady,this._effectWrapper._postConstructor(q,k,e,c)}}_gatherImports(){let c=arguments.length>1?arguments[1]:void 0;arguments.length>0&&void 0!==arguments[0]&&arguments[0]&&this._webGPUReady?c.push(Promise.all([D.e(53).then(D.bind(D,14157))])):c.push(Promise.all([Promise.resolve().then(D.bind(D,11787))]))}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._effectWrapper.drawWrapper.effect}shareOutputWith(c){return this._disposeTextures(),this._shareOutputWithPostProcess=c,this}useOwnOutput(){0==this._textures.length&&(this._textures=new B.e(2)),this._shareOutputWithPostProcess=null}updateEffect(){let c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,D=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,W=arguments.length>3?arguments[3]:void 0,B=arguments.length>4?arguments[4]:void 0,t=arguments.length>5?arguments[5]:void 0,u=arguments.length>6?arguments[6]:void 0,a=arguments.length>7?arguments[7]:void 0;this._effectWrapper.updateEffect(c,r,D,W,B,t,u,a),this._postProcessDefines=Array.isArray(this._effectWrapper.options.defines)?this._effectWrapper.options.defines.join("\n"):this._effectWrapper.options.defines}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(c,r){let D=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;for(let B=0;B<this._textureCache.length;B++)if(this._textureCache[B].texture.width===c.width&&this._textureCache[B].texture.height===c.height&&this._textureCache[B].postProcessChannel===D&&this._textureCache[B].texture._generateDepthBuffer===r.generateDepthBuffer&&this._textureCache[B].texture.samples===r.samples)return this._textureCache[B].texture;const W=this._engine.createRenderTargetTexture(c,r);return this._textureCache.push({texture:W,postProcessChannel:D,lastUsedRenderId:-1}),W}_flushTextureCache(){const c=this._renderId;for(let r=this._textureCache.length-1;r>=0;r--)if(c-this._textureCache[r].lastUsedRenderId>100){let c=!1;for(let D=0;D<this._textures.length;D++)if(this._textures.data[D]===this._textureCache[r].texture){c=!0;break}c||(this._textureCache[r].texture.dispose(),this._textureCache.splice(r,1))}}resize(c,r){let D=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,W=arguments.length>3&&void 0!==arguments[3]&&arguments[3],B=arguments.length>4&&void 0!==arguments[4]&&arguments[4];this._textures.length>0&&this._textures.reset(),this.width=c,this.height=r;let t=null;if(D)for(let H=0;H<D._postProcesses.length;H++)if(null!==D._postProcesses[H]){t=D._postProcesses[H];break}const u={width:this.width,height:this.height},a={generateMipMaps:W,generateDepthBuffer:B||t===this,generateStencilBuffer:(B||t===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples,label:"PostProcessRTT-"+this.name};this._textures.push(this._createRenderTargetTexture(u,a,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(u,a,1)),this._texelSize.Ja(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}_getTarget(){let c;if(this._shareOutputWithPostProcess)c=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)c=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{let r;c=this.inputTexture;for(let D=0;D<this._textureCache.length;D++)if(this._textureCache[D].texture===c){r=this._textureCache[D];break}r&&(r.lastUsedRenderId=this._renderId)}return c}activate(c){var r,D;let W=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,B=arguments.length>2?arguments[2]:void 0;const t=null===c||void 0!==c.cameraRigMode?c||this._camera:null,u=(null===t||void 0===t?void 0:t.yc())??c,a=u.getEngine(),H=a.getCaps().maxTextureSize,x=(W?W.width:this._engine.getRenderWidth(!0))*this._options|0,M=(W?W.height:this._engine.getRenderHeight(!0))*this._options|0;let E=this._options.width||x,Y=this._options.height||M;const v=7!==this.renderTargetSamplingMode&&1!==this.renderTargetSamplingMode&&2!==this.renderTargetSamplingMode;let k=null;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const c=a.currentViewport;c&&(E*=c.width,Y*=c.height)}(v||this.alwaysForcePOT)&&(this._options.width||(E=a.needPOTTextures?(0,m.e)(E,H,this.scaleMode):E),this._options.height||(Y=a.needPOTTextures?(0,m.e)(Y,H,this.scaleMode):Y)),this.width===E&&this.height===Y&&(k=this._getTarget())||this.resize(E,Y,t,v,B),this._textures.forEach((c=>{c.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(c,this.samples)})),this._flushTextureCache(),this._renderId++}return k||(k=this._getTarget()),this.enablePixelPerfectMode?(this._scaleRatio.Ja(x/E,M/Y),this._engine.bindFramebuffer(k,0,x,M,this.forceFullscreenViewport)):(this._scaleRatio.Ja(1,1),this._engine.bindFramebuffer(k,0,void 0,void 0,this.forceFullscreenViewport)),null===(r=(D=this._engine)._debugInsertMarker)||void 0===r||r.call(D,`post process ${this.name} input`),this.onActivateObservable.notifyObservers(t),this.Ha&&(0===this.alphaMode||this.forceAutoClearInAlphaMode)&&this._engine.clear(this.clearColor?this.clearColor:u.clearColor,u._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),k}get isSupported(){return this._effectWrapper.drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){return this._effectWrapper.isReady()}apply(){if(!this._effectWrapper.isReady())return null;let c;var r;(this._engine.enableEffect(this._effectWrapper.drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a),this._engine.setAlphaMode(this.alphaMode),c=this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?this._forcedOutputTexture:this.inputTexture,this.externalTextureSamplerBinding)||this._effectWrapper.drawWrapper.effect._bindTexture("textureSampler",null===(r=c)||void 0===r?void 0:r.texture);return this._effectWrapper.drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._effectWrapper.drawWrapper.effect),this._effectWrapper.bind(!0),this._effectWrapper.drawWrapper.effect}_disposeTextures(){this._shareOutputWithPostProcess||this._forcedOutputTexture?this._disposeTextureCache():(this._disposeTextureCache(),this._textures.dispose())}_disposeTextureCache(){for(let c=this._textureCache.length-1;c>=0;c--)this._textureCache[c].texture.dispose();this._textureCache.length=0}setPrePassRenderer(c){return!!this._prePassEffectConfiguration&&(this._prePassEffectConfiguration=c.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0)}dispose(c){let r;if(c=c||this._camera,this._useExistingThinPostProcess||this._effectWrapper.dispose(),this._disposeTextures(),this._scene&&(r=this._scene.postProcesses.indexOf(this),-1!==r&&this._scene.postProcesses.splice(r,1)),this._parentContainer){const c=this._parentContainer.postProcesses.indexOf(this);c>-1&&this._parentContainer.postProcesses.splice(c,1),this._parentContainer=null}if(r=this._engine.postProcesses.indexOf(this),-1!==r&&this._engine.postProcesses.splice(r,1),this.Wa.notifyObservers(),c){if(c.detachPostProcess(this),r=c._postProcesses.indexOf(this),0===r&&c._postProcesses.length>0){const c=this._camera._getFirstPostProcess();c&&c.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear(),this.onEffectCreatedObservable.clear()}}serialize(){const c=x.d.Serialize(this),r=this.getCamera()||this._scene&&this._scene.activeCamera;return c.customType="BABYLON."+this.getClassName(),c.cameraId=r?r.id:null,c.reusable=this._reusable,c.textureType=this._textureType,c.fragmentUrl=this._fragmentUrl,c.parameters=this._parameters,c.samplers=this._samplers,c.uniformBuffers=this._uniformBuffers,c.options=this._options,c.defines=this._postProcessDefines,c.textureFormat=this._textureFormat,c.vertexUrl=this._vertexUrl,c.indexParameters=this._indexParameters,c}clone(){const c=this.serialize();c._engine=this._engine,c.cameraId=null;const r=v.Parse(c,this._scene,"");return r?(r.onActivateObservable=this.onActivateObservable.clone(),r.onSizeChangedObservable=this.onSizeChangedObservable.clone(),r.onApplyObservable=this.onApplyObservable.clone(),r.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),r.onAfterRenderObservable=this.onAfterRenderObservable.clone(),r._prePassEffectConfiguration=this._prePassEffectConfiguration,r):null}static Parse(c,r,D){const W=(0,M.b)(c.customType);if(!W||!W._Parse)return null;const B=r?r.getCameraById(c.cameraId):null;return W._Parse(c,B,r,D)}static _Parse(c,r,D,W){return x.d.Parse((()=>new v(c.name,c.fragmentUrl,c.parameters,c.samplers,c.options,r,c.renderTargetSamplingMode,c._engine,c.reusable,c.defines,c.textureType,c.vertexUrl,c.indexParameters,!1,c.textureFormat)),c,D,W)}}(0,W.e)([(0,H.K)()],v.prototype,"uniqueId",void 0),(0,W.e)([(0,H.K)()],v.prototype,"name",null),(0,W.e)([(0,H.K)()],v.prototype,"width",void 0),(0,W.e)([(0,H.K)()],v.prototype,"height",void 0),(0,W.e)([(0,H.K)()],v.prototype,"renderTargetSamplingMode",void 0),(0,W.e)([(0,H.l)()],v.prototype,"clearColor",void 0),(0,W.e)([(0,H.K)()],v.prototype,"Ha",void 0),(0,W.e)([(0,H.K)()],v.prototype,"forceAutoClearInAlphaMode",void 0),(0,W.e)([(0,H.K)()],v.prototype,"alphaMode",null),(0,W.e)([(0,H.K)()],v.prototype,"alphaConstants",void 0),(0,W.e)([(0,H.K)()],v.prototype,"enablePixelPerfectMode",void 0),(0,W.e)([(0,H.K)()],v.prototype,"forceFullscreenViewport",void 0),(0,W.e)([(0,H.K)()],v.prototype,"scaleMode",void 0),(0,W.e)([(0,H.K)()],v.prototype,"alwaysForcePOT",void 0),(0,W.e)([(0,H.K)("samples")],v.prototype,"_samples",void 0),(0,W.e)([(0,H.K)()],v.prototype,"adaptScaleToCurrentViewport",void 0),(0,M.e)("BABYLON.PostProcess",v)},11787:(c,r,D)=>{D.r(r),D.d(r,{postprocessVertexShader:()=>u});var W=D(11595);const B="postprocessVertexShader",t="attribute vec2 position;uniform vec2 scale;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=(position*madd+madd)*scale;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";W.d.ShadersStore[B]||(W.d.ShadersStore[B]=t);const u={name:B,shader:t}}}]);