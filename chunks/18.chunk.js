"use strict";(self.ufnpnb83drd=self.ufnpnb83drd||[]).push([[18],{12523:(E,U,g)=>{g(12243).b.prototype.createDepthStencilTexture=function(E,U,g){if(U.isCube){const g=E.width||E;return this._createDepthStencilCubeTexture(g,U)}return this._createDepthStencilTexture(E,U,g)}},12504:(E,U,g)=>{g(12471).ThinEngine.prototype.setAlphaMode=function(E){let U=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._alphaMode!==E){switch(E){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0}U||(this.depthCullingState.depthMask=0===E),this._alphaMode=E}else if(!U){const U=0===E;this.depthCullingState.depthMask!==U&&(this.depthCullingState.depthMask=U)}}},12511:(E,U,g)=>{var N=g(12471);N.ThinEngine.prototype.updateDynamicIndexBuffer=function(E,U){let g;this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(E),g=E.is32Bits?U instanceof Uint32Array?U:new Uint32Array(U):U instanceof Uint16Array?U:new Uint16Array(U),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,g,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()},N.ThinEngine.prototype.updateDynamicVertexBuffer=function(E,U,g,N){this.bindArrayBuffer(E),void 0===g&&(g=0);const L=U.byteLength||U.length;void 0===N||N>=L&&0===g?U instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,g,new Float32Array(U)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,g,U):U instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,g,new Float32Array(U).subarray(0,N/4)):(U=U instanceof ArrayBuffer?new Uint8Array(U,0,N):new Uint8Array(U.buffer,U.byteOffset,N),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,g,U)),this._resetVertexBufferBinding()}},12514:(E,U,g)=>{var N=g(12273),L=g(12186),D=g(12471),S=g(12517),u=g(12502);class s extends S.e{setDepthStencilTexture(E){let U=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(super.setDepthStencilTexture(E,U),!E)return;const g=this._engine,N=this._context,L=E._hardwareTexture;if(L&&E._autoMSAAManagement&&this._MSAAFramebuffer){const U=g._currentFramebuffer;g._bindUnboundFramebuffer(this._MSAAFramebuffer),N.framebufferRenderbuffer(N.FRAMEBUFFER,(0,u.b)(E.format)?N.DEPTH_STENCIL_ATTACHMENT:N.DEPTH_ATTACHMENT,N.RENDERBUFFER,L.getMSAARenderBuffer()),g._bindUnboundFramebuffer(U)}}constructor(E,U,g,N,L){super(E,U,g,N),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._disposeOnlyFramebuffers=!1,this._currentLOD=0,this._context=L}_cloneRenderTargetWrapper(){let E=null;return this._colorTextureArray&&this._depthStencilTextureArray?(E=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),E.texture.isReady=!0):E=super._cloneRenderTargetWrapper(),E}_swapRenderTargetWrapper(E){super._swapRenderTargetWrapper(E),E._framebuffer=this._framebuffer,E._depthStencilBuffer=this._depthStencilBuffer,E._MSAAFramebuffer=this._MSAAFramebuffer,E._colorTextureArray=this._colorTextureArray,E._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}createDepthStencilTexture(){let E=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,U=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],g=arguments.length>2&&void 0!==arguments[2]&&arguments[2],N=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,L=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14,D=arguments.length>5?arguments[5]:void 0;if(this._depthStencilBuffer){const E=this._engine,U=E._currentFramebuffer,g=this._context;E._bindUnboundFramebuffer(this._framebuffer),g.framebufferRenderbuffer(g.FRAMEBUFFER,g.DEPTH_STENCIL_ATTACHMENT,g.RENDERBUFFER,null),g.framebufferRenderbuffer(g.FRAMEBUFFER,g.DEPTH_ATTACHMENT,g.RENDERBUFFER,null),g.framebufferRenderbuffer(g.FRAMEBUFFER,g.STENCIL_ATTACHMENT,g.RENDERBUFFER,null),E._bindUnboundFramebuffer(U),g.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null}return super.createDepthStencilTexture(E,U,g,N,L,D)}shareDepth(E){super.shareDepth(E);const U=this._context,g=this._depthStencilBuffer,N=E._MSAAFramebuffer||E._framebuffer,L=this._engine;E._depthStencilBuffer&&E._depthStencilBuffer!==g&&U.deleteRenderbuffer(E._depthStencilBuffer),E._depthStencilBuffer=g;const D=E._generateStencilBuffer?U.DEPTH_STENCIL_ATTACHMENT:U.DEPTH_ATTACHMENT;L._bindUnboundFramebuffer(N),U.framebufferRenderbuffer(U.FRAMEBUFFER,D,U.RENDERBUFFER,g),L._bindUnboundFramebuffer(null)}_bindTextureRenderTarget(E){let U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,g=arguments.length>2?arguments[2]:void 0,N=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const L=E._hardwareTexture;if(!L)return;const D=this._framebuffer,S=this._engine,u=S._currentFramebuffer;let s;if(S._bindUnboundFramebuffer(D),S.webGLVersion>1){const D=this._context;var C;if(s=D["COLOR_ATTACHMENT"+U],E.is2DArray||E.is3D)g=g??(null===(C=this.layerIndices)||void 0===C?void 0:C[U])??0,D.framebufferTextureLayer(D.FRAMEBUFFER,s,L.underlyingResource,N,g);else if(E.isCube){var B;g=g??(null===(B=this.faceIndices)||void 0===B?void 0:B[U])??0,D.framebufferTexture2D(D.FRAMEBUFFER,s,D.TEXTURE_CUBE_MAP_POSITIVE_X+g,L.underlyingResource,N)}else D.framebufferTexture2D(D.FRAMEBUFFER,s,D.TEXTURE_2D,L.underlyingResource,N)}else{const E=this._context;s=E["COLOR_ATTACHMENT"+U+"_WEBGL"];const D=void 0!==g?E.TEXTURE_CUBE_MAP_POSITIVE_X+g:E.TEXTURE_2D;E.framebufferTexture2D(E.FRAMEBUFFER,s,D,L.underlyingResource,N)}if(E._autoMSAAManagement&&this._MSAAFramebuffer){const E=this._context;S._bindUnboundFramebuffer(this._MSAAFramebuffer),E.framebufferRenderbuffer(E.FRAMEBUFFER,s,E.RENDERBUFFER,L.getMSAARenderBuffer())}S._bindUnboundFramebuffer(u)}setTexture(E){let U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,g=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];super.setTexture(E,U,g),this._bindTextureRenderTarget(E,U)}setLayerAndFaceIndices(E,U){var g;if(super.setLayerAndFaceIndices(E,U),!this.textures||!this.layerIndices||!this.faceIndices)return;const N=(null===(g=this._attachments)||void 0===g?void 0:g.length)??this.textures.length;for(let L=0;L<N;L++){const E=this.textures[L];E&&(E.is2DArray||E.is3D?this._bindTextureRenderTarget(E,L,this.layerIndices[L]):E.isCube?this._bindTextureRenderTarget(E,L,this.faceIndices[L]):this._bindTextureRenderTarget(E,L))}}setLayerAndFaceIndex(){let E=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,U=arguments.length>1?arguments[1]:void 0,g=arguments.length>2?arguments[2]:void 0;if(super.setLayerAndFaceIndex(E,U,g),!this.textures||!this.layerIndices||!this.faceIndices)return;const N=this.textures[E];N.is2DArray||N.is3D?this._bindTextureRenderTarget(this.textures[E],E,this.layerIndices[E]):N.isCube&&this._bindTextureRenderTarget(this.textures[E],E,this.faceIndices[E])}resolveMSAATextures(){const E=this._engine,U=E._currentFramebuffer;E._bindUnboundFramebuffer(this._MSAAFramebuffer),super.resolveMSAATextures(),E._bindUnboundFramebuffer(U)}dispose(){let E=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._disposeOnlyFramebuffers;const U=this._context;E||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(U.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(U.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(U.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(E)}}g(12523);D.ThinEngine.prototype._createHardwareRenderTargetWrapper=function(E,U,g){const N=new s(E,U,g,this,this._gl);return this._renderTargetWrapperCache.push(N),N},D.ThinEngine.prototype.createRenderTargetTexture=function(E,U){const g=this._createHardwareRenderTargetWrapper(!1,!1,E);let N,L,D=!0,S=!1,u=!1,s=1;void 0!==U&&"object"===typeof U&&(D=U.generateDepthBuffer??!0,S=!!U.generateStencilBuffer,u=!!U.noColorAttachment,N=U.colorAttachment,s=U.samples??1,L=U.label);const C=N||(u?null:this._createInternalTexture(E,U,!0,5)),B=E.width||E,P=E.height||E,F=this._currentFramebuffer,f=this._gl,d=f.createFramebuffer();if(this._bindUnboundFramebuffer(d),g._depthStencilBuffer=this._setupFramebufferDepthAttachments(S,D,B,P),!C||C.is2DArray||C.is3D||f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,C._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(F),g.label=L??"RenderTargetWrapper",g._framebuffer=d,g._generateDepthBuffer=D,g._generateStencilBuffer=S,g.setTextures(C),N){if(g._samples=N.samples,N.samples>1){const E=N._hardwareTexture.getMSAARenderBuffer(0);g._MSAAFramebuffer=f.createFramebuffer(),this._bindUnboundFramebuffer(g._MSAAFramebuffer),f.framebufferRenderbuffer(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.RENDERBUFFER,E),this._bindUnboundFramebuffer(null)}}else this.updateRenderTargetTextureSampleCount(g,s);return g},D.ThinEngine.prototype._createDepthStencilTexture=function(E,U,g){const D=this._gl,S=E.layers||0,s=E.depth||0;let C=D.TEXTURE_2D;0!==S?C=D.TEXTURE_2D_ARRAY:0!==s&&(C=D.TEXTURE_3D);const B=new N.c(this,12);if(B.label=U.label,!this._caps.depthTextureExtension)return L.d.Error("Depth texture is not supported by your browser or hardware."),B;const P={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...U};if(this._bindTextureDirectly(C,B,!0),this._setupDepthStencilTexture(B,E,0!==P.comparisonFunction&&P.bilinearFiltering,P.comparisonFunction,P.samples),void 0!==P.depthTextureFormat){if(15!==P.depthTextureFormat&&16!==P.depthTextureFormat&&17!==P.depthTextureFormat&&13!==P.depthTextureFormat&&14!==P.depthTextureFormat&&18!==P.depthTextureFormat)return L.d.Error(`Depth texture ${P.depthTextureFormat} format is not supported.`),B;B.format=P.depthTextureFormat}else B.format=P.generateStencil?13:16;const F=(0,u.b)(B.format),f=this._getWebGLTextureTypeFromDepthTextureFormat(B.format),d=F?D.DEPTH_STENCIL:D.DEPTH_COMPONENT,I=this._getInternalFormatFromDepthTextureFormat(B.format,!0,F);return B.is2DArray?D.texImage3D(C,0,I,B.width,B.height,S,0,d,f,null):B.is3D?D.texImage3D(C,0,I,B.width,B.height,s,0,d,f,null):D.texImage2D(C,0,I,B.width,B.height,0,d,f,null),this._bindTextureDirectly(C,null),this._internalTexturesCache.push(B),g._depthStencilBuffer&&(D.deleteRenderbuffer(g._depthStencilBuffer),g._depthStencilBuffer=null),this._bindUnboundFramebuffer(g._MSAAFramebuffer??g._framebuffer),g._generateStencilBuffer=F,g._depthStencilTextureWithStencil=F,g._depthStencilBuffer=this._setupFramebufferDepthAttachments(g._generateStencilBuffer,g._generateDepthBuffer,g.width,g.height,g.samples,B.format),this._bindUnboundFramebuffer(null),B},D.ThinEngine.prototype.updateRenderTargetTextureSampleCount=function(E,U){var g;if(this.webGLVersion<2||!E)return 1;if(E.samples===U)return U;const N=this._gl;U=Math.min(U,this.getCaps().maxMSAASamples),E._depthStencilBuffer&&(N.deleteRenderbuffer(E._depthStencilBuffer),E._depthStencilBuffer=null),E._MSAAFramebuffer&&(N.deleteFramebuffer(E._MSAAFramebuffer),E._MSAAFramebuffer=null);const L=null===(g=E.texture)||void 0===g?void 0:g._hardwareTexture;if(null===L||void 0===L||L.releaseMSAARenderBuffers(),E.texture&&U>1&&"function"===typeof N.renderbufferStorageMultisample){const g=N.createFramebuffer();if(!g)throw new Error("Unable to create multi sampled framebuffer");E._MSAAFramebuffer=g,this._bindUnboundFramebuffer(E._MSAAFramebuffer);const D=this._createRenderBuffer(E.texture.width,E.texture.height,U,-1,this._getRGBABufferInternalSizedFormat(E.texture.type,E.texture.format,E.texture._useSRGBBuffer),N.COLOR_ATTACHMENT0,!1);if(!D)throw new Error("Unable to create multi sampled framebuffer");null===L||void 0===L||L.addMSAARenderBuffer(D)}this._bindUnboundFramebuffer(E._MSAAFramebuffer??E._framebuffer),E.texture&&(E.texture.samples=U),E._samples=U;const D=E._depthStencilTexture?E._depthStencilTexture.format:void 0;return E._depthStencilBuffer=this._setupFramebufferDepthAttachments(E._generateStencilBuffer,E._generateDepthBuffer,E.width,E.height,U,D),this._bindUnboundFramebuffer(null),U},D.ThinEngine.prototype._setupDepthStencilTexture=function(E,U,g,N){let L=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;const D=U.width??U,S=U.height??U,u=U.layers||0,s=U.depth||0;E.baseWidth=D,E.baseHeight=S,E.width=D,E.height=S,E.is2DArray=u>0,E.depth=u||s,E.isReady=!0,E.samples=L,E.generateMipMaps=!1,E.samplingMode=g?2:1,E.type=0,E._comparisonFunction=N;const C=this._gl,B=this._getTextureTarget(E),P=this._getSamplingParameters(E.samplingMode,!1);C.texParameteri(B,C.TEXTURE_MAG_FILTER,P.mag),C.texParameteri(B,C.TEXTURE_MIN_FILTER,P.min),C.texParameteri(B,C.TEXTURE_WRAP_S,C.CLAMP_TO_EDGE),C.texParameteri(B,C.TEXTURE_WRAP_T,C.CLAMP_TO_EDGE),this.webGLVersion>1&&(0===N?(C.texParameteri(B,C.TEXTURE_COMPARE_FUNC,515),C.texParameteri(B,C.TEXTURE_COMPARE_MODE,C.NONE)):(C.texParameteri(B,C.TEXTURE_COMPARE_FUNC,N),C.texParameteri(B,C.TEXTURE_COMPARE_MODE,C.COMPARE_REF_TO_TEXTURE)))}},12493:(E,U,g)=>{g.d(U,{e:()=>N});class N{get underlyingResource(){return this._webGLTexture}constructor(){let E=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,U=arguments.length>1?arguments[1]:void 0;if(this._MSAARenderBuffers=null,this._context=U,!E&&(E=U.createTexture(),!E))throw new Error("Unable to create webGL texture");this.set(E)}setUsage(){}set(E){this._webGLTexture=E}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(E){this._MSAARenderBuffers||(this._MSAARenderBuffers=[]),this._MSAARenderBuffers.push(E)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(const E of this._MSAARenderBuffers)this._context.deleteRenderbuffer(E);this._MSAARenderBuffers=null}}getMSAARenderBuffer(){var E;let U=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return(null===(E=this._MSAARenderBuffers)||void 0===E?void 0:E[U])??null}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}},12462:(E,U,g)=>{g.d(U,{c:()=>G});var N=g(12273),L=g(12205),D=g(12471),S=g(12197);class u{constructor(){let E=arguments.length>0&&void 0!==arguments[0]?arguments[0]:30;this._enabled=!0,this._rollingFrameTime=new s(E)}sampleFrame(){let E=arguments.length>0&&void 0!==arguments[0]?arguments[0]:S.b.Now;if(this._enabled){if(null!=this._lastFrameTimeMs){const U=E-this._lastFrameTimeMs;this._rollingFrameTime.add(U)}this._lastFrameTimeMs=E}}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){const E=this._rollingFrameTime.history(0);return 0===E?0:1e3/E}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}}class s{constructor(E){this._samples=new Array(E),this.reset()}add(E){let U;if(this.isSaturated()){const E=this._samples[this._pos];U=E-this.average,this.average-=U/(this._sampleCount-1),this._m2-=U*(E-this.average)}else this._sampleCount++;U=E-this.average,this.average+=U/this._sampleCount,this._m2+=U*(E-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=E,this._pos++,this._pos%=this._samples.length}history(E){if(E>=this._sampleCount||E>=this._samples.length)return 0;const U=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(U-E)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(E){const U=this._samples.length;return(E%U+U)%U}}var C=g(12484),B=g(12186),P=g(12493),F=(g(12504),g(12300));function f(E,U,g,N){let L,D=1;1===N?L=new Float32Array(U*g*4):2===N?(L=new Uint16Array(U*g*4),D=15360):L=7===N?new Uint32Array(U*g*4):new Uint8Array(U*g*4);for(let S=0;S<U;S++)for(let N=0;N<g;N++){const g=3*(N*U+S),u=4*(N*U+S);L[u+0]=E[g+0],L[u+1]=E[g+1],L[u+2]=E[g+2],L[u+3]=D}return L}function d(E){return function(U,g,L,D,S,u,s,C){let B=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,P=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;const F=E?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,f=E?10:11,d=new N.c(this,f);d.baseWidth=g,d.baseHeight=L,d.baseDepth=D,d.width=g,d.height=L,d.depth=D,d.format=S,d.type=P,d.generateMipMaps=u,d.samplingMode=C,E?d.is3D=!0:d.is2DArray=!0,this._doNotHandleContextLost||(d._bufferView=U),E?this.updateRawTexture3D(d,U,S,s,B,P):this.updateRawTexture2DArray(d,U,S,s,B,P),this._bindTextureDirectly(F,d,!0);const I=this._getSamplingParameters(C,u);return this._gl.texParameteri(F,this._gl.TEXTURE_MAG_FILTER,I.mag),this._gl.texParameteri(F,this._gl.TEXTURE_MIN_FILTER,I.min),u&&this._gl.generateMipmap(F),this._bindTextureDirectly(F,null),this._internalTexturesCache.push(d),d}}function I(E){return function(U,g,N,L){let D=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,S=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;const u=E?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,s=this._getWebGLTextureType(S),C=this._getInternalFormat(N),B=this._getRGBABufferInternalSizedFormat(S,N);this._bindTextureDirectly(u,U,!0),this._unpackFlipY(void 0===L||!!L),this._doNotHandleContextLost||(U._bufferView=g,U.format=N,U.invertY=L,U._compression=D),U.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),D&&g?this._gl.compressedTexImage3D(u,0,this.getCaps().s3tc[D],U.width,U.height,U.depth,0,g):this._gl.texImage3D(u,0,B,U.width,U.height,U.depth,0,C,s,g),U.generateMipMaps&&this._gl.generateMipmap(u),this._bindTextureDirectly(u,null),U.isReady=!0}}D.ThinEngine.prototype.updateRawTexture=function(E,U,g,N){let L=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,D=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,S=arguments.length>6&&void 0!==arguments[6]&&arguments[6];if(!E)return;const u=this._getRGBABufferInternalSizedFormat(D,g,S),s=this._getInternalFormat(g),C=this._getWebGLTextureType(D);this._bindTextureDirectly(this._gl.TEXTURE_2D,E,!0),this._unpackFlipY(void 0===N||!!N),this._doNotHandleContextLost||(E._bufferView=U,E.format=g,E.type=D,E.invertY=N,E._compression=L),E.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),L&&U?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[L],E.width,E.height,0,U):this._gl.texImage2D(this._gl.TEXTURE_2D,0,u,E.width,E.height,0,s,C,U),E.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),E.isReady=!0},D.ThinEngine.prototype.createRawTexture=function(E,U,g,L,D,S,u){let s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,C=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,B=arguments.length>10&&void 0!==arguments[10]&&arguments[10];const P=new N.c(this,3);P.baseWidth=U,P.baseHeight=g,P.width=U,P.height=g,P.format=L,P.generateMipMaps=D,P.samplingMode=u,P.invertY=S,P._compression=s,P.type=C,P._useSRGBBuffer=this._getUseSRGBBuffer(B,!D),this._doNotHandleContextLost||(P._bufferView=E),this.updateRawTexture(P,E,L,S,s,C,P._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,P,!0);const F=this._getSamplingParameters(u,D);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,F.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,F.min),D&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(P),P},D.ThinEngine.prototype.createRawCubeTexture=function(E,U,g,L,D,S,u){let s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;const C=this._gl,P=new N.c(this,8);P.isCube=!0,P.format=g,P.type=L,this._doNotHandleContextLost||(P._bufferViewArray=E);const f=this._getWebGLTextureType(L);let d=this._getInternalFormat(g);d===C.RGB&&(d=C.RGBA),f!==C.FLOAT||this._caps.textureFloatLinearFiltering?f!==this._gl.HALF_FLOAT_OES||this._caps.textureHalfFloatLinearFiltering?f!==C.FLOAT||this._caps.textureFloatRender?f!==C.HALF_FLOAT||this._caps.colorBufferFloat||(D=!1,B.d.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(D=!1,B.d.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(D=!1,u=1,B.d.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(D=!1,u=1,B.d.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively."));const I=U,y=I;P.width=I,P.height=y,P.invertY=S,P._compression=s;if(!this.needPOTTextures||(0,F.h)(P.width)&&(0,F.h)(P.height)||(D=!1),E)this.updateRawCubeTexture(P,E,g,L,S,s);else{const E=this._getRGBABufferInternalSizedFormat(L),U=0;this._bindTextureDirectly(C.TEXTURE_CUBE_MAP,P,!0);for(let g=0;g<6;g++)s?C.compressedTexImage2D(C.TEXTURE_CUBE_MAP_POSITIVE_X+g,U,this.getCaps().s3tc[s],P.width,P.height,0,void 0):C.texImage2D(C.TEXTURE_CUBE_MAP_POSITIVE_X+g,U,E,P.width,P.height,0,d,f,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,P,!0),E&&D&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);const h=this._getSamplingParameters(u,D);return C.texParameteri(C.TEXTURE_CUBE_MAP,C.TEXTURE_MAG_FILTER,h.mag),C.texParameteri(C.TEXTURE_CUBE_MAP,C.TEXTURE_MIN_FILTER,h.min),C.texParameteri(C.TEXTURE_CUBE_MAP,C.TEXTURE_WRAP_S,C.CLAMP_TO_EDGE),C.texParameteri(C.TEXTURE_CUBE_MAP,C.TEXTURE_WRAP_T,C.CLAMP_TO_EDGE),this._bindTextureDirectly(C.TEXTURE_CUBE_MAP,null),P.generateMipMaps=D,P.samplingMode=u,P.isReady=!0,P},D.ThinEngine.prototype.updateRawCubeTexture=function(E,U,g,N,L){let D=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,S=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;E._bufferViewArray=U,E.format=g,E.type=N,E.invertY=L,E._compression=D;const u=this._gl,s=this._getWebGLTextureType(N);let C=this._getInternalFormat(g);const B=this._getRGBABufferInternalSizedFormat(N);let P=!1;C===u.RGB&&(C=u.RGBA,P=!0),this._bindTextureDirectly(u.TEXTURE_CUBE_MAP,E,!0),this._unpackFlipY(void 0===L||!!L),E.width%4!==0&&u.pixelStorei(u.UNPACK_ALIGNMENT,1);for(let F=0;F<6;F++){let g=U[F];D?u.compressedTexImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_X+F,S,this.getCaps().s3tc[D],E.width,E.height,0,g):(P&&(g=f(g,E.width,E.height,N)),u.texImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_X+F,S,B,E.width,E.height,0,C,s,g))}(!this.needPOTTextures||(0,F.h)(E.width)&&(0,F.h)(E.height))&&E.generateMipMaps&&0===S&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),E.isReady=!0},D.ThinEngine.prototype.createRawCubeTextureFromUrl=function(E,U,g,N,L,D,S,u){let s=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,C=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,B=arguments.length>10&&void 0!==arguments[10]?arguments[10]:3,P=arguments.length>11&&void 0!==arguments[11]&&arguments[11];const F=this._gl,d=this.createRawCubeTexture(null,g,N,L,!D,P,B,null);null===U||void 0===U||U.addPendingData(d),d.url=E,d.isReady=!1,this._internalTexturesCache.push(d);const I=E=>{if(!d._hardwareTexture)return;const g=d.width,D=S(E);if(D){if(u){const E=this._getWebGLTextureType(L);let U=this._getInternalFormat(N);const S=this._getRGBABufferInternalSizedFormat(L);let s=!1;U===F.RGB&&(U=F.RGBA,s=!0),this._bindTextureDirectly(F.TEXTURE_CUBE_MAP,d,!0),this._unpackFlipY(!1);const C=u(D);for(let N=0;N<C.length;N++){const D=g>>N;for(let g=0;g<6;g++){let u=C[N][g];s&&(u=f(u,D,D,L)),F.texImage2D(g,N,S,D,D,0,U,E,u)}}this._bindTextureDirectly(F.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(d,D,N,L,P);d.isReady=!0,null===U||void 0===U||U.removePendingData(d),d.onLoadedObservable.notifyObservers(d),d.onLoadedObservable.clear(),s&&s()}};return this._loadFile(E,(E=>{I(E)}),void 0,null===U||void 0===U?void 0:U.offlineProvider,!0,((E,g)=>{null===U||void 0===U||U.removePendingData(d),C&&E&&C(E.status+" "+E.statusText,g)})),d},D.ThinEngine.prototype.createRawTexture2DArray=d(!1),D.ThinEngine.prototype.createRawTexture3D=d(!0),D.ThinEngine.prototype.updateRawTexture2DArray=I(!1),D.ThinEngine.prototype.updateRawTexture3D=I(!0);var y=g(12229);D.ThinEngine.prototype._readTexturePixelsSync=function(E,U,g){let N=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,L=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,D=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,S=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],u=arguments.length>7&&void 0!==arguments[7]&&arguments[7],s=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,C=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;const B=this._gl;if(!B)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){const E=B.createFramebuffer();if(!E)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=E}var P,F;(B.bindFramebuffer(B.FRAMEBUFFER,this._dummyFramebuffer),N>-1)?B.framebufferTexture2D(B.FRAMEBUFFER,B.COLOR_ATTACHMENT0,B.TEXTURE_CUBE_MAP_POSITIVE_X+N,null===(P=E._hardwareTexture)||void 0===P?void 0:P.underlyingResource,L):B.framebufferTexture2D(B.FRAMEBUFFER,B.COLOR_ATTACHMENT0,B.TEXTURE_2D,null===(F=E._hardwareTexture)||void 0===F?void 0:F.underlyingResource,L);let f=void 0!==E.type?this._getWebGLTextureType(E.type):B.UNSIGNED_BYTE;if(u)D||(D=(0,y.k)(E.type,4*U*g));else if(f===B.UNSIGNED_BYTE)D||(D=new Uint8Array(4*U*g)),f=B.UNSIGNED_BYTE;else D||(D=new Float32Array(4*U*g)),f=B.FLOAT;return S&&this.flushFramebuffer(),B.readPixels(s,C,U,g,B.RGBA,f,D),B.bindFramebuffer(B.FRAMEBUFFER,this._currentFramebuffer),D},D.ThinEngine.prototype._readTexturePixels=function(E,U,g){let N=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,L=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,D=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,S=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],u=arguments.length>7&&void 0!==arguments[7]&&arguments[7],s=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,C=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;return Promise.resolve(this._readTexturePixelsSync(E,U,g,N,L,D,S,u,s,C))};g(12511);D.ThinEngine.prototype._createDepthStencilCubeTexture=function(E,U){const g=new N.c(this,12);if(g.isCube=!0,1===this.webGLVersion)return B.d.Error("Depth cube texture is not supported by WebGL 1."),g;const L={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...U},D=this._gl;this._bindTextureDirectly(D.TEXTURE_CUBE_MAP,g,!0),this._setupDepthStencilTexture(g,E,L.bilinearFiltering,L.comparisonFunction);for(let N=0;N<6;N++)L.generateStencil?D.texImage2D(D.TEXTURE_CUBE_MAP_POSITIVE_X+N,0,D.DEPTH24_STENCIL8,E,E,0,D.DEPTH_STENCIL,D.UNSIGNED_INT_24_8,null):D.texImage2D(D.TEXTURE_CUBE_MAP_POSITIVE_X+N,0,D.DEPTH_COMPONENT24,E,E,0,D.DEPTH_COMPONENT,D.UNSIGNED_INT,null);return this._bindTextureDirectly(D.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(g),g},D.ThinEngine.prototype._setCubeMapTextureParams=function(E,U,g){const N=this._gl;N.texParameteri(N.TEXTURE_CUBE_MAP,N.TEXTURE_MAG_FILTER,N.LINEAR),N.texParameteri(N.TEXTURE_CUBE_MAP,N.TEXTURE_MIN_FILTER,U?N.LINEAR_MIPMAP_LINEAR:N.LINEAR),N.texParameteri(N.TEXTURE_CUBE_MAP,N.TEXTURE_WRAP_S,N.CLAMP_TO_EDGE),N.texParameteri(N.TEXTURE_CUBE_MAP,N.TEXTURE_WRAP_T,N.CLAMP_TO_EDGE),E.samplingMode=U?3:2,U&&this.getCaps().textureMaxLevel&&void 0!==g&&g>0&&(N.texParameteri(N.TEXTURE_CUBE_MAP,N.TEXTURE_MAX_LEVEL,g),E._maxLodLevel=g),this._bindTextureDirectly(N.TEXTURE_CUBE_MAP,null)},D.ThinEngine.prototype.createCubeTexture=function(E,U,g,N){let L=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,D=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,S=arguments.length>6?arguments[6]:void 0,u=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,s=arguments.length>8&&void 0!==arguments[8]&&arguments[8],C=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,P=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0,f=arguments.length>11&&void 0!==arguments[11]?arguments[11]:null,d=arguments.length>13&&void 0!==arguments[13]&&arguments[13],I=arguments.length>14&&void 0!==arguments[14]?arguments[14]:null;const y=this._gl;return this.createCubeTextureBase(E,U,g,!!N,L,D,S,u,s,C,P,f,(E=>this._bindTextureDirectly(y.TEXTURE_CUBE_MAP,E,!0)),((E,U)=>{const g=this.needPOTTextures?(0,F.f)(U[0].width,this._caps.maxCubemapTextureSize):U[0].width,D=g,u=[y.TEXTURE_CUBE_MAP_POSITIVE_X,y.TEXTURE_CUBE_MAP_POSITIVE_Y,y.TEXTURE_CUBE_MAP_POSITIVE_Z,y.TEXTURE_CUBE_MAP_NEGATIVE_X,y.TEXTURE_CUBE_MAP_NEGATIVE_Y,y.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(y.TEXTURE_CUBE_MAP,E,!0),this._unpackFlipY(!1);const s=S?this._getInternalFormat(S,E._useSRGBBuffer):E._useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:y.RGBA;let C=S?this._getInternalFormat(S):y.RGBA;E._useSRGBBuffer&&1===this.webGLVersion&&(C=s);for(let N=0;N<u.length;N++)if(U[N].width!==g||U[N].height!==D){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext)return void B.d.Warn("Cannot create canvas to resize texture.");this._workingCanvas.width=g,this._workingCanvas.height=D,this._workingContext.drawImage(U[N],0,0,U[N].width,U[N].height,0,0,g,D),y.texImage2D(u[N],0,s,C,y.UNSIGNED_BYTE,this._workingCanvas)}else y.texImage2D(u[N],0,s,C,y.UNSIGNED_BYTE,U[N]);N||y.generateMipmap(y.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(E,!N),E.width=g,E.height=D,E.isReady=!0,S&&(E.format=S),E.onLoadedObservable.notifyObservers(E),E.onLoadedObservable.clear(),L&&L()}),!!d,I)},D.ThinEngine.prototype.generateMipMapsForCubemap=function(E){let U=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(E.generateMipMaps){const g=this._gl;this._bindTextureDirectly(g.TEXTURE_CUBE_MAP,E,!0),g.generateMipmap(g.TEXTURE_CUBE_MAP),U&&this._bindTextureDirectly(g.TEXTURE_CUBE_MAP,null)}};g(12514);D.ThinEngine.prototype.setDepthStencilTexture=function(E,U,g,N){void 0!==E&&(U&&(this._boundUniforms[E]=U),g&&g.depthStencilTexture?this._setTexture(E,g,!1,!0,N):this._setTexture(E,null,void 0,void 0,N))},D.ThinEngine.prototype.createRenderTargetCubeTexture=function(E,U){const g=this._createHardwareRenderTargetWrapper(!1,!0,E),L={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,...U};L.generateStencilBuffer=L.generateDepthBuffer&&L.generateStencilBuffer,(1!==L.type||this._caps.textureFloatLinearFiltering)&&(2!==L.type||this._caps.textureHalfFloatLinearFiltering)||(L.samplingMode=1);const D=this._gl,S=new N.c(this,5);this._bindTextureDirectly(D.TEXTURE_CUBE_MAP,S,!0);const u=this._getSamplingParameters(L.samplingMode,L.generateMipMaps);1!==L.type||this._caps.textureFloat||(L.type=0,B.d.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),D.texParameteri(D.TEXTURE_CUBE_MAP,D.TEXTURE_MAG_FILTER,u.mag),D.texParameteri(D.TEXTURE_CUBE_MAP,D.TEXTURE_MIN_FILTER,u.min),D.texParameteri(D.TEXTURE_CUBE_MAP,D.TEXTURE_WRAP_S,D.CLAMP_TO_EDGE),D.texParameteri(D.TEXTURE_CUBE_MAP,D.TEXTURE_WRAP_T,D.CLAMP_TO_EDGE);for(let N=0;N<6;N++)D.texImage2D(D.TEXTURE_CUBE_MAP_POSITIVE_X+N,0,this._getRGBABufferInternalSizedFormat(L.type,L.format),E,E,0,this._getInternalFormat(L.format),this._getWebGLTextureType(L.type),null);const s=D.createFramebuffer();return this._bindUnboundFramebuffer(s),g._depthStencilBuffer=this._setupFramebufferDepthAttachments(L.generateStencilBuffer,L.generateDepthBuffer,E,E),L.generateMipMaps&&D.generateMipmap(D.TEXTURE_CUBE_MAP),this._bindTextureDirectly(D.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),g._framebuffer=s,g._generateDepthBuffer=L.generateDepthBuffer,g._generateStencilBuffer=L.generateStencilBuffer,S.width=E,S.height=E,S.isReady=!0,S.isCube=!0,S.samples=1,S.generateMipMaps=L.generateMipMaps,S.samplingMode=L.samplingMode,S.type=L.type,S.format=L.format,this._internalTexturesCache.push(S),g.setTextures(S),g};var h=g(12527),V=g(12355);D.ThinEngine.prototype.createPrefilteredCubeTexture=function(E,U,L,D){let S=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,u=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,s=arguments.length>6?arguments[6]:void 0,C=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,P=!(arguments.length>8&&void 0!==arguments[8])||arguments[8];return this.createCubeTexture(E,U,null,!1,(async E=>{if(!E)return void(S&&S(null));const u=E.texture;if(P?E.info.sphericalPolynomial&&(u._sphericalPolynomial=E.info.sphericalPolynomial):u._sphericalPolynomial=new h.f,u._source=9,this.getCaps().textureLOD)return void(S&&S(u));const s=this._gl,C=E.width;if(!C)return;const{DDSTools:F}=await g.e(29).then(g.bind(g,14819)),f=[];for(let g=0;g<3;g++){const S=1-g/2,P=D,d=Math.log2(C)*L+D,I=P+(d-P)*S,y=Math.round(Math.min(Math.max(I,0),d)),h=new N.c(this,2);if(h.type=u.type,h.format=u.format,h.width=Math.pow(2,Math.max(Math.log2(C)-y,0)),h.height=h.width,h.isCube=!0,h._cachedWrapU=0,h._cachedWrapV=0,this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,h,!0),h.samplingMode=2,s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),E.isDDS){const U=E.info,g=E.data;this._unpackFlipY(U.isCompressed),F.UploadDDSLevels(this,h,g,U,!0,6,y)}else B.d.Warn("DDS is the only prefiltered cube map supported so far.");this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,null);const e=new V.d(U);e._isCube=!0,e._texture=h,h.isReady=!0,f.push(e)}u._lodTextureHigh=f[2],u._lodTextureMid=f[1],u._lodTextureLow=f[0],S&&S(u)}),u,s,C,P,L,D)},D.ThinEngine.prototype.createUniformBuffer=function(E,U){const g=this._gl.createBuffer();if(!g)throw new Error("Unable to create uniform buffer");const N=new C.b(g);return this.bindUniformBuffer(N),E instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,E,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(E),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),N.references=1,N},D.ThinEngine.prototype.createDynamicUniformBuffer=function(E,U){const g=this._gl.createBuffer();if(!g)throw new Error("Unable to create dynamic uniform buffer");const N=new C.b(g);return this.bindUniformBuffer(N),E instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,E,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(E),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),N.references=1,N},D.ThinEngine.prototype.updateUniformBuffer=function(E,U,g,N){this.bindUniformBuffer(E),void 0===g&&(g=0),void 0===N?U instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,g,U):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,g,new Float32Array(U)):U instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,U.subarray(g,g+N)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(U).subarray(g,g+N)),this.bindUniformBuffer(null)},D.ThinEngine.prototype.bindUniformBuffer=function(E){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,E?E.underlyingResource:null)},D.ThinEngine.prototype.bindUniformBufferBase=function(E,U,g){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,U,E?E.underlyingResource:null)},D.ThinEngine.prototype.bindUniformBlock=function(E,U,g){const N=E.program,L=this._gl.getUniformBlockIndex(N,U);4294967295!==L&&this._gl.uniformBlockBinding(N,L,g)};var e=g(12183),x=g(12243);x.b.prototype.displayLoadingUI=function(){if(!(0,e.f)())return;const E=this.loadingScreen;E&&E.displayLoadingUI()},x.b.prototype.hideLoadingUI=function(){if(!(0,e.f)())return;const E=this._loadingScreen;E&&E.hideLoadingUI()},Object.defineProperty(x.b.prototype,"loadingScreen",{get:function(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=x.b.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen},set:function(E){this._loadingScreen=E},enumerable:!0,configurable:!0}),Object.defineProperty(x.b.prototype,"loadingUIText",{set:function(E){this.loadingScreen.loadingUIText=E},enumerable:!0,configurable:!0}),Object.defineProperty(x.b.prototype,"loadingUIBackgroundColor",{set:function(E){this.loadingScreen.loadingUIBackgroundColor=E},enumerable:!0,configurable:!0}),x.b.prototype.getInputElement=function(){return this._renderingCanvas},x.b.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null},x.b.prototype.getInputElementClientRect=function(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null},x.b.prototype.getAspectRatio=function(E){let U=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const g=E.viewport;return this.getRenderWidth(U)*g.width/(this.getRenderHeight(U)*g.height)},x.b.prototype.getScreenAspectRatio=function(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)},x.b.prototype._verifyPointerLock=function(){var E;null===(E=this._onPointerLockChange)||void 0===E||E.call(this)},x.b.prototype.setAlphaEquation=function(E){if(this._alphaEquation!==E){switch(E){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774)}this._alphaEquation=E}},x.b.prototype.getInputElement=function(){return this._renderingCanvas},x.b.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc},x.b.prototype.setDepthFunction=function(E){this._depthCullingState.depthFunc=E},x.b.prototype.setDepthFunctionToGreater=function(){this.setDepthFunction(516)},x.b.prototype.setDepthFunctionToGreaterOrEqual=function(){this.setDepthFunction(518)},x.b.prototype.setDepthFunctionToLess=function(){this.setDepthFunction(513)},x.b.prototype.setDepthFunctionToLessOrEqual=function(){this.setDepthFunction(515)},x.b.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask},x.b.prototype.setDepthWrite=function(E){this._depthCullingState.depthMask=E},x.b.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest},x.b.prototype.setStencilBuffer=function(E){this._stencilState.stencilTest=E},x.b.prototype.getStencilMask=function(){return this._stencilState.stencilMask},x.b.prototype.setStencilMask=function(E){this._stencilState.stencilMask=E},x.b.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc},x.b.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef},x.b.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask},x.b.prototype.setStencilFunction=function(E){this._stencilState.stencilFunc=E},x.b.prototype.setStencilFunctionReference=function(E){this._stencilState.stencilFuncRef=E},x.b.prototype.setStencilFunctionMask=function(E){this._stencilState.stencilFuncMask=E},x.b.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail},x.b.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail},x.b.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass},x.b.prototype.setStencilOperationFail=function(E){this._stencilState.stencilOpStencilFail=E},x.b.prototype.setStencilOperationDepthFail=function(E){this._stencilState.stencilOpDepthFail=E},x.b.prototype.setStencilOperationPass=function(E){this._stencilState.stencilOpStencilDepthPass=E},x.b.prototype.cacheStencilState=function(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()},x.b.prototype.restoreStencilState=function(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)},x.b.prototype.setAlphaConstants=function(E,U,g,N){this._alphaState.setAlphaBlendConstants(E,U,g,N)},x.b.prototype.getAlphaMode=function(){return this._alphaMode},x.b.prototype.getAlphaEquation=function(){return this._alphaEquation},x.b.prototype.getRenderPassNames=function(){return this._renderPassNames},x.b.prototype.getCurrentRenderPassName=function(){return this._renderPassNames[this.currentRenderPassId]},x.b.prototype.createRenderPassId=function(E){const U=++x.b._RenderPassIdCounter;return this._renderPassNames[U]=E??"NONAME",U},x.b.prototype.releaseRenderPassId=function(E){this._renderPassNames[E]=void 0;for(let U=0;U<this.scenes.length;++U){const g=this.scenes[U];for(let U=0;U<g.meshes.length;++U){const N=g.meshes[U];if(N.Wg)for(let U=0;U<N.Wg.length;++U){N.Wg[U]._removeDrawWrapper(E)}}}};g(12523);function l(E){if(E.requestPointerLock){const U=E.requestPointerLock();U instanceof Promise?U.then((()=>{E.focus()})).catch((()=>{})):E.focus()}}var Y=g(12551),t=g(12234);class G extends D.ThinEngine{static get NpmPackage(){return x.b.NpmPackage}static get Version(){return x.b.Version}static get Instances(){return L.b.Instances}static get LastCreatedEngine(){return L.b.LastCreatedEngine}static get LastCreatedScene(){return L.b.LastCreatedScene}static DefaultLoadingScreenFactory(E){return x.b.DefaultLoadingScreenFactory(E)}get _supportsHardwareTextureRescaling(){return!!G._RescalePostProcessFactory}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}get performanceMonitor(){return this._performanceMonitor}constructor(E,U,g){super(E,U,g,arguments.length>3&&void 0!==arguments[3]&&arguments[3]),this.customAnimationFrameRequester=null,this._performanceMonitor=new u,this._drawCalls=new Y.e,E&&(this._features.supportRenderPasses=!0,g=this._creationOptions)}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(E){super._sharedInit(E),function(E,U,g){E._onCanvasFocus=()=>{E.onCanvasFocusObservable.notifyObservers(E)},E._onCanvasBlur=()=>{E.onCanvasBlurObservable.notifyObservers(E)},E._onCanvasContextMenu=U=>{E.disableContextMenu&&U.preventDefault()},U.addEventListener("focus",E._onCanvasFocus),U.addEventListener("blur",E._onCanvasBlur),U.addEventListener("contextmenu",E._onCanvasContextMenu),E._onBlur=()=>{E.disablePerformanceMonitorInBackground&&E.performanceMonitor.disable(),E._windowIsBackground=!0},E._onFocus=()=>{E.disablePerformanceMonitorInBackground&&E.performanceMonitor.enable(),E._windowIsBackground=!1},E._onCanvasPointerOut=g=>{document.elementFromPoint(g.clientX,g.clientY)!==U&&E.onCanvasPointerOutObservable.notifyObservers(g)};const N=E.getHostWindow();N&&"function"===typeof N.addEventListener&&(N.addEventListener("blur",E._onBlur),N.addEventListener("focus",E._onFocus)),U.addEventListener("pointerout",E._onCanvasPointerOut),g.doNotHandleTouchAction||function(E){E&&E.setAttribute&&(E.setAttribute("touch-action","none"),E.style.touchAction="none",E.style.webkitTapHighlightColor="transparent")}(U),!x.b.audioEngine&&g.audioEngine&&x.b.AudioEngineFactory&&(x.b.audioEngine=x.b.AudioEngineFactory(E.getRenderingCanvas(),E.getAudioContext(),E.getAudioDestination())),(0,e.c)()&&(E._onFullscreenChange=()=>{E.isFullscreen=!!document.fullscreenElement,E.isFullscreen&&E._pointerLockRequested&&U&&l(U)},document.addEventListener("fullscreenchange",E._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",E._onFullscreenChange,!1),E._onPointerLockChange=()=>{E.isPointerLock=document.pointerLockElement===U},document.addEventListener("pointerlockchange",E._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",E._onPointerLockChange,!1)),E.enableOfflineSupport=void 0!==x.b.OfflineProviderFactory,E._deterministicLockstep=!!g.deterministicLockstep,E._lockstepMaxSteps=g.lockstepMaxSteps||0,E._timeStep=g.timeStep||1/60}(this,E,this._creationOptions)}resizeImageBitmap(E,U,g){return function(E,U,g,N){const L=E.createCanvas(g,N).getContext("2d");if(!L)throw new Error("Unable to get 2d context for resizeImageBitmap");return L.drawImage(U,0,0),L.getImageData(0,0,g,N).data}(this,E,U,g)}async _createImageBitmapFromSource(E,U){return await async function(E,U,g){return await new Promise(((N,L)=>{const D=new Image;D.onload=()=>{D.decode().then((()=>{E.createImageBitmap(D,g).then((E=>{N(E)}))}))},D.onerror=()=>{L(`Error loading image ${D.src}`)},D.src=U}))}(this,E,U)}switchFullscreen(E){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(E)}enterFullscreen(E){this.isFullscreen||(this._pointerLockRequested=E,this._renderingCanvas&&function(E){const U=E.requestFullscreen||E.webkitRequestFullscreen;U&&U.call(E)}(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&function(){const E=document;document.exitFullscreen?document.exitFullscreen():E.webkitCancelFullScreen&&E.webkitCancelFullScreen()}()}setDitheringState(E){E?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(E){E?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}setDirectViewport(E,U,g,N){const L=this._cachedViewport;return this._cachedViewport=null,this._viewport(E,U,g,N),L}scissorClear(E,U,g,N,L){this.enableScissor(E,U,g,N),this.clear(L,!0,!0,!0),this.disableScissor()}enableScissor(E,U,g,N){const L=this._gl;L.enable(L.SCISSOR_TEST),L.scissor(E,U,g,N)}disableScissor(){const E=this._gl;E.disable(E.SCISSOR_TEST)}async _loadFileAsync(E,U,g){return await new Promise(((N,L)=>{this._loadFile(E,(E=>{N(E)}),void 0,U,g,((E,U)=>{L(U)}))}))}getVertexShaderSource(E){const U=this._gl.getAttachedShaders(E);return U?this._gl.getShaderSource(U[0]):null}getFragmentShaderSource(E){const U=this._gl.getAttachedShaders(E);return U?this._gl.getShaderSource(U[1]):null}set framebufferDimensionsObject(E){this._framebufferDimensionsObject=E,this._framebufferDimensionsObject&&this.onResizeObservable.notifyObservers(this)}_rebuildBuffers(){for(const E of this.scenes)E.resetCachedMaterial(),E._rebuildGeometries();for(const E of this._virtualScenes)E.resetCachedMaterial(),E._rebuildGeometries();super._rebuildBuffers()}getFontOffset(E){return function(E){const U=document.createElement("span");U.textContent="Hg",U.style.font=E;const g=document.createElement("div");g.style.display="inline-block",g.style.width="1px",g.style.height="0px",g.style.verticalAlign="bottom";const N=document.createElement("div");N.style.whiteSpace="nowrap",N.appendChild(U),N.appendChild(g),document.body.appendChild(N);let L=0,D=0;try{D=g.getBoundingClientRect().top-U.getBoundingClientRect().top,g.style.verticalAlign="baseline",L=g.getBoundingClientRect().top-U.getBoundingClientRect().top}finally{document.body.removeChild(N)}return{ascent:L,height:D,descent:D-L}}(E)}_cancelFrame(){if(this.customAnimationFrameRequester){if(0!==this._frameHandler){this._frameHandler=0;const{cancelAnimationFrame:E}=this.customAnimationFrameRequester;E&&E(this.customAnimationFrameRequester.B)}}else super._cancelFrame()}_renderLoop(E){this._processFrame(E),this._activeRenderLoops.length>0&&0===this._frameHandler&&(this.customAnimationFrameRequester?(this.customAnimationFrameRequester.B=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.B):this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()))}enterPointerlock(){this._renderingCanvas&&l(this._renderingCanvas)}exitPointerlock(){document.exitPointerLock&&document.exitPointerLock()}dg(){this._measureFps(),super.dg()}_deletePipelineContext(E){const U=E;U&&U.program&&U.transformFeedback&&(this.deleteTransformFeedback(U.transformFeedback),U.transformFeedback=null),super._deletePipelineContext(E)}createShaderProgram(E,U,g,N,L){let D=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;L=L||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);const S=super.createShaderProgram(E,U,g,N,L,D);return this.onAfterShaderCompilationObservable.notifyObservers(this),S}_createShaderProgram(E,U,g,N){let L=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const D=N.createProgram();if(E.program=D,!D)throw new Error("Unable to create program");if(N.attachShader(D,U),N.attachShader(D,g),this.webGLVersion>1&&L){const U=this.createTransformFeedback();this.bindTransformFeedback(U),this.setTranformFeedbackVaryings(D,L),E.transformFeedback=U}return N.linkProgram(D),this.webGLVersion>1&&L&&this.bindTransformFeedback(null),E.context=N,E.vertexShader=U,E.fragmentShader=g,E.isParallelCompiled||this._finalizePipelineContext(E),D}_releaseTexture(E){super._releaseTexture(E)}_releaseRenderTargetWrapper(E){super._releaseRenderTargetWrapper(E);for(const U of this.scenes){for(const g of U.postProcesses)g._outputTexture===E&&(g._outputTexture=null);for(const g of U.cameras)for(const U of g._postProcesses)U&&U._outputTexture===E&&(U._outputTexture=null)}}_rescaleTexture(E,U,g,N,L){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);const D=this.createRenderTargetTexture({width:U.width,height:U.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});if(!this._rescalePostProcess&&G._RescalePostProcessFactory&&(this._rescalePostProcess=G._RescalePostProcessFactory(this)),this._rescalePostProcess){this._rescalePostProcess.externalTextureSamplerBinding=!0;const S=()=>{this._rescalePostProcess.onApply=function(U){U._bindTexture("textureSampler",E)};let S=g;S||(S=this.scenes[this.scenes.length-1]),S.postProcessManager.directRender([this._rescalePostProcess],D,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,U,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,N,0,0,U.width,U.height,0),this.unBindFramebuffer(D),D.dispose(),L&&L()},u=this._rescalePostProcess.getEffect();u?u.executeWhenCompiled(S):this._rescalePostProcess.onEffectCreatedObservable.addOnce((E=>{E.executeWhenCompiled(S)}))}}wrapWebGLTexture(E){let U=arguments.length>1&&void 0!==arguments[1]&&arguments[1],g=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3,L=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,D=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;const S=new P.e(E,this._gl),u=new N.c(this,0,!0);return u._hardwareTexture=S,u.baseWidth=L,u.baseHeight=D,u.width=L,u.height=D,u.isReady=!0,u.useMipMaps=U,this.updateTextureSamplingMode(g,u),u}_uploadImageToTexture(E,U){let g=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,N=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const L=this._gl,D=this._getWebGLTextureType(E.type),S=this._getInternalFormat(E.format),u=this._getRGBABufferInternalSizedFormat(E.type,S),s=E.isCube?L.TEXTURE_CUBE_MAP:L.TEXTURE_2D;this._bindTextureDirectly(s,E,!0),this._unpackFlipY(E.invertY);let C=L.TEXTURE_2D;E.isCube&&(C=L.TEXTURE_CUBE_MAP_POSITIVE_X+g),L.texImage2D(C,N,u,S,D,U),this._bindTextureDirectly(s,null,!0)}updateTextureComparisonFunction(E,U){if(1===this.webGLVersion)return void B.d.Error("WebGL 1 does not support texture comparison.");const g=this._gl;E.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,E,!0),0===U?(g.texParameteri(g.TEXTURE_CUBE_MAP,g.TEXTURE_COMPARE_FUNC,515),g.texParameteri(g.TEXTURE_CUBE_MAP,g.TEXTURE_COMPARE_MODE,g.NONE)):(g.texParameteri(g.TEXTURE_CUBE_MAP,g.TEXTURE_COMPARE_FUNC,U),g.texParameteri(g.TEXTURE_CUBE_MAP,g.TEXTURE_COMPARE_MODE,g.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,E,!0),0===U?(g.texParameteri(g.TEXTURE_2D,g.TEXTURE_COMPARE_FUNC,515),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_COMPARE_MODE,g.NONE)):(g.texParameteri(g.TEXTURE_2D,g.TEXTURE_COMPARE_FUNC,U),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_COMPARE_MODE,g.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),E._comparisonFunction=U}createInstancesBuffer(E){const U=this._gl.createBuffer();if(!U)throw new Error("Unable to create instance buffer");const g=new C.b(U);return g.aU=E,this.bindArrayBuffer(g),this._gl.bufferData(this._gl.ARRAY_BUFFER,E,this._gl.DYNAMIC_DRAW),g.references=1,g}deleteInstancesBuffer(E){this._gl.deleteBuffer(E)}async _clientWaitAsync(E){let U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,g=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;const N=this._gl;return await new Promise(((L,D)=>{(0,t.f)((()=>{const g=N.clientWaitSync(E,U,0);if(g==N.WAIT_FAILED)throw new Error("clientWaitSync failed");return g!=N.TIMEOUT_EXPIRED}),L,D,g)}))}_readPixelsAsync(E,U,g,N,L,D,S){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");const u=this._gl,s=u.createBuffer();u.bindBuffer(u.PIXEL_PACK_BUFFER,s),u.bufferData(u.PIXEL_PACK_BUFFER,S.byteLength,u.STREAM_READ),u.readPixels(E,U,g,N,L,D,0),u.bindBuffer(u.PIXEL_PACK_BUFFER,null);const C=u.fenceSync(u.SYNC_GPU_COMMANDS_COMPLETE,0);return C?(u.flush(),this._clientWaitAsync(C,0,10).then((()=>(u.deleteSync(C),u.bindBuffer(u.PIXEL_PACK_BUFFER,s),u.getBufferSubData(u.PIXEL_PACK_BUFFER,0,S),u.bindBuffer(u.PIXEL_PACK_BUFFER,null),u.deleteBuffer(s),S)))):null}dispose(){this.hideLoadingUI(),this._rescalePostProcess&&this._rescalePostProcess.dispose(),function(E,U){1===L.b.Instances.length&&x.b.audioEngine&&(x.b.audioEngine.dispose(),x.b.audioEngine=null);const g=E.getHostWindow();g&&"function"===typeof g.removeEventListener&&(g.removeEventListener("blur",E._onBlur),g.removeEventListener("focus",E._onFocus)),U&&(U.removeEventListener("focus",E._onCanvasFocus),U.removeEventListener("blur",E._onCanvasBlur),U.removeEventListener("pointerout",E._onCanvasPointerOut),U.removeEventListener("contextmenu",E._onCanvasContextMenu)),(0,e.c)()&&(document.removeEventListener("fullscreenchange",E._onFullscreenChange),document.removeEventListener("mozfullscreenchange",E._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",E._onFullscreenChange),document.removeEventListener("msfullscreenchange",E._onFullscreenChange),document.removeEventListener("pointerlockchange",E._onPointerLockChange),document.removeEventListener("mspointerlockchange",E._onPointerLockChange),document.removeEventListener("mozpointerlockchange",E._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",E._onPointerLockChange))}(this,this._renderingCanvas),super.dispose()}}G.ALPHA_DISABLE=0,G.ALPHA_ADD=1,G.ALPHA_COMBINE=2,G.ALPHA_SUBTRACT=3,G.ALPHA_MULTIPLY=4,G.ALPHA_MAXIMIZED=5,G.ALPHA_ONEONE=6,G.ALPHA_PREMULTIPLIED=7,G.ALPHA_PREMULTIPLIED_PORTERDUFF=8,G.ALPHA_INTERPOLATE=9,G.ALPHA_SCREENMODE=10,G.DELAYLOADSTATE_NONE=0,G.DELAYLOADSTATE_LOADED=1,G.DELAYLOADSTATE_LOADING=2,G.DELAYLOADSTATE_NOTLOADED=4,G.NEVER=512,G.ALWAYS=519,G.LESS=513,G.EQUAL=514,G.LEQUAL=515,G.GREATER=516,G.GEQUAL=518,G.NOTEQUAL=517,G.KEEP=7680,G.REPLACE=7681,G.INCR=7682,G.DECR=7683,G.INVERT=5386,G.INCR_WRAP=34055,G.DECR_WRAP=34056,G.TEXTURE_CLAMP_ADDRESSMODE=0,G.TEXTURE_WRAP_ADDRESSMODE=1,G.TEXTURE_MIRROR_ADDRESSMODE=2,G.TEXTUREFORMAT_ALPHA=0,G.TEXTUREFORMAT_LUMINANCE=1,G.TEXTUREFORMAT_LUMINANCE_ALPHA=2,G.TEXTUREFORMAT_RGB=4,G.TEXTUREFORMAT_RGBA=5,G.TEXTUREFORMAT_RED=6,G.TEXTUREFORMAT_R=6,G.TEXTUREFORMAT_R16_UNORM=33322,G.TEXTUREFORMAT_RG16_UNORM=33324,G.TEXTUREFORMAT_RGB16_UNORM=32852,G.TEXTUREFORMAT_RGBA16_UNORM=32859,G.TEXTUREFORMAT_R16_SNORM=36760,G.TEXTUREFORMAT_RG16_SNORM=36761,G.TEXTUREFORMAT_RGB16_SNORM=36762,G.TEXTUREFORMAT_RGBA16_SNORM=36763,G.TEXTUREFORMAT_RG=7,G.TEXTUREFORMAT_RED_INTEGER=8,G.TEXTUREFORMAT_R_INTEGER=8,G.TEXTUREFORMAT_RG_INTEGER=9,G.TEXTUREFORMAT_RGB_INTEGER=10,G.TEXTUREFORMAT_RGBA_INTEGER=11,G.TEXTURETYPE_UNSIGNED_BYTE=0,G.TEXTURETYPE_UNSIGNED_INT=0,G.TEXTURETYPE_FLOAT=1,G.TEXTURETYPE_HALF_FLOAT=2,G.TEXTURETYPE_BYTE=3,G.TEXTURETYPE_SHORT=4,G.TEXTURETYPE_UNSIGNED_SHORT=5,G.TEXTURETYPE_INT=6,G.TEXTURETYPE_UNSIGNED_INTEGER=7,G.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,G.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,G.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,G.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,G.TEXTURETYPE_UNSIGNED_INT_24_8=12,G.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,G.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,G.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,G.TEXTURE_NEAREST_SAMPLINGMODE=1,G.TEXTURE_BILINEAR_SAMPLINGMODE=2,G.TEXTURE_TRILINEAR_SAMPLINGMODE=3,G.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,G.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,G.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,G.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,G.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,G.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,G.TEXTURE_NEAREST_LINEAR=7,G.TEXTURE_NEAREST_NEAREST=1,G.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,G.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,G.TEXTURE_LINEAR_LINEAR=2,G.TEXTURE_LINEAR_NEAREST=12,G.TEXTURE_EXPLICIT_MODE=0,G.TEXTURE_SPHERICAL_MODE=1,G.TEXTURE_PLANAR_MODE=2,G.TEXTURE_CUBIC_MODE=3,G.TEXTURE_PROJECTION_MODE=4,G.TEXTURE_SKYBOX_MODE=5,G.TEXTURE_INVCUBIC_MODE=6,G.TEXTURE_EQUIRECTANGULAR_MODE=7,G.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,G.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,G.SCALEMODE_FLOOR=1,G.SCALEMODE_NEAREST=2,G.SCALEMODE_CEILING=3},12517:(E,U,g)=>{g.d(U,{e:()=>L});var N=g(12502);class L{get depthStencilTexture(){return this._depthStencilTexture}setDepthStencilTexture(E){(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&this._depthStencilTexture&&this._depthStencilTexture.dispose(),this._depthStencilTexture=E,this._generateDepthBuffer=this._generateStencilBuffer=this._depthStencilTextureWithStencil=!1,E&&(this._generateDepthBuffer=!0,this._generateStencilBuffer=this._depthStencilTextureWithStencil=(0,N.b)(E.format))}get depthStencilTextureWithStencil(){return this._depthStencilTextureWithStencil}get isCube(){return this._isCube}get isMulti(){return this._isMulti}get is2DArray(){return this.layers>0}get is3D(){return this.depth>0}get size(){return this.width}get width(){return this._size.width??this._size}get height(){return this._size.height??this._size}get layers(){return this._size.layers||0}get depth(){return this._size.depth||0}get texture(){var E;return(null===(E=this._textures)||void 0===E?void 0:E[0])??null}get textures(){return this._textures}get faceIndices(){return this._faceIndices}get layerIndices(){return this._layerIndices}getBaseArrayLayer(E){var U,g;if(!this._textures)return-1;const N=this._textures[E],L=(null===(U=this._layerIndices)||void 0===U?void 0:U[E])??0,D=(null===(g=this._faceIndices)||void 0===g?void 0:g[E])??0;return N.isCube?6*L+D:N.is3D?0:L}get samples(){return this._samples}setSamples(E){let U=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],g=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this.samples===E&&!g)return E;const N=this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,E,U):this._engine.updateRenderTargetTextureSampleCount(this,E);return this._samples=E,N}resolveMSAATextures(){this.isMulti?this._engine.resolveMultiFramebuffer(this):this._engine.resolveFramebuffer(this)}generateMipMaps(){this._engine._currentRenderTarget===this&&this._engine.unBindFramebuffer(this,!0),this.isMulti?this._engine.generateMipMapsMultiFramebuffer(this):this._engine.generateMipMapsFramebuffer(this)}constructor(E,U,g,N,L){this._textures=null,this._faceIndices=null,this._layerIndices=null,this._samples=1,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this.disableAutomaticMSAAResolve=!1,this.resolveMSAAColors=!0,this.resolveMSAADepth=!1,this.resolveMSAAStencil=!1,this._isMulti=E,this._isCube=U,this._size=g,this._engine=N,this._depthStencilTexture=null,this.label=L}setTextures(E){Array.isArray(E)?this._textures=E:this._textures=E?[E]:null}setTexture(E){let U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,g=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._textures||(this._textures=[]),this._textures[U]!==E&&(this._textures[U]&&g&&this._textures[U].dispose(),this._textures[U]=E)}setLayerAndFaceIndices(E,U){this._layerIndices=E,this._faceIndices=U}setLayerAndFaceIndex(){let E=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,U=arguments.length>1?arguments[1]:void 0,g=arguments.length>2?arguments[2]:void 0;this._layerIndices||(this._layerIndices=[]),this._faceIndices||(this._faceIndices=[]),void 0!==U&&U>=0&&(this._layerIndices[E]=U),void 0!==g&&g>=0&&(this._faceIndices[E]=g)}createDepthStencilTexture(){var E;let U=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,g=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],N=arguments.length>2&&void 0!==arguments[2]&&arguments[2],L=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,D=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14,S=arguments.length>5?arguments[5]:void 0;return null===(E=this._depthStencilTexture)||void 0===E||E.dispose(),this._depthStencilTextureWithStencil=N,this._depthStencilTextureLabel=S,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:g,comparisonFunction:U,generateStencil:N,isCube:this._isCube,samples:L,depthTextureFormat:D,label:S},this),this._depthStencilTexture}_shareDepth(E){this.shareDepth(E)}shareDepth(E){this._depthStencilTexture&&(E._depthStencilTexture&&E._depthStencilTexture.dispose(),E._depthStencilTexture=this._depthStencilTexture,E._depthStencilTextureWithStencil=this._depthStencilTextureWithStencil,this._depthStencilTexture.incrementReferences())}_swapAndDie(E){this.texture&&this.texture._swapAndDie(E),this._textures=null,this.dispose(!0)}_cloneRenderTargetWrapper(){let E=null;if(this._isMulti){const U=this.textures;if(U&&U.length>0){let g=!1,N=U.length,L=-1;const D=U[U.length-1]._source;14!==D&&12!==D||(g=!0,L=U[U.length-1].format,N--);const S=[],u=[],s=[],C=[],B=[],P=[],F=[],f={};for(let E=0;E<N;++E){const g=U[E];S.push(g.samplingMode),u.push(g.type),s.push(g.format);void 0!==f[g.uniqueId]?(C.push(-1),F.push(0)):(f[g.uniqueId]=E,g.is2DArray?(C.push(35866),F.push(g.depth)):g.isCube?(C.push(34067),F.push(0)):g.is3D?(C.push(32879),F.push(g.depth)):(C.push(3553),F.push(0))),this._faceIndices&&B.push(this._faceIndices[E]??0),this._layerIndices&&P.push(this._layerIndices[E]??0)}const d={samplingModes:S,generateMipMaps:U[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:g,depthTextureFormat:L,types:u,formats:s,textureCount:N,targetTypes:C,faceIndex:B,layerIndex:P,layerCounts:F,label:this.label},I={width:this.width,height:this.height,depth:this.depth};E=this._engine.createMultipleRenderTarget(I,d);for(let y=0;y<N;++y){if(-1!==C[y])continue;const g=f[U[y].uniqueId];E.setTexture(E.textures[g],y)}}}else{var U,g,N,L;const S={};if(S.generateDepthBuffer=this._generateDepthBuffer,S.generateMipMaps=(null===(U=this.texture)||void 0===U?void 0:U.generateMipMaps)??!1,S.generateStencilBuffer=this._generateStencilBuffer,S.samplingMode=null===(g=this.texture)||void 0===g?void 0:g.samplingMode,S.type=null===(N=this.texture)||void 0===N?void 0:N.type,S.format=null===(L=this.texture)||void 0===L?void 0:L.format,S.noColorAttachment=!this._textures,S.label=this.label,this.isCube)E=this._engine.createRenderTargetCubeTexture(this.width,S);else{var D;const U={width:this.width,height:this.height,layers:this.is2DArray||this.is3D?null===(D=this.texture)||void 0===D?void 0:D.depth:void 0};E=this._engine.createRenderTargetTexture(U,S)}E.texture&&(E.texture.isReady=!0)}return E}_swapRenderTargetWrapper(E){if(this._textures&&E._textures)for(let U=0;U<this._textures.length;++U)this._textures[U]._swapAndDie(E._textures[U],!1),E._textures[U].isReady=!0;this._depthStencilTexture&&E._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(E._depthStencilTexture),E._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null}_rebuild(){const E=this._cloneRenderTargetWrapper();if(E){if(this._depthStencilTexture){const U=this._depthStencilTexture.samplingMode,g=this._depthStencilTexture.format,N=2===U||3===U||11===U;E.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,N,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples,g,this._depthStencilTextureLabel)}this.samples>1&&E.setSamples(this.samples),E._swapRenderTargetWrapper(this),E.dispose()}}releaseTextures(){if(this._textures)for(let E=0;E<this._textures.length;++E)this._textures[E].dispose();this._textures=null}dispose(){var E;arguments.length>0&&void 0!==arguments[0]&&arguments[0]||(null===(E=this._depthStencilTexture)||void 0===E||E.dispose(),this._depthStencilTexture=null,this.releaseTextures());this._engine._releaseRenderTargetWrapper(this)}}},12471:(E,U,g)=>{g.r(U),g.d(U,{ThinEngine:()=>x});var N=g(12255),L=g(12478),D=g(12186),S=g(12183);class u{constructor(){this.shaderLanguage=0}postProcessor(E,U,g,N,L){if(L.drawBuffersExtensionDisabled){const U=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;E=E.replace(U,"")}return E}}const s=/(flat\s)?\s*varying\s*.*/;class C{constructor(){this.shaderLanguage=0}attributeProcessor(E){return E.replace("attribute","in")}varyingCheck(E,U){return s.test(E)}varyingProcessor(E,U){return E.replace("varying",U?"in":"out")}postProcessor(E,U,g){const N=-1!==E.search(/#extension.+GL_EXT_draw_buffers.+require/);if(E=(E=E.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),g){const U=-1!==E.search(/layout *\(location *= *0\) *out/g);E=(E=(E=(E=(E=(E=(E=E.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/void\s+?main\s*\(/g,(N||U?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(")}else{if(-1!==U.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+E}return E}}var B=g(12484),P=g(12300),F=g(12243),f=g(12493),d=g(12273),I=g(12247),y=g(12229),h=g(12253),V=g(12502);class e{}class x extends F.b{get name(){return this._name}set name(E){this._name=E}get version(){return this._webGLVersion}static get ShadersRepository(){return I.Effect.ShadersRepository}static set ShadersRepository(E){I.Effect.ShadersRepository=E}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(E){this._framebufferDimensionsObject=E}snapshotRenderingReset(){this.snapshotRendering=!1}constructor(E,U,g,L){if(g=g||{},super(U??g.antialias,g,L),this._name="WebGL",this.forcePOTTextures=!1,this.validateShaderPrograms=!1,this.disableUniformBuffers=!1,this._webGLVersion=1,this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},!E)return;let S=null;if(E.getContext){if(S=E,void 0===g.ag&&(g.ag=!1),void 0===g.xrCompatible&&(g.xrCompatible=!1),navigator&&navigator.userAgent){this._setupMobileChecks();const E=navigator.userAgent;for(const U of x.ExceptionList){const N=U.key,L=U.targets;if(new RegExp(N).test(E)){if(U.capture&&U.captureConstraint){const g=U.capture,N=U.captureConstraint,L=new RegExp(g).exec(E);if(L&&L.length>0){if(parseInt(L[L.length-1])>=N)continue}}for(const E of L)switch(E){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":g.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1}}}}if(this._doNotHandleContextLost?this._onContextLost=()=>{(0,N.A)(this._gl)}:(this._onContextLost=E=>{E.preventDefault(),this._contextWasLost=!0,(0,N.A)(this._gl),D.d.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost((()=>this._initGLContext()))},S.addEventListener("webglcontextrestored",this._onContextRestored,!1),g.powerPreference=g.powerPreference||"high-performance"),S.addEventListener("webglcontextlost",this._onContextLost,!1),this._badDesktopOS&&(g.xrCompatible=!1),!g.disableWebGL2Support)try{this._gl=S.getContext("webgl2",g)||S.getContext("experimental-webgl2",g),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch(P){}if(!this._gl){if(!S)throw new Error("The provided canvas is null or undefined.");try{this._gl=S.getContext("webgl",g)||S.getContext("experimental-webgl",g)}catch(P){throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=E,S=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const U=this._gl.getContextAttributes();U&&(g.Vg=U.Vg)}this._sharedInit(S),this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),void 0!==g.useHighPrecisionFloats&&(this._highPrecisionShadersAllowed=g.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let N=0;N<this._caps.maxVertexAttribs;N++)this._currentBufferPointers[N]=new e;this._shaderProcessor=this.webGLVersion>1?new C:new u;const s=`Babylon.js v${x.Version}`;D.d.Log(s+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",s);const B=(0,N.D)(this._gl);B.validateShaderPrograms=this.validateShaderPrograms,B.parallelShaderCompile=this._caps.parallelShaderCompile}_clearEmptyResources(){this._dummyFramebuffer=null,super._clearEmptyResources()}_getShaderProcessingContext(E){return null}areAllEffectsReady(){for(const E in this._compiledEffects){if(!this._compiledEffects[E].isReady())return!1}return!0}_initGLContext(){this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||null!==this._gl.getExtension("OES_standard_derivatives"),maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||null!==this._gl.getExtension("OES_element_index_uint"),fragmentDepthSupported:this._webGLVersion>1||null!==this._gl.getExtension("EXT_frag_depth"),highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,colorBufferHalfFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_half_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:1!==this._webGLVersion,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1,textureNorm16:!!this._gl.getExtension("EXT_texture_norm16")},this._caps.supportFloatTexturesResolve=this._caps.colorBufferFloat,this._caps.rg11b10ufColorRenderable=this._caps.colorBufferFloat,this._glVersion=this._gl.getParameter(this._gl.VERSION);const E=this._gl.getExtension("WEBGL_debug_renderer_info");if(null!=E&&(this._glRenderer=this._gl.getParameter(E.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(E.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),36193!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=36193),34842!==this._gl.RGBA16F&&(this._gl.RGBA16F=34842),34836!==this._gl.RGBA32F&&(this._gl.RGBA32F=34836),35056!==this._gl.DEPTH24_STENCIL8&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(1===this._webGLVersion&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=(this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)??0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!(!this._caps.textureFloat||!this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!(!this._caps.textureFloat||!this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.textureNorm16&&(this._gl.R16_EXT=33322,this._gl.RG16_EXT=33324,this._gl.RGB16_EXT=32852,this._gl.RGBA16_EXT=32859,this._gl.R16_SNORM_EXT=36760,this._gl.RG16_SNORM_EXT=36761,this._gl.RGB16_SNORM_EXT=36762,this._gl.RGBA16_SNORM_EXT=36763),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&5131!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=null!==this._maxMSAASamplesOverride?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES),this._caps.maxDrawBuffers=this._gl.getParameter(this._gl.MAX_DRAW_BUFFERS);else{const E=this._gl.getExtension("WEBGL_draw_buffers");if(null!==E){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=E.drawBuffersWEBGL.bind(E),this._caps.maxDrawBuffers=this._gl.getParameter(E.MAX_DRAW_BUFFERS_WEBGL),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let U=0;U<16;U++)this._gl["COLOR_ATTACHMENT"+U+"_WEBGL"]=E["COLOR_ATTACHMENT"+U+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{const E=this._gl.getExtension("WEBGL_depth_texture");null!=E&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=E.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{const E=this._gl.getExtension("OES_vertex_array_object");null!=E&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=E.createVertexArrayOES.bind(E),this._gl.bindVertexArray=E.bindVertexArrayOES.bind(E),this._gl.deleteVertexArray=E.deleteVertexArrayOES.bind(E))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{const E=this._gl.getExtension("ANGLE_instanced_arrays");null!=E?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=E.drawArraysInstancedANGLE.bind(E),this._gl.drawElementsInstanced=E.drawElementsInstancedANGLE.bind(E),this._gl.vertexAttribDivisor=E.vertexAttribDivisorANGLE.bind(E)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){const E=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),U=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);E&&U&&(this._caps.highPrecisionShaderSupported=0!==E.precision&&0!==U.precision)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{const E=this._gl.getExtension("EXT_blend_minmax");null!=E&&(this._caps.blendMinMax=!0,this._gl.MAX=E.MAX_EXT,this._gl.MIN=E.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:WebGL2RenderingContext.SRGB,SRGB8:WebGL2RenderingContext.SRGB8,SRGB8_ALPHA8:WebGL2RenderingContext.SRGB8_ALPHA8};else{const E=this._gl.getExtension("EXT_sRGB");null!=E&&(this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:E.SRGB_EXT,SRGB8:E.SRGB_ALPHA_EXT,SRGB8_ALPHA8:E.SRGB_ALPHA_EXT})}if(this._creationOptions){const E=this._creationOptions.forceSRGBBufferSupportState;void 0!==E&&(this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&E)}}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let U=0;U<this._maxSimultaneousTextures;U++)this._nextFreeTextureSlots.push(U);"Mali-G72"===this._glRenderer&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:"undefined"===typeof HTMLImageElement,supportRenderAndCopyToLodForFloatTextures:1!==this._webGLVersion,supportDepthStencilTexture:1!==this._webGLVersion,supportShadowSamplers:1!==this._webGLVersion,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:1!==this._webGLVersion,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:1!==this._webGLVersion,basisNeedsPOT:1===this._webGLVersion,support3DTextures:1!==this._webGLVersion,needTypeSuffixInShaderConstants:1!==this._webGLVersion,supportMSAA:1!==this._webGLVersion,supportSSAO2:1!==this._webGLVersion,supportIBLShadows:1!==this._webGLVersion,supportExtendedTextureFormats:1!==this._webGLVersion,supportSwitchCaseInShader:1!==this._webGLVersion,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,forceVertexBufferStrideAndOffsetMultiple4Bytes:!1,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const E=this._workingCanvas.getContext("2d");E&&(this._workingContext=E)}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}extractDriverInfo(){const E=this.getGlInfo();return E&&E.renderer?E.renderer:""}getRenderWidth(){return!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(){return!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}clear(E,U,g){let N=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const L=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=L;let D=0;if(U&&E){let U=!0;if(this._currentRenderTarget){var S;const g=null===(S=this._currentRenderTarget.texture)||void 0===S?void 0:S.format;if(8===g||9===g||10===g||11===g){var u;const g=null===(u=this._currentRenderTarget.texture)||void 0===u?void 0:u.type;7===g||5===g?(x._TempClearColorUint32[0]=255*E.r,x._TempClearColorUint32[1]=255*E.g,x._TempClearColorUint32[2]=255*E.b,x._TempClearColorUint32[3]=255*E.a,this._gl.clearBufferuiv(this._gl.COLOR,0,x._TempClearColorUint32),U=!1):(x._TempClearColorInt32[0]=255*E.r,x._TempClearColorInt32[1]=255*E.g,x._TempClearColorInt32[2]=255*E.b,x._TempClearColorInt32[3]=255*E.a,this._gl.clearBufferiv(this._gl.COLOR,0,x._TempClearColorInt32),U=!1)}}U&&(this._gl.clearColor(E.r,E.g,E.b,void 0!==E.a?E.a:1),D|=this._gl.COLOR_BUFFER_BIT)}g&&(this.Fg?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),D|=this._gl.DEPTH_BUFFER_BIT),N&&(this._gl.clearStencil(0),D|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(D)}_viewport(E,U,g,N){E===this._viewportCached.x&&U===this._viewportCached.y&&g===this._viewportCached.z&&N===this._viewportCached.w||(this._viewportCached.x=E,this._viewportCached.y=U,this._viewportCached.z=g,this._viewportCached.w=N,this._gl.viewport(E,U,g,N))}Ig(){super.Ig(),this._badOS&&this.flushFramebuffer()}get performanceMonitor(){throw new Error("Not Supported by ThinEngine")}bindFramebuffer(E){let U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,g=arguments.length>2?arguments[2]:void 0,N=arguments.length>3?arguments[3]:void 0,L=arguments.length>4?arguments[4]:void 0,S=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;const s=E;this._currentRenderTarget&&this._resolveAndGenerateMipMapsFramebuffer(this._currentRenderTarget),this._currentRenderTarget=E,this._bindUnboundFramebuffer(s._framebuffer);const C=this._gl;var B;if(!E.isMulti)if(E.is2DArray||E.is3D)C.framebufferTextureLayer(C.FRAMEBUFFER,C.COLOR_ATTACHMENT0,null===(B=E.texture._hardwareTexture)||void 0===B?void 0:B.underlyingResource,S,u),s._currentLOD=S;else if(E.isCube){var P;C.framebufferTexture2D(C.FRAMEBUFFER,C.COLOR_ATTACHMENT0,C.TEXTURE_CUBE_MAP_POSITIVE_X+U,null===(P=E.texture._hardwareTexture)||void 0===P?void 0:P.underlyingResource,S)}else if(s._currentLOD!==S){var F;C.framebufferTexture2D(C.FRAMEBUFFER,C.COLOR_ATTACHMENT0,C.TEXTURE_2D,null===(F=E.texture._hardwareTexture)||void 0===F?void 0:F.underlyingResource,S),s._currentLOD=S}const f=E._depthStencilTexture;if(f){E.is3D&&(E.texture.width===f.width&&E.texture.height===f.height&&E.texture.depth===f.depth||D.d.Warn("Depth/Stencil attachment for 3D target must have same dimensions as color attachment"));const g=E._depthStencilTextureWithStencil?C.DEPTH_STENCIL_ATTACHMENT:C.DEPTH_ATTACHMENT;var d;if(E.is2DArray||E.is3D)C.framebufferTextureLayer(C.FRAMEBUFFER,g,null===(d=f._hardwareTexture)||void 0===d?void 0:d.underlyingResource,S,u);else if(E.isCube){var I;C.framebufferTexture2D(C.FRAMEBUFFER,g,C.TEXTURE_CUBE_MAP_POSITIVE_X+U,null===(I=f._hardwareTexture)||void 0===I?void 0:I.underlyingResource,S)}else{var y;C.framebufferTexture2D(C.FRAMEBUFFER,g,C.TEXTURE_2D,null===(y=f._hardwareTexture)||void 0===y?void 0:y.underlyingResource,S)}}s._MSAAFramebuffer&&this._bindUnboundFramebuffer(s._MSAAFramebuffer),this._cachedViewport&&!L?this.setViewport(this._cachedViewport,g,N):(g||(g=E.width,S&&(g/=Math.pow(2,S))),N||(N=E.height,S&&(N/=Math.pow(2,S))),this._viewport(0,0,g,N)),this.wipeCaches()}setStateCullFaceType(E,U){const g=this.cullBackFaces??E??1?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==g||U)&&(this._depthCullingState.cullFace=g)}setState(E){let U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,g=arguments.length>2?arguments[2]:void 0,N=arguments.length>3&&void 0!==arguments[3]&&arguments[3],L=arguments.length>4?arguments[4]:void 0,D=arguments.length>5?arguments[5]:void 0,S=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;(this._depthCullingState.cull!==E||g)&&(this._depthCullingState.cull=E),this.setStateCullFaceType(L,g),this.setZOffset(U),this.setZOffsetUnits(S);const u=N?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==u||g)&&(this._depthCullingState.frontFace=u),this._stencilStateComposer.stencilMaterial=D}_resolveAndGenerateMipMapsFramebuffer(E){let U=arguments.length>1&&void 0!==arguments[1]&&arguments[1];E.disableAutomaticMSAAResolve||(E.isMulti?this.resolveMultiFramebuffer(E):this.resolveFramebuffer(E)),U||(E.isMulti?this.generateMipMapsMultiFramebuffer(E):this.generateMipMapsFramebuffer(E))}_bindUnboundFramebuffer(E){this._currentFramebuffer!==E&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,E),this._currentFramebuffer=E)}_currentFrameBufferIsDefaultFrameBuffer(){return null===this._currentFramebuffer}generateMipmaps(E){const U=this._getTextureTarget(E);this._bindTextureDirectly(U,E,!0),this._gl.generateMipmap(U),this._bindTextureDirectly(U,null)}unBindFramebuffer(E,U,g){const N=E;this._currentRenderTarget=null,this._resolveAndGenerateMipMapsFramebuffer(E,U),g&&(N._MSAAFramebuffer&&this._bindUnboundFramebuffer(N._framebuffer),g()),this._bindUnboundFramebuffer(null)}generateMipMapsFramebuffer(E){var U;E.isMulti||null===(U=E.texture)||void 0===U||!U.generateMipMaps||E.isCube||this.generateMipmaps(E.texture)}resolveFramebuffer(E){const U=E,g=this._gl;if(!U._MSAAFramebuffer||U.isMulti)return;let N=U.resolveMSAAColors?g.COLOR_BUFFER_BIT:0;N|=U._generateDepthBuffer&&U.resolveMSAADepth?g.DEPTH_BUFFER_BIT:0,N|=U._generateStencilBuffer&&U.resolveMSAAStencil?g.STENCIL_BUFFER_BIT:0,g.bindFramebuffer(g.READ_FRAMEBUFFER,U._MSAAFramebuffer),g.bindFramebuffer(g.DRAW_FRAMEBUFFER,U._framebuffer),g.blitFramebuffer(0,0,E.width,E.height,0,0,E.width,E.height,N,g.NEAREST)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(E,U,g){return this._createVertexBuffer(E,this._gl.STATIC_DRAW)}_createVertexBuffer(E,U){const g=this._gl.createBuffer();if(!g)throw new Error("Unable to create vertex buffer");const N=new B.b(g);return this.bindArrayBuffer(N),"number"!==typeof E?E instanceof Array?(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(E),U),N.aU=4*E.length):(this._gl.bufferData(this._gl.ARRAY_BUFFER,E,U),N.aU=E.byteLength):(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Uint8Array(E),U),N.aU=E),this._resetVertexBufferBinding(),N.references=1,N}createDynamicVertexBuffer(E,U){return this._createVertexBuffer(E,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(E,U,g){const N=this._gl.createBuffer(),L=new B.b(N);if(!N)throw new Error("Unable to create index buffer");this.bindIndexBuffer(L);const D=this._normalizeIndexData(E);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,D,U?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),L.references=1,L.is32Bits=4===D.BYTES_PER_ELEMENT,L}_normalizeIndexData(E){if(2===E.BYTES_PER_ELEMENT)return E;if(this._caps.uintIndices){if(E instanceof Uint32Array)return E;for(let U=0;U<E.length;U++)if(E[U]>=65535)return new Uint32Array(E);return new Uint16Array(E)}return new Uint16Array(E)}bindArrayBuffer(E){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(E,this._gl.ARRAY_BUFFER)}bindUniformBlock(E,U,g){const N=E.program,L=this._gl.getUniformBlockIndex(N,U);this._gl.uniformBlockBinding(N,L,g)}bindIndexBuffer(E){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(E,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(E,U){(this._vaoRecordInProgress||this._currentBoundBuffer[U]!==E)&&(this._gl.bindBuffer(U,E?E.underlyingResource:null),this._currentBoundBuffer[U]=E)}updateArrayBuffer(E){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,E)}_vertexAttribPointer(E,U,g,N,L,D,S){const u=this._currentBufferPointers[U];if(!u)return;let s=!1;u.active?(u.buffer!==E&&(u.buffer=E,s=!0),u.size!==g&&(u.size=g,s=!0),u.type!==N&&(u.type=N,s=!0),u.normalized!==L&&(u.normalized=L,s=!0),u.stride!==D&&(u.stride=D,s=!0),u.offset!==S&&(u.offset=S,s=!0)):(s=!0,u.active=!0,u.index=U,u.size=g,u.type=N,u.normalized=L,u.stride=D,u.offset=S,u.buffer=E),(s||this._vaoRecordInProgress)&&(this.bindArrayBuffer(E),N===this._gl.UNSIGNED_INT||N===this._gl.INT?this._gl.vertexAttribIPointer(U,g,N,D,S):this._gl.vertexAttribPointer(U,g,N,L,D,S))}_bindIndexBufferWithCache(E){null!=E&&this._cachedIndexBuffer!==E&&(this._cachedIndexBuffer=E,this.bindIndexBuffer(E),this._uintIndicesCurrentlySet=E.is32Bits)}_bindVertexBuffersAttributes(E,U,g){const N=U.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let L=0;L<N.length;L++){const D=U.getAttributeLocation(L);if(D>=0){const U=N[L];let S=null;if(g&&(S=g[U]),S||(S=E[U]),!S)continue;this._gl.enableVertexAttribArray(D),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[D]=!0);const u=S.getBuffer();u&&(this._vertexAttribPointer(u,D,S.getSize(),S.type,S.normalized,S.byteStride,S.byteOffset),S.getIsInstanced()&&(this._gl.vertexAttribDivisor(D,S.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(D),this._currentInstanceBuffers.push(u))))}}}recordVertexArrayObject(E,U,g,N){const L=this._gl.createVertexArray();if(!L)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(L),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(E,g,N),this.bindIndexBuffer(U),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),L}bindVertexArrayObject(E,U){this._cachedVertexArrayObject!==E&&(this._cachedVertexArrayObject=E,this._gl.bindVertexArray(E),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=null!=U&&U.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(E,U,g,N,L){if(this._cachedVertexBuffers!==E||this._cachedEffectForVertexBuffers!==L){this._cachedVertexBuffers=E,this._cachedEffectForVertexBuffers=L;const U=L.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let D=0;for(let S=0;S<U;S++)if(S<g.length){const U=L.getAttributeLocation(S);U>=0&&(this._gl.enableVertexAttribArray(U),this._vertexAttribArraysEnabled[U]=!0,this._vertexAttribPointer(E,U,g[S],this._gl.FLOAT,!1,N,D)),D+=4*g[S]}}this._bindIndexBufferWithCache(U)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(E,U,g,N){this._cachedVertexBuffers===E&&this._cachedEffectForVertexBuffers===g||(this._cachedVertexBuffers=E,this._cachedEffectForVertexBuffers=g,this._bindVertexBuffersAttributes(E,g,N)),this._bindIndexBufferWithCache(U)}unbindInstanceAttributes(){let E;for(let U=0,g=this._currentInstanceLocations.length;U<g;U++){const g=this._currentInstanceBuffers[U];E!=g&&g.references&&(E=g,this.bindArrayBuffer(g));const N=this._currentInstanceLocations[U];this._gl.vertexAttribDivisor(N,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(E){this._gl.deleteVertexArray(E)}_releaseBuffer(E){return E.references--,0===E.references&&(this._deleteBuffer(E),!0)}_deleteBuffer(E){this._gl.deleteBuffer(E.underlyingResource)}updateAndBindInstancesBuffer(E,U,g){if(this.bindArrayBuffer(E),U&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,U),void 0!==g[0].index)this.bindInstancesBuffer(E,g,!0);else for(let N=0;N<4;N++){const U=g[N];this._vertexAttribArraysEnabled[U]||(this._gl.enableVertexAttribArray(U),this._vertexAttribArraysEnabled[U]=!0),this._vertexAttribPointer(E,U,4,this._gl.FLOAT,!1,64,16*N),this._gl.vertexAttribDivisor(U,1),this._currentInstanceLocations.push(U),this._currentInstanceBuffers.push(E)}}bindInstancesBuffer(E,U){let g=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.bindArrayBuffer(E);let N=0;if(g)for(let L=0;L<U.length;L++){N+=4*U[L].attributeSize}for(let L=0;L<U.length;L++){const g=U[L];void 0===g.index&&(g.index=this._currentEffect.getAttributeLocationByName(g.attributeName)),g.index<0||(this._vertexAttribArraysEnabled[g.index]||(this._gl.enableVertexAttribArray(g.index),this._vertexAttribArraysEnabled[g.index]=!0),this._vertexAttribPointer(E,g.index,g.attributeSize,g.attributeType||this._gl.FLOAT,g.normalized||!1,N,g.offset),this._gl.vertexAttribDivisor(g.index,void 0===g.divisor?1:g.divisor),this._currentInstanceLocations.push(g.index),this._currentInstanceBuffers.push(E))}}disableInstanceAttributeByName(E){if(!this._currentEffect)return;const U=this._currentEffect.getAttributeLocationByName(E);this.disableInstanceAttribute(U)}disableInstanceAttribute(E){let U,g=!1;for(;-1!==(U=this._currentInstanceLocations.indexOf(E));)this._currentInstanceLocations.splice(U,1),this._currentInstanceBuffers.splice(U,1),g=!0,U=this._currentInstanceLocations.indexOf(E);g&&(this._gl.vertexAttribDivisor(E,0),this.disableAttributeByIndex(E))}disableAttributeByIndex(E){this._gl.disableVertexAttribArray(E),this._vertexAttribArraysEnabled[E]=!1,this._currentBufferPointers[E].active=!1}draw(E,U,g,N){this.drawElementsType(E?0:1,U,g,N)}drawPointClouds(E,U,g){this.drawArraysType(2,E,U,g)}drawUnIndexed(E,U,g,N){this.drawArraysType(E?0:1,U,g,N)}drawElementsType(E,U,g,N){this.applyStates(),this._reportDrawCall();const L=this._drawMode(E),D=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,S=this._uintIndicesCurrentlySet?4:2;N?this._gl.drawElementsInstanced(L,g,D,U*S,N):this._gl.drawElements(L,g,D,U*S)}drawArraysType(E,U,g,N){this.applyStates(),this._reportDrawCall();const L=this._drawMode(E);N?this._gl.drawArraysInstanced(L,U,g,N):this._gl.drawArrays(L,U,g)}_drawMode(E){switch(E){case 0:default:return this._gl.TRIANGLES;case 2:case 3:return this._gl.POINTS;case 1:case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN}}_releaseEffect(E){this._compiledEffects[E._key]&&delete this._compiledEffects[E._key];const U=E.getPipelineContext();U&&this._deletePipelineContext(U)}_deletePipelineContext(E){const U=E;U&&U.program&&(U.program.__SPECTOR_rebuildProgram=null,(0,h.i)(U),this._gl&&(this._currentProgram===U.program&&this._setProgram(null),this._gl.deleteProgram(U.program)))}_getGlobalDefines(E){return(0,y.g)(E,this.isNDCHalfZRange,this.Fg,this.useExactSrgbConversions)}createEffect(E,U,g,L,D,S,u,s,C){let B=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,P=arguments.length>10?arguments[10]:void 0;const F="string"===typeof E?E:E.vertexToken||E.vertexSource||E.vertexElement||E.vertex,f="string"===typeof E?E:E.fragmentToken||E.fragmentSource||E.fragmentElement||E.fragment,d=this._getGlobalDefines(),y=void 0!==U.attributes;let h=D??U.defines??"";d&&(h+=d);const V=F+"+"+f+"@"+h;if(this._compiledEffects[V]){const E=this._compiledEffects[V];return u&&E.isReady()&&u(E),E._refCount++,E}this._gl&&(0,N.D)(this._gl);const e=new I.Effect(E,U,y?this:g,L,this,D,S,u,s,C,V,U.shaderLanguage??B,U.extraInitializationsAsync??P);return this._compiledEffects[V]=e,e}_getShaderSource(E){return this._gl.getShaderSource(E)}createRawShaderProgram(E,U,g,L){let D=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const S=(0,N.D)(this._gl);return S._contextWasLost=this._contextWasLost,S.validateShaderPrograms=this.validateShaderPrograms,(0,N.s)(E,U,g,L||this._gl,D)}createShaderProgram(E,U,g,L,D){let S=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;const u=(0,N.D)(this._gl);return u._contextWasLost=this._contextWasLost,u.validateShaderPrograms=this.validateShaderPrograms,(0,N.w)(E,U,g,L,D||this._gl,S)}inlineShaderCode(E){return E}createPipelineContext(E){if(this._gl){(0,N.D)(this._gl).parallelShaderCompile=this._caps.parallelShaderCompile}const U=(0,N.p)(this._gl,E);return U.fU=this,U}createMaterialContext(){}createDrawContext(){}_finalizePipelineContext(E){return(0,N.g)(E,this._gl,this.validateShaderPrograms)}_preparePipelineContextAsync(E,U,g,L,D,S,u,s,C,B,P){const F=(0,N.D)(this._gl);return F._contextWasLost=this._contextWasLost,F.validateShaderPrograms=this.validateShaderPrograms,F._createShaderProgramInjection=this._createShaderProgram.bind(this),F.createRawShaderProgramInjection=this.createRawShaderProgram.bind(this),F.createShaderProgramInjection=this.createShaderProgram.bind(this),F.loadFileInjection=this._loadFile.bind(this),(0,N.l)(E,U,g,L,D,S,u,s,C,B,P)}_createShaderProgram(E,U,g,L){let D=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return(0,N.b)(E,U,g,L,D)}_isRenderingStateCompiled(E){return!this._isDisposed&&(0,N.h)(E,this._gl,this.validateShaderPrograms)}_executeWhenRenderingStateIsCompiled(E,U){(0,N.e)(E,U)}getUniforms(E,U){const g=new Array,N=E;for(let L=0;L<U.length;L++)g.push(this._gl.getUniformLocation(N.program,U[L]));return g}getAttributes(E,U){const g=[],N=E;for(let D=0;D<U.length;D++)try{g.push(this._gl.getAttribLocation(N.program,U[D]))}catch(L){g.push(-1)}return g}enableEffect(E){(E=null!==E&&(0,L.d)(E)?E.effect:E)&&E!==this._currentEffect&&(this._stencilStateComposer.stencilMaterial=void 0,this.bindSamplers(E),this._currentEffect=E,E.onBind&&E.onBind(E),E._onBindObservable&&E._onBindObservable.notifyObservers(E))}setInt(E,U){return!!E&&(this._gl.uniform1i(E,U),!0)}setInt2(E,U,g){return!!E&&(this._gl.uniform2i(E,U,g),!0)}setInt3(E,U,g,N){return!!E&&(this._gl.uniform3i(E,U,g,N),!0)}setInt4(E,U,g,N,L){return!!E&&(this._gl.uniform4i(E,U,g,N,L),!0)}setIntArray(E,U){return!!E&&(this._gl.uniform1iv(E,U),!0)}setIntArray2(E,U){return!(!E||U.length%2!==0)&&(this._gl.uniform2iv(E,U),!0)}setIntArray3(E,U){return!(!E||U.length%3!==0)&&(this._gl.uniform3iv(E,U),!0)}setIntArray4(E,U){return!(!E||U.length%4!==0)&&(this._gl.uniform4iv(E,U),!0)}setUInt(E,U){return!!E&&(this._gl.uniform1ui(E,U),!0)}setUInt2(E,U,g){return!!E&&(this._gl.uniform2ui(E,U,g),!0)}setUInt3(E,U,g,N){return!!E&&(this._gl.uniform3ui(E,U,g,N),!0)}setUInt4(E,U,g,N,L){return!!E&&(this._gl.uniform4ui(E,U,g,N,L),!0)}setUIntArray(E,U){return!!E&&(this._gl.uniform1uiv(E,U),!0)}setUIntArray2(E,U){return!(!E||U.length%2!==0)&&(this._gl.uniform2uiv(E,U),!0)}setUIntArray3(E,U){return!(!E||U.length%3!==0)&&(this._gl.uniform3uiv(E,U),!0)}setUIntArray4(E,U){return!(!E||U.length%4!==0)&&(this._gl.uniform4uiv(E,U),!0)}setArray(E,U){return!!E&&(!(U.length<1)&&(this._gl.uniform1fv(E,U),!0))}setArray2(E,U){return!(!E||U.length%2!==0)&&(this._gl.uniform2fv(E,U),!0)}setArray3(E,U){return!(!E||U.length%3!==0)&&(this._gl.uniform3fv(E,U),!0)}setArray4(E,U){return!(!E||U.length%4!==0)&&(this._gl.uniform4fv(E,U),!0)}setMatrices(E,U){return!!E&&(this._gl.uniformMatrix4fv(E,!1,U),!0)}setMatrix3x3(E,U){return!!E&&(this._gl.uniformMatrix3fv(E,!1,U),!0)}setMatrix2x2(E,U){return!!E&&(this._gl.uniformMatrix2fv(E,!1,U),!0)}setFloat(E,U){return!!E&&(this._gl.uniform1f(E,U),!0)}setFloat2(E,U,g){return!!E&&(this._gl.uniform2f(E,U,g),!0)}setFloat3(E,U,g,N){return!!E&&(this._gl.uniform3f(E,U,g,N),!0)}setFloat4(E,U,g,N,L){return!!E&&(this._gl.uniform4f(E,U,g,N,L),!0)}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;const E=this._colorWrite;this._gl.colorMask(E,E,E,E)}}wipeCaches(E){this.preventCacheWipeBetweenFrames&&!E||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),E&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(E,U){const g=this._gl;let N=g.NEAREST,L=g.NEAREST,D=!1;switch(E){case 11:N=g.LINEAR,L=U?g.LINEAR_MIPMAP_NEAREST:g.LINEAR;break;case 3:N=g.LINEAR,D=!0,L=U?g.LINEAR_MIPMAP_LINEAR:g.LINEAR;break;case 8:D=!0,N=g.NEAREST,L=U?g.NEAREST_MIPMAP_LINEAR:g.NEAREST;break;case 4:N=g.NEAREST,L=U?g.NEAREST_MIPMAP_NEAREST:g.NEAREST;break;case 5:N=g.NEAREST,L=U?g.LINEAR_MIPMAP_NEAREST:g.LINEAR;break;case 6:D=!0,N=g.NEAREST,L=U?g.LINEAR_MIPMAP_LINEAR:g.LINEAR;break;case 7:N=g.NEAREST,L=g.LINEAR;break;case 1:N=g.NEAREST,L=g.NEAREST;break;case 9:N=g.LINEAR,L=U?g.NEAREST_MIPMAP_NEAREST:g.NEAREST;break;case 10:D=!0,N=g.LINEAR,L=U?g.NEAREST_MIPMAP_LINEAR:g.NEAREST;break;case 2:N=g.LINEAR,L=g.LINEAR;break;case 12:N=g.LINEAR,L=g.NEAREST}return{min:L,mag:N,hasMipMaps:D}}_createTexture(){const E=this._gl.createTexture();if(!E)throw new Error("Unable to create texture");return E}_createHardwareTexture(){return new f.e(this._createTexture(),this._gl)}_createInternalTexture(E,U){let g,N=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,L=!1,S=!1,u=0,s=3,C=5,B=!1,P=1,F=!1,f=0;void 0!==U&&"object"===typeof U?(L=!!U.generateMipMaps,S=!!U.createMipMaps,u=void 0===U.type?0:U.type,s=void 0===U.samplingMode?3:U.samplingMode,C=void 0===U.format?5:U.format,B=void 0!==U.useSRGBBuffer&&U.useSRGBBuffer,P=U.samples??1,g=U.label,F=!!U.createMSAATexture,f=U.comparisonFunction||0):L=!!U,B&&(B=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(1!==u||this._caps.textureFloatLinearFiltering)&&(2!==u||this._caps.textureHalfFloatLinearFiltering)||(s=1),1!==u||this._caps.textureFloat||(u=0,D.d.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const I=(0,V.d)(C),y=(0,V.b)(C),h=this._gl,e=new d.c(this,N),x=E.width||E,l=E.height||E,Y=E.depth||0,t=E.layers||0,G=this._getSamplingParameters(s,(L||S)&&!I),b=0!==t?h.TEXTURE_2D_ARRAY:0!==Y?h.TEXTURE_3D:h.TEXTURE_2D,T=I?this._getInternalFormatFromDepthTextureFormat(C,!0,y):this._getRGBABufferInternalSizedFormat(u,C,B),v=I?y?h.DEPTH_STENCIL:h.DEPTH_COMPONENT:this._getInternalFormat(C),o=I?this._getWebGLTextureTypeFromDepthTextureFormat(C):this._getWebGLTextureType(u);if(this._bindTextureDirectly(b,e),0!==t?(e.is2DArray=!0,h.texImage3D(b,0,T,x,l,t,0,v,o,null)):0!==Y?(e.is3D=!0,h.texImage3D(b,0,T,x,l,Y,0,v,o,null)):h.texImage2D(b,0,T,x,l,0,v,o,null),h.texParameteri(b,h.TEXTURE_MAG_FILTER,G.mag),h.texParameteri(b,h.TEXTURE_MIN_FILTER,G.min),h.texParameteri(b,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(b,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),I&&this.webGLVersion>1&&(0===f?(h.texParameteri(b,h.TEXTURE_COMPARE_FUNC,515),h.texParameteri(b,h.TEXTURE_COMPARE_MODE,h.NONE)):(h.texParameteri(b,h.TEXTURE_COMPARE_FUNC,f),h.texParameteri(b,h.TEXTURE_COMPARE_MODE,h.COMPARE_REF_TO_TEXTURE))),(L||S)&&this._gl.generateMipmap(b),this._bindTextureDirectly(b,null),e._useSRGBBuffer=B,e.baseWidth=x,e.baseHeight=l,e.width=x,e.height=l,e.depth=t||Y,e.isReady=!0,e.samples=P,e.generateMipMaps=L,e.samplingMode=s,e.type=u,e.format=C,e.label=g,e.comparisonFunction=f,this._internalTexturesCache.push(e),F){let E=null;if(E=(0,V.d)(e.format)?this._setupFramebufferDepthAttachments((0,V.b)(e.format),19!==e.format,e.width,e.height,P,e.format,!0):this._createRenderBuffer(e.width,e.height,P,-1,this._getRGBABufferInternalSizedFormat(e.type,e.format,e._useSRGBBuffer),-1),!E)throw new Error("Unable to create render buffer");e._autoMSAAManagement=!0;let U=e._hardwareTexture;U||(U=e._hardwareTexture=this._createHardwareTexture()),U.addMSAARenderBuffer(E)}return e}_getUseSRGBBuffer(E,U){return E&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||U)}createTexture(E,U,g,N){var L=this;let D=arguments.length>4&&void 0!==arguments[4]?arguments[4]:3,S=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,C=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,B=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,P=arguments.length>10&&void 0!==arguments[10]?arguments[10]:null,F=arguments.length>11?arguments[11]:void 0,f=arguments.length>12?arguments[12]:void 0,I=arguments.length>13?arguments[13]:void 0,y=arguments.length>14?arguments[14]:void 0;return this._createTextureBase(E,U,g,N,D,S,u,(function(){for(var E=arguments.length,U=new Array(E),g=0;g<E;g++)U[g]=arguments[g];return L._prepareWebGLTexture(...U,B)}),((E,U,g,L,D,S)=>{const u=this._gl,s=g.width===E&&g.height===U;D._creationFlags=I??0;const C=this._getTexImageParametersForCreateTexture(D.format,D._useSRGBBuffer);if(s)return u.texImage2D(u.TEXTURE_2D,0,C.internalFormat,C.format,C.type,g),!1;const B=this._caps.maxTextureSize;if(g.width>B||g.height>B||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!(!this._workingCanvas||!this._workingContext)&&(this._workingCanvas.width=E,this._workingCanvas.height=U,this._workingContext.drawImage(g,0,0,g.width,g.height,0,0,E,U),u.texImage2D(u.TEXTURE_2D,0,C.internalFormat,C.format,C.type,this._workingCanvas),D.width=E,D.height=U,!1);{const E=new d.c(this,2);this._bindTextureDirectly(u.TEXTURE_2D,E,!0),u.texImage2D(u.TEXTURE_2D,0,C.internalFormat,C.format,C.type,g),this._rescaleTexture(E,D,N,C.format,(()=>{this._releaseTexture(E),this._bindTextureDirectly(u.TEXTURE_2D,D,!0),S()}))}return!0}),s,C,B,P,F,f,y)}_getTexImageParametersForCreateTexture(E,U){let g,N;return 1===this.webGLVersion?(g=this._getInternalFormat(E,U),N=g):(g=this._getInternalFormat(E,!1),N=this._getRGBABufferInternalSizedFormat(0,E,U)),{internalFormat:N,format:g,type:this._gl.UNSIGNED_BYTE}}_rescaleTexture(E,U,g,N,L){}_unpackFlipY(E){this._unpackFlipYCached!==E&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,E?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=E))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(E){return E.isCube?this._gl.TEXTURE_CUBE_MAP:E.is3D?this._gl.TEXTURE_3D:E.is2DArray||E.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(E,U){let g=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const N=this._getTextureTarget(U),L=this._getSamplingParameters(E,U.useMipMaps||g);this._setTextureParameterInteger(N,this._gl.TEXTURE_MAG_FILTER,L.mag,U),this._setTextureParameterInteger(N,this._gl.TEXTURE_MIN_FILTER,L.min),g&&L.hasMipMaps&&(U.generateMipMaps=!0,this._gl.generateMipmap(N)),this._bindTextureDirectly(N,null),U.samplingMode=E}updateTextureDimensions(E,U,g){}updateTextureWrappingMode(E,U){let g=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,N=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;const L=this._getTextureTarget(E);null!==U&&(this._setTextureParameterInteger(L,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(U),E),E._cachedWrapU=U),null!==g&&(this._setTextureParameterInteger(L,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(g),E),E._cachedWrapV=g),(E.is2DArray||E.is3D)&&null!==N&&(this._setTextureParameterInteger(L,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(N),E),E._cachedWrapR=N),this._bindTextureDirectly(L,null)}_uploadCompressedDataToTextureDirectly(E,U,g,N,L){let D=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,S=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;const u=this._gl;let s=u.TEXTURE_2D;if(E.isCube&&(s=u.TEXTURE_CUBE_MAP_POSITIVE_X+D),E._useSRGBBuffer)switch(U){case 37492:case 36196:this._caps.etc2?U=u.COMPRESSED_SRGB8_ETC2:E._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?U=u.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:E._useSRGBBuffer=!1;break;case 36492:U=u.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:U=u.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?U=u.COMPRESSED_SRGB_S3TC_DXT1_EXT:E._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?U=u.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:E._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?U=u.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:E._useSRGBBuffer=!1;break;default:E._useSRGBBuffer=!1}this._gl.compressedTexImage2D(s,S,U,g,N,0,L)}_uploadDataToTextureDirectly(E,U){let g=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,N=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,L=arguments.length>4?arguments[4]:void 0,D=arguments.length>5&&void 0!==arguments[5]&&arguments[5];const S=this._gl,u=this._getWebGLTextureType(E.type),s=this._getInternalFormat(E.format),C=void 0===L?this._getRGBABufferInternalSizedFormat(E.type,E.format,E._useSRGBBuffer):this._getInternalFormat(L,E._useSRGBBuffer);this._unpackFlipY(E.invertY);let B=S.TEXTURE_2D;E.isCube&&(B=S.TEXTURE_CUBE_MAP_POSITIVE_X+g);const P=Math.round(Math.log(E.width)*Math.LOG2E),F=Math.round(Math.log(E.height)*Math.LOG2E),f=D?E.width:Math.pow(2,Math.max(P-N,0)),d=D?E.height:Math.pow(2,Math.max(F-N,0));S.texImage2D(B,N,C,f,d,0,s,u,U)}updateTextureData(E,U,g,N,L,D){let S=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,u=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,s=arguments.length>8&&void 0!==arguments[8]&&arguments[8];const C=this._gl,B=this._getWebGLTextureType(E.type),P=this._getInternalFormat(E.format);this._unpackFlipY(E.invertY);let F=C.TEXTURE_2D,f=C.TEXTURE_2D;E.isCube&&(f=C.TEXTURE_CUBE_MAP_POSITIVE_X+S,F=C.TEXTURE_CUBE_MAP),this._bindTextureDirectly(F,E,!0),C.texSubImage2D(f,u,g,N,L,D,P,B,U),s&&this._gl.generateMipmap(f),this._bindTextureDirectly(F,null)}_uploadArrayBufferViewToTexture(E,U){let g=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,N=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const L=this._gl,D=E.isCube?L.TEXTURE_CUBE_MAP:L.TEXTURE_2D;this._bindTextureDirectly(D,E,!0),this._uploadDataToTextureDirectly(E,U,g,N),this._bindTextureDirectly(D,null,!0)}_prepareWebGLTextureContinuation(E,U,g,N,L){const D=this._gl;if(!D)return;const S=this._getSamplingParameters(L,!g);D.texParameteri(D.TEXTURE_2D,D.TEXTURE_MAG_FILTER,S.mag),D.texParameteri(D.TEXTURE_2D,D.TEXTURE_MIN_FILTER,S.min),g||N||D.generateMipmap(D.TEXTURE_2D),this._bindTextureDirectly(D.TEXTURE_2D,null),U&&U.removePendingData(E),E.onLoadedObservable.notifyObservers(E),E.onLoadedObservable.clear()}_prepareWebGLTexture(E,U,g,N,L,D,S,u,s,C){const B=this.getCaps().maxTextureSize,F=Math.min(B,this.needPOTTextures?(0,P.f)(N.width,B):N.width),f=Math.min(B,this.needPOTTextures?(0,P.f)(N.height,B):N.height),d=this._gl;d&&(E._hardwareTexture?(this._bindTextureDirectly(d.TEXTURE_2D,E,!0),this._unpackFlipY(void 0===L||!!L),E.baseWidth=N.width,E.baseHeight=N.height,E.width=F,E.height=f,E.isReady=!0,E.type=-1!==E.type?E.type:0,E.format=-1!==E.format?E.format:C??(".jpg"!==U||E._useSRGBBuffer?5:4),u(F,f,N,U,E,(()=>{this._prepareWebGLTextureContinuation(E,g,D,S,s)}))||this._prepareWebGLTextureContinuation(E,g,D,S,s)):g&&g.removePendingData(E))}_getInternalFormatFromDepthTextureFormat(E,U,g){const N=this._gl;if(!U)return N.STENCIL_INDEX8;let L=g?N.DEPTH_STENCIL:N.DEPTH_COMPONENT;return this.webGLVersion>1?15===E?L=N.DEPTH_COMPONENT16:16===E?L=N.DEPTH_COMPONENT24:17===E||13===E?L=g?N.DEPTH24_STENCIL8:N.DEPTH_COMPONENT24:14===E?L=N.DEPTH_COMPONENT32F:18===E&&(L=g?N.DEPTH32F_STENCIL8:N.DEPTH_COMPONENT32F):L=N.DEPTH_COMPONENT16,L}_getWebGLTextureTypeFromDepthTextureFormat(E){const U=this._gl;let g=U.UNSIGNED_INT;return 15===E?g=U.UNSIGNED_SHORT:17===E||13===E?g=U.UNSIGNED_INT_24_8:14===E?g=U.FLOAT:18===E?g=U.FLOAT_32_UNSIGNED_INT_24_8_REV:19===E&&(g=U.UNSIGNED_BYTE),g}_setupFramebufferDepthAttachments(E,U,g,N){let L=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,D=arguments.length>5?arguments[5]:void 0,S=arguments.length>6&&void 0!==arguments[6]&&arguments[6];const u=this._gl;D=D??(E?13:14);const s=this._getInternalFormatFromDepthTextureFormat(D,U,E);return E&&U?this._createRenderBuffer(g,N,L,u.DEPTH_STENCIL,s,S?-1:u.DEPTH_STENCIL_ATTACHMENT):U?this._createRenderBuffer(g,N,L,s,s,S?-1:u.DEPTH_ATTACHMENT):E?this._createRenderBuffer(g,N,L,s,s,S?-1:u.STENCIL_ATTACHMENT):null}_createRenderBuffer(E,U,g,N,L,D){let S=!(arguments.length>6&&void 0!==arguments[6])||arguments[6];const u=this._gl.createRenderbuffer();return this._updateRenderBuffer(u,E,U,g,N,L,D,S)}_updateRenderBuffer(E,U,g,N,L,D,S){let u=!(arguments.length>7&&void 0!==arguments[7])||arguments[7];const s=this._gl;return s.bindRenderbuffer(s.RENDERBUFFER,E),N>1&&s.renderbufferStorageMultisample?s.renderbufferStorageMultisample(s.RENDERBUFFER,N,D,U,g):s.renderbufferStorage(s.RENDERBUFFER,L,U,g),-1!==S&&s.framebufferRenderbuffer(s.FRAMEBUFFER,S,s.RENDERBUFFER,E),u&&s.bindRenderbuffer(s.RENDERBUFFER,null),E}_releaseTexture(E){this._deleteTexture(E._hardwareTexture),this.unbindAllTextures();const U=this._internalTexturesCache.indexOf(E);-1!==U&&this._internalTexturesCache.splice(U,1),E._lodTextureHigh&&E._lodTextureHigh.dispose(),E._lodTextureMid&&E._lodTextureMid.dispose(),E._lodTextureLow&&E._lodTextureLow.dispose(),E._irradianceTexture&&E._irradianceTexture.dispose()}_deleteTexture(E){null===E||void 0===E||E.release()}_setProgram(E){this._currentProgram!==E&&((0,N.m)(E,this._gl),this._currentProgram=E)}bindSamplers(E){const U=E.getPipelineContext();this._setProgram(U.program);const g=E.getSamplers();for(let N=0;N<g.length;N++){const U=E.getUniform(g[N]);U&&(this._boundUniforms[N]=U)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(E,U){let g=arguments.length>2&&void 0!==arguments[2]&&arguments[2],N=arguments.length>3&&void 0!==arguments[3]&&arguments[3],L=!1;const S=U&&U._associatedChannel>-1;g&&S&&(this._activeChannel=U._associatedChannel);if(this._boundTexturesCache[this._activeChannel]!==U||N){if(this._activateCurrentTexture(),U&&U.isMultiview)throw D.d.Error(["_bindTextureDirectly called with a multiview texture!",E,U]),"_bindTextureDirectly called with a multiview texture!";var u;this._gl.bindTexture(E,(null===U||void 0===U||null===(u=U._hardwareTexture)||void 0===u?void 0:u.underlyingResource)??null),this._boundTexturesCache[this._activeChannel]=U,U&&(U._associatedChannel=this._activeChannel)}else g&&(L=!0,this._activateCurrentTexture());return S&&!g&&this._bindSamplerUniformToChannel(U._associatedChannel,this._activeChannel),L}_bindTexture(E,U,g){if(void 0===E)return;U&&(U._associatedChannel=E),this._activeChannel=E;const N=U?this._getTextureTarget(U):this._gl.TEXTURE_2D;this._bindTextureDirectly(N,U)}unbindAllTextures(){for(let E=0;E<this._maxSimultaneousTextures;E++)this._activeChannel=E,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(E,U,g,N){void 0!==E&&(U&&(this._boundUniforms[E]=U),this._setTexture(E,g))}_bindSamplerUniformToChannel(E,U){const g=this._boundUniforms[E];g&&g._currentState!==U&&(this._gl.uniform1i(g,U),g._currentState=U)}_getTextureWrapMode(E){switch(E){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(E,U){let g,N=arguments.length>2&&void 0!==arguments[2]&&arguments[2],L=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!U)return null!=this._boundTexturesCache[E]&&(this._activeChannel=E,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(U.video){this._activeChannel=E;const g=U.getInternalTexture();g&&(g._associatedChannel=E),U.update()}else if(4===U.delayLoadState)return U.delayLoad(),!1;g=L?U.depthStencilTexture:U.isReady()?U.getInternalTexture():U.isCube?this.emptyCubeTexture:U.is3D?this.emptyTexture3D:U.is2DArray?this.emptyTexture2DArray:this.emptyTexture,!N&&g&&(g._associatedChannel=E);let D=!0;this._boundTexturesCache[E]===g&&(N||this._bindSamplerUniformToChannel(g._associatedChannel,E),D=!1),this._activeChannel=E;const S=this._getTextureTarget(g);if(D&&this._bindTextureDirectly(S,g,N),g&&!g.isMultiview){if(g.isCube&&g._cachedCoordinatesMode!==U.coordinatesMode){g._cachedCoordinatesMode=U.coordinatesMode;const E=3!==U.coordinatesMode&&5!==U.coordinatesMode?1:0;U.wrapU=E,U.wrapV=E}g._cachedWrapU!==U.wrapU&&(g._cachedWrapU=U.wrapU,this._setTextureParameterInteger(S,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(U.wrapU),g)),g._cachedWrapV!==U.wrapV&&(g._cachedWrapV=U.wrapV,this._setTextureParameterInteger(S,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(U.wrapV),g)),g.is3D&&g._cachedWrapR!==U.wrapR&&(g._cachedWrapR=U.wrapR,this._setTextureParameterInteger(S,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(U.wrapR),g)),this._setAnisotropicLevel(S,g,U.anisotropicFilteringLevel)}return!0}setTextureArray(E,U,g,N){if(void 0!==E&&U){this._textureUnits&&this._textureUnits.length===g.length||(this._textureUnits=new Int32Array(g.length));for(let U=0;U<g.length;U++){const N=g[U].getInternalTexture();N?(this._textureUnits[U]=E+U,N._associatedChannel=E+U):this._textureUnits[U]=-1}this._gl.uniform1iv(U,this._textureUnits);for(let E=0;E<g.length;E++)this._setTexture(this._textureUnits[E],g[E],!0)}}_setAnisotropicLevel(E,U,g){const N=this._caps.textureAnisotropicFilterExtension;11!==U.samplingMode&&3!==U.samplingMode&&2!==U.samplingMode&&(g=1),N&&U._cachedAnisotropicFilteringLevel!==g&&(this._setTextureParameterFloat(E,N.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(g,this._caps.maxAnisotropy),U),U._cachedAnisotropicFilteringLevel=g)}_setTextureParameterFloat(E,U,g,N){this._bindTextureDirectly(E,N,!0,!0),this._gl.texParameterf(E,U,g)}_setTextureParameterInteger(E,U,g,N){N&&this._bindTextureDirectly(E,N,!0,!0),this._gl.texParameteri(E,U,g)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let E=0;E<this._caps.maxVertexAttribs;E++)this.disableAttributeByIndex(E)}else for(let E=0,U=this._vertexAttribArraysEnabled.length;E<U;E++)E>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[E]||this.disableAttributeByIndex(E)}releaseEffects(){this._compiledEffects={},this.onReleaseEffectsObservable.notifyObservers(this)}dispose(){var E;((0,S.f)()&&this._renderingCanvas&&(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._onContextRestored&&this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),super.dispose(),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.unbindAllAttributes(),this._boundUniforms={},this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._currentProgram=null,this._creationOptions.loseContextOnDispose)&&(null===(E=this._gl.getExtension("WEBGL_lose_context"))||void 0===E||E.loseContext());(0,N.A)(this._gl)}attachContextLostEvent(E){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",E,!1)}attachContextRestoredEvent(E){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",E,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(E){const U=this._gl;for(;U.getError()!==U.NO_ERROR;);let g=!0;const N=U.createTexture();U.bindTexture(U.TEXTURE_2D,N),U.texImage2D(U.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(E),1,1,0,U.RGBA,this._getWebGLTextureType(E),null),U.texParameteri(U.TEXTURE_2D,U.TEXTURE_MIN_FILTER,U.NEAREST),U.texParameteri(U.TEXTURE_2D,U.TEXTURE_MAG_FILTER,U.NEAREST);const L=U.createFramebuffer();U.bindFramebuffer(U.FRAMEBUFFER,L),U.framebufferTexture2D(U.FRAMEBUFFER,U.COLOR_ATTACHMENT0,U.TEXTURE_2D,N,0);const D=U.checkFramebufferStatus(U.FRAMEBUFFER);if(g=g&&D===U.FRAMEBUFFER_COMPLETE,g=g&&U.getError()===U.NO_ERROR,g&&(U.clear(U.COLOR_BUFFER_BIT),g=g&&U.getError()===U.NO_ERROR),g){U.bindFramebuffer(U.FRAMEBUFFER,null);const E=U.RGBA,N=U.UNSIGNED_BYTE,L=new Uint8Array(4);U.readPixels(0,0,1,1,E,N,L),g=g&&U.getError()===U.NO_ERROR}for(U.deleteTexture(N),U.deleteFramebuffer(L),U.bindFramebuffer(U.FRAMEBUFFER,null);!g&&U.getError()!==U.NO_ERROR;);return g}_getWebGLTextureType(E){if(1===this._webGLVersion){switch(E){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(E){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(E){let U=arguments.length>1&&void 0!==arguments[1]&&arguments[1],g=U?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;switch(E){case 0:g=this._gl.ALPHA;break;case 1:g=this._gl.LUMINANCE;break;case 2:g=this._gl.LUMINANCE_ALPHA;break;case 6:case 33322:case 36760:g=this._gl.RED;break;case 7:case 33324:case 36761:g=this._gl.RG;break;case 4:case 32852:case 36762:g=U?this._glSRGBExtensionValues.SRGB:this._gl.RGB;break;case 5:case 32859:case 36763:g=U?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA}if(this._webGLVersion>1)switch(E){case 8:g=this._gl.RED_INTEGER;break;case 9:g=this._gl.RG_INTEGER;break;case 10:g=this._gl.RGB_INTEGER;break;case 11:g=this._gl.RGBA_INTEGER}return g}_getRGBABufferInternalSizedFormat(E,U){let g=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(1===this._webGLVersion){if(void 0!==U)switch(U){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return g?this._glSRGBExtensionValues.SRGB:this._gl.RGB}return this._gl.RGBA}switch(E){case 3:switch(U){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(U){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return g?this._glSRGBExtensionValues.SRGB8:this._gl.RGB8;case 5:return g?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(U){case 8:return this._gl.R16I;case 36760:return this._gl.R16_SNORM_EXT;case 36761:return this._gl.RG16_SNORM_EXT;case 36762:return this._gl.RGB16_SNORM_EXT;case 36763:return this._gl.RGBA16_SNORM_EXT;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;default:return this._gl.RGBA16I}case 5:switch(U){case 8:return this._gl.R16UI;case 33322:return this._gl.R16_EXT;case 33324:return this._gl.RG16_EXT;case 32852:return this._gl.RGB16_EXT;case 32859:return this._gl.RGBA16_EXT;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;default:return this._gl.RGBA16UI}case 6:switch(U){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;default:return this._gl.RGBA32I}case 7:switch(U){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;default:return this._gl.RGBA32UI}case 1:switch(U){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;default:return this._gl.RGBA32F}case 2:switch(U){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(U){case 5:default:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI}}return g?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8}readPixels(E,U,g,N){let L=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],S=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;const s=L?4:3,C=L?this._gl.RGBA:this._gl.RGB,B=g*N*s;if(u){if(u.length<B)return D.d.Error(`Data buffer is too small to store the read pixels (${u.length} should be more than ${B})`),Promise.resolve(u)}else u=new Uint8Array(B);return S&&this.flushFramebuffer(),this._gl.readPixels(E,U,g,N,C,this._gl.UNSIGNED_BYTE,u),Promise.resolve(u)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(null!==this._HasMajorPerformanceCaveat)return!this._HasMajorPerformanceCaveat;if(null===this._IsSupported)try{const E=F.b._CreateCanvas(1,1),U=E.getContext("webgl")||E.getContext("experimental-webgl");this._IsSupported=null!=U&&!!window.WebGLRenderingContext}catch(E){this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(null===this._HasMajorPerformanceCaveat)try{const E=F.b._CreateCanvas(1,1),U=E.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||E.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!U}catch(E){this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}}x._TempClearColorUint32=new Uint32Array(4),x._TempClearColorInt32=new Int32Array(4),x.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/12\\d\\..+?Mobile",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}],x._ConcatenateShader=y.c,x._IsSupported=null,x._HasMajorPerformanceCaveat=null},12396:(E,U,g)=>{g.d(U,{c:()=>f});var N=g(12174),L=g(12334),D=g(12311),S=g(12399),u=g(12300),s=g(12247),C=g(12186),B=g(12420),P=g(12345);class F{get renderList(){return this._renderList}set renderList(E){this._renderList!==E&&(this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),E&&(this._unObserveRenderList=(0,P.g)(E,this._renderListHasChanged)),this._renderList=E)}get disableImageProcessing(){return this._disableImageProcessing}set disableImageProcessing(E){E!==this._disableImageProcessing&&(this._disableImageProcessing=E,this._scene.markAllMaterialsAsDirty(64))}get name(){return this._name}set name(E){if(this._name===E)return;if(this._name=E,!this._scene)return;const U=this._scene.getEngine();for(let g=0;g<this._renderPassIds.length;++g){const E=this._renderPassIds[g];U._renderPassNames[E]=`${this._name}#${g}`}}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}setMaterialForRendering(E,U){let g;g=Array.isArray(E)?E:[E];for(let N=0;N<g.length;++N)for(let E=0;E<this.options.numPasses;++E){let L=g[N];g[N].isAnInstance&&(L=g[N].sourceMesh),L.setMaterialForRenderPass(this._renderPassIds[E],void 0!==U?Array.isArray(U)?U[E]:U:void 0)}}constructor(E,U,g){this._unObserveRenderList=null,this._renderListHasChanged=(E,U)=>{const g=this._renderList?this._renderList.length:0;if(0===U&&g>0||0===g)for(const N of this._scene.meshes)N._markSubMeshesAsLightDirty()},this.particleSystemList=null,this.getCustomRenderList=null,this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this._disableImageProcessing=!1,this.onBeforeRenderObservable=new N.b,this.onAfterRenderObservable=new N.b,this.onBeforeRenderingManagerRenderObservable=new N.b,this.onAfterRenderingManagerRenderObservable=new N.b,this.onFastPathRenderObservable=new N.b,this._currentRefreshId=-1,this._refreshRate=1,this._currentApplyByPostProcessSetting=!1,this._currentSceneCamera=null,this.name=E,this._scene=U,this.renderList=[],this._renderPassIds=[],this.options={numPasses:1,doNotChangeAspectRatio:!0,...g},this._createRenderPassId(),this.renderPassId=this._renderPassIds[0],this._renderingManager=new B.d(U),this._renderingManager._useSceneAutoClearSetup=!0}_releaseRenderPassId(){const E=this._scene.getEngine();for(let U=0;U<this.options.numPasses;++U)E.releaseRenderPassId(this._renderPassIds[U]);this._renderPassIds.length=0}_createRenderPassId(){this._releaseRenderPassId();const E=this._scene.getEngine();for(let U=0;U<this.options.numPasses;++U)this._renderPassIds[U]=E.createRenderPassId(`${this.name}#${U}`)}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(E){this._refreshRate=E,this.resetRefreshCounter()}shouldRender(){return-1===this._currentRefreshId||this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}isReadyForRendering(E,U){this.prepareRenderList(),this.initRender(E,U);const g=this._checkReadiness();return this.finishRender(),g}prepareRenderList(){const E=this._scene;if(this._waitingRenderList){if(!this.renderListPredicate){this.renderList=[];for(let U=0;U<this._waitingRenderList.length;U++){const g=this._waitingRenderList[U],N=E.getMeshById(g);N&&this.renderList.push(N)}}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const E=this._scene.meshes;for(let U=0;U<E.length;U++){const g=E[U];this.renderListPredicate(g)&&this.renderList.push(g)}}this._currentApplyByPostProcessSetting=this._scene.imageProcessingConfiguration.applyByPostProcess,this._disableImageProcessing&&(this._scene.imageProcessingConfiguration._applyByPostProcess=this._disableImageProcessing)}initRender(E,U){const g=this._scene.getEngine(),N=this.activeCamera??this._scene.activeCamera;this._currentSceneCamera=this._scene.activeCamera,N&&(N!==this._scene.activeCamera&&(this._scene.setTransformMatrix(N.getViewMatrix(),N.getProjectionMatrix(!0)),this._scene.activeCamera=N),g.setViewport(N.rigParent?N.rigParent.viewport:N.viewport,E,U)),this._defaultRenderListPrepared=!1}finishRender(){const E=this._scene;this._disableImageProcessing&&(E.imageProcessingConfiguration._applyByPostProcess=this._currentApplyByPostProcessSetting),E.activeCamera=this._currentSceneCamera,this._currentSceneCamera&&(this.activeCamera&&this.activeCamera!==E.activeCamera&&E.setTransformMatrix(this._currentSceneCamera.getViewMatrix(),this._currentSceneCamera.getProjectionMatrix(!0)),E.getEngine().setViewport(this._currentSceneCamera.viewport)),E.resetCachedMaterial()}render(){let E=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,U=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const g=this._scene,N=g.getEngine(),L=N.currentRenderPassId;N.currentRenderPassId=this._renderPassIds[E],this.onBeforeRenderObservable.notifyObservers(E);if(N.snapshotRendering&&1===N.snapshotRenderingMode)this.onFastPathRenderObservable.notifyObservers(E);else{let U=null;const N=this.renderList?this.renderList:g.getActiveMeshes().data,L=this.renderList?this.renderList.length:g.getActiveMeshes().length;this.getCustomRenderList&&(U=this.getCustomRenderList(E,N,L)),U?this._prepareRenderingManager(U,U.length,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(N,L,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),U=N),this.onBeforeRenderingManagerRenderObservable.notifyObservers(E),this._renderingManager.render(this.customRenderFunction,U,this.renderParticles,this.renderSprites),this.onAfterRenderingManagerRenderObservable.notifyObservers(E)}U||this.onAfterRenderObservable.notifyObservers(E),N.currentRenderPassId=L}_checkReadiness(){const E=this._scene,U=E.getEngine(),g=U.currentRenderPassId;let N=!0;E.getViewMatrix()||E.updateTransformMatrix();const L=this.options.numPasses;for(let S=0;S<L&&N;S++){let g=null;const D=this.renderList?this.renderList:E.getActiveMeshes().data,u=this.renderList?this.renderList.length:E.getActiveMeshes().length;U.currentRenderPassId=this._renderPassIds[S],this.onBeforeRenderObservable.notifyObservers(S),this.getCustomRenderList&&(g=this.getCustomRenderList(S,D,u)),g||(g=D),this.options.doNotChangeAspectRatio||E.updateTransformMatrix(!0);for(let E=0;E<g.length&&N;++E){const U=g[E];if(U.isEnabled()&&!U.isBlocked&&U.isVisible&&U.Wg)if(this.customIsReadyFunction){if(!this.customIsReadyFunction(U,this.refreshRate,!0)){N=!1;continue}}else if(!U.isReady(!0)){N=!1;continue}}this.onAfterRenderObservable.notifyObservers(S),L>1&&(E.incrementRenderId(),E.resetCachedMaterial())}const D=this.particleSystemList||E.RP;for(const S of D)S.isReady()||(N=!1);return U.currentRenderPassId=g,N}_prepareRenderingManager(E,U,g){const N=this._scene,L=N.activeCamera,D=this.cameraForLOD??L;this._renderingManager.reset();const S=N.getRenderId(),u=N.getFrameId();for(let C=0;C<U;C++){const U=E[C];if(U&&!U.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(U,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!U.isReady(0===this.refreshRate)){this.resetRefreshCounter();continue}let E,s=null;if(D){const E=U._internalAbstractMeshDataInfo._currentLOD.get(D);E&&E[1]===u?s=E[0]:(s=N.customLODSelector?N.customLODSelector(U,D):U.getLOD(D),E?(E[0]=s,E[1]=u):U._internalAbstractMeshDataInfo._currentLOD.set(D,[s,u]))}else s=U;if(!s)continue;if(s!==U&&0!==s.billboardMode&&s.pg(),s._preActivateForIntermediateRendering(S),E=!(!g||!L)&&0===(U.layerMask&L.layerMask),U.isEnabled()&&U.isVisible&&U.Wg&&!E){if(s!==U&&s._activate(S,!0),U._activate(S,!0)&&U.Wg.length){U.isAnInstance?U._internalAbstractMeshDataInfo._actAsRegularMesh&&(s=U):s._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,s._internalAbstractMeshDataInfo._isActiveIntermediate=!0,N._prepareSkeleton(s);for(let E=0;E<s.Wg.length;E++){const U=s.Wg[E];this._renderingManager.dispatch(U,s)}}U._postActivate()}}}const s=this.particleSystemList||N.RP;for(let C=0;C<s.length;C++){const E=s[C],U=E.NU;E.isStarted()&&U&&(!U.position||U.isEnabled())&&this._renderingManager.dispatchParticles(E)}}setRenderingOrder(E){let U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,g=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,N=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this._renderingManager.setRenderingOrder(E,U,g,N)}setRenderingAutoClearDepthStencil(E,U){let g=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],N=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];this._renderingManager.setRenderingAutoClearDepthStencil(E,U,g,N),this._renderingManager._useSceneAutoClearSetup=!1}clone(){const E=new F(this.name,this._scene,this.options);return this.renderList&&(E.renderList=this.renderList.slice(0)),E}dispose(){const E=this.renderList?this.renderList:this._scene.getActiveMeshes().data,U=this.renderList?this.renderList.length:this._scene.getActiveMeshes().length;for(let g=0;g<U;g++){const U=E[g];U&&void 0!==U.getMaterialForRenderPass(this.renderPassId)&&U.setMaterialForRenderPass(this.renderPassId,void 0)}this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderingManagerRenderObservable.clear(),this.onAfterRenderingManagerRenderObservable.clear(),this.onFastPathRenderObservable.clear(),this._releaseRenderPassId(),this.renderList=null}_rebuild(){this.refreshRate===F.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=F.REFRESHRATE_RENDER_ONCE)}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}}F.REFRESHRATE_RENDER_ONCE=0,F.REFRESHRATE_RENDER_ONEVERYFRAME=1,F.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,s.Effect.prototype.setDepthStencilTexture=function(E,U){this._engine.setDepthStencilTexture(this._samplers[E],this._uniforms[E],U,E)};class f extends D.c{get renderListPredicate(){return this._objectRenderer.renderListPredicate}set renderListPredicate(E){this._objectRenderer.renderListPredicate=E}get renderList(){return this._objectRenderer.renderList}set renderList(E){this._objectRenderer.renderList=E}get particleSystemList(){return this._objectRenderer.particleSystemList}set particleSystemList(E){this._objectRenderer.particleSystemList=E}get getCustomRenderList(){return this._objectRenderer.getCustomRenderList}set getCustomRenderList(E){this._objectRenderer.getCustomRenderList=E}get renderParticles(){return this._objectRenderer.renderParticles}set renderParticles(E){this._objectRenderer.renderParticles=E}get renderSprites(){return this._objectRenderer.renderSprites}set renderSprites(E){this._objectRenderer.renderSprites=E}get forceLayerMaskCheck(){return this._objectRenderer.forceLayerMaskCheck}set forceLayerMaskCheck(E){this._objectRenderer.forceLayerMaskCheck=E}get activeCamera(){return this._objectRenderer.activeCamera}set activeCamera(E){this._objectRenderer.activeCamera=E}get cameraForLOD(){return this._objectRenderer.cameraForLOD}set cameraForLOD(E){this._objectRenderer.cameraForLOD=E}get disableImageProcessing(){return this._objectRenderer.disableImageProcessing}set disableImageProcessing(E){this._objectRenderer.disableImageProcessing=E}get customIsReadyFunction(){return this._objectRenderer.customIsReadyFunction}set customIsReadyFunction(E){this._objectRenderer.customIsReadyFunction=E}get customRenderFunction(){return this._objectRenderer.customRenderFunction}set customRenderFunction(E){this._objectRenderer.customRenderFunction=E}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(E){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(E)}get onBeforeRenderObservable(){return this._objectRenderer.onBeforeRenderObservable}set onBeforeRender(E){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(E)}get onAfterRenderObservable(){return this._objectRenderer.onAfterRenderObservable}set onAfterRender(E){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(E)}set onClear(E){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(E)}get _waitingRenderList(){return this._objectRenderer._waitingRenderList}set _waitingRenderList(E){this._objectRenderer._waitingRenderList=E}get renderPassId(){return this._objectRenderer.renderPassId}get renderPassIds(){return this._objectRenderer.renderPassIds}get currentRefreshId(){return this._objectRenderer.currentRefreshId}setMaterialForRendering(E,U){this._objectRenderer.setMaterialForRendering(E,U)}get isMulti(){var E;return(null===(E=this._renderTarget)||void 0===E?void 0:E.isMulti)??!1}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(E){if(this._boundingBoxSize&&this._boundingBoxSize.equals(E))return;this._boundingBoxSize=E;const U=this.tE();U&&U.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){var E;return(null===(E=this._renderTarget)||void 0===E?void 0:E._depthStencilTexture)??null}constructor(E,U,g){let S,u,s=arguments.length>3&&void 0!==arguments[3]&&arguments[3],B=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],P=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,f=arguments.length>6&&void 0!==arguments[6]&&arguments[6],d=arguments.length>7&&void 0!==arguments[7]?arguments[7]:D.c.TRILINEAR_SAMPLINGMODE,I=!(arguments.length>8&&void 0!==arguments[8])||arguments[8],y=arguments.length>9&&void 0!==arguments[9]&&arguments[9],h=arguments.length>10&&void 0!==arguments[10]&&arguments[10],V=arguments.length>11&&void 0!==arguments[11]?arguments[11]:5,e=arguments.length>12&&void 0!==arguments[12]&&arguments[12],x=arguments.length>13?arguments[13]:void 0,l=arguments.length>14?arguments[14]:void 0,Y=arguments.length>15&&void 0!==arguments[15]&&arguments[15],t=arguments.length>16&&void 0!==arguments[16]&&arguments[16],G=!0;if("object"===typeof s){const E=s;s=!!E.generateMipMaps,B=E.doNotChangeAspectRatio??!0,P=E.type??0,f=!!E.isCube,d=E.samplingMode??D.c.TRILINEAR_SAMPLINGMODE,I=E.generateDepthBuffer??!0,y=!!E.generateStencilBuffer,h=!!E.isMulti,V=E.format??5,e=!!E.delayAllocation,x=E.samples,l=E.creationFlags,Y=!!E.noColorAttachment,t=!!E.useSRGBBuffer,S=E.colorAttachment,G=E.gammaSpace??G,u=E.existingObjectRenderer}if(super(null,g,!s,void 0,d,void 0,void 0,void 0,void 0,V),this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new N.b,this.onAfterUnbindObservable=new N.b,this.onClearObservable=new N.b,this.onResizeObservable=new N.b,this._cleared=!1,this.skipInitialClear=!1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this._dontDisposeObjectRenderer=!1,this.boundingBoxPosition=L.dU.Zero(),this._disableEngineStages=!1,this._dumpToolsLoading=!1,!(g=this.tE()))return;const b=this.tE().getEngine();this._gammaSpace=G,this._coordinatesMode=D.c.PROJECTION_MODE,this.name=E,this.isRenderTarget=!0,this._initialSizeParameter=U,this._dontDisposeObjectRenderer=!!u,this._processSizeParameter(U),this._objectRenderer=u??new F(E,g,{numPasses:f?6:this.getRenderLayers()||1,doNotChangeAspectRatio:B}),this._onBeforeRenderingManagerRenderObserver=this._objectRenderer.onBeforeRenderingManagerRenderObservable.add((()=>{if(!this._disableEngineStages)for(const E of this._scene._beforeRenderTargetClearStage)E.action(this,this._currentFaceIndex,this._currentLayer);if(this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(b):this.skipInitialClear||b.clear(this.clearColor||this._scene.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),!this._disableEngineStages)for(const E of this._scene._beforeRenderTargetDrawStage)E.action(this,this._currentFaceIndex,this._currentLayer)})),this._onAfterRenderingManagerRenderObserver=this._objectRenderer.onAfterRenderingManagerRenderObservable.add((()=>{var E;if(!this._disableEngineStages)for(const g of this._scene._afterRenderTargetDrawStage)g.action(this,this._currentFaceIndex,this._currentLayer);const U=(null===(E=this._texture)||void 0===E?void 0:E.generateMipMaps)??!1;if(this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex,this._postProcesses,this.ignoreCameraViewport):this._currentUseCameraPostProcess&&this._scene.postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex),!this._disableEngineStages)for(const g of this._scene._afterRenderTargetPostProcessStage)g.action(this,this._currentFaceIndex,this._currentLayer);this._texture&&(this._texture.generateMipMaps=U),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),this._currentDumpForDebug&&(this._dumpTools?this._dumpTools.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),b):C.d.Error("dumpTools module is still being loaded. To speed up the process import dump tools directly in your project"))})),this._onFastPathRenderObserver=this._objectRenderer.onFastPathRenderObservable.add((()=>{this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(b):this.skipInitialClear||b.clear(this.clearColor||this._scene.clearColor,!0,!0,!0)})),this._resizeObserver=b.onResizeObservable.add((()=>{})),this._generateMipMaps=!!s,this._doNotChangeAspectRatio=B,h||(this._renderTargetOptions={generateMipMaps:s,type:P,format:this._format??void 0,samplingMode:this.samplingMode,generateDepthBuffer:I,generateStencilBuffer:y,samples:x,creationFlags:l,noColorAttachment:Y,useSRGBBuffer:t,colorAttachment:S,label:this.name},this.samplingMode===D.c.NEAREST_SAMPLINGMODE&&(this.wrapU=D.c.CLAMP_ADDRESSMODE,this.wrapV=D.c.CLAMP_ADDRESSMODE),e||(f?(this._renderTarget=g.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=D.c.INVCUBIC_MODE,this._textureMatrix=L.Matrix.Identity()):this._renderTarget=g.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==x&&(this.samples=x)))}createDepthStencilTexture(){var E;let U=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,g=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],N=arguments.length>2&&void 0!==arguments[2]&&arguments[2],L=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,D=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14,S=arguments.length>5?arguments[5]:void 0;null===(E=this._renderTarget)||void 0===E||E.createDepthStencilTexture(U,g,N,L,D,S)}_processSizeParameter(E){if(E.ratio){this._sizeRatio=E.ratio;const U=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(U.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(U.getRenderHeight(),this._sizeRatio)}}else this._size=E}get samples(){var E;return(null===(E=this._renderTarget)||void 0===E?void 0:E.samples)??this._samples}set samples(E){this._renderTarget&&(this._samples=this._renderTarget.setSamples(E))}addPostProcess(E){if(!this._postProcessManager){const E=this.tE();if(!E)return;this._postProcessManager=new S.c(E),this._postProcesses=new Array}this._postProcesses.push(E),this._postProcesses[0].Mg=!1}clearPostProcesses(){let E=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._postProcesses){if(E)for(const E of this._postProcesses)E.dispose();this._postProcesses=[]}}removePostProcess(E){if(!this._postProcesses)return;const U=this._postProcesses.indexOf(E);-1!==U&&(this._postProcesses.splice(U,1),this._postProcesses.length>0&&(this._postProcesses[0].Mg=!1))}resetRefreshCounter(){this._objectRenderer.resetRefreshCounter()}get refreshRate(){return this._objectRenderer.refreshRate}set refreshRate(E){this._objectRenderer.refreshRate=E}_shouldRender(){return this._objectRenderer.shouldRender()}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){const E=this._size.layers;if(E)return E;const U=this._size.depth;return U||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(E){const U=Math.max(1,this.getRenderSize()*E);this.resize(U)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(E){var U;const g=this.isCube;null===(U=this._renderTarget)||void 0===U||U.dispose(),this._renderTarget=null;const N=this.tE();N&&(this._processSizeParameter(E),this._renderTarget=g?N.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):N.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==this._renderTargetOptions.samples&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(){let E=arguments.length>0&&void 0!==arguments[0]&&arguments[0],U=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._render(E,U)}isReadyForRendering(){this._dumpToolsLoading||(this._dumpToolsLoading=!0,g.e(20).then(g.bind(g,12554)).then((E=>this._dumpTools=E))),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight());const E=this._objectRenderer._checkReadiness();return this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender(),E}_render(){let E=arguments.length>0&&void 0!==arguments[0]&&arguments[0],U=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const g=this.tE();if(g){if(void 0!==this.useCameraPostProcesses&&(E=this.useCameraPostProcesses),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight()),!this.is2DArray&&!this.is3D||this.isMulti)if(this.isCube&&!this.isMulti)for(let N=0;N<6;N++)this._renderToTarget(N,E,U),g.incrementRenderId(),g.resetCachedMaterial();else this._renderToTarget(0,E,U);else for(let N=0;N<this.getRenderLayers();N++)this._renderToTarget(0,E,U,N),g.incrementRenderId(),g.resetCachedMaterial();this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender()}}_bestReflectionRenderTargetDimension(E,U){const g=E*U,N=(0,u.n)(g+16384/(128+g));return Math.min((0,u.d)(E),N)}_bindFrameBuffer(){let E=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const g=this.tE();if(!g)return;const N=g.getEngine();this._renderTarget&&N.bindFramebuffer(this._renderTarget,this.isCube?E:void 0,void 0,void 0,this.ignoreCameraViewport,0,U)}_unbindFrameBuffer(E,U){this._renderTarget&&E.unBindFramebuffer(this._renderTarget,this.isCube,(()=>{this.onAfterRenderObservable.notifyObservers(U)}))}_prepareFrame(E,U,g,N){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses)||this._bindFrameBuffer(U,g):N&&E.postProcessManager._prepareFrame(this._texture)||this._bindFrameBuffer(U,g)}_renderToTarget(E,U,g){var N,L;let D=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const S=this.tE();if(!S)return;const u=S.getEngine();this._currentFaceIndex=E,this._currentLayer=D,this._currentUseCameraPostProcess=U,this._currentDumpForDebug=g,this._prepareFrame(S,E,D,U),null===(N=u._debugPushGroup)||void 0===N||N.call(u,`render to face #${E} layer #${D}`,2),this._objectRenderer.render(E+D,!0),null===(L=u._debugPopGroup)||void 0===L||L.call(u,2),this._unbindFrameBuffer(u,E),this._texture&&this.isCube&&5===E&&u.generateMipMapsForCubemap(this._texture,!0)}setRenderingOrder(E){let U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,g=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,N=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this._objectRenderer.setRenderingOrder(E,U,g,N)}setRenderingAutoClearDepthStencil(E,U){this._objectRenderer.setRenderingAutoClearDepthStencil(E,U)}clone(){const E=this.getSize(),U=new f(this.name,E,this.tE(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return U.Qg=this.Qg,U.level=this.level,U.coordinatesMode=this.coordinatesMode,this.renderList&&(U.renderList=this.renderList.slice(0)),U}serialize(){if(!this.name)return null;const E=super.serialize();if(E.renderTargetSize=this.getRenderSize(),E.renderList=[],this.renderList)for(let U=0;U<this.renderList.length;U++)E.renderList.push(this.renderList[U].id);return E}disposeFramebufferObjects(){var E;null===(E=this._renderTarget)||void 0===E||E.dispose(!0)}releaseInternalTexture(){var E;null===(E=this._renderTarget)||void 0===E||E.releaseTextures(),this._texture=null}dispose(){var E;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._objectRenderer.onBeforeRenderingManagerRenderObservable.remove(this._onBeforeRenderingManagerRenderObserver),this._objectRenderer.onAfterRenderingManagerRenderObservable.remove(this._onAfterRenderingManagerRenderObserver),this._objectRenderer.onFastPathRenderObservable.remove(this._onFastPathRenderObserver),this._dontDisposeObjectRenderer||this._objectRenderer.dispose(),this.clearPostProcesses(!0),this._resizeObserver&&(this.tE().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null);const U=this.tE();if(!U)return;let g=U.customRenderTargets.indexOf(this);g>=0&&U.customRenderTargets.splice(g,1);for(const N of U.cameras)g=N.customRenderTargets.indexOf(this),g>=0&&N.customRenderTargets.splice(g,1);null===(E=this._renderTarget)||void 0===E||E.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this._objectRenderer._rebuild(),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._objectRenderer.freeRenderingGroups()}getViewCount(){return 1}}f.REFRESHRATE_RENDER_ONCE=F.REFRESHRATE_RENDER_ONCE,f.REFRESHRATE_RENDER_ONEVERYFRAME=F.REFRESHRATE_RENDER_ONEVERYFRAME,f.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=F.REFRESHRATE_RENDER_ONEVERYTWOFRAMES,D.c._CreateRenderTargetTexture=(E,U,g,N,L)=>new f(E,U,g,N)},12502:(E,U,g)=>{function N(E){return 13===E||14===E||15===E||16===E||17===E||18===E||19===E}function L(E){return 13===E||17===E||18===E||19===E}g.d(U,{b:()=>L,d:()=>N})},12478:(E,U,g)=>{function N(E){return void 0===E.getPipelineContext}g.d(U,{d:()=>N})},12433:(E,U,g)=>{g.d(U,{c:()=>C,e:()=>B});var N=g(12407),L=g(12442),D=g(12174),S=g(12247),u=g(12450);g(12453);const s={bE:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class C{constructor(E){let U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:s;this._fullscreenViewport=new L.e(0,0,1,1);const g=U.bE??s.bE,D=U.indices??s.indices;this.fU=E,this._vertexBuffers={[N.f.PositionKind]:new N.f(E,g,N.f.PositionKind,!1,!1,2)},this._indexBuffer=E.createIndexBuffer(D),this._indexBufferLength=D.length,this._onContextRestoredObserver=E.onContextRestoredObservable.add((()=>{this._indexBuffer=E.createIndexBuffer(D);for(const E in this._vertexBuffers){this._vertexBuffers[E]._rebuild()}}))}setViewport(){let E=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._fullscreenViewport;this.fU.setViewport(E)}bindBuffers(E){this.fU.bindBuffers(this._vertexBuffers,this._indexBuffer,E)}applyEffectWrapper(E){this.fU.setState(!0),this.fU.depthCullingState.depthTest=!1,this.fU.stencilState.stencilTest=!1,this.fU.enableEffect(E.drawWrapper),this.bindBuffers(E.effect),E.onApplyObservable.notifyObservers({})}saveStates(){this._savedStateDepthTest=this.fU.depthCullingState.depthTest,this._savedStateStencilTest=this.fU.stencilState.stencilTest}restoreStates(){this.fU.depthCullingState.depthTest=this._savedStateDepthTest,this.fU.stencilState.stencilTest=this._savedStateStencilTest}draw(){this.fU.drawElementsType(0,0,this._indexBufferLength)}_isRenderTargetTexture(E){return void 0!==E.renderTarget}render(E){let U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!E.effect.isReady())return;this.saveStates(),this.setViewport();const g=null===U?null:this._isRenderTargetTexture(U)?U.renderTarget:U;g&&this.fU.bindFramebuffer(g),this.applyEffectWrapper(E),this.draw(),g&&this.fU.unBindFramebuffer(g),this.restoreStates()}dispose(){const E=this._vertexBuffers[N.f.PositionKind];E&&(E.dispose(),delete this._vertexBuffers[N.f.PositionKind]),this._indexBuffer&&this.fU._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.fU.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}}class B{static RegisterShaderCodeProcessing(E,U){U?B._CustomShaderCodeProcessing[E??""]=U:delete B._CustomShaderCodeProcessing[E??""]}static _GetShaderCodeProcessing(E){return B._CustomShaderCodeProcessing[E]??B._CustomShaderCodeProcessing[""]}get name(){return this.options.name}set name(E){this.options.name=E}isReady(){var E;return(null===(E=this._drawWrapper.effect)||void 0===E?void 0:E.isReady())??!1}get drawWrapper(){return this._drawWrapper}get effect(){return this._drawWrapper.effect}set effect(E){this._drawWrapper.effect=E}constructor(E){this.alphaMode=0,this.onEffectCreatedObservable=new D.b(void 0,!0),this.onApplyObservable=new D.b,this._shadersLoaded=!1,this._webGPUReady=!1,this._importPromises=[],this.options={...E,name:E.name||"effectWrapper",fU:E.fU,uniforms:E.uniforms||E.uniformNames||[],uniformNames:void 0,samplers:E.samplers||E.samplerNames||[],samplerNames:void 0,attributeNames:E.attributeNames||["position"],uniformBuffers:E.uniformBuffers||[],defines:E.defines||"",useShaderStore:E.useShaderStore||!1,vertexUrl:E.vertexUrl||E.vertexShader||"postprocess",vertexShader:void 0,fragmentShader:E.fragmentShader||"pass",indexParameters:E.indexParameters,blockCompilation:E.blockCompilation||!1,shaderLanguage:E.shaderLanguage||0,onCompiled:E.onCompiled||void 0,extraInitializations:E.extraInitializations||void 0,extraInitializationsAsync:E.extraInitializationsAsync||void 0,useAsPostProcess:E.useAsPostProcess??!1},this.options.uniformNames=this.options.uniforms,this.options.samplerNames=this.options.samplers,this.options.vertexShader=this.options.vertexUrl,this.options.useAsPostProcess&&(-1===this.options.samplers.indexOf("textureSampler")&&this.options.samplers.push("textureSampler"),-1===this.options.uniforms.indexOf("scale")&&this.options.uniforms.push("scale")),E.vertexUrl||E.vertexShader?this._shaderPath={vertexSource:this.options.vertexShader}:(this.options.useAsPostProcess||(this.options.uniforms.push("scale"),this.onApplyObservable.add((()=>{this.effect.setFloat2("scale",1,1)}))),this._shaderPath={vertex:this.options.vertexShader}),this._shaderPath.fragmentSource=this.options.fragmentShader,this._shaderPath.spectorName=this.options.name,this.options.useShaderStore&&(this._shaderPath.fragment=this._shaderPath.fragmentSource,this._shaderPath.vertex||(this._shaderPath.vertex=this._shaderPath.vertexSource),delete this._shaderPath.fragmentSource,delete this._shaderPath.vertexSource),this.onApplyObservable.add((()=>{this.bind()})),this.options.useShaderStore||(this._onContextRestoredObserver=this.options.fU.onContextRestoredObservable.add((()=>{this.effect._pipelineContext=null,this.effect._prepareEffect()}))),this._drawWrapper=new u.c(this.options.fU),this._webGPUReady=1===this.options.shaderLanguage;const U=Array.isArray(this.options.defines)?this.options.defines.join("\n"):this.options.defines;this._postConstructor(this.options.blockCompilation,U,this.options.extraInitializations)}_gatherImports(){let E=arguments.length>0&&void 0!==arguments[0]&&arguments[0],U=arguments.length>1?arguments[1]:void 0;this.options.useAsPostProcess&&(E&&this._webGPUReady?U.push(Promise.all([g.e(53).then(g.bind(g,14871))])):U.push(Promise.all([Promise.resolve().then(g.bind(g,12453))])))}_postConstructor(E){let U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,g=arguments.length>2?arguments[2]:void 0,N=arguments.length>3?arguments[3]:void 0;this._importPromises.length=0,N&&this._importPromises.push(...N);const L=this.options.fU.isWebGPU&&!B.ForceGLSL;this._gatherImports(L,this._importPromises),void 0!==g&&g(L,this._importPromises),L&&this._webGPUReady&&(this.options.shaderLanguage=1),E||this.updateEffect(U)}updateEffect(){let E=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,g=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,N=arguments.length>3?arguments[3]:void 0,L=arguments.length>4?arguments[4]:void 0,D=arguments.length>5?arguments[5]:void 0,u=arguments.length>6?arguments[6]:void 0,s=arguments.length>7?arguments[7]:void 0;const C=B._GetShaderCodeProcessing(this.name);if(null!==C&&void 0!==C&&C.defineCustomBindings){var P,F;const N=(null===(P=U)||void 0===P?void 0:P.slice())??[];N.push(...this.options.uniforms);const L=(null===(F=g)||void 0===F?void 0:F.slice())??[];L.push(...this.options.samplers),E=C.defineCustomBindings(this.name,E,N,L),U=N,g=L}this.options.defines=E||"";const f=this._shadersLoaded||0===this._importPromises.length?void 0:async()=>{await Promise.all(this._importPromises),this._shadersLoaded=!0};let d;d=this.options.extraInitializationsAsync?async()=>{null===f||void 0===f||f(),await this.options.extraInitializationsAsync()}:f,this.options.useShaderStore?this._drawWrapper.effect=this.options.fU.createEffect({vertex:u??this._shaderPath.vertex,fragment:s??this._shaderPath.fragment},{attributes:this.options.attributeNames,uniformsNames:U||this.options.uniforms,uniformBuffersNames:this.options.uniformBuffers,samplers:g||this.options.samplers,defines:null!==E?E:"",fallbacks:null,onCompiled:L??this.options.onCompiled,onError:D??null,indexParameters:N||this.options.indexParameters,processCodeAfterIncludes:null!==C&&void 0!==C&&C.processCodeAfterIncludes?(E,U)=>C.processCodeAfterIncludes(this.name,E,U):null,processFinalCode:null!==C&&void 0!==C&&C.processFinalCode?(E,U)=>C.processFinalCode(this.name,E,U):null,shaderLanguage:this.options.shaderLanguage,extraInitializationsAsync:d},this.options.fU):this._drawWrapper.effect=new S.Effect(this._shaderPath,this.options.attributeNames,U||this.options.uniforms,g||this.options.samplerNames,this.options.fU,E,void 0,L||this.options.onCompiled,void 0,void 0,void 0,this.options.shaderLanguage,d),this.onEffectCreatedObservable.notifyObservers(this._drawWrapper.effect)}bind(){var E,U;let g=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.options.useAsPostProcess&&!g&&(this.options.fU.setAlphaMode(this.alphaMode),this.drawWrapper.effect.setFloat2("scale",1,1)),null===(E=B._GetShaderCodeProcessing(this.name))||void 0===E||null===(U=E.bindCustomBindings)||void 0===U||U.call(E,this.name,this._drawWrapper.effect)}dispose(){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.onEffectCreatedObservable.clear(),this._drawWrapper.dispose(!0)}}B.ForceGLSL=!1,B._CustomShaderCodeProcessing={}},12531:(E,U,g)=>{g.d(U,{e:()=>S});var N,L,D=g(12334);!function(E){E[E.LOCAL=0]="LOCAL",E[E.WORLD=1]="WORLD",E[E.BONE=2]="BONE"}(N||(N={}));class S{}S.X=new D.dU(1,0,0),S.Y=new D.dU(0,1,0),S.Z=new D.dU(0,0,1),function(E){E[E.X=0]="X",E[E.Y=1]="Y",E[E.Z=2]="Z"}(L||(L={}))},12529:(E,U,g)=>{g.d(U,{c:()=>N.Matrix,e:()=>N.Quaternion,h:()=>N.TmpVectors,j:()=>N.dU});g(12531),g(12379),g(12336),g(12534),g(12542),g(12382),g(12363);var N=g(12334);g(12442)},12542:(E,U,g)=>{g.d(U,{c:()=>u,f:()=>F,j:()=>B,m:()=>P});var N,L=g(12353),D=g(12334),S=g(12336);!function(E){E[E.CW=0]="CW",E[E.CCW=1]="CCW"}(N||(N={}));class u{static Interpolate(E,U,g,N,L){if(0===E)return 0;const D=1-3*N+3*U,S=3*N-6*U,u=3*U;let s=E;for(let C=0;C<5;C++){const U=s*s;s-=(D*(U*s)+S*U+u*s-E)*(1/(3*D*U+2*S*s+u)),s=Math.min(1,Math.max(0,s))}return 3*Math.pow(1-s,2)*s*g+3*(1-s)*Math.pow(s,2)*L+Math.pow(s,3)}}class s{constructor(E){this._radians=E,this._radians<0&&(this._radians+=2*Math.PI)}degrees(){return 180*this._radians/Math.PI}radians(){return this._radians}static BetweenTwoPoints(E,U){const g=U.IU(E),N=Math.atan2(g.y,g.x);return new s(N)}static BetweenTwoVectors(E,U){let g=E.lengthSquared()*U.lengthSquared();if(0===g)return new s(Math.PI/2);g=Math.sqrt(g);let N=E.dot(U)/g;N=(0,L.Clamp)(N,-1,1);const D=Math.acos(N);return new s(D)}static FromRadians(E){return new s(E)}static FromDegrees(E){return new s(E*Math.PI/180)}}class C{constructor(E,U,g){this.startPoint=E,this.midPoint=U,this.endPoint=g;const N=Math.pow(U.x,2)+Math.pow(U.y,2),L=(Math.pow(E.x,2)+Math.pow(E.y,2)-N)/2,S=(N-Math.pow(g.x,2)-Math.pow(g.y,2))/2,u=(E.x-U.x)*(U.y-g.y)-(U.x-g.x)*(E.y-U.y);this.centerPoint=new D.Vector2((L*(U.y-g.y)-S*(E.y-U.y))/u,((E.x-U.x)*S-(U.x-g.x)*L)/u),this.radius=this.centerPoint.IU(this.startPoint).length(),this.startAngle=s.BetweenTwoPoints(this.centerPoint,this.startPoint);const C=this.startAngle.degrees();let B=s.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),P=s.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();B-C>180&&(B-=360),B-C<-180&&(B+=360),P-B>180&&(P-=360),P-B<-180&&(P+=360),this.orientation=B-C<0?0:1,this.angle=s.FromDegrees(0===this.orientation?C-P:P-C)}}class B{constructor(E,U){this._points=new Array,this._length=0,this.closed=!1,this._points.push(new D.Vector2(E,U))}addLineTo(E,U){if(this.closed)return this;const g=new D.Vector2(E,U),N=this._points[this._points.length-1];return this._points.push(g),this._length+=g.IU(N).length(),this}addArcTo(E,U,g,N){let L=arguments.length>4&&void 0!==arguments[4]?arguments[4]:36;if(this.closed)return this;const S=this._points[this._points.length-1],u=new D.Vector2(E,U),s=new D.Vector2(g,N),B=new C(S,u,s);let P=B.angle.radians()/L;0===B.orientation&&(P*=-1);let F=B.startAngle.radians()+P;for(let D=0;D<L;D++){const E=Math.cos(F)*B.radius+B.centerPoint.x,U=Math.sin(F)*B.radius+B.centerPoint.y;this.addLineTo(E,U),F+=P}return this}addQuadraticCurveTo(E,U,g,N){let L=arguments.length>4&&void 0!==arguments[4]?arguments[4]:36;if(this.closed)return this;const D=(E,U,g,N)=>(1-E)*(1-E)*U+2*E*(1-E)*g+E*E*N,S=this._points[this._points.length-1];for(let u=0;u<=L;u++){const s=u/L,C=D(s,S.x,E,g),B=D(s,S.y,U,N);this.addLineTo(C,B)}return this}addBezierCurveTo(E,U,g,N,L,D){let S=arguments.length>6&&void 0!==arguments[6]?arguments[6]:36;if(this.closed)return this;const u=(E,U,g,N,L)=>(1-E)*(1-E)*(1-E)*U+3*E*(1-E)*(1-E)*g+3*E*E*(1-E)*N+E*E*E*L,s=this._points[this._points.length-1];for(let C=0;C<=S;C++){const B=C/S,P=u(B,s.x,E,g,L),F=u(B,s.y,U,N,D);this.addLineTo(P,F)}return this}isPointInside(E){let U=!1;const g=this._points.length;for(let N=g-1,L=0;L<g;N=L++){let g=this._points[N],D=this._points[L],S=D.x-g.x,u=D.y-g.y;if(Math.abs(u)>Number.EPSILON){if(u<0&&(g=this._points[L],S=-S,D=this._points[N],u=-u),E.y<g.y||E.y>D.y)continue;if(E.y===g.y&&E.x===g.x)return!0;{const N=u*(E.x-g.x)-S*(E.y-g.y);if(0===N)return!0;if(N<0)continue;U=!U}}else{if(E.y!==g.y)continue;if(D.x<=E.x&&E.x<=g.x||g.x<=E.x&&E.x<=D.x)return!0}}return U}close(){return this.closed=!0,this}length(){let E=this._length;if(this.closed){const U=this._points[this._points.length-1];E+=this._points[0].IU(U).length()}return E}area(){const E=this._points.length;let U=0;for(let g=E-1,N=0;N<E;g=N++)U+=this._points[g].x*this._points[N].y-this._points[N].x*this._points[g].y;return.5*U}getPoints(){return this._points}getPointAtLengthPosition(E){if(E<0||E>1)return D.Vector2.Zero();const U=E*this.length();let g=0;for(let N=0;N<this._points.length;N++){const E=(N+1)%this._points.length,L=this._points[N],S=this._points[E].IU(L),u=S.length()+g;if(U>=g&&U<=u){const E=S.normalize(),N=U-g;return new D.Vector2(L.x+E.x*N,L.y+E.y*N)}g=u}return D.Vector2.Zero()}static StartingAt(E,U){return new B(E,U)}}class P{constructor(E){let U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,g=arguments.length>2?arguments[2]:void 0,N=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.path=E,this._curve=new Array,this._distances=new Array,this._tangents=new Array,this._normals=new Array,this._binormals=new Array,this._pointAtData={id:0,point:D.dU.Zero(),previousPointArrayIndex:0,position:0,subPosition:0,interpolateReady:!1,interpolationMatrix:D.Matrix.Identity()};for(let L=0;L<E.length;L++)this._curve[L]=E[L].clone();this._raw=g||!1,this._alignTangentsWithPath=N,this._compute(U,N)}getCurve(){return this._curve}getPoints(){return this._curve}length(){return this._distances[this._distances.length-1]}getTangents(){return this._tangents}getNormals(){return this._normals}getBinormals(){return this._binormals}getDistances(){return this._distances}getPointAt(E){return this._updatePointAtData(E).point}getTangentAt(E){let U=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(E,U),U?D.dU.TransformCoordinates(D.dU.Forward(),this._pointAtData.interpolationMatrix):this._tangents[this._pointAtData.previousPointArrayIndex]}getNormalAt(E){let U=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(E,U),U?D.dU.TransformCoordinates(D.dU.Right(),this._pointAtData.interpolationMatrix):this._normals[this._pointAtData.previousPointArrayIndex]}getBinormalAt(E){let U=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(E,U),U?D.dU.TransformCoordinates(D.dU.UpReadOnly,this._pointAtData.interpolationMatrix):this._binormals[this._pointAtData.previousPointArrayIndex]}getDistanceAt(E){return this.length()*E}getPreviousPointIndexAt(E){return this._updatePointAtData(E),this._pointAtData.previousPointArrayIndex}getSubPositionAt(E){return this._updatePointAtData(E),this._pointAtData.subPosition}getClosestPositionTo(E){let U=Number.MAX_VALUE,g=0;for(let N=0;N<this._curve.length-1;N++){const L=this._curve[N+0],S=this._curve[N+1].IU(L).normalize(),u=this._distances[N+1]-this._distances[N+0],s=Math.min(Math.max(D.dU.Dot(S,E.IU(L).normalize()),0)*D.dU.Distance(L,E)/u,1),C=D.dU.Distance(L.add(S.scale(s*u)),E);C<U&&(U=C,g=(this._distances[N+0]+u*s)/this.length())}return g}slice(){let E=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(E<0&&(E=1- -1*E%1),U<0&&(U=1- -1*U%1),E>U){const g=E;E=U,U=g}const g=this.getCurve(),N=this.getPointAt(E);let L=this.getPreviousPointIndexAt(E);const D=this.getPointAt(U),S=this.getPreviousPointIndexAt(U)+1,u=[];return 0!==E&&(L++,u.push(N)),u.push(...g.slice(L,S)),1===U&&1!==E||u.push(D),new P(u,this.getNormalAt(E),this._raw,this._alignTangentsWithPath)}update(E){let U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,g=arguments.length>2&&void 0!==arguments[2]&&arguments[2];for(let N=0;N<E.length;N++)this._curve[N].x=E[N].x,this._curve[N].y=E[N].y,this._curve[N].z=E[N].z;return this._compute(U,g),this}_compute(E){let U=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const g=this._curve.length;if(g<2)return;this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[g-1]=this._curve[g-1].IU(this._curve[g-2]),this._raw||this._tangents[g-1].normalize();const N=this._tangents[0],L=this._normalVector(N,E);let S,u,s,C,B;this._normals[0]=L,this._raw||this._normals[0].normalize(),this._binormals[0]=D.dU.Cross(N,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;for(let P=1;P<g;P++)S=this._getLastNonNullVector(P),P<g-1&&(u=this._getFirstNonNullVector(P),this._tangents[P]=U?u:S.add(u),this._tangents[P].normalize()),this._distances[P]=this._distances[P-1]+this._curve[P].IU(this._curve[P-1]).length(),s=this._tangents[P],B=this._binormals[P-1],this._normals[P]=D.dU.Cross(B,s),this._raw||(0===this._normals[P].length()?(C=this._normals[P-1],this._normals[P]=C.clone()):this._normals[P].normalize()),this._binormals[P]=D.dU.Cross(s,this._normals[P]),this._raw||this._binormals[P].normalize();this._pointAtData.id=NaN}_getFirstNonNullVector(E){let U=1,g=this._curve[E+U].IU(this._curve[E]);for(;0===g.length()&&E+U+1<this._curve.length;)U++,g=this._curve[E+U].IU(this._curve[E]);return g}_getLastNonNullVector(E){let U=1,g=this._curve[E].IU(this._curve[E-U]);for(;0===g.length()&&E>U+1;)U++,g=this._curve[E].IU(this._curve[E-U]);return g}_normalVector(E,U){let g,N=E.length();if(0===N&&(N=1),void 0===U||null===U){let U;U=(0,L.WithinEpsilon)(Math.abs(E.y)/N,1,S.c)?(0,L.WithinEpsilon)(Math.abs(E.x)/N,1,S.c)?(0,L.WithinEpsilon)(Math.abs(E.z)/N,1,S.c)?D.dU.Zero():new D.dU(0,0,1):new D.dU(1,0,0):new D.dU(0,-1,0),g=D.dU.Cross(E,U)}else g=D.dU.Cross(E,U),D.dU.CrossToRef(g,E,g);return g.normalize(),g}_updatePointAtData(E){let U=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._pointAtData.id===E)return this._pointAtData.interpolateReady||this._updateInterpolationMatrix(),this._pointAtData;this._pointAtData.id=E;const g=this.getPoints();if(E<=0)return this._setPointAtData(0,0,g[0],0,U);if(E>=1)return this._setPointAtData(1,1,g[g.length-1],g.length-1,U);let N,L=g[0],S=0;const u=E*this.length();for(let s=1;s<g.length;s++){N=g[s];const C=D.dU.Distance(L,N);if(S+=C,S===u)return this._setPointAtData(E,1,N,s,U);if(S>u){const g=(S-u)/C,D=L.IU(N),B=N.add(D.scaleInPlace(g));return this._setPointAtData(E,1-g,B,s-1,U)}L=N}return this._pointAtData}_setPointAtData(E,U,g,N,L){return this._pointAtData.point=g,this._pointAtData.position=E,this._pointAtData.subPosition=U,this._pointAtData.previousPointArrayIndex=N,this._pointAtData.interpolateReady=L,L&&this._updateInterpolationMatrix(),this._pointAtData}_updateInterpolationMatrix(){this._pointAtData.interpolationMatrix=D.Matrix.Identity();const E=this._pointAtData.previousPointArrayIndex;if(E!==this._tangents.length-1){const U=E+1,g=this._tangents[E].clone(),N=this._normals[E].clone(),L=this._binormals[E].clone(),S=this._tangents[U].clone(),u=this._normals[U].clone(),s=this._binormals[U].clone(),C=D.Quaternion.RotationQuaternionFromAxis(N,L,g),B=D.Quaternion.RotationQuaternionFromAxis(u,s,S);D.Quaternion.Slerp(C,B,this._pointAtData.subPosition).toRotationMatrix(this._pointAtData.interpolationMatrix)}}}class F{static CreateQuadraticBezier(E,U,g,N){N=N>2?N:3;const L=[],S=(E,U,g,N)=>(1-E)*(1-E)*U+2*E*(1-E)*g+E*E*N;for(let u=0;u<=N;u++)L.push(new D.dU(S(u/N,E.x,U.x,g.x),S(u/N,E.y,U.y,g.y),S(u/N,E.z,U.z,g.z)));return new F(L)}static CreateCubicBezier(E,U,g,N,L){L=L>3?L:4;const S=[],u=(E,U,g,N,L)=>(1-E)*(1-E)*(1-E)*U+3*E*(1-E)*(1-E)*g+3*E*E*(1-E)*N+E*E*E*L;for(let s=0;s<=L;s++)S.push(new D.dU(u(s/L,E.x,U.x,g.x,N.x),u(s/L,E.y,U.y,g.y,N.y),u(s/L,E.z,U.z,g.z,N.z)));return new F(S)}static CreateHermiteSpline(E,U,g,N,L){const S=[],u=1/L;for(let s=0;s<=L;s++)S.push(D.dU.Hermite(E,U,g,N,s*u));return new F(S)}static CreateCatmullRomSpline(E,U,g){const N=[],L=1/U;let S=0;if(g){const g=E.length;for(let u=0;u<g;u++){S=0;for(let s=0;s<U;s++)N.push(D.dU.CatmullRom(E[u%g],E[(u+1)%g],E[(u+2)%g],E[(u+3)%g],S)),S+=L}N.push(N[0])}else{const g=[];g.push(E[0].clone()),Array.prototype.push.apply(g,E),g.push(E[E.length-1].clone());let u=0;for(;u<g.length-3;u++){S=0;for(let E=0;E<U;E++)N.push(D.dU.CatmullRom(g[u],g[u+1],g[u+2],g[u+3],S)),S+=L}u--,N.push(D.dU.CatmullRom(g[u],g[u+1],g[u+2],g[u+3],S))}return new F(N)}static ArcThru3Points(E,U,g){let N=arguments.length>3&&void 0!==arguments[3]?arguments[3]:32,L=arguments.length>4&&void 0!==arguments[4]&&arguments[4],S=arguments.length>5&&void 0!==arguments[5]&&arguments[5];const u=[],s=U.IU(E),C=g.IU(U),B=E.IU(g),P=D.dU.Cross(s,C),f=P.length();if(f<Math.pow(10,-8))return new F(u);const d=s.lengthSquared(),I=C.lengthSquared(),y=B.lengthSquared(),h=P.lengthSquared(),V=.5*s.length()*C.length()*B.length()/f,e=-.5*I*D.dU.Dot(s,B)/h,x=-.5*y*D.dU.Dot(s,C)/h,l=-.5*d*D.dU.Dot(C,B)/h,Y=E.scale(e).add(U.scale(x)).add(g.scale(l)),t=E.IU(Y).normalize(),G=D.dU.Cross(P,t).normalize();if(S){const U=2*Math.PI/N;for(let E=0;E<=2*Math.PI;E+=U)u.push(Y.add(t.scale(V*Math.cos(E)).add(G.scale(V*Math.sin(E)))));u.push(E)}else{const U=1/N;let S=0,s=D.dU.Zero();do{s=Y.add(t.scale(V*Math.cos(S)).add(G.scale(V*Math.sin(S)))),u.push(s),S+=U}while(!s.equalsWithEpsilon(g,V*U*1.1));u.push(g),L&&u.push(E)}return new F(u)}constructor(E){this._length=0,this._points=E,this._length=this._computeLength(E)}getPoints(){return this._points}length(){return this._length}continue(E){const U=this._points[this._points.length-1],g=this._points.slice(),N=E.getPoints();for(let L=1;L<N.length;L++)g.push(N[L].IU(N[0]).add(U));return new F(g)}_computeLength(E){let U=0;for(let g=1;g<E.length;g++)U+=E[g].IU(E[g-1]).length();return U}}},12442:(E,U,g)=>{g.d(U,{e:()=>N});class N{constructor(E,U,g,N){this.x=E,this.y=U,this.width=g,this.height=N}toGlobal(E,U){return new N(this.x*E,this.y*U,this.width*E,this.height*U)}toGlobalToRef(E,U,g){return g.x=this.x*E,g.y=this.y*U,g.width=this.width*E,g.height=this.height*U,this}clone(){return new N(this.x,this.y,this.width,this.height)}}},12527:(E,U,g)=>{g.d(U,{c:()=>C,f:()=>B});var N=g(12334),L=g(12529);const D=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],S=[()=>1,E=>E.y,E=>E.z,E=>E.x,E=>E.x*E.y,E=>E.y*E.z,E=>3*E.z*E.z-1,E=>E.x*E.z,E=>E.x*E.x-E.y*E.y],u=(E,U)=>D[E]*S[E](U),s=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4];class C{constructor(){this.preScaled=!1,this.l00=N.dU.Zero(),this.l1_1=N.dU.Zero(),this.l10=N.dU.Zero(),this.l11=N.dU.Zero(),this.l2_2=N.dU.Zero(),this.l2_1=N.dU.Zero(),this.l20=N.dU.Zero(),this.l21=N.dU.Zero(),this.l22=N.dU.Zero()}addLight(E,U,g){L.h.dU[0].set(U.r,U.g,U.b);const N=L.h.dU[0],D=L.h.dU[1];N.scaleToRef(g,D),D.scaleToRef(u(0,E),L.h.dU[2]),this.l00.addInPlace(L.h.dU[2]),D.scaleToRef(u(1,E),L.h.dU[2]),this.l1_1.addInPlace(L.h.dU[2]),D.scaleToRef(u(2,E),L.h.dU[2]),this.l10.addInPlace(L.h.dU[2]),D.scaleToRef(u(3,E),L.h.dU[2]),this.l11.addInPlace(L.h.dU[2]),D.scaleToRef(u(4,E),L.h.dU[2]),this.l2_2.addInPlace(L.h.dU[2]),D.scaleToRef(u(5,E),L.h.dU[2]),this.l2_1.addInPlace(L.h.dU[2]),D.scaleToRef(u(6,E),L.h.dU[2]),this.l20.addInPlace(L.h.dU[2]),D.scaleToRef(u(7,E),L.h.dU[2]),this.l21.addInPlace(L.h.dU[2]),D.scaleToRef(u(8,E),L.h.dU[2]),this.l22.addInPlace(L.h.dU[2])}scaleInPlace(E){this.l00.scaleInPlace(E),this.l1_1.scaleInPlace(E),this.l10.scaleInPlace(E),this.l11.scaleInPlace(E),this.l2_2.scaleInPlace(E),this.l2_1.scaleInPlace(E),this.l20.scaleInPlace(E),this.l21.scaleInPlace(E),this.l22.scaleInPlace(E)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(s[0]),this.l1_1.scaleInPlace(s[1]),this.l10.scaleInPlace(s[2]),this.l11.scaleInPlace(s[3]),this.l2_2.scaleInPlace(s[4]),this.l2_1.scaleInPlace(s[5]),this.l20.scaleInPlace(s[6]),this.l21.scaleInPlace(s[7]),this.l22.scaleInPlace(s[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(D[0]),this.l1_1.scaleInPlace(D[1]),this.l10.scaleInPlace(D[2]),this.l11.scaleInPlace(D[3]),this.l2_2.scaleInPlace(D[4]),this.l2_1.scaleInPlace(D[5]),this.l20.scaleInPlace(D[6]),this.l21.scaleInPlace(D[7]),this.l22.scaleInPlace(D[8])}updateFromArray(E){return N.dU.FromArrayToRef(E[0],0,this.l00),N.dU.FromArrayToRef(E[1],0,this.l1_1),N.dU.FromArrayToRef(E[2],0,this.l10),N.dU.FromArrayToRef(E[3],0,this.l11),N.dU.FromArrayToRef(E[4],0,this.l2_2),N.dU.FromArrayToRef(E[5],0,this.l2_1),N.dU.FromArrayToRef(E[6],0,this.l20),N.dU.FromArrayToRef(E[7],0,this.l21),N.dU.FromArrayToRef(E[8],0,this.l22),this}updateFromFloatsArray(E){return N.dU.FromFloatsToRef(E[0],E[1],E[2],this.l00),N.dU.FromFloatsToRef(E[3],E[4],E[5],this.l1_1),N.dU.FromFloatsToRef(E[6],E[7],E[8],this.l10),N.dU.FromFloatsToRef(E[9],E[10],E[11],this.l11),N.dU.FromFloatsToRef(E[12],E[13],E[14],this.l2_2),N.dU.FromFloatsToRef(E[15],E[16],E[17],this.l2_1),N.dU.FromFloatsToRef(E[18],E[19],E[20],this.l20),N.dU.FromFloatsToRef(E[21],E[22],E[23],this.l21),N.dU.FromFloatsToRef(E[24],E[25],E[26],this.l22),this}static eU(E){return(new C).updateFromArray(E)}static FromPolynomial(E){const U=new C;return U.l00=E.xx.scale(.376127).add(E.yy.scale(.376127)).add(E.zz.scale(.376126)),U.l1_1=E.y.scale(.977204),U.l10=E.z.scale(.977204),U.l11=E.x.scale(.977204),U.l2_2=E.xy.scale(1.16538),U.l2_1=E.yz.scale(1.16538),U.l20=E.zz.scale(1.34567).IU(E.xx.scale(.672834)).IU(E.yy.scale(.672834)),U.l21=E.zx.scale(1.16538),U.l22=E.xx.scale(1.16538).IU(E.yy.scale(1.16538)),U.l1_1.scaleInPlace(-1),U.l11.scaleInPlace(-1),U.l2_1.scaleInPlace(-1),U.l21.scaleInPlace(-1),U.scaleInPlace(Math.PI),U}}class B{constructor(){this.x=N.dU.Zero(),this.y=N.dU.Zero(),this.z=N.dU.Zero(),this.xx=N.dU.Zero(),this.yy=N.dU.Zero(),this.zz=N.dU.Zero(),this.xy=N.dU.Zero(),this.yz=N.dU.Zero(),this.zx=N.dU.Zero()}get preScaledHarmonics(){return this._harmonics||(this._harmonics=C.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(E){L.h.dU[0].du(E.r,E.g,E.b);const U=L.h.dU[0];this.xx.addInPlace(U),this.yy.addInPlace(U),this.zz.addInPlace(U)}scaleInPlace(E){this.x.scaleInPlace(E),this.y.scaleInPlace(E),this.z.scaleInPlace(E),this.xx.scaleInPlace(E),this.yy.scaleInPlace(E),this.zz.scaleInPlace(E),this.yz.scaleInPlace(E),this.zx.scaleInPlace(E),this.xy.scaleInPlace(E)}updateFromHarmonics(E){return this._harmonics=E,this.x.D(E.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.D(E.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.D(E.l10),this.z.scaleInPlace(1.02333),this.xx.D(E.l00),L.h.dU[0].D(E.l20).scaleInPlace(.247708),L.h.dU[1].D(E.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).iB(L.h.dU[0]).addInPlace(L.h.dU[1]),this.yy.D(E.l00),this.yy.scaleInPlace(.886277).iB(L.h.dU[0]).iB(L.h.dU[1]),this.zz.D(E.l00),L.h.dU[0].D(E.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(L.h.dU[0]),this.yz.D(E.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.D(E.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.D(E.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(E){return(new B).updateFromHarmonics(E)}static eU(E){const U=new B;return N.dU.FromArrayToRef(E[0],0,U.x),N.dU.FromArrayToRef(E[1],0,U.y),N.dU.FromArrayToRef(E[2],0,U.z),N.dU.FromArrayToRef(E[3],0,U.xx),N.dU.FromArrayToRef(E[4],0,U.yy),N.dU.FromArrayToRef(E[5],0,U.zz),N.dU.FromArrayToRef(E[6],0,U.yz),N.dU.FromArrayToRef(E[7],0,U.zx),N.dU.FromArrayToRef(E[8],0,U.xy),U}}},12484:(E,U,g)=>{g.d(U,{b:()=>L});var N=g(12410);class L extends N.d{constructor(E){super(),this._buffer=E}get underlyingResource(){return this._buffer}}},12557:(E,U,g)=>{g.d(U,{b:()=>h,e:()=>l,f:()=>t,i:()=>G,j:()=>x});var N=g(12311),L=g(12396),D=g(12320),S=g(12430),u=g(12243),s=g(12292),C=g(12367),B=g(12433),P=g(12462);class F extends B.e{_gatherImports(E,U){E?(this._webGPUReady=!0,U.push(Promise.all([g.e(51).then(g.bind(g,14858))]))):U.push(Promise.all([g.e(52).then(g.bind(g,14865))])),super._gatherImports(E,U)}constructor(E){super({...arguments.length>2?arguments[2]:void 0,name:E,fU:(arguments.length>1&&void 0!==arguments[1]?arguments[1]:null)||P.c.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:F.FragmentUrl})}}F.FragmentUrl="pass";class f extends B.e{_gatherImports(E,U){E?(this._webGPUReady=!0,U.push(Promise.all([g.e(62).then(g.bind(g,14918))]))):U.push(Promise.all([g.e(63).then(g.bind(g,14924))])),super._gatherImports(E,U)}constructor(E){super({...arguments.length>2?arguments[2]:void 0,name:E,fU:(arguments.length>1&&void 0!==arguments[1]?arguments[1]:null)||P.c.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:f.FragmentUrl,defines:"#define POSITIVEX"}),this._face=0}get face(){return this._face}set face(E){if(!(E<0||E>5))switch(this._face=E,this._face){case 0:this.updateEffect("#define POSITIVEX");break;case 1:this.updateEffect("#define NEGATIVEX");break;case 2:this.updateEffect("#define POSITIVEY");break;case 3:this.updateEffect("#define NEGATIVEY");break;case 4:this.updateEffect("#define POSITIVEZ");break;case 5:this.updateEffect("#define NEGATIVEZ")}}}f.FragmentUrl="passCube";var d=g(12322);class I extends S.e{getClassName(){return"PassPostProcess"}constructor(E,U){let g=arguments.length>4?arguments[4]:void 0;const N={size:"number"===typeof U?U:void 0,camera:arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,samplingMode:arguments.length>3?arguments[3]:void 0,fU:g,reusable:arguments.length>5?arguments[5]:void 0,textureType:arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,blockCompilation:arguments.length>7&&void 0!==arguments[7]&&arguments[7],...U};super(E,F.FragmentUrl,{effectWrapper:"number"!==typeof U&&U.effectWrapper?void 0:new F(E,g,N),...N})}static _Parse(E,U,g,N){return C.b.Parse((()=>new I(E.name,E.options,U,E.renderTargetSamplingMode,E._engine,E.reusable)),E,g,N)}}(0,s.f)("BABYLON.PassPostProcess",I);class y extends S.e{get face(){return this._effectWrapper.face}set face(E){this._effectWrapper.face=E}getClassName(){return"PassCubePostProcess"}constructor(E,U){let g=arguments.length>4?arguments[4]:void 0;const N={size:"number"===typeof U?U:void 0,camera:arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,samplingMode:arguments.length>3?arguments[3]:void 0,fU:g,reusable:arguments.length>5?arguments[5]:void 0,textureType:arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,blockCompilation:arguments.length>7&&void 0!==arguments[7]&&arguments[7],...U};super(E,F.FragmentUrl,{effectWrapper:"number"!==typeof U&&U.effectWrapper?void 0:new f(E,g,N),...N})}static _Parse(E,U,g,N){return C.b.Parse((()=>new y(E.name,E.options,U,E.renderTargetSamplingMode,E._engine,E.reusable)),E,g,N)}}function h(E,U,g,N,L,D,u,s){const C=U.getEngine();return U.isReady=!1,L=L??U.samplingMode,N=N??U.type,D=D??U.format,u=u??U.width,s=s??U.height,-1===N&&(N=0),new Promise((B=>{const P=new S.e("postprocess",E,null,null,1,null,L,C,!1,void 0,N,void 0,null,!1,D);P.externalTextureSamplerBinding=!0;const F=C.createRenderTargetTexture({width:u,height:s},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:L,type:N,format:D});P.onEffectCreatedObservable.addOnce((E=>{E.executeWhenCompiled((()=>{P.onApply=E=>{E._bindTexture("textureSampler",U),E.setFloat2("scale",1,1)},g.postProcessManager.directRender([P],F,!0),C.restoreDefaultFramebuffer(),C._releaseTexture(U),P&&P.dispose(),F._swapAndDie(U),U.type=N,U.format=5,U.isReady=!0,B(U)}))}))}))}let V,e;function x(E){V||(V=new Float32Array(1),e=new Int32Array(V.buffer)),V[0]=E;const U=e[0];let g=U>>16&32768,N=U>>12&2047;const L=U>>23&255;return L<103?g:L>142?(g|=31744,g|=(255==L?0:1)&&8388607&U,g):L<113?(N|=2048,g|=(N>>114-L)+(N>>113-L&1),g):(g|=L-112<<10|N>>1,g+=1&N,g)}function l(E){const U=(32768&E)>>15,g=(31744&E)>>10,N=1023&E;return 0===g?(U?-1:1)*Math.pow(2,-14)*(N/Math.pow(2,10)):31==g?N?NaN:1/0*(U?-1:1):(U?-1:1)*Math.pow(2,g-15)*(1+N/Math.pow(2,10))}(0,D.e)([(0,d.E)()],y.prototype,"face",null),u.b._RescalePostProcessFactory=E=>new I("rescale",1,null,2,E,!1,0);const Y=async(E,U,D,u,s)=>{const C=E.tE(),B=C.getEngine();let P;if(B.isWebGPU?E.isCube?await g.e(60).then(g.bind(g,14905)):await g.e(61).then(g.bind(g,14914)):E.isCube?await g.e(58).then(g.bind(g,14894)):await g.e(59).then(g.bind(g,14903)),E.isCube){const E=["#define POSITIVEX","#define NEGATIVEX","#define POSITIVEY","#define NEGATIVEY","#define POSITIVEZ","#define NEGATIVEZ"];P=new S.e("lodCube","lodCube",{uniforms:["lod","gamma"],samplingMode:N.c.NEAREST_NEAREST_MIPNEAREST,fU:B,defines:E[u],shaderLanguage:B.isWebGPU?1:0})}else P=new S.e("lod","lod",{uniforms:["lod","gamma"],samplingMode:N.c.NEAREST_NEAREST_MIPNEAREST,fU:B,shaderLanguage:B.isWebGPU?1:0});await new Promise((E=>{P.onEffectCreatedObservable.addOnce((U=>{U.executeWhenCompiled((()=>{E(0)}))}))}));const F=new L.c("temp",{width:U,height:D},C,!1);P.onApply=function(U){U.setTexture("textureSampler",E),U.setFloat("lod",s),U.setInt("gamma",E.gammaSpace?1:0)};const f=E.getInternalTexture();try{if(F.renderTarget&&f){const g=f.samplingMode;0!==s?E.updateSamplingMode(N.c.NEAREST_NEAREST_MIPNEAREST):E.updateSamplingMode(N.c.NEAREST_NEAREST),C.postProcessManager.directRender([P],F.renderTarget,!0),E.updateSamplingMode(g);const L=await B.readPixels(0,0,U,D),S=new Uint8Array(L.buffer,0,L.byteLength);return B.unBindFramebuffer(F.renderTarget),S}throw Error("Render to texture failed.")}finally{F.dispose(),P.dispose()}};async function t(E,U,g){let N=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,L=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;return!E.isReady()&&E._texture&&await new Promise(((U,g)=>{null!==E._texture?E._texture.onLoadedObservable.addOnce((()=>{U(0)})):g(0)})),await Y(E,U,g,N,L)}const G={CreateResizedCopy:function(E,U,g){let D=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const S=E.tE(),u=S.getEngine(),s=new L.c("resized"+E.name,{width:U,height:g},S,!E.noMipmap,!0,E._texture.type,!1,E.samplingMode,!1);s.wrapU=E.wrapU,s.wrapV=E.wrapV,s.uOffset=E.uOffset,s.vOffset=E.vOffset,s.uScale=E.uScale,s.vScale=E.vScale,s.uAng=E.uAng,s.vAng=E.vAng,s.wAng=E.wAng,s.coordinatesIndex=E.coordinatesIndex,s.level=E.level,s.anisotropicFilteringLevel=E.anisotropicFilteringLevel,s._texture.isReady=!1,E.wrapU=N.c.CLAMP_ADDRESSMODE,E.wrapV=N.c.CLAMP_ADDRESSMODE;const C=new I("pass",1,null,D?N.c.BILINEAR_SAMPLINGMODE:N.c.NEAREST_SAMPLINGMODE,u,!1,0);return C.externalTextureSamplerBinding=!0,C.onEffectCreatedObservable.addOnce((U=>{U.executeWhenCompiled((()=>{C.onApply=function(U){U.setTexture("textureSampler",E)};const U=s.renderTarget;U&&(S.postProcessManager.directRender([C],U),u.unBindFramebuffer(U),s.disposeFramebufferObjects(),C.dispose(),s.getInternalTexture().isReady=!0)}))})),s},ApplyPostProcess:h,ToHalfFloat:x,FromHalfFloat:l,GetTextureDataAsync:t}},12430:(E,U,g)=>{g.d(U,{e:()=>d});var N=g(12320),L=g(12422),D=g(12174),S=g(12334),u=g(12247),s=g(12322),C=g(12367),B=g(12292),P=g(12243),F=g(12300),f=g(12433);P.b.prototype.setTextureFromPostProcess=function(E,U,g){var N;let L=null;U&&(U._forcedOutputTexture?L=U._forcedOutputTexture:U._textures.data[U._currentRenderTextureInd]&&(L=U._textures.data[U._currentRenderTextureInd])),this._bindTexture(E,(null===(N=L)||void 0===N?void 0:N.texture)??null,g)},P.b.prototype.setTextureFromPostProcessOutput=function(E,U,g){var N;this._bindTexture(E,(null===U||void 0===U||null===(N=U._outputTexture)||void 0===N?void 0:N.texture)??null,g)},u.Effect.prototype.setTextureFromPostProcess=function(E,U){this._engine.setTextureFromPostProcess(this._samplers[E],U,E)},u.Effect.prototype.setTextureFromPostProcessOutput=function(E,U){this._engine.setTextureFromPostProcessOutput(this._samplers[E],U,E)};class d{static get ForceGLSL(){return f.e.ForceGLSL}static set ForceGLSL(E){f.e.ForceGLSL=E}static RegisterShaderCodeProcessing(E,U){f.e.RegisterShaderCodeProcessing(E,U)}get name(){return this._effectWrapper.name}set name(E){this._effectWrapper.name=E}get alphaMode(){return this._effectWrapper.alphaMode}set alphaMode(E){this._effectWrapper.alphaMode=E}get samples(){return this._samples}set samples(E){this._samples=Math.min(E,this._engine.getCaps().maxMSAASamples),this._textures.forEach((E=>{E.setSamples(this._samples)}))}get shaderLanguage(){return this._shaderLanguage}getEffectName(){return this._fragmentUrl}set onActivate(E){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),E&&(this._onActivateObserver=this.onActivateObservable.add(E))}set onSizeChanged(E){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(E)}set onApply(E){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(E)}set onBeforeRender(E){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(E)}set onAfterRender(E){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(E)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(E){this._forcedOutputTexture=E}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.du(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(E,U,g,N,u,s){var C;let B=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,P=arguments.length>7?arguments[7]:void 0,F=arguments.length>8?arguments[8]:void 0,I=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,y=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0,h=arguments.length>11&&void 0!==arguments[11]?arguments[11]:"postprocess",V=arguments.length>12?arguments[12]:void 0,e=arguments.length>13&&void 0!==arguments[13]&&arguments[13],x=arguments.length>14&&void 0!==arguments[14]?arguments[14]:5,l=arguments.length>15?arguments[15]:void 0,Y=arguments.length>16?arguments[16]:void 0;this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.Mg=!0,this.forceAutoClearInAlphaMode=!1,this.animations=[],this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._webGPUReady=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new L.e(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new S.Vector2(1,1),this._texelSize=S.Vector2.Zero(),this.onActivateObservable=new D.b,this.onSizeChangedObservable=new D.b,this.onApplyObservable=new D.b,this.onBeforeRenderObservable=new D.b,this.onAfterRenderObservable=new D.b,this.hg=new D.b;let t,G=1,b=null;if(g&&!Array.isArray(g)){const E=g;g=E.uniforms??null,N=E.samplers??null,G=E.size??1,s=E.camera??null,B=E.samplingMode??1,P=E.fU,F=E.reusable,I=Array.isArray(E.defines)?E.defines.join("\n"):E.defines??null,y=E.textureType??0,h=E.vertexUrl??"postprocess",V=E.indexParameters,e=E.blockCompilation??!1,x=E.textureFormat??5,l=E.shaderLanguage??0,b=E.uniformBuffers??null,Y=E.extraInitializations,t=E.effectWrapper}else u&&(G="number"===typeof u?u:{width:u.width,height:u.height});if(this._useExistingThinPostProcess=!!t,this._effectWrapper=t??new f.e({name:E,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:U,fU:P||(null===(C=s)||void 0===C?void 0:C.tE().getEngine()),uniforms:g,samplers:N,uniformBuffers:b,defines:I,vertexUrl:h,indexParameters:V,blockCompilation:!0,shaderLanguage:l,extraInitializations:void 0}),this.name=E,this.onEffectCreatedObservable=this._effectWrapper.onEffectCreatedObservable,null!=s?(this._camera=s,this._scene=s.tE(),s.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):P&&(this._engine=P,this._engine.postProcesses.push(this)),this._options=G,this.renderTargetSamplingMode=B||1,this._reusable=F||!1,this._textureType=y,this._textureFormat=x,this._shaderLanguage=l||0,this._samplers=N||[],-1===this._samplers.indexOf("textureSampler")&&this._samplers.push("textureSampler"),this._fragmentUrl=U,this._vertexUrl=h,this._parameters=g||[],-1===this._parameters.indexOf("scale")&&this._parameters.push("scale"),this._uniformBuffers=b||[],this._indexParameters=V,!this._useExistingThinPostProcess){this._webGPUReady=1===this._shaderLanguage;const E=[];this._gatherImports(this._engine.isWebGPU&&!d.ForceGLSL,E),this._effectWrapper._webGPUReady=this._webGPUReady,this._effectWrapper._postConstructor(e,I,Y,E)}}_gatherImports(){let E=arguments.length>1?arguments[1]:void 0;arguments.length>0&&void 0!==arguments[0]&&arguments[0]&&this._webGPUReady?E.push(Promise.all([g.e(53).then(g.bind(g,14871))])):E.push(Promise.all([Promise.resolve().then(g.bind(g,12453))]))}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._effectWrapper.drawWrapper.effect}shareOutputWith(E){return this._disposeTextures(),this._shareOutputWithPostProcess=E,this}useOwnOutput(){0==this._textures.length&&(this._textures=new L.e(2)),this._shareOutputWithPostProcess=null}updateEffect(){let E=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,g=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,N=arguments.length>3?arguments[3]:void 0,L=arguments.length>4?arguments[4]:void 0,D=arguments.length>5?arguments[5]:void 0,S=arguments.length>6?arguments[6]:void 0,u=arguments.length>7?arguments[7]:void 0;this._effectWrapper.updateEffect(E,U,g,N,L,D,S,u),this._postProcessDefines=Array.isArray(this._effectWrapper.options.defines)?this._effectWrapper.options.defines.join("\n"):this._effectWrapper.options.defines}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(E,U){let g=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;for(let L=0;L<this._textureCache.length;L++)if(this._textureCache[L].texture.width===E.width&&this._textureCache[L].texture.height===E.height&&this._textureCache[L].postProcessChannel===g&&this._textureCache[L].texture._generateDepthBuffer===U.generateDepthBuffer&&this._textureCache[L].texture.samples===U.samples)return this._textureCache[L].texture;const N=this._engine.createRenderTargetTexture(E,U);return this._textureCache.push({texture:N,postProcessChannel:g,lastUsedRenderId:-1}),N}_flushTextureCache(){const E=this._renderId;for(let U=this._textureCache.length-1;U>=0;U--)if(E-this._textureCache[U].lastUsedRenderId>100){let E=!1;for(let g=0;g<this._textures.length;g++)if(this._textures.data[g]===this._textureCache[U].texture){E=!0;break}E||(this._textureCache[U].texture.dispose(),this._textureCache.splice(U,1))}}resize(E,U){let g=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,N=arguments.length>3&&void 0!==arguments[3]&&arguments[3],L=arguments.length>4&&void 0!==arguments[4]&&arguments[4];this._textures.length>0&&this._textures.reset(),this.width=E,this.height=U;let D=null;if(g)for(let s=0;s<g._postProcesses.length;s++)if(null!==g._postProcesses[s]){D=g._postProcesses[s];break}const S={width:this.width,height:this.height},u={generateMipMaps:N,generateDepthBuffer:L||D===this,generateStencilBuffer:(L||D===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples,label:"PostProcessRTT-"+this.name};this._textures.push(this._createRenderTargetTexture(S,u,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(S,u,1)),this._texelSize.du(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}_getTarget(){let E;if(this._shareOutputWithPostProcess)E=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)E=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{let U;E=this.inputTexture;for(let g=0;g<this._textureCache.length;g++)if(this._textureCache[g].texture===E){U=this._textureCache[g];break}U&&(U.lastUsedRenderId=this._renderId)}return E}activate(E){var U,g;let N=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,L=arguments.length>2?arguments[2]:void 0;const D=null===E||void 0!==E.cameraRigMode?E||this._camera:null,S=(null===D||void 0===D?void 0:D.tE())??E,u=S.getEngine(),s=u.getCaps().maxTextureSize,C=(N?N.width:this._engine.getRenderWidth(!0))*this._options|0,B=(N?N.height:this._engine.getRenderHeight(!0))*this._options|0;let P=this._options.width||C,f=this._options.height||B;const d=7!==this.renderTargetSamplingMode&&1!==this.renderTargetSamplingMode&&2!==this.renderTargetSamplingMode;let I=null;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const E=u.currentViewport;E&&(P*=E.width,f*=E.height)}(d||this.alwaysForcePOT)&&(this._options.width||(P=u.needPOTTextures?(0,F.f)(P,s,this.scaleMode):P),this._options.height||(f=u.needPOTTextures?(0,F.f)(f,s,this.scaleMode):f)),this.width===P&&this.height===f&&(I=this._getTarget())||this.resize(P,f,D,d,L),this._textures.forEach((E=>{E.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(E,this.samples)})),this._flushTextureCache(),this._renderId++}return I||(I=this._getTarget()),this.enablePixelPerfectMode?(this._scaleRatio.du(C/P,B/f),this._engine.bindFramebuffer(I,0,C,B,this.forceFullscreenViewport)):(this._scaleRatio.du(1,1),this._engine.bindFramebuffer(I,0,void 0,void 0,this.forceFullscreenViewport)),null===(U=(g=this._engine)._debugInsertMarker)||void 0===U||U.call(g,`post process ${this.name} input`),this.onActivateObservable.notifyObservers(D),this.Mg&&(0===this.alphaMode||this.forceAutoClearInAlphaMode)&&this._engine.clear(this.clearColor?this.clearColor:S.clearColor,S._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),I}get isSupported(){return this._effectWrapper.drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){return this._effectWrapper.isReady()}apply(){if(!this._effectWrapper.isReady())return null;let E;var U;(this._engine.enableEffect(this._effectWrapper.drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a),this._engine.setAlphaMode(this.alphaMode),E=this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?this._forcedOutputTexture:this.inputTexture,this.externalTextureSamplerBinding)||this._effectWrapper.drawWrapper.effect._bindTexture("textureSampler",null===(U=E)||void 0===U?void 0:U.texture);return this._effectWrapper.drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._effectWrapper.drawWrapper.effect),this._effectWrapper.bind(!0),this._effectWrapper.drawWrapper.effect}_disposeTextures(){this._shareOutputWithPostProcess||this._forcedOutputTexture?this._disposeTextureCache():(this._disposeTextureCache(),this._textures.dispose())}_disposeTextureCache(){for(let E=this._textureCache.length-1;E>=0;E--)this._textureCache[E].texture.dispose();this._textureCache.length=0}setPrePassRenderer(E){return!!this._prePassEffectConfiguration&&(this._prePassEffectConfiguration=E.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0)}dispose(E){let U;if(E=E||this._camera,this._useExistingThinPostProcess||this._effectWrapper.dispose(),this._disposeTextures(),this._scene&&(U=this._scene.postProcesses.indexOf(this),-1!==U&&this._scene.postProcesses.splice(U,1)),this._parentContainer){const E=this._parentContainer.postProcesses.indexOf(this);E>-1&&this._parentContainer.postProcesses.splice(E,1),this._parentContainer=null}if(U=this._engine.postProcesses.indexOf(this),-1!==U&&this._engine.postProcesses.splice(U,1),this.hg.notifyObservers(),E){if(E.detachPostProcess(this),U=E._postProcesses.indexOf(this),0===U&&E._postProcesses.length>0){const E=this._camera._getFirstPostProcess();E&&E.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear(),this.onEffectCreatedObservable.clear()}}serialize(){const E=C.b.Serialize(this),U=this.getCamera()||this._scene&&this._scene.activeCamera;return E.customType="BABYLON."+this.getClassName(),E.cameraId=U?U.id:null,E.reusable=this._reusable,E.textureType=this._textureType,E.fragmentUrl=this._fragmentUrl,E.parameters=this._parameters,E.samplers=this._samplers,E.uniformBuffers=this._uniformBuffers,E.options=this._options,E.defines=this._postProcessDefines,E.textureFormat=this._textureFormat,E.vertexUrl=this._vertexUrl,E.indexParameters=this._indexParameters,E}clone(){const E=this.serialize();E._engine=this._engine,E.cameraId=null;const U=d.Parse(E,this._scene,"");return U?(U.onActivateObservable=this.onActivateObservable.clone(),U.onSizeChangedObservable=this.onSizeChangedObservable.clone(),U.onApplyObservable=this.onApplyObservable.clone(),U.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),U.onAfterRenderObservable=this.onAfterRenderObservable.clone(),U._prePassEffectConfiguration=this._prePassEffectConfiguration,U):null}static Parse(E,U,g){const N=(0,B.d)(E.customType);if(!N||!N._Parse)return null;const L=U?U.getCameraById(E.cameraId):null;return N._Parse(E,L,U,g)}static _Parse(E,U,g,N){return C.b.Parse((()=>new d(E.name,E.fragmentUrl,E.parameters,E.samplers,E.options,U,E.renderTargetSamplingMode,E._engine,E.reusable,E.defines,E.textureType,E.vertexUrl,E.indexParameters,!1,E.textureFormat)),E,g,N)}}(0,N.e)([(0,s.E)()],d.prototype,"uniqueId",void 0),(0,N.e)([(0,s.E)()],d.prototype,"name",null),(0,N.e)([(0,s.E)()],d.prototype,"width",void 0),(0,N.e)([(0,s.E)()],d.prototype,"height",void 0),(0,N.e)([(0,s.E)()],d.prototype,"renderTargetSamplingMode",void 0),(0,N.e)([(0,s.l)()],d.prototype,"clearColor",void 0),(0,N.e)([(0,s.E)()],d.prototype,"Mg",void 0),(0,N.e)([(0,s.E)()],d.prototype,"forceAutoClearInAlphaMode",void 0),(0,N.e)([(0,s.E)()],d.prototype,"alphaMode",null),(0,N.e)([(0,s.E)()],d.prototype,"alphaConstants",void 0),(0,N.e)([(0,s.E)()],d.prototype,"enablePixelPerfectMode",void 0),(0,N.e)([(0,s.E)()],d.prototype,"forceFullscreenViewport",void 0),(0,N.e)([(0,s.E)()],d.prototype,"scaleMode",void 0),(0,N.e)([(0,s.E)()],d.prototype,"alwaysForcePOT",void 0),(0,N.e)([(0,s.E)("samples")],d.prototype,"_samples",void 0),(0,N.e)([(0,s.E)()],d.prototype,"adaptScaleToCurrentViewport",void 0),(0,B.f)("BABYLON.PostProcess",d)},12453:(E,U,g)=>{g.r(U),g.d(U,{postprocessVertexShader:()=>S});var N=g(12250);const L="postprocessVertexShader",D="attribute vec2 position;uniform vec2 scale;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=(position*madd+madd)*scale;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";N.e.ShadersStore[L]||(N.e.ShadersStore[L]=D);const S={name:L,shader:D}}}]);