"use strict";(self.pp3k1ov3ibi=self.pp3k1ov3ibi||[]).push([[18],{12547:(M,Z,P)=>{P(12260).e.prototype.createDepthStencilTexture=function(M,Z,P){if(Z.isCube){const P=M.width||M;return this._createDepthStencilCubeTexture(P,Z)}return this._createDepthStencilTexture(M,Z,P)}},12530:(M,Z,P)=>{P(12490).ThinEngine.prototype.setAlphaMode=function(M){let Z=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._alphaMode!==M){switch(M){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0}Z||(this.depthCullingState.depthMask=0===M),this._alphaMode=M}else if(!Z){const Z=0===M;this.depthCullingState.depthMask!==Z&&(this.depthCullingState.depthMask=Z)}}},12533:(M,Z,P)=>{var x=P(12490);x.ThinEngine.prototype.updateDynamicIndexBuffer=function(M,Z){let P;this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(M),P=M.is32Bits?Z instanceof Uint32Array?Z:new Uint32Array(Z):Z instanceof Uint16Array?Z:new Uint16Array(Z),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,P,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()},x.ThinEngine.prototype.updateDynamicVertexBuffer=function(M,Z,P,x){this.bindArrayBuffer(M),void 0===P&&(P=0);const c=Z.byteLength||Z.length;void 0===x||x>=c&&0===P?Z instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,P,new Float32Array(Z)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,P,Z):Z instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,P,new Float32Array(Z).subarray(0,x/4)):(Z=Z instanceof ArrayBuffer?new Uint8Array(Z,0,x):new Uint8Array(Z.buffer,Z.byteOffset,x),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,P,Z)),this._resetVertexBufferBinding()}},12537:(M,Z,P)=>{var x=P(12291),c=P(12199),w=P(12490),v=P(12544),G=P(12522);class mM extends v.b{setDepthStencilTexture(M){let Z=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(super.setDepthStencilTexture(M,Z),!M)return;const P=this._engine,x=this._context,c=M._hardwareTexture;if(c&&M._autoMSAAManagement&&this._MSAAFramebuffer){const Z=P._currentFramebuffer;P._bindUnboundFramebuffer(this._MSAAFramebuffer),x.framebufferRenderbuffer(x.FRAMEBUFFER,(0,G.d)(M.format)?x.DEPTH_STENCIL_ATTACHMENT:x.DEPTH_ATTACHMENT,x.RENDERBUFFER,c.getMSAARenderBuffer()),P._bindUnboundFramebuffer(Z)}}constructor(M,Z,P,x,c){super(M,Z,P,x),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._disposeOnlyFramebuffers=!1,this._currentLOD=0,this._context=c}_cloneRenderTargetWrapper(){let M=null;return this._colorTextureArray&&this._depthStencilTextureArray?(M=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),M.texture.isReady=!0):M=super._cloneRenderTargetWrapper(),M}_swapRenderTargetWrapper(M){super._swapRenderTargetWrapper(M),M._framebuffer=this._framebuffer,M._depthStencilBuffer=this._depthStencilBuffer,M._MSAAFramebuffer=this._MSAAFramebuffer,M._colorTextureArray=this._colorTextureArray,M._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}createDepthStencilTexture(){let M=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,Z=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],P=arguments.length>2&&void 0!==arguments[2]&&arguments[2],x=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14,w=arguments.length>5?arguments[5]:void 0;if(this._depthStencilBuffer){const M=this._engine,Z=M._currentFramebuffer,P=this._context;M._bindUnboundFramebuffer(this._framebuffer),P.framebufferRenderbuffer(P.FRAMEBUFFER,P.DEPTH_STENCIL_ATTACHMENT,P.RENDERBUFFER,null),P.framebufferRenderbuffer(P.FRAMEBUFFER,P.DEPTH_ATTACHMENT,P.RENDERBUFFER,null),P.framebufferRenderbuffer(P.FRAMEBUFFER,P.STENCIL_ATTACHMENT,P.RENDERBUFFER,null),M._bindUnboundFramebuffer(Z),P.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null}return super.createDepthStencilTexture(M,Z,P,x,c,w)}shareDepth(M){super.shareDepth(M);const Z=this._context,P=this._depthStencilBuffer,x=M._MSAAFramebuffer||M._framebuffer,c=this._engine;M._depthStencilBuffer&&M._depthStencilBuffer!==P&&Z.deleteRenderbuffer(M._depthStencilBuffer),M._depthStencilBuffer=P;const w=M._generateStencilBuffer?Z.DEPTH_STENCIL_ATTACHMENT:Z.DEPTH_ATTACHMENT;c._bindUnboundFramebuffer(x),Z.framebufferRenderbuffer(Z.FRAMEBUFFER,w,Z.RENDERBUFFER,P),c._bindUnboundFramebuffer(null)}_bindTextureRenderTarget(M){let Z=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,P=arguments.length>2?arguments[2]:void 0,x=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const c=M._hardwareTexture;if(!c)return;const w=this._framebuffer,v=this._engine,G=v._currentFramebuffer;let mM;if(v._bindUnboundFramebuffer(w),v.webGLVersion>1){const w=this._context;var K;if(mM=w["COLOR_ATTACHMENT"+Z],M.is2DArray||M.is3D)P=P??(null===(K=this.layerIndices)||void 0===K?void 0:K[Z])??0,w.framebufferTextureLayer(w.FRAMEBUFFER,mM,c.underlyingResource,x,P);else if(M.isCube){var d;P=P??(null===(d=this.faceIndices)||void 0===d?void 0:d[Z])??0,w.framebufferTexture2D(w.FRAMEBUFFER,mM,w.TEXTURE_CUBE_MAP_POSITIVE_X+P,c.underlyingResource,x)}else w.framebufferTexture2D(w.FRAMEBUFFER,mM,w.TEXTURE_2D,c.underlyingResource,x)}else{const M=this._context;mM=M["COLOR_ATTACHMENT"+Z+"_WEBGL"];const w=void 0!==P?M.TEXTURE_CUBE_MAP_POSITIVE_X+P:M.TEXTURE_2D;M.framebufferTexture2D(M.FRAMEBUFFER,mM,w,c.underlyingResource,x)}if(M._autoMSAAManagement&&this._MSAAFramebuffer){const M=this._context;v._bindUnboundFramebuffer(this._MSAAFramebuffer),M.framebufferRenderbuffer(M.FRAMEBUFFER,mM,M.RENDERBUFFER,c.getMSAARenderBuffer())}v._bindUnboundFramebuffer(G)}setTexture(M){let Z=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,P=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];super.setTexture(M,Z,P),this._bindTextureRenderTarget(M,Z)}setLayerAndFaceIndices(M,Z){var P;if(super.setLayerAndFaceIndices(M,Z),!this.textures||!this.layerIndices||!this.faceIndices)return;const x=(null===(P=this._attachments)||void 0===P?void 0:P.length)??this.textures.length;for(let c=0;c<x;c++){const M=this.textures[c];M&&(M.is2DArray||M.is3D?this._bindTextureRenderTarget(M,c,this.layerIndices[c]):M.isCube?this._bindTextureRenderTarget(M,c,this.faceIndices[c]):this._bindTextureRenderTarget(M,c))}}setLayerAndFaceIndex(){let M=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,Z=arguments.length>1?arguments[1]:void 0,P=arguments.length>2?arguments[2]:void 0;if(super.setLayerAndFaceIndex(M,Z,P),!this.textures||!this.layerIndices||!this.faceIndices)return;const x=this.textures[M];x.is2DArray||x.is3D?this._bindTextureRenderTarget(this.textures[M],M,this.layerIndices[M]):x.isCube&&this._bindTextureRenderTarget(this.textures[M],M,this.faceIndices[M])}resolveMSAATextures(){const M=this._engine,Z=M._currentFramebuffer;M._bindUnboundFramebuffer(this._MSAAFramebuffer),super.resolveMSAATextures(),M._bindUnboundFramebuffer(Z)}dispose(){let M=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._disposeOnlyFramebuffers;const Z=this._context;M||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(Z.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(Z.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(Z.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(M)}}P(12547);w.ThinEngine.prototype._createHardwareRenderTargetWrapper=function(M,Z,P){const x=new mM(M,Z,P,this,this._gl);return this._renderTargetWrapperCache.push(x),x},w.ThinEngine.prototype.createRenderTargetTexture=function(M,Z){const P=this._createHardwareRenderTargetWrapper(!1,!1,M);let x,c,w=!0,v=!1,G=!1,mM=1;void 0!==Z&&"object"===typeof Z&&(w=Z.generateDepthBuffer??!0,v=!!Z.generateStencilBuffer,G=!!Z.noColorAttachment,x=Z.colorAttachment,mM=Z.samples??1,c=Z.label);const K=x||(G?null:this._createInternalTexture(M,Z,!0,5)),d=M.width||M,O=M.height||M,H=this._currentFramebuffer,j=this._gl,B=j.createFramebuffer();if(this._bindUnboundFramebuffer(B),P._depthStencilBuffer=this._setupFramebufferDepthAttachments(v,w,d,O),!K||K.is2DArray||K.is3D||j.framebufferTexture2D(j.FRAMEBUFFER,j.COLOR_ATTACHMENT0,j.TEXTURE_2D,K._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(H),P.label=c??"RenderTargetWrapper",P._framebuffer=B,P._generateDepthBuffer=w,P._generateStencilBuffer=v,P.setTextures(K),x){if(P._samples=x.samples,x.samples>1){const M=x._hardwareTexture.getMSAARenderBuffer(0);P._MSAAFramebuffer=j.createFramebuffer(),this._bindUnboundFramebuffer(P._MSAAFramebuffer),j.framebufferRenderbuffer(j.FRAMEBUFFER,j.COLOR_ATTACHMENT0,j.RENDERBUFFER,M),this._bindUnboundFramebuffer(null)}}else this.updateRenderTargetTextureSampleCount(P,mM);return P},w.ThinEngine.prototype._createDepthStencilTexture=function(M,Z,P){const w=this._gl,v=M.layers||0,mM=M.depth||0;let K=w.TEXTURE_2D;0!==v?K=w.TEXTURE_2D_ARRAY:0!==mM&&(K=w.TEXTURE_3D);const d=new x.d(this,12);if(d.label=Z.label,!this._caps.depthTextureExtension)return c.d.Error("Depth texture is not supported by your browser or hardware."),d;const O={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...Z};if(this._bindTextureDirectly(K,d,!0),this._setupDepthStencilTexture(d,M,0!==O.comparisonFunction&&O.bilinearFiltering,O.comparisonFunction,O.samples),void 0!==O.depthTextureFormat){if(15!==O.depthTextureFormat&&16!==O.depthTextureFormat&&17!==O.depthTextureFormat&&13!==O.depthTextureFormat&&14!==O.depthTextureFormat&&18!==O.depthTextureFormat)return c.d.Error(`Depth texture ${O.depthTextureFormat} format is not supported.`),d;d.format=O.depthTextureFormat}else d.format=O.generateStencil?13:16;const H=(0,G.d)(d.format),j=this._getWebGLTextureTypeFromDepthTextureFormat(d.format),B=H?w.DEPTH_STENCIL:w.DEPTH_COMPONENT,U=this._getInternalFormatFromDepthTextureFormat(d.format,!0,H);return d.is2DArray?w.texImage3D(K,0,U,d.width,d.height,v,0,B,j,null):d.is3D?w.texImage3D(K,0,U,d.width,d.height,mM,0,B,j,null):w.texImage2D(K,0,U,d.width,d.height,0,B,j,null),this._bindTextureDirectly(K,null),this._internalTexturesCache.push(d),P._depthStencilBuffer&&(w.deleteRenderbuffer(P._depthStencilBuffer),P._depthStencilBuffer=null),this._bindUnboundFramebuffer(P._MSAAFramebuffer??P._framebuffer),P._generateStencilBuffer=H,P._depthStencilTextureWithStencil=H,P._depthStencilBuffer=this._setupFramebufferDepthAttachments(P._generateStencilBuffer,P._generateDepthBuffer,P.width,P.height,P.samples,d.format),this._bindUnboundFramebuffer(null),d},w.ThinEngine.prototype.updateRenderTargetTextureSampleCount=function(M,Z){var P;if(this.webGLVersion<2||!M)return 1;if(M.samples===Z)return Z;const x=this._gl;Z=Math.min(Z,this.getCaps().maxMSAASamples),M._depthStencilBuffer&&(x.deleteRenderbuffer(M._depthStencilBuffer),M._depthStencilBuffer=null),M._MSAAFramebuffer&&(x.deleteFramebuffer(M._MSAAFramebuffer),M._MSAAFramebuffer=null);const c=null===(P=M.texture)||void 0===P?void 0:P._hardwareTexture;if(null===c||void 0===c||c.releaseMSAARenderBuffers(),M.texture&&Z>1&&"function"===typeof x.renderbufferStorageMultisample){const P=x.createFramebuffer();if(!P)throw new Error("Unable to create multi sampled framebuffer");M._MSAAFramebuffer=P,this._bindUnboundFramebuffer(M._MSAAFramebuffer);const w=this._createRenderBuffer(M.texture.width,M.texture.height,Z,-1,this._getRGBABufferInternalSizedFormat(M.texture.type,M.texture.format,M.texture._useSRGBBuffer),x.COLOR_ATTACHMENT0,!1);if(!w)throw new Error("Unable to create multi sampled framebuffer");null===c||void 0===c||c.addMSAARenderBuffer(w)}this._bindUnboundFramebuffer(M._MSAAFramebuffer??M._framebuffer),M.texture&&(M.texture.samples=Z),M._samples=Z;const w=M._depthStencilTexture?M._depthStencilTexture.format:void 0;return M._depthStencilBuffer=this._setupFramebufferDepthAttachments(M._generateStencilBuffer,M._generateDepthBuffer,M.width,M.height,Z,w),this._bindUnboundFramebuffer(null),Z},w.ThinEngine.prototype._setupDepthStencilTexture=function(M,Z,P,x){let c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;const w=Z.width??Z,v=Z.height??Z,G=Z.layers||0,mM=Z.depth||0;M.baseWidth=w,M.baseHeight=v,M.width=w,M.height=v,M.is2DArray=G>0,M.depth=G||mM,M.isReady=!0,M.samples=c,M.generateMipMaps=!1,M.samplingMode=P?2:1,M.type=0,M._comparisonFunction=x;const K=this._gl,d=this._getTextureTarget(M),O=this._getSamplingParameters(M.samplingMode,!1);K.texParameteri(d,K.TEXTURE_MAG_FILTER,O.mag),K.texParameteri(d,K.TEXTURE_MIN_FILTER,O.min),K.texParameteri(d,K.TEXTURE_WRAP_S,K.CLAMP_TO_EDGE),K.texParameteri(d,K.TEXTURE_WRAP_T,K.CLAMP_TO_EDGE),this.webGLVersion>1&&(0===x?(K.texParameteri(d,K.TEXTURE_COMPARE_FUNC,515),K.texParameteri(d,K.TEXTURE_COMPARE_MODE,K.NONE)):(K.texParameteri(d,K.TEXTURE_COMPARE_FUNC,x),K.texParameteri(d,K.TEXTURE_COMPARE_MODE,K.COMPARE_REF_TO_TEXTURE)))}},12514:(M,Z,P)=>{P.d(Z,{c:()=>x});class x{get underlyingResource(){return this._webGLTexture}constructor(){let M=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,Z=arguments.length>1?arguments[1]:void 0;if(this._MSAARenderBuffers=null,this._context=Z,!M&&(M=Z.createTexture(),!M))throw new Error("Unable to create webGL texture");this.set(M)}setUsage(){}set(M){this._webGLTexture=M}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(M){this._MSAARenderBuffers||(this._MSAARenderBuffers=[]),this._MSAARenderBuffers.push(M)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(const M of this._MSAARenderBuffers)this._context.deleteRenderbuffer(M);this._MSAARenderBuffers=null}}getMSAARenderBuffer(){var M;let Z=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return(null===(M=this._MSAARenderBuffers)||void 0===M?void 0:M[Z])??null}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}},12482:(M,Z,P)=>{P.d(Z,{d:()=>l});var x=P(12291),c=P(12225),w=P(12490),v=P(12209);class G{constructor(){let M=arguments.length>0&&void 0!==arguments[0]?arguments[0]:30;this._enabled=!0,this._rollingFrameTime=new mM(M)}sampleFrame(){let M=arguments.length>0&&void 0!==arguments[0]?arguments[0]:v.c.Now;if(this._enabled){if(null!=this._lastFrameTimeMs){const Z=M-this._lastFrameTimeMs;this._rollingFrameTime.add(Z)}this._lastFrameTimeMs=M}}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){const M=this._rollingFrameTime.history(0);return 0===M?0:1e3/M}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}}class mM{constructor(M){this._samples=new Array(M),this.reset()}add(M){let Z;if(this.isSaturated()){const M=this._samples[this._pos];Z=M-this.average,this.average-=Z/(this._sampleCount-1),this._m2-=Z*(M-this.average)}else this._sampleCount++;Z=M-this.average,this.average+=Z/this._sampleCount,this._m2+=Z*(M-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=M,this._pos++,this._pos%=this._samples.length}history(M){if(M>=this._sampleCount||M>=this._samples.length)return 0;const Z=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(Z-M)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(M){const Z=this._samples.length;return(M%Z+Z)%Z}}var K=P(12505),d=P(12199),O=P(12514),H=(P(12530),P(12332));function j(M,Z,P,x){let c,w=1;1===x?c=new Float32Array(Z*P*4):2===x?(c=new Uint16Array(Z*P*4),w=15360):c=7===x?new Uint32Array(Z*P*4):new Uint8Array(Z*P*4);for(let v=0;v<Z;v++)for(let x=0;x<P;x++){const P=3*(x*Z+v),G=4*(x*Z+v);c[G+0]=M[P+0],c[G+1]=M[P+1],c[G+2]=M[P+2],c[G+3]=w}return c}function B(M){return function(Z,P,c,w,v,G,mM,K){let d=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,O=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;const H=M?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,j=M?10:11,B=new x.d(this,j);B.baseWidth=P,B.baseHeight=c,B.baseDepth=w,B.width=P,B.height=c,B.depth=w,B.format=v,B.type=O,B.generateMipMaps=G,B.samplingMode=K,M?B.is3D=!0:B.is2DArray=!0,this._doNotHandleContextLost||(B._bufferView=Z),M?this.updateRawTexture3D(B,Z,v,mM,d,O):this.updateRawTexture2DArray(B,Z,v,mM,d,O),this._bindTextureDirectly(H,B,!0);const U=this._getSamplingParameters(K,G);return this._gl.texParameteri(H,this._gl.TEXTURE_MAG_FILTER,U.mag),this._gl.texParameteri(H,this._gl.TEXTURE_MIN_FILTER,U.min),G&&this._gl.generateMipmap(H),this._bindTextureDirectly(H,null),this._internalTexturesCache.push(B),B}}function U(M){return function(Z,P,x,c){let w=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,v=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;const G=M?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,mM=this._getWebGLTextureType(v),K=this._getInternalFormat(x),d=this._getRGBABufferInternalSizedFormat(v,x);this._bindTextureDirectly(G,Z,!0),this._unpackFlipY(void 0===c||!!c),this._doNotHandleContextLost||(Z._bufferView=P,Z.format=x,Z.invertY=c,Z._compression=w),Z.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),w&&P?this._gl.compressedTexImage3D(G,0,this.getCaps().s3tc[w],Z.width,Z.height,Z.depth,0,P):this._gl.texImage3D(G,0,d,Z.width,Z.height,Z.depth,0,K,mM,P),Z.generateMipMaps&&this._gl.generateMipmap(G),this._bindTextureDirectly(G,null),Z.isReady=!0}}w.ThinEngine.prototype.updateRawTexture=function(M,Z,P,x){let c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,w=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,v=arguments.length>6&&void 0!==arguments[6]&&arguments[6];if(!M)return;const G=this._getRGBABufferInternalSizedFormat(w,P,v),mM=this._getInternalFormat(P),K=this._getWebGLTextureType(w);this._bindTextureDirectly(this._gl.TEXTURE_2D,M,!0),this._unpackFlipY(void 0===x||!!x),this._doNotHandleContextLost||(M._bufferView=Z,M.format=P,M.type=w,M.invertY=x,M._compression=c),M.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),c&&Z?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[c],M.width,M.height,0,Z):this._gl.texImage2D(this._gl.TEXTURE_2D,0,G,M.width,M.height,0,mM,K,Z),M.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),M.isReady=!0},w.ThinEngine.prototype.createRawTexture=function(M,Z,P,c,w,v,G){let mM=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,K=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,d=arguments.length>10&&void 0!==arguments[10]&&arguments[10];const O=new x.d(this,3);O.baseWidth=Z,O.baseHeight=P,O.width=Z,O.height=P,O.format=c,O.generateMipMaps=w,O.samplingMode=G,O.invertY=v,O._compression=mM,O.type=K,O._useSRGBBuffer=this._getUseSRGBBuffer(d,!w),this._doNotHandleContextLost||(O._bufferView=M),this.updateRawTexture(O,M,c,v,mM,K,O._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,O,!0);const H=this._getSamplingParameters(G,w);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,H.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,H.min),w&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(O),O},w.ThinEngine.prototype.createRawCubeTexture=function(M,Z,P,c,w,v,G){let mM=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;const K=this._gl,O=new x.d(this,8);O.isCube=!0,O.format=P,O.type=c,this._doNotHandleContextLost||(O._bufferViewArray=M);const j=this._getWebGLTextureType(c);let B=this._getInternalFormat(P);B===K.RGB&&(B=K.RGBA),j!==K.FLOAT||this._caps.textureFloatLinearFiltering?j!==this._gl.HALF_FLOAT_OES||this._caps.textureHalfFloatLinearFiltering?j!==K.FLOAT||this._caps.textureFloatRender?j!==K.HALF_FLOAT||this._caps.colorBufferFloat||(w=!1,d.d.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(w=!1,d.d.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(w=!1,G=1,d.d.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(w=!1,G=1,d.d.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively."));const U=Z,n=U;O.width=U,O.height=n,O.invertY=v,O._compression=mM;if(!this.needPOTTextures||(0,H.g)(O.width)&&(0,H.g)(O.height)||(w=!1),M)this.updateRawCubeTexture(O,M,P,c,v,mM);else{const M=this._getRGBABufferInternalSizedFormat(c),Z=0;this._bindTextureDirectly(K.TEXTURE_CUBE_MAP,O,!0);for(let P=0;P<6;P++)mM?K.compressedTexImage2D(K.TEXTURE_CUBE_MAP_POSITIVE_X+P,Z,this.getCaps().s3tc[mM],O.width,O.height,0,void 0):K.texImage2D(K.TEXTURE_CUBE_MAP_POSITIVE_X+P,Z,M,O.width,O.height,0,B,j,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,O,!0),M&&w&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);const L=this._getSamplingParameters(G,w);return K.texParameteri(K.TEXTURE_CUBE_MAP,K.TEXTURE_MAG_FILTER,L.mag),K.texParameteri(K.TEXTURE_CUBE_MAP,K.TEXTURE_MIN_FILTER,L.min),K.texParameteri(K.TEXTURE_CUBE_MAP,K.TEXTURE_WRAP_S,K.CLAMP_TO_EDGE),K.texParameteri(K.TEXTURE_CUBE_MAP,K.TEXTURE_WRAP_T,K.CLAMP_TO_EDGE),this._bindTextureDirectly(K.TEXTURE_CUBE_MAP,null),O.generateMipMaps=w,O.samplingMode=G,O.isReady=!0,O},w.ThinEngine.prototype.updateRawCubeTexture=function(M,Z,P,x,c){let w=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,v=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;M._bufferViewArray=Z,M.format=P,M.type=x,M.invertY=c,M._compression=w;const G=this._gl,mM=this._getWebGLTextureType(x);let K=this._getInternalFormat(P);const d=this._getRGBABufferInternalSizedFormat(x);let O=!1;K===G.RGB&&(K=G.RGBA,O=!0),this._bindTextureDirectly(G.TEXTURE_CUBE_MAP,M,!0),this._unpackFlipY(void 0===c||!!c),M.width%4!==0&&G.pixelStorei(G.UNPACK_ALIGNMENT,1);for(let H=0;H<6;H++){let P=Z[H];w?G.compressedTexImage2D(G.TEXTURE_CUBE_MAP_POSITIVE_X+H,v,this.getCaps().s3tc[w],M.width,M.height,0,P):(O&&(P=j(P,M.width,M.height,x)),G.texImage2D(G.TEXTURE_CUBE_MAP_POSITIVE_X+H,v,d,M.width,M.height,0,K,mM,P))}(!this.needPOTTextures||(0,H.g)(M.width)&&(0,H.g)(M.height))&&M.generateMipMaps&&0===v&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),M.isReady=!0},w.ThinEngine.prototype.createRawCubeTextureFromUrl=function(M,Z,P,x,c,w,v,G){let mM=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,K=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,d=arguments.length>10&&void 0!==arguments[10]?arguments[10]:3,O=arguments.length>11&&void 0!==arguments[11]&&arguments[11];const H=this._gl,B=this.createRawCubeTexture(null,P,x,c,!w,O,d,null);null===Z||void 0===Z||Z.addPendingData(B),B.url=M,B.isReady=!1,this._internalTexturesCache.push(B);const U=M=>{if(!B._hardwareTexture)return;const P=B.width,w=v(M);if(w){if(G){const M=this._getWebGLTextureType(c);let Z=this._getInternalFormat(x);const v=this._getRGBABufferInternalSizedFormat(c);let mM=!1;Z===H.RGB&&(Z=H.RGBA,mM=!0),this._bindTextureDirectly(H.TEXTURE_CUBE_MAP,B,!0),this._unpackFlipY(!1);const K=G(w);for(let x=0;x<K.length;x++){const w=P>>x;for(let P=0;P<6;P++){let G=K[x][P];mM&&(G=j(G,w,w,c)),H.texImage2D(P,x,v,w,w,0,Z,M,G)}}this._bindTextureDirectly(H.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(B,w,x,c,O);B.isReady=!0,null===Z||void 0===Z||Z.removePendingData(B),B.onLoadedObservable.notifyObservers(B),B.onLoadedObservable.clear(),mM&&mM()}};return this._loadFile(M,(M=>{U(M)}),void 0,null===Z||void 0===Z?void 0:Z.offlineProvider,!0,((M,P)=>{null===Z||void 0===Z||Z.removePendingData(B),K&&M&&K(M.status+" "+M.statusText,P)})),B},w.ThinEngine.prototype.createRawTexture2DArray=B(!1),w.ThinEngine.prototype.createRawTexture3D=B(!0),w.ThinEngine.prototype.updateRawTexture2DArray=U(!1),w.ThinEngine.prototype.updateRawTexture3D=U(!0);var n=P(12254);w.ThinEngine.prototype._readTexturePixelsSync=function(M,Z,P){let x=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,w=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,v=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],G=arguments.length>7&&void 0!==arguments[7]&&arguments[7],mM=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,K=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;const d=this._gl;if(!d)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){const M=d.createFramebuffer();if(!M)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=M}var O,H;(d.bindFramebuffer(d.FRAMEBUFFER,this._dummyFramebuffer),x>-1)?d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_CUBE_MAP_POSITIVE_X+x,null===(O=M._hardwareTexture)||void 0===O?void 0:O.underlyingResource,c):d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,null===(H=M._hardwareTexture)||void 0===H?void 0:H.underlyingResource,c);let j=void 0!==M.type?this._getWebGLTextureType(M.type):d.UNSIGNED_BYTE;if(G)w||(w=(0,n.s)(M.type,4*Z*P));else if(j===d.UNSIGNED_BYTE)w||(w=new Uint8Array(4*Z*P)),j=d.UNSIGNED_BYTE;else w||(w=new Float32Array(4*Z*P)),j=d.FLOAT;return v&&this.flushFramebuffer(),d.readPixels(mM,K,Z,P,d.RGBA,j,w),d.bindFramebuffer(d.FRAMEBUFFER,this._currentFramebuffer),w},w.ThinEngine.prototype._readTexturePixels=function(M,Z,P){let x=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,w=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,v=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],G=arguments.length>7&&void 0!==arguments[7]&&arguments[7],mM=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,K=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;return Promise.resolve(this._readTexturePixelsSync(M,Z,P,x,c,w,v,G,mM,K))};P(12533);w.ThinEngine.prototype._createDepthStencilCubeTexture=function(M,Z){const P=new x.d(this,12);if(P.isCube=!0,1===this.webGLVersion)return d.d.Error("Depth cube texture is not supported by WebGL 1."),P;const c={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...Z},w=this._gl;this._bindTextureDirectly(w.TEXTURE_CUBE_MAP,P,!0),this._setupDepthStencilTexture(P,M,c.bilinearFiltering,c.comparisonFunction);for(let x=0;x<6;x++)c.generateStencil?w.texImage2D(w.TEXTURE_CUBE_MAP_POSITIVE_X+x,0,w.DEPTH24_STENCIL8,M,M,0,w.DEPTH_STENCIL,w.UNSIGNED_INT_24_8,null):w.texImage2D(w.TEXTURE_CUBE_MAP_POSITIVE_X+x,0,w.DEPTH_COMPONENT24,M,M,0,w.DEPTH_COMPONENT,w.UNSIGNED_INT,null);return this._bindTextureDirectly(w.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(P),P},w.ThinEngine.prototype._setCubeMapTextureParams=function(M,Z,P){const x=this._gl;x.texParameteri(x.TEXTURE_CUBE_MAP,x.TEXTURE_MAG_FILTER,x.LINEAR),x.texParameteri(x.TEXTURE_CUBE_MAP,x.TEXTURE_MIN_FILTER,Z?x.LINEAR_MIPMAP_LINEAR:x.LINEAR),x.texParameteri(x.TEXTURE_CUBE_MAP,x.TEXTURE_WRAP_S,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_CUBE_MAP,x.TEXTURE_WRAP_T,x.CLAMP_TO_EDGE),M.samplingMode=Z?3:2,Z&&this.getCaps().textureMaxLevel&&void 0!==P&&P>0&&(x.texParameteri(x.TEXTURE_CUBE_MAP,x.TEXTURE_MAX_LEVEL,P),M._maxLodLevel=P),this._bindTextureDirectly(x.TEXTURE_CUBE_MAP,null)},w.ThinEngine.prototype.createCubeTexture=function(M,Z,P,x){let c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,w=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,v=arguments.length>6?arguments[6]:void 0,G=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,mM=arguments.length>8&&void 0!==arguments[8]&&arguments[8],K=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,O=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0,j=arguments.length>11&&void 0!==arguments[11]?arguments[11]:null,B=arguments.length>13&&void 0!==arguments[13]&&arguments[13],U=arguments.length>14&&void 0!==arguments[14]?arguments[14]:null;const n=this._gl;return this.createCubeTextureBase(M,Z,P,!!x,c,w,v,G,mM,K,O,j,(M=>this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,M,!0)),((M,Z)=>{const P=this.needPOTTextures?(0,H.e)(Z[0].width,this._caps.maxCubemapTextureSize):Z[0].width,w=P,G=[n.TEXTURE_CUBE_MAP_POSITIVE_X,n.TEXTURE_CUBE_MAP_POSITIVE_Y,n.TEXTURE_CUBE_MAP_POSITIVE_Z,n.TEXTURE_CUBE_MAP_NEGATIVE_X,n.TEXTURE_CUBE_MAP_NEGATIVE_Y,n.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,M,!0),this._unpackFlipY(!1);const mM=v?this._getInternalFormat(v,M._useSRGBBuffer):M._useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:n.RGBA;let K=v?this._getInternalFormat(v):n.RGBA;M._useSRGBBuffer&&1===this.webGLVersion&&(K=mM);for(let x=0;x<G.length;x++)if(Z[x].width!==P||Z[x].height!==w){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext)return void d.d.Warn("Cannot create canvas to resize texture.");this._workingCanvas.width=P,this._workingCanvas.height=w,this._workingContext.drawImage(Z[x],0,0,Z[x].width,Z[x].height,0,0,P,w),n.texImage2D(G[x],0,mM,K,n.UNSIGNED_BYTE,this._workingCanvas)}else n.texImage2D(G[x],0,mM,K,n.UNSIGNED_BYTE,Z[x]);x||n.generateMipmap(n.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(M,!x),M.width=P,M.height=w,M.isReady=!0,v&&(M.format=v),M.onLoadedObservable.notifyObservers(M),M.onLoadedObservable.clear(),c&&c()}),!!B,U)},w.ThinEngine.prototype.generateMipMapsForCubemap=function(M){let Z=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(M.generateMipMaps){const P=this._gl;this._bindTextureDirectly(P.TEXTURE_CUBE_MAP,M,!0),P.generateMipmap(P.TEXTURE_CUBE_MAP),Z&&this._bindTextureDirectly(P.TEXTURE_CUBE_MAP,null)}};P(12537);w.ThinEngine.prototype.setDepthStencilTexture=function(M,Z,P,x){void 0!==M&&(Z&&(this._boundUniforms[M]=Z),P&&P.depthStencilTexture?this._setTexture(M,P,!1,!0,x):this._setTexture(M,null,void 0,void 0,x))},w.ThinEngine.prototype.createRenderTargetCubeTexture=function(M,Z){const P=this._createHardwareRenderTargetWrapper(!1,!0,M),c={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,...Z};c.generateStencilBuffer=c.generateDepthBuffer&&c.generateStencilBuffer,(1!==c.type||this._caps.textureFloatLinearFiltering)&&(2!==c.type||this._caps.textureHalfFloatLinearFiltering)||(c.samplingMode=1);const w=this._gl,v=new x.d(this,5);this._bindTextureDirectly(w.TEXTURE_CUBE_MAP,v,!0);const G=this._getSamplingParameters(c.samplingMode,c.generateMipMaps);1!==c.type||this._caps.textureFloat||(c.type=0,d.d.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),w.texParameteri(w.TEXTURE_CUBE_MAP,w.TEXTURE_MAG_FILTER,G.mag),w.texParameteri(w.TEXTURE_CUBE_MAP,w.TEXTURE_MIN_FILTER,G.min),w.texParameteri(w.TEXTURE_CUBE_MAP,w.TEXTURE_WRAP_S,w.CLAMP_TO_EDGE),w.texParameteri(w.TEXTURE_CUBE_MAP,w.TEXTURE_WRAP_T,w.CLAMP_TO_EDGE);for(let x=0;x<6;x++)w.texImage2D(w.TEXTURE_CUBE_MAP_POSITIVE_X+x,0,this._getRGBABufferInternalSizedFormat(c.type,c.format),M,M,0,this._getInternalFormat(c.format),this._getWebGLTextureType(c.type),null);const mM=w.createFramebuffer();return this._bindUnboundFramebuffer(mM),P._depthStencilBuffer=this._setupFramebufferDepthAttachments(c.generateStencilBuffer,c.generateDepthBuffer,M,M),c.generateMipMaps&&w.generateMipmap(w.TEXTURE_CUBE_MAP),this._bindTextureDirectly(w.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),P._framebuffer=mM,P._generateDepthBuffer=c.generateDepthBuffer,P._generateStencilBuffer=c.generateStencilBuffer,v.width=M,v.height=M,v.isReady=!0,v.isCube=!0,v.samples=1,v.generateMipMaps=c.generateMipMaps,v.samplingMode=c.samplingMode,v.type=c.type,v.format=c.format,this._internalTexturesCache.push(v),P.setTextures(v),P};var L=P(12549),u=P(12390);w.ThinEngine.prototype.createPrefilteredCubeTexture=function(M,Z,c,w){let v=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,G=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,mM=arguments.length>6?arguments[6]:void 0,K=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,O=!(arguments.length>8&&void 0!==arguments[8])||arguments[8];return this.createCubeTexture(M,Z,null,!1,(async M=>{if(!M)return void(v&&v(null));const G=M.texture;if(O?M.info.sphericalPolynomial&&(G._sphericalPolynomial=M.info.sphericalPolynomial):G._sphericalPolynomial=new L.h,G._source=9,this.getCaps().textureLOD)return void(v&&v(G));const mM=this._gl,K=M.width;if(!K)return;const{DDSTools:H}=await P.e(29).then(P.bind(P,14839)),j=[];for(let P=0;P<3;P++){const v=1-P/2,O=w,B=Math.log2(K)*c+w,U=O+(B-O)*v,n=Math.round(Math.min(Math.max(U,0),B)),L=new x.d(this,2);if(L.type=G.type,L.format=G.format,L.width=Math.pow(2,Math.max(Math.log2(K)-n,0)),L.height=L.width,L.isCube=!0,L._cachedWrapU=0,L._cachedWrapV=0,this._bindTextureDirectly(mM.TEXTURE_CUBE_MAP,L,!0),L.samplingMode=2,mM.texParameteri(mM.TEXTURE_CUBE_MAP,mM.TEXTURE_MAG_FILTER,mM.LINEAR),mM.texParameteri(mM.TEXTURE_CUBE_MAP,mM.TEXTURE_MIN_FILTER,mM.LINEAR),mM.texParameteri(mM.TEXTURE_CUBE_MAP,mM.TEXTURE_WRAP_S,mM.CLAMP_TO_EDGE),mM.texParameteri(mM.TEXTURE_CUBE_MAP,mM.TEXTURE_WRAP_T,mM.CLAMP_TO_EDGE),M.isDDS){const Z=M.info,P=M.data;this._unpackFlipY(Z.isCompressed),H.UploadDDSLevels(this,L,P,Z,!0,6,n)}else d.d.Warn("DDS is the only prefiltered cube map supported so far.");this._bindTextureDirectly(mM.TEXTURE_CUBE_MAP,null);const N=new u.b(Z);N._isCube=!0,N._texture=L,L.isReady=!0,j.push(N)}G._lodTextureHigh=j[2],G._lodTextureMid=j[1],G._lodTextureLow=j[0],v&&v(G)}),G,mM,K,O,c,w)},w.ThinEngine.prototype.createUniformBuffer=function(M,Z){const P=this._gl.createBuffer();if(!P)throw new Error("Unable to create uniform buffer");const x=new K.c(P);return this.bindUniformBuffer(x),M instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,M,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(M),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),x.references=1,x},w.ThinEngine.prototype.createDynamicUniformBuffer=function(M,Z){const P=this._gl.createBuffer();if(!P)throw new Error("Unable to create dynamic uniform buffer");const x=new K.c(P);return this.bindUniformBuffer(x),M instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,M,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(M),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),x.references=1,x},w.ThinEngine.prototype.updateUniformBuffer=function(M,Z,P,x){this.bindUniformBuffer(M),void 0===P&&(P=0),void 0===x?Z instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,P,Z):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,P,new Float32Array(Z)):Z instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,Z.subarray(P,P+x)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(Z).subarray(P,P+x)),this.bindUniformBuffer(null)},w.ThinEngine.prototype.bindUniformBuffer=function(M){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,M?M.underlyingResource:null)},w.ThinEngine.prototype.bindUniformBufferBase=function(M,Z,P){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,Z,M?M.underlyingResource:null)},w.ThinEngine.prototype.bindUniformBlock=function(M,Z,P){const x=M.program,c=this._gl.getUniformBlockIndex(x,Z);4294967295!==c&&this._gl.uniformBlockBinding(x,c,P)};var N=P(12192),J=P(12260);J.e.prototype.displayLoadingUI=function(){if(!(0,N.p)())return;const M=this.loadingScreen;M&&M.displayLoadingUI()},J.e.prototype.hideLoadingUI=function(){if(!(0,N.p)())return;const M=this._loadingScreen;M&&M.hideLoadingUI()},Object.defineProperty(J.e.prototype,"loadingScreen",{get:function(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=J.e.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen},set:function(M){this._loadingScreen=M},enumerable:!0,configurable:!0}),Object.defineProperty(J.e.prototype,"loadingUIText",{set:function(M){this.loadingScreen.loadingUIText=M},enumerable:!0,configurable:!0}),Object.defineProperty(J.e.prototype,"loadingUIBackgroundColor",{set:function(M){this.loadingScreen.loadingUIBackgroundColor=M},enumerable:!0,configurable:!0}),J.e.prototype.getInputElement=function(){return this._renderingCanvas},J.e.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null},J.e.prototype.getInputElementClientRect=function(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null},J.e.prototype.getAspectRatio=function(M){let Z=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const P=M.viewport;return this.getRenderWidth(Z)*P.width/(this.getRenderHeight(Z)*P.height)},J.e.prototype.getScreenAspectRatio=function(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)},J.e.prototype._verifyPointerLock=function(){var M;null===(M=this._onPointerLockChange)||void 0===M||M.call(this)},J.e.prototype.setAlphaEquation=function(M){if(this._alphaEquation!==M){switch(M){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774)}this._alphaEquation=M}},J.e.prototype.getInputElement=function(){return this._renderingCanvas},J.e.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc},J.e.prototype.setDepthFunction=function(M){this._depthCullingState.depthFunc=M},J.e.prototype.setDepthFunctionToGreater=function(){this.setDepthFunction(516)},J.e.prototype.setDepthFunctionToGreaterOrEqual=function(){this.setDepthFunction(518)},J.e.prototype.setDepthFunctionToLess=function(){this.setDepthFunction(513)},J.e.prototype.setDepthFunctionToLessOrEqual=function(){this.setDepthFunction(515)},J.e.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask},J.e.prototype.setDepthWrite=function(M){this._depthCullingState.depthMask=M},J.e.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest},J.e.prototype.setStencilBuffer=function(M){this._stencilState.stencilTest=M},J.e.prototype.getStencilMask=function(){return this._stencilState.stencilMask},J.e.prototype.setStencilMask=function(M){this._stencilState.stencilMask=M},J.e.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc},J.e.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef},J.e.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask},J.e.prototype.setStencilFunction=function(M){this._stencilState.stencilFunc=M},J.e.prototype.setStencilFunctionReference=function(M){this._stencilState.stencilFuncRef=M},J.e.prototype.setStencilFunctionMask=function(M){this._stencilState.stencilFuncMask=M},J.e.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail},J.e.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail},J.e.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass},J.e.prototype.setStencilOperationFail=function(M){this._stencilState.stencilOpStencilFail=M},J.e.prototype.setStencilOperationDepthFail=function(M){this._stencilState.stencilOpDepthFail=M},J.e.prototype.setStencilOperationPass=function(M){this._stencilState.stencilOpStencilDepthPass=M},J.e.prototype.cacheStencilState=function(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()},J.e.prototype.restoreStencilState=function(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)},J.e.prototype.setAlphaConstants=function(M,Z,P,x){this._alphaState.setAlphaBlendConstants(M,Z,P,x)},J.e.prototype.getAlphaMode=function(){return this._alphaMode},J.e.prototype.getAlphaEquation=function(){return this._alphaEquation},J.e.prototype.getRenderPassNames=function(){return this._renderPassNames},J.e.prototype.getCurrentRenderPassName=function(){return this._renderPassNames[this.currentRenderPassId]},J.e.prototype.createRenderPassId=function(M){const Z=++J.e._RenderPassIdCounter;return this._renderPassNames[Z]=M??"NONAME",Z},J.e.prototype.releaseRenderPassId=function(M){this._renderPassNames[M]=void 0;for(let Z=0;Z<this.scenes.length;++Z){const P=this.scenes[Z];for(let Z=0;Z<P.meshes.length;++Z){const x=P.meshes[Z];if(x.Uc)for(let Z=0;Z<x.Uc.length;++Z){x.Uc[Z]._removeDrawWrapper(M)}}}};P(12547);function t(M){if(M.requestPointerLock){const Z=M.requestPointerLock();Z instanceof Promise?Z.then((()=>{M.focus()})).catch((()=>{})):M.focus()}}var F=P(12572),D=P(12258);class l extends w.ThinEngine{static get NpmPackage(){return J.e.NpmPackage}static get Version(){return J.e.Version}static get Instances(){return c.b.Instances}static get LastCreatedEngine(){return c.b.LastCreatedEngine}static get LastCreatedScene(){return c.b.LastCreatedScene}static DefaultLoadingScreenFactory(M){return J.e.DefaultLoadingScreenFactory(M)}get _supportsHardwareTextureRescaling(){return!!l._RescalePostProcessFactory}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}get performanceMonitor(){return this._performanceMonitor}constructor(M,Z,P){super(M,Z,P,arguments.length>3&&void 0!==arguments[3]&&arguments[3]),this.customAnimationFrameRequester=null,this._performanceMonitor=new G,this._drawCalls=new F.b,M&&(this._features.supportRenderPasses=!0,P=this._creationOptions)}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(M){super._sharedInit(M),function(M,Z,P){M._onCanvasFocus=()=>{M.onCanvasFocusObservable.notifyObservers(M)},M._onCanvasBlur=()=>{M.onCanvasBlurObservable.notifyObservers(M)},M._onCanvasContextMenu=Z=>{M.disableContextMenu&&Z.preventDefault()},Z.addEventListener("focus",M._onCanvasFocus),Z.addEventListener("blur",M._onCanvasBlur),Z.addEventListener("contextmenu",M._onCanvasContextMenu),M._onBlur=()=>{M.disablePerformanceMonitorInBackground&&M.performanceMonitor.disable(),M._windowIsBackground=!0},M._onFocus=()=>{M.disablePerformanceMonitorInBackground&&M.performanceMonitor.enable(),M._windowIsBackground=!1},M._onCanvasPointerOut=P=>{document.elementFromPoint(P.clientX,P.clientY)!==Z&&M.onCanvasPointerOutObservable.notifyObservers(P)};const x=M.getHostWindow();x&&"function"===typeof x.addEventListener&&(x.addEventListener("blur",M._onBlur),x.addEventListener("focus",M._onFocus)),Z.addEventListener("pointerout",M._onCanvasPointerOut),P.doNotHandleTouchAction||function(M){M&&M.setAttribute&&(M.setAttribute("touch-action","none"),M.style.touchAction="none",M.style.webkitTapHighlightColor="transparent")}(Z),!J.e.audioEngine&&P.audioEngine&&J.e.AudioEngineFactory&&(J.e.audioEngine=J.e.AudioEngineFactory(M.getRenderingCanvas(),M.getAudioContext(),M.getAudioDestination())),(0,N.h)()&&(M._onFullscreenChange=()=>{M.isFullscreen=!!document.fullscreenElement,M.isFullscreen&&M._pointerLockRequested&&Z&&t(Z)},document.addEventListener("fullscreenchange",M._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",M._onFullscreenChange,!1),M._onPointerLockChange=()=>{M.isPointerLock=document.pointerLockElement===Z},document.addEventListener("pointerlockchange",M._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",M._onPointerLockChange,!1)),M.enableOfflineSupport=void 0!==J.e.OfflineProviderFactory,M._deterministicLockstep=!!P.deterministicLockstep,M._lockstepMaxSteps=P.lockstepMaxSteps||0,M._timeStep=P.timeStep||1/60}(this,M,this._creationOptions)}resizeImageBitmap(M,Z,P){return function(M,Z,P,x){const c=M.createCanvas(P,x).getContext("2d");if(!c)throw new Error("Unable to get 2d context for resizeImageBitmap");return c.drawImage(Z,0,0),c.getImageData(0,0,P,x).data}(this,M,Z,P)}async _createImageBitmapFromSource(M,Z){return await async function(M,Z,P){return await new Promise(((x,c)=>{const w=new Image;w.onload=()=>{w.decode().then((()=>{M.createImageBitmap(w,P).then((M=>{x(M)}))}))},w.onerror=()=>{c(`Error loading image ${w.src}`)},w.src=Z}))}(this,M,Z)}switchFullscreen(M){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(M)}enterFullscreen(M){this.isFullscreen||(this._pointerLockRequested=M,this._renderingCanvas&&function(M){const Z=M.requestFullscreen||M.webkitRequestFullscreen;Z&&Z.call(M)}(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&function(){const M=document;document.exitFullscreen?document.exitFullscreen():M.webkitCancelFullScreen&&M.webkitCancelFullScreen()}()}setDitheringState(M){M?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(M){M?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}setDirectViewport(M,Z,P,x){const c=this._cachedViewport;return this._cachedViewport=null,this._viewport(M,Z,P,x),c}scissorClear(M,Z,P,x,c){this.enableScissor(M,Z,P,x),this.clear(c,!0,!0,!0),this.disableScissor()}enableScissor(M,Z,P,x){const c=this._gl;c.enable(c.SCISSOR_TEST),c.scissor(M,Z,P,x)}disableScissor(){const M=this._gl;M.disable(M.SCISSOR_TEST)}async _loadFileAsync(M,Z,P){return await new Promise(((x,c)=>{this._loadFile(M,(M=>{x(M)}),void 0,Z,P,((M,Z)=>{c(Z)}))}))}getVertexShaderSource(M){const Z=this._gl.getAttachedShaders(M);return Z?this._gl.getShaderSource(Z[0]):null}getFragmentShaderSource(M){const Z=this._gl.getAttachedShaders(M);return Z?this._gl.getShaderSource(Z[1]):null}set framebufferDimensionsObject(M){this._framebufferDimensionsObject=M,this._framebufferDimensionsObject&&this.onResizeObservable.notifyObservers(this)}_rebuildBuffers(){for(const M of this.scenes)M.resetCachedMaterial(),M._rebuildGeometries();for(const M of this._virtualScenes)M.resetCachedMaterial(),M._rebuildGeometries();super._rebuildBuffers()}getFontOffset(M){return function(M){const Z=document.createElement("span");Z.textContent="Hg",Z.style.font=M;const P=document.createElement("div");P.style.display="inline-block",P.style.width="1px",P.style.height="0px",P.style.verticalAlign="bottom";const x=document.createElement("div");x.style.whiteSpace="nowrap",x.appendChild(Z),x.appendChild(P),document.body.appendChild(x);let c=0,w=0;try{w=P.getBoundingClientRect().top-Z.getBoundingClientRect().top,P.style.verticalAlign="baseline",c=P.getBoundingClientRect().top-Z.getBoundingClientRect().top}finally{document.body.removeChild(x)}return{ascent:c,height:w,descent:w-c}}(M)}_cancelFrame(){if(this.customAnimationFrameRequester){if(0!==this._frameHandler){this._frameHandler=0;const{cancelAnimationFrame:M}=this.customAnimationFrameRequester;M&&M(this.customAnimationFrameRequester.O)}}else super._cancelFrame()}_renderLoop(M){this._processFrame(M),this._activeRenderLoops.length>0&&0===this._frameHandler&&(this.customAnimationFrameRequester?(this.customAnimationFrameRequester.O=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.O):this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()))}enterPointerlock(){this._renderingCanvas&&t(this._renderingCanvas)}exitPointerlock(){document.exitPointerLock&&document.exitPointerLock()}wc(){this._measureFps(),super.wc()}_deletePipelineContext(M){const Z=M;Z&&Z.program&&Z.transformFeedback&&(this.deleteTransformFeedback(Z.transformFeedback),Z.transformFeedback=null),super._deletePipelineContext(M)}createShaderProgram(M,Z,P,x,c){let w=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;c=c||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);const v=super.createShaderProgram(M,Z,P,x,c,w);return this.onAfterShaderCompilationObservable.notifyObservers(this),v}_createShaderProgram(M,Z,P,x){let c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const w=x.createProgram();if(M.program=w,!w)throw new Error("Unable to create program");if(x.attachShader(w,Z),x.attachShader(w,P),this.webGLVersion>1&&c){const Z=this.createTransformFeedback();this.bindTransformFeedback(Z),this.setTranformFeedbackVaryings(w,c),M.transformFeedback=Z}return x.linkProgram(w),this.webGLVersion>1&&c&&this.bindTransformFeedback(null),M.context=x,M.vertexShader=Z,M.fragmentShader=P,M.isParallelCompiled||this._finalizePipelineContext(M),w}_releaseTexture(M){super._releaseTexture(M)}_releaseRenderTargetWrapper(M){super._releaseRenderTargetWrapper(M);for(const Z of this.scenes){for(const P of Z.postProcesses)P._outputTexture===M&&(P._outputTexture=null);for(const P of Z.cameras)for(const Z of P._postProcesses)Z&&Z._outputTexture===M&&(Z._outputTexture=null)}}_rescaleTexture(M,Z,P,x,c){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);const w=this.createRenderTargetTexture({width:Z.width,height:Z.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});if(!this._rescalePostProcess&&l._RescalePostProcessFactory&&(this._rescalePostProcess=l._RescalePostProcessFactory(this)),this._rescalePostProcess){this._rescalePostProcess.externalTextureSamplerBinding=!0;const v=()=>{this._rescalePostProcess.onApply=function(Z){Z._bindTexture("textureSampler",M)};let v=P;v||(v=this.scenes[this.scenes.length-1]),v.postProcessManager.directRender([this._rescalePostProcess],w,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,Z,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,x,0,0,Z.width,Z.height,0),this.unBindFramebuffer(w),w.dispose(),c&&c()},G=this._rescalePostProcess.getEffect();G?G.executeWhenCompiled(v):this._rescalePostProcess.onEffectCreatedObservable.addOnce((M=>{M.executeWhenCompiled(v)}))}}wrapWebGLTexture(M){let Z=arguments.length>1&&void 0!==arguments[1]&&arguments[1],P=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3,c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,w=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;const v=new O.c(M,this._gl),G=new x.d(this,0,!0);return G._hardwareTexture=v,G.baseWidth=c,G.baseHeight=w,G.width=c,G.height=w,G.isReady=!0,G.useMipMaps=Z,this.updateTextureSamplingMode(P,G),G}_uploadImageToTexture(M,Z){let P=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,x=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const c=this._gl,w=this._getWebGLTextureType(M.type),v=this._getInternalFormat(M.format),G=this._getRGBABufferInternalSizedFormat(M.type,v),mM=M.isCube?c.TEXTURE_CUBE_MAP:c.TEXTURE_2D;this._bindTextureDirectly(mM,M,!0),this._unpackFlipY(M.invertY);let K=c.TEXTURE_2D;M.isCube&&(K=c.TEXTURE_CUBE_MAP_POSITIVE_X+P),c.texImage2D(K,x,G,v,w,Z),this._bindTextureDirectly(mM,null,!0)}updateTextureComparisonFunction(M,Z){if(1===this.webGLVersion)return void d.d.Error("WebGL 1 does not support texture comparison.");const P=this._gl;M.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,M,!0),0===Z?(P.texParameteri(P.TEXTURE_CUBE_MAP,P.TEXTURE_COMPARE_FUNC,515),P.texParameteri(P.TEXTURE_CUBE_MAP,P.TEXTURE_COMPARE_MODE,P.NONE)):(P.texParameteri(P.TEXTURE_CUBE_MAP,P.TEXTURE_COMPARE_FUNC,Z),P.texParameteri(P.TEXTURE_CUBE_MAP,P.TEXTURE_COMPARE_MODE,P.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,M,!0),0===Z?(P.texParameteri(P.TEXTURE_2D,P.TEXTURE_COMPARE_FUNC,515),P.texParameteri(P.TEXTURE_2D,P.TEXTURE_COMPARE_MODE,P.NONE)):(P.texParameteri(P.TEXTURE_2D,P.TEXTURE_COMPARE_FUNC,Z),P.texParameteri(P.TEXTURE_2D,P.TEXTURE_COMPARE_MODE,P.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),M._comparisonFunction=Z}createInstancesBuffer(M){const Z=this._gl.createBuffer();if(!Z)throw new Error("Unable to create instance buffer");const P=new K.c(Z);return P.tZ=M,this.bindArrayBuffer(P),this._gl.bufferData(this._gl.ARRAY_BUFFER,M,this._gl.DYNAMIC_DRAW),P.references=1,P}deleteInstancesBuffer(M){this._gl.deleteBuffer(M)}async _clientWaitAsync(M){let Z=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,P=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;const x=this._gl;return await new Promise(((c,w)=>{(0,D.d)((()=>{const P=x.clientWaitSync(M,Z,0);if(P==x.WAIT_FAILED)throw new Error("clientWaitSync failed");return P!=x.TIMEOUT_EXPIRED}),c,w,P)}))}_readPixelsAsync(M,Z,P,x,c,w,v){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");const G=this._gl,mM=G.createBuffer();G.bindBuffer(G.PIXEL_PACK_BUFFER,mM),G.bufferData(G.PIXEL_PACK_BUFFER,v.byteLength,G.STREAM_READ),G.readPixels(M,Z,P,x,c,w,0),G.bindBuffer(G.PIXEL_PACK_BUFFER,null);const K=G.fenceSync(G.SYNC_GPU_COMMANDS_COMPLETE,0);return K?(G.flush(),this._clientWaitAsync(K,0,10).then((()=>(G.deleteSync(K),G.bindBuffer(G.PIXEL_PACK_BUFFER,mM),G.getBufferSubData(G.PIXEL_PACK_BUFFER,0,v),G.bindBuffer(G.PIXEL_PACK_BUFFER,null),G.deleteBuffer(mM),v)))):null}dispose(){this.hideLoadingUI(),this._rescalePostProcess&&this._rescalePostProcess.dispose(),function(M,Z){1===c.b.Instances.length&&J.e.audioEngine&&(J.e.audioEngine.dispose(),J.e.audioEngine=null);const P=M.getHostWindow();P&&"function"===typeof P.removeEventListener&&(P.removeEventListener("blur",M._onBlur),P.removeEventListener("focus",M._onFocus)),Z&&(Z.removeEventListener("focus",M._onCanvasFocus),Z.removeEventListener("blur",M._onCanvasBlur),Z.removeEventListener("pointerout",M._onCanvasPointerOut),Z.removeEventListener("contextmenu",M._onCanvasContextMenu)),(0,N.h)()&&(document.removeEventListener("fullscreenchange",M._onFullscreenChange),document.removeEventListener("mozfullscreenchange",M._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",M._onFullscreenChange),document.removeEventListener("msfullscreenchange",M._onFullscreenChange),document.removeEventListener("pointerlockchange",M._onPointerLockChange),document.removeEventListener("mspointerlockchange",M._onPointerLockChange),document.removeEventListener("mozpointerlockchange",M._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",M._onPointerLockChange))}(this,this._renderingCanvas),super.dispose()}}l.ALPHA_DISABLE=0,l.ALPHA_ADD=1,l.ALPHA_COMBINE=2,l.ALPHA_SUBTRACT=3,l.ALPHA_MULTIPLY=4,l.ALPHA_MAXIMIZED=5,l.ALPHA_ONEONE=6,l.ALPHA_PREMULTIPLIED=7,l.ALPHA_PREMULTIPLIED_PORTERDUFF=8,l.ALPHA_INTERPOLATE=9,l.ALPHA_SCREENMODE=10,l.DELAYLOADSTATE_NONE=0,l.DELAYLOADSTATE_LOADED=1,l.DELAYLOADSTATE_LOADING=2,l.DELAYLOADSTATE_NOTLOADED=4,l.NEVER=512,l.ALWAYS=519,l.LESS=513,l.EQUAL=514,l.LEQUAL=515,l.GREATER=516,l.GEQUAL=518,l.NOTEQUAL=517,l.KEEP=7680,l.REPLACE=7681,l.INCR=7682,l.DECR=7683,l.INVERT=5386,l.INCR_WRAP=34055,l.DECR_WRAP=34056,l.TEXTURE_CLAMP_ADDRESSMODE=0,l.TEXTURE_WRAP_ADDRESSMODE=1,l.TEXTURE_MIRROR_ADDRESSMODE=2,l.TEXTUREFORMAT_ALPHA=0,l.TEXTUREFORMAT_LUMINANCE=1,l.TEXTUREFORMAT_LUMINANCE_ALPHA=2,l.TEXTUREFORMAT_RGB=4,l.TEXTUREFORMAT_RGBA=5,l.TEXTUREFORMAT_RED=6,l.TEXTUREFORMAT_R=6,l.TEXTUREFORMAT_R16_UNORM=33322,l.TEXTUREFORMAT_RG16_UNORM=33324,l.TEXTUREFORMAT_RGB16_UNORM=32852,l.TEXTUREFORMAT_RGBA16_UNORM=32859,l.TEXTUREFORMAT_R16_SNORM=36760,l.TEXTUREFORMAT_RG16_SNORM=36761,l.TEXTUREFORMAT_RGB16_SNORM=36762,l.TEXTUREFORMAT_RGBA16_SNORM=36763,l.TEXTUREFORMAT_RG=7,l.TEXTUREFORMAT_RED_INTEGER=8,l.TEXTUREFORMAT_R_INTEGER=8,l.TEXTUREFORMAT_RG_INTEGER=9,l.TEXTUREFORMAT_RGB_INTEGER=10,l.TEXTUREFORMAT_RGBA_INTEGER=11,l.TEXTURETYPE_UNSIGNED_BYTE=0,l.TEXTURETYPE_UNSIGNED_INT=0,l.TEXTURETYPE_FLOAT=1,l.TEXTURETYPE_HALF_FLOAT=2,l.TEXTURETYPE_BYTE=3,l.TEXTURETYPE_SHORT=4,l.TEXTURETYPE_UNSIGNED_SHORT=5,l.TEXTURETYPE_INT=6,l.TEXTURETYPE_UNSIGNED_INTEGER=7,l.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,l.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,l.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,l.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,l.TEXTURETYPE_UNSIGNED_INT_24_8=12,l.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,l.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,l.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,l.TEXTURE_NEAREST_SAMPLINGMODE=1,l.TEXTURE_BILINEAR_SAMPLINGMODE=2,l.TEXTURE_TRILINEAR_SAMPLINGMODE=3,l.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,l.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,l.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,l.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,l.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,l.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,l.TEXTURE_NEAREST_LINEAR=7,l.TEXTURE_NEAREST_NEAREST=1,l.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,l.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,l.TEXTURE_LINEAR_LINEAR=2,l.TEXTURE_LINEAR_NEAREST=12,l.TEXTURE_EXPLICIT_MODE=0,l.TEXTURE_SPHERICAL_MODE=1,l.TEXTURE_PLANAR_MODE=2,l.TEXTURE_CUBIC_MODE=3,l.TEXTURE_PROJECTION_MODE=4,l.TEXTURE_SKYBOX_MODE=5,l.TEXTURE_INVCUBIC_MODE=6,l.TEXTURE_EQUIRECTANGULAR_MODE=7,l.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,l.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,l.SCALEMODE_FLOOR=1,l.SCALEMODE_NEAREST=2,l.SCALEMODE_CEILING=3},12544:(M,Z,P)=>{P.d(Z,{b:()=>c});var x=P(12522);class c{get depthStencilTexture(){return this._depthStencilTexture}setDepthStencilTexture(M){(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&this._depthStencilTexture&&this._depthStencilTexture.dispose(),this._depthStencilTexture=M,this._generateDepthBuffer=this._generateStencilBuffer=this._depthStencilTextureWithStencil=!1,M&&(this._generateDepthBuffer=!0,this._generateStencilBuffer=this._depthStencilTextureWithStencil=(0,x.d)(M.format))}get depthStencilTextureWithStencil(){return this._depthStencilTextureWithStencil}get isCube(){return this._isCube}get isMulti(){return this._isMulti}get is2DArray(){return this.layers>0}get is3D(){return this.depth>0}get size(){return this.width}get width(){return this._size.width??this._size}get height(){return this._size.height??this._size}get layers(){return this._size.layers||0}get depth(){return this._size.depth||0}get texture(){var M;return(null===(M=this._textures)||void 0===M?void 0:M[0])??null}get textures(){return this._textures}get faceIndices(){return this._faceIndices}get layerIndices(){return this._layerIndices}getBaseArrayLayer(M){var Z,P;if(!this._textures)return-1;const x=this._textures[M],c=(null===(Z=this._layerIndices)||void 0===Z?void 0:Z[M])??0,w=(null===(P=this._faceIndices)||void 0===P?void 0:P[M])??0;return x.isCube?6*c+w:x.is3D?0:c}get samples(){return this._samples}setSamples(M){let Z=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],P=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this.samples===M&&!P)return M;const x=this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,M,Z):this._engine.updateRenderTargetTextureSampleCount(this,M);return this._samples=M,x}resolveMSAATextures(){this.isMulti?this._engine.resolveMultiFramebuffer(this):this._engine.resolveFramebuffer(this)}generateMipMaps(){this._engine._currentRenderTarget===this&&this._engine.unBindFramebuffer(this,!0),this.isMulti?this._engine.generateMipMapsMultiFramebuffer(this):this._engine.generateMipMapsFramebuffer(this)}constructor(M,Z,P,x,c){this._textures=null,this._faceIndices=null,this._layerIndices=null,this._samples=1,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this.disableAutomaticMSAAResolve=!1,this.resolveMSAAColors=!0,this.resolveMSAADepth=!1,this.resolveMSAAStencil=!1,this._isMulti=M,this._isCube=Z,this._size=P,this._engine=x,this._depthStencilTexture=null,this.label=c}setTextures(M){Array.isArray(M)?this._textures=M:this._textures=M?[M]:null}setTexture(M){let Z=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,P=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._textures||(this._textures=[]),this._textures[Z]!==M&&(this._textures[Z]&&P&&this._textures[Z].dispose(),this._textures[Z]=M)}setLayerAndFaceIndices(M,Z){this._layerIndices=M,this._faceIndices=Z}setLayerAndFaceIndex(){let M=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,Z=arguments.length>1?arguments[1]:void 0,P=arguments.length>2?arguments[2]:void 0;this._layerIndices||(this._layerIndices=[]),this._faceIndices||(this._faceIndices=[]),void 0!==Z&&Z>=0&&(this._layerIndices[M]=Z),void 0!==P&&P>=0&&(this._faceIndices[M]=P)}createDepthStencilTexture(){var M;let Z=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,P=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],x=arguments.length>2&&void 0!==arguments[2]&&arguments[2],c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,w=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14,v=arguments.length>5?arguments[5]:void 0;return null===(M=this._depthStencilTexture)||void 0===M||M.dispose(),this._depthStencilTextureWithStencil=x,this._depthStencilTextureLabel=v,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:P,comparisonFunction:Z,generateStencil:x,isCube:this._isCube,samples:c,depthTextureFormat:w,label:v},this),this._depthStencilTexture}_shareDepth(M){this.shareDepth(M)}shareDepth(M){this._depthStencilTexture&&(M._depthStencilTexture&&M._depthStencilTexture.dispose(),M._depthStencilTexture=this._depthStencilTexture,M._depthStencilTextureWithStencil=this._depthStencilTextureWithStencil,this._depthStencilTexture.incrementReferences())}_swapAndDie(M){this.texture&&this.texture._swapAndDie(M),this._textures=null,this.dispose(!0)}_cloneRenderTargetWrapper(){let M=null;if(this._isMulti){const Z=this.textures;if(Z&&Z.length>0){let P=!1,x=Z.length,c=-1;const w=Z[Z.length-1]._source;14!==w&&12!==w||(P=!0,c=Z[Z.length-1].format,x--);const v=[],G=[],mM=[],K=[],d=[],O=[],H=[],j={};for(let M=0;M<x;++M){const P=Z[M];v.push(P.samplingMode),G.push(P.type),mM.push(P.format);void 0!==j[P.uniqueId]?(K.push(-1),H.push(0)):(j[P.uniqueId]=M,P.is2DArray?(K.push(35866),H.push(P.depth)):P.isCube?(K.push(34067),H.push(0)):P.is3D?(K.push(32879),H.push(P.depth)):(K.push(3553),H.push(0))),this._faceIndices&&d.push(this._faceIndices[M]??0),this._layerIndices&&O.push(this._layerIndices[M]??0)}const B={samplingModes:v,generateMipMaps:Z[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:P,depthTextureFormat:c,types:G,formats:mM,textureCount:x,targetTypes:K,faceIndex:d,layerIndex:O,layerCounts:H,label:this.label},U={width:this.width,height:this.height,depth:this.depth};M=this._engine.createMultipleRenderTarget(U,B);for(let n=0;n<x;++n){if(-1!==K[n])continue;const P=j[Z[n].uniqueId];M.setTexture(M.textures[P],n)}}}else{var Z,P,x,c;const v={};if(v.generateDepthBuffer=this._generateDepthBuffer,v.generateMipMaps=(null===(Z=this.texture)||void 0===Z?void 0:Z.generateMipMaps)??!1,v.generateStencilBuffer=this._generateStencilBuffer,v.samplingMode=null===(P=this.texture)||void 0===P?void 0:P.samplingMode,v.type=null===(x=this.texture)||void 0===x?void 0:x.type,v.format=null===(c=this.texture)||void 0===c?void 0:c.format,v.noColorAttachment=!this._textures,v.label=this.label,this.isCube)M=this._engine.createRenderTargetCubeTexture(this.width,v);else{var w;const Z={width:this.width,height:this.height,layers:this.is2DArray||this.is3D?null===(w=this.texture)||void 0===w?void 0:w.depth:void 0};M=this._engine.createRenderTargetTexture(Z,v)}M.texture&&(M.texture.isReady=!0)}return M}_swapRenderTargetWrapper(M){if(this._textures&&M._textures)for(let Z=0;Z<this._textures.length;++Z)this._textures[Z]._swapAndDie(M._textures[Z],!1),M._textures[Z].isReady=!0;this._depthStencilTexture&&M._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(M._depthStencilTexture),M._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null}_rebuild(){const M=this._cloneRenderTargetWrapper();if(M){if(this._depthStencilTexture){const Z=this._depthStencilTexture.samplingMode,P=this._depthStencilTexture.format,x=2===Z||3===Z||11===Z;M.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,x,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples,P,this._depthStencilTextureLabel)}this.samples>1&&M.setSamples(this.samples),M._swapRenderTargetWrapper(this),M.dispose()}}releaseTextures(){if(this._textures)for(let M=0;M<this._textures.length;++M)this._textures[M].dispose();this._textures=null}dispose(){var M;arguments.length>0&&void 0!==arguments[0]&&arguments[0]||(null===(M=this._depthStencilTexture)||void 0===M||M.dispose(),this._depthStencilTexture=null,this.releaseTextures());this._engine._releaseRenderTargetWrapper(this)}}},12490:(M,Z,P)=>{P.r(Z),P.d(Z,{ThinEngine:()=>J});var x=P(12280),c=P(12497),w=P(12199),v=P(12192);class G{constructor(){this.shaderLanguage=0}postProcessor(M,Z,P,x,c){if(c.drawBuffersExtensionDisabled){const Z=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;M=M.replace(Z,"")}return M}}const mM=/(flat\s)?\s*varying\s*.*/;class K{constructor(){this.shaderLanguage=0}attributeProcessor(M){return M.replace("attribute","in")}varyingCheck(M,Z){return mM.test(M)}varyingProcessor(M,Z){return M.replace("varying",Z?"in":"out")}postProcessor(M,Z,P){const x=-1!==M.search(/#extension.+GL_EXT_draw_buffers.+require/);if(M=(M=M.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),P){const Z=-1!==M.search(/layout *\(location *= *0\) *out/g);M=(M=(M=(M=(M=(M=(M=M.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/void\s+?main\s*\(/g,(x||Z?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(")}else{if(-1!==Z.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+M}return M}}var d=P(12505),O=P(12332),H=P(12260),j=P(12514),B=P(12291),U=P(12262),n=P(12254),L=P(12276),u=P(12522);class N{}class J extends H.e{get name(){return this._name}set name(M){this._name=M}get version(){return this._webGLVersion}static get ShadersRepository(){return U.Effect.ShadersRepository}static set ShadersRepository(M){U.Effect.ShadersRepository=M}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(M){this._framebufferDimensionsObject=M}snapshotRenderingReset(){this.snapshotRendering=!1}constructor(M,Z,P,c){if(P=P||{},super(Z??P.antialias,P,c),this._name="WebGL",this.forcePOTTextures=!1,this.validateShaderPrograms=!1,this.disableUniformBuffers=!1,this._webGLVersion=1,this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},!M)return;let v=null;if(M.getContext){if(v=M,void 0===P.o&&(P.o=!1),void 0===P.xrCompatible&&(P.xrCompatible=!1),navigator&&navigator.userAgent){this._setupMobileChecks();const M=navigator.userAgent;for(const Z of J.ExceptionList){const x=Z.key,c=Z.targets;if(new RegExp(x).test(M)){if(Z.capture&&Z.captureConstraint){const P=Z.capture,x=Z.captureConstraint,c=new RegExp(P).exec(M);if(c&&c.length>0){if(parseInt(c[c.length-1])>=x)continue}}for(const M of c)switch(M){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":P.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1}}}}if(this._doNotHandleContextLost?this._onContextLost=()=>{(0,x.z)(this._gl)}:(this._onContextLost=M=>{M.preventDefault(),this._contextWasLost=!0,(0,x.z)(this._gl),w.d.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost((()=>this._initGLContext()))},v.addEventListener("webglcontextrestored",this._onContextRestored,!1),P.powerPreference=P.powerPreference||"high-performance"),v.addEventListener("webglcontextlost",this._onContextLost,!1),this._badDesktopOS&&(P.xrCompatible=!1),!P.disableWebGL2Support)try{this._gl=v.getContext("webgl2",P)||v.getContext("experimental-webgl2",P),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch(O){}if(!this._gl){if(!v)throw new Error("The provided canvas is null or undefined.");try{this._gl=v.getContext("webgl",P)||v.getContext("experimental-webgl",P)}catch(O){throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=M,v=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const Z=this._gl.getContextAttributes();Z&&(P.Kc=Z.Kc)}this._sharedInit(v),this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),void 0!==P.useHighPrecisionFloats&&(this._highPrecisionShadersAllowed=P.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let x=0;x<this._caps.maxVertexAttribs;x++)this._currentBufferPointers[x]=new N;this._shaderProcessor=this.webGLVersion>1?new K:new G;const mM=`Babylon.js v${J.Version}`;w.d.Log(mM+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",mM);const d=(0,x.A)(this._gl);d.validateShaderPrograms=this.validateShaderPrograms,d.parallelShaderCompile=this._caps.parallelShaderCompile}_clearEmptyResources(){this._dummyFramebuffer=null,super._clearEmptyResources()}_getShaderProcessingContext(M){return null}areAllEffectsReady(){for(const M in this._compiledEffects){if(!this._compiledEffects[M].isReady())return!1}return!0}_initGLContext(){this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||null!==this._gl.getExtension("OES_standard_derivatives"),maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||null!==this._gl.getExtension("OES_element_index_uint"),fragmentDepthSupported:this._webGLVersion>1||null!==this._gl.getExtension("EXT_frag_depth"),highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,colorBufferHalfFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_half_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:1!==this._webGLVersion,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1,textureNorm16:!!this._gl.getExtension("EXT_texture_norm16")},this._caps.supportFloatTexturesResolve=this._caps.colorBufferFloat,this._caps.rg11b10ufColorRenderable=this._caps.colorBufferFloat,this._glVersion=this._gl.getParameter(this._gl.VERSION);const M=this._gl.getExtension("WEBGL_debug_renderer_info");if(null!=M&&(this._glRenderer=this._gl.getParameter(M.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(M.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),36193!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=36193),34842!==this._gl.RGBA16F&&(this._gl.RGBA16F=34842),34836!==this._gl.RGBA32F&&(this._gl.RGBA32F=34836),35056!==this._gl.DEPTH24_STENCIL8&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(1===this._webGLVersion&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=(this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)??0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!(!this._caps.textureFloat||!this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!(!this._caps.textureFloat||!this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.textureNorm16&&(this._gl.R16_EXT=33322,this._gl.RG16_EXT=33324,this._gl.RGB16_EXT=32852,this._gl.RGBA16_EXT=32859,this._gl.R16_SNORM_EXT=36760,this._gl.RG16_SNORM_EXT=36761,this._gl.RGB16_SNORM_EXT=36762,this._gl.RGBA16_SNORM_EXT=36763),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&5131!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=null!==this._maxMSAASamplesOverride?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES),this._caps.maxDrawBuffers=this._gl.getParameter(this._gl.MAX_DRAW_BUFFERS);else{const M=this._gl.getExtension("WEBGL_draw_buffers");if(null!==M){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=M.drawBuffersWEBGL.bind(M),this._caps.maxDrawBuffers=this._gl.getParameter(M.MAX_DRAW_BUFFERS_WEBGL),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let Z=0;Z<16;Z++)this._gl["COLOR_ATTACHMENT"+Z+"_WEBGL"]=M["COLOR_ATTACHMENT"+Z+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{const M=this._gl.getExtension("WEBGL_depth_texture");null!=M&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=M.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{const M=this._gl.getExtension("OES_vertex_array_object");null!=M&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=M.createVertexArrayOES.bind(M),this._gl.bindVertexArray=M.bindVertexArrayOES.bind(M),this._gl.deleteVertexArray=M.deleteVertexArrayOES.bind(M))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{const M=this._gl.getExtension("ANGLE_instanced_arrays");null!=M?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=M.drawArraysInstancedANGLE.bind(M),this._gl.drawElementsInstanced=M.drawElementsInstancedANGLE.bind(M),this._gl.vertexAttribDivisor=M.vertexAttribDivisorANGLE.bind(M)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){const M=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),Z=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);M&&Z&&(this._caps.highPrecisionShaderSupported=0!==M.precision&&0!==Z.precision)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{const M=this._gl.getExtension("EXT_blend_minmax");null!=M&&(this._caps.blendMinMax=!0,this._gl.MAX=M.MAX_EXT,this._gl.MIN=M.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:WebGL2RenderingContext.SRGB,SRGB8:WebGL2RenderingContext.SRGB8,SRGB8_ALPHA8:WebGL2RenderingContext.SRGB8_ALPHA8};else{const M=this._gl.getExtension("EXT_sRGB");null!=M&&(this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:M.SRGB_EXT,SRGB8:M.SRGB_ALPHA_EXT,SRGB8_ALPHA8:M.SRGB_ALPHA_EXT})}if(this._creationOptions){const M=this._creationOptions.forceSRGBBufferSupportState;void 0!==M&&(this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&M)}}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let Z=0;Z<this._maxSimultaneousTextures;Z++)this._nextFreeTextureSlots.push(Z);"Mali-G72"===this._glRenderer&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:"undefined"===typeof HTMLImageElement,supportRenderAndCopyToLodForFloatTextures:1!==this._webGLVersion,supportDepthStencilTexture:1!==this._webGLVersion,supportShadowSamplers:1!==this._webGLVersion,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:1!==this._webGLVersion,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:1!==this._webGLVersion,basisNeedsPOT:1===this._webGLVersion,support3DTextures:1!==this._webGLVersion,needTypeSuffixInShaderConstants:1!==this._webGLVersion,supportMSAA:1!==this._webGLVersion,supportSSAO2:1!==this._webGLVersion,supportIBLShadows:1!==this._webGLVersion,supportExtendedTextureFormats:1!==this._webGLVersion,supportSwitchCaseInShader:1!==this._webGLVersion,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,forceVertexBufferStrideAndOffsetMultiple4Bytes:!1,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const M=this._workingCanvas.getContext("2d");M&&(this._workingContext=M)}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}extractDriverInfo(){const M=this.getGlInfo();return M&&M.renderer?M.renderer:""}getRenderWidth(){return!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(){return!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}clear(M,Z,P){let x=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const c=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=c;let w=0;if(Z&&M){let Z=!0;if(this._currentRenderTarget){var v;const P=null===(v=this._currentRenderTarget.texture)||void 0===v?void 0:v.format;if(8===P||9===P||10===P||11===P){var G;const P=null===(G=this._currentRenderTarget.texture)||void 0===G?void 0:G.type;7===P||5===P?(J._TempClearColorUint32[0]=255*M.r,J._TempClearColorUint32[1]=255*M.g,J._TempClearColorUint32[2]=255*M.b,J._TempClearColorUint32[3]=255*M.a,this._gl.clearBufferuiv(this._gl.COLOR,0,J._TempClearColorUint32),Z=!1):(J._TempClearColorInt32[0]=255*M.r,J._TempClearColorInt32[1]=255*M.g,J._TempClearColorInt32[2]=255*M.b,J._TempClearColorInt32[3]=255*M.a,this._gl.clearBufferiv(this._gl.COLOR,0,J._TempClearColorInt32),Z=!1)}}Z&&(this._gl.clearColor(M.r,M.g,M.b,void 0!==M.a?M.a:1),w|=this._gl.COLOR_BUFFER_BIT)}P&&(this.cc?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),w|=this._gl.DEPTH_BUFFER_BIT),x&&(this._gl.clearStencil(0),w|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(w)}_viewport(M,Z,P,x){M===this._viewportCached.x&&Z===this._viewportCached.y&&P===this._viewportCached.z&&x===this._viewportCached.w||(this._viewportCached.x=M,this._viewportCached.y=Z,this._viewportCached.z=P,this._viewportCached.w=x,this._gl.viewport(M,Z,P,x))}vc(){super.vc(),this._badOS&&this.flushFramebuffer()}get performanceMonitor(){throw new Error("Not Supported by ThinEngine")}bindFramebuffer(M){let Z=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,P=arguments.length>2?arguments[2]:void 0,x=arguments.length>3?arguments[3]:void 0,c=arguments.length>4?arguments[4]:void 0,v=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,G=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;const mM=M;this._currentRenderTarget&&this._resolveAndGenerateMipMapsFramebuffer(this._currentRenderTarget),this._currentRenderTarget=M,this._bindUnboundFramebuffer(mM._framebuffer);const K=this._gl;var d;if(!M.isMulti)if(M.is2DArray||M.is3D)K.framebufferTextureLayer(K.FRAMEBUFFER,K.COLOR_ATTACHMENT0,null===(d=M.texture._hardwareTexture)||void 0===d?void 0:d.underlyingResource,v,G),mM._currentLOD=v;else if(M.isCube){var O;K.framebufferTexture2D(K.FRAMEBUFFER,K.COLOR_ATTACHMENT0,K.TEXTURE_CUBE_MAP_POSITIVE_X+Z,null===(O=M.texture._hardwareTexture)||void 0===O?void 0:O.underlyingResource,v)}else if(mM._currentLOD!==v){var H;K.framebufferTexture2D(K.FRAMEBUFFER,K.COLOR_ATTACHMENT0,K.TEXTURE_2D,null===(H=M.texture._hardwareTexture)||void 0===H?void 0:H.underlyingResource,v),mM._currentLOD=v}const j=M._depthStencilTexture;if(j){M.is3D&&(M.texture.width===j.width&&M.texture.height===j.height&&M.texture.depth===j.depth||w.d.Warn("Depth/Stencil attachment for 3D target must have same dimensions as color attachment"));const P=M._depthStencilTextureWithStencil?K.DEPTH_STENCIL_ATTACHMENT:K.DEPTH_ATTACHMENT;var B;if(M.is2DArray||M.is3D)K.framebufferTextureLayer(K.FRAMEBUFFER,P,null===(B=j._hardwareTexture)||void 0===B?void 0:B.underlyingResource,v,G);else if(M.isCube){var U;K.framebufferTexture2D(K.FRAMEBUFFER,P,K.TEXTURE_CUBE_MAP_POSITIVE_X+Z,null===(U=j._hardwareTexture)||void 0===U?void 0:U.underlyingResource,v)}else{var n;K.framebufferTexture2D(K.FRAMEBUFFER,P,K.TEXTURE_2D,null===(n=j._hardwareTexture)||void 0===n?void 0:n.underlyingResource,v)}}mM._MSAAFramebuffer&&this._bindUnboundFramebuffer(mM._MSAAFramebuffer),this._cachedViewport&&!c?this.setViewport(this._cachedViewport,P,x):(P||(P=M.width,v&&(P/=Math.pow(2,v))),x||(x=M.height,v&&(x/=Math.pow(2,v))),this._viewport(0,0,P,x)),this.wipeCaches()}setStateCullFaceType(M,Z){const P=this.cullBackFaces??M??1?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==P||Z)&&(this._depthCullingState.cullFace=P)}setState(M){let Z=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,P=arguments.length>2?arguments[2]:void 0,x=arguments.length>3&&void 0!==arguments[3]&&arguments[3],c=arguments.length>4?arguments[4]:void 0,w=arguments.length>5?arguments[5]:void 0,v=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;(this._depthCullingState.cull!==M||P)&&(this._depthCullingState.cull=M),this.setStateCullFaceType(c,P),this.setZOffset(Z),this.setZOffsetUnits(v);const G=x?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==G||P)&&(this._depthCullingState.frontFace=G),this._stencilStateComposer.stencilMaterial=w}_resolveAndGenerateMipMapsFramebuffer(M){let Z=arguments.length>1&&void 0!==arguments[1]&&arguments[1];M.disableAutomaticMSAAResolve||(M.isMulti?this.resolveMultiFramebuffer(M):this.resolveFramebuffer(M)),Z||(M.isMulti?this.generateMipMapsMultiFramebuffer(M):this.generateMipMapsFramebuffer(M))}_bindUnboundFramebuffer(M){this._currentFramebuffer!==M&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,M),this._currentFramebuffer=M)}_currentFrameBufferIsDefaultFrameBuffer(){return null===this._currentFramebuffer}generateMipmaps(M){const Z=this._getTextureTarget(M);this._bindTextureDirectly(Z,M,!0),this._gl.generateMipmap(Z),this._bindTextureDirectly(Z,null)}unBindFramebuffer(M,Z,P){const x=M;this._currentRenderTarget=null,this._resolveAndGenerateMipMapsFramebuffer(M,Z),P&&(x._MSAAFramebuffer&&this._bindUnboundFramebuffer(x._framebuffer),P()),this._bindUnboundFramebuffer(null)}generateMipMapsFramebuffer(M){var Z;M.isMulti||null===(Z=M.texture)||void 0===Z||!Z.generateMipMaps||M.isCube||this.generateMipmaps(M.texture)}resolveFramebuffer(M){const Z=M,P=this._gl;if(!Z._MSAAFramebuffer||Z.isMulti)return;let x=Z.resolveMSAAColors?P.COLOR_BUFFER_BIT:0;x|=Z._generateDepthBuffer&&Z.resolveMSAADepth?P.DEPTH_BUFFER_BIT:0,x|=Z._generateStencilBuffer&&Z.resolveMSAAStencil?P.STENCIL_BUFFER_BIT:0,P.bindFramebuffer(P.READ_FRAMEBUFFER,Z._MSAAFramebuffer),P.bindFramebuffer(P.DRAW_FRAMEBUFFER,Z._framebuffer),P.blitFramebuffer(0,0,M.width,M.height,0,0,M.width,M.height,x,P.NEAREST)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(M,Z,P){return this._createVertexBuffer(M,this._gl.STATIC_DRAW)}_createVertexBuffer(M,Z){const P=this._gl.createBuffer();if(!P)throw new Error("Unable to create vertex buffer");const x=new d.c(P);return this.bindArrayBuffer(x),"number"!==typeof M?M instanceof Array?(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(M),Z),x.tZ=4*M.length):(this._gl.bufferData(this._gl.ARRAY_BUFFER,M,Z),x.tZ=M.byteLength):(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Uint8Array(M),Z),x.tZ=M),this._resetVertexBufferBinding(),x.references=1,x}createDynamicVertexBuffer(M,Z){return this._createVertexBuffer(M,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(M,Z,P){const x=this._gl.createBuffer(),c=new d.c(x);if(!x)throw new Error("Unable to create index buffer");this.bindIndexBuffer(c);const w=this._normalizeIndexData(M);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,w,Z?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),c.references=1,c.is32Bits=4===w.BYTES_PER_ELEMENT,c}_normalizeIndexData(M){if(2===M.BYTES_PER_ELEMENT)return M;if(this._caps.uintIndices){if(M instanceof Uint32Array)return M;for(let Z=0;Z<M.length;Z++)if(M[Z]>=65535)return new Uint32Array(M);return new Uint16Array(M)}return new Uint16Array(M)}bindArrayBuffer(M){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(M,this._gl.ARRAY_BUFFER)}bindUniformBlock(M,Z,P){const x=M.program,c=this._gl.getUniformBlockIndex(x,Z);this._gl.uniformBlockBinding(x,c,P)}bindIndexBuffer(M){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(M,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(M,Z){(this._vaoRecordInProgress||this._currentBoundBuffer[Z]!==M)&&(this._gl.bindBuffer(Z,M?M.underlyingResource:null),this._currentBoundBuffer[Z]=M)}updateArrayBuffer(M){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,M)}_vertexAttribPointer(M,Z,P,x,c,w,v){const G=this._currentBufferPointers[Z];if(!G)return;let mM=!1;G.active?(G.buffer!==M&&(G.buffer=M,mM=!0),G.size!==P&&(G.size=P,mM=!0),G.type!==x&&(G.type=x,mM=!0),G.normalized!==c&&(G.normalized=c,mM=!0),G.stride!==w&&(G.stride=w,mM=!0),G.offset!==v&&(G.offset=v,mM=!0)):(mM=!0,G.active=!0,G.index=Z,G.size=P,G.type=x,G.normalized=c,G.stride=w,G.offset=v,G.buffer=M),(mM||this._vaoRecordInProgress)&&(this.bindArrayBuffer(M),x===this._gl.UNSIGNED_INT||x===this._gl.INT?this._gl.vertexAttribIPointer(Z,P,x,w,v):this._gl.vertexAttribPointer(Z,P,x,c,w,v))}_bindIndexBufferWithCache(M){null!=M&&this._cachedIndexBuffer!==M&&(this._cachedIndexBuffer=M,this.bindIndexBuffer(M),this._uintIndicesCurrentlySet=M.is32Bits)}_bindVertexBuffersAttributes(M,Z,P){const x=Z.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let c=0;c<x.length;c++){const w=Z.getAttributeLocation(c);if(w>=0){const Z=x[c];let v=null;if(P&&(v=P[Z]),v||(v=M[Z]),!v)continue;this._gl.enableVertexAttribArray(w),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[w]=!0);const G=v.getBuffer();G&&(this._vertexAttribPointer(G,w,v.getSize(),v.type,v.normalized,v.byteStride,v.byteOffset),v.getIsInstanced()&&(this._gl.vertexAttribDivisor(w,v.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(w),this._currentInstanceBuffers.push(G))))}}}recordVertexArrayObject(M,Z,P,x){const c=this._gl.createVertexArray();if(!c)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(c),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(M,P,x),this.bindIndexBuffer(Z),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),c}bindVertexArrayObject(M,Z){this._cachedVertexArrayObject!==M&&(this._cachedVertexArrayObject=M,this._gl.bindVertexArray(M),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=null!=Z&&Z.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(M,Z,P,x,c){if(this._cachedVertexBuffers!==M||this._cachedEffectForVertexBuffers!==c){this._cachedVertexBuffers=M,this._cachedEffectForVertexBuffers=c;const Z=c.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let w=0;for(let v=0;v<Z;v++)if(v<P.length){const Z=c.getAttributeLocation(v);Z>=0&&(this._gl.enableVertexAttribArray(Z),this._vertexAttribArraysEnabled[Z]=!0,this._vertexAttribPointer(M,Z,P[v],this._gl.FLOAT,!1,x,w)),w+=4*P[v]}}this._bindIndexBufferWithCache(Z)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(M,Z,P,x){this._cachedVertexBuffers===M&&this._cachedEffectForVertexBuffers===P||(this._cachedVertexBuffers=M,this._cachedEffectForVertexBuffers=P,this._bindVertexBuffersAttributes(M,P,x)),this._bindIndexBufferWithCache(Z)}unbindInstanceAttributes(){let M;for(let Z=0,P=this._currentInstanceLocations.length;Z<P;Z++){const P=this._currentInstanceBuffers[Z];M!=P&&P.references&&(M=P,this.bindArrayBuffer(P));const x=this._currentInstanceLocations[Z];this._gl.vertexAttribDivisor(x,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(M){this._gl.deleteVertexArray(M)}_releaseBuffer(M){return M.references--,0===M.references&&(this._deleteBuffer(M),!0)}_deleteBuffer(M){this._gl.deleteBuffer(M.underlyingResource)}updateAndBindInstancesBuffer(M,Z,P){if(this.bindArrayBuffer(M),Z&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,Z),void 0!==P[0].index)this.bindInstancesBuffer(M,P,!0);else for(let x=0;x<4;x++){const Z=P[x];this._vertexAttribArraysEnabled[Z]||(this._gl.enableVertexAttribArray(Z),this._vertexAttribArraysEnabled[Z]=!0),this._vertexAttribPointer(M,Z,4,this._gl.FLOAT,!1,64,16*x),this._gl.vertexAttribDivisor(Z,1),this._currentInstanceLocations.push(Z),this._currentInstanceBuffers.push(M)}}bindInstancesBuffer(M,Z){let P=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.bindArrayBuffer(M);let x=0;if(P)for(let c=0;c<Z.length;c++){x+=4*Z[c].attributeSize}for(let c=0;c<Z.length;c++){const P=Z[c];void 0===P.index&&(P.index=this._currentEffect.getAttributeLocationByName(P.attributeName)),P.index<0||(this._vertexAttribArraysEnabled[P.index]||(this._gl.enableVertexAttribArray(P.index),this._vertexAttribArraysEnabled[P.index]=!0),this._vertexAttribPointer(M,P.index,P.attributeSize,P.attributeType||this._gl.FLOAT,P.normalized||!1,x,P.offset),this._gl.vertexAttribDivisor(P.index,void 0===P.divisor?1:P.divisor),this._currentInstanceLocations.push(P.index),this._currentInstanceBuffers.push(M))}}disableInstanceAttributeByName(M){if(!this._currentEffect)return;const Z=this._currentEffect.getAttributeLocationByName(M);this.disableInstanceAttribute(Z)}disableInstanceAttribute(M){let Z,P=!1;for(;-1!==(Z=this._currentInstanceLocations.indexOf(M));)this._currentInstanceLocations.splice(Z,1),this._currentInstanceBuffers.splice(Z,1),P=!0,Z=this._currentInstanceLocations.indexOf(M);P&&(this._gl.vertexAttribDivisor(M,0),this.disableAttributeByIndex(M))}disableAttributeByIndex(M){this._gl.disableVertexAttribArray(M),this._vertexAttribArraysEnabled[M]=!1,this._currentBufferPointers[M].active=!1}draw(M,Z,P,x){this.drawElementsType(M?0:1,Z,P,x)}drawPointClouds(M,Z,P){this.drawArraysType(2,M,Z,P)}drawUnIndexed(M,Z,P,x){this.drawArraysType(M?0:1,Z,P,x)}drawElementsType(M,Z,P,x){this.applyStates(),this._reportDrawCall();const c=this._drawMode(M),w=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,v=this._uintIndicesCurrentlySet?4:2;x?this._gl.drawElementsInstanced(c,P,w,Z*v,x):this._gl.drawElements(c,P,w,Z*v)}drawArraysType(M,Z,P,x){this.applyStates(),this._reportDrawCall();const c=this._drawMode(M);x?this._gl.drawArraysInstanced(c,Z,P,x):this._gl.drawArrays(c,Z,P)}_drawMode(M){switch(M){case 0:default:return this._gl.TRIANGLES;case 2:case 3:return this._gl.POINTS;case 1:case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN}}_releaseEffect(M){this._compiledEffects[M._key]&&delete this._compiledEffects[M._key];const Z=M.getPipelineContext();Z&&this._deletePipelineContext(Z)}_deletePipelineContext(M){const Z=M;Z&&Z.program&&(Z.program.__SPECTOR_rebuildProgram=null,(0,L.k)(Z),this._gl&&(this._currentProgram===Z.program&&this._setProgram(null),this._gl.deleteProgram(Z.program)))}_getGlobalDefines(M){return(0,n.l)(M,this.isNDCHalfZRange,this.cc,this.useExactSrgbConversions)}createEffect(M,Z,P,c,w,v,G,mM,K){let d=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,O=arguments.length>10?arguments[10]:void 0;const H="string"===typeof M?M:M.vertexToken||M.vertexSource||M.vertexElement||M.vertex,j="string"===typeof M?M:M.fragmentToken||M.fragmentSource||M.fragmentElement||M.fragment,B=this._getGlobalDefines(),n=void 0!==Z.attributes;let L=w??Z.defines??"";B&&(L+=B);const u=H+"+"+j+"@"+L;if(this._compiledEffects[u]){const M=this._compiledEffects[u];return G&&M.isReady()&&G(M),M._refCount++,M}this._gl&&(0,x.A)(this._gl);const N=new U.Effect(M,Z,n?this:P,c,this,w,v,G,mM,K,u,Z.shaderLanguage??d,Z.extraInitializationsAsync??O);return this._compiledEffects[u]=N,N}_getShaderSource(M){return this._gl.getShaderSource(M)}createRawShaderProgram(M,Z,P,c){let w=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const v=(0,x.A)(this._gl);return v._contextWasLost=this._contextWasLost,v.validateShaderPrograms=this.validateShaderPrograms,(0,x.s)(M,Z,P,c||this._gl,w)}createShaderProgram(M,Z,P,c,w){let v=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;const G=(0,x.A)(this._gl);return G._contextWasLost=this._contextWasLost,G.validateShaderPrograms=this.validateShaderPrograms,(0,x.w)(M,Z,P,c,w||this._gl,v)}inlineShaderCode(M){return M}createPipelineContext(M){if(this._gl){(0,x.A)(this._gl).parallelShaderCompile=this._caps.parallelShaderCompile}const Z=(0,x.r)(this._gl,M);return Z.jZ=this,Z}createMaterialContext(){}createDrawContext(){}_finalizePipelineContext(M){return(0,x.h)(M,this._gl,this.validateShaderPrograms)}_preparePipelineContextAsync(M,Z,P,c,w,v,G,mM,K,d,O){const H=(0,x.A)(this._gl);return H._contextWasLost=this._contextWasLost,H.validateShaderPrograms=this.validateShaderPrograms,H._createShaderProgramInjection=this._createShaderProgram.bind(this),H.createRawShaderProgramInjection=this.createRawShaderProgram.bind(this),H.createShaderProgramInjection=this.createShaderProgram.bind(this),H.loadFileInjection=this._loadFile.bind(this),(0,x.k)(M,Z,P,c,w,v,G,mM,K,d,O)}_createShaderProgram(M,Z,P,c){let w=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return(0,x.e)(M,Z,P,c,w)}_isRenderingStateCompiled(M){return!this._isDisposed&&(0,x.i)(M,this._gl,this.validateShaderPrograms)}_executeWhenRenderingStateIsCompiled(M,Z){(0,x.f)(M,Z)}getUniforms(M,Z){const P=new Array,x=M;for(let c=0;c<Z.length;c++)P.push(this._gl.getUniformLocation(x.program,Z[c]));return P}getAttributes(M,Z){const P=[],x=M;for(let w=0;w<Z.length;w++)try{P.push(this._gl.getAttribLocation(x.program,Z[w]))}catch(c){P.push(-1)}return P}enableEffect(M){(M=null!==M&&(0,c.b)(M)?M.effect:M)&&M!==this._currentEffect&&(this._stencilStateComposer.stencilMaterial=void 0,this.bindSamplers(M),this._currentEffect=M,M.onBind&&M.onBind(M),M._onBindObservable&&M._onBindObservable.notifyObservers(M))}setInt(M,Z){return!!M&&(this._gl.uniform1i(M,Z),!0)}setInt2(M,Z,P){return!!M&&(this._gl.uniform2i(M,Z,P),!0)}setInt3(M,Z,P,x){return!!M&&(this._gl.uniform3i(M,Z,P,x),!0)}setInt4(M,Z,P,x,c){return!!M&&(this._gl.uniform4i(M,Z,P,x,c),!0)}setIntArray(M,Z){return!!M&&(this._gl.uniform1iv(M,Z),!0)}setIntArray2(M,Z){return!(!M||Z.length%2!==0)&&(this._gl.uniform2iv(M,Z),!0)}setIntArray3(M,Z){return!(!M||Z.length%3!==0)&&(this._gl.uniform3iv(M,Z),!0)}setIntArray4(M,Z){return!(!M||Z.length%4!==0)&&(this._gl.uniform4iv(M,Z),!0)}setUInt(M,Z){return!!M&&(this._gl.uniform1ui(M,Z),!0)}setUInt2(M,Z,P){return!!M&&(this._gl.uniform2ui(M,Z,P),!0)}setUInt3(M,Z,P,x){return!!M&&(this._gl.uniform3ui(M,Z,P,x),!0)}setUInt4(M,Z,P,x,c){return!!M&&(this._gl.uniform4ui(M,Z,P,x,c),!0)}setUIntArray(M,Z){return!!M&&(this._gl.uniform1uiv(M,Z),!0)}setUIntArray2(M,Z){return!(!M||Z.length%2!==0)&&(this._gl.uniform2uiv(M,Z),!0)}setUIntArray3(M,Z){return!(!M||Z.length%3!==0)&&(this._gl.uniform3uiv(M,Z),!0)}setUIntArray4(M,Z){return!(!M||Z.length%4!==0)&&(this._gl.uniform4uiv(M,Z),!0)}setArray(M,Z){return!!M&&(!(Z.length<1)&&(this._gl.uniform1fv(M,Z),!0))}setArray2(M,Z){return!(!M||Z.length%2!==0)&&(this._gl.uniform2fv(M,Z),!0)}setArray3(M,Z){return!(!M||Z.length%3!==0)&&(this._gl.uniform3fv(M,Z),!0)}setArray4(M,Z){return!(!M||Z.length%4!==0)&&(this._gl.uniform4fv(M,Z),!0)}setMatrices(M,Z){return!!M&&(this._gl.uniformMatrix4fv(M,!1,Z),!0)}setMatrix3x3(M,Z){return!!M&&(this._gl.uniformMatrix3fv(M,!1,Z),!0)}setMatrix2x2(M,Z){return!!M&&(this._gl.uniformMatrix2fv(M,!1,Z),!0)}setFloat(M,Z){return!!M&&(this._gl.uniform1f(M,Z),!0)}setFloat2(M,Z,P){return!!M&&(this._gl.uniform2f(M,Z,P),!0)}setFloat3(M,Z,P,x){return!!M&&(this._gl.uniform3f(M,Z,P,x),!0)}setFloat4(M,Z,P,x,c){return!!M&&(this._gl.uniform4f(M,Z,P,x,c),!0)}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;const M=this._colorWrite;this._gl.colorMask(M,M,M,M)}}wipeCaches(M){this.preventCacheWipeBetweenFrames&&!M||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),M&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(M,Z){const P=this._gl;let x=P.NEAREST,c=P.NEAREST,w=!1;switch(M){case 11:x=P.LINEAR,c=Z?P.LINEAR_MIPMAP_NEAREST:P.LINEAR;break;case 3:x=P.LINEAR,w=!0,c=Z?P.LINEAR_MIPMAP_LINEAR:P.LINEAR;break;case 8:w=!0,x=P.NEAREST,c=Z?P.NEAREST_MIPMAP_LINEAR:P.NEAREST;break;case 4:x=P.NEAREST,c=Z?P.NEAREST_MIPMAP_NEAREST:P.NEAREST;break;case 5:x=P.NEAREST,c=Z?P.LINEAR_MIPMAP_NEAREST:P.LINEAR;break;case 6:w=!0,x=P.NEAREST,c=Z?P.LINEAR_MIPMAP_LINEAR:P.LINEAR;break;case 7:x=P.NEAREST,c=P.LINEAR;break;case 1:x=P.NEAREST,c=P.NEAREST;break;case 9:x=P.LINEAR,c=Z?P.NEAREST_MIPMAP_NEAREST:P.NEAREST;break;case 10:w=!0,x=P.LINEAR,c=Z?P.NEAREST_MIPMAP_LINEAR:P.NEAREST;break;case 2:x=P.LINEAR,c=P.LINEAR;break;case 12:x=P.LINEAR,c=P.NEAREST}return{min:c,mag:x,hasMipMaps:w}}_createTexture(){const M=this._gl.createTexture();if(!M)throw new Error("Unable to create texture");return M}_createHardwareTexture(){return new j.c(this._createTexture(),this._gl)}_createInternalTexture(M,Z){let P,x=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,c=!1,v=!1,G=0,mM=3,K=5,d=!1,O=1,H=!1,j=0;void 0!==Z&&"object"===typeof Z?(c=!!Z.generateMipMaps,v=!!Z.createMipMaps,G=void 0===Z.type?0:Z.type,mM=void 0===Z.samplingMode?3:Z.samplingMode,K=void 0===Z.format?5:Z.format,d=void 0!==Z.useSRGBBuffer&&Z.useSRGBBuffer,O=Z.samples??1,P=Z.label,H=!!Z.createMSAATexture,j=Z.comparisonFunction||0):c=!!Z,d&&(d=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(1!==G||this._caps.textureFloatLinearFiltering)&&(2!==G||this._caps.textureHalfFloatLinearFiltering)||(mM=1),1!==G||this._caps.textureFloat||(G=0,w.d.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const U=(0,u.h)(K),n=(0,u.d)(K),L=this._gl,N=new B.d(this,x),J=M.width||M,t=M.height||M,F=M.depth||0,D=M.layers||0,l=this._getSamplingParameters(mM,(c||v)&&!U),h=0!==D?L.TEXTURE_2D_ARRAY:0!==F?L.TEXTURE_3D:L.TEXTURE_2D,Q=U?this._getInternalFormatFromDepthTextureFormat(K,!0,n):this._getRGBABufferInternalSizedFormat(G,K,d),I=U?n?L.DEPTH_STENCIL:L.DEPTH_COMPONENT:this._getInternalFormat(K),s=U?this._getWebGLTextureTypeFromDepthTextureFormat(K):this._getWebGLTextureType(G);if(this._bindTextureDirectly(h,N),0!==D?(N.is2DArray=!0,L.texImage3D(h,0,Q,J,t,D,0,I,s,null)):0!==F?(N.is3D=!0,L.texImage3D(h,0,Q,J,t,F,0,I,s,null)):L.texImage2D(h,0,Q,J,t,0,I,s,null),L.texParameteri(h,L.TEXTURE_MAG_FILTER,l.mag),L.texParameteri(h,L.TEXTURE_MIN_FILTER,l.min),L.texParameteri(h,L.TEXTURE_WRAP_S,L.CLAMP_TO_EDGE),L.texParameteri(h,L.TEXTURE_WRAP_T,L.CLAMP_TO_EDGE),U&&this.webGLVersion>1&&(0===j?(L.texParameteri(h,L.TEXTURE_COMPARE_FUNC,515),L.texParameteri(h,L.TEXTURE_COMPARE_MODE,L.NONE)):(L.texParameteri(h,L.TEXTURE_COMPARE_FUNC,j),L.texParameteri(h,L.TEXTURE_COMPARE_MODE,L.COMPARE_REF_TO_TEXTURE))),(c||v)&&this._gl.generateMipmap(h),this._bindTextureDirectly(h,null),N._useSRGBBuffer=d,N.baseWidth=J,N.baseHeight=t,N.width=J,N.height=t,N.depth=D||F,N.isReady=!0,N.samples=O,N.generateMipMaps=c,N.samplingMode=mM,N.type=G,N.format=K,N.label=P,N.comparisonFunction=j,this._internalTexturesCache.push(N),H){let M=null;if(M=(0,u.h)(N.format)?this._setupFramebufferDepthAttachments((0,u.d)(N.format),19!==N.format,N.width,N.height,O,N.format,!0):this._createRenderBuffer(N.width,N.height,O,-1,this._getRGBABufferInternalSizedFormat(N.type,N.format,N._useSRGBBuffer),-1),!M)throw new Error("Unable to create render buffer");N._autoMSAAManagement=!0;let Z=N._hardwareTexture;Z||(Z=N._hardwareTexture=this._createHardwareTexture()),Z.addMSAARenderBuffer(M)}return N}_getUseSRGBBuffer(M,Z){return M&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||Z)}createTexture(M,Z,P,x){var c=this;let w=arguments.length>4&&void 0!==arguments[4]?arguments[4]:3,v=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,G=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,mM=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,K=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,d=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,O=arguments.length>10&&void 0!==arguments[10]?arguments[10]:null,H=arguments.length>11?arguments[11]:void 0,j=arguments.length>12?arguments[12]:void 0,U=arguments.length>13?arguments[13]:void 0,n=arguments.length>14?arguments[14]:void 0;return this._createTextureBase(M,Z,P,x,w,v,G,(function(){for(var M=arguments.length,Z=new Array(M),P=0;P<M;P++)Z[P]=arguments[P];return c._prepareWebGLTexture(...Z,d)}),((M,Z,P,c,w,v)=>{const G=this._gl,mM=P.width===M&&P.height===Z;w._creationFlags=U??0;const K=this._getTexImageParametersForCreateTexture(w.format,w._useSRGBBuffer);if(mM)return G.texImage2D(G.TEXTURE_2D,0,K.internalFormat,K.format,K.type,P),!1;const d=this._caps.maxTextureSize;if(P.width>d||P.height>d||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!(!this._workingCanvas||!this._workingContext)&&(this._workingCanvas.width=M,this._workingCanvas.height=Z,this._workingContext.drawImage(P,0,0,P.width,P.height,0,0,M,Z),G.texImage2D(G.TEXTURE_2D,0,K.internalFormat,K.format,K.type,this._workingCanvas),w.width=M,w.height=Z,!1);{const M=new B.d(this,2);this._bindTextureDirectly(G.TEXTURE_2D,M,!0),G.texImage2D(G.TEXTURE_2D,0,K.internalFormat,K.format,K.type,P),this._rescaleTexture(M,w,x,K.format,(()=>{this._releaseTexture(M),this._bindTextureDirectly(G.TEXTURE_2D,w,!0),v()}))}return!0}),mM,K,d,O,H,j,n)}_getTexImageParametersForCreateTexture(M,Z){let P,x;return 1===this.webGLVersion?(P=this._getInternalFormat(M,Z),x=P):(P=this._getInternalFormat(M,!1),x=this._getRGBABufferInternalSizedFormat(0,M,Z)),{internalFormat:x,format:P,type:this._gl.UNSIGNED_BYTE}}_rescaleTexture(M,Z,P,x,c){}_unpackFlipY(M){this._unpackFlipYCached!==M&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,M?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=M))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(M){return M.isCube?this._gl.TEXTURE_CUBE_MAP:M.is3D?this._gl.TEXTURE_3D:M.is2DArray||M.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(M,Z){let P=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const x=this._getTextureTarget(Z),c=this._getSamplingParameters(M,Z.useMipMaps||P);this._setTextureParameterInteger(x,this._gl.TEXTURE_MAG_FILTER,c.mag,Z),this._setTextureParameterInteger(x,this._gl.TEXTURE_MIN_FILTER,c.min),P&&c.hasMipMaps&&(Z.generateMipMaps=!0,this._gl.generateMipmap(x)),this._bindTextureDirectly(x,null),Z.samplingMode=M}updateTextureDimensions(M,Z,P){}updateTextureWrappingMode(M,Z){let P=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,x=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;const c=this._getTextureTarget(M);null!==Z&&(this._setTextureParameterInteger(c,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(Z),M),M._cachedWrapU=Z),null!==P&&(this._setTextureParameterInteger(c,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(P),M),M._cachedWrapV=P),(M.is2DArray||M.is3D)&&null!==x&&(this._setTextureParameterInteger(c,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(x),M),M._cachedWrapR=x),this._bindTextureDirectly(c,null)}_uploadCompressedDataToTextureDirectly(M,Z,P,x,c){let w=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,v=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;const G=this._gl;let mM=G.TEXTURE_2D;if(M.isCube&&(mM=G.TEXTURE_CUBE_MAP_POSITIVE_X+w),M._useSRGBBuffer)switch(Z){case 37492:case 36196:this._caps.etc2?Z=G.COMPRESSED_SRGB8_ETC2:M._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?Z=G.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:M._useSRGBBuffer=!1;break;case 36492:Z=G.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:Z=G.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?Z=G.COMPRESSED_SRGB_S3TC_DXT1_EXT:M._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?Z=G.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:M._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?Z=G.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:M._useSRGBBuffer=!1;break;default:M._useSRGBBuffer=!1}this._gl.compressedTexImage2D(mM,v,Z,P,x,0,c)}_uploadDataToTextureDirectly(M,Z){let P=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,x=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,c=arguments.length>4?arguments[4]:void 0,w=arguments.length>5&&void 0!==arguments[5]&&arguments[5];const v=this._gl,G=this._getWebGLTextureType(M.type),mM=this._getInternalFormat(M.format),K=void 0===c?this._getRGBABufferInternalSizedFormat(M.type,M.format,M._useSRGBBuffer):this._getInternalFormat(c,M._useSRGBBuffer);this._unpackFlipY(M.invertY);let d=v.TEXTURE_2D;M.isCube&&(d=v.TEXTURE_CUBE_MAP_POSITIVE_X+P);const O=Math.round(Math.log(M.width)*Math.LOG2E),H=Math.round(Math.log(M.height)*Math.LOG2E),j=w?M.width:Math.pow(2,Math.max(O-x,0)),B=w?M.height:Math.pow(2,Math.max(H-x,0));v.texImage2D(d,x,K,j,B,0,mM,G,Z)}updateTextureData(M,Z,P,x,c,w){let v=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,G=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,mM=arguments.length>8&&void 0!==arguments[8]&&arguments[8];const K=this._gl,d=this._getWebGLTextureType(M.type),O=this._getInternalFormat(M.format);this._unpackFlipY(M.invertY);let H=K.TEXTURE_2D,j=K.TEXTURE_2D;M.isCube&&(j=K.TEXTURE_CUBE_MAP_POSITIVE_X+v,H=K.TEXTURE_CUBE_MAP),this._bindTextureDirectly(H,M,!0),K.texSubImage2D(j,G,P,x,c,w,O,d,Z),mM&&this._gl.generateMipmap(j),this._bindTextureDirectly(H,null)}_uploadArrayBufferViewToTexture(M,Z){let P=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,x=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const c=this._gl,w=M.isCube?c.TEXTURE_CUBE_MAP:c.TEXTURE_2D;this._bindTextureDirectly(w,M,!0),this._uploadDataToTextureDirectly(M,Z,P,x),this._bindTextureDirectly(w,null,!0)}_prepareWebGLTextureContinuation(M,Z,P,x,c){const w=this._gl;if(!w)return;const v=this._getSamplingParameters(c,!P);w.texParameteri(w.TEXTURE_2D,w.TEXTURE_MAG_FILTER,v.mag),w.texParameteri(w.TEXTURE_2D,w.TEXTURE_MIN_FILTER,v.min),P||x||w.generateMipmap(w.TEXTURE_2D),this._bindTextureDirectly(w.TEXTURE_2D,null),Z&&Z.removePendingData(M),M.onLoadedObservable.notifyObservers(M),M.onLoadedObservable.clear()}_prepareWebGLTexture(M,Z,P,x,c,w,v,G,mM,K){const d=this.getCaps().maxTextureSize,H=Math.min(d,this.needPOTTextures?(0,O.e)(x.width,d):x.width),j=Math.min(d,this.needPOTTextures?(0,O.e)(x.height,d):x.height),B=this._gl;B&&(M._hardwareTexture?(this._bindTextureDirectly(B.TEXTURE_2D,M,!0),this._unpackFlipY(void 0===c||!!c),M.baseWidth=x.width,M.baseHeight=x.height,M.width=H,M.height=j,M.isReady=!0,M.type=-1!==M.type?M.type:0,M.format=-1!==M.format?M.format:K??(".jpg"!==Z||M._useSRGBBuffer?5:4),G(H,j,x,Z,M,(()=>{this._prepareWebGLTextureContinuation(M,P,w,v,mM)}))||this._prepareWebGLTextureContinuation(M,P,w,v,mM)):P&&P.removePendingData(M))}_getInternalFormatFromDepthTextureFormat(M,Z,P){const x=this._gl;if(!Z)return x.STENCIL_INDEX8;let c=P?x.DEPTH_STENCIL:x.DEPTH_COMPONENT;return this.webGLVersion>1?15===M?c=x.DEPTH_COMPONENT16:16===M?c=x.DEPTH_COMPONENT24:17===M||13===M?c=P?x.DEPTH24_STENCIL8:x.DEPTH_COMPONENT24:14===M?c=x.DEPTH_COMPONENT32F:18===M&&(c=P?x.DEPTH32F_STENCIL8:x.DEPTH_COMPONENT32F):c=x.DEPTH_COMPONENT16,c}_getWebGLTextureTypeFromDepthTextureFormat(M){const Z=this._gl;let P=Z.UNSIGNED_INT;return 15===M?P=Z.UNSIGNED_SHORT:17===M||13===M?P=Z.UNSIGNED_INT_24_8:14===M?P=Z.FLOAT:18===M?P=Z.FLOAT_32_UNSIGNED_INT_24_8_REV:19===M&&(P=Z.UNSIGNED_BYTE),P}_setupFramebufferDepthAttachments(M,Z,P,x){let c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,w=arguments.length>5?arguments[5]:void 0,v=arguments.length>6&&void 0!==arguments[6]&&arguments[6];const G=this._gl;w=w??(M?13:14);const mM=this._getInternalFormatFromDepthTextureFormat(w,Z,M);return M&&Z?this._createRenderBuffer(P,x,c,G.DEPTH_STENCIL,mM,v?-1:G.DEPTH_STENCIL_ATTACHMENT):Z?this._createRenderBuffer(P,x,c,mM,mM,v?-1:G.DEPTH_ATTACHMENT):M?this._createRenderBuffer(P,x,c,mM,mM,v?-1:G.STENCIL_ATTACHMENT):null}_createRenderBuffer(M,Z,P,x,c,w){let v=!(arguments.length>6&&void 0!==arguments[6])||arguments[6];const G=this._gl.createRenderbuffer();return this._updateRenderBuffer(G,M,Z,P,x,c,w,v)}_updateRenderBuffer(M,Z,P,x,c,w,v){let G=!(arguments.length>7&&void 0!==arguments[7])||arguments[7];const mM=this._gl;return mM.bindRenderbuffer(mM.RENDERBUFFER,M),x>1&&mM.renderbufferStorageMultisample?mM.renderbufferStorageMultisample(mM.RENDERBUFFER,x,w,Z,P):mM.renderbufferStorage(mM.RENDERBUFFER,c,Z,P),-1!==v&&mM.framebufferRenderbuffer(mM.FRAMEBUFFER,v,mM.RENDERBUFFER,M),G&&mM.bindRenderbuffer(mM.RENDERBUFFER,null),M}_releaseTexture(M){this._deleteTexture(M._hardwareTexture),this.unbindAllTextures();const Z=this._internalTexturesCache.indexOf(M);-1!==Z&&this._internalTexturesCache.splice(Z,1),M._lodTextureHigh&&M._lodTextureHigh.dispose(),M._lodTextureMid&&M._lodTextureMid.dispose(),M._lodTextureLow&&M._lodTextureLow.dispose(),M._irradianceTexture&&M._irradianceTexture.dispose()}_deleteTexture(M){null===M||void 0===M||M.release()}_setProgram(M){this._currentProgram!==M&&((0,x.n)(M,this._gl),this._currentProgram=M)}bindSamplers(M){const Z=M.getPipelineContext();this._setProgram(Z.program);const P=M.getSamplers();for(let x=0;x<P.length;x++){const Z=M.getUniform(P[x]);Z&&(this._boundUniforms[x]=Z)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(M,Z){let P=arguments.length>2&&void 0!==arguments[2]&&arguments[2],x=arguments.length>3&&void 0!==arguments[3]&&arguments[3],c=!1;const v=Z&&Z._associatedChannel>-1;P&&v&&(this._activeChannel=Z._associatedChannel);if(this._boundTexturesCache[this._activeChannel]!==Z||x){if(this._activateCurrentTexture(),Z&&Z.isMultiview)throw w.d.Error(["_bindTextureDirectly called with a multiview texture!",M,Z]),"_bindTextureDirectly called with a multiview texture!";var G;this._gl.bindTexture(M,(null===Z||void 0===Z||null===(G=Z._hardwareTexture)||void 0===G?void 0:G.underlyingResource)??null),this._boundTexturesCache[this._activeChannel]=Z,Z&&(Z._associatedChannel=this._activeChannel)}else P&&(c=!0,this._activateCurrentTexture());return v&&!P&&this._bindSamplerUniformToChannel(Z._associatedChannel,this._activeChannel),c}_bindTexture(M,Z,P){if(void 0===M)return;Z&&(Z._associatedChannel=M),this._activeChannel=M;const x=Z?this._getTextureTarget(Z):this._gl.TEXTURE_2D;this._bindTextureDirectly(x,Z)}unbindAllTextures(){for(let M=0;M<this._maxSimultaneousTextures;M++)this._activeChannel=M,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(M,Z,P,x){void 0!==M&&(Z&&(this._boundUniforms[M]=Z),this._setTexture(M,P))}_bindSamplerUniformToChannel(M,Z){const P=this._boundUniforms[M];P&&P._currentState!==Z&&(this._gl.uniform1i(P,Z),P._currentState=Z)}_getTextureWrapMode(M){switch(M){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(M,Z){let P,x=arguments.length>2&&void 0!==arguments[2]&&arguments[2],c=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!Z)return null!=this._boundTexturesCache[M]&&(this._activeChannel=M,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(Z.video){this._activeChannel=M;const P=Z.getInternalTexture();P&&(P._associatedChannel=M),Z.update()}else if(4===Z.delayLoadState)return Z.delayLoad(),!1;P=c?Z.depthStencilTexture:Z.isReady()?Z.getInternalTexture():Z.isCube?this.emptyCubeTexture:Z.is3D?this.emptyTexture3D:Z.is2DArray?this.emptyTexture2DArray:this.emptyTexture,!x&&P&&(P._associatedChannel=M);let w=!0;this._boundTexturesCache[M]===P&&(x||this._bindSamplerUniformToChannel(P._associatedChannel,M),w=!1),this._activeChannel=M;const v=this._getTextureTarget(P);if(w&&this._bindTextureDirectly(v,P,x),P&&!P.isMultiview){if(P.isCube&&P._cachedCoordinatesMode!==Z.coordinatesMode){P._cachedCoordinatesMode=Z.coordinatesMode;const M=3!==Z.coordinatesMode&&5!==Z.coordinatesMode?1:0;Z.wrapU=M,Z.wrapV=M}P._cachedWrapU!==Z.wrapU&&(P._cachedWrapU=Z.wrapU,this._setTextureParameterInteger(v,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(Z.wrapU),P)),P._cachedWrapV!==Z.wrapV&&(P._cachedWrapV=Z.wrapV,this._setTextureParameterInteger(v,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(Z.wrapV),P)),P.is3D&&P._cachedWrapR!==Z.wrapR&&(P._cachedWrapR=Z.wrapR,this._setTextureParameterInteger(v,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(Z.wrapR),P)),this._setAnisotropicLevel(v,P,Z.anisotropicFilteringLevel)}return!0}setTextureArray(M,Z,P,x){if(void 0!==M&&Z){this._textureUnits&&this._textureUnits.length===P.length||(this._textureUnits=new Int32Array(P.length));for(let Z=0;Z<P.length;Z++){const x=P[Z].getInternalTexture();x?(this._textureUnits[Z]=M+Z,x._associatedChannel=M+Z):this._textureUnits[Z]=-1}this._gl.uniform1iv(Z,this._textureUnits);for(let M=0;M<P.length;M++)this._setTexture(this._textureUnits[M],P[M],!0)}}_setAnisotropicLevel(M,Z,P){const x=this._caps.textureAnisotropicFilterExtension;11!==Z.samplingMode&&3!==Z.samplingMode&&2!==Z.samplingMode&&(P=1),x&&Z._cachedAnisotropicFilteringLevel!==P&&(this._setTextureParameterFloat(M,x.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(P,this._caps.maxAnisotropy),Z),Z._cachedAnisotropicFilteringLevel=P)}_setTextureParameterFloat(M,Z,P,x){this._bindTextureDirectly(M,x,!0,!0),this._gl.texParameterf(M,Z,P)}_setTextureParameterInteger(M,Z,P,x){x&&this._bindTextureDirectly(M,x,!0,!0),this._gl.texParameteri(M,Z,P)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let M=0;M<this._caps.maxVertexAttribs;M++)this.disableAttributeByIndex(M)}else for(let M=0,Z=this._vertexAttribArraysEnabled.length;M<Z;M++)M>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[M]||this.disableAttributeByIndex(M)}releaseEffects(){this._compiledEffects={},this.onReleaseEffectsObservable.notifyObservers(this)}dispose(){var M;((0,v.p)()&&this._renderingCanvas&&(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._onContextRestored&&this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),super.dispose(),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.unbindAllAttributes(),this._boundUniforms={},this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._currentProgram=null,this._creationOptions.loseContextOnDispose)&&(null===(M=this._gl.getExtension("WEBGL_lose_context"))||void 0===M||M.loseContext());(0,x.z)(this._gl)}attachContextLostEvent(M){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",M,!1)}attachContextRestoredEvent(M){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",M,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(M){const Z=this._gl;for(;Z.getError()!==Z.NO_ERROR;);let P=!0;const x=Z.createTexture();Z.bindTexture(Z.TEXTURE_2D,x),Z.texImage2D(Z.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(M),1,1,0,Z.RGBA,this._getWebGLTextureType(M),null),Z.texParameteri(Z.TEXTURE_2D,Z.TEXTURE_MIN_FILTER,Z.NEAREST),Z.texParameteri(Z.TEXTURE_2D,Z.TEXTURE_MAG_FILTER,Z.NEAREST);const c=Z.createFramebuffer();Z.bindFramebuffer(Z.FRAMEBUFFER,c),Z.framebufferTexture2D(Z.FRAMEBUFFER,Z.COLOR_ATTACHMENT0,Z.TEXTURE_2D,x,0);const w=Z.checkFramebufferStatus(Z.FRAMEBUFFER);if(P=P&&w===Z.FRAMEBUFFER_COMPLETE,P=P&&Z.getError()===Z.NO_ERROR,P&&(Z.clear(Z.COLOR_BUFFER_BIT),P=P&&Z.getError()===Z.NO_ERROR),P){Z.bindFramebuffer(Z.FRAMEBUFFER,null);const M=Z.RGBA,x=Z.UNSIGNED_BYTE,c=new Uint8Array(4);Z.readPixels(0,0,1,1,M,x,c),P=P&&Z.getError()===Z.NO_ERROR}for(Z.deleteTexture(x),Z.deleteFramebuffer(c),Z.bindFramebuffer(Z.FRAMEBUFFER,null);!P&&Z.getError()!==Z.NO_ERROR;);return P}_getWebGLTextureType(M){if(1===this._webGLVersion){switch(M){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(M){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(M){let Z=arguments.length>1&&void 0!==arguments[1]&&arguments[1],P=Z?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;switch(M){case 0:P=this._gl.ALPHA;break;case 1:P=this._gl.LUMINANCE;break;case 2:P=this._gl.LUMINANCE_ALPHA;break;case 6:case 33322:case 36760:P=this._gl.RED;break;case 7:case 33324:case 36761:P=this._gl.RG;break;case 4:case 32852:case 36762:P=Z?this._glSRGBExtensionValues.SRGB:this._gl.RGB;break;case 5:case 32859:case 36763:P=Z?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA}if(this._webGLVersion>1)switch(M){case 8:P=this._gl.RED_INTEGER;break;case 9:P=this._gl.RG_INTEGER;break;case 10:P=this._gl.RGB_INTEGER;break;case 11:P=this._gl.RGBA_INTEGER}return P}_getRGBABufferInternalSizedFormat(M,Z){let P=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(1===this._webGLVersion){if(void 0!==Z)switch(Z){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return P?this._glSRGBExtensionValues.SRGB:this._gl.RGB}return this._gl.RGBA}switch(M){case 3:switch(Z){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(Z){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return P?this._glSRGBExtensionValues.SRGB8:this._gl.RGB8;case 5:return P?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(Z){case 8:return this._gl.R16I;case 36760:return this._gl.R16_SNORM_EXT;case 36761:return this._gl.RG16_SNORM_EXT;case 36762:return this._gl.RGB16_SNORM_EXT;case 36763:return this._gl.RGBA16_SNORM_EXT;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;default:return this._gl.RGBA16I}case 5:switch(Z){case 8:return this._gl.R16UI;case 33322:return this._gl.R16_EXT;case 33324:return this._gl.RG16_EXT;case 32852:return this._gl.RGB16_EXT;case 32859:return this._gl.RGBA16_EXT;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;default:return this._gl.RGBA16UI}case 6:switch(Z){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;default:return this._gl.RGBA32I}case 7:switch(Z){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;default:return this._gl.RGBA32UI}case 1:switch(Z){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;default:return this._gl.RGBA32F}case 2:switch(Z){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(Z){case 5:default:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI}}return P?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8}readPixels(M,Z,P,x){let c=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],v=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],G=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;const mM=c?4:3,K=c?this._gl.RGBA:this._gl.RGB,d=P*x*mM;if(G){if(G.length<d)return w.d.Error(`Data buffer is too small to store the read pixels (${G.length} should be more than ${d})`),Promise.resolve(G)}else G=new Uint8Array(d);return v&&this.flushFramebuffer(),this._gl.readPixels(M,Z,P,x,K,this._gl.UNSIGNED_BYTE,G),Promise.resolve(G)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(null!==this._HasMajorPerformanceCaveat)return!this._HasMajorPerformanceCaveat;if(null===this._IsSupported)try{const M=H.e._CreateCanvas(1,1),Z=M.getContext("webgl")||M.getContext("experimental-webgl");this._IsSupported=null!=Z&&!!window.WebGLRenderingContext}catch(M){this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(null===this._HasMajorPerformanceCaveat)try{const M=H.e._CreateCanvas(1,1),Z=M.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||M.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!Z}catch(M){this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}}J._TempClearColorUint32=new Uint32Array(4),J._TempClearColorInt32=new Int32Array(4),J.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/12\\d\\..+?Mobile",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}],J._ConcatenateShader=n.i,J._IsSupported=null,J._HasMajorPerformanceCaveat=null},12418:(M,Z,P)=>{P.d(Z,{d:()=>j});var x=P(12184),c=P(12373),w=P(12344),v=P(12426),G=P(12332),mM=P(12262),K=P(12199),d=P(12452),O=P(12379);class H{get renderList(){return this._renderList}set renderList(M){this._renderList!==M&&(this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),M&&(this._unObserveRenderList=(0,O.i)(M,this._renderListHasChanged)),this._renderList=M)}get disableImageProcessing(){return this._disableImageProcessing}set disableImageProcessing(M){M!==this._disableImageProcessing&&(this._disableImageProcessing=M,this._scene.markAllMaterialsAsDirty(64))}get name(){return this._name}set name(M){if(this._name===M)return;if(this._name=M,!this._scene)return;const Z=this._scene.getEngine();for(let P=0;P<this._renderPassIds.length;++P){const M=this._renderPassIds[P];Z._renderPassNames[M]=`${this._name}#${P}`}}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}setMaterialForRendering(M,Z){let P;P=Array.isArray(M)?M:[M];for(let x=0;x<P.length;++x)for(let M=0;M<this.options.numPasses;++M){let c=P[x];P[x].isAnInstance&&(c=P[x].sourceMesh),c.setMaterialForRenderPass(this._renderPassIds[M],void 0!==Z?Array.isArray(Z)?Z[M]:Z:void 0)}}constructor(M,Z,P){this._unObserveRenderList=null,this._renderListHasChanged=(M,Z)=>{const P=this._renderList?this._renderList.length:0;if(0===Z&&P>0||0===P)for(const x of this._scene.meshes)x._markSubMeshesAsLightDirty()},this.particleSystemList=null,this.getCustomRenderList=null,this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this._disableImageProcessing=!1,this.onBeforeRenderObservable=new x.b,this.onAfterRenderObservable=new x.b,this.onBeforeRenderingManagerRenderObservable=new x.b,this.onAfterRenderingManagerRenderObservable=new x.b,this.onFastPathRenderObservable=new x.b,this._currentRefreshId=-1,this._refreshRate=1,this._currentApplyByPostProcessSetting=!1,this._currentSceneCamera=null,this.name=M,this._scene=Z,this.renderList=[],this._renderPassIds=[],this.options={numPasses:1,doNotChangeAspectRatio:!0,...P},this._createRenderPassId(),this.renderPassId=this._renderPassIds[0],this._renderingManager=new d.d(Z),this._renderingManager._useSceneAutoClearSetup=!0}_releaseRenderPassId(){const M=this._scene.getEngine();for(let Z=0;Z<this.options.numPasses;++Z)M.releaseRenderPassId(this._renderPassIds[Z]);this._renderPassIds.length=0}_createRenderPassId(){this._releaseRenderPassId();const M=this._scene.getEngine();for(let Z=0;Z<this.options.numPasses;++Z)this._renderPassIds[Z]=M.createRenderPassId(`${this.name}#${Z}`)}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(M){this._refreshRate=M,this.resetRefreshCounter()}shouldRender(){return-1===this._currentRefreshId||this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}isReadyForRendering(M,Z){this.prepareRenderList(),this.initRender(M,Z);const P=this._checkReadiness();return this.finishRender(),P}prepareRenderList(){const M=this._scene;if(this._waitingRenderList){if(!this.renderListPredicate){this.renderList=[];for(let Z=0;Z<this._waitingRenderList.length;Z++){const P=this._waitingRenderList[Z],x=M.getMeshById(P);x&&this.renderList.push(x)}}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const M=this._scene.meshes;for(let Z=0;Z<M.length;Z++){const P=M[Z];this.renderListPredicate(P)&&this.renderList.push(P)}}this._currentApplyByPostProcessSetting=this._scene.imageProcessingConfiguration.applyByPostProcess,this._disableImageProcessing&&(this._scene.imageProcessingConfiguration._applyByPostProcess=this._disableImageProcessing)}initRender(M,Z){const P=this._scene.getEngine(),x=this.activeCamera??this._scene.activeCamera;this._currentSceneCamera=this._scene.activeCamera,x&&(x!==this._scene.activeCamera&&(this._scene.setTransformMatrix(x.getViewMatrix(),x.getProjectionMatrix(!0)),this._scene.activeCamera=x),P.setViewport(x.rigParent?x.rigParent.viewport:x.viewport,M,Z)),this._defaultRenderListPrepared=!1}finishRender(){const M=this._scene;this._disableImageProcessing&&(M.imageProcessingConfiguration._applyByPostProcess=this._currentApplyByPostProcessSetting),M.activeCamera=this._currentSceneCamera,this._currentSceneCamera&&(this.activeCamera&&this.activeCamera!==M.activeCamera&&M.setTransformMatrix(this._currentSceneCamera.getViewMatrix(),this._currentSceneCamera.getProjectionMatrix(!0)),M.getEngine().setViewport(this._currentSceneCamera.viewport)),M.resetCachedMaterial()}render(){let M=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,Z=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const P=this._scene,x=P.getEngine(),c=x.currentRenderPassId;x.currentRenderPassId=this._renderPassIds[M],this.onBeforeRenderObservable.notifyObservers(M);if(x.snapshotRendering&&1===x.snapshotRenderingMode)this.onFastPathRenderObservable.notifyObservers(M);else{let Z=null;const x=this.renderList?this.renderList:P.getActiveMeshes().data,c=this.renderList?this.renderList.length:P.getActiveMeshes().length;this.getCustomRenderList&&(Z=this.getCustomRenderList(M,x,c)),Z?this._prepareRenderingManager(Z,Z.length,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(x,c,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),Z=x),this.onBeforeRenderingManagerRenderObservable.notifyObservers(M),this._renderingManager.render(this.customRenderFunction,Z,this.renderParticles,this.renderSprites),this.onAfterRenderingManagerRenderObservable.notifyObservers(M)}Z||this.onAfterRenderObservable.notifyObservers(M),x.currentRenderPassId=c}_checkReadiness(){const M=this._scene,Z=M.getEngine(),P=Z.currentRenderPassId;let x=!0;M.getViewMatrix()||M.updateTransformMatrix();const c=this.options.numPasses;for(let v=0;v<c&&x;v++){let P=null;const w=this.renderList?this.renderList:M.getActiveMeshes().data,G=this.renderList?this.renderList.length:M.getActiveMeshes().length;Z.currentRenderPassId=this._renderPassIds[v],this.onBeforeRenderObservable.notifyObservers(v),this.getCustomRenderList&&(P=this.getCustomRenderList(v,w,G)),P||(P=w),this.options.doNotChangeAspectRatio||M.updateTransformMatrix(!0);for(let M=0;M<P.length&&x;++M){const Z=P[M];if(Z.isEnabled()&&!Z.isBlocked&&Z.isVisible&&Z.Uc)if(this.customIsReadyFunction){if(!this.customIsReadyFunction(Z,this.refreshRate,!0)){x=!1;continue}}else if(!Z.isReady(!0)){x=!1;continue}}this.onAfterRenderObservable.notifyObservers(v),c>1&&(M.incrementRenderId(),M.resetCachedMaterial())}const w=this.particleSystemList||M.SH;for(const v of w)v.isReady()||(x=!1);return Z.currentRenderPassId=P,x}_prepareRenderingManager(M,Z,P){const x=this._scene,c=x.activeCamera,w=this.cameraForLOD??c;this._renderingManager.reset();const v=x.getRenderId(),G=x.getFrameId();for(let K=0;K<Z;K++){const Z=M[K];if(Z&&!Z.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(Z,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!Z.isReady(0===this.refreshRate)){this.resetRefreshCounter();continue}let M,mM=null;if(w){const M=Z._internalAbstractMeshDataInfo._currentLOD.get(w);M&&M[1]===G?mM=M[0]:(mM=x.customLODSelector?x.customLODSelector(Z,w):Z.getLOD(w),M?(M[0]=mM,M[1]=G):Z._internalAbstractMeshDataInfo._currentLOD.set(w,[mM,G]))}else mM=Z;if(!mM)continue;if(mM!==Z&&0!==mM.billboardMode&&mM.Jc(),mM._preActivateForIntermediateRendering(v),M=!(!P||!c)&&0===(Z.layerMask&c.layerMask),Z.isEnabled()&&Z.isVisible&&Z.Uc&&!M){if(mM!==Z&&mM._activate(v,!0),Z._activate(v,!0)&&Z.Uc.length){Z.isAnInstance?Z._internalAbstractMeshDataInfo._actAsRegularMesh&&(mM=Z):mM._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,mM._internalAbstractMeshDataInfo._isActiveIntermediate=!0,x._prepareSkeleton(mM);for(let M=0;M<mM.Uc.length;M++){const Z=mM.Uc[M];this._renderingManager.dispatch(Z,mM)}}Z._postActivate()}}}const mM=this.particleSystemList||x.SH;for(let K=0;K<mM.length;K++){const M=mM[K],Z=M.xZ;M.isStarted()&&Z&&(!Z.position||Z.isEnabled())&&this._renderingManager.dispatchParticles(M)}}setRenderingOrder(M){let Z=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,P=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,x=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this._renderingManager.setRenderingOrder(M,Z,P,x)}setRenderingAutoClearDepthStencil(M,Z){let P=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],x=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];this._renderingManager.setRenderingAutoClearDepthStencil(M,Z,P,x),this._renderingManager._useSceneAutoClearSetup=!1}clone(){const M=new H(this.name,this._scene,this.options);return this.renderList&&(M.renderList=this.renderList.slice(0)),M}dispose(){const M=this.renderList?this.renderList:this._scene.getActiveMeshes().data,Z=this.renderList?this.renderList.length:this._scene.getActiveMeshes().length;for(let P=0;P<Z;P++){const Z=M[P];Z&&void 0!==Z.getMaterialForRenderPass(this.renderPassId)&&Z.setMaterialForRenderPass(this.renderPassId,void 0)}this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderingManagerRenderObservable.clear(),this.onAfterRenderingManagerRenderObservable.clear(),this.onFastPathRenderObservable.clear(),this._releaseRenderPassId(),this.renderList=null}_rebuild(){this.refreshRate===H.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=H.REFRESHRATE_RENDER_ONCE)}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}}H.REFRESHRATE_RENDER_ONCE=0,H.REFRESHRATE_RENDER_ONEVERYFRAME=1,H.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,mM.Effect.prototype.setDepthStencilTexture=function(M,Z){this._engine.setDepthStencilTexture(this._samplers[M],this._uniforms[M],Z,M)};class j extends w.e{get renderListPredicate(){return this._objectRenderer.renderListPredicate}set renderListPredicate(M){this._objectRenderer.renderListPredicate=M}get renderList(){return this._objectRenderer.renderList}set renderList(M){this._objectRenderer.renderList=M}get particleSystemList(){return this._objectRenderer.particleSystemList}set particleSystemList(M){this._objectRenderer.particleSystemList=M}get getCustomRenderList(){return this._objectRenderer.getCustomRenderList}set getCustomRenderList(M){this._objectRenderer.getCustomRenderList=M}get renderParticles(){return this._objectRenderer.renderParticles}set renderParticles(M){this._objectRenderer.renderParticles=M}get renderSprites(){return this._objectRenderer.renderSprites}set renderSprites(M){this._objectRenderer.renderSprites=M}get forceLayerMaskCheck(){return this._objectRenderer.forceLayerMaskCheck}set forceLayerMaskCheck(M){this._objectRenderer.forceLayerMaskCheck=M}get activeCamera(){return this._objectRenderer.activeCamera}set activeCamera(M){this._objectRenderer.activeCamera=M}get cameraForLOD(){return this._objectRenderer.cameraForLOD}set cameraForLOD(M){this._objectRenderer.cameraForLOD=M}get disableImageProcessing(){return this._objectRenderer.disableImageProcessing}set disableImageProcessing(M){this._objectRenderer.disableImageProcessing=M}get customIsReadyFunction(){return this._objectRenderer.customIsReadyFunction}set customIsReadyFunction(M){this._objectRenderer.customIsReadyFunction=M}get customRenderFunction(){return this._objectRenderer.customRenderFunction}set customRenderFunction(M){this._objectRenderer.customRenderFunction=M}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(M){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(M)}get onBeforeRenderObservable(){return this._objectRenderer.onBeforeRenderObservable}set onBeforeRender(M){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(M)}get onAfterRenderObservable(){return this._objectRenderer.onAfterRenderObservable}set onAfterRender(M){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(M)}set onClear(M){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(M)}get _waitingRenderList(){return this._objectRenderer._waitingRenderList}set _waitingRenderList(M){this._objectRenderer._waitingRenderList=M}get renderPassId(){return this._objectRenderer.renderPassId}get renderPassIds(){return this._objectRenderer.renderPassIds}get currentRefreshId(){return this._objectRenderer.currentRefreshId}setMaterialForRendering(M,Z){this._objectRenderer.setMaterialForRendering(M,Z)}get isMulti(){var M;return(null===(M=this._renderTarget)||void 0===M?void 0:M.isMulti)??!1}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(M){if(this._boundingBoxSize&&this._boundingBoxSize.equals(M))return;this._boundingBoxSize=M;const Z=this.DM();Z&&Z.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){var M;return(null===(M=this._renderTarget)||void 0===M?void 0:M._depthStencilTexture)??null}constructor(M,Z,P){let v,G,mM=arguments.length>3&&void 0!==arguments[3]&&arguments[3],d=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],O=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,j=arguments.length>6&&void 0!==arguments[6]&&arguments[6],B=arguments.length>7&&void 0!==arguments[7]?arguments[7]:w.e.TRILINEAR_SAMPLINGMODE,U=!(arguments.length>8&&void 0!==arguments[8])||arguments[8],n=arguments.length>9&&void 0!==arguments[9]&&arguments[9],L=arguments.length>10&&void 0!==arguments[10]&&arguments[10],u=arguments.length>11&&void 0!==arguments[11]?arguments[11]:5,N=arguments.length>12&&void 0!==arguments[12]&&arguments[12],J=arguments.length>13?arguments[13]:void 0,t=arguments.length>14?arguments[14]:void 0,F=arguments.length>15&&void 0!==arguments[15]&&arguments[15],D=arguments.length>16&&void 0!==arguments[16]&&arguments[16],l=!0;if("object"===typeof mM){const M=mM;mM=!!M.generateMipMaps,d=M.doNotChangeAspectRatio??!0,O=M.type??0,j=!!M.isCube,B=M.samplingMode??w.e.TRILINEAR_SAMPLINGMODE,U=M.generateDepthBuffer??!0,n=!!M.generateStencilBuffer,L=!!M.isMulti,u=M.format??5,N=!!M.delayAllocation,J=M.samples,t=M.creationFlags,F=!!M.noColorAttachment,D=!!M.useSRGBBuffer,v=M.colorAttachment,l=M.gammaSpace??l,G=M.existingObjectRenderer}if(super(null,P,!mM,void 0,B,void 0,void 0,void 0,void 0,u),this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new x.b,this.onAfterUnbindObservable=new x.b,this.onClearObservable=new x.b,this.onResizeObservable=new x.b,this._cleared=!1,this.skipInitialClear=!1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this._dontDisposeObjectRenderer=!1,this.boundingBoxPosition=c.BZ.Zero(),this._disableEngineStages=!1,this._dumpToolsLoading=!1,!(P=this.DM()))return;const h=this.DM().getEngine();this._gammaSpace=l,this._coordinatesMode=w.e.PROJECTION_MODE,this.name=M,this.isRenderTarget=!0,this._initialSizeParameter=Z,this._dontDisposeObjectRenderer=!!G,this._processSizeParameter(Z),this._objectRenderer=G??new H(M,P,{numPasses:j?6:this.getRenderLayers()||1,doNotChangeAspectRatio:d}),this._onBeforeRenderingManagerRenderObserver=this._objectRenderer.onBeforeRenderingManagerRenderObservable.add((()=>{if(!this._disableEngineStages)for(const M of this._scene._beforeRenderTargetClearStage)M.action(this,this._currentFaceIndex,this._currentLayer);if(this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(h):this.skipInitialClear||h.clear(this.clearColor||this._scene.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),!this._disableEngineStages)for(const M of this._scene._beforeRenderTargetDrawStage)M.action(this,this._currentFaceIndex,this._currentLayer)})),this._onAfterRenderingManagerRenderObserver=this._objectRenderer.onAfterRenderingManagerRenderObservable.add((()=>{var M;if(!this._disableEngineStages)for(const P of this._scene._afterRenderTargetDrawStage)P.action(this,this._currentFaceIndex,this._currentLayer);const Z=(null===(M=this._texture)||void 0===M?void 0:M.generateMipMaps)??!1;if(this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex,this._postProcesses,this.ignoreCameraViewport):this._currentUseCameraPostProcess&&this._scene.postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex),!this._disableEngineStages)for(const P of this._scene._afterRenderTargetPostProcessStage)P.action(this,this._currentFaceIndex,this._currentLayer);this._texture&&(this._texture.generateMipMaps=Z),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),this._currentDumpForDebug&&(this._dumpTools?this._dumpTools.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),h):K.d.Error("dumpTools module is still being loaded. To speed up the process import dump tools directly in your project"))})),this._onFastPathRenderObserver=this._objectRenderer.onFastPathRenderObservable.add((()=>{this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(h):this.skipInitialClear||h.clear(this.clearColor||this._scene.clearColor,!0,!0,!0)})),this._resizeObserver=h.onResizeObservable.add((()=>{})),this._generateMipMaps=!!mM,this._doNotChangeAspectRatio=d,L||(this._renderTargetOptions={generateMipMaps:mM,type:O,format:this._format??void 0,samplingMode:this.samplingMode,generateDepthBuffer:U,generateStencilBuffer:n,samples:J,creationFlags:t,noColorAttachment:F,useSRGBBuffer:D,colorAttachment:v,label:this.name},this.samplingMode===w.e.NEAREST_SAMPLINGMODE&&(this.wrapU=w.e.CLAMP_ADDRESSMODE,this.wrapV=w.e.CLAMP_ADDRESSMODE),N||(j?(this._renderTarget=P.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=w.e.INVCUBIC_MODE,this._textureMatrix=c.Matrix.Identity()):this._renderTarget=P.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==J&&(this.samples=J)))}createDepthStencilTexture(){var M;let Z=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,P=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],x=arguments.length>2&&void 0!==arguments[2]&&arguments[2],c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,w=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14,v=arguments.length>5?arguments[5]:void 0;null===(M=this._renderTarget)||void 0===M||M.createDepthStencilTexture(Z,P,x,c,w,v)}_processSizeParameter(M){if(M.ratio){this._sizeRatio=M.ratio;const Z=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(Z.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(Z.getRenderHeight(),this._sizeRatio)}}else this._size=M}get samples(){var M;return(null===(M=this._renderTarget)||void 0===M?void 0:M.samples)??this._samples}set samples(M){this._renderTarget&&(this._samples=this._renderTarget.setSamples(M))}addPostProcess(M){if(!this._postProcessManager){const M=this.DM();if(!M)return;this._postProcessManager=new v.c(M),this._postProcesses=new Array}this._postProcesses.push(M),this._postProcesses[0].Bc=!1}clearPostProcesses(){let M=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._postProcesses){if(M)for(const M of this._postProcesses)M.dispose();this._postProcesses=[]}}removePostProcess(M){if(!this._postProcesses)return;const Z=this._postProcesses.indexOf(M);-1!==Z&&(this._postProcesses.splice(Z,1),this._postProcesses.length>0&&(this._postProcesses[0].Bc=!1))}resetRefreshCounter(){this._objectRenderer.resetRefreshCounter()}get refreshRate(){return this._objectRenderer.refreshRate}set refreshRate(M){this._objectRenderer.refreshRate=M}_shouldRender(){return this._objectRenderer.shouldRender()}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){const M=this._size.layers;if(M)return M;const Z=this._size.depth;return Z||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(M){const Z=Math.max(1,this.getRenderSize()*M);this.resize(Z)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(M){var Z;const P=this.isCube;null===(Z=this._renderTarget)||void 0===Z||Z.dispose(),this._renderTarget=null;const x=this.DM();x&&(this._processSizeParameter(M),this._renderTarget=P?x.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):x.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==this._renderTargetOptions.samples&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(){let M=arguments.length>0&&void 0!==arguments[0]&&arguments[0],Z=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._render(M,Z)}isReadyForRendering(){this._dumpToolsLoading||(this._dumpToolsLoading=!0,P.e(20).then(P.bind(P,12579)).then((M=>this._dumpTools=M))),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight());const M=this._objectRenderer._checkReadiness();return this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender(),M}_render(){let M=arguments.length>0&&void 0!==arguments[0]&&arguments[0],Z=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const P=this.DM();if(P){if(void 0!==this.useCameraPostProcesses&&(M=this.useCameraPostProcesses),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight()),!this.is2DArray&&!this.is3D||this.isMulti)if(this.isCube&&!this.isMulti)for(let x=0;x<6;x++)this._renderToTarget(x,M,Z),P.incrementRenderId(),P.resetCachedMaterial();else this._renderToTarget(0,M,Z);else for(let x=0;x<this.getRenderLayers();x++)this._renderToTarget(0,M,Z,x),P.incrementRenderId(),P.resetCachedMaterial();this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender()}}_bestReflectionRenderTargetDimension(M,Z){const P=M*Z,x=(0,G.o)(P+16384/(128+P));return Math.min((0,G.b)(M),x)}_bindFrameBuffer(){let M=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,Z=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const P=this.DM();if(!P)return;const x=P.getEngine();this._renderTarget&&x.bindFramebuffer(this._renderTarget,this.isCube?M:void 0,void 0,void 0,this.ignoreCameraViewport,0,Z)}_unbindFrameBuffer(M,Z){this._renderTarget&&M.unBindFramebuffer(this._renderTarget,this.isCube,(()=>{this.onAfterRenderObservable.notifyObservers(Z)}))}_prepareFrame(M,Z,P,x){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses)||this._bindFrameBuffer(Z,P):x&&M.postProcessManager._prepareFrame(this._texture)||this._bindFrameBuffer(Z,P)}_renderToTarget(M,Z,P){var x,c;let w=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const v=this.DM();if(!v)return;const G=v.getEngine();this._currentFaceIndex=M,this._currentLayer=w,this._currentUseCameraPostProcess=Z,this._currentDumpForDebug=P,this._prepareFrame(v,M,w,Z),null===(x=G._debugPushGroup)||void 0===x||x.call(G,`render to face #${M} layer #${w}`,2),this._objectRenderer.render(M+w,!0),null===(c=G._debugPopGroup)||void 0===c||c.call(G,2),this._unbindFrameBuffer(G,M),this._texture&&this.isCube&&5===M&&G.generateMipMapsForCubemap(this._texture,!0)}setRenderingOrder(M){let Z=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,P=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,x=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this._objectRenderer.setRenderingOrder(M,Z,P,x)}setRenderingAutoClearDepthStencil(M,Z){this._objectRenderer.setRenderingAutoClearDepthStencil(M,Z)}clone(){const M=this.getSize(),Z=new j(this.name,M,this.DM(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return Z.Lc=this.Lc,Z.level=this.level,Z.coordinatesMode=this.coordinatesMode,this.renderList&&(Z.renderList=this.renderList.slice(0)),Z}serialize(){if(!this.name)return null;const M=super.serialize();if(M.renderTargetSize=this.getRenderSize(),M.renderList=[],this.renderList)for(let Z=0;Z<this.renderList.length;Z++)M.renderList.push(this.renderList[Z].id);return M}disposeFramebufferObjects(){var M;null===(M=this._renderTarget)||void 0===M||M.dispose(!0)}releaseInternalTexture(){var M;null===(M=this._renderTarget)||void 0===M||M.releaseTextures(),this._texture=null}dispose(){var M;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._objectRenderer.onBeforeRenderingManagerRenderObservable.remove(this._onBeforeRenderingManagerRenderObserver),this._objectRenderer.onAfterRenderingManagerRenderObservable.remove(this._onAfterRenderingManagerRenderObserver),this._objectRenderer.onFastPathRenderObservable.remove(this._onFastPathRenderObserver),this._dontDisposeObjectRenderer||this._objectRenderer.dispose(),this.clearPostProcesses(!0),this._resizeObserver&&(this.DM().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null);const Z=this.DM();if(!Z)return;let P=Z.customRenderTargets.indexOf(this);P>=0&&Z.customRenderTargets.splice(P,1);for(const x of Z.cameras)P=x.customRenderTargets.indexOf(this),P>=0&&x.customRenderTargets.splice(P,1);null===(M=this._renderTarget)||void 0===M||M.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this._objectRenderer._rebuild(),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._objectRenderer.freeRenderingGroups()}getViewCount(){return 1}}j.REFRESHRATE_RENDER_ONCE=H.REFRESHRATE_RENDER_ONCE,j.REFRESHRATE_RENDER_ONEVERYFRAME=H.REFRESHRATE_RENDER_ONEVERYFRAME,j.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=H.REFRESHRATE_RENDER_ONEVERYTWOFRAMES,w.e._CreateRenderTargetTexture=(M,Z,P,x,c)=>new j(M,Z,P,x)},12522:(M,Z,P)=>{function x(M){return 13===M||14===M||15===M||16===M||17===M||18===M||19===M}function c(M){return 13===M||17===M||18===M||19===M}P.d(Z,{d:()=>c,h:()=>x})},12497:(M,Z,P)=>{function x(M){return void 0===M.getPipelineContext}P.d(Z,{b:()=>x})},12464:(M,Z,P)=>{P.d(Z,{d:()=>K,f:()=>d});var x=P(12430),c=P(12469),w=P(12184),v=P(12262),G=P(12471);P(12475);const mM={hM:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class K{constructor(M){let Z=arguments.length>1&&void 0!==arguments[1]?arguments[1]:mM;this._fullscreenViewport=new c.b(0,0,1,1);const P=Z.hM??mM.hM,w=Z.indices??mM.indices;this.jZ=M,this._vertexBuffers={[x.g.PositionKind]:new x.g(M,P,x.g.PositionKind,!1,!1,2)},this._indexBuffer=M.createIndexBuffer(w),this._indexBufferLength=w.length,this._onContextRestoredObserver=M.onContextRestoredObservable.add((()=>{this._indexBuffer=M.createIndexBuffer(w);for(const M in this._vertexBuffers){this._vertexBuffers[M]._rebuild()}}))}setViewport(){let M=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._fullscreenViewport;this.jZ.setViewport(M)}bindBuffers(M){this.jZ.bindBuffers(this._vertexBuffers,this._indexBuffer,M)}applyEffectWrapper(M){this.jZ.setState(!0),this.jZ.depthCullingState.depthTest=!1,this.jZ.stencilState.stencilTest=!1,this.jZ.enableEffect(M.drawWrapper),this.bindBuffers(M.effect),M.onApplyObservable.notifyObservers({})}saveStates(){this._savedStateDepthTest=this.jZ.depthCullingState.depthTest,this._savedStateStencilTest=this.jZ.stencilState.stencilTest}restoreStates(){this.jZ.depthCullingState.depthTest=this._savedStateDepthTest,this.jZ.stencilState.stencilTest=this._savedStateStencilTest}draw(){this.jZ.drawElementsType(0,0,this._indexBufferLength)}_isRenderTargetTexture(M){return void 0!==M.renderTarget}render(M){let Z=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!M.effect.isReady())return;this.saveStates(),this.setViewport();const P=null===Z?null:this._isRenderTargetTexture(Z)?Z.renderTarget:Z;P&&this.jZ.bindFramebuffer(P),this.applyEffectWrapper(M),this.draw(),P&&this.jZ.unBindFramebuffer(P),this.restoreStates()}dispose(){const M=this._vertexBuffers[x.g.PositionKind];M&&(M.dispose(),delete this._vertexBuffers[x.g.PositionKind]),this._indexBuffer&&this.jZ._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.jZ.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}}class d{static RegisterShaderCodeProcessing(M,Z){Z?d._CustomShaderCodeProcessing[M??""]=Z:delete d._CustomShaderCodeProcessing[M??""]}static _GetShaderCodeProcessing(M){return d._CustomShaderCodeProcessing[M]??d._CustomShaderCodeProcessing[""]}get name(){return this.options.name}set name(M){this.options.name=M}isReady(){var M;return(null===(M=this._drawWrapper.effect)||void 0===M?void 0:M.isReady())??!1}get drawWrapper(){return this._drawWrapper}get effect(){return this._drawWrapper.effect}set effect(M){this._drawWrapper.effect=M}constructor(M){this.alphaMode=0,this.onEffectCreatedObservable=new w.b(void 0,!0),this.onApplyObservable=new w.b,this._shadersLoaded=!1,this._webGPUReady=!1,this._importPromises=[],this.options={...M,name:M.name||"effectWrapper",jZ:M.jZ,uniforms:M.uniforms||M.uniformNames||[],uniformNames:void 0,samplers:M.samplers||M.samplerNames||[],samplerNames:void 0,attributeNames:M.attributeNames||["position"],uniformBuffers:M.uniformBuffers||[],defines:M.defines||"",useShaderStore:M.useShaderStore||!1,vertexUrl:M.vertexUrl||M.vertexShader||"postprocess",vertexShader:void 0,fragmentShader:M.fragmentShader||"pass",indexParameters:M.indexParameters,blockCompilation:M.blockCompilation||!1,shaderLanguage:M.shaderLanguage||0,onCompiled:M.onCompiled||void 0,extraInitializations:M.extraInitializations||void 0,extraInitializationsAsync:M.extraInitializationsAsync||void 0,useAsPostProcess:M.useAsPostProcess??!1},this.options.uniformNames=this.options.uniforms,this.options.samplerNames=this.options.samplers,this.options.vertexShader=this.options.vertexUrl,this.options.useAsPostProcess&&(-1===this.options.samplers.indexOf("textureSampler")&&this.options.samplers.push("textureSampler"),-1===this.options.uniforms.indexOf("scale")&&this.options.uniforms.push("scale")),M.vertexUrl||M.vertexShader?this._shaderPath={vertexSource:this.options.vertexShader}:(this.options.useAsPostProcess||(this.options.uniforms.push("scale"),this.onApplyObservable.add((()=>{this.effect.setFloat2("scale",1,1)}))),this._shaderPath={vertex:this.options.vertexShader}),this._shaderPath.fragmentSource=this.options.fragmentShader,this._shaderPath.spectorName=this.options.name,this.options.useShaderStore&&(this._shaderPath.fragment=this._shaderPath.fragmentSource,this._shaderPath.vertex||(this._shaderPath.vertex=this._shaderPath.vertexSource),delete this._shaderPath.fragmentSource,delete this._shaderPath.vertexSource),this.onApplyObservable.add((()=>{this.bind()})),this.options.useShaderStore||(this._onContextRestoredObserver=this.options.jZ.onContextRestoredObservable.add((()=>{this.effect._pipelineContext=null,this.effect._prepareEffect()}))),this._drawWrapper=new G.e(this.options.jZ),this._webGPUReady=1===this.options.shaderLanguage;const Z=Array.isArray(this.options.defines)?this.options.defines.join("\n"):this.options.defines;this._postConstructor(this.options.blockCompilation,Z,this.options.extraInitializations)}_gatherImports(){let M=arguments.length>0&&void 0!==arguments[0]&&arguments[0],Z=arguments.length>1?arguments[1]:void 0;this.options.useAsPostProcess&&(M&&this._webGPUReady?Z.push(Promise.all([P.e(53).then(P.bind(P,14886))])):Z.push(Promise.all([Promise.resolve().then(P.bind(P,12475))])))}_postConstructor(M){let Z=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,P=arguments.length>2?arguments[2]:void 0,x=arguments.length>3?arguments[3]:void 0;this._importPromises.length=0,x&&this._importPromises.push(...x);const c=this.options.jZ.isWebGPU&&!d.ForceGLSL;this._gatherImports(c,this._importPromises),void 0!==P&&P(c,this._importPromises),c&&this._webGPUReady&&(this.options.shaderLanguage=1),M||this.updateEffect(Z)}updateEffect(){let M=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,Z=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,P=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,x=arguments.length>3?arguments[3]:void 0,c=arguments.length>4?arguments[4]:void 0,w=arguments.length>5?arguments[5]:void 0,G=arguments.length>6?arguments[6]:void 0,mM=arguments.length>7?arguments[7]:void 0;const K=d._GetShaderCodeProcessing(this.name);if(null!==K&&void 0!==K&&K.defineCustomBindings){var O,H;const x=(null===(O=Z)||void 0===O?void 0:O.slice())??[];x.push(...this.options.uniforms);const c=(null===(H=P)||void 0===H?void 0:H.slice())??[];c.push(...this.options.samplers),M=K.defineCustomBindings(this.name,M,x,c),Z=x,P=c}this.options.defines=M||"";const j=this._shadersLoaded||0===this._importPromises.length?void 0:async()=>{await Promise.all(this._importPromises),this._shadersLoaded=!0};let B;B=this.options.extraInitializationsAsync?async()=>{null===j||void 0===j||j(),await this.options.extraInitializationsAsync()}:j,this.options.useShaderStore?this._drawWrapper.effect=this.options.jZ.createEffect({vertex:G??this._shaderPath.vertex,fragment:mM??this._shaderPath.fragment},{attributes:this.options.attributeNames,uniformsNames:Z||this.options.uniforms,uniformBuffersNames:this.options.uniformBuffers,samplers:P||this.options.samplers,defines:null!==M?M:"",fallbacks:null,onCompiled:c??this.options.onCompiled,onError:w??null,indexParameters:x||this.options.indexParameters,processCodeAfterIncludes:null!==K&&void 0!==K&&K.processCodeAfterIncludes?(M,Z)=>K.processCodeAfterIncludes(this.name,M,Z):null,processFinalCode:null!==K&&void 0!==K&&K.processFinalCode?(M,Z)=>K.processFinalCode(this.name,M,Z):null,shaderLanguage:this.options.shaderLanguage,extraInitializationsAsync:B},this.options.jZ):this._drawWrapper.effect=new v.Effect(this._shaderPath,this.options.attributeNames,Z||this.options.uniforms,P||this.options.samplerNames,this.options.jZ,M,void 0,c||this.options.onCompiled,void 0,void 0,void 0,this.options.shaderLanguage,B),this.onEffectCreatedObservable.notifyObservers(this._drawWrapper.effect)}bind(){var M,Z;let P=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.options.useAsPostProcess&&!P&&(this.options.jZ.setAlphaMode(this.alphaMode),this.drawWrapper.effect.setFloat2("scale",1,1)),null===(M=d._GetShaderCodeProcessing(this.name))||void 0===M||null===(Z=M.bindCustomBindings)||void 0===Z||Z.call(M,this.name,this._drawWrapper.effect)}dispose(){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.onEffectCreatedObservable.clear(),this._drawWrapper.dispose(!0)}}d.ForceGLSL=!1,d._CustomShaderCodeProcessing={}},12561:(M,Z,P)=>{P.d(Z,{c:()=>v});var x,c,w=P(12373);!function(M){M[M.LOCAL=0]="LOCAL",M[M.WORLD=1]="WORLD",M[M.BONE=2]="BONE"}(x||(x={}));class v{}v.X=new w.BZ(1,0,0),v.Y=new w.BZ(0,1,0),v.Z=new w.BZ(0,0,1),function(M){M[M.X=0]="X",M[M.Y=1]="Y",M[M.Z=2]="Z"}(c||(c={}))},12555:(M,Z,P)=>{P.d(Z,{d:()=>x.Matrix,e:()=>x.Quaternion,i:()=>x.TmpVectors,j:()=>x.BZ});P(12561),P(12406),P(12377),P(12567),P(12570),P(12408),P(12392);var x=P(12373);P(12469)},12570:(M,Z,P)=>{P.d(Z,{d:()=>G,e:()=>H,i:()=>d,m:()=>O});var x,c=P(12387),w=P(12373),v=P(12377);!function(M){M[M.CW=0]="CW",M[M.CCW=1]="CCW"}(x||(x={}));class G{static Interpolate(M,Z,P,x,c){if(0===M)return 0;const w=1-3*x+3*Z,v=3*x-6*Z,G=3*Z;let mM=M;for(let K=0;K<5;K++){const Z=mM*mM;mM-=(w*(Z*mM)+v*Z+G*mM-M)*(1/(3*w*Z+2*v*mM+G)),mM=Math.min(1,Math.max(0,mM))}return 3*Math.pow(1-mM,2)*mM*P+3*(1-mM)*Math.pow(mM,2)*c+Math.pow(mM,3)}}class mM{constructor(M){this._radians=M,this._radians<0&&(this._radians+=2*Math.PI)}degrees(){return 180*this._radians/Math.PI}radians(){return this._radians}static BetweenTwoPoints(M,Z){const P=Z.UZ(M),x=Math.atan2(P.y,P.x);return new mM(x)}static BetweenTwoVectors(M,Z){let P=M.lengthSquared()*Z.lengthSquared();if(0===P)return new mM(Math.PI/2);P=Math.sqrt(P);let x=M.dot(Z)/P;x=(0,c.Clamp)(x,-1,1);const w=Math.acos(x);return new mM(w)}static FromRadians(M){return new mM(M)}static FromDegrees(M){return new mM(M*Math.PI/180)}}class K{constructor(M,Z,P){this.startPoint=M,this.midPoint=Z,this.endPoint=P;const x=Math.pow(Z.x,2)+Math.pow(Z.y,2),c=(Math.pow(M.x,2)+Math.pow(M.y,2)-x)/2,v=(x-Math.pow(P.x,2)-Math.pow(P.y,2))/2,G=(M.x-Z.x)*(Z.y-P.y)-(Z.x-P.x)*(M.y-Z.y);this.centerPoint=new w.Vector2((c*(Z.y-P.y)-v*(M.y-Z.y))/G,((M.x-Z.x)*v-(Z.x-P.x)*c)/G),this.radius=this.centerPoint.UZ(this.startPoint).length(),this.startAngle=mM.BetweenTwoPoints(this.centerPoint,this.startPoint);const K=this.startAngle.degrees();let d=mM.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),O=mM.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();d-K>180&&(d-=360),d-K<-180&&(d+=360),O-d>180&&(O-=360),O-d<-180&&(O+=360),this.orientation=d-K<0?0:1,this.angle=mM.FromDegrees(0===this.orientation?K-O:O-K)}}class d{constructor(M,Z){this._points=new Array,this._length=0,this.closed=!1,this._points.push(new w.Vector2(M,Z))}addLineTo(M,Z){if(this.closed)return this;const P=new w.Vector2(M,Z),x=this._points[this._points.length-1];return this._points.push(P),this._length+=P.UZ(x).length(),this}addArcTo(M,Z,P,x){let c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:36;if(this.closed)return this;const v=this._points[this._points.length-1],G=new w.Vector2(M,Z),mM=new w.Vector2(P,x),d=new K(v,G,mM);let O=d.angle.radians()/c;0===d.orientation&&(O*=-1);let H=d.startAngle.radians()+O;for(let w=0;w<c;w++){const M=Math.cos(H)*d.radius+d.centerPoint.x,Z=Math.sin(H)*d.radius+d.centerPoint.y;this.addLineTo(M,Z),H+=O}return this}addQuadraticCurveTo(M,Z,P,x){let c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:36;if(this.closed)return this;const w=(M,Z,P,x)=>(1-M)*(1-M)*Z+2*M*(1-M)*P+M*M*x,v=this._points[this._points.length-1];for(let G=0;G<=c;G++){const mM=G/c,K=w(mM,v.x,M,P),d=w(mM,v.y,Z,x);this.addLineTo(K,d)}return this}addBezierCurveTo(M,Z,P,x,c,w){let v=arguments.length>6&&void 0!==arguments[6]?arguments[6]:36;if(this.closed)return this;const G=(M,Z,P,x,c)=>(1-M)*(1-M)*(1-M)*Z+3*M*(1-M)*(1-M)*P+3*M*M*(1-M)*x+M*M*M*c,mM=this._points[this._points.length-1];for(let K=0;K<=v;K++){const d=K/v,O=G(d,mM.x,M,P,c),H=G(d,mM.y,Z,x,w);this.addLineTo(O,H)}return this}isPointInside(M){let Z=!1;const P=this._points.length;for(let x=P-1,c=0;c<P;x=c++){let P=this._points[x],w=this._points[c],v=w.x-P.x,G=w.y-P.y;if(Math.abs(G)>Number.EPSILON){if(G<0&&(P=this._points[c],v=-v,w=this._points[x],G=-G),M.y<P.y||M.y>w.y)continue;if(M.y===P.y&&M.x===P.x)return!0;{const x=G*(M.x-P.x)-v*(M.y-P.y);if(0===x)return!0;if(x<0)continue;Z=!Z}}else{if(M.y!==P.y)continue;if(w.x<=M.x&&M.x<=P.x||P.x<=M.x&&M.x<=w.x)return!0}}return Z}close(){return this.closed=!0,this}length(){let M=this._length;if(this.closed){const Z=this._points[this._points.length-1];M+=this._points[0].UZ(Z).length()}return M}area(){const M=this._points.length;let Z=0;for(let P=M-1,x=0;x<M;P=x++)Z+=this._points[P].x*this._points[x].y-this._points[x].x*this._points[P].y;return.5*Z}getPoints(){return this._points}getPointAtLengthPosition(M){if(M<0||M>1)return w.Vector2.Zero();const Z=M*this.length();let P=0;for(let x=0;x<this._points.length;x++){const M=(x+1)%this._points.length,c=this._points[x],v=this._points[M].UZ(c),G=v.length()+P;if(Z>=P&&Z<=G){const M=v.normalize(),x=Z-P;return new w.Vector2(c.x+M.x*x,c.y+M.y*x)}P=G}return w.Vector2.Zero()}static StartingAt(M,Z){return new d(M,Z)}}class O{constructor(M){let Z=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,P=arguments.length>2?arguments[2]:void 0,x=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.path=M,this._curve=new Array,this._distances=new Array,this._tangents=new Array,this._normals=new Array,this._binormals=new Array,this._pointAtData={id:0,point:w.BZ.Zero(),previousPointArrayIndex:0,position:0,subPosition:0,interpolateReady:!1,interpolationMatrix:w.Matrix.Identity()};for(let c=0;c<M.length;c++)this._curve[c]=M[c].clone();this._raw=P||!1,this._alignTangentsWithPath=x,this._compute(Z,x)}getCurve(){return this._curve}getPoints(){return this._curve}length(){return this._distances[this._distances.length-1]}getTangents(){return this._tangents}getNormals(){return this._normals}getBinormals(){return this._binormals}getDistances(){return this._distances}getPointAt(M){return this._updatePointAtData(M).point}getTangentAt(M){let Z=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(M,Z),Z?w.BZ.TransformCoordinates(w.BZ.Forward(),this._pointAtData.interpolationMatrix):this._tangents[this._pointAtData.previousPointArrayIndex]}getNormalAt(M){let Z=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(M,Z),Z?w.BZ.TransformCoordinates(w.BZ.Right(),this._pointAtData.interpolationMatrix):this._normals[this._pointAtData.previousPointArrayIndex]}getBinormalAt(M){let Z=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(M,Z),Z?w.BZ.TransformCoordinates(w.BZ.UpReadOnly,this._pointAtData.interpolationMatrix):this._binormals[this._pointAtData.previousPointArrayIndex]}getDistanceAt(M){return this.length()*M}getPreviousPointIndexAt(M){return this._updatePointAtData(M),this._pointAtData.previousPointArrayIndex}getSubPositionAt(M){return this._updatePointAtData(M),this._pointAtData.subPosition}getClosestPositionTo(M){let Z=Number.MAX_VALUE,P=0;for(let x=0;x<this._curve.length-1;x++){const c=this._curve[x+0],v=this._curve[x+1].UZ(c).normalize(),G=this._distances[x+1]-this._distances[x+0],mM=Math.min(Math.max(w.BZ.Dot(v,M.UZ(c).normalize()),0)*w.BZ.Distance(c,M)/G,1),K=w.BZ.Distance(c.add(v.scale(mM*G)),M);K<Z&&(Z=K,P=(this._distances[x+0]+G*mM)/this.length())}return P}slice(){let M=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,Z=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(M<0&&(M=1- -1*M%1),Z<0&&(Z=1- -1*Z%1),M>Z){const P=M;M=Z,Z=P}const P=this.getCurve(),x=this.getPointAt(M);let c=this.getPreviousPointIndexAt(M);const w=this.getPointAt(Z),v=this.getPreviousPointIndexAt(Z)+1,G=[];return 0!==M&&(c++,G.push(x)),G.push(...P.slice(c,v)),1===Z&&1!==M||G.push(w),new O(G,this.getNormalAt(M),this._raw,this._alignTangentsWithPath)}update(M){let Z=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,P=arguments.length>2&&void 0!==arguments[2]&&arguments[2];for(let x=0;x<M.length;x++)this._curve[x].x=M[x].x,this._curve[x].y=M[x].y,this._curve[x].z=M[x].z;return this._compute(Z,P),this}_compute(M){let Z=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const P=this._curve.length;if(P<2)return;this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[P-1]=this._curve[P-1].UZ(this._curve[P-2]),this._raw||this._tangents[P-1].normalize();const x=this._tangents[0],c=this._normalVector(x,M);let v,G,mM,K,d;this._normals[0]=c,this._raw||this._normals[0].normalize(),this._binormals[0]=w.BZ.Cross(x,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;for(let O=1;O<P;O++)v=this._getLastNonNullVector(O),O<P-1&&(G=this._getFirstNonNullVector(O),this._tangents[O]=Z?G:v.add(G),this._tangents[O].normalize()),this._distances[O]=this._distances[O-1]+this._curve[O].UZ(this._curve[O-1]).length(),mM=this._tangents[O],d=this._binormals[O-1],this._normals[O]=w.BZ.Cross(d,mM),this._raw||(0===this._normals[O].length()?(K=this._normals[O-1],this._normals[O]=K.clone()):this._normals[O].normalize()),this._binormals[O]=w.BZ.Cross(mM,this._normals[O]),this._raw||this._binormals[O].normalize();this._pointAtData.id=NaN}_getFirstNonNullVector(M){let Z=1,P=this._curve[M+Z].UZ(this._curve[M]);for(;0===P.length()&&M+Z+1<this._curve.length;)Z++,P=this._curve[M+Z].UZ(this._curve[M]);return P}_getLastNonNullVector(M){let Z=1,P=this._curve[M].UZ(this._curve[M-Z]);for(;0===P.length()&&M>Z+1;)Z++,P=this._curve[M].UZ(this._curve[M-Z]);return P}_normalVector(M,Z){let P,x=M.length();if(0===x&&(x=1),void 0===Z||null===Z){let Z;Z=(0,c.WithinEpsilon)(Math.abs(M.y)/x,1,v.c)?(0,c.WithinEpsilon)(Math.abs(M.x)/x,1,v.c)?(0,c.WithinEpsilon)(Math.abs(M.z)/x,1,v.c)?w.BZ.Zero():new w.BZ(0,0,1):new w.BZ(1,0,0):new w.BZ(0,-1,0),P=w.BZ.Cross(M,Z)}else P=w.BZ.Cross(M,Z),w.BZ.CrossToRef(P,M,P);return P.normalize(),P}_updatePointAtData(M){let Z=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._pointAtData.id===M)return this._pointAtData.interpolateReady||this._updateInterpolationMatrix(),this._pointAtData;this._pointAtData.id=M;const P=this.getPoints();if(M<=0)return this._setPointAtData(0,0,P[0],0,Z);if(M>=1)return this._setPointAtData(1,1,P[P.length-1],P.length-1,Z);let x,c=P[0],v=0;const G=M*this.length();for(let mM=1;mM<P.length;mM++){x=P[mM];const K=w.BZ.Distance(c,x);if(v+=K,v===G)return this._setPointAtData(M,1,x,mM,Z);if(v>G){const P=(v-G)/K,w=c.UZ(x),d=x.add(w.scaleInPlace(P));return this._setPointAtData(M,1-P,d,mM-1,Z)}c=x}return this._pointAtData}_setPointAtData(M,Z,P,x,c){return this._pointAtData.point=P,this._pointAtData.position=M,this._pointAtData.subPosition=Z,this._pointAtData.previousPointArrayIndex=x,this._pointAtData.interpolateReady=c,c&&this._updateInterpolationMatrix(),this._pointAtData}_updateInterpolationMatrix(){this._pointAtData.interpolationMatrix=w.Matrix.Identity();const M=this._pointAtData.previousPointArrayIndex;if(M!==this._tangents.length-1){const Z=M+1,P=this._tangents[M].clone(),x=this._normals[M].clone(),c=this._binormals[M].clone(),v=this._tangents[Z].clone(),G=this._normals[Z].clone(),mM=this._binormals[Z].clone(),K=w.Quaternion.RotationQuaternionFromAxis(x,c,P),d=w.Quaternion.RotationQuaternionFromAxis(G,mM,v);w.Quaternion.Slerp(K,d,this._pointAtData.subPosition).toRotationMatrix(this._pointAtData.interpolationMatrix)}}}class H{static CreateQuadraticBezier(M,Z,P,x){x=x>2?x:3;const c=[],v=(M,Z,P,x)=>(1-M)*(1-M)*Z+2*M*(1-M)*P+M*M*x;for(let G=0;G<=x;G++)c.push(new w.BZ(v(G/x,M.x,Z.x,P.x),v(G/x,M.y,Z.y,P.y),v(G/x,M.z,Z.z,P.z)));return new H(c)}static CreateCubicBezier(M,Z,P,x,c){c=c>3?c:4;const v=[],G=(M,Z,P,x,c)=>(1-M)*(1-M)*(1-M)*Z+3*M*(1-M)*(1-M)*P+3*M*M*(1-M)*x+M*M*M*c;for(let mM=0;mM<=c;mM++)v.push(new w.BZ(G(mM/c,M.x,Z.x,P.x,x.x),G(mM/c,M.y,Z.y,P.y,x.y),G(mM/c,M.z,Z.z,P.z,x.z)));return new H(v)}static CreateHermiteSpline(M,Z,P,x,c){const v=[],G=1/c;for(let mM=0;mM<=c;mM++)v.push(w.BZ.Hermite(M,Z,P,x,mM*G));return new H(v)}static CreateCatmullRomSpline(M,Z,P){const x=[],c=1/Z;let v=0;if(P){const P=M.length;for(let G=0;G<P;G++){v=0;for(let mM=0;mM<Z;mM++)x.push(w.BZ.CatmullRom(M[G%P],M[(G+1)%P],M[(G+2)%P],M[(G+3)%P],v)),v+=c}x.push(x[0])}else{const P=[];P.push(M[0].clone()),Array.prototype.push.apply(P,M),P.push(M[M.length-1].clone());let G=0;for(;G<P.length-3;G++){v=0;for(let M=0;M<Z;M++)x.push(w.BZ.CatmullRom(P[G],P[G+1],P[G+2],P[G+3],v)),v+=c}G--,x.push(w.BZ.CatmullRom(P[G],P[G+1],P[G+2],P[G+3],v))}return new H(x)}static ArcThru3Points(M,Z,P){let x=arguments.length>3&&void 0!==arguments[3]?arguments[3]:32,c=arguments.length>4&&void 0!==arguments[4]&&arguments[4],v=arguments.length>5&&void 0!==arguments[5]&&arguments[5];const G=[],mM=Z.UZ(M),K=P.UZ(Z),d=M.UZ(P),O=w.BZ.Cross(mM,K),j=O.length();if(j<Math.pow(10,-8))return new H(G);const B=mM.lengthSquared(),U=K.lengthSquared(),n=d.lengthSquared(),L=O.lengthSquared(),u=.5*mM.length()*K.length()*d.length()/j,N=-.5*U*w.BZ.Dot(mM,d)/L,J=-.5*n*w.BZ.Dot(mM,K)/L,t=-.5*B*w.BZ.Dot(K,d)/L,F=M.scale(N).add(Z.scale(J)).add(P.scale(t)),D=M.UZ(F).normalize(),l=w.BZ.Cross(O,D).normalize();if(v){const Z=2*Math.PI/x;for(let M=0;M<=2*Math.PI;M+=Z)G.push(F.add(D.scale(u*Math.cos(M)).add(l.scale(u*Math.sin(M)))));G.push(M)}else{const Z=1/x;let v=0,mM=w.BZ.Zero();do{mM=F.add(D.scale(u*Math.cos(v)).add(l.scale(u*Math.sin(v)))),G.push(mM),v+=Z}while(!mM.equalsWithEpsilon(P,u*Z*1.1));G.push(P),c&&G.push(M)}return new H(G)}constructor(M){this._length=0,this._points=M,this._length=this._computeLength(M)}getPoints(){return this._points}length(){return this._length}continue(M){const Z=this._points[this._points.length-1],P=this._points.slice(),x=M.getPoints();for(let c=1;c<x.length;c++)P.push(x[c].UZ(x[0]).add(Z));return new H(P)}_computeLength(M){let Z=0;for(let P=1;P<M.length;P++)Z+=M[P].UZ(M[P-1]).length();return Z}}},12469:(M,Z,P)=>{P.d(Z,{b:()=>x});class x{constructor(M,Z,P,x){this.x=M,this.y=Z,this.width=P,this.height=x}toGlobal(M,Z){return new x(this.x*M,this.y*Z,this.width*M,this.height*Z)}toGlobalToRef(M,Z,P){return P.x=this.x*M,P.y=this.y*Z,P.width=this.width*M,P.height=this.height*Z,this}clone(){return new x(this.x,this.y,this.width,this.height)}}},12549:(M,Z,P)=>{P.d(Z,{d:()=>K,h:()=>d});var x=P(12373),c=P(12555);const w=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],v=[()=>1,M=>M.y,M=>M.z,M=>M.x,M=>M.x*M.y,M=>M.y*M.z,M=>3*M.z*M.z-1,M=>M.x*M.z,M=>M.x*M.x-M.y*M.y],G=(M,Z)=>w[M]*v[M](Z),mM=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4];class K{constructor(){this.preScaled=!1,this.l00=x.BZ.Zero(),this.l1_1=x.BZ.Zero(),this.l10=x.BZ.Zero(),this.l11=x.BZ.Zero(),this.l2_2=x.BZ.Zero(),this.l2_1=x.BZ.Zero(),this.l20=x.BZ.Zero(),this.l21=x.BZ.Zero(),this.l22=x.BZ.Zero()}addLight(M,Z,P){c.i.BZ[0].set(Z.r,Z.g,Z.b);const x=c.i.BZ[0],w=c.i.BZ[1];x.scaleToRef(P,w),w.scaleToRef(G(0,M),c.i.BZ[2]),this.l00.addInPlace(c.i.BZ[2]),w.scaleToRef(G(1,M),c.i.BZ[2]),this.l1_1.addInPlace(c.i.BZ[2]),w.scaleToRef(G(2,M),c.i.BZ[2]),this.l10.addInPlace(c.i.BZ[2]),w.scaleToRef(G(3,M),c.i.BZ[2]),this.l11.addInPlace(c.i.BZ[2]),w.scaleToRef(G(4,M),c.i.BZ[2]),this.l2_2.addInPlace(c.i.BZ[2]),w.scaleToRef(G(5,M),c.i.BZ[2]),this.l2_1.addInPlace(c.i.BZ[2]),w.scaleToRef(G(6,M),c.i.BZ[2]),this.l20.addInPlace(c.i.BZ[2]),w.scaleToRef(G(7,M),c.i.BZ[2]),this.l21.addInPlace(c.i.BZ[2]),w.scaleToRef(G(8,M),c.i.BZ[2]),this.l22.addInPlace(c.i.BZ[2])}scaleInPlace(M){this.l00.scaleInPlace(M),this.l1_1.scaleInPlace(M),this.l10.scaleInPlace(M),this.l11.scaleInPlace(M),this.l2_2.scaleInPlace(M),this.l2_1.scaleInPlace(M),this.l20.scaleInPlace(M),this.l21.scaleInPlace(M),this.l22.scaleInPlace(M)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(mM[0]),this.l1_1.scaleInPlace(mM[1]),this.l10.scaleInPlace(mM[2]),this.l11.scaleInPlace(mM[3]),this.l2_2.scaleInPlace(mM[4]),this.l2_1.scaleInPlace(mM[5]),this.l20.scaleInPlace(mM[6]),this.l21.scaleInPlace(mM[7]),this.l22.scaleInPlace(mM[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(w[0]),this.l1_1.scaleInPlace(w[1]),this.l10.scaleInPlace(w[2]),this.l11.scaleInPlace(w[3]),this.l2_2.scaleInPlace(w[4]),this.l2_1.scaleInPlace(w[5]),this.l20.scaleInPlace(w[6]),this.l21.scaleInPlace(w[7]),this.l22.scaleInPlace(w[8])}updateFromArray(M){return x.BZ.FromArrayToRef(M[0],0,this.l00),x.BZ.FromArrayToRef(M[1],0,this.l1_1),x.BZ.FromArrayToRef(M[2],0,this.l10),x.BZ.FromArrayToRef(M[3],0,this.l11),x.BZ.FromArrayToRef(M[4],0,this.l2_2),x.BZ.FromArrayToRef(M[5],0,this.l2_1),x.BZ.FromArrayToRef(M[6],0,this.l20),x.BZ.FromArrayToRef(M[7],0,this.l21),x.BZ.FromArrayToRef(M[8],0,this.l22),this}updateFromFloatsArray(M){return x.BZ.FromFloatsToRef(M[0],M[1],M[2],this.l00),x.BZ.FromFloatsToRef(M[3],M[4],M[5],this.l1_1),x.BZ.FromFloatsToRef(M[6],M[7],M[8],this.l10),x.BZ.FromFloatsToRef(M[9],M[10],M[11],this.l11),x.BZ.FromFloatsToRef(M[12],M[13],M[14],this.l2_2),x.BZ.FromFloatsToRef(M[15],M[16],M[17],this.l2_1),x.BZ.FromFloatsToRef(M[18],M[19],M[20],this.l20),x.BZ.FromFloatsToRef(M[21],M[22],M[23],this.l21),x.BZ.FromFloatsToRef(M[24],M[25],M[26],this.l22),this}static NZ(M){return(new K).updateFromArray(M)}static FromPolynomial(M){const Z=new K;return Z.l00=M.xx.scale(.376127).add(M.yy.scale(.376127)).add(M.zz.scale(.376126)),Z.l1_1=M.y.scale(.977204),Z.l10=M.z.scale(.977204),Z.l11=M.x.scale(.977204),Z.l2_2=M.xy.scale(1.16538),Z.l2_1=M.yz.scale(1.16538),Z.l20=M.zz.scale(1.34567).UZ(M.xx.scale(.672834)).UZ(M.yy.scale(.672834)),Z.l21=M.zx.scale(1.16538),Z.l22=M.xx.scale(1.16538).UZ(M.yy.scale(1.16538)),Z.l1_1.scaleInPlace(-1),Z.l11.scaleInPlace(-1),Z.l2_1.scaleInPlace(-1),Z.l21.scaleInPlace(-1),Z.scaleInPlace(Math.PI),Z}}class d{constructor(){this.x=x.BZ.Zero(),this.y=x.BZ.Zero(),this.z=x.BZ.Zero(),this.xx=x.BZ.Zero(),this.yy=x.BZ.Zero(),this.zz=x.BZ.Zero(),this.xy=x.BZ.Zero(),this.yz=x.BZ.Zero(),this.zx=x.BZ.Zero()}get preScaledHarmonics(){return this._harmonics||(this._harmonics=K.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(M){c.i.BZ[0].lc(M.r,M.g,M.b);const Z=c.i.BZ[0];this.xx.addInPlace(Z),this.yy.addInPlace(Z),this.zz.addInPlace(Z)}scaleInPlace(M){this.x.scaleInPlace(M),this.y.scaleInPlace(M),this.z.scaleInPlace(M),this.xx.scaleInPlace(M),this.yy.scaleInPlace(M),this.zz.scaleInPlace(M),this.yz.scaleInPlace(M),this.zx.scaleInPlace(M),this.xy.scaleInPlace(M)}updateFromHarmonics(M){return this._harmonics=M,this.x.v(M.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.v(M.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.v(M.l10),this.z.scaleInPlace(1.02333),this.xx.v(M.l00),c.i.BZ[0].v(M.l20).scaleInPlace(.247708),c.i.BZ[1].v(M.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).MH(c.i.BZ[0]).addInPlace(c.i.BZ[1]),this.yy.v(M.l00),this.yy.scaleInPlace(.886277).MH(c.i.BZ[0]).MH(c.i.BZ[1]),this.zz.v(M.l00),c.i.BZ[0].v(M.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(c.i.BZ[0]),this.yz.v(M.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.v(M.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.v(M.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(M){return(new d).updateFromHarmonics(M)}static NZ(M){const Z=new d;return x.BZ.FromArrayToRef(M[0],0,Z.x),x.BZ.FromArrayToRef(M[1],0,Z.y),x.BZ.FromArrayToRef(M[2],0,Z.z),x.BZ.FromArrayToRef(M[3],0,Z.xx),x.BZ.FromArrayToRef(M[4],0,Z.yy),x.BZ.FromArrayToRef(M[5],0,Z.zz),x.BZ.FromArrayToRef(M[6],0,Z.yz),x.BZ.FromArrayToRef(M[7],0,Z.zx),x.BZ.FromArrayToRef(M[8],0,Z.xy),Z}}},12505:(M,Z,P)=>{P.d(Z,{c:()=>c});var x=P(12439);class c extends x.b{constructor(M){super(),this._buffer=M}get underlyingResource(){return this._buffer}}},12581:(M,Z,P)=>{P.d(Z,{c:()=>L,f:()=>t,j:()=>D,l:()=>l,p:()=>J});var x=P(12344),c=P(12418),w=P(12351),v=P(12462),G=P(12260),mM=P(12317),K=P(12394),d=P(12464),O=P(12482);class H extends d.f{_gatherImports(M,Z){M?(this._webGPUReady=!0,Z.push(Promise.all([P.e(51).then(P.bind(P,14873))]))):Z.push(Promise.all([P.e(52).then(P.bind(P,14881))])),super._gatherImports(M,Z)}constructor(M){super({...arguments.length>2?arguments[2]:void 0,name:M,jZ:(arguments.length>1&&void 0!==arguments[1]?arguments[1]:null)||O.d.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:H.FragmentUrl})}}H.FragmentUrl="pass";class j extends d.f{_gatherImports(M,Z){M?(this._webGPUReady=!0,Z.push(Promise.all([P.e(62).then(P.bind(P,14937))]))):Z.push(Promise.all([P.e(63).then(P.bind(P,14941))])),super._gatherImports(M,Z)}constructor(M){super({...arguments.length>2?arguments[2]:void 0,name:M,jZ:(arguments.length>1&&void 0!==arguments[1]?arguments[1]:null)||O.d.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:j.FragmentUrl,defines:"#define POSITIVEX"}),this._face=0}get face(){return this._face}set face(M){if(!(M<0||M>5))switch(this._face=M,this._face){case 0:this.updateEffect("#define POSITIVEX");break;case 1:this.updateEffect("#define NEGATIVEX");break;case 2:this.updateEffect("#define POSITIVEY");break;case 3:this.updateEffect("#define NEGATIVEY");break;case 4:this.updateEffect("#define POSITIVEZ");break;case 5:this.updateEffect("#define NEGATIVEZ")}}}j.FragmentUrl="passCube";var B=P(12359);class U extends v.e{getClassName(){return"PassPostProcess"}constructor(M,Z){let P=arguments.length>4?arguments[4]:void 0;const x={size:"number"===typeof Z?Z:void 0,camera:arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,samplingMode:arguments.length>3?arguments[3]:void 0,jZ:P,reusable:arguments.length>5?arguments[5]:void 0,textureType:arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,blockCompilation:arguments.length>7&&void 0!==arguments[7]&&arguments[7],...Z};super(M,H.FragmentUrl,{effectWrapper:"number"!==typeof Z&&Z.effectWrapper?void 0:new H(M,P,x),...x})}static _Parse(M,Z,P,x){return K.b.Parse((()=>new U(M.name,M.options,Z,M.renderTargetSamplingMode,M._engine,M.reusable)),M,P,x)}}(0,mM.g)("BABYLON.PassPostProcess",U);class n extends v.e{get face(){return this._effectWrapper.face}set face(M){this._effectWrapper.face=M}getClassName(){return"PassCubePostProcess"}constructor(M,Z){let P=arguments.length>4?arguments[4]:void 0;const x={size:"number"===typeof Z?Z:void 0,camera:arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,samplingMode:arguments.length>3?arguments[3]:void 0,jZ:P,reusable:arguments.length>5?arguments[5]:void 0,textureType:arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,blockCompilation:arguments.length>7&&void 0!==arguments[7]&&arguments[7],...Z};super(M,H.FragmentUrl,{effectWrapper:"number"!==typeof Z&&Z.effectWrapper?void 0:new j(M,P,x),...x})}static _Parse(M,Z,P,x){return K.b.Parse((()=>new n(M.name,M.options,Z,M.renderTargetSamplingMode,M._engine,M.reusable)),M,P,x)}}function L(M,Z,P,x,c,w,G,mM){const K=Z.getEngine();return Z.isReady=!1,c=c??Z.samplingMode,x=x??Z.type,w=w??Z.format,G=G??Z.width,mM=mM??Z.height,-1===x&&(x=0),new Promise((d=>{const O=new v.e("postprocess",M,null,null,1,null,c,K,!1,void 0,x,void 0,null,!1,w);O.externalTextureSamplerBinding=!0;const H=K.createRenderTargetTexture({width:G,height:mM},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:c,type:x,format:w});O.onEffectCreatedObservable.addOnce((M=>{M.executeWhenCompiled((()=>{O.onApply=M=>{M._bindTexture("textureSampler",Z),M.setFloat2("scale",1,1)},P.postProcessManager.directRender([O],H,!0),K.restoreDefaultFramebuffer(),K._releaseTexture(Z),O&&O.dispose(),H._swapAndDie(Z),Z.type=x,Z.format=5,Z.isReady=!0,d(Z)}))}))}))}let u,N;function J(M){u||(u=new Float32Array(1),N=new Int32Array(u.buffer)),u[0]=M;const Z=N[0];let P=Z>>16&32768,x=Z>>12&2047;const c=Z>>23&255;return c<103?P:c>142?(P|=31744,P|=(255==c?0:1)&&8388607&Z,P):c<113?(x|=2048,P|=(x>>114-c)+(x>>113-c&1),P):(P|=c-112<<10|x>>1,P+=1&x,P)}function t(M){const Z=(32768&M)>>15,P=(31744&M)>>10,x=1023&M;return 0===P?(Z?-1:1)*Math.pow(2,-14)*(x/Math.pow(2,10)):31==P?x?NaN:1/0*(Z?-1:1):(Z?-1:1)*Math.pow(2,P-15)*(1+x/Math.pow(2,10))}(0,w.c)([(0,B.H)()],n.prototype,"face",null),G.e._RescalePostProcessFactory=M=>new U("rescale",1,null,2,M,!1,0);const F=async(M,Z,w,G,mM)=>{const K=M.DM(),d=K.getEngine();let O;if(d.isWebGPU?M.isCube?await P.e(60).then(P.bind(P,14932)):await P.e(61).then(P.bind(P,14935)):M.isCube?await P.e(58).then(P.bind(P,14917)):await P.e(59).then(P.bind(P,14926)),M.isCube){const M=["#define POSITIVEX","#define NEGATIVEX","#define POSITIVEY","#define NEGATIVEY","#define POSITIVEZ","#define NEGATIVEZ"];O=new v.e("lodCube","lodCube",{uniforms:["lod","gamma"],samplingMode:x.e.NEAREST_NEAREST_MIPNEAREST,jZ:d,defines:M[G],shaderLanguage:d.isWebGPU?1:0})}else O=new v.e("lod","lod",{uniforms:["lod","gamma"],samplingMode:x.e.NEAREST_NEAREST_MIPNEAREST,jZ:d,shaderLanguage:d.isWebGPU?1:0});await new Promise((M=>{O.onEffectCreatedObservable.addOnce((Z=>{Z.executeWhenCompiled((()=>{M(0)}))}))}));const H=new c.d("temp",{width:Z,height:w},K,!1);O.onApply=function(Z){Z.setTexture("textureSampler",M),Z.setFloat("lod",mM),Z.setInt("gamma",M.gammaSpace?1:0)};const j=M.getInternalTexture();try{if(H.renderTarget&&j){const P=j.samplingMode;0!==mM?M.updateSamplingMode(x.e.NEAREST_NEAREST_MIPNEAREST):M.updateSamplingMode(x.e.NEAREST_NEAREST),K.postProcessManager.directRender([O],H.renderTarget,!0),M.updateSamplingMode(P);const c=await d.readPixels(0,0,Z,w),v=new Uint8Array(c.buffer,0,c.byteLength);return d.unBindFramebuffer(H.renderTarget),v}throw Error("Render to texture failed.")}finally{H.dispose(),O.dispose()}};async function D(M,Z,P){let x=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;return!M.isReady()&&M._texture&&await new Promise(((Z,P)=>{null!==M._texture?M._texture.onLoadedObservable.addOnce((()=>{Z(0)})):P(0)})),await F(M,Z,P,x,c)}const l={CreateResizedCopy:function(M,Z,P){let w=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const v=M.DM(),G=v.getEngine(),mM=new c.d("resized"+M.name,{width:Z,height:P},v,!M.noMipmap,!0,M._texture.type,!1,M.samplingMode,!1);mM.wrapU=M.wrapU,mM.wrapV=M.wrapV,mM.uOffset=M.uOffset,mM.vOffset=M.vOffset,mM.uScale=M.uScale,mM.vScale=M.vScale,mM.uAng=M.uAng,mM.vAng=M.vAng,mM.wAng=M.wAng,mM.coordinatesIndex=M.coordinatesIndex,mM.level=M.level,mM.anisotropicFilteringLevel=M.anisotropicFilteringLevel,mM._texture.isReady=!1,M.wrapU=x.e.CLAMP_ADDRESSMODE,M.wrapV=x.e.CLAMP_ADDRESSMODE;const K=new U("pass",1,null,w?x.e.BILINEAR_SAMPLINGMODE:x.e.NEAREST_SAMPLINGMODE,G,!1,0);return K.externalTextureSamplerBinding=!0,K.onEffectCreatedObservable.addOnce((Z=>{Z.executeWhenCompiled((()=>{K.onApply=function(Z){Z.setTexture("textureSampler",M)};const Z=mM.renderTarget;Z&&(v.postProcessManager.directRender([K],Z),G.unBindFramebuffer(Z),mM.disposeFramebufferObjects(),K.dispose(),mM.getInternalTexture().isReady=!0)}))})),mM},ApplyPostProcess:L,ToHalfFloat:J,FromHalfFloat:t,GetTextureDataAsync:D}},12462:(M,Z,P)=>{P.d(Z,{e:()=>B});var x=P(12351),c=P(12457),w=P(12184),v=P(12373),G=P(12262),mM=P(12359),K=P(12394),d=P(12317),O=P(12260),H=P(12332),j=P(12464);O.e.prototype.setTextureFromPostProcess=function(M,Z,P){var x;let c=null;Z&&(Z._forcedOutputTexture?c=Z._forcedOutputTexture:Z._textures.data[Z._currentRenderTextureInd]&&(c=Z._textures.data[Z._currentRenderTextureInd])),this._bindTexture(M,(null===(x=c)||void 0===x?void 0:x.texture)??null,P)},O.e.prototype.setTextureFromPostProcessOutput=function(M,Z,P){var x;this._bindTexture(M,(null===Z||void 0===Z||null===(x=Z._outputTexture)||void 0===x?void 0:x.texture)??null,P)},G.Effect.prototype.setTextureFromPostProcess=function(M,Z){this._engine.setTextureFromPostProcess(this._samplers[M],Z,M)},G.Effect.prototype.setTextureFromPostProcessOutput=function(M,Z){this._engine.setTextureFromPostProcessOutput(this._samplers[M],Z,M)};class B{static get ForceGLSL(){return j.f.ForceGLSL}static set ForceGLSL(M){j.f.ForceGLSL=M}static RegisterShaderCodeProcessing(M,Z){j.f.RegisterShaderCodeProcessing(M,Z)}get name(){return this._effectWrapper.name}set name(M){this._effectWrapper.name=M}get alphaMode(){return this._effectWrapper.alphaMode}set alphaMode(M){this._effectWrapper.alphaMode=M}get samples(){return this._samples}set samples(M){this._samples=Math.min(M,this._engine.getCaps().maxMSAASamples),this._textures.forEach((M=>{M.setSamples(this._samples)}))}get shaderLanguage(){return this._shaderLanguage}getEffectName(){return this._fragmentUrl}set onActivate(M){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),M&&(this._onActivateObserver=this.onActivateObservable.add(M))}set onSizeChanged(M){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(M)}set onApply(M){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(M)}set onBeforeRender(M){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(M)}set onAfterRender(M){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(M)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(M){this._forcedOutputTexture=M}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.lc(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(M,Z,P,x,G,mM){var K;let d=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,O=arguments.length>7?arguments[7]:void 0,H=arguments.length>8?arguments[8]:void 0,U=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,n=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0,L=arguments.length>11&&void 0!==arguments[11]?arguments[11]:"postprocess",u=arguments.length>12?arguments[12]:void 0,N=arguments.length>13&&void 0!==arguments[13]&&arguments[13],J=arguments.length>14&&void 0!==arguments[14]?arguments[14]:5,t=arguments.length>15?arguments[15]:void 0,F=arguments.length>16?arguments[16]:void 0;this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.Bc=!0,this.forceAutoClearInAlphaMode=!1,this.animations=[],this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._webGPUReady=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new c.g(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new v.Vector2(1,1),this._texelSize=v.Vector2.Zero(),this.onActivateObservable=new w.b,this.onSizeChangedObservable=new w.b,this.onApplyObservable=new w.b,this.onBeforeRenderObservable=new w.b,this.onAfterRenderObservable=new w.b,this.Gc=new w.b;let D,l=1,h=null;if(P&&!Array.isArray(P)){const M=P;P=M.uniforms??null,x=M.samplers??null,l=M.size??1,mM=M.camera??null,d=M.samplingMode??1,O=M.jZ,H=M.reusable,U=Array.isArray(M.defines)?M.defines.join("\n"):M.defines??null,n=M.textureType??0,L=M.vertexUrl??"postprocess",u=M.indexParameters,N=M.blockCompilation??!1,J=M.textureFormat??5,t=M.shaderLanguage??0,h=M.uniformBuffers??null,F=M.extraInitializations,D=M.effectWrapper}else G&&(l="number"===typeof G?G:{width:G.width,height:G.height});if(this._useExistingThinPostProcess=!!D,this._effectWrapper=D??new j.f({name:M,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Z,jZ:O||(null===(K=mM)||void 0===K?void 0:K.DM().getEngine()),uniforms:P,samplers:x,uniformBuffers:h,defines:U,vertexUrl:L,indexParameters:u,blockCompilation:!0,shaderLanguage:t,extraInitializations:void 0}),this.name=M,this.onEffectCreatedObservable=this._effectWrapper.onEffectCreatedObservable,null!=mM?(this._camera=mM,this._scene=mM.DM(),mM.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):O&&(this._engine=O,this._engine.postProcesses.push(this)),this._options=l,this.renderTargetSamplingMode=d||1,this._reusable=H||!1,this._textureType=n,this._textureFormat=J,this._shaderLanguage=t||0,this._samplers=x||[],-1===this._samplers.indexOf("textureSampler")&&this._samplers.push("textureSampler"),this._fragmentUrl=Z,this._vertexUrl=L,this._parameters=P||[],-1===this._parameters.indexOf("scale")&&this._parameters.push("scale"),this._uniformBuffers=h||[],this._indexParameters=u,!this._useExistingThinPostProcess){this._webGPUReady=1===this._shaderLanguage;const M=[];this._gatherImports(this._engine.isWebGPU&&!B.ForceGLSL,M),this._effectWrapper._webGPUReady=this._webGPUReady,this._effectWrapper._postConstructor(N,U,F,M)}}_gatherImports(){let M=arguments.length>1?arguments[1]:void 0;arguments.length>0&&void 0!==arguments[0]&&arguments[0]&&this._webGPUReady?M.push(Promise.all([P.e(53).then(P.bind(P,14886))])):M.push(Promise.all([Promise.resolve().then(P.bind(P,12475))]))}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._effectWrapper.drawWrapper.effect}shareOutputWith(M){return this._disposeTextures(),this._shareOutputWithPostProcess=M,this}useOwnOutput(){0==this._textures.length&&(this._textures=new c.g(2)),this._shareOutputWithPostProcess=null}updateEffect(){let M=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,Z=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,P=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,x=arguments.length>3?arguments[3]:void 0,c=arguments.length>4?arguments[4]:void 0,w=arguments.length>5?arguments[5]:void 0,v=arguments.length>6?arguments[6]:void 0,G=arguments.length>7?arguments[7]:void 0;this._effectWrapper.updateEffect(M,Z,P,x,c,w,v,G),this._postProcessDefines=Array.isArray(this._effectWrapper.options.defines)?this._effectWrapper.options.defines.join("\n"):this._effectWrapper.options.defines}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(M,Z){let P=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;for(let c=0;c<this._textureCache.length;c++)if(this._textureCache[c].texture.width===M.width&&this._textureCache[c].texture.height===M.height&&this._textureCache[c].postProcessChannel===P&&this._textureCache[c].texture._generateDepthBuffer===Z.generateDepthBuffer&&this._textureCache[c].texture.samples===Z.samples)return this._textureCache[c].texture;const x=this._engine.createRenderTargetTexture(M,Z);return this._textureCache.push({texture:x,postProcessChannel:P,lastUsedRenderId:-1}),x}_flushTextureCache(){const M=this._renderId;for(let Z=this._textureCache.length-1;Z>=0;Z--)if(M-this._textureCache[Z].lastUsedRenderId>100){let M=!1;for(let P=0;P<this._textures.length;P++)if(this._textures.data[P]===this._textureCache[Z].texture){M=!0;break}M||(this._textureCache[Z].texture.dispose(),this._textureCache.splice(Z,1))}}resize(M,Z){let P=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,x=arguments.length>3&&void 0!==arguments[3]&&arguments[3],c=arguments.length>4&&void 0!==arguments[4]&&arguments[4];this._textures.length>0&&this._textures.reset(),this.width=M,this.height=Z;let w=null;if(P)for(let mM=0;mM<P._postProcesses.length;mM++)if(null!==P._postProcesses[mM]){w=P._postProcesses[mM];break}const v={width:this.width,height:this.height},G={generateMipMaps:x,generateDepthBuffer:c||w===this,generateStencilBuffer:(c||w===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples,label:"PostProcessRTT-"+this.name};this._textures.push(this._createRenderTargetTexture(v,G,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(v,G,1)),this._texelSize.lc(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}_getTarget(){let M;if(this._shareOutputWithPostProcess)M=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)M=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{let Z;M=this.inputTexture;for(let P=0;P<this._textureCache.length;P++)if(this._textureCache[P].texture===M){Z=this._textureCache[P];break}Z&&(Z.lastUsedRenderId=this._renderId)}return M}activate(M){var Z,P;let x=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,c=arguments.length>2?arguments[2]:void 0;const w=null===M||void 0!==M.cameraRigMode?M||this._camera:null,v=(null===w||void 0===w?void 0:w.DM())??M,G=v.getEngine(),mM=G.getCaps().maxTextureSize,K=(x?x.width:this._engine.getRenderWidth(!0))*this._options|0,d=(x?x.height:this._engine.getRenderHeight(!0))*this._options|0;let O=this._options.width||K,j=this._options.height||d;const B=7!==this.renderTargetSamplingMode&&1!==this.renderTargetSamplingMode&&2!==this.renderTargetSamplingMode;let U=null;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const M=G.currentViewport;M&&(O*=M.width,j*=M.height)}(B||this.alwaysForcePOT)&&(this._options.width||(O=G.needPOTTextures?(0,H.e)(O,mM,this.scaleMode):O),this._options.height||(j=G.needPOTTextures?(0,H.e)(j,mM,this.scaleMode):j)),this.width===O&&this.height===j&&(U=this._getTarget())||this.resize(O,j,w,B,c),this._textures.forEach((M=>{M.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(M,this.samples)})),this._flushTextureCache(),this._renderId++}return U||(U=this._getTarget()),this.enablePixelPerfectMode?(this._scaleRatio.lc(K/O,d/j),this._engine.bindFramebuffer(U,0,K,d,this.forceFullscreenViewport)):(this._scaleRatio.lc(1,1),this._engine.bindFramebuffer(U,0,void 0,void 0,this.forceFullscreenViewport)),null===(Z=(P=this._engine)._debugInsertMarker)||void 0===Z||Z.call(P,`post process ${this.name} input`),this.onActivateObservable.notifyObservers(w),this.Bc&&(0===this.alphaMode||this.forceAutoClearInAlphaMode)&&this._engine.clear(this.clearColor?this.clearColor:v.clearColor,v._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),U}get isSupported(){return this._effectWrapper.drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){return this._effectWrapper.isReady()}apply(){if(!this._effectWrapper.isReady())return null;let M;var Z;(this._engine.enableEffect(this._effectWrapper.drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a),this._engine.setAlphaMode(this.alphaMode),M=this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?this._forcedOutputTexture:this.inputTexture,this.externalTextureSamplerBinding)||this._effectWrapper.drawWrapper.effect._bindTexture("textureSampler",null===(Z=M)||void 0===Z?void 0:Z.texture);return this._effectWrapper.drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._effectWrapper.drawWrapper.effect),this._effectWrapper.bind(!0),this._effectWrapper.drawWrapper.effect}_disposeTextures(){this._shareOutputWithPostProcess||this._forcedOutputTexture?this._disposeTextureCache():(this._disposeTextureCache(),this._textures.dispose())}_disposeTextureCache(){for(let M=this._textureCache.length-1;M>=0;M--)this._textureCache[M].texture.dispose();this._textureCache.length=0}setPrePassRenderer(M){return!!this._prePassEffectConfiguration&&(this._prePassEffectConfiguration=M.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0)}dispose(M){let Z;if(M=M||this._camera,this._useExistingThinPostProcess||this._effectWrapper.dispose(),this._disposeTextures(),this._scene&&(Z=this._scene.postProcesses.indexOf(this),-1!==Z&&this._scene.postProcesses.splice(Z,1)),this._parentContainer){const M=this._parentContainer.postProcesses.indexOf(this);M>-1&&this._parentContainer.postProcesses.splice(M,1),this._parentContainer=null}if(Z=this._engine.postProcesses.indexOf(this),-1!==Z&&this._engine.postProcesses.splice(Z,1),this.Gc.notifyObservers(),M){if(M.detachPostProcess(this),Z=M._postProcesses.indexOf(this),0===Z&&M._postProcesses.length>0){const M=this._camera._getFirstPostProcess();M&&M.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear(),this.onEffectCreatedObservable.clear()}}serialize(){const M=K.b.Serialize(this),Z=this.getCamera()||this._scene&&this._scene.activeCamera;return M.customType="BABYLON."+this.getClassName(),M.cameraId=Z?Z.id:null,M.reusable=this._reusable,M.textureType=this._textureType,M.fragmentUrl=this._fragmentUrl,M.parameters=this._parameters,M.samplers=this._samplers,M.uniformBuffers=this._uniformBuffers,M.options=this._options,M.defines=this._postProcessDefines,M.textureFormat=this._textureFormat,M.vertexUrl=this._vertexUrl,M.indexParameters=this._indexParameters,M}clone(){const M=this.serialize();M._engine=this._engine,M.cameraId=null;const Z=B.Parse(M,this._scene,"");return Z?(Z.onActivateObservable=this.onActivateObservable.clone(),Z.onSizeChangedObservable=this.onSizeChangedObservable.clone(),Z.onApplyObservable=this.onApplyObservable.clone(),Z.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),Z.onAfterRenderObservable=this.onAfterRenderObservable.clone(),Z._prePassEffectConfiguration=this._prePassEffectConfiguration,Z):null}static Parse(M,Z,P){const x=(0,d.e)(M.customType);if(!x||!x._Parse)return null;const c=Z?Z.getCameraById(M.cameraId):null;return x._Parse(M,c,Z,P)}static _Parse(M,Z,P,x){return K.b.Parse((()=>new B(M.name,M.fragmentUrl,M.parameters,M.samplers,M.options,Z,M.renderTargetSamplingMode,M._engine,M.reusable,M.defines,M.textureType,M.vertexUrl,M.indexParameters,!1,M.textureFormat)),M,P,x)}}(0,x.c)([(0,mM.H)()],B.prototype,"uniqueId",void 0),(0,x.c)([(0,mM.H)()],B.prototype,"name",null),(0,x.c)([(0,mM.H)()],B.prototype,"width",void 0),(0,x.c)([(0,mM.H)()],B.prototype,"height",void 0),(0,x.c)([(0,mM.H)()],B.prototype,"renderTargetSamplingMode",void 0),(0,x.c)([(0,mM.l)()],B.prototype,"clearColor",void 0),(0,x.c)([(0,mM.H)()],B.prototype,"Bc",void 0),(0,x.c)([(0,mM.H)()],B.prototype,"forceAutoClearInAlphaMode",void 0),(0,x.c)([(0,mM.H)()],B.prototype,"alphaMode",null),(0,x.c)([(0,mM.H)()],B.prototype,"alphaConstants",void 0),(0,x.c)([(0,mM.H)()],B.prototype,"enablePixelPerfectMode",void 0),(0,x.c)([(0,mM.H)()],B.prototype,"forceFullscreenViewport",void 0),(0,x.c)([(0,mM.H)()],B.prototype,"scaleMode",void 0),(0,x.c)([(0,mM.H)()],B.prototype,"alwaysForcePOT",void 0),(0,x.c)([(0,mM.H)("samples")],B.prototype,"_samples",void 0),(0,x.c)([(0,mM.H)()],B.prototype,"adaptScaleToCurrentViewport",void 0),(0,d.g)("BABYLON.PostProcess",B)},12475:(M,Z,P)=>{P.r(Z),P.d(Z,{postprocessVertexShader:()=>v});var x=P(12271);const c="postprocessVertexShader",w="attribute vec2 position;uniform vec2 scale;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=(position*madd+madd)*scale;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";x.c.ShadersStore[c]||(x.c.ShadersStore[c]=w);const v={name:c,shader:w}}}]);