"use strict";(self["3nlrbof8msu"]=self["3nlrbof8msu"]||[]).push([[18],{12919:(t,b,Z)=>{Z(12623).e.prototype.createDepthStencilTexture=function(t,b,Z){if(b.isCube){const Z=t.width||t;return this._createDepthStencilCubeTexture(Z,b)}return this._createDepthStencilTexture(t,b,Z)}},12898:(t,b,Z)=>{Z(12866).ThinEngine.prototype.setAlphaMode=function(t){let b=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._alphaMode!==t){switch(t){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0}b||(this.depthCullingState.depthMask=0===t),this._alphaMode=t}else if(!b){const b=0===t;this.depthCullingState.depthMask!==b&&(this.depthCullingState.depthMask=b)}}},12907:(t,b,Z)=>{var J=Z(12866);J.ThinEngine.prototype.updateDynamicIndexBuffer=function(t,b){let Z;this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(t),Z=t.is32Bits?b instanceof Uint32Array?b:new Uint32Array(b):b instanceof Uint16Array?b:new Uint16Array(b),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,Z,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()},J.ThinEngine.prototype.updateDynamicVertexBuffer=function(t,b,Z,J){this.bindArrayBuffer(t),void 0===Z&&(Z=0);const S=b.byteLength||b.length;void 0===J||J>=S&&0===Z?b instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,Z,new Float32Array(b)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,Z,b):b instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,Z,new Float32Array(b).subarray(0,J/4)):(b=b instanceof ArrayBuffer?new Uint8Array(b,0,J):new Uint8Array(b.buffer,b.byteOffset,J),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,Z,b)),this._resetVertexBufferBinding()}},12911:(t,b,Z)=>{var J=Z(12663),S=Z(12557),P=Z(12866),v=Z(12915),h=Z(12892);class C extends v.b{setDepthStencilTexture(t){let b=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(super.setDepthStencilTexture(t,b),!t)return;const Z=this._engine,J=this._context,S=t._hardwareTexture;if(S&&t._autoMSAAManagement&&this._MSAAFramebuffer){const b=Z._currentFramebuffer;Z._bindUnboundFramebuffer(this._MSAAFramebuffer),J.framebufferRenderbuffer(J.FRAMEBUFFER,(0,h.d)(t.format)?J.DEPTH_STENCIL_ATTACHMENT:J.DEPTH_ATTACHMENT,J.RENDERBUFFER,S.getMSAARenderBuffer()),Z._bindUnboundFramebuffer(b)}}constructor(t,b,Z,J,S){super(t,b,Z,J),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._disposeOnlyFramebuffers=!1,this._currentLOD=0,this._context=S}_cloneRenderTargetWrapper(){let t=null;return this._colorTextureArray&&this._depthStencilTextureArray?(t=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),t.texture.isReady=!0):t=super._cloneRenderTargetWrapper(),t}_swapRenderTargetWrapper(t){super._swapRenderTargetWrapper(t),t._framebuffer=this._framebuffer,t._depthStencilBuffer=this._depthStencilBuffer,t._MSAAFramebuffer=this._MSAAFramebuffer,t._colorTextureArray=this._colorTextureArray,t._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}createDepthStencilTexture(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,b=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],Z=arguments.length>2&&void 0!==arguments[2]&&arguments[2],J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,S=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14,P=arguments.length>5?arguments[5]:void 0;if(this._depthStencilBuffer){const t=this._engine,b=t._currentFramebuffer,Z=this._context;t._bindUnboundFramebuffer(this._framebuffer),Z.framebufferRenderbuffer(Z.FRAMEBUFFER,Z.DEPTH_STENCIL_ATTACHMENT,Z.RENDERBUFFER,null),Z.framebufferRenderbuffer(Z.FRAMEBUFFER,Z.DEPTH_ATTACHMENT,Z.RENDERBUFFER,null),Z.framebufferRenderbuffer(Z.FRAMEBUFFER,Z.STENCIL_ATTACHMENT,Z.RENDERBUFFER,null),t._bindUnboundFramebuffer(b),Z.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null}return super.createDepthStencilTexture(t,b,Z,J,S,P)}shareDepth(t){super.shareDepth(t);const b=this._context,Z=this._depthStencilBuffer,J=t._MSAAFramebuffer||t._framebuffer,S=this._engine;t._depthStencilBuffer&&t._depthStencilBuffer!==Z&&b.deleteRenderbuffer(t._depthStencilBuffer),t._depthStencilBuffer=Z;const P=t._generateStencilBuffer?b.DEPTH_STENCIL_ATTACHMENT:b.DEPTH_ATTACHMENT;S._bindUnboundFramebuffer(J),b.framebufferRenderbuffer(b.FRAMEBUFFER,P,b.RENDERBUFFER,Z),S._bindUnboundFramebuffer(null)}_bindTextureRenderTarget(t){let b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,Z=arguments.length>2?arguments[2]:void 0,J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const S=t._hardwareTexture;if(!S)return;const P=this._framebuffer,v=this._engine,h=v._currentFramebuffer;let C;if(v._bindUnboundFramebuffer(P),v.webGLVersion>1){const P=this._context;var Y;if(C=P["COLOR_ATTACHMENT"+b],t.is2DArray||t.is3D)Z=Z??(null===(Y=this.layerIndices)||void 0===Y?void 0:Y[b])??0,P.framebufferTextureLayer(P.FRAMEBUFFER,C,S.underlyingResource,J,Z);else if(t.isCube){var g;Z=Z??(null===(g=this.faceIndices)||void 0===g?void 0:g[b])??0,P.framebufferTexture2D(P.FRAMEBUFFER,C,P.TEXTURE_CUBE_MAP_POSITIVE_X+Z,S.underlyingResource,J)}else P.framebufferTexture2D(P.FRAMEBUFFER,C,P.TEXTURE_2D,S.underlyingResource,J)}else{const t=this._context;C=t["COLOR_ATTACHMENT"+b+"_WEBGL"];const P=void 0!==Z?t.TEXTURE_CUBE_MAP_POSITIVE_X+Z:t.TEXTURE_2D;t.framebufferTexture2D(t.FRAMEBUFFER,C,P,S.underlyingResource,J)}if(t._autoMSAAManagement&&this._MSAAFramebuffer){const t=this._context;v._bindUnboundFramebuffer(this._MSAAFramebuffer),t.framebufferRenderbuffer(t.FRAMEBUFFER,C,t.RENDERBUFFER,S.getMSAARenderBuffer())}v._bindUnboundFramebuffer(h)}setTexture(t){let b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,Z=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];super.setTexture(t,b,Z),this._bindTextureRenderTarget(t,b)}setLayerAndFaceIndices(t,b){var Z;if(super.setLayerAndFaceIndices(t,b),!this.textures||!this.layerIndices||!this.faceIndices)return;const J=(null===(Z=this._attachments)||void 0===Z?void 0:Z.length)??this.textures.length;for(let S=0;S<J;S++){const t=this.textures[S];t&&(t.is2DArray||t.is3D?this._bindTextureRenderTarget(t,S,this.layerIndices[S]):t.isCube?this._bindTextureRenderTarget(t,S,this.faceIndices[S]):this._bindTextureRenderTarget(t,S))}}setLayerAndFaceIndex(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,b=arguments.length>1?arguments[1]:void 0,Z=arguments.length>2?arguments[2]:void 0;if(super.setLayerAndFaceIndex(t,b,Z),!this.textures||!this.layerIndices||!this.faceIndices)return;const J=this.textures[t];J.is2DArray||J.is3D?this._bindTextureRenderTarget(this.textures[t],t,this.layerIndices[t]):J.isCube&&this._bindTextureRenderTarget(this.textures[t],t,this.faceIndices[t])}resolveMSAATextures(){const t=this._engine,b=t._currentFramebuffer;t._bindUnboundFramebuffer(this._MSAAFramebuffer),super.resolveMSAATextures(),t._bindUnboundFramebuffer(b)}dispose(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._disposeOnlyFramebuffers;const b=this._context;t||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(b.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(b.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(b.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(t)}}Z(12919);P.ThinEngine.prototype._createHardwareRenderTargetWrapper=function(t,b,Z){const J=new C(t,b,Z,this,this._gl);return this._renderTargetWrapperCache.push(J),J},P.ThinEngine.prototype.createRenderTargetTexture=function(t,b){const Z=this._createHardwareRenderTargetWrapper(!1,!1,t);let J,S,P=!0,v=!1,h=!1,C=1;void 0!==b&&"object"===typeof b&&(P=b.generateDepthBuffer??!0,v=!!b.generateStencilBuffer,h=!!b.noColorAttachment,J=b.colorAttachment,C=b.samples??1,S=b.label);const Y=J||(h?null:this._createInternalTexture(t,b,!0,5)),g=t.width||t,I=t.height||t,r=this._currentFramebuffer,M=this._gl,T=M.createFramebuffer();if(this._bindUnboundFramebuffer(T),Z._depthStencilBuffer=this._setupFramebufferDepthAttachments(v,P,g,I),!Y||Y.is2DArray||Y.is3D||M.framebufferTexture2D(M.FRAMEBUFFER,M.COLOR_ATTACHMENT0,M.TEXTURE_2D,Y._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(r),Z.label=S??"RenderTargetWrapper",Z._framebuffer=T,Z._generateDepthBuffer=P,Z._generateStencilBuffer=v,Z.setTextures(Y),J){if(Z._samples=J.samples,J.samples>1){const t=J._hardwareTexture.getMSAARenderBuffer(0);Z._MSAAFramebuffer=M.createFramebuffer(),this._bindUnboundFramebuffer(Z._MSAAFramebuffer),M.framebufferRenderbuffer(M.FRAMEBUFFER,M.COLOR_ATTACHMENT0,M.RENDERBUFFER,t),this._bindUnboundFramebuffer(null)}}else this.updateRenderTargetTextureSampleCount(Z,C);return Z},P.ThinEngine.prototype._createDepthStencilTexture=function(t,b,Z){const P=this._gl,v=t.layers||0,C=t.depth||0;let Y=P.TEXTURE_2D;0!==v?Y=P.TEXTURE_2D_ARRAY:0!==C&&(Y=P.TEXTURE_3D);const g=new J.d(this,12);if(g.label=b.label,!this._caps.depthTextureExtension)return S.c.Error("Depth texture is not supported by your browser or hardware."),g;const I={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...b};if(this._bindTextureDirectly(Y,g,!0),this._setupDepthStencilTexture(g,t,0!==I.comparisonFunction&&I.bilinearFiltering,I.comparisonFunction,I.samples),void 0!==I.depthTextureFormat){if(15!==I.depthTextureFormat&&16!==I.depthTextureFormat&&17!==I.depthTextureFormat&&13!==I.depthTextureFormat&&14!==I.depthTextureFormat&&18!==I.depthTextureFormat)return S.c.Error(`Depth texture ${I.depthTextureFormat} format is not supported.`),g;g.format=I.depthTextureFormat}else g.format=I.generateStencil?13:16;const r=(0,h.d)(g.format),M=this._getWebGLTextureTypeFromDepthTextureFormat(g.format),T=r?P.DEPTH_STENCIL:P.DEPTH_COMPONENT,a=this._getInternalFormatFromDepthTextureFormat(g.format,!0,r);return g.is2DArray?P.texImage3D(Y,0,a,g.width,g.height,v,0,T,M,null):g.is3D?P.texImage3D(Y,0,a,g.width,g.height,C,0,T,M,null):P.texImage2D(Y,0,a,g.width,g.height,0,T,M,null),this._bindTextureDirectly(Y,null),this._internalTexturesCache.push(g),Z._depthStencilBuffer&&(P.deleteRenderbuffer(Z._depthStencilBuffer),Z._depthStencilBuffer=null),this._bindUnboundFramebuffer(Z._MSAAFramebuffer??Z._framebuffer),Z._generateStencilBuffer=r,Z._depthStencilTextureWithStencil=r,Z._depthStencilBuffer=this._setupFramebufferDepthAttachments(Z._generateStencilBuffer,Z._generateDepthBuffer,Z.width,Z.height,Z.samples,g.format),this._bindUnboundFramebuffer(null),g},P.ThinEngine.prototype.updateRenderTargetTextureSampleCount=function(t,b){var Z;if(this.webGLVersion<2||!t)return 1;if(t.samples===b)return b;const J=this._gl;b=Math.min(b,this.getCaps().maxMSAASamples),t._depthStencilBuffer&&(J.deleteRenderbuffer(t._depthStencilBuffer),t._depthStencilBuffer=null),t._MSAAFramebuffer&&(J.deleteFramebuffer(t._MSAAFramebuffer),t._MSAAFramebuffer=null);const S=null===(Z=t.texture)||void 0===Z?void 0:Z._hardwareTexture;if(null===S||void 0===S||S.releaseMSAARenderBuffers(),t.texture&&b>1&&"function"===typeof J.renderbufferStorageMultisample){const Z=J.createFramebuffer();if(!Z)throw new Error("Unable to create multi sampled framebuffer");t._MSAAFramebuffer=Z,this._bindUnboundFramebuffer(t._MSAAFramebuffer);const P=this._createRenderBuffer(t.texture.width,t.texture.height,b,-1,this._getRGBABufferInternalSizedFormat(t.texture.type,t.texture.format,t.texture._useSRGBBuffer),J.COLOR_ATTACHMENT0,!1);if(!P)throw new Error("Unable to create multi sampled framebuffer");null===S||void 0===S||S.addMSAARenderBuffer(P)}this._bindUnboundFramebuffer(t._MSAAFramebuffer??t._framebuffer),t.texture&&(t.texture.samples=b),t._samples=b;const P=t._depthStencilTexture?t._depthStencilTexture.format:void 0;return t._depthStencilBuffer=this._setupFramebufferDepthAttachments(t._generateStencilBuffer,t._generateDepthBuffer,t.width,t.height,b,P),this._bindUnboundFramebuffer(null),b},P.ThinEngine.prototype._setupDepthStencilTexture=function(t,b,Z,J){let S=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;const P=b.width??b,v=b.height??b,h=b.layers||0,C=b.depth||0;t.baseWidth=P,t.baseHeight=v,t.width=P,t.height=v,t.is2DArray=h>0,t.depth=h||C,t.isReady=!0,t.samples=S,t.generateMipMaps=!1,t.samplingMode=Z?2:1,t.type=0,t._comparisonFunction=J;const Y=this._gl,g=this._getTextureTarget(t),I=this._getSamplingParameters(t.samplingMode,!1);Y.texParameteri(g,Y.TEXTURE_MAG_FILTER,I.mag),Y.texParameteri(g,Y.TEXTURE_MIN_FILTER,I.min),Y.texParameteri(g,Y.TEXTURE_WRAP_S,Y.CLAMP_TO_EDGE),Y.texParameteri(g,Y.TEXTURE_WRAP_T,Y.CLAMP_TO_EDGE),this.webGLVersion>1&&(0===J?(Y.texParameteri(g,Y.TEXTURE_COMPARE_FUNC,515),Y.texParameteri(g,Y.TEXTURE_COMPARE_MODE,Y.NONE)):(Y.texParameteri(g,Y.TEXTURE_COMPARE_FUNC,J),Y.texParameteri(g,Y.TEXTURE_COMPARE_MODE,Y.COMPARE_REF_TO_TEXTURE)))}},12889:(t,b,Z)=>{Z.d(b,{b:()=>J});class J{get underlyingResource(){return this._webGLTexture}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,b=arguments.length>1?arguments[1]:void 0;if(this._MSAARenderBuffers=null,this._context=b,!t&&(t=b.createTexture(),!t))throw new Error("Unable to create webGL texture");this.set(t)}setUsage(){}set(t){this._webGLTexture=t}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(t){this._MSAARenderBuffers||(this._MSAARenderBuffers=[]),this._MSAARenderBuffers.push(t)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(const t of this._MSAARenderBuffers)this._context.deleteRenderbuffer(t);this._MSAARenderBuffers=null}}getMSAARenderBuffer(){var t;let b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return(null===(t=this._MSAARenderBuffers)||void 0===t?void 0:t[b])??null}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}},12860:(t,b,Z)=>{Z.d(b,{b:()=>O});var J=Z(12663),S=Z(12585),P=Z(12866),v=Z(12570);class h{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:30;this._enabled=!0,this._rollingFrameTime=new C(t)}sampleFrame(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:v.e.Now;if(this._enabled){if(null!=this._lastFrameTimeMs){const b=t-this._lastFrameTimeMs;this._rollingFrameTime.add(b)}this._lastFrameTimeMs=t}}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){const t=this._rollingFrameTime.history(0);return 0===t?0:1e3/t}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}}class C{constructor(t){this._samples=new Array(t),this.reset()}add(t){let b;if(this.isSaturated()){const t=this._samples[this._pos];b=t-this.average,this.average-=b/(this._sampleCount-1),this._m2-=b*(t-this.average)}else this._sampleCount++;b=t-this.average,this.average+=b/this._sampleCount,this._m2+=b*(t-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=t,this._pos++,this._pos%=this._samples.length}history(t){if(t>=this._sampleCount||t>=this._samples.length)return 0;const b=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(b-t)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(t){const b=this._samples.length;return(t%b+b)%b}}var Y=Z(12882),g=Z(12557),I=Z(12889),r=(Z(12898),Z(12702));function M(t,b,Z,J){let S,P=1;1===J?S=new Float32Array(b*Z*4):2===J?(S=new Uint16Array(b*Z*4),P=15360):S=7===J?new Uint32Array(b*Z*4):new Uint8Array(b*Z*4);for(let v=0;v<b;v++)for(let J=0;J<Z;J++){const Z=3*(J*b+v),h=4*(J*b+v);S[h+0]=t[Z+0],S[h+1]=t[Z+1],S[h+2]=t[Z+2],S[h+3]=P}return S}function T(t){return function(b,Z,S,P,v,h,C,Y){let g=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,I=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;const r=t?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,M=t?10:11,T=new J.d(this,M);T.baseWidth=Z,T.baseHeight=S,T.baseDepth=P,T.width=Z,T.height=S,T.depth=P,T.format=v,T.type=I,T.generateMipMaps=h,T.samplingMode=Y,t?T.is3D=!0:T.is2DArray=!0,this._doNotHandleContextLost||(T._bufferView=b),t?this.updateRawTexture3D(T,b,v,C,g,I):this.updateRawTexture2DArray(T,b,v,C,g,I),this._bindTextureDirectly(r,T,!0);const a=this._getSamplingParameters(Y,h);return this._gl.texParameteri(r,this._gl.TEXTURE_MAG_FILTER,a.mag),this._gl.texParameteri(r,this._gl.TEXTURE_MIN_FILTER,a.min),h&&this._gl.generateMipmap(r),this._bindTextureDirectly(r,null),this._internalTexturesCache.push(T),T}}function a(t){return function(b,Z,J,S){let P=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,v=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;const h=t?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,C=this._getWebGLTextureType(v),Y=this._getInternalFormat(J),g=this._getRGBABufferInternalSizedFormat(v,J);this._bindTextureDirectly(h,b,!0),this._unpackFlipY(void 0===S||!!S),this._doNotHandleContextLost||(b._bufferView=Z,b.format=J,b.invertY=S,b._compression=P),b.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),P&&Z?this._gl.compressedTexImage3D(h,0,this.getCaps().s3tc[P],b.width,b.height,b.depth,0,Z):this._gl.texImage3D(h,0,g,b.width,b.height,b.depth,0,Y,C,Z),b.generateMipMaps&&this._gl.generateMipmap(h),this._bindTextureDirectly(h,null),b.isReady=!0}}P.ThinEngine.prototype.updateRawTexture=function(t,b,Z,J){let S=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,P=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,v=arguments.length>6&&void 0!==arguments[6]&&arguments[6];if(!t)return;const h=this._getRGBABufferInternalSizedFormat(P,Z,v),C=this._getInternalFormat(Z),Y=this._getWebGLTextureType(P);this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),this._unpackFlipY(void 0===J||!!J),this._doNotHandleContextLost||(t._bufferView=b,t.format=Z,t.type=P,t.invertY=J,t._compression=S),t.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),S&&b?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[S],t.width,t.height,0,b):this._gl.texImage2D(this._gl.TEXTURE_2D,0,h,t.width,t.height,0,C,Y,b),t.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),t.isReady=!0},P.ThinEngine.prototype.createRawTexture=function(t,b,Z,S,P,v,h){let C=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,Y=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,g=arguments.length>10&&void 0!==arguments[10]&&arguments[10];const I=new J.d(this,3);I.baseWidth=b,I.baseHeight=Z,I.width=b,I.height=Z,I.format=S,I.generateMipMaps=P,I.samplingMode=h,I.invertY=v,I._compression=C,I.type=Y,I._useSRGBBuffer=this._getUseSRGBBuffer(g,!P),this._doNotHandleContextLost||(I._bufferView=t),this.updateRawTexture(I,t,S,v,C,Y,I._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,I,!0);const r=this._getSamplingParameters(h,P);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,r.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,r.min),P&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(I),I},P.ThinEngine.prototype.createRawCubeTexture=function(t,b,Z,S,P,v,h){let C=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;const Y=this._gl,I=new J.d(this,8);I.isCube=!0,I.format=Z,I.type=S,this._doNotHandleContextLost||(I._bufferViewArray=t);const M=this._getWebGLTextureType(S);let T=this._getInternalFormat(Z);T===Y.RGB&&(T=Y.RGBA),M!==Y.FLOAT||this._caps.textureFloatLinearFiltering?M!==this._gl.HALF_FLOAT_OES||this._caps.textureHalfFloatLinearFiltering?M!==Y.FLOAT||this._caps.textureFloatRender?M!==Y.HALF_FLOAT||this._caps.colorBufferFloat||(P=!1,g.c.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(P=!1,g.c.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(P=!1,h=1,g.c.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(P=!1,h=1,g.c.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively."));const a=b,k=a;I.width=a,I.height=k,I.invertY=v,I._compression=C;if(!this.needPOTTextures||(0,r.i)(I.width)&&(0,r.i)(I.height)||(P=!1),t)this.updateRawCubeTexture(I,t,Z,S,v,C);else{const t=this._getRGBABufferInternalSizedFormat(S),b=0;this._bindTextureDirectly(Y.TEXTURE_CUBE_MAP,I,!0);for(let Z=0;Z<6;Z++)C?Y.compressedTexImage2D(Y.TEXTURE_CUBE_MAP_POSITIVE_X+Z,b,this.getCaps().s3tc[C],I.width,I.height,0,void 0):Y.texImage2D(Y.TEXTURE_CUBE_MAP_POSITIVE_X+Z,b,t,I.width,I.height,0,T,M,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,I,!0),t&&P&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);const u=this._getSamplingParameters(h,P);return Y.texParameteri(Y.TEXTURE_CUBE_MAP,Y.TEXTURE_MAG_FILTER,u.mag),Y.texParameteri(Y.TEXTURE_CUBE_MAP,Y.TEXTURE_MIN_FILTER,u.min),Y.texParameteri(Y.TEXTURE_CUBE_MAP,Y.TEXTURE_WRAP_S,Y.CLAMP_TO_EDGE),Y.texParameteri(Y.TEXTURE_CUBE_MAP,Y.TEXTURE_WRAP_T,Y.CLAMP_TO_EDGE),this._bindTextureDirectly(Y.TEXTURE_CUBE_MAP,null),I.generateMipMaps=P,I.samplingMode=h,I.isReady=!0,I},P.ThinEngine.prototype.updateRawCubeTexture=function(t,b,Z,J,S){let P=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,v=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;t._bufferViewArray=b,t.format=Z,t.type=J,t.invertY=S,t._compression=P;const h=this._gl,C=this._getWebGLTextureType(J);let Y=this._getInternalFormat(Z);const g=this._getRGBABufferInternalSizedFormat(J);let I=!1;Y===h.RGB&&(Y=h.RGBA,I=!0),this._bindTextureDirectly(h.TEXTURE_CUBE_MAP,t,!0),this._unpackFlipY(void 0===S||!!S),t.width%4!==0&&h.pixelStorei(h.UNPACK_ALIGNMENT,1);for(let r=0;r<6;r++){let Z=b[r];P?h.compressedTexImage2D(h.TEXTURE_CUBE_MAP_POSITIVE_X+r,v,this.getCaps().s3tc[P],t.width,t.height,0,Z):(I&&(Z=M(Z,t.width,t.height,J)),h.texImage2D(h.TEXTURE_CUBE_MAP_POSITIVE_X+r,v,g,t.width,t.height,0,Y,C,Z))}(!this.needPOTTextures||(0,r.i)(t.width)&&(0,r.i)(t.height))&&t.generateMipMaps&&0===v&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),t.isReady=!0},P.ThinEngine.prototype.createRawCubeTextureFromUrl=function(t,b,Z,J,S,P,v,h){let C=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,Y=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,g=arguments.length>10&&void 0!==arguments[10]?arguments[10]:3,I=arguments.length>11&&void 0!==arguments[11]&&arguments[11];const r=this._gl,T=this.createRawCubeTexture(null,Z,J,S,!P,I,g,null);null===b||void 0===b||b.addPendingData(T),T.url=t,T.isReady=!1,this._internalTexturesCache.push(T);const a=t=>{if(!T._hardwareTexture)return;const Z=T.width,P=v(t);if(P){if(h){const t=this._getWebGLTextureType(S);let b=this._getInternalFormat(J);const v=this._getRGBABufferInternalSizedFormat(S);let C=!1;b===r.RGB&&(b=r.RGBA,C=!0),this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,T,!0),this._unpackFlipY(!1);const Y=h(P);for(let J=0;J<Y.length;J++){const P=Z>>J;for(let Z=0;Z<6;Z++){let h=Y[J][Z];C&&(h=M(h,P,P,S)),r.texImage2D(Z,J,v,P,P,0,b,t,h)}}this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(T,P,J,S,I);T.isReady=!0,null===b||void 0===b||b.removePendingData(T),T.onLoadedObservable.notifyObservers(T),T.onLoadedObservable.clear(),C&&C()}};return this._loadFile(t,(t=>{a(t)}),void 0,null===b||void 0===b?void 0:b.offlineProvider,!0,((t,Z)=>{null===b||void 0===b||b.removePendingData(T),Y&&t&&Y(t.status+" "+t.statusText,Z)})),T},P.ThinEngine.prototype.createRawTexture2DArray=T(!1),P.ThinEngine.prototype.createRawTexture3D=T(!0),P.ThinEngine.prototype.updateRawTexture2DArray=a(!1),P.ThinEngine.prototype.updateRawTexture3D=a(!0);var k=Z(12618);P.ThinEngine.prototype._readTexturePixelsSync=function(t,b,Z){let J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,S=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,P=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,v=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],h=arguments.length>7&&void 0!==arguments[7]&&arguments[7],C=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,Y=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;const g=this._gl;if(!g)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){const t=g.createFramebuffer();if(!t)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=t}var I,r;(g.bindFramebuffer(g.FRAMEBUFFER,this._dummyFramebuffer),J>-1)?g.framebufferTexture2D(g.FRAMEBUFFER,g.COLOR_ATTACHMENT0,g.TEXTURE_CUBE_MAP_POSITIVE_X+J,null===(I=t._hardwareTexture)||void 0===I?void 0:I.underlyingResource,S):g.framebufferTexture2D(g.FRAMEBUFFER,g.COLOR_ATTACHMENT0,g.TEXTURE_2D,null===(r=t._hardwareTexture)||void 0===r?void 0:r.underlyingResource,S);let M=void 0!==t.type?this._getWebGLTextureType(t.type):g.UNSIGNED_BYTE;if(h)P||(P=(0,k.p)(t.type,4*b*Z));else if(M===g.UNSIGNED_BYTE)P||(P=new Uint8Array(4*b*Z)),M=g.UNSIGNED_BYTE;else P||(P=new Float32Array(4*b*Z)),M=g.FLOAT;return v&&this.flushFramebuffer(),g.readPixels(C,Y,b,Z,g.RGBA,M,P),g.bindFramebuffer(g.FRAMEBUFFER,this._currentFramebuffer),P},P.ThinEngine.prototype._readTexturePixels=function(t,b,Z){let J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,S=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,P=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,v=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],h=arguments.length>7&&void 0!==arguments[7]&&arguments[7],C=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,Y=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;return Promise.resolve(this._readTexturePixelsSync(t,b,Z,J,S,P,v,h,C,Y))};Z(12907);P.ThinEngine.prototype._createDepthStencilCubeTexture=function(t,b){const Z=new J.d(this,12);if(Z.isCube=!0,1===this.webGLVersion)return g.c.Error("Depth cube texture is not supported by WebGL 1."),Z;const S={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...b},P=this._gl;this._bindTextureDirectly(P.TEXTURE_CUBE_MAP,Z,!0),this._setupDepthStencilTexture(Z,t,S.bilinearFiltering,S.comparisonFunction);for(let J=0;J<6;J++)S.generateStencil?P.texImage2D(P.TEXTURE_CUBE_MAP_POSITIVE_X+J,0,P.DEPTH24_STENCIL8,t,t,0,P.DEPTH_STENCIL,P.UNSIGNED_INT_24_8,null):P.texImage2D(P.TEXTURE_CUBE_MAP_POSITIVE_X+J,0,P.DEPTH_COMPONENT24,t,t,0,P.DEPTH_COMPONENT,P.UNSIGNED_INT,null);return this._bindTextureDirectly(P.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(Z),Z},P.ThinEngine.prototype._setCubeMapTextureParams=function(t,b,Z){const J=this._gl;J.texParameteri(J.TEXTURE_CUBE_MAP,J.TEXTURE_MAG_FILTER,J.LINEAR),J.texParameteri(J.TEXTURE_CUBE_MAP,J.TEXTURE_MIN_FILTER,b?J.LINEAR_MIPMAP_LINEAR:J.LINEAR),J.texParameteri(J.TEXTURE_CUBE_MAP,J.TEXTURE_WRAP_S,J.CLAMP_TO_EDGE),J.texParameteri(J.TEXTURE_CUBE_MAP,J.TEXTURE_WRAP_T,J.CLAMP_TO_EDGE),t.samplingMode=b?3:2,b&&this.getCaps().textureMaxLevel&&void 0!==Z&&Z>0&&(J.texParameteri(J.TEXTURE_CUBE_MAP,J.TEXTURE_MAX_LEVEL,Z),t._maxLodLevel=Z),this._bindTextureDirectly(J.TEXTURE_CUBE_MAP,null)},P.ThinEngine.prototype.createCubeTexture=function(t,b,Z,J){let S=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,P=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,v=arguments.length>6?arguments[6]:void 0,h=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,C=arguments.length>8&&void 0!==arguments[8]&&arguments[8],Y=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,I=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0,M=arguments.length>11&&void 0!==arguments[11]?arguments[11]:null,T=arguments.length>13&&void 0!==arguments[13]&&arguments[13],a=arguments.length>14&&void 0!==arguments[14]?arguments[14]:null;const k=this._gl;return this.createCubeTextureBase(t,b,Z,!!J,S,P,v,h,C,Y,I,M,(t=>this._bindTextureDirectly(k.TEXTURE_CUBE_MAP,t,!0)),((t,b)=>{const Z=this.needPOTTextures?(0,r.h)(b[0].width,this._caps.maxCubemapTextureSize):b[0].width,P=Z,h=[k.TEXTURE_CUBE_MAP_POSITIVE_X,k.TEXTURE_CUBE_MAP_POSITIVE_Y,k.TEXTURE_CUBE_MAP_POSITIVE_Z,k.TEXTURE_CUBE_MAP_NEGATIVE_X,k.TEXTURE_CUBE_MAP_NEGATIVE_Y,k.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(k.TEXTURE_CUBE_MAP,t,!0),this._unpackFlipY(!1);const C=v?this._getInternalFormat(v,t._useSRGBBuffer):t._useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:k.RGBA;let Y=v?this._getInternalFormat(v):k.RGBA;t._useSRGBBuffer&&1===this.webGLVersion&&(Y=C);for(let J=0;J<h.length;J++)if(b[J].width!==Z||b[J].height!==P){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext)return void g.c.Warn("Cannot create canvas to resize texture.");this._workingCanvas.width=Z,this._workingCanvas.height=P,this._workingContext.drawImage(b[J],0,0,b[J].width,b[J].height,0,0,Z,P),k.texImage2D(h[J],0,C,Y,k.UNSIGNED_BYTE,this._workingCanvas)}else k.texImage2D(h[J],0,C,Y,k.UNSIGNED_BYTE,b[J]);J||k.generateMipmap(k.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(t,!J),t.width=Z,t.height=P,t.isReady=!0,v&&(t.format=v),t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),S&&S()}),!!T,a)},P.ThinEngine.prototype.generateMipMapsForCubemap=function(t){let b=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(t.generateMipMaps){const Z=this._gl;this._bindTextureDirectly(Z.TEXTURE_CUBE_MAP,t,!0),Z.generateMipmap(Z.TEXTURE_CUBE_MAP),b&&this._bindTextureDirectly(Z.TEXTURE_CUBE_MAP,null)}};Z(12911);P.ThinEngine.prototype.setDepthStencilTexture=function(t,b,Z,J){void 0!==t&&(b&&(this._boundUniforms[t]=b),Z&&Z.depthStencilTexture?this._setTexture(t,Z,!1,!0,J):this._setTexture(t,null,void 0,void 0,J))},P.ThinEngine.prototype.createRenderTargetCubeTexture=function(t,b){const Z=this._createHardwareRenderTargetWrapper(!1,!0,t),S={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,...b};S.generateStencilBuffer=S.generateDepthBuffer&&S.generateStencilBuffer,(1!==S.type||this._caps.textureFloatLinearFiltering)&&(2!==S.type||this._caps.textureHalfFloatLinearFiltering)||(S.samplingMode=1);const P=this._gl,v=new J.d(this,5);this._bindTextureDirectly(P.TEXTURE_CUBE_MAP,v,!0);const h=this._getSamplingParameters(S.samplingMode,S.generateMipMaps);1!==S.type||this._caps.textureFloat||(S.type=0,g.c.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),P.texParameteri(P.TEXTURE_CUBE_MAP,P.TEXTURE_MAG_FILTER,h.mag),P.texParameteri(P.TEXTURE_CUBE_MAP,P.TEXTURE_MIN_FILTER,h.min),P.texParameteri(P.TEXTURE_CUBE_MAP,P.TEXTURE_WRAP_S,P.CLAMP_TO_EDGE),P.texParameteri(P.TEXTURE_CUBE_MAP,P.TEXTURE_WRAP_T,P.CLAMP_TO_EDGE);for(let J=0;J<6;J++)P.texImage2D(P.TEXTURE_CUBE_MAP_POSITIVE_X+J,0,this._getRGBABufferInternalSizedFormat(S.type,S.format),t,t,0,this._getInternalFormat(S.format),this._getWebGLTextureType(S.type),null);const C=P.createFramebuffer();return this._bindUnboundFramebuffer(C),Z._depthStencilBuffer=this._setupFramebufferDepthAttachments(S.generateStencilBuffer,S.generateDepthBuffer,t,t),S.generateMipMaps&&P.generateMipmap(P.TEXTURE_CUBE_MAP),this._bindTextureDirectly(P.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),Z._framebuffer=C,Z._generateDepthBuffer=S.generateDepthBuffer,Z._generateStencilBuffer=S.generateStencilBuffer,v.width=t,v.height=t,v.isReady=!0,v.isCube=!0,v.samples=1,v.generateMipMaps=S.generateMipMaps,v.samplingMode=S.samplingMode,v.type=S.type,v.format=S.format,this._internalTexturesCache.push(v),Z.setTextures(v),Z};var u=Z(12923),l=Z(12748);P.ThinEngine.prototype.createPrefilteredCubeTexture=function(t,b,S,P){let v=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,h=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,C=arguments.length>6?arguments[6]:void 0,Y=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,I=!(arguments.length>8&&void 0!==arguments[8])||arguments[8];return this.createCubeTexture(t,b,null,!1,(async t=>{if(!t)return void(v&&v(null));const h=t.texture;if(I?t.info.sphericalPolynomial&&(h._sphericalPolynomial=t.info.sphericalPolynomial):h._sphericalPolynomial=new u.f,h._source=9,this.getCaps().textureLOD)return void(v&&v(h));const C=this._gl,Y=t.width;if(!Y)return;const{DDSTools:r}=await Z.e(29).then(Z.bind(Z,15167)),M=[];for(let Z=0;Z<3;Z++){const v=1-Z/2,I=P,T=Math.log2(Y)*S+P,a=I+(T-I)*v,k=Math.round(Math.min(Math.max(a,0),T)),u=new J.d(this,2);if(u.type=h.type,u.format=h.format,u.width=Math.pow(2,Math.max(Math.log2(Y)-k,0)),u.height=u.width,u.isCube=!0,u._cachedWrapU=0,u._cachedWrapV=0,this._bindTextureDirectly(C.TEXTURE_CUBE_MAP,u,!0),u.samplingMode=2,C.texParameteri(C.TEXTURE_CUBE_MAP,C.TEXTURE_MAG_FILTER,C.LINEAR),C.texParameteri(C.TEXTURE_CUBE_MAP,C.TEXTURE_MIN_FILTER,C.LINEAR),C.texParameteri(C.TEXTURE_CUBE_MAP,C.TEXTURE_WRAP_S,C.CLAMP_TO_EDGE),C.texParameteri(C.TEXTURE_CUBE_MAP,C.TEXTURE_WRAP_T,C.CLAMP_TO_EDGE),t.isDDS){const b=t.info,Z=t.data;this._unpackFlipY(b.isCompressed),r.UploadDDSLevels(this,u,Z,b,!0,6,k)}else g.c.Warn("DDS is the only prefiltered cube map supported so far.");this._bindTextureDirectly(C.TEXTURE_CUBE_MAP,null);const U=new l.d(b);U._isCube=!0,U._texture=u,u.isReady=!0,M.push(U)}h._lodTextureHigh=M[2],h._lodTextureMid=M[1],h._lodTextureLow=M[0],v&&v(h)}),h,C,Y,I,S,P)},P.ThinEngine.prototype.createUniformBuffer=function(t,b){const Z=this._gl.createBuffer();if(!Z)throw new Error("Unable to create uniform buffer");const J=new Y.d(Z);return this.bindUniformBuffer(J),t instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,t,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(t),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),J.references=1,J},P.ThinEngine.prototype.createDynamicUniformBuffer=function(t,b){const Z=this._gl.createBuffer();if(!Z)throw new Error("Unable to create dynamic uniform buffer");const J=new Y.d(Z);return this.bindUniformBuffer(J),t instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,t,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(t),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),J.references=1,J},P.ThinEngine.prototype.updateUniformBuffer=function(t,b,Z,J){this.bindUniformBuffer(t),void 0===Z&&(Z=0),void 0===J?b instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,Z,b):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,Z,new Float32Array(b)):b instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,b.subarray(Z,Z+J)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(b).subarray(Z,Z+J)),this.bindUniformBuffer(null)},P.ThinEngine.prototype.bindUniformBuffer=function(t){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,t?t.underlyingResource:null)},P.ThinEngine.prototype.bindUniformBufferBase=function(t,b,Z){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,b,t?t.underlyingResource:null)},P.ThinEngine.prototype.bindUniformBlock=function(t,b,Z){const J=t.program,S=this._gl.getUniformBlockIndex(J,b);4294967295!==S&&this._gl.uniformBlockBinding(J,S,Z)};var U=Z(12555),E=Z(12623);E.e.prototype.displayLoadingUI=function(){if(!(0,U.f)())return;const t=this.loadingScreen;t&&t.displayLoadingUI()},E.e.prototype.hideLoadingUI=function(){if(!(0,U.f)())return;const t=this._loadingScreen;t&&t.hideLoadingUI()},Object.defineProperty(E.e.prototype,"loadingScreen",{get:function(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=E.e.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen},set:function(t){this._loadingScreen=t},enumerable:!0,configurable:!0}),Object.defineProperty(E.e.prototype,"loadingUIText",{set:function(t){this.loadingScreen.loadingUIText=t},enumerable:!0,configurable:!0}),Object.defineProperty(E.e.prototype,"loadingUIBackgroundColor",{set:function(t){this.loadingScreen.loadingUIBackgroundColor=t},enumerable:!0,configurable:!0}),E.e.prototype.getInputElement=function(){return this._renderingCanvas},E.e.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null},E.e.prototype.getInputElementClientRect=function(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null},E.e.prototype.getAspectRatio=function(t){let b=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const Z=t.viewport;return this.getRenderWidth(b)*Z.width/(this.getRenderHeight(b)*Z.height)},E.e.prototype.getScreenAspectRatio=function(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)},E.e.prototype._verifyPointerLock=function(){var t;null===(t=this._onPointerLockChange)||void 0===t||t.call(this)},E.e.prototype.setAlphaEquation=function(t){if(this._alphaEquation!==t){switch(t){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774)}this._alphaEquation=t}},E.e.prototype.getInputElement=function(){return this._renderingCanvas},E.e.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc},E.e.prototype.setDepthFunction=function(t){this._depthCullingState.depthFunc=t},E.e.prototype.setDepthFunctionToGreater=function(){this.setDepthFunction(516)},E.e.prototype.setDepthFunctionToGreaterOrEqual=function(){this.setDepthFunction(518)},E.e.prototype.setDepthFunctionToLess=function(){this.setDepthFunction(513)},E.e.prototype.setDepthFunctionToLessOrEqual=function(){this.setDepthFunction(515)},E.e.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask},E.e.prototype.setDepthWrite=function(t){this._depthCullingState.depthMask=t},E.e.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest},E.e.prototype.setStencilBuffer=function(t){this._stencilState.stencilTest=t},E.e.prototype.getStencilMask=function(){return this._stencilState.stencilMask},E.e.prototype.setStencilMask=function(t){this._stencilState.stencilMask=t},E.e.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc},E.e.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef},E.e.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask},E.e.prototype.setStencilFunction=function(t){this._stencilState.stencilFunc=t},E.e.prototype.setStencilFunctionReference=function(t){this._stencilState.stencilFuncRef=t},E.e.prototype.setStencilFunctionMask=function(t){this._stencilState.stencilFuncMask=t},E.e.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail},E.e.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail},E.e.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass},E.e.prototype.setStencilOperationFail=function(t){this._stencilState.stencilOpStencilFail=t},E.e.prototype.setStencilOperationDepthFail=function(t){this._stencilState.stencilOpDepthFail=t},E.e.prototype.setStencilOperationPass=function(t){this._stencilState.stencilOpStencilDepthPass=t},E.e.prototype.cacheStencilState=function(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()},E.e.prototype.restoreStencilState=function(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)},E.e.prototype.setAlphaConstants=function(t,b,Z,J){this._alphaState.setAlphaBlendConstants(t,b,Z,J)},E.e.prototype.getAlphaMode=function(){return this._alphaMode},E.e.prototype.getAlphaEquation=function(){return this._alphaEquation},E.e.prototype.getRenderPassNames=function(){return this._renderPassNames},E.e.prototype.getCurrentRenderPassName=function(){return this._renderPassNames[this.currentRenderPassId]},E.e.prototype.createRenderPassId=function(t){const b=++E.e._RenderPassIdCounter;return this._renderPassNames[b]=t??"NONAME",b},E.e.prototype.releaseRenderPassId=function(t){this._renderPassNames[t]=void 0;for(let b=0;b<this.scenes.length;++b){const Z=this.scenes[b];for(let b=0;b<Z.meshes.length;++b){const J=Z.meshes[b];if(J.Wb)for(let b=0;b<J.Wb.length;++b){J.Wb[b]._removeDrawWrapper(t)}}}};Z(12919);function c(t){if(t.requestPointerLock){const b=t.requestPointerLock();b instanceof Promise?b.then((()=>{t.focus()})).catch((()=>{})):t.focus()}}var H=Z(12946),o=Z(12621);class O extends P.ThinEngine{static get NpmPackage(){return E.e.NpmPackage}static get Version(){return E.e.Version}static get Instances(){return S.e.Instances}static get LastCreatedEngine(){return S.e.LastCreatedEngine}static get LastCreatedScene(){return S.e.LastCreatedScene}static DefaultLoadingScreenFactory(t){return E.e.DefaultLoadingScreenFactory(t)}get _supportsHardwareTextureRescaling(){return!!O._RescalePostProcessFactory}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}get performanceMonitor(){return this._performanceMonitor}constructor(t,b,Z){super(t,b,Z,arguments.length>3&&void 0!==arguments[3]&&arguments[3]),this.customAnimationFrameRequester=null,this._performanceMonitor=new h,this._drawCalls=new H.c,t&&(this._features.supportRenderPasses=!0,Z=this._creationOptions)}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(t){super._sharedInit(t),function(t,b,Z){t._onCanvasFocus=()=>{t.onCanvasFocusObservable.notifyObservers(t)},t._onCanvasBlur=()=>{t.onCanvasBlurObservable.notifyObservers(t)},t._onCanvasContextMenu=b=>{t.disableContextMenu&&b.preventDefault()},b.addEventListener("focus",t._onCanvasFocus),b.addEventListener("blur",t._onCanvasBlur),b.addEventListener("contextmenu",t._onCanvasContextMenu),t._onBlur=()=>{t.disablePerformanceMonitorInBackground&&t.performanceMonitor.disable(),t._windowIsBackground=!0},t._onFocus=()=>{t.disablePerformanceMonitorInBackground&&t.performanceMonitor.enable(),t._windowIsBackground=!1},t._onCanvasPointerOut=Z=>{document.elementFromPoint(Z.clientX,Z.clientY)!==b&&t.onCanvasPointerOutObservable.notifyObservers(Z)};const J=t.getHostWindow();J&&"function"===typeof J.addEventListener&&(J.addEventListener("blur",t._onBlur),J.addEventListener("focus",t._onFocus)),b.addEventListener("pointerout",t._onCanvasPointerOut),Z.doNotHandleTouchAction||function(t){t&&t.setAttribute&&(t.setAttribute("touch-action","none"),t.style.touchAction="none",t.style.webkitTapHighlightColor="transparent")}(b),!E.e.audioEngine&&Z.audioEngine&&E.e.AudioEngineFactory&&(E.e.audioEngine=E.e.AudioEngineFactory(t.getRenderingCanvas(),t.getAudioContext(),t.getAudioDestination())),(0,U.d)()&&(t._onFullscreenChange=()=>{t.isFullscreen=!!document.fullscreenElement,t.isFullscreen&&t._pointerLockRequested&&b&&c(b)},document.addEventListener("fullscreenchange",t._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",t._onFullscreenChange,!1),t._onPointerLockChange=()=>{t.isPointerLock=document.pointerLockElement===b},document.addEventListener("pointerlockchange",t._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",t._onPointerLockChange,!1)),t.enableOfflineSupport=void 0!==E.e.OfflineProviderFactory,t._deterministicLockstep=!!Z.deterministicLockstep,t._lockstepMaxSteps=Z.lockstepMaxSteps||0,t._timeStep=Z.timeStep||1/60}(this,t,this._creationOptions)}resizeImageBitmap(t,b,Z){return function(t,b,Z,J){const S=t.createCanvas(Z,J).getContext("2d");if(!S)throw new Error("Unable to get 2d context for resizeImageBitmap");return S.drawImage(b,0,0),S.getImageData(0,0,Z,J).data}(this,t,b,Z)}async _createImageBitmapFromSource(t,b){return await async function(t,b,Z){return await new Promise(((J,S)=>{const P=new Image;P.onload=()=>{P.decode().then((()=>{t.createImageBitmap(P,Z).then((t=>{J(t)}))}))},P.onerror=()=>{S(`Error loading image ${P.src}`)},P.src=b}))}(this,t,b)}switchFullscreen(t){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(t)}enterFullscreen(t){this.isFullscreen||(this._pointerLockRequested=t,this._renderingCanvas&&function(t){const b=t.requestFullscreen||t.webkitRequestFullscreen;b&&b.call(t)}(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&function(){const t=document;document.exitFullscreen?document.exitFullscreen():t.webkitCancelFullScreen&&t.webkitCancelFullScreen()}()}setDitheringState(t){t?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(t){t?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}setDirectViewport(t,b,Z,J){const S=this._cachedViewport;return this._cachedViewport=null,this._viewport(t,b,Z,J),S}scissorClear(t,b,Z,J,S){this.enableScissor(t,b,Z,J),this.clear(S,!0,!0,!0),this.disableScissor()}enableScissor(t,b,Z,J){const S=this._gl;S.enable(S.SCISSOR_TEST),S.scissor(t,b,Z,J)}disableScissor(){const t=this._gl;t.disable(t.SCISSOR_TEST)}async _loadFileAsync(t,b,Z){return await new Promise(((J,S)=>{this._loadFile(t,(t=>{J(t)}),void 0,b,Z,((t,b)=>{S(b)}))}))}getVertexShaderSource(t){const b=this._gl.getAttachedShaders(t);return b?this._gl.getShaderSource(b[0]):null}getFragmentShaderSource(t){const b=this._gl.getAttachedShaders(t);return b?this._gl.getShaderSource(b[1]):null}set framebufferDimensionsObject(t){this._framebufferDimensionsObject=t,this._framebufferDimensionsObject&&this.onResizeObservable.notifyObservers(this)}_rebuildBuffers(){for(const t of this.scenes)t.resetCachedMaterial(),t._rebuildGeometries();for(const t of this._virtualScenes)t.resetCachedMaterial(),t._rebuildGeometries();super._rebuildBuffers()}getFontOffset(t){return function(t){const b=document.createElement("span");b.textContent="Hg",b.style.font=t;const Z=document.createElement("div");Z.style.display="inline-block",Z.style.width="1px",Z.style.height="0px",Z.style.verticalAlign="bottom";const J=document.createElement("div");J.style.whiteSpace="nowrap",J.appendChild(b),J.appendChild(Z),document.body.appendChild(J);let S=0,P=0;try{P=Z.getBoundingClientRect().top-b.getBoundingClientRect().top,Z.style.verticalAlign="baseline",S=Z.getBoundingClientRect().top-b.getBoundingClientRect().top}finally{document.body.removeChild(J)}return{ascent:S,height:P,descent:P-S}}(t)}_cancelFrame(){if(this.customAnimationFrameRequester){if(0!==this._frameHandler){this._frameHandler=0;const{cancelAnimationFrame:t}=this.customAnimationFrameRequester;t&&t(this.customAnimationFrameRequester.C)}}else super._cancelFrame()}_renderLoop(t){this._processFrame(t),this._activeRenderLoops.length>0&&0===this._frameHandler&&(this.customAnimationFrameRequester?(this.customAnimationFrameRequester.C=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.C):this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()))}enterPointerlock(){this._renderingCanvas&&c(this._renderingCanvas)}exitPointerlock(){document.exitPointerLock&&document.exitPointerLock()}ab(){this._measureFps(),super.ab()}_deletePipelineContext(t){const b=t;b&&b.program&&b.transformFeedback&&(this.deleteTransformFeedback(b.transformFeedback),b.transformFeedback=null),super._deletePipelineContext(t)}createShaderProgram(t,b,Z,J,S){let P=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;S=S||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);const v=super.createShaderProgram(t,b,Z,J,S,P);return this.onAfterShaderCompilationObservable.notifyObservers(this),v}_createShaderProgram(t,b,Z,J){let S=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const P=J.createProgram();if(t.program=P,!P)throw new Error("Unable to create program");if(J.attachShader(P,b),J.attachShader(P,Z),this.webGLVersion>1&&S){const b=this.createTransformFeedback();this.bindTransformFeedback(b),this.setTranformFeedbackVaryings(P,S),t.transformFeedback=b}return J.linkProgram(P),this.webGLVersion>1&&S&&this.bindTransformFeedback(null),t.context=J,t.vertexShader=b,t.fragmentShader=Z,t.isParallelCompiled||this._finalizePipelineContext(t),P}_releaseTexture(t){super._releaseTexture(t)}_releaseRenderTargetWrapper(t){super._releaseRenderTargetWrapper(t);for(const b of this.scenes){for(const Z of b.postProcesses)Z._outputTexture===t&&(Z._outputTexture=null);for(const Z of b.cameras)for(const b of Z._postProcesses)b&&b._outputTexture===t&&(b._outputTexture=null)}}_rescaleTexture(t,b,Z,J,S){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);const P=this.createRenderTargetTexture({width:b.width,height:b.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});if(!this._rescalePostProcess&&O._RescalePostProcessFactory&&(this._rescalePostProcess=O._RescalePostProcessFactory(this)),this._rescalePostProcess){this._rescalePostProcess.externalTextureSamplerBinding=!0;const v=()=>{this._rescalePostProcess.onApply=function(b){b._bindTexture("textureSampler",t)};let v=Z;v||(v=this.scenes[this.scenes.length-1]),v.postProcessManager.directRender([this._rescalePostProcess],P,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,b,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,J,0,0,b.width,b.height,0),this.unBindFramebuffer(P),P.dispose(),S&&S()},h=this._rescalePostProcess.getEffect();h?h.executeWhenCompiled(v):this._rescalePostProcess.onEffectCreatedObservable.addOnce((t=>{t.executeWhenCompiled(v)}))}}wrapWebGLTexture(t){let b=arguments.length>1&&void 0!==arguments[1]&&arguments[1],Z=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3,S=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,P=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;const v=new I.b(t,this._gl),h=new J.d(this,0,!0);return h._hardwareTexture=v,h.baseWidth=S,h.baseHeight=P,h.width=S,h.height=P,h.isReady=!0,h.useMipMaps=b,this.updateTextureSamplingMode(Z,h),h}_uploadImageToTexture(t,b){let Z=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const S=this._gl,P=this._getWebGLTextureType(t.type),v=this._getInternalFormat(t.format),h=this._getRGBABufferInternalSizedFormat(t.type,v),C=t.isCube?S.TEXTURE_CUBE_MAP:S.TEXTURE_2D;this._bindTextureDirectly(C,t,!0),this._unpackFlipY(t.invertY);let Y=S.TEXTURE_2D;t.isCube&&(Y=S.TEXTURE_CUBE_MAP_POSITIVE_X+Z),S.texImage2D(Y,J,h,v,P,b),this._bindTextureDirectly(C,null,!0)}updateTextureComparisonFunction(t,b){if(1===this.webGLVersion)return void g.c.Error("WebGL 1 does not support texture comparison.");const Z=this._gl;t.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,t,!0),0===b?(Z.texParameteri(Z.TEXTURE_CUBE_MAP,Z.TEXTURE_COMPARE_FUNC,515),Z.texParameteri(Z.TEXTURE_CUBE_MAP,Z.TEXTURE_COMPARE_MODE,Z.NONE)):(Z.texParameteri(Z.TEXTURE_CUBE_MAP,Z.TEXTURE_COMPARE_FUNC,b),Z.texParameteri(Z.TEXTURE_CUBE_MAP,Z.TEXTURE_COMPARE_MODE,Z.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),0===b?(Z.texParameteri(Z.TEXTURE_2D,Z.TEXTURE_COMPARE_FUNC,515),Z.texParameteri(Z.TEXTURE_2D,Z.TEXTURE_COMPARE_MODE,Z.NONE)):(Z.texParameteri(Z.TEXTURE_2D,Z.TEXTURE_COMPARE_FUNC,b),Z.texParameteri(Z.TEXTURE_2D,Z.TEXTURE_COMPARE_MODE,Z.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),t._comparisonFunction=b}createInstancesBuffer(t){const b=this._gl.createBuffer();if(!b)throw new Error("Unable to create instance buffer");const Z=new Y.d(b);return Z.gZ=t,this.bindArrayBuffer(Z),this._gl.bufferData(this._gl.ARRAY_BUFFER,t,this._gl.DYNAMIC_DRAW),Z.references=1,Z}deleteInstancesBuffer(t){this._gl.deleteBuffer(t)}async _clientWaitAsync(t){let b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,Z=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;const J=this._gl;return await new Promise(((S,P)=>{(0,o.f)((()=>{const Z=J.clientWaitSync(t,b,0);if(Z==J.WAIT_FAILED)throw new Error("clientWaitSync failed");return Z!=J.TIMEOUT_EXPIRED}),S,P,Z)}))}_readPixelsAsync(t,b,Z,J,S,P,v){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");const h=this._gl,C=h.createBuffer();h.bindBuffer(h.PIXEL_PACK_BUFFER,C),h.bufferData(h.PIXEL_PACK_BUFFER,v.byteLength,h.STREAM_READ),h.readPixels(t,b,Z,J,S,P,0),h.bindBuffer(h.PIXEL_PACK_BUFFER,null);const Y=h.fenceSync(h.SYNC_GPU_COMMANDS_COMPLETE,0);return Y?(h.flush(),this._clientWaitAsync(Y,0,10).then((()=>(h.deleteSync(Y),h.bindBuffer(h.PIXEL_PACK_BUFFER,C),h.getBufferSubData(h.PIXEL_PACK_BUFFER,0,v),h.bindBuffer(h.PIXEL_PACK_BUFFER,null),h.deleteBuffer(C),v)))):null}dispose(){this.hideLoadingUI(),this._rescalePostProcess&&this._rescalePostProcess.dispose(),function(t,b){1===S.e.Instances.length&&E.e.audioEngine&&(E.e.audioEngine.dispose(),E.e.audioEngine=null);const Z=t.getHostWindow();Z&&"function"===typeof Z.removeEventListener&&(Z.removeEventListener("blur",t._onBlur),Z.removeEventListener("focus",t._onFocus)),b&&(b.removeEventListener("focus",t._onCanvasFocus),b.removeEventListener("blur",t._onCanvasBlur),b.removeEventListener("pointerout",t._onCanvasPointerOut),b.removeEventListener("contextmenu",t._onCanvasContextMenu)),(0,U.d)()&&(document.removeEventListener("fullscreenchange",t._onFullscreenChange),document.removeEventListener("mozfullscreenchange",t._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",t._onFullscreenChange),document.removeEventListener("msfullscreenchange",t._onFullscreenChange),document.removeEventListener("pointerlockchange",t._onPointerLockChange),document.removeEventListener("mspointerlockchange",t._onPointerLockChange),document.removeEventListener("mozpointerlockchange",t._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",t._onPointerLockChange))}(this,this._renderingCanvas),super.dispose()}}O.ALPHA_DISABLE=0,O.ALPHA_ADD=1,O.ALPHA_COMBINE=2,O.ALPHA_SUBTRACT=3,O.ALPHA_MULTIPLY=4,O.ALPHA_MAXIMIZED=5,O.ALPHA_ONEONE=6,O.ALPHA_PREMULTIPLIED=7,O.ALPHA_PREMULTIPLIED_PORTERDUFF=8,O.ALPHA_INTERPOLATE=9,O.ALPHA_SCREENMODE=10,O.DELAYLOADSTATE_NONE=0,O.DELAYLOADSTATE_LOADED=1,O.DELAYLOADSTATE_LOADING=2,O.DELAYLOADSTATE_NOTLOADED=4,O.NEVER=512,O.ALWAYS=519,O.LESS=513,O.EQUAL=514,O.LEQUAL=515,O.GREATER=516,O.GEQUAL=518,O.NOTEQUAL=517,O.KEEP=7680,O.REPLACE=7681,O.INCR=7682,O.DECR=7683,O.INVERT=5386,O.INCR_WRAP=34055,O.DECR_WRAP=34056,O.TEXTURE_CLAMP_ADDRESSMODE=0,O.TEXTURE_WRAP_ADDRESSMODE=1,O.TEXTURE_MIRROR_ADDRESSMODE=2,O.TEXTUREFORMAT_ALPHA=0,O.TEXTUREFORMAT_LUMINANCE=1,O.TEXTUREFORMAT_LUMINANCE_ALPHA=2,O.TEXTUREFORMAT_RGB=4,O.TEXTUREFORMAT_RGBA=5,O.TEXTUREFORMAT_RED=6,O.TEXTUREFORMAT_R=6,O.TEXTUREFORMAT_R16_UNORM=33322,O.TEXTUREFORMAT_RG16_UNORM=33324,O.TEXTUREFORMAT_RGB16_UNORM=32852,O.TEXTUREFORMAT_RGBA16_UNORM=32859,O.TEXTUREFORMAT_R16_SNORM=36760,O.TEXTUREFORMAT_RG16_SNORM=36761,O.TEXTUREFORMAT_RGB16_SNORM=36762,O.TEXTUREFORMAT_RGBA16_SNORM=36763,O.TEXTUREFORMAT_RG=7,O.TEXTUREFORMAT_RED_INTEGER=8,O.TEXTUREFORMAT_R_INTEGER=8,O.TEXTUREFORMAT_RG_INTEGER=9,O.TEXTUREFORMAT_RGB_INTEGER=10,O.TEXTUREFORMAT_RGBA_INTEGER=11,O.TEXTURETYPE_UNSIGNED_BYTE=0,O.TEXTURETYPE_UNSIGNED_INT=0,O.TEXTURETYPE_FLOAT=1,O.TEXTURETYPE_HALF_FLOAT=2,O.TEXTURETYPE_BYTE=3,O.TEXTURETYPE_SHORT=4,O.TEXTURETYPE_UNSIGNED_SHORT=5,O.TEXTURETYPE_INT=6,O.TEXTURETYPE_UNSIGNED_INTEGER=7,O.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,O.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,O.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,O.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,O.TEXTURETYPE_UNSIGNED_INT_24_8=12,O.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,O.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,O.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,O.TEXTURE_NEAREST_SAMPLINGMODE=1,O.TEXTURE_BILINEAR_SAMPLINGMODE=2,O.TEXTURE_TRILINEAR_SAMPLINGMODE=3,O.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,O.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,O.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,O.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,O.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,O.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,O.TEXTURE_NEAREST_LINEAR=7,O.TEXTURE_NEAREST_NEAREST=1,O.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,O.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,O.TEXTURE_LINEAR_LINEAR=2,O.TEXTURE_LINEAR_NEAREST=12,O.TEXTURE_EXPLICIT_MODE=0,O.TEXTURE_SPHERICAL_MODE=1,O.TEXTURE_PLANAR_MODE=2,O.TEXTURE_CUBIC_MODE=3,O.TEXTURE_PROJECTION_MODE=4,O.TEXTURE_SKYBOX_MODE=5,O.TEXTURE_INVCUBIC_MODE=6,O.TEXTURE_EQUIRECTANGULAR_MODE=7,O.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,O.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,O.SCALEMODE_FLOOR=1,O.SCALEMODE_NEAREST=2,O.SCALEMODE_CEILING=3},12915:(t,b,Z)=>{Z.d(b,{b:()=>S});var J=Z(12892);class S{get depthStencilTexture(){return this._depthStencilTexture}setDepthStencilTexture(t){(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&this._depthStencilTexture&&this._depthStencilTexture.dispose(),this._depthStencilTexture=t,this._generateDepthBuffer=this._generateStencilBuffer=this._depthStencilTextureWithStencil=!1,t&&(this._generateDepthBuffer=!0,this._generateStencilBuffer=this._depthStencilTextureWithStencil=(0,J.d)(t.format))}get depthStencilTextureWithStencil(){return this._depthStencilTextureWithStencil}get isCube(){return this._isCube}get isMulti(){return this._isMulti}get is2DArray(){return this.layers>0}get is3D(){return this.depth>0}get size(){return this.width}get width(){return this._size.width??this._size}get height(){return this._size.height??this._size}get layers(){return this._size.layers||0}get depth(){return this._size.depth||0}get texture(){var t;return(null===(t=this._textures)||void 0===t?void 0:t[0])??null}get textures(){return this._textures}get faceIndices(){return this._faceIndices}get layerIndices(){return this._layerIndices}getBaseArrayLayer(t){var b,Z;if(!this._textures)return-1;const J=this._textures[t],S=(null===(b=this._layerIndices)||void 0===b?void 0:b[t])??0,P=(null===(Z=this._faceIndices)||void 0===Z?void 0:Z[t])??0;return J.isCube?6*S+P:J.is3D?0:S}get samples(){return this._samples}setSamples(t){let b=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],Z=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this.samples===t&&!Z)return t;const J=this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,t,b):this._engine.updateRenderTargetTextureSampleCount(this,t);return this._samples=t,J}resolveMSAATextures(){this.isMulti?this._engine.resolveMultiFramebuffer(this):this._engine.resolveFramebuffer(this)}generateMipMaps(){this._engine._currentRenderTarget===this&&this._engine.unBindFramebuffer(this,!0),this.isMulti?this._engine.generateMipMapsMultiFramebuffer(this):this._engine.generateMipMapsFramebuffer(this)}constructor(t,b,Z,J,S){this._textures=null,this._faceIndices=null,this._layerIndices=null,this._samples=1,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this.disableAutomaticMSAAResolve=!1,this.resolveMSAAColors=!0,this.resolveMSAADepth=!1,this.resolveMSAAStencil=!1,this._isMulti=t,this._isCube=b,this._size=Z,this._engine=J,this._depthStencilTexture=null,this.label=S}setTextures(t){Array.isArray(t)?this._textures=t:this._textures=t?[t]:null}setTexture(t){let b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,Z=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._textures||(this._textures=[]),this._textures[b]!==t&&(this._textures[b]&&Z&&this._textures[b].dispose(),this._textures[b]=t)}setLayerAndFaceIndices(t,b){this._layerIndices=t,this._faceIndices=b}setLayerAndFaceIndex(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,b=arguments.length>1?arguments[1]:void 0,Z=arguments.length>2?arguments[2]:void 0;this._layerIndices||(this._layerIndices=[]),this._faceIndices||(this._faceIndices=[]),void 0!==b&&b>=0&&(this._layerIndices[t]=b),void 0!==Z&&Z>=0&&(this._faceIndices[t]=Z)}createDepthStencilTexture(){var t;let b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,Z=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],J=arguments.length>2&&void 0!==arguments[2]&&arguments[2],S=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,P=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14,v=arguments.length>5?arguments[5]:void 0;return null===(t=this._depthStencilTexture)||void 0===t||t.dispose(),this._depthStencilTextureWithStencil=J,this._depthStencilTextureLabel=v,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:Z,comparisonFunction:b,generateStencil:J,isCube:this._isCube,samples:S,depthTextureFormat:P,label:v},this),this._depthStencilTexture}_shareDepth(t){this.shareDepth(t)}shareDepth(t){this._depthStencilTexture&&(t._depthStencilTexture&&t._depthStencilTexture.dispose(),t._depthStencilTexture=this._depthStencilTexture,t._depthStencilTextureWithStencil=this._depthStencilTextureWithStencil,this._depthStencilTexture.incrementReferences())}_swapAndDie(t){this.texture&&this.texture._swapAndDie(t),this._textures=null,this.dispose(!0)}_cloneRenderTargetWrapper(){let t=null;if(this._isMulti){const b=this.textures;if(b&&b.length>0){let Z=!1,J=b.length,S=-1;const P=b[b.length-1]._source;14!==P&&12!==P||(Z=!0,S=b[b.length-1].format,J--);const v=[],h=[],C=[],Y=[],g=[],I=[],r=[],M={};for(let t=0;t<J;++t){const Z=b[t];v.push(Z.samplingMode),h.push(Z.type),C.push(Z.format);void 0!==M[Z.uniqueId]?(Y.push(-1),r.push(0)):(M[Z.uniqueId]=t,Z.is2DArray?(Y.push(35866),r.push(Z.depth)):Z.isCube?(Y.push(34067),r.push(0)):Z.is3D?(Y.push(32879),r.push(Z.depth)):(Y.push(3553),r.push(0))),this._faceIndices&&g.push(this._faceIndices[t]??0),this._layerIndices&&I.push(this._layerIndices[t]??0)}const T={samplingModes:v,generateMipMaps:b[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:Z,depthTextureFormat:S,types:h,formats:C,textureCount:J,targetTypes:Y,faceIndex:g,layerIndex:I,layerCounts:r,label:this.label},a={width:this.width,height:this.height,depth:this.depth};t=this._engine.createMultipleRenderTarget(a,T);for(let k=0;k<J;++k){if(-1!==Y[k])continue;const Z=M[b[k].uniqueId];t.setTexture(t.textures[Z],k)}}}else{var b,Z,J,S;const v={};if(v.generateDepthBuffer=this._generateDepthBuffer,v.generateMipMaps=(null===(b=this.texture)||void 0===b?void 0:b.generateMipMaps)??!1,v.generateStencilBuffer=this._generateStencilBuffer,v.samplingMode=null===(Z=this.texture)||void 0===Z?void 0:Z.samplingMode,v.type=null===(J=this.texture)||void 0===J?void 0:J.type,v.format=null===(S=this.texture)||void 0===S?void 0:S.format,v.noColorAttachment=!this._textures,v.label=this.label,this.isCube)t=this._engine.createRenderTargetCubeTexture(this.width,v);else{var P;const b={width:this.width,height:this.height,layers:this.is2DArray||this.is3D?null===(P=this.texture)||void 0===P?void 0:P.depth:void 0};t=this._engine.createRenderTargetTexture(b,v)}t.texture&&(t.texture.isReady=!0)}return t}_swapRenderTargetWrapper(t){if(this._textures&&t._textures)for(let b=0;b<this._textures.length;++b)this._textures[b]._swapAndDie(t._textures[b],!1),t._textures[b].isReady=!0;this._depthStencilTexture&&t._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(t._depthStencilTexture),t._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null}_rebuild(){const t=this._cloneRenderTargetWrapper();if(t){if(this._depthStencilTexture){const b=this._depthStencilTexture.samplingMode,Z=this._depthStencilTexture.format,J=2===b||3===b||11===b;t.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,J,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples,Z,this._depthStencilTextureLabel)}this.samples>1&&t.setSamples(this.samples),t._swapRenderTargetWrapper(this),t.dispose()}}releaseTextures(){if(this._textures)for(let t=0;t<this._textures.length;++t)this._textures[t].dispose();this._textures=null}dispose(){var t;arguments.length>0&&void 0!==arguments[0]&&arguments[0]||(null===(t=this._depthStencilTexture)||void 0===t||t.dispose(),this._depthStencilTexture=null,this.releaseTextures());this._engine._releaseRenderTargetWrapper(this)}}},12866:(t,b,Z)=>{Z.r(b),Z.d(b,{ThinEngine:()=>E});var J=Z(12654),S=Z(12873),P=Z(12557),v=Z(12555);class h{constructor(){this.shaderLanguage=0}postProcessor(t,b,Z,J,S){if(S.drawBuffersExtensionDisabled){const b=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;t=t.replace(b,"")}return t}}const C=/(flat\s)?\s*varying\s*.*/;class Y{constructor(){this.shaderLanguage=0}attributeProcessor(t){return t.replace("attribute","in")}varyingCheck(t,b){return C.test(t)}varyingProcessor(t,b){return t.replace("varying",b?"in":"out")}postProcessor(t,b,Z){const J=-1!==t.search(/#extension.+GL_EXT_draw_buffers.+require/);if(t=(t=t.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),Z){const b=-1!==t.search(/layout *\(location *= *0\) *out/g);t=(t=(t=(t=(t=(t=(t=t.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/void\s+?main\s*\(/g,(J||b?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(")}else{if(-1!==b.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+t}return t}}var g=Z(12882),I=Z(12702),r=Z(12623),M=Z(12889),T=Z(12663),a=Z(12632),k=Z(12618),u=Z(12645),l=Z(12892);class U{}class E extends r.e{get name(){return this._name}set name(t){this._name=t}get version(){return this._webGLVersion}static get ShadersRepository(){return a.Effect.ShadersRepository}static set ShadersRepository(t){a.Effect.ShadersRepository=t}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(t){this._framebufferDimensionsObject=t}snapshotRenderingReset(){this.snapshotRendering=!1}constructor(t,b,Z,S){if(Z=Z||{},super(b??Z.antialias,Z,S),this._name="WebGL",this.forcePOTTextures=!1,this.validateShaderPrograms=!1,this.disableUniformBuffers=!1,this._webGLVersion=1,this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},!t)return;let v=null;if(t.getContext){if(v=t,void 0===Z.o&&(Z.o=!1),void 0===Z.xrCompatible&&(Z.xrCompatible=!1),navigator&&navigator.userAgent){this._setupMobileChecks();const t=navigator.userAgent;for(const b of E.ExceptionList){const J=b.key,S=b.targets;if(new RegExp(J).test(t)){if(b.capture&&b.captureConstraint){const Z=b.capture,J=b.captureConstraint,S=new RegExp(Z).exec(t);if(S&&S.length>0){if(parseInt(S[S.length-1])>=J)continue}}for(const t of S)switch(t){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":Z.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1}}}}if(this._doNotHandleContextLost?this._onContextLost=()=>{(0,J.x)(this._gl)}:(this._onContextLost=t=>{t.preventDefault(),this._contextWasLost=!0,(0,J.x)(this._gl),P.c.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost((()=>this._initGLContext()))},v.addEventListener("webglcontextrestored",this._onContextRestored,!1),Z.powerPreference=Z.powerPreference||"high-performance"),v.addEventListener("webglcontextlost",this._onContextLost,!1),this._badDesktopOS&&(Z.xrCompatible=!1),!Z.disableWebGL2Support)try{this._gl=v.getContext("webgl2",Z)||v.getContext("experimental-webgl2",Z),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch(I){}if(!this._gl){if(!v)throw new Error("The provided canvas is null or undefined.");try{this._gl=v.getContext("webgl",Z)||v.getContext("experimental-webgl",Z)}catch(I){throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=t,v=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const b=this._gl.getContextAttributes();b&&(Z.Ub=b.Ub)}this._sharedInit(v),this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),void 0!==Z.useHighPrecisionFloats&&(this._highPrecisionShadersAllowed=Z.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let J=0;J<this._caps.maxVertexAttribs;J++)this._currentBufferPointers[J]=new U;this._shaderProcessor=this.webGLVersion>1?new Y:new h;const C=`Babylon.js v${E.Version}`;P.c.Log(C+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",C);const g=(0,J.A)(this._gl);g.validateShaderPrograms=this.validateShaderPrograms,g.parallelShaderCompile=this._caps.parallelShaderCompile}_clearEmptyResources(){this._dummyFramebuffer=null,super._clearEmptyResources()}_getShaderProcessingContext(t){return null}areAllEffectsReady(){for(const t in this._compiledEffects){if(!this._compiledEffects[t].isReady())return!1}return!0}_initGLContext(){this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||null!==this._gl.getExtension("OES_standard_derivatives"),maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||null!==this._gl.getExtension("OES_element_index_uint"),fragmentDepthSupported:this._webGLVersion>1||null!==this._gl.getExtension("EXT_frag_depth"),highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,colorBufferHalfFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_half_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:1!==this._webGLVersion,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1,textureNorm16:!!this._gl.getExtension("EXT_texture_norm16")},this._caps.supportFloatTexturesResolve=this._caps.colorBufferFloat,this._caps.rg11b10ufColorRenderable=this._caps.colorBufferFloat,this._glVersion=this._gl.getParameter(this._gl.VERSION);const t=this._gl.getExtension("WEBGL_debug_renderer_info");if(null!=t&&(this._glRenderer=this._gl.getParameter(t.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(t.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),36193!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=36193),34842!==this._gl.RGBA16F&&(this._gl.RGBA16F=34842),34836!==this._gl.RGBA32F&&(this._gl.RGBA32F=34836),35056!==this._gl.DEPTH24_STENCIL8&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(1===this._webGLVersion&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=(this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)??0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!(!this._caps.textureFloat||!this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!(!this._caps.textureFloat||!this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.textureNorm16&&(this._gl.R16_EXT=33322,this._gl.RG16_EXT=33324,this._gl.RGB16_EXT=32852,this._gl.RGBA16_EXT=32859,this._gl.R16_SNORM_EXT=36760,this._gl.RG16_SNORM_EXT=36761,this._gl.RGB16_SNORM_EXT=36762,this._gl.RGBA16_SNORM_EXT=36763),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&5131!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=null!==this._maxMSAASamplesOverride?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES),this._caps.maxDrawBuffers=this._gl.getParameter(this._gl.MAX_DRAW_BUFFERS);else{const t=this._gl.getExtension("WEBGL_draw_buffers");if(null!==t){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=t.drawBuffersWEBGL.bind(t),this._caps.maxDrawBuffers=this._gl.getParameter(t.MAX_DRAW_BUFFERS_WEBGL),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let b=0;b<16;b++)this._gl["COLOR_ATTACHMENT"+b+"_WEBGL"]=t["COLOR_ATTACHMENT"+b+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{const t=this._gl.getExtension("WEBGL_depth_texture");null!=t&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=t.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{const t=this._gl.getExtension("OES_vertex_array_object");null!=t&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=t.createVertexArrayOES.bind(t),this._gl.bindVertexArray=t.bindVertexArrayOES.bind(t),this._gl.deleteVertexArray=t.deleteVertexArrayOES.bind(t))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{const t=this._gl.getExtension("ANGLE_instanced_arrays");null!=t?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=t.drawArraysInstancedANGLE.bind(t),this._gl.drawElementsInstanced=t.drawElementsInstancedANGLE.bind(t),this._gl.vertexAttribDivisor=t.vertexAttribDivisorANGLE.bind(t)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){const t=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),b=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);t&&b&&(this._caps.highPrecisionShaderSupported=0!==t.precision&&0!==b.precision)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{const t=this._gl.getExtension("EXT_blend_minmax");null!=t&&(this._caps.blendMinMax=!0,this._gl.MAX=t.MAX_EXT,this._gl.MIN=t.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:WebGL2RenderingContext.SRGB,SRGB8:WebGL2RenderingContext.SRGB8,SRGB8_ALPHA8:WebGL2RenderingContext.SRGB8_ALPHA8};else{const t=this._gl.getExtension("EXT_sRGB");null!=t&&(this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:t.SRGB_EXT,SRGB8:t.SRGB_ALPHA_EXT,SRGB8_ALPHA8:t.SRGB_ALPHA_EXT})}if(this._creationOptions){const t=this._creationOptions.forceSRGBBufferSupportState;void 0!==t&&(this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&t)}}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let b=0;b<this._maxSimultaneousTextures;b++)this._nextFreeTextureSlots.push(b);"Mali-G72"===this._glRenderer&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:"undefined"===typeof HTMLImageElement,supportRenderAndCopyToLodForFloatTextures:1!==this._webGLVersion,supportDepthStencilTexture:1!==this._webGLVersion,supportShadowSamplers:1!==this._webGLVersion,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:1!==this._webGLVersion,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:1!==this._webGLVersion,basisNeedsPOT:1===this._webGLVersion,support3DTextures:1!==this._webGLVersion,needTypeSuffixInShaderConstants:1!==this._webGLVersion,supportMSAA:1!==this._webGLVersion,supportSSAO2:1!==this._webGLVersion,supportIBLShadows:1!==this._webGLVersion,supportExtendedTextureFormats:1!==this._webGLVersion,supportSwitchCaseInShader:1!==this._webGLVersion,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,forceVertexBufferStrideAndOffsetMultiple4Bytes:!1,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const t=this._workingCanvas.getContext("2d");t&&(this._workingContext=t)}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}extractDriverInfo(){const t=this.getGlInfo();return t&&t.renderer?t.renderer:""}getRenderWidth(){return!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(){return!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}clear(t,b,Z){let J=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const S=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=S;let P=0;if(b&&t){let b=!0;if(this._currentRenderTarget){var v;const Z=null===(v=this._currentRenderTarget.texture)||void 0===v?void 0:v.format;if(8===Z||9===Z||10===Z||11===Z){var h;const Z=null===(h=this._currentRenderTarget.texture)||void 0===h?void 0:h.type;7===Z||5===Z?(E._TempClearColorUint32[0]=255*t.r,E._TempClearColorUint32[1]=255*t.g,E._TempClearColorUint32[2]=255*t.b,E._TempClearColorUint32[3]=255*t.a,this._gl.clearBufferuiv(this._gl.COLOR,0,E._TempClearColorUint32),b=!1):(E._TempClearColorInt32[0]=255*t.r,E._TempClearColorInt32[1]=255*t.g,E._TempClearColorInt32[2]=255*t.b,E._TempClearColorInt32[3]=255*t.a,this._gl.clearBufferiv(this._gl.COLOR,0,E._TempClearColorInt32),b=!1)}}b&&(this._gl.clearColor(t.r,t.g,t.b,void 0!==t.a?t.a:1),P|=this._gl.COLOR_BUFFER_BIT)}Z&&(this.Tb?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),P|=this._gl.DEPTH_BUFFER_BIT),J&&(this._gl.clearStencil(0),P|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(P)}_viewport(t,b,Z,J){t===this._viewportCached.x&&b===this._viewportCached.y&&Z===this._viewportCached.z&&J===this._viewportCached.w||(this._viewportCached.x=t,this._viewportCached.y=b,this._viewportCached.z=Z,this._viewportCached.w=J,this._gl.viewport(t,b,Z,J))}ub(){super.ub(),this._badOS&&this.flushFramebuffer()}get performanceMonitor(){throw new Error("Not Supported by ThinEngine")}bindFramebuffer(t){let b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,Z=arguments.length>2?arguments[2]:void 0,J=arguments.length>3?arguments[3]:void 0,S=arguments.length>4?arguments[4]:void 0,v=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,h=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;const C=t;this._currentRenderTarget&&this._resolveAndGenerateMipMapsFramebuffer(this._currentRenderTarget),this._currentRenderTarget=t,this._bindUnboundFramebuffer(C._framebuffer);const Y=this._gl;var g;if(!t.isMulti)if(t.is2DArray||t.is3D)Y.framebufferTextureLayer(Y.FRAMEBUFFER,Y.COLOR_ATTACHMENT0,null===(g=t.texture._hardwareTexture)||void 0===g?void 0:g.underlyingResource,v,h),C._currentLOD=v;else if(t.isCube){var I;Y.framebufferTexture2D(Y.FRAMEBUFFER,Y.COLOR_ATTACHMENT0,Y.TEXTURE_CUBE_MAP_POSITIVE_X+b,null===(I=t.texture._hardwareTexture)||void 0===I?void 0:I.underlyingResource,v)}else if(C._currentLOD!==v){var r;Y.framebufferTexture2D(Y.FRAMEBUFFER,Y.COLOR_ATTACHMENT0,Y.TEXTURE_2D,null===(r=t.texture._hardwareTexture)||void 0===r?void 0:r.underlyingResource,v),C._currentLOD=v}const M=t._depthStencilTexture;if(M){t.is3D&&(t.texture.width===M.width&&t.texture.height===M.height&&t.texture.depth===M.depth||P.c.Warn("Depth/Stencil attachment for 3D target must have same dimensions as color attachment"));const Z=t._depthStencilTextureWithStencil?Y.DEPTH_STENCIL_ATTACHMENT:Y.DEPTH_ATTACHMENT;var T;if(t.is2DArray||t.is3D)Y.framebufferTextureLayer(Y.FRAMEBUFFER,Z,null===(T=M._hardwareTexture)||void 0===T?void 0:T.underlyingResource,v,h);else if(t.isCube){var a;Y.framebufferTexture2D(Y.FRAMEBUFFER,Z,Y.TEXTURE_CUBE_MAP_POSITIVE_X+b,null===(a=M._hardwareTexture)||void 0===a?void 0:a.underlyingResource,v)}else{var k;Y.framebufferTexture2D(Y.FRAMEBUFFER,Z,Y.TEXTURE_2D,null===(k=M._hardwareTexture)||void 0===k?void 0:k.underlyingResource,v)}}C._MSAAFramebuffer&&this._bindUnboundFramebuffer(C._MSAAFramebuffer),this._cachedViewport&&!S?this.setViewport(this._cachedViewport,Z,J):(Z||(Z=t.width,v&&(Z/=Math.pow(2,v))),J||(J=t.height,v&&(J/=Math.pow(2,v))),this._viewport(0,0,Z,J)),this.wipeCaches()}setStateCullFaceType(t,b){const Z=this.cullBackFaces??t??1?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==Z||b)&&(this._depthCullingState.cullFace=Z)}setState(t){let b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,Z=arguments.length>2?arguments[2]:void 0,J=arguments.length>3&&void 0!==arguments[3]&&arguments[3],S=arguments.length>4?arguments[4]:void 0,P=arguments.length>5?arguments[5]:void 0,v=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;(this._depthCullingState.cull!==t||Z)&&(this._depthCullingState.cull=t),this.setStateCullFaceType(S,Z),this.setZOffset(b),this.setZOffsetUnits(v);const h=J?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==h||Z)&&(this._depthCullingState.frontFace=h),this._stencilStateComposer.stencilMaterial=P}_resolveAndGenerateMipMapsFramebuffer(t){let b=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t.disableAutomaticMSAAResolve||(t.isMulti?this.resolveMultiFramebuffer(t):this.resolveFramebuffer(t)),b||(t.isMulti?this.generateMipMapsMultiFramebuffer(t):this.generateMipMapsFramebuffer(t))}_bindUnboundFramebuffer(t){this._currentFramebuffer!==t&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,t),this._currentFramebuffer=t)}_currentFrameBufferIsDefaultFrameBuffer(){return null===this._currentFramebuffer}generateMipmaps(t){const b=this._getTextureTarget(t);this._bindTextureDirectly(b,t,!0),this._gl.generateMipmap(b),this._bindTextureDirectly(b,null)}unBindFramebuffer(t,b,Z){const J=t;this._currentRenderTarget=null,this._resolveAndGenerateMipMapsFramebuffer(t,b),Z&&(J._MSAAFramebuffer&&this._bindUnboundFramebuffer(J._framebuffer),Z()),this._bindUnboundFramebuffer(null)}generateMipMapsFramebuffer(t){var b;t.isMulti||null===(b=t.texture)||void 0===b||!b.generateMipMaps||t.isCube||this.generateMipmaps(t.texture)}resolveFramebuffer(t){const b=t,Z=this._gl;if(!b._MSAAFramebuffer||b.isMulti)return;let J=b.resolveMSAAColors?Z.COLOR_BUFFER_BIT:0;J|=b._generateDepthBuffer&&b.resolveMSAADepth?Z.DEPTH_BUFFER_BIT:0,J|=b._generateStencilBuffer&&b.resolveMSAAStencil?Z.STENCIL_BUFFER_BIT:0,Z.bindFramebuffer(Z.READ_FRAMEBUFFER,b._MSAAFramebuffer),Z.bindFramebuffer(Z.DRAW_FRAMEBUFFER,b._framebuffer),Z.blitFramebuffer(0,0,t.width,t.height,0,0,t.width,t.height,J,Z.NEAREST)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(t,b,Z){return this._createVertexBuffer(t,this._gl.STATIC_DRAW)}_createVertexBuffer(t,b){const Z=this._gl.createBuffer();if(!Z)throw new Error("Unable to create vertex buffer");const J=new g.d(Z);return this.bindArrayBuffer(J),"number"!==typeof t?t instanceof Array?(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(t),b),J.gZ=4*t.length):(this._gl.bufferData(this._gl.ARRAY_BUFFER,t,b),J.gZ=t.byteLength):(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Uint8Array(t),b),J.gZ=t),this._resetVertexBufferBinding(),J.references=1,J}createDynamicVertexBuffer(t,b){return this._createVertexBuffer(t,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(t,b,Z){const J=this._gl.createBuffer(),S=new g.d(J);if(!J)throw new Error("Unable to create index buffer");this.bindIndexBuffer(S);const P=this._normalizeIndexData(t);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,P,b?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),S.references=1,S.is32Bits=4===P.BYTES_PER_ELEMENT,S}_normalizeIndexData(t){if(2===t.BYTES_PER_ELEMENT)return t;if(this._caps.uintIndices){if(t instanceof Uint32Array)return t;for(let b=0;b<t.length;b++)if(t[b]>=65535)return new Uint32Array(t);return new Uint16Array(t)}return new Uint16Array(t)}bindArrayBuffer(t){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(t,this._gl.ARRAY_BUFFER)}bindUniformBlock(t,b,Z){const J=t.program,S=this._gl.getUniformBlockIndex(J,b);this._gl.uniformBlockBinding(J,S,Z)}bindIndexBuffer(t){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(t,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(t,b){(this._vaoRecordInProgress||this._currentBoundBuffer[b]!==t)&&(this._gl.bindBuffer(b,t?t.underlyingResource:null),this._currentBoundBuffer[b]=t)}updateArrayBuffer(t){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t)}_vertexAttribPointer(t,b,Z,J,S,P,v){const h=this._currentBufferPointers[b];if(!h)return;let C=!1;h.active?(h.buffer!==t&&(h.buffer=t,C=!0),h.size!==Z&&(h.size=Z,C=!0),h.type!==J&&(h.type=J,C=!0),h.normalized!==S&&(h.normalized=S,C=!0),h.stride!==P&&(h.stride=P,C=!0),h.offset!==v&&(h.offset=v,C=!0)):(C=!0,h.active=!0,h.index=b,h.size=Z,h.type=J,h.normalized=S,h.stride=P,h.offset=v,h.buffer=t),(C||this._vaoRecordInProgress)&&(this.bindArrayBuffer(t),J===this._gl.UNSIGNED_INT||J===this._gl.INT?this._gl.vertexAttribIPointer(b,Z,J,P,v):this._gl.vertexAttribPointer(b,Z,J,S,P,v))}_bindIndexBufferWithCache(t){null!=t&&this._cachedIndexBuffer!==t&&(this._cachedIndexBuffer=t,this.bindIndexBuffer(t),this._uintIndicesCurrentlySet=t.is32Bits)}_bindVertexBuffersAttributes(t,b,Z){const J=b.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let S=0;S<J.length;S++){const P=b.getAttributeLocation(S);if(P>=0){const b=J[S];let v=null;if(Z&&(v=Z[b]),v||(v=t[b]),!v)continue;this._gl.enableVertexAttribArray(P),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[P]=!0);const h=v.getBuffer();h&&(this._vertexAttribPointer(h,P,v.getSize(),v.type,v.normalized,v.byteStride,v.byteOffset),v.getIsInstanced()&&(this._gl.vertexAttribDivisor(P,v.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(P),this._currentInstanceBuffers.push(h))))}}}recordVertexArrayObject(t,b,Z,J){const S=this._gl.createVertexArray();if(!S)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(S),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(t,Z,J),this.bindIndexBuffer(b),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),S}bindVertexArrayObject(t,b){this._cachedVertexArrayObject!==t&&(this._cachedVertexArrayObject=t,this._gl.bindVertexArray(t),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=null!=b&&b.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(t,b,Z,J,S){if(this._cachedVertexBuffers!==t||this._cachedEffectForVertexBuffers!==S){this._cachedVertexBuffers=t,this._cachedEffectForVertexBuffers=S;const b=S.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let P=0;for(let v=0;v<b;v++)if(v<Z.length){const b=S.getAttributeLocation(v);b>=0&&(this._gl.enableVertexAttribArray(b),this._vertexAttribArraysEnabled[b]=!0,this._vertexAttribPointer(t,b,Z[v],this._gl.FLOAT,!1,J,P)),P+=4*Z[v]}}this._bindIndexBufferWithCache(b)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(t,b,Z,J){this._cachedVertexBuffers===t&&this._cachedEffectForVertexBuffers===Z||(this._cachedVertexBuffers=t,this._cachedEffectForVertexBuffers=Z,this._bindVertexBuffersAttributes(t,Z,J)),this._bindIndexBufferWithCache(b)}unbindInstanceAttributes(){let t;for(let b=0,Z=this._currentInstanceLocations.length;b<Z;b++){const Z=this._currentInstanceBuffers[b];t!=Z&&Z.references&&(t=Z,this.bindArrayBuffer(Z));const J=this._currentInstanceLocations[b];this._gl.vertexAttribDivisor(J,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(t){this._gl.deleteVertexArray(t)}_releaseBuffer(t){return t.references--,0===t.references&&(this._deleteBuffer(t),!0)}_deleteBuffer(t){this._gl.deleteBuffer(t.underlyingResource)}updateAndBindInstancesBuffer(t,b,Z){if(this.bindArrayBuffer(t),b&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,b),void 0!==Z[0].index)this.bindInstancesBuffer(t,Z,!0);else for(let J=0;J<4;J++){const b=Z[J];this._vertexAttribArraysEnabled[b]||(this._gl.enableVertexAttribArray(b),this._vertexAttribArraysEnabled[b]=!0),this._vertexAttribPointer(t,b,4,this._gl.FLOAT,!1,64,16*J),this._gl.vertexAttribDivisor(b,1),this._currentInstanceLocations.push(b),this._currentInstanceBuffers.push(t)}}bindInstancesBuffer(t,b){let Z=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.bindArrayBuffer(t);let J=0;if(Z)for(let S=0;S<b.length;S++){J+=4*b[S].attributeSize}for(let S=0;S<b.length;S++){const Z=b[S];void 0===Z.index&&(Z.index=this._currentEffect.getAttributeLocationByName(Z.attributeName)),Z.index<0||(this._vertexAttribArraysEnabled[Z.index]||(this._gl.enableVertexAttribArray(Z.index),this._vertexAttribArraysEnabled[Z.index]=!0),this._vertexAttribPointer(t,Z.index,Z.attributeSize,Z.attributeType||this._gl.FLOAT,Z.normalized||!1,J,Z.offset),this._gl.vertexAttribDivisor(Z.index,void 0===Z.divisor?1:Z.divisor),this._currentInstanceLocations.push(Z.index),this._currentInstanceBuffers.push(t))}}disableInstanceAttributeByName(t){if(!this._currentEffect)return;const b=this._currentEffect.getAttributeLocationByName(t);this.disableInstanceAttribute(b)}disableInstanceAttribute(t){let b,Z=!1;for(;-1!==(b=this._currentInstanceLocations.indexOf(t));)this._currentInstanceLocations.splice(b,1),this._currentInstanceBuffers.splice(b,1),Z=!0,b=this._currentInstanceLocations.indexOf(t);Z&&(this._gl.vertexAttribDivisor(t,0),this.disableAttributeByIndex(t))}disableAttributeByIndex(t){this._gl.disableVertexAttribArray(t),this._vertexAttribArraysEnabled[t]=!1,this._currentBufferPointers[t].active=!1}draw(t,b,Z,J){this.drawElementsType(t?0:1,b,Z,J)}drawPointClouds(t,b,Z){this.drawArraysType(2,t,b,Z)}drawUnIndexed(t,b,Z,J){this.drawArraysType(t?0:1,b,Z,J)}drawElementsType(t,b,Z,J){this.applyStates(),this._reportDrawCall();const S=this._drawMode(t),P=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,v=this._uintIndicesCurrentlySet?4:2;J?this._gl.drawElementsInstanced(S,Z,P,b*v,J):this._gl.drawElements(S,Z,P,b*v)}drawArraysType(t,b,Z,J){this.applyStates(),this._reportDrawCall();const S=this._drawMode(t);J?this._gl.drawArraysInstanced(S,b,Z,J):this._gl.drawArrays(S,b,Z)}_drawMode(t){switch(t){case 0:default:return this._gl.TRIANGLES;case 2:case 3:return this._gl.POINTS;case 1:case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN}}_releaseEffect(t){this._compiledEffects[t._key]&&delete this._compiledEffects[t._key];const b=t.getPipelineContext();b&&this._deletePipelineContext(b)}_deletePipelineContext(t){const b=t;b&&b.program&&(b.program.__SPECTOR_rebuildProgram=null,(0,u.k)(b),this._gl&&(this._currentProgram===b.program&&this._setProgram(null),this._gl.deleteProgram(b.program)))}_getGlobalDefines(t){return(0,k.k)(t,this.isNDCHalfZRange,this.Tb,this.useExactSrgbConversions)}createEffect(t,b,Z,S,P,v,h,C,Y){let g=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,I=arguments.length>10?arguments[10]:void 0;const r="string"===typeof t?t:t.vertexToken||t.vertexSource||t.vertexElement||t.vertex,M="string"===typeof t?t:t.fragmentToken||t.fragmentSource||t.fragmentElement||t.fragment,T=this._getGlobalDefines(),k=void 0!==b.attributes;let u=P??b.defines??"";T&&(u+=T);const l=r+"+"+M+"@"+u;if(this._compiledEffects[l]){const t=this._compiledEffects[l];return h&&t.isReady()&&h(t),t._refCount++,t}this._gl&&(0,J.A)(this._gl);const U=new a.Effect(t,b,k?this:Z,S,this,P,v,h,C,Y,l,b.shaderLanguage??g,b.extraInitializationsAsync??I);return this._compiledEffects[l]=U,U}_getShaderSource(t){return this._gl.getShaderSource(t)}createRawShaderProgram(t,b,Z,S){let P=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const v=(0,J.A)(this._gl);return v._contextWasLost=this._contextWasLost,v.validateShaderPrograms=this.validateShaderPrograms,(0,J.u)(t,b,Z,S||this._gl,P)}createShaderProgram(t,b,Z,S,P){let v=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;const h=(0,J.A)(this._gl);return h._contextWasLost=this._contextWasLost,h.validateShaderPrograms=this.validateShaderPrograms,(0,J.v)(t,b,Z,S,P||this._gl,v)}inlineShaderCode(t){return t}createPipelineContext(t){if(this._gl){(0,J.A)(this._gl).parallelShaderCompile=this._caps.parallelShaderCompile}const b=(0,J.s)(this._gl,t);return b.ZZ=this,b}createMaterialContext(){}createDrawContext(){}_finalizePipelineContext(t){return(0,J.g)(t,this._gl,this.validateShaderPrograms)}_preparePipelineContextAsync(t,b,Z,S,P,v,h,C,Y,g,I){const r=(0,J.A)(this._gl);return r._contextWasLost=this._contextWasLost,r.validateShaderPrograms=this.validateShaderPrograms,r._createShaderProgramInjection=this._createShaderProgram.bind(this),r.createRawShaderProgramInjection=this.createRawShaderProgram.bind(this),r.createShaderProgramInjection=this.createShaderProgram.bind(this),r.loadFileInjection=this._loadFile.bind(this),(0,J.o)(t,b,Z,S,P,v,h,C,Y,g,I)}_createShaderProgram(t,b,Z,S){let P=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return(0,J.b)(t,b,Z,S,P)}_isRenderingStateCompiled(t){return!this._isDisposed&&(0,J.k)(t,this._gl,this.validateShaderPrograms)}_executeWhenRenderingStateIsCompiled(t,b){(0,J.e)(t,b)}getUniforms(t,b){const Z=new Array,J=t;for(let S=0;S<b.length;S++)Z.push(this._gl.getUniformLocation(J.program,b[S]));return Z}getAttributes(t,b){const Z=[],J=t;for(let P=0;P<b.length;P++)try{Z.push(this._gl.getAttribLocation(J.program,b[P]))}catch(S){Z.push(-1)}return Z}enableEffect(t){(t=null!==t&&(0,S.e)(t)?t.effect:t)&&t!==this._currentEffect&&(this._stencilStateComposer.stencilMaterial=void 0,this.bindSamplers(t),this._currentEffect=t,t.onBind&&t.onBind(t),t._onBindObservable&&t._onBindObservable.notifyObservers(t))}setInt(t,b){return!!t&&(this._gl.uniform1i(t,b),!0)}setInt2(t,b,Z){return!!t&&(this._gl.uniform2i(t,b,Z),!0)}setInt3(t,b,Z,J){return!!t&&(this._gl.uniform3i(t,b,Z,J),!0)}setInt4(t,b,Z,J,S){return!!t&&(this._gl.uniform4i(t,b,Z,J,S),!0)}setIntArray(t,b){return!!t&&(this._gl.uniform1iv(t,b),!0)}setIntArray2(t,b){return!(!t||b.length%2!==0)&&(this._gl.uniform2iv(t,b),!0)}setIntArray3(t,b){return!(!t||b.length%3!==0)&&(this._gl.uniform3iv(t,b),!0)}setIntArray4(t,b){return!(!t||b.length%4!==0)&&(this._gl.uniform4iv(t,b),!0)}setUInt(t,b){return!!t&&(this._gl.uniform1ui(t,b),!0)}setUInt2(t,b,Z){return!!t&&(this._gl.uniform2ui(t,b,Z),!0)}setUInt3(t,b,Z,J){return!!t&&(this._gl.uniform3ui(t,b,Z,J),!0)}setUInt4(t,b,Z,J,S){return!!t&&(this._gl.uniform4ui(t,b,Z,J,S),!0)}setUIntArray(t,b){return!!t&&(this._gl.uniform1uiv(t,b),!0)}setUIntArray2(t,b){return!(!t||b.length%2!==0)&&(this._gl.uniform2uiv(t,b),!0)}setUIntArray3(t,b){return!(!t||b.length%3!==0)&&(this._gl.uniform3uiv(t,b),!0)}setUIntArray4(t,b){return!(!t||b.length%4!==0)&&(this._gl.uniform4uiv(t,b),!0)}setArray(t,b){return!!t&&(!(b.length<1)&&(this._gl.uniform1fv(t,b),!0))}setArray2(t,b){return!(!t||b.length%2!==0)&&(this._gl.uniform2fv(t,b),!0)}setArray3(t,b){return!(!t||b.length%3!==0)&&(this._gl.uniform3fv(t,b),!0)}setArray4(t,b){return!(!t||b.length%4!==0)&&(this._gl.uniform4fv(t,b),!0)}setMatrices(t,b){return!!t&&(this._gl.uniformMatrix4fv(t,!1,b),!0)}setMatrix3x3(t,b){return!!t&&(this._gl.uniformMatrix3fv(t,!1,b),!0)}setMatrix2x2(t,b){return!!t&&(this._gl.uniformMatrix2fv(t,!1,b),!0)}setFloat(t,b){return!!t&&(this._gl.uniform1f(t,b),!0)}setFloat2(t,b,Z){return!!t&&(this._gl.uniform2f(t,b,Z),!0)}setFloat3(t,b,Z,J){return!!t&&(this._gl.uniform3f(t,b,Z,J),!0)}setFloat4(t,b,Z,J,S){return!!t&&(this._gl.uniform4f(t,b,Z,J,S),!0)}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;const t=this._colorWrite;this._gl.colorMask(t,t,t,t)}}wipeCaches(t){this.preventCacheWipeBetweenFrames&&!t||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),t&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(t,b){const Z=this._gl;let J=Z.NEAREST,S=Z.NEAREST,P=!1;switch(t){case 11:J=Z.LINEAR,S=b?Z.LINEAR_MIPMAP_NEAREST:Z.LINEAR;break;case 3:J=Z.LINEAR,P=!0,S=b?Z.LINEAR_MIPMAP_LINEAR:Z.LINEAR;break;case 8:P=!0,J=Z.NEAREST,S=b?Z.NEAREST_MIPMAP_LINEAR:Z.NEAREST;break;case 4:J=Z.NEAREST,S=b?Z.NEAREST_MIPMAP_NEAREST:Z.NEAREST;break;case 5:J=Z.NEAREST,S=b?Z.LINEAR_MIPMAP_NEAREST:Z.LINEAR;break;case 6:P=!0,J=Z.NEAREST,S=b?Z.LINEAR_MIPMAP_LINEAR:Z.LINEAR;break;case 7:J=Z.NEAREST,S=Z.LINEAR;break;case 1:J=Z.NEAREST,S=Z.NEAREST;break;case 9:J=Z.LINEAR,S=b?Z.NEAREST_MIPMAP_NEAREST:Z.NEAREST;break;case 10:P=!0,J=Z.LINEAR,S=b?Z.NEAREST_MIPMAP_LINEAR:Z.NEAREST;break;case 2:J=Z.LINEAR,S=Z.LINEAR;break;case 12:J=Z.LINEAR,S=Z.NEAREST}return{min:S,mag:J,hasMipMaps:P}}_createTexture(){const t=this._gl.createTexture();if(!t)throw new Error("Unable to create texture");return t}_createHardwareTexture(){return new M.b(this._createTexture(),this._gl)}_createInternalTexture(t,b){let Z,J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,S=!1,v=!1,h=0,C=3,Y=5,g=!1,I=1,r=!1,M=0;void 0!==b&&"object"===typeof b?(S=!!b.generateMipMaps,v=!!b.createMipMaps,h=void 0===b.type?0:b.type,C=void 0===b.samplingMode?3:b.samplingMode,Y=void 0===b.format?5:b.format,g=void 0!==b.useSRGBBuffer&&b.useSRGBBuffer,I=b.samples??1,Z=b.label,r=!!b.createMSAATexture,M=b.comparisonFunction||0):S=!!b,g&&(g=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(1!==h||this._caps.textureFloatLinearFiltering)&&(2!==h||this._caps.textureHalfFloatLinearFiltering)||(C=1),1!==h||this._caps.textureFloat||(h=0,P.c.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const a=(0,l.g)(Y),k=(0,l.d)(Y),u=this._gl,U=new T.d(this,J),E=t.width||t,c=t.height||t,H=t.depth||0,o=t.layers||0,O=this._getSamplingParameters(C,(S||v)&&!a),p=0!==o?u.TEXTURE_2D_ARRAY:0!==H?u.TEXTURE_3D:u.TEXTURE_2D,e=a?this._getInternalFormatFromDepthTextureFormat(Y,!0,k):this._getRGBABufferInternalSizedFormat(h,Y,g),W=a?k?u.DEPTH_STENCIL:u.DEPTH_COMPONENT:this._getInternalFormat(Y),j=a?this._getWebGLTextureTypeFromDepthTextureFormat(Y):this._getWebGLTextureType(h);if(this._bindTextureDirectly(p,U),0!==o?(U.is2DArray=!0,u.texImage3D(p,0,e,E,c,o,0,W,j,null)):0!==H?(U.is3D=!0,u.texImage3D(p,0,e,E,c,H,0,W,j,null)):u.texImage2D(p,0,e,E,c,0,W,j,null),u.texParameteri(p,u.TEXTURE_MAG_FILTER,O.mag),u.texParameteri(p,u.TEXTURE_MIN_FILTER,O.min),u.texParameteri(p,u.TEXTURE_WRAP_S,u.CLAMP_TO_EDGE),u.texParameteri(p,u.TEXTURE_WRAP_T,u.CLAMP_TO_EDGE),a&&this.webGLVersion>1&&(0===M?(u.texParameteri(p,u.TEXTURE_COMPARE_FUNC,515),u.texParameteri(p,u.TEXTURE_COMPARE_MODE,u.NONE)):(u.texParameteri(p,u.TEXTURE_COMPARE_FUNC,M),u.texParameteri(p,u.TEXTURE_COMPARE_MODE,u.COMPARE_REF_TO_TEXTURE))),(S||v)&&this._gl.generateMipmap(p),this._bindTextureDirectly(p,null),U._useSRGBBuffer=g,U.baseWidth=E,U.baseHeight=c,U.width=E,U.height=c,U.depth=o||H,U.isReady=!0,U.samples=I,U.generateMipMaps=S,U.samplingMode=C,U.type=h,U.format=Y,U.label=Z,U.comparisonFunction=M,this._internalTexturesCache.push(U),r){let t=null;if(t=(0,l.g)(U.format)?this._setupFramebufferDepthAttachments((0,l.d)(U.format),19!==U.format,U.width,U.height,I,U.format,!0):this._createRenderBuffer(U.width,U.height,I,-1,this._getRGBABufferInternalSizedFormat(U.type,U.format,U._useSRGBBuffer),-1),!t)throw new Error("Unable to create render buffer");U._autoMSAAManagement=!0;let b=U._hardwareTexture;b||(b=U._hardwareTexture=this._createHardwareTexture()),b.addMSAARenderBuffer(t)}return U}_getUseSRGBBuffer(t,b){return t&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||b)}createTexture(t,b,Z,J){var S=this;let P=arguments.length>4&&void 0!==arguments[4]?arguments[4]:3,v=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,h=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,C=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,Y=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,g=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,I=arguments.length>10&&void 0!==arguments[10]?arguments[10]:null,r=arguments.length>11?arguments[11]:void 0,M=arguments.length>12?arguments[12]:void 0,a=arguments.length>13?arguments[13]:void 0,k=arguments.length>14?arguments[14]:void 0;return this._createTextureBase(t,b,Z,J,P,v,h,(function(){for(var t=arguments.length,b=new Array(t),Z=0;Z<t;Z++)b[Z]=arguments[Z];return S._prepareWebGLTexture(...b,g)}),((t,b,Z,S,P,v)=>{const h=this._gl,C=Z.width===t&&Z.height===b;P._creationFlags=a??0;const Y=this._getTexImageParametersForCreateTexture(P.format,P._useSRGBBuffer);if(C)return h.texImage2D(h.TEXTURE_2D,0,Y.internalFormat,Y.format,Y.type,Z),!1;const g=this._caps.maxTextureSize;if(Z.width>g||Z.height>g||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!(!this._workingCanvas||!this._workingContext)&&(this._workingCanvas.width=t,this._workingCanvas.height=b,this._workingContext.drawImage(Z,0,0,Z.width,Z.height,0,0,t,b),h.texImage2D(h.TEXTURE_2D,0,Y.internalFormat,Y.format,Y.type,this._workingCanvas),P.width=t,P.height=b,!1);{const t=new T.d(this,2);this._bindTextureDirectly(h.TEXTURE_2D,t,!0),h.texImage2D(h.TEXTURE_2D,0,Y.internalFormat,Y.format,Y.type,Z),this._rescaleTexture(t,P,J,Y.format,(()=>{this._releaseTexture(t),this._bindTextureDirectly(h.TEXTURE_2D,P,!0),v()}))}return!0}),C,Y,g,I,r,M,k)}_getTexImageParametersForCreateTexture(t,b){let Z,J;return 1===this.webGLVersion?(Z=this._getInternalFormat(t,b),J=Z):(Z=this._getInternalFormat(t,!1),J=this._getRGBABufferInternalSizedFormat(0,t,b)),{internalFormat:J,format:Z,type:this._gl.UNSIGNED_BYTE}}_rescaleTexture(t,b,Z,J,S){}_unpackFlipY(t){this._unpackFlipYCached!==t&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,t?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=t))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(t){return t.isCube?this._gl.TEXTURE_CUBE_MAP:t.is3D?this._gl.TEXTURE_3D:t.is2DArray||t.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(t,b){let Z=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const J=this._getTextureTarget(b),S=this._getSamplingParameters(t,b.useMipMaps||Z);this._setTextureParameterInteger(J,this._gl.TEXTURE_MAG_FILTER,S.mag,b),this._setTextureParameterInteger(J,this._gl.TEXTURE_MIN_FILTER,S.min),Z&&S.hasMipMaps&&(b.generateMipMaps=!0,this._gl.generateMipmap(J)),this._bindTextureDirectly(J,null),b.samplingMode=t}updateTextureDimensions(t,b,Z){}updateTextureWrappingMode(t,b){let Z=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;const S=this._getTextureTarget(t);null!==b&&(this._setTextureParameterInteger(S,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(b),t),t._cachedWrapU=b),null!==Z&&(this._setTextureParameterInteger(S,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(Z),t),t._cachedWrapV=Z),(t.is2DArray||t.is3D)&&null!==J&&(this._setTextureParameterInteger(S,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(J),t),t._cachedWrapR=J),this._bindTextureDirectly(S,null)}_uploadCompressedDataToTextureDirectly(t,b,Z,J,S){let P=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,v=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;const h=this._gl;let C=h.TEXTURE_2D;if(t.isCube&&(C=h.TEXTURE_CUBE_MAP_POSITIVE_X+P),t._useSRGBBuffer)switch(b){case 37492:case 36196:this._caps.etc2?b=h.COMPRESSED_SRGB8_ETC2:t._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?b=h.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:t._useSRGBBuffer=!1;break;case 36492:b=h.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:b=h.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?b=h.COMPRESSED_SRGB_S3TC_DXT1_EXT:t._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?b=h.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:t._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?b=h.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:t._useSRGBBuffer=!1;break;default:t._useSRGBBuffer=!1}this._gl.compressedTexImage2D(C,v,b,Z,J,0,S)}_uploadDataToTextureDirectly(t,b){let Z=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,S=arguments.length>4?arguments[4]:void 0,P=arguments.length>5&&void 0!==arguments[5]&&arguments[5];const v=this._gl,h=this._getWebGLTextureType(t.type),C=this._getInternalFormat(t.format),Y=void 0===S?this._getRGBABufferInternalSizedFormat(t.type,t.format,t._useSRGBBuffer):this._getInternalFormat(S,t._useSRGBBuffer);this._unpackFlipY(t.invertY);let g=v.TEXTURE_2D;t.isCube&&(g=v.TEXTURE_CUBE_MAP_POSITIVE_X+Z);const I=Math.round(Math.log(t.width)*Math.LOG2E),r=Math.round(Math.log(t.height)*Math.LOG2E),M=P?t.width:Math.pow(2,Math.max(I-J,0)),T=P?t.height:Math.pow(2,Math.max(r-J,0));v.texImage2D(g,J,Y,M,T,0,C,h,b)}updateTextureData(t,b,Z,J,S,P){let v=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,h=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,C=arguments.length>8&&void 0!==arguments[8]&&arguments[8];const Y=this._gl,g=this._getWebGLTextureType(t.type),I=this._getInternalFormat(t.format);this._unpackFlipY(t.invertY);let r=Y.TEXTURE_2D,M=Y.TEXTURE_2D;t.isCube&&(M=Y.TEXTURE_CUBE_MAP_POSITIVE_X+v,r=Y.TEXTURE_CUBE_MAP),this._bindTextureDirectly(r,t,!0),Y.texSubImage2D(M,h,Z,J,S,P,I,g,b),C&&this._gl.generateMipmap(M),this._bindTextureDirectly(r,null)}_uploadArrayBufferViewToTexture(t,b){let Z=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const S=this._gl,P=t.isCube?S.TEXTURE_CUBE_MAP:S.TEXTURE_2D;this._bindTextureDirectly(P,t,!0),this._uploadDataToTextureDirectly(t,b,Z,J),this._bindTextureDirectly(P,null,!0)}_prepareWebGLTextureContinuation(t,b,Z,J,S){const P=this._gl;if(!P)return;const v=this._getSamplingParameters(S,!Z);P.texParameteri(P.TEXTURE_2D,P.TEXTURE_MAG_FILTER,v.mag),P.texParameteri(P.TEXTURE_2D,P.TEXTURE_MIN_FILTER,v.min),Z||J||P.generateMipmap(P.TEXTURE_2D),this._bindTextureDirectly(P.TEXTURE_2D,null),b&&b.removePendingData(t),t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear()}_prepareWebGLTexture(t,b,Z,J,S,P,v,h,C,Y){const g=this.getCaps().maxTextureSize,r=Math.min(g,this.needPOTTextures?(0,I.h)(J.width,g):J.width),M=Math.min(g,this.needPOTTextures?(0,I.h)(J.height,g):J.height),T=this._gl;T&&(t._hardwareTexture?(this._bindTextureDirectly(T.TEXTURE_2D,t,!0),this._unpackFlipY(void 0===S||!!S),t.baseWidth=J.width,t.baseHeight=J.height,t.width=r,t.height=M,t.isReady=!0,t.type=-1!==t.type?t.type:0,t.format=-1!==t.format?t.format:Y??(".jpg"!==b||t._useSRGBBuffer?5:4),h(r,M,J,b,t,(()=>{this._prepareWebGLTextureContinuation(t,Z,P,v,C)}))||this._prepareWebGLTextureContinuation(t,Z,P,v,C)):Z&&Z.removePendingData(t))}_getInternalFormatFromDepthTextureFormat(t,b,Z){const J=this._gl;if(!b)return J.STENCIL_INDEX8;let S=Z?J.DEPTH_STENCIL:J.DEPTH_COMPONENT;return this.webGLVersion>1?15===t?S=J.DEPTH_COMPONENT16:16===t?S=J.DEPTH_COMPONENT24:17===t||13===t?S=Z?J.DEPTH24_STENCIL8:J.DEPTH_COMPONENT24:14===t?S=J.DEPTH_COMPONENT32F:18===t&&(S=Z?J.DEPTH32F_STENCIL8:J.DEPTH_COMPONENT32F):S=J.DEPTH_COMPONENT16,S}_getWebGLTextureTypeFromDepthTextureFormat(t){const b=this._gl;let Z=b.UNSIGNED_INT;return 15===t?Z=b.UNSIGNED_SHORT:17===t||13===t?Z=b.UNSIGNED_INT_24_8:14===t?Z=b.FLOAT:18===t?Z=b.FLOAT_32_UNSIGNED_INT_24_8_REV:19===t&&(Z=b.UNSIGNED_BYTE),Z}_setupFramebufferDepthAttachments(t,b,Z,J){let S=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,P=arguments.length>5?arguments[5]:void 0,v=arguments.length>6&&void 0!==arguments[6]&&arguments[6];const h=this._gl;P=P??(t?13:14);const C=this._getInternalFormatFromDepthTextureFormat(P,b,t);return t&&b?this._createRenderBuffer(Z,J,S,h.DEPTH_STENCIL,C,v?-1:h.DEPTH_STENCIL_ATTACHMENT):b?this._createRenderBuffer(Z,J,S,C,C,v?-1:h.DEPTH_ATTACHMENT):t?this._createRenderBuffer(Z,J,S,C,C,v?-1:h.STENCIL_ATTACHMENT):null}_createRenderBuffer(t,b,Z,J,S,P){let v=!(arguments.length>6&&void 0!==arguments[6])||arguments[6];const h=this._gl.createRenderbuffer();return this._updateRenderBuffer(h,t,b,Z,J,S,P,v)}_updateRenderBuffer(t,b,Z,J,S,P,v){let h=!(arguments.length>7&&void 0!==arguments[7])||arguments[7];const C=this._gl;return C.bindRenderbuffer(C.RENDERBUFFER,t),J>1&&C.renderbufferStorageMultisample?C.renderbufferStorageMultisample(C.RENDERBUFFER,J,P,b,Z):C.renderbufferStorage(C.RENDERBUFFER,S,b,Z),-1!==v&&C.framebufferRenderbuffer(C.FRAMEBUFFER,v,C.RENDERBUFFER,t),h&&C.bindRenderbuffer(C.RENDERBUFFER,null),t}_releaseTexture(t){this._deleteTexture(t._hardwareTexture),this.unbindAllTextures();const b=this._internalTexturesCache.indexOf(t);-1!==b&&this._internalTexturesCache.splice(b,1),t._lodTextureHigh&&t._lodTextureHigh.dispose(),t._lodTextureMid&&t._lodTextureMid.dispose(),t._lodTextureLow&&t._lodTextureLow.dispose(),t._irradianceTexture&&t._irradianceTexture.dispose()}_deleteTexture(t){null===t||void 0===t||t.release()}_setProgram(t){this._currentProgram!==t&&((0,J.q)(t,this._gl),this._currentProgram=t)}bindSamplers(t){const b=t.getPipelineContext();this._setProgram(b.program);const Z=t.getSamplers();for(let J=0;J<Z.length;J++){const b=t.getUniform(Z[J]);b&&(this._boundUniforms[J]=b)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(t,b){let Z=arguments.length>2&&void 0!==arguments[2]&&arguments[2],J=arguments.length>3&&void 0!==arguments[3]&&arguments[3],S=!1;const v=b&&b._associatedChannel>-1;Z&&v&&(this._activeChannel=b._associatedChannel);if(this._boundTexturesCache[this._activeChannel]!==b||J){if(this._activateCurrentTexture(),b&&b.isMultiview)throw P.c.Error(["_bindTextureDirectly called with a multiview texture!",t,b]),"_bindTextureDirectly called with a multiview texture!";var h;this._gl.bindTexture(t,(null===b||void 0===b||null===(h=b._hardwareTexture)||void 0===h?void 0:h.underlyingResource)??null),this._boundTexturesCache[this._activeChannel]=b,b&&(b._associatedChannel=this._activeChannel)}else Z&&(S=!0,this._activateCurrentTexture());return v&&!Z&&this._bindSamplerUniformToChannel(b._associatedChannel,this._activeChannel),S}_bindTexture(t,b,Z){if(void 0===t)return;b&&(b._associatedChannel=t),this._activeChannel=t;const J=b?this._getTextureTarget(b):this._gl.TEXTURE_2D;this._bindTextureDirectly(J,b)}unbindAllTextures(){for(let t=0;t<this._maxSimultaneousTextures;t++)this._activeChannel=t,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(t,b,Z,J){void 0!==t&&(b&&(this._boundUniforms[t]=b),this._setTexture(t,Z))}_bindSamplerUniformToChannel(t,b){const Z=this._boundUniforms[t];Z&&Z._currentState!==b&&(this._gl.uniform1i(Z,b),Z._currentState=b)}_getTextureWrapMode(t){switch(t){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(t,b){let Z,J=arguments.length>2&&void 0!==arguments[2]&&arguments[2],S=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!b)return null!=this._boundTexturesCache[t]&&(this._activeChannel=t,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(b.video){this._activeChannel=t;const Z=b.getInternalTexture();Z&&(Z._associatedChannel=t),b.update()}else if(4===b.delayLoadState)return b.delayLoad(),!1;Z=S?b.depthStencilTexture:b.isReady()?b.getInternalTexture():b.isCube?this.emptyCubeTexture:b.is3D?this.emptyTexture3D:b.is2DArray?this.emptyTexture2DArray:this.emptyTexture,!J&&Z&&(Z._associatedChannel=t);let P=!0;this._boundTexturesCache[t]===Z&&(J||this._bindSamplerUniformToChannel(Z._associatedChannel,t),P=!1),this._activeChannel=t;const v=this._getTextureTarget(Z);if(P&&this._bindTextureDirectly(v,Z,J),Z&&!Z.isMultiview){if(Z.isCube&&Z._cachedCoordinatesMode!==b.coordinatesMode){Z._cachedCoordinatesMode=b.coordinatesMode;const t=3!==b.coordinatesMode&&5!==b.coordinatesMode?1:0;b.wrapU=t,b.wrapV=t}Z._cachedWrapU!==b.wrapU&&(Z._cachedWrapU=b.wrapU,this._setTextureParameterInteger(v,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(b.wrapU),Z)),Z._cachedWrapV!==b.wrapV&&(Z._cachedWrapV=b.wrapV,this._setTextureParameterInteger(v,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(b.wrapV),Z)),Z.is3D&&Z._cachedWrapR!==b.wrapR&&(Z._cachedWrapR=b.wrapR,this._setTextureParameterInteger(v,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(b.wrapR),Z)),this._setAnisotropicLevel(v,Z,b.anisotropicFilteringLevel)}return!0}setTextureArray(t,b,Z,J){if(void 0!==t&&b){this._textureUnits&&this._textureUnits.length===Z.length||(this._textureUnits=new Int32Array(Z.length));for(let b=0;b<Z.length;b++){const J=Z[b].getInternalTexture();J?(this._textureUnits[b]=t+b,J._associatedChannel=t+b):this._textureUnits[b]=-1}this._gl.uniform1iv(b,this._textureUnits);for(let t=0;t<Z.length;t++)this._setTexture(this._textureUnits[t],Z[t],!0)}}_setAnisotropicLevel(t,b,Z){const J=this._caps.textureAnisotropicFilterExtension;11!==b.samplingMode&&3!==b.samplingMode&&2!==b.samplingMode&&(Z=1),J&&b._cachedAnisotropicFilteringLevel!==Z&&(this._setTextureParameterFloat(t,J.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(Z,this._caps.maxAnisotropy),b),b._cachedAnisotropicFilteringLevel=Z)}_setTextureParameterFloat(t,b,Z,J){this._bindTextureDirectly(t,J,!0,!0),this._gl.texParameterf(t,b,Z)}_setTextureParameterInteger(t,b,Z,J){J&&this._bindTextureDirectly(t,J,!0,!0),this._gl.texParameteri(t,b,Z)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let t=0;t<this._caps.maxVertexAttribs;t++)this.disableAttributeByIndex(t)}else for(let t=0,b=this._vertexAttribArraysEnabled.length;t<b;t++)t>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[t]||this.disableAttributeByIndex(t)}releaseEffects(){this._compiledEffects={},this.onReleaseEffectsObservable.notifyObservers(this)}dispose(){var t;((0,v.f)()&&this._renderingCanvas&&(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._onContextRestored&&this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),super.dispose(),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.unbindAllAttributes(),this._boundUniforms={},this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._currentProgram=null,this._creationOptions.loseContextOnDispose)&&(null===(t=this._gl.getExtension("WEBGL_lose_context"))||void 0===t||t.loseContext());(0,J.x)(this._gl)}attachContextLostEvent(t){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",t,!1)}attachContextRestoredEvent(t){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",t,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(t){const b=this._gl;for(;b.getError()!==b.NO_ERROR;);let Z=!0;const J=b.createTexture();b.bindTexture(b.TEXTURE_2D,J),b.texImage2D(b.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(t),1,1,0,b.RGBA,this._getWebGLTextureType(t),null),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST);const S=b.createFramebuffer();b.bindFramebuffer(b.FRAMEBUFFER,S),b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,J,0);const P=b.checkFramebufferStatus(b.FRAMEBUFFER);if(Z=Z&&P===b.FRAMEBUFFER_COMPLETE,Z=Z&&b.getError()===b.NO_ERROR,Z&&(b.clear(b.COLOR_BUFFER_BIT),Z=Z&&b.getError()===b.NO_ERROR),Z){b.bindFramebuffer(b.FRAMEBUFFER,null);const t=b.RGBA,J=b.UNSIGNED_BYTE,S=new Uint8Array(4);b.readPixels(0,0,1,1,t,J,S),Z=Z&&b.getError()===b.NO_ERROR}for(b.deleteTexture(J),b.deleteFramebuffer(S),b.bindFramebuffer(b.FRAMEBUFFER,null);!Z&&b.getError()!==b.NO_ERROR;);return Z}_getWebGLTextureType(t){if(1===this._webGLVersion){switch(t){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(t){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(t){let b=arguments.length>1&&void 0!==arguments[1]&&arguments[1],Z=b?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;switch(t){case 0:Z=this._gl.ALPHA;break;case 1:Z=this._gl.LUMINANCE;break;case 2:Z=this._gl.LUMINANCE_ALPHA;break;case 6:case 33322:case 36760:Z=this._gl.RED;break;case 7:case 33324:case 36761:Z=this._gl.RG;break;case 4:case 32852:case 36762:Z=b?this._glSRGBExtensionValues.SRGB:this._gl.RGB;break;case 5:case 32859:case 36763:Z=b?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA}if(this._webGLVersion>1)switch(t){case 8:Z=this._gl.RED_INTEGER;break;case 9:Z=this._gl.RG_INTEGER;break;case 10:Z=this._gl.RGB_INTEGER;break;case 11:Z=this._gl.RGBA_INTEGER}return Z}_getRGBABufferInternalSizedFormat(t,b){let Z=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(1===this._webGLVersion){if(void 0!==b)switch(b){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return Z?this._glSRGBExtensionValues.SRGB:this._gl.RGB}return this._gl.RGBA}switch(t){case 3:switch(b){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(b){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return Z?this._glSRGBExtensionValues.SRGB8:this._gl.RGB8;case 5:return Z?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(b){case 8:return this._gl.R16I;case 36760:return this._gl.R16_SNORM_EXT;case 36761:return this._gl.RG16_SNORM_EXT;case 36762:return this._gl.RGB16_SNORM_EXT;case 36763:return this._gl.RGBA16_SNORM_EXT;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;default:return this._gl.RGBA16I}case 5:switch(b){case 8:return this._gl.R16UI;case 33322:return this._gl.R16_EXT;case 33324:return this._gl.RG16_EXT;case 32852:return this._gl.RGB16_EXT;case 32859:return this._gl.RGBA16_EXT;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;default:return this._gl.RGBA16UI}case 6:switch(b){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;default:return this._gl.RGBA32I}case 7:switch(b){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;default:return this._gl.RGBA32UI}case 1:switch(b){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;default:return this._gl.RGBA32F}case 2:switch(b){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(b){case 5:default:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI}}return Z?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8}readPixels(t,b,Z,J){let S=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],v=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],h=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;const C=S?4:3,Y=S?this._gl.RGBA:this._gl.RGB,g=Z*J*C;if(h){if(h.length<g)return P.c.Error(`Data buffer is too small to store the read pixels (${h.length} should be more than ${g})`),Promise.resolve(h)}else h=new Uint8Array(g);return v&&this.flushFramebuffer(),this._gl.readPixels(t,b,Z,J,Y,this._gl.UNSIGNED_BYTE,h),Promise.resolve(h)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(null!==this._HasMajorPerformanceCaveat)return!this._HasMajorPerformanceCaveat;if(null===this._IsSupported)try{const t=r.e._CreateCanvas(1,1),b=t.getContext("webgl")||t.getContext("experimental-webgl");this._IsSupported=null!=b&&!!window.WebGLRenderingContext}catch(t){this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(null===this._HasMajorPerformanceCaveat)try{const t=r.e._CreateCanvas(1,1),b=t.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||t.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!b}catch(t){this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}}E._TempClearColorUint32=new Uint32Array(4),E._TempClearColorInt32=new Int32Array(4),E.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/12\\d\\..+?Mobile",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}],E._ConcatenateShader=k.h,E._IsSupported=null,E._HasMajorPerformanceCaveat=null},12784:(t,b,Z)=>{Z.d(b,{b:()=>M});var J=Z(12551),S=Z(12735),P=Z(12716),v=Z(12792),h=Z(12702),C=Z(12632),Y=Z(12557),g=Z(12818),I=Z(12742);class r{get renderList(){return this._renderList}set renderList(t){this._renderList!==t&&(this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),t&&(this._unObserveRenderList=(0,I.h)(t,this._renderListHasChanged)),this._renderList=t)}get disableImageProcessing(){return this._disableImageProcessing}set disableImageProcessing(t){t!==this._disableImageProcessing&&(this._disableImageProcessing=t,this._scene.markAllMaterialsAsDirty(64))}get name(){return this._name}set name(t){if(this._name===t)return;if(this._name=t,!this._scene)return;const b=this._scene.getEngine();for(let Z=0;Z<this._renderPassIds.length;++Z){const t=this._renderPassIds[Z];b._renderPassNames[t]=`${this._name}#${Z}`}}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}setMaterialForRendering(t,b){let Z;Z=Array.isArray(t)?t:[t];for(let J=0;J<Z.length;++J)for(let t=0;t<this.options.numPasses;++t){let S=Z[J];Z[J].isAnInstance&&(S=Z[J].sourceMesh),S.setMaterialForRenderPass(this._renderPassIds[t],void 0!==b?Array.isArray(b)?b[t]:b:void 0)}}constructor(t,b,Z){this._unObserveRenderList=null,this._renderListHasChanged=(t,b)=>{const Z=this._renderList?this._renderList.length:0;if(0===b&&Z>0||0===Z)for(const J of this._scene.meshes)J._markSubMeshesAsLightDirty()},this.particleSystemList=null,this.getCustomRenderList=null,this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this._disableImageProcessing=!1,this.onBeforeRenderObservable=new J.d,this.onAfterRenderObservable=new J.d,this.onBeforeRenderingManagerRenderObservable=new J.d,this.onAfterRenderingManagerRenderObservable=new J.d,this.onFastPathRenderObservable=new J.d,this._currentRefreshId=-1,this._refreshRate=1,this._currentApplyByPostProcessSetting=!1,this._currentSceneCamera=null,this.name=t,this._scene=b,this.renderList=[],this._renderPassIds=[],this.options={numPasses:1,doNotChangeAspectRatio:!0,...Z},this._createRenderPassId(),this.renderPassId=this._renderPassIds[0],this._renderingManager=new g.d(b),this._renderingManager._useSceneAutoClearSetup=!0}_releaseRenderPassId(){const t=this._scene.getEngine();for(let b=0;b<this.options.numPasses;++b)t.releaseRenderPassId(this._renderPassIds[b]);this._renderPassIds.length=0}_createRenderPassId(){this._releaseRenderPassId();const t=this._scene.getEngine();for(let b=0;b<this.options.numPasses;++b)this._renderPassIds[b]=t.createRenderPassId(`${this.name}#${b}`)}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(t){this._refreshRate=t,this.resetRefreshCounter()}shouldRender(){return-1===this._currentRefreshId||this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}isReadyForRendering(t,b){this.prepareRenderList(),this.initRender(t,b);const Z=this._checkReadiness();return this.finishRender(),Z}prepareRenderList(){const t=this._scene;if(this._waitingRenderList){if(!this.renderListPredicate){this.renderList=[];for(let b=0;b<this._waitingRenderList.length;b++){const Z=this._waitingRenderList[b],J=t.getMeshById(Z);J&&this.renderList.push(J)}}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const t=this._scene.meshes;for(let b=0;b<t.length;b++){const Z=t[b];this.renderListPredicate(Z)&&this.renderList.push(Z)}}this._currentApplyByPostProcessSetting=this._scene.imageProcessingConfiguration.applyByPostProcess,this._disableImageProcessing&&(this._scene.imageProcessingConfiguration._applyByPostProcess=this._disableImageProcessing)}initRender(t,b){const Z=this._scene.getEngine(),J=this.activeCamera??this._scene.activeCamera;this._currentSceneCamera=this._scene.activeCamera,J&&(J!==this._scene.activeCamera&&(this._scene.setTransformMatrix(J.getViewMatrix(),J.getProjectionMatrix(!0)),this._scene.activeCamera=J),Z.setViewport(J.rigParent?J.rigParent.viewport:J.viewport,t,b)),this._defaultRenderListPrepared=!1}finishRender(){const t=this._scene;this._disableImageProcessing&&(t.imageProcessingConfiguration._applyByPostProcess=this._currentApplyByPostProcessSetting),t.activeCamera=this._currentSceneCamera,this._currentSceneCamera&&(this.activeCamera&&this.activeCamera!==t.activeCamera&&t.setTransformMatrix(this._currentSceneCamera.getViewMatrix(),this._currentSceneCamera.getProjectionMatrix(!0)),t.getEngine().setViewport(this._currentSceneCamera.viewport)),t.resetCachedMaterial()}render(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,b=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const Z=this._scene,J=Z.getEngine(),S=J.currentRenderPassId;J.currentRenderPassId=this._renderPassIds[t],this.onBeforeRenderObservable.notifyObservers(t);if(J.snapshotRendering&&1===J.snapshotRenderingMode)this.onFastPathRenderObservable.notifyObservers(t);else{let b=null;const J=this.renderList?this.renderList:Z.getActiveMeshes().data,S=this.renderList?this.renderList.length:Z.getActiveMeshes().length;this.getCustomRenderList&&(b=this.getCustomRenderList(t,J,S)),b?this._prepareRenderingManager(b,b.length,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(J,S,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),b=J),this.onBeforeRenderingManagerRenderObservable.notifyObservers(t),this._renderingManager.render(this.customRenderFunction,b,this.renderParticles,this.renderSprites),this.onAfterRenderingManagerRenderObservable.notifyObservers(t)}b||this.onAfterRenderObservable.notifyObservers(t),J.currentRenderPassId=S}_checkReadiness(){const t=this._scene,b=t.getEngine(),Z=b.currentRenderPassId;let J=!0;t.getViewMatrix()||t.updateTransformMatrix();const S=this.options.numPasses;for(let v=0;v<S&&J;v++){let Z=null;const P=this.renderList?this.renderList:t.getActiveMeshes().data,h=this.renderList?this.renderList.length:t.getActiveMeshes().length;b.currentRenderPassId=this._renderPassIds[v],this.onBeforeRenderObservable.notifyObservers(v),this.getCustomRenderList&&(Z=this.getCustomRenderList(v,P,h)),Z||(Z=P),this.options.doNotChangeAspectRatio||t.updateTransformMatrix(!0);for(let t=0;t<Z.length&&J;++t){const b=Z[t];if(b.isEnabled()&&!b.isBlocked&&b.isVisible&&b.Wb)if(this.customIsReadyFunction){if(!this.customIsReadyFunction(b,this.refreshRate,!0)){J=!1;continue}}else if(!b.isReady(!0)){J=!1;continue}}this.onAfterRenderObservable.notifyObservers(v),S>1&&(t.incrementRenderId(),t.resetCachedMaterial())}const P=this.particleSystemList||t.Lr;for(const v of P)v.isReady()||(J=!1);return b.currentRenderPassId=Z,J}_prepareRenderingManager(t,b,Z){const J=this._scene,S=J.activeCamera,P=this.cameraForLOD??S;this._renderingManager.reset();const v=J.getRenderId(),h=J.getFrameId();for(let Y=0;Y<b;Y++){const b=t[Y];if(b&&!b.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(b,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!b.isReady(0===this.refreshRate)){this.resetRefreshCounter();continue}let t,C=null;if(P){const t=b._internalAbstractMeshDataInfo._currentLOD.get(P);t&&t[1]===h?C=t[0]:(C=J.customLODSelector?J.customLODSelector(b,P):b.getLOD(P),t?(t[0]=C,t[1]=h):b._internalAbstractMeshDataInfo._currentLOD.set(P,[C,h]))}else C=b;if(!C)continue;if(C!==b&&0!==C.billboardMode&&C.sb(),C._preActivateForIntermediateRendering(v),t=!(!Z||!S)&&0===(b.layerMask&S.layerMask),b.isEnabled()&&b.isVisible&&b.Wb&&!t){if(C!==b&&C._activate(v,!0),b._activate(v,!0)&&b.Wb.length){b.isAnInstance?b._internalAbstractMeshDataInfo._actAsRegularMesh&&(C=b):C._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,C._internalAbstractMeshDataInfo._isActiveIntermediate=!0,J._prepareSkeleton(C);for(let t=0;t<C.Wb.length;t++){const b=C.Wb[t];this._renderingManager.dispatch(b,C)}}b._postActivate()}}}const C=this.particleSystemList||J.Lr;for(let Y=0;Y<C.length;Y++){const t=C[Y],b=t.hb;t.isStarted()&&b&&(!b.position||b.isEnabled())&&this._renderingManager.dispatchParticles(t)}}setRenderingOrder(t){let b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,Z=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this._renderingManager.setRenderingOrder(t,b,Z,J)}setRenderingAutoClearDepthStencil(t,b){let Z=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],J=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];this._renderingManager.setRenderingAutoClearDepthStencil(t,b,Z,J),this._renderingManager._useSceneAutoClearSetup=!1}clone(){const t=new r(this.name,this._scene,this.options);return this.renderList&&(t.renderList=this.renderList.slice(0)),t}dispose(){const t=this.renderList?this.renderList:this._scene.getActiveMeshes().data,b=this.renderList?this.renderList.length:this._scene.getActiveMeshes().length;for(let Z=0;Z<b;Z++){const b=t[Z];b&&void 0!==b.getMaterialForRenderPass(this.renderPassId)&&b.setMaterialForRenderPass(this.renderPassId,void 0)}this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderingManagerRenderObservable.clear(),this.onAfterRenderingManagerRenderObservable.clear(),this.onFastPathRenderObservable.clear(),this._releaseRenderPassId(),this.renderList=null}_rebuild(){this.refreshRate===r.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=r.REFRESHRATE_RENDER_ONCE)}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}}r.REFRESHRATE_RENDER_ONCE=0,r.REFRESHRATE_RENDER_ONEVERYFRAME=1,r.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,C.Effect.prototype.setDepthStencilTexture=function(t,b){this._engine.setDepthStencilTexture(this._samplers[t],this._uniforms[t],b,t)};class M extends P.c{get renderListPredicate(){return this._objectRenderer.renderListPredicate}set renderListPredicate(t){this._objectRenderer.renderListPredicate=t}get renderList(){return this._objectRenderer.renderList}set renderList(t){this._objectRenderer.renderList=t}get particleSystemList(){return this._objectRenderer.particleSystemList}set particleSystemList(t){this._objectRenderer.particleSystemList=t}get getCustomRenderList(){return this._objectRenderer.getCustomRenderList}set getCustomRenderList(t){this._objectRenderer.getCustomRenderList=t}get renderParticles(){return this._objectRenderer.renderParticles}set renderParticles(t){this._objectRenderer.renderParticles=t}get renderSprites(){return this._objectRenderer.renderSprites}set renderSprites(t){this._objectRenderer.renderSprites=t}get forceLayerMaskCheck(){return this._objectRenderer.forceLayerMaskCheck}set forceLayerMaskCheck(t){this._objectRenderer.forceLayerMaskCheck=t}get activeCamera(){return this._objectRenderer.activeCamera}set activeCamera(t){this._objectRenderer.activeCamera=t}get cameraForLOD(){return this._objectRenderer.cameraForLOD}set cameraForLOD(t){this._objectRenderer.cameraForLOD=t}get disableImageProcessing(){return this._objectRenderer.disableImageProcessing}set disableImageProcessing(t){this._objectRenderer.disableImageProcessing=t}get customIsReadyFunction(){return this._objectRenderer.customIsReadyFunction}set customIsReadyFunction(t){this._objectRenderer.customIsReadyFunction=t}get customRenderFunction(){return this._objectRenderer.customRenderFunction}set customRenderFunction(t){this._objectRenderer.customRenderFunction=t}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(t){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(t)}get onBeforeRenderObservable(){return this._objectRenderer.onBeforeRenderObservable}set onBeforeRender(t){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(t)}get onAfterRenderObservable(){return this._objectRenderer.onAfterRenderObservable}set onAfterRender(t){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(t)}set onClear(t){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(t)}get _waitingRenderList(){return this._objectRenderer._waitingRenderList}set _waitingRenderList(t){this._objectRenderer._waitingRenderList=t}get renderPassId(){return this._objectRenderer.renderPassId}get renderPassIds(){return this._objectRenderer.renderPassIds}get currentRefreshId(){return this._objectRenderer.currentRefreshId}setMaterialForRendering(t,b){this._objectRenderer.setMaterialForRendering(t,b)}get isMulti(){var t;return(null===(t=this._renderTarget)||void 0===t?void 0:t.isMulti)??!1}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(t){if(this._boundingBoxSize&&this._boundingBoxSize.equals(t))return;this._boundingBoxSize=t;const b=this.et();b&&b.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){var t;return(null===(t=this._renderTarget)||void 0===t?void 0:t._depthStencilTexture)??null}constructor(t,b,Z){let v,h,C=arguments.length>3&&void 0!==arguments[3]&&arguments[3],g=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],I=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,M=arguments.length>6&&void 0!==arguments[6]&&arguments[6],T=arguments.length>7&&void 0!==arguments[7]?arguments[7]:P.c.TRILINEAR_SAMPLINGMODE,a=!(arguments.length>8&&void 0!==arguments[8])||arguments[8],k=arguments.length>9&&void 0!==arguments[9]&&arguments[9],u=arguments.length>10&&void 0!==arguments[10]&&arguments[10],l=arguments.length>11&&void 0!==arguments[11]?arguments[11]:5,U=arguments.length>12&&void 0!==arguments[12]&&arguments[12],E=arguments.length>13?arguments[13]:void 0,c=arguments.length>14?arguments[14]:void 0,H=arguments.length>15&&void 0!==arguments[15]&&arguments[15],o=arguments.length>16&&void 0!==arguments[16]&&arguments[16],O=!0;if("object"===typeof C){const t=C;C=!!t.generateMipMaps,g=t.doNotChangeAspectRatio??!0,I=t.type??0,M=!!t.isCube,T=t.samplingMode??P.c.TRILINEAR_SAMPLINGMODE,a=t.generateDepthBuffer??!0,k=!!t.generateStencilBuffer,u=!!t.isMulti,l=t.format??5,U=!!t.delayAllocation,E=t.samples,c=t.creationFlags,H=!!t.noColorAttachment,o=!!t.useSRGBBuffer,v=t.colorAttachment,O=t.gammaSpace??O,h=t.existingObjectRenderer}if(super(null,Z,!C,void 0,T,void 0,void 0,void 0,void 0,l),this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new J.d,this.onAfterUnbindObservable=new J.d,this.onClearObservable=new J.d,this.onResizeObservable=new J.d,this._cleared=!1,this.skipInitialClear=!1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this._dontDisposeObjectRenderer=!1,this.boundingBoxPosition=S.JZ.Zero(),this._disableEngineStages=!1,this._dumpToolsLoading=!1,!(Z=this.et()))return;const p=this.et().getEngine();this._gammaSpace=O,this._coordinatesMode=P.c.PROJECTION_MODE,this.name=t,this.isRenderTarget=!0,this._initialSizeParameter=b,this._dontDisposeObjectRenderer=!!h,this._processSizeParameter(b),this._objectRenderer=h??new r(t,Z,{numPasses:M?6:this.getRenderLayers()||1,doNotChangeAspectRatio:g}),this._onBeforeRenderingManagerRenderObserver=this._objectRenderer.onBeforeRenderingManagerRenderObservable.add((()=>{if(!this._disableEngineStages)for(const t of this._scene._beforeRenderTargetClearStage)t.action(this,this._currentFaceIndex,this._currentLayer);if(this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(p):this.skipInitialClear||p.clear(this.clearColor||this._scene.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),!this._disableEngineStages)for(const t of this._scene._beforeRenderTargetDrawStage)t.action(this,this._currentFaceIndex,this._currentLayer)})),this._onAfterRenderingManagerRenderObserver=this._objectRenderer.onAfterRenderingManagerRenderObservable.add((()=>{var t;if(!this._disableEngineStages)for(const Z of this._scene._afterRenderTargetDrawStage)Z.action(this,this._currentFaceIndex,this._currentLayer);const b=(null===(t=this._texture)||void 0===t?void 0:t.generateMipMaps)??!1;if(this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex,this._postProcesses,this.ignoreCameraViewport):this._currentUseCameraPostProcess&&this._scene.postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex),!this._disableEngineStages)for(const Z of this._scene._afterRenderTargetPostProcessStage)Z.action(this,this._currentFaceIndex,this._currentLayer);this._texture&&(this._texture.generateMipMaps=b),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),this._currentDumpForDebug&&(this._dumpTools?this._dumpTools.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),p):Y.c.Error("dumpTools module is still being loaded. To speed up the process import dump tools directly in your project"))})),this._onFastPathRenderObserver=this._objectRenderer.onFastPathRenderObservable.add((()=>{this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(p):this.skipInitialClear||p.clear(this.clearColor||this._scene.clearColor,!0,!0,!0)})),this._resizeObserver=p.onResizeObservable.add((()=>{})),this._generateMipMaps=!!C,this._doNotChangeAspectRatio=g,u||(this._renderTargetOptions={generateMipMaps:C,type:I,format:this._format??void 0,samplingMode:this.samplingMode,generateDepthBuffer:a,generateStencilBuffer:k,samples:E,creationFlags:c,noColorAttachment:H,useSRGBBuffer:o,colorAttachment:v,label:this.name},this.samplingMode===P.c.NEAREST_SAMPLINGMODE&&(this.wrapU=P.c.CLAMP_ADDRESSMODE,this.wrapV=P.c.CLAMP_ADDRESSMODE),U||(M?(this._renderTarget=Z.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=P.c.INVCUBIC_MODE,this._textureMatrix=S.Matrix.Identity()):this._renderTarget=Z.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==E&&(this.samples=E)))}createDepthStencilTexture(){var t;let b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,Z=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],J=arguments.length>2&&void 0!==arguments[2]&&arguments[2],S=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,P=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14,v=arguments.length>5?arguments[5]:void 0;null===(t=this._renderTarget)||void 0===t||t.createDepthStencilTexture(b,Z,J,S,P,v)}_processSizeParameter(t){if(t.ratio){this._sizeRatio=t.ratio;const b=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(b.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(b.getRenderHeight(),this._sizeRatio)}}else this._size=t}get samples(){var t;return(null===(t=this._renderTarget)||void 0===t?void 0:t.samples)??this._samples}set samples(t){this._renderTarget&&(this._samples=this._renderTarget.setSamples(t))}addPostProcess(t){if(!this._postProcessManager){const t=this.et();if(!t)return;this._postProcessManager=new v.c(t),this._postProcesses=new Array}this._postProcesses.push(t),this._postProcesses[0].eb=!1}clearPostProcesses(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._postProcesses){if(t)for(const t of this._postProcesses)t.dispose();this._postProcesses=[]}}removePostProcess(t){if(!this._postProcesses)return;const b=this._postProcesses.indexOf(t);-1!==b&&(this._postProcesses.splice(b,1),this._postProcesses.length>0&&(this._postProcesses[0].eb=!1))}resetRefreshCounter(){this._objectRenderer.resetRefreshCounter()}get refreshRate(){return this._objectRenderer.refreshRate}set refreshRate(t){this._objectRenderer.refreshRate=t}_shouldRender(){return this._objectRenderer.shouldRender()}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){const t=this._size.layers;if(t)return t;const b=this._size.depth;return b||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(t){const b=Math.max(1,this.getRenderSize()*t);this.resize(b)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(t){var b;const Z=this.isCube;null===(b=this._renderTarget)||void 0===b||b.dispose(),this._renderTarget=null;const J=this.et();J&&(this._processSizeParameter(t),this._renderTarget=Z?J.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):J.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==this._renderTargetOptions.samples&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],b=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._render(t,b)}isReadyForRendering(){this._dumpToolsLoading||(this._dumpToolsLoading=!0,Z.e(20).then(Z.bind(Z,12955)).then((t=>this._dumpTools=t))),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight());const t=this._objectRenderer._checkReadiness();return this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender(),t}_render(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],b=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const Z=this.et();if(Z){if(void 0!==this.useCameraPostProcesses&&(t=this.useCameraPostProcesses),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight()),!this.is2DArray&&!this.is3D||this.isMulti)if(this.isCube&&!this.isMulti)for(let J=0;J<6;J++)this._renderToTarget(J,t,b),Z.incrementRenderId(),Z.resetCachedMaterial();else this._renderToTarget(0,t,b);else for(let J=0;J<this.getRenderLayers();J++)this._renderToTarget(0,t,b,J),Z.incrementRenderId(),Z.resetCachedMaterial();this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender()}}_bestReflectionRenderTargetDimension(t,b){const Z=t*b,J=(0,h.k)(Z+16384/(128+Z));return Math.min((0,h.e)(t),J)}_bindFrameBuffer(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const Z=this.et();if(!Z)return;const J=Z.getEngine();this._renderTarget&&J.bindFramebuffer(this._renderTarget,this.isCube?t:void 0,void 0,void 0,this.ignoreCameraViewport,0,b)}_unbindFrameBuffer(t,b){this._renderTarget&&t.unBindFramebuffer(this._renderTarget,this.isCube,(()=>{this.onAfterRenderObservable.notifyObservers(b)}))}_prepareFrame(t,b,Z,J){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses)||this._bindFrameBuffer(b,Z):J&&t.postProcessManager._prepareFrame(this._texture)||this._bindFrameBuffer(b,Z)}_renderToTarget(t,b,Z){var J,S;let P=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const v=this.et();if(!v)return;const h=v.getEngine();this._currentFaceIndex=t,this._currentLayer=P,this._currentUseCameraPostProcess=b,this._currentDumpForDebug=Z,this._prepareFrame(v,t,P,b),null===(J=h._debugPushGroup)||void 0===J||J.call(h,`render to face #${t} layer #${P}`,2),this._objectRenderer.render(t+P,!0),null===(S=h._debugPopGroup)||void 0===S||S.call(h,2),this._unbindFrameBuffer(h,t),this._texture&&this.isCube&&5===t&&h.generateMipMapsForCubemap(this._texture,!0)}setRenderingOrder(t){let b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,Z=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this._objectRenderer.setRenderingOrder(t,b,Z,J)}setRenderingAutoClearDepthStencil(t,b){this._objectRenderer.setRenderingAutoClearDepthStencil(t,b)}clone(){const t=this.getSize(),b=new M(this.name,t,this.et(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return b.Vb=this.Vb,b.level=this.level,b.coordinatesMode=this.coordinatesMode,this.renderList&&(b.renderList=this.renderList.slice(0)),b}serialize(){if(!this.name)return null;const t=super.serialize();if(t.renderTargetSize=this.getRenderSize(),t.renderList=[],this.renderList)for(let b=0;b<this.renderList.length;b++)t.renderList.push(this.renderList[b].id);return t}disposeFramebufferObjects(){var t;null===(t=this._renderTarget)||void 0===t||t.dispose(!0)}releaseInternalTexture(){var t;null===(t=this._renderTarget)||void 0===t||t.releaseTextures(),this._texture=null}dispose(){var t;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._objectRenderer.onBeforeRenderingManagerRenderObservable.remove(this._onBeforeRenderingManagerRenderObserver),this._objectRenderer.onAfterRenderingManagerRenderObservable.remove(this._onAfterRenderingManagerRenderObserver),this._objectRenderer.onFastPathRenderObservable.remove(this._onFastPathRenderObserver),this._dontDisposeObjectRenderer||this._objectRenderer.dispose(),this.clearPostProcesses(!0),this._resizeObserver&&(this.et().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null);const b=this.et();if(!b)return;let Z=b.customRenderTargets.indexOf(this);Z>=0&&b.customRenderTargets.splice(Z,1);for(const J of b.cameras)Z=J.customRenderTargets.indexOf(this),Z>=0&&J.customRenderTargets.splice(Z,1);null===(t=this._renderTarget)||void 0===t||t.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this._objectRenderer._rebuild(),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._objectRenderer.freeRenderingGroups()}getViewCount(){return 1}}M.REFRESHRATE_RENDER_ONCE=r.REFRESHRATE_RENDER_ONCE,M.REFRESHRATE_RENDER_ONEVERYFRAME=r.REFRESHRATE_RENDER_ONEVERYFRAME,M.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=r.REFRESHRATE_RENDER_ONEVERYTWOFRAMES,P.c._CreateRenderTargetTexture=(t,b,Z,J,S)=>new M(t,b,Z,J)},12892:(t,b,Z)=>{function J(t){return 13===t||14===t||15===t||16===t||17===t||18===t||19===t}function S(t){return 13===t||17===t||18===t||19===t}Z.d(b,{d:()=>S,g:()=>J})},12873:(t,b,Z)=>{function J(t){return void 0===t.getPipelineContext}Z.d(b,{e:()=>J})},12838:(t,b,Z)=>{Z.d(b,{b:()=>Y,d:()=>g});var J=Z(12800),S=Z(12846),P=Z(12551),v=Z(12632),h=Z(12848);Z(12854);const C={jt:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class Y{constructor(t){let b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:C;this._fullscreenViewport=new S.b(0,0,1,1);const Z=b.jt??C.jt,P=b.indices??C.indices;this.ZZ=t,this._vertexBuffers={[J.g.PositionKind]:new J.g(t,Z,J.g.PositionKind,!1,!1,2)},this._indexBuffer=t.createIndexBuffer(P),this._indexBufferLength=P.length,this._onContextRestoredObserver=t.onContextRestoredObservable.add((()=>{this._indexBuffer=t.createIndexBuffer(P);for(const t in this._vertexBuffers){this._vertexBuffers[t]._rebuild()}}))}setViewport(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._fullscreenViewport;this.ZZ.setViewport(t)}bindBuffers(t){this.ZZ.bindBuffers(this._vertexBuffers,this._indexBuffer,t)}applyEffectWrapper(t){this.ZZ.setState(!0),this.ZZ.depthCullingState.depthTest=!1,this.ZZ.stencilState.stencilTest=!1,this.ZZ.enableEffect(t.drawWrapper),this.bindBuffers(t.effect),t.onApplyObservable.notifyObservers({})}saveStates(){this._savedStateDepthTest=this.ZZ.depthCullingState.depthTest,this._savedStateStencilTest=this.ZZ.stencilState.stencilTest}restoreStates(){this.ZZ.depthCullingState.depthTest=this._savedStateDepthTest,this.ZZ.stencilState.stencilTest=this._savedStateStencilTest}draw(){this.ZZ.drawElementsType(0,0,this._indexBufferLength)}_isRenderTargetTexture(t){return void 0!==t.renderTarget}render(t){let b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!t.effect.isReady())return;this.saveStates(),this.setViewport();const Z=null===b?null:this._isRenderTargetTexture(b)?b.renderTarget:b;Z&&this.ZZ.bindFramebuffer(Z),this.applyEffectWrapper(t),this.draw(),Z&&this.ZZ.unBindFramebuffer(Z),this.restoreStates()}dispose(){const t=this._vertexBuffers[J.g.PositionKind];t&&(t.dispose(),delete this._vertexBuffers[J.g.PositionKind]),this._indexBuffer&&this.ZZ._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.ZZ.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}}class g{static RegisterShaderCodeProcessing(t,b){b?g._CustomShaderCodeProcessing[t??""]=b:delete g._CustomShaderCodeProcessing[t??""]}static _GetShaderCodeProcessing(t){return g._CustomShaderCodeProcessing[t]??g._CustomShaderCodeProcessing[""]}get name(){return this.options.name}set name(t){this.options.name=t}isReady(){var t;return(null===(t=this._drawWrapper.effect)||void 0===t?void 0:t.isReady())??!1}get drawWrapper(){return this._drawWrapper}get effect(){return this._drawWrapper.effect}set effect(t){this._drawWrapper.effect=t}constructor(t){this.alphaMode=0,this.onEffectCreatedObservable=new P.d(void 0,!0),this.onApplyObservable=new P.d,this._shadersLoaded=!1,this._webGPUReady=!1,this._importPromises=[],this.options={...t,name:t.name||"effectWrapper",ZZ:t.ZZ,uniforms:t.uniforms||t.uniformNames||[],uniformNames:void 0,samplers:t.samplers||t.samplerNames||[],samplerNames:void 0,attributeNames:t.attributeNames||["position"],uniformBuffers:t.uniformBuffers||[],defines:t.defines||"",useShaderStore:t.useShaderStore||!1,vertexUrl:t.vertexUrl||t.vertexShader||"postprocess",vertexShader:void 0,fragmentShader:t.fragmentShader||"pass",indexParameters:t.indexParameters,blockCompilation:t.blockCompilation||!1,shaderLanguage:t.shaderLanguage||0,onCompiled:t.onCompiled||void 0,extraInitializations:t.extraInitializations||void 0,extraInitializationsAsync:t.extraInitializationsAsync||void 0,useAsPostProcess:t.useAsPostProcess??!1},this.options.uniformNames=this.options.uniforms,this.options.samplerNames=this.options.samplers,this.options.vertexShader=this.options.vertexUrl,this.options.useAsPostProcess&&(-1===this.options.samplers.indexOf("textureSampler")&&this.options.samplers.push("textureSampler"),-1===this.options.uniforms.indexOf("scale")&&this.options.uniforms.push("scale")),t.vertexUrl||t.vertexShader?this._shaderPath={vertexSource:this.options.vertexShader}:(this.options.useAsPostProcess||(this.options.uniforms.push("scale"),this.onApplyObservable.add((()=>{this.effect.setFloat2("scale",1,1)}))),this._shaderPath={vertex:this.options.vertexShader}),this._shaderPath.fragmentSource=this.options.fragmentShader,this._shaderPath.spectorName=this.options.name,this.options.useShaderStore&&(this._shaderPath.fragment=this._shaderPath.fragmentSource,this._shaderPath.vertex||(this._shaderPath.vertex=this._shaderPath.vertexSource),delete this._shaderPath.fragmentSource,delete this._shaderPath.vertexSource),this.onApplyObservable.add((()=>{this.bind()})),this.options.useShaderStore||(this._onContextRestoredObserver=this.options.ZZ.onContextRestoredObservable.add((()=>{this.effect._pipelineContext=null,this.effect._prepareEffect()}))),this._drawWrapper=new h.e(this.options.ZZ),this._webGPUReady=1===this.options.shaderLanguage;const b=Array.isArray(this.options.defines)?this.options.defines.join("\n"):this.options.defines;this._postConstructor(this.options.blockCompilation,b,this.options.extraInitializations)}_gatherImports(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],b=arguments.length>1?arguments[1]:void 0;this.options.useAsPostProcess&&(t&&this._webGPUReady?b.push(Promise.all([Z.e(53).then(Z.bind(Z,15214))])):b.push(Promise.all([Promise.resolve().then(Z.bind(Z,12854))])))}_postConstructor(t){let b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,Z=arguments.length>2?arguments[2]:void 0,J=arguments.length>3?arguments[3]:void 0;this._importPromises.length=0,J&&this._importPromises.push(...J);const S=this.options.ZZ.isWebGPU&&!g.ForceGLSL;this._gatherImports(S,this._importPromises),void 0!==Z&&Z(S,this._importPromises),S&&this._webGPUReady&&(this.options.shaderLanguage=1),t||this.updateEffect(b)}updateEffect(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,Z=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,J=arguments.length>3?arguments[3]:void 0,S=arguments.length>4?arguments[4]:void 0,P=arguments.length>5?arguments[5]:void 0,h=arguments.length>6?arguments[6]:void 0,C=arguments.length>7?arguments[7]:void 0;const Y=g._GetShaderCodeProcessing(this.name);if(null!==Y&&void 0!==Y&&Y.defineCustomBindings){var I,r;const J=(null===(I=b)||void 0===I?void 0:I.slice())??[];J.push(...this.options.uniforms);const S=(null===(r=Z)||void 0===r?void 0:r.slice())??[];S.push(...this.options.samplers),t=Y.defineCustomBindings(this.name,t,J,S),b=J,Z=S}this.options.defines=t||"";const M=this._shadersLoaded||0===this._importPromises.length?void 0:async()=>{await Promise.all(this._importPromises),this._shadersLoaded=!0};let T;T=this.options.extraInitializationsAsync?async()=>{null===M||void 0===M||M(),await this.options.extraInitializationsAsync()}:M,this.options.useShaderStore?this._drawWrapper.effect=this.options.ZZ.createEffect({vertex:h??this._shaderPath.vertex,fragment:C??this._shaderPath.fragment},{attributes:this.options.attributeNames,uniformsNames:b||this.options.uniforms,uniformBuffersNames:this.options.uniformBuffers,samplers:Z||this.options.samplers,defines:null!==t?t:"",fallbacks:null,onCompiled:S??this.options.onCompiled,onError:P??null,indexParameters:J||this.options.indexParameters,processCodeAfterIncludes:null!==Y&&void 0!==Y&&Y.processCodeAfterIncludes?(t,b)=>Y.processCodeAfterIncludes(this.name,t,b):null,processFinalCode:null!==Y&&void 0!==Y&&Y.processFinalCode?(t,b)=>Y.processFinalCode(this.name,t,b):null,shaderLanguage:this.options.shaderLanguage,extraInitializationsAsync:T},this.options.ZZ):this._drawWrapper.effect=new v.Effect(this._shaderPath,this.options.attributeNames,b||this.options.uniforms,Z||this.options.samplerNames,this.options.ZZ,t,void 0,S||this.options.onCompiled,void 0,void 0,void 0,this.options.shaderLanguage,T),this.onEffectCreatedObservable.notifyObservers(this._drawWrapper.effect)}bind(){var t,b;let Z=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.options.useAsPostProcess&&!Z&&(this.options.ZZ.setAlphaMode(this.alphaMode),this.drawWrapper.effect.setFloat2("scale",1,1)),null===(t=g._GetShaderCodeProcessing(this.name))||void 0===t||null===(b=t.bindCustomBindings)||void 0===b||b.call(t,this.name,this._drawWrapper.effect)}dispose(){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.onEffectCreatedObservable.clear(),this._drawWrapper.dispose(!0)}}g.ForceGLSL=!1,g._CustomShaderCodeProcessing={}},12936:(t,b,Z)=>{Z.d(b,{e:()=>v});var J,S,P=Z(12735);!function(t){t[t.LOCAL=0]="LOCAL",t[t.WORLD=1]="WORLD",t[t.BONE=2]="BONE"}(J||(J={}));class v{}v.X=new P.JZ(1,0,0),v.Y=new P.JZ(0,1,0),v.Z=new P.JZ(0,0,1),function(t){t[t.X=0]="X",t[t.Y=1]="Y",t[t.Z=2]="Z"}(S||(S={}))},12928:(t,b,Z)=>{Z.d(b,{b:()=>J.Matrix,c:()=>J.Quaternion,g:()=>J.TmpVectors,k:()=>J.JZ});Z(12936),Z(12775),Z(12737),Z(12939),Z(12944),Z(12778),Z(12757);var J=Z(12735);Z(12846)},12944:(t,b,Z)=>{Z.d(b,{b:()=>h,c:()=>r,d:()=>g,h:()=>I});var J,S=Z(12745),P=Z(12735),v=Z(12737);!function(t){t[t.CW=0]="CW",t[t.CCW=1]="CCW"}(J||(J={}));class h{static Interpolate(t,b,Z,J,S){if(0===t)return 0;const P=1-3*J+3*b,v=3*J-6*b,h=3*b;let C=t;for(let Y=0;Y<5;Y++){const b=C*C;C-=(P*(b*C)+v*b+h*C-t)*(1/(3*P*b+2*v*C+h)),C=Math.min(1,Math.max(0,C))}return 3*Math.pow(1-C,2)*C*Z+3*(1-C)*Math.pow(C,2)*S+Math.pow(C,3)}}class C{constructor(t){this._radians=t,this._radians<0&&(this._radians+=2*Math.PI)}degrees(){return 180*this._radians/Math.PI}radians(){return this._radians}static BetweenTwoPoints(t,b){const Z=b.SZ(t),J=Math.atan2(Z.y,Z.x);return new C(J)}static BetweenTwoVectors(t,b){let Z=t.lengthSquared()*b.lengthSquared();if(0===Z)return new C(Math.PI/2);Z=Math.sqrt(Z);let J=t.dot(b)/Z;J=(0,S.Clamp)(J,-1,1);const P=Math.acos(J);return new C(P)}static FromRadians(t){return new C(t)}static FromDegrees(t){return new C(t*Math.PI/180)}}class Y{constructor(t,b,Z){this.startPoint=t,this.midPoint=b,this.endPoint=Z;const J=Math.pow(b.x,2)+Math.pow(b.y,2),S=(Math.pow(t.x,2)+Math.pow(t.y,2)-J)/2,v=(J-Math.pow(Z.x,2)-Math.pow(Z.y,2))/2,h=(t.x-b.x)*(b.y-Z.y)-(b.x-Z.x)*(t.y-b.y);this.centerPoint=new P.Vector2((S*(b.y-Z.y)-v*(t.y-b.y))/h,((t.x-b.x)*v-(b.x-Z.x)*S)/h),this.radius=this.centerPoint.SZ(this.startPoint).length(),this.startAngle=C.BetweenTwoPoints(this.centerPoint,this.startPoint);const Y=this.startAngle.degrees();let g=C.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),I=C.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();g-Y>180&&(g-=360),g-Y<-180&&(g+=360),I-g>180&&(I-=360),I-g<-180&&(I+=360),this.orientation=g-Y<0?0:1,this.angle=C.FromDegrees(0===this.orientation?Y-I:I-Y)}}class g{constructor(t,b){this._points=new Array,this._length=0,this.closed=!1,this._points.push(new P.Vector2(t,b))}addLineTo(t,b){if(this.closed)return this;const Z=new P.Vector2(t,b),J=this._points[this._points.length-1];return this._points.push(Z),this._length+=Z.SZ(J).length(),this}addArcTo(t,b,Z,J){let S=arguments.length>4&&void 0!==arguments[4]?arguments[4]:36;if(this.closed)return this;const v=this._points[this._points.length-1],h=new P.Vector2(t,b),C=new P.Vector2(Z,J),g=new Y(v,h,C);let I=g.angle.radians()/S;0===g.orientation&&(I*=-1);let r=g.startAngle.radians()+I;for(let P=0;P<S;P++){const t=Math.cos(r)*g.radius+g.centerPoint.x,b=Math.sin(r)*g.radius+g.centerPoint.y;this.addLineTo(t,b),r+=I}return this}addQuadraticCurveTo(t,b,Z,J){let S=arguments.length>4&&void 0!==arguments[4]?arguments[4]:36;if(this.closed)return this;const P=(t,b,Z,J)=>(1-t)*(1-t)*b+2*t*(1-t)*Z+t*t*J,v=this._points[this._points.length-1];for(let h=0;h<=S;h++){const C=h/S,Y=P(C,v.x,t,Z),g=P(C,v.y,b,J);this.addLineTo(Y,g)}return this}addBezierCurveTo(t,b,Z,J,S,P){let v=arguments.length>6&&void 0!==arguments[6]?arguments[6]:36;if(this.closed)return this;const h=(t,b,Z,J,S)=>(1-t)*(1-t)*(1-t)*b+3*t*(1-t)*(1-t)*Z+3*t*t*(1-t)*J+t*t*t*S,C=this._points[this._points.length-1];for(let Y=0;Y<=v;Y++){const g=Y/v,I=h(g,C.x,t,Z,S),r=h(g,C.y,b,J,P);this.addLineTo(I,r)}return this}isPointInside(t){let b=!1;const Z=this._points.length;for(let J=Z-1,S=0;S<Z;J=S++){let Z=this._points[J],P=this._points[S],v=P.x-Z.x,h=P.y-Z.y;if(Math.abs(h)>Number.EPSILON){if(h<0&&(Z=this._points[S],v=-v,P=this._points[J],h=-h),t.y<Z.y||t.y>P.y)continue;if(t.y===Z.y&&t.x===Z.x)return!0;{const J=h*(t.x-Z.x)-v*(t.y-Z.y);if(0===J)return!0;if(J<0)continue;b=!b}}else{if(t.y!==Z.y)continue;if(P.x<=t.x&&t.x<=Z.x||Z.x<=t.x&&t.x<=P.x)return!0}}return b}close(){return this.closed=!0,this}length(){let t=this._length;if(this.closed){const b=this._points[this._points.length-1];t+=this._points[0].SZ(b).length()}return t}area(){const t=this._points.length;let b=0;for(let Z=t-1,J=0;J<t;Z=J++)b+=this._points[Z].x*this._points[J].y-this._points[J].x*this._points[Z].y;return.5*b}getPoints(){return this._points}getPointAtLengthPosition(t){if(t<0||t>1)return P.Vector2.Zero();const b=t*this.length();let Z=0;for(let J=0;J<this._points.length;J++){const t=(J+1)%this._points.length,S=this._points[J],v=this._points[t].SZ(S),h=v.length()+Z;if(b>=Z&&b<=h){const t=v.normalize(),J=b-Z;return new P.Vector2(S.x+t.x*J,S.y+t.y*J)}Z=h}return P.Vector2.Zero()}static StartingAt(t,b){return new g(t,b)}}class I{constructor(t){let b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,Z=arguments.length>2?arguments[2]:void 0,J=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.path=t,this._curve=new Array,this._distances=new Array,this._tangents=new Array,this._normals=new Array,this._binormals=new Array,this._pointAtData={id:0,point:P.JZ.Zero(),previousPointArrayIndex:0,position:0,subPosition:0,interpolateReady:!1,interpolationMatrix:P.Matrix.Identity()};for(let S=0;S<t.length;S++)this._curve[S]=t[S].clone();this._raw=Z||!1,this._alignTangentsWithPath=J,this._compute(b,J)}getCurve(){return this._curve}getPoints(){return this._curve}length(){return this._distances[this._distances.length-1]}getTangents(){return this._tangents}getNormals(){return this._normals}getBinormals(){return this._binormals}getDistances(){return this._distances}getPointAt(t){return this._updatePointAtData(t).point}getTangentAt(t){let b=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(t,b),b?P.JZ.TransformCoordinates(P.JZ.Forward(),this._pointAtData.interpolationMatrix):this._tangents[this._pointAtData.previousPointArrayIndex]}getNormalAt(t){let b=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(t,b),b?P.JZ.TransformCoordinates(P.JZ.Right(),this._pointAtData.interpolationMatrix):this._normals[this._pointAtData.previousPointArrayIndex]}getBinormalAt(t){let b=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(t,b),b?P.JZ.TransformCoordinates(P.JZ.UpReadOnly,this._pointAtData.interpolationMatrix):this._binormals[this._pointAtData.previousPointArrayIndex]}getDistanceAt(t){return this.length()*t}getPreviousPointIndexAt(t){return this._updatePointAtData(t),this._pointAtData.previousPointArrayIndex}getSubPositionAt(t){return this._updatePointAtData(t),this._pointAtData.subPosition}getClosestPositionTo(t){let b=Number.MAX_VALUE,Z=0;for(let J=0;J<this._curve.length-1;J++){const S=this._curve[J+0],v=this._curve[J+1].SZ(S).normalize(),h=this._distances[J+1]-this._distances[J+0],C=Math.min(Math.max(P.JZ.Dot(v,t.SZ(S).normalize()),0)*P.JZ.Distance(S,t)/h,1),Y=P.JZ.Distance(S.add(v.scale(C*h)),t);Y<b&&(b=Y,Z=(this._distances[J+0]+h*C)/this.length())}return Z}slice(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(t<0&&(t=1- -1*t%1),b<0&&(b=1- -1*b%1),t>b){const Z=t;t=b,b=Z}const Z=this.getCurve(),J=this.getPointAt(t);let S=this.getPreviousPointIndexAt(t);const P=this.getPointAt(b),v=this.getPreviousPointIndexAt(b)+1,h=[];return 0!==t&&(S++,h.push(J)),h.push(...Z.slice(S,v)),1===b&&1!==t||h.push(P),new I(h,this.getNormalAt(t),this._raw,this._alignTangentsWithPath)}update(t){let b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,Z=arguments.length>2&&void 0!==arguments[2]&&arguments[2];for(let J=0;J<t.length;J++)this._curve[J].x=t[J].x,this._curve[J].y=t[J].y,this._curve[J].z=t[J].z;return this._compute(b,Z),this}_compute(t){let b=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const Z=this._curve.length;if(Z<2)return;this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[Z-1]=this._curve[Z-1].SZ(this._curve[Z-2]),this._raw||this._tangents[Z-1].normalize();const J=this._tangents[0],S=this._normalVector(J,t);let v,h,C,Y,g;this._normals[0]=S,this._raw||this._normals[0].normalize(),this._binormals[0]=P.JZ.Cross(J,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;for(let I=1;I<Z;I++)v=this._getLastNonNullVector(I),I<Z-1&&(h=this._getFirstNonNullVector(I),this._tangents[I]=b?h:v.add(h),this._tangents[I].normalize()),this._distances[I]=this._distances[I-1]+this._curve[I].SZ(this._curve[I-1]).length(),C=this._tangents[I],g=this._binormals[I-1],this._normals[I]=P.JZ.Cross(g,C),this._raw||(0===this._normals[I].length()?(Y=this._normals[I-1],this._normals[I]=Y.clone()):this._normals[I].normalize()),this._binormals[I]=P.JZ.Cross(C,this._normals[I]),this._raw||this._binormals[I].normalize();this._pointAtData.id=NaN}_getFirstNonNullVector(t){let b=1,Z=this._curve[t+b].SZ(this._curve[t]);for(;0===Z.length()&&t+b+1<this._curve.length;)b++,Z=this._curve[t+b].SZ(this._curve[t]);return Z}_getLastNonNullVector(t){let b=1,Z=this._curve[t].SZ(this._curve[t-b]);for(;0===Z.length()&&t>b+1;)b++,Z=this._curve[t].SZ(this._curve[t-b]);return Z}_normalVector(t,b){let Z,J=t.length();if(0===J&&(J=1),void 0===b||null===b){let b;b=(0,S.WithinEpsilon)(Math.abs(t.y)/J,1,v.e)?(0,S.WithinEpsilon)(Math.abs(t.x)/J,1,v.e)?(0,S.WithinEpsilon)(Math.abs(t.z)/J,1,v.e)?P.JZ.Zero():new P.JZ(0,0,1):new P.JZ(1,0,0):new P.JZ(0,-1,0),Z=P.JZ.Cross(t,b)}else Z=P.JZ.Cross(t,b),P.JZ.CrossToRef(Z,t,Z);return Z.normalize(),Z}_updatePointAtData(t){let b=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._pointAtData.id===t)return this._pointAtData.interpolateReady||this._updateInterpolationMatrix(),this._pointAtData;this._pointAtData.id=t;const Z=this.getPoints();if(t<=0)return this._setPointAtData(0,0,Z[0],0,b);if(t>=1)return this._setPointAtData(1,1,Z[Z.length-1],Z.length-1,b);let J,S=Z[0],v=0;const h=t*this.length();for(let C=1;C<Z.length;C++){J=Z[C];const Y=P.JZ.Distance(S,J);if(v+=Y,v===h)return this._setPointAtData(t,1,J,C,b);if(v>h){const Z=(v-h)/Y,P=S.SZ(J),g=J.add(P.scaleInPlace(Z));return this._setPointAtData(t,1-Z,g,C-1,b)}S=J}return this._pointAtData}_setPointAtData(t,b,Z,J,S){return this._pointAtData.point=Z,this._pointAtData.position=t,this._pointAtData.subPosition=b,this._pointAtData.previousPointArrayIndex=J,this._pointAtData.interpolateReady=S,S&&this._updateInterpolationMatrix(),this._pointAtData}_updateInterpolationMatrix(){this._pointAtData.interpolationMatrix=P.Matrix.Identity();const t=this._pointAtData.previousPointArrayIndex;if(t!==this._tangents.length-1){const b=t+1,Z=this._tangents[t].clone(),J=this._normals[t].clone(),S=this._binormals[t].clone(),v=this._tangents[b].clone(),h=this._normals[b].clone(),C=this._binormals[b].clone(),Y=P.Quaternion.RotationQuaternionFromAxis(J,S,Z),g=P.Quaternion.RotationQuaternionFromAxis(h,C,v);P.Quaternion.Slerp(Y,g,this._pointAtData.subPosition).toRotationMatrix(this._pointAtData.interpolationMatrix)}}}class r{static CreateQuadraticBezier(t,b,Z,J){J=J>2?J:3;const S=[],v=(t,b,Z,J)=>(1-t)*(1-t)*b+2*t*(1-t)*Z+t*t*J;for(let h=0;h<=J;h++)S.push(new P.JZ(v(h/J,t.x,b.x,Z.x),v(h/J,t.y,b.y,Z.y),v(h/J,t.z,b.z,Z.z)));return new r(S)}static CreateCubicBezier(t,b,Z,J,S){S=S>3?S:4;const v=[],h=(t,b,Z,J,S)=>(1-t)*(1-t)*(1-t)*b+3*t*(1-t)*(1-t)*Z+3*t*t*(1-t)*J+t*t*t*S;for(let C=0;C<=S;C++)v.push(new P.JZ(h(C/S,t.x,b.x,Z.x,J.x),h(C/S,t.y,b.y,Z.y,J.y),h(C/S,t.z,b.z,Z.z,J.z)));return new r(v)}static CreateHermiteSpline(t,b,Z,J,S){const v=[],h=1/S;for(let C=0;C<=S;C++)v.push(P.JZ.Hermite(t,b,Z,J,C*h));return new r(v)}static CreateCatmullRomSpline(t,b,Z){const J=[],S=1/b;let v=0;if(Z){const Z=t.length;for(let h=0;h<Z;h++){v=0;for(let C=0;C<b;C++)J.push(P.JZ.CatmullRom(t[h%Z],t[(h+1)%Z],t[(h+2)%Z],t[(h+3)%Z],v)),v+=S}J.push(J[0])}else{const Z=[];Z.push(t[0].clone()),Array.prototype.push.apply(Z,t),Z.push(t[t.length-1].clone());let h=0;for(;h<Z.length-3;h++){v=0;for(let t=0;t<b;t++)J.push(P.JZ.CatmullRom(Z[h],Z[h+1],Z[h+2],Z[h+3],v)),v+=S}h--,J.push(P.JZ.CatmullRom(Z[h],Z[h+1],Z[h+2],Z[h+3],v))}return new r(J)}static ArcThru3Points(t,b,Z){let J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:32,S=arguments.length>4&&void 0!==arguments[4]&&arguments[4],v=arguments.length>5&&void 0!==arguments[5]&&arguments[5];const h=[],C=b.SZ(t),Y=Z.SZ(b),g=t.SZ(Z),I=P.JZ.Cross(C,Y),M=I.length();if(M<Math.pow(10,-8))return new r(h);const T=C.lengthSquared(),a=Y.lengthSquared(),k=g.lengthSquared(),u=I.lengthSquared(),l=.5*C.length()*Y.length()*g.length()/M,U=-.5*a*P.JZ.Dot(C,g)/u,E=-.5*k*P.JZ.Dot(C,Y)/u,c=-.5*T*P.JZ.Dot(Y,g)/u,H=t.scale(U).add(b.scale(E)).add(Z.scale(c)),o=t.SZ(H).normalize(),O=P.JZ.Cross(I,o).normalize();if(v){const b=2*Math.PI/J;for(let t=0;t<=2*Math.PI;t+=b)h.push(H.add(o.scale(l*Math.cos(t)).add(O.scale(l*Math.sin(t)))));h.push(t)}else{const b=1/J;let v=0,C=P.JZ.Zero();do{C=H.add(o.scale(l*Math.cos(v)).add(O.scale(l*Math.sin(v)))),h.push(C),v+=b}while(!C.equalsWithEpsilon(Z,l*b*1.1));h.push(Z),S&&h.push(t)}return new r(h)}constructor(t){this._length=0,this._points=t,this._length=this._computeLength(t)}getPoints(){return this._points}length(){return this._length}continue(t){const b=this._points[this._points.length-1],Z=this._points.slice(),J=t.getPoints();for(let S=1;S<J.length;S++)Z.push(J[S].SZ(J[0]).add(b));return new r(Z)}_computeLength(t){let b=0;for(let Z=1;Z<t.length;Z++)b+=t[Z].SZ(t[Z-1]).length();return b}}},12846:(t,b,Z)=>{Z.d(b,{b:()=>J});class J{constructor(t,b,Z,J){this.x=t,this.y=b,this.width=Z,this.height=J}toGlobal(t,b){return new J(this.x*t,this.y*b,this.width*t,this.height*b)}toGlobalToRef(t,b,Z){return Z.x=this.x*t,Z.y=this.y*b,Z.width=this.width*t,Z.height=this.height*b,this}clone(){return new J(this.x,this.y,this.width,this.height)}}},12923:(t,b,Z)=>{Z.d(b,{e:()=>Y,f:()=>g});var J=Z(12735),S=Z(12928);const P=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],v=[()=>1,t=>t.y,t=>t.z,t=>t.x,t=>t.x*t.y,t=>t.y*t.z,t=>3*t.z*t.z-1,t=>t.x*t.z,t=>t.x*t.x-t.y*t.y],h=(t,b)=>P[t]*v[t](b),C=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4];class Y{constructor(){this.preScaled=!1,this.l00=J.JZ.Zero(),this.l1_1=J.JZ.Zero(),this.l10=J.JZ.Zero(),this.l11=J.JZ.Zero(),this.l2_2=J.JZ.Zero(),this.l2_1=J.JZ.Zero(),this.l20=J.JZ.Zero(),this.l21=J.JZ.Zero(),this.l22=J.JZ.Zero()}addLight(t,b,Z){S.g.JZ[0].set(b.r,b.g,b.b);const J=S.g.JZ[0],P=S.g.JZ[1];J.scaleToRef(Z,P),P.scaleToRef(h(0,t),S.g.JZ[2]),this.l00.addInPlace(S.g.JZ[2]),P.scaleToRef(h(1,t),S.g.JZ[2]),this.l1_1.addInPlace(S.g.JZ[2]),P.scaleToRef(h(2,t),S.g.JZ[2]),this.l10.addInPlace(S.g.JZ[2]),P.scaleToRef(h(3,t),S.g.JZ[2]),this.l11.addInPlace(S.g.JZ[2]),P.scaleToRef(h(4,t),S.g.JZ[2]),this.l2_2.addInPlace(S.g.JZ[2]),P.scaleToRef(h(5,t),S.g.JZ[2]),this.l2_1.addInPlace(S.g.JZ[2]),P.scaleToRef(h(6,t),S.g.JZ[2]),this.l20.addInPlace(S.g.JZ[2]),P.scaleToRef(h(7,t),S.g.JZ[2]),this.l21.addInPlace(S.g.JZ[2]),P.scaleToRef(h(8,t),S.g.JZ[2]),this.l22.addInPlace(S.g.JZ[2])}scaleInPlace(t){this.l00.scaleInPlace(t),this.l1_1.scaleInPlace(t),this.l10.scaleInPlace(t),this.l11.scaleInPlace(t),this.l2_2.scaleInPlace(t),this.l2_1.scaleInPlace(t),this.l20.scaleInPlace(t),this.l21.scaleInPlace(t),this.l22.scaleInPlace(t)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(C[0]),this.l1_1.scaleInPlace(C[1]),this.l10.scaleInPlace(C[2]),this.l11.scaleInPlace(C[3]),this.l2_2.scaleInPlace(C[4]),this.l2_1.scaleInPlace(C[5]),this.l20.scaleInPlace(C[6]),this.l21.scaleInPlace(C[7]),this.l22.scaleInPlace(C[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(P[0]),this.l1_1.scaleInPlace(P[1]),this.l10.scaleInPlace(P[2]),this.l11.scaleInPlace(P[3]),this.l2_2.scaleInPlace(P[4]),this.l2_1.scaleInPlace(P[5]),this.l20.scaleInPlace(P[6]),this.l21.scaleInPlace(P[7]),this.l22.scaleInPlace(P[8])}updateFromArray(t){return J.JZ.FromArrayToRef(t[0],0,this.l00),J.JZ.FromArrayToRef(t[1],0,this.l1_1),J.JZ.FromArrayToRef(t[2],0,this.l10),J.JZ.FromArrayToRef(t[3],0,this.l11),J.JZ.FromArrayToRef(t[4],0,this.l2_2),J.JZ.FromArrayToRef(t[5],0,this.l2_1),J.JZ.FromArrayToRef(t[6],0,this.l20),J.JZ.FromArrayToRef(t[7],0,this.l21),J.JZ.FromArrayToRef(t[8],0,this.l22),this}updateFromFloatsArray(t){return J.JZ.FromFloatsToRef(t[0],t[1],t[2],this.l00),J.JZ.FromFloatsToRef(t[3],t[4],t[5],this.l1_1),J.JZ.FromFloatsToRef(t[6],t[7],t[8],this.l10),J.JZ.FromFloatsToRef(t[9],t[10],t[11],this.l11),J.JZ.FromFloatsToRef(t[12],t[13],t[14],this.l2_2),J.JZ.FromFloatsToRef(t[15],t[16],t[17],this.l2_1),J.JZ.FromFloatsToRef(t[18],t[19],t[20],this.l20),J.JZ.FromFloatsToRef(t[21],t[22],t[23],this.l21),J.JZ.FromFloatsToRef(t[24],t[25],t[26],this.l22),this}static CZ(t){return(new Y).updateFromArray(t)}static FromPolynomial(t){const b=new Y;return b.l00=t.xx.scale(.376127).add(t.yy.scale(.376127)).add(t.zz.scale(.376126)),b.l1_1=t.y.scale(.977204),b.l10=t.z.scale(.977204),b.l11=t.x.scale(.977204),b.l2_2=t.xy.scale(1.16538),b.l2_1=t.yz.scale(1.16538),b.l20=t.zz.scale(1.34567).SZ(t.xx.scale(.672834)).SZ(t.yy.scale(.672834)),b.l21=t.zx.scale(1.16538),b.l22=t.xx.scale(1.16538).SZ(t.yy.scale(1.16538)),b.l1_1.scaleInPlace(-1),b.l11.scaleInPlace(-1),b.l2_1.scaleInPlace(-1),b.l21.scaleInPlace(-1),b.scaleInPlace(Math.PI),b}}class g{constructor(){this.x=J.JZ.Zero(),this.y=J.JZ.Zero(),this.z=J.JZ.Zero(),this.xx=J.JZ.Zero(),this.yy=J.JZ.Zero(),this.zz=J.JZ.Zero(),this.xy=J.JZ.Zero(),this.yz=J.JZ.Zero(),this.zx=J.JZ.Zero()}get preScaledHarmonics(){return this._harmonics||(this._harmonics=Y.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(t){S.g.JZ[0].Ab(t.r,t.g,t.b);const b=S.g.JZ[0];this.xx.addInPlace(b),this.yy.addInPlace(b),this.zz.addInPlace(b)}scaleInPlace(t){this.x.scaleInPlace(t),this.y.scaleInPlace(t),this.z.scaleInPlace(t),this.xx.scaleInPlace(t),this.yy.scaleInPlace(t),this.zz.scaleInPlace(t),this.yz.scaleInPlace(t),this.zx.scaleInPlace(t),this.xy.scaleInPlace(t)}updateFromHarmonics(t){return this._harmonics=t,this.x.S(t.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.S(t.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.S(t.l10),this.z.scaleInPlace(1.02333),this.xx.S(t.l00),S.g.JZ[0].S(t.l20).scaleInPlace(.247708),S.g.JZ[1].S(t.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).XI(S.g.JZ[0]).addInPlace(S.g.JZ[1]),this.yy.S(t.l00),this.yy.scaleInPlace(.886277).XI(S.g.JZ[0]).XI(S.g.JZ[1]),this.zz.S(t.l00),S.g.JZ[0].S(t.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(S.g.JZ[0]),this.yz.S(t.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.S(t.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.S(t.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(t){return(new g).updateFromHarmonics(t)}static CZ(t){const b=new g;return J.JZ.FromArrayToRef(t[0],0,b.x),J.JZ.FromArrayToRef(t[1],0,b.y),J.JZ.FromArrayToRef(t[2],0,b.z),J.JZ.FromArrayToRef(t[3],0,b.xx),J.JZ.FromArrayToRef(t[4],0,b.yy),J.JZ.FromArrayToRef(t[5],0,b.zz),J.JZ.FromArrayToRef(t[6],0,b.yz),J.JZ.FromArrayToRef(t[7],0,b.zx),J.JZ.FromArrayToRef(t[8],0,b.xy),b}}},12882:(t,b,Z)=>{Z.d(b,{d:()=>S});var J=Z(12805);class S extends J.d{constructor(t){super(),this._buffer=t}get underlyingResource(){return this._buffer}}},12964:(t,b,Z)=>{Z.d(b,{c:()=>u,f:()=>c,i:()=>o,j:()=>O,m:()=>E});var J=Z(12716),S=Z(12784),P=Z(12721),v=Z(12829),h=Z(12623),C=Z(12688),Y=Z(12760),g=Z(12838),I=Z(12860);class r extends g.d{_gatherImports(t,b){t?(this._webGPUReady=!0,b.push(Promise.all([Z.e(51).then(Z.bind(Z,15203))]))):b.push(Promise.all([Z.e(52).then(Z.bind(Z,15205))])),super._gatherImports(t,b)}constructor(t){super({...arguments.length>2?arguments[2]:void 0,name:t,ZZ:(arguments.length>1&&void 0!==arguments[1]?arguments[1]:null)||I.b.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:r.FragmentUrl})}}r.FragmentUrl="pass";class M extends g.d{_gatherImports(t,b){t?(this._webGPUReady=!0,b.push(Promise.all([Z.e(62).then(Z.bind(Z,15268))]))):b.push(Promise.all([Z.e(63).then(Z.bind(Z,15273))])),super._gatherImports(t,b)}constructor(t){super({...arguments.length>2?arguments[2]:void 0,name:t,ZZ:(arguments.length>1&&void 0!==arguments[1]?arguments[1]:null)||I.b.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:M.FragmentUrl,defines:"#define POSITIVEX"}),this._face=0}get face(){return this._face}set face(t){if(!(t<0||t>5))switch(this._face=t,this._face){case 0:this.updateEffect("#define POSITIVEX");break;case 1:this.updateEffect("#define NEGATIVEX");break;case 2:this.updateEffect("#define POSITIVEY");break;case 3:this.updateEffect("#define NEGATIVEY");break;case 4:this.updateEffect("#define POSITIVEZ");break;case 5:this.updateEffect("#define NEGATIVEZ")}}}M.FragmentUrl="passCube";var T=Z(12726);class a extends v.c{getClassName(){return"PassPostProcess"}constructor(t,b){let Z=arguments.length>4?arguments[4]:void 0;const J={size:"number"===typeof b?b:void 0,camera:arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,samplingMode:arguments.length>3?arguments[3]:void 0,ZZ:Z,reusable:arguments.length>5?arguments[5]:void 0,textureType:arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,blockCompilation:arguments.length>7&&void 0!==arguments[7]&&arguments[7],...b};super(t,r.FragmentUrl,{effectWrapper:"number"!==typeof b&&b.effectWrapper?void 0:new r(t,Z,J),...J})}static _Parse(t,b,Z,J){return Y.d.Parse((()=>new a(t.name,t.options,b,t.renderTargetSamplingMode,t._engine,t.reusable)),t,Z,J)}}(0,C.f)("BABYLON.PassPostProcess",a);class k extends v.c{get face(){return this._effectWrapper.face}set face(t){this._effectWrapper.face=t}getClassName(){return"PassCubePostProcess"}constructor(t,b){let Z=arguments.length>4?arguments[4]:void 0;const J={size:"number"===typeof b?b:void 0,camera:arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,samplingMode:arguments.length>3?arguments[3]:void 0,ZZ:Z,reusable:arguments.length>5?arguments[5]:void 0,textureType:arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,blockCompilation:arguments.length>7&&void 0!==arguments[7]&&arguments[7],...b};super(t,r.FragmentUrl,{effectWrapper:"number"!==typeof b&&b.effectWrapper?void 0:new M(t,Z,J),...J})}static _Parse(t,b,Z,J){return Y.d.Parse((()=>new k(t.name,t.options,b,t.renderTargetSamplingMode,t._engine,t.reusable)),t,Z,J)}}function u(t,b,Z,J,S,P,h,C){const Y=b.getEngine();return b.isReady=!1,S=S??b.samplingMode,J=J??b.type,P=P??b.format,h=h??b.width,C=C??b.height,-1===J&&(J=0),new Promise((g=>{const I=new v.c("postprocess",t,null,null,1,null,S,Y,!1,void 0,J,void 0,null,!1,P);I.externalTextureSamplerBinding=!0;const r=Y.createRenderTargetTexture({width:h,height:C},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:S,type:J,format:P});I.onEffectCreatedObservable.addOnce((t=>{t.executeWhenCompiled((()=>{I.onApply=t=>{t._bindTexture("textureSampler",b),t.setFloat2("scale",1,1)},Z.postProcessManager.directRender([I],r,!0),Y.restoreDefaultFramebuffer(),Y._releaseTexture(b),I&&I.dispose(),r._swapAndDie(b),b.type=J,b.format=5,b.isReady=!0,g(b)}))}))}))}let l,U;function E(t){l||(l=new Float32Array(1),U=new Int32Array(l.buffer)),l[0]=t;const b=U[0];let Z=b>>16&32768,J=b>>12&2047;const S=b>>23&255;return S<103?Z:S>142?(Z|=31744,Z|=(255==S?0:1)&&8388607&b,Z):S<113?(J|=2048,Z|=(J>>114-S)+(J>>113-S&1),Z):(Z|=S-112<<10|J>>1,Z+=1&J,Z)}function c(t){const b=(32768&t)>>15,Z=(31744&t)>>10,J=1023&t;return 0===Z?(b?-1:1)*Math.pow(2,-14)*(J/Math.pow(2,10)):31==Z?J?NaN:1/0*(b?-1:1):(b?-1:1)*Math.pow(2,Z-15)*(1+J/Math.pow(2,10))}(0,P.e)([(0,T.N)()],k.prototype,"face",null),h.e._RescalePostProcessFactory=t=>new a("rescale",1,null,2,t,!1,0);const H=async(t,b,P,h,C)=>{const Y=t.et(),g=Y.getEngine();let I;if(g.isWebGPU?t.isCube?await Z.e(60).then(Z.bind(Z,15250)):await Z.e(61).then(Z.bind(Z,15259)):t.isCube?await Z.e(58).then(Z.bind(Z,15240)):await Z.e(59).then(Z.bind(Z,15248)),t.isCube){const t=["#define POSITIVEX","#define NEGATIVEX","#define POSITIVEY","#define NEGATIVEY","#define POSITIVEZ","#define NEGATIVEZ"];I=new v.c("lodCube","lodCube",{uniforms:["lod","gamma"],samplingMode:J.c.NEAREST_NEAREST_MIPNEAREST,ZZ:g,defines:t[h],shaderLanguage:g.isWebGPU?1:0})}else I=new v.c("lod","lod",{uniforms:["lod","gamma"],samplingMode:J.c.NEAREST_NEAREST_MIPNEAREST,ZZ:g,shaderLanguage:g.isWebGPU?1:0});await new Promise((t=>{I.onEffectCreatedObservable.addOnce((b=>{b.executeWhenCompiled((()=>{t(0)}))}))}));const r=new S.b("temp",{width:b,height:P},Y,!1);I.onApply=function(b){b.setTexture("textureSampler",t),b.setFloat("lod",C),b.setInt("gamma",t.gammaSpace?1:0)};const M=t.getInternalTexture();try{if(r.renderTarget&&M){const Z=M.samplingMode;0!==C?t.updateSamplingMode(J.c.NEAREST_NEAREST_MIPNEAREST):t.updateSamplingMode(J.c.NEAREST_NEAREST),Y.postProcessManager.directRender([I],r.renderTarget,!0),t.updateSamplingMode(Z);const S=await g.readPixels(0,0,b,P),v=new Uint8Array(S.buffer,0,S.byteLength);return g.unBindFramebuffer(r.renderTarget),v}throw Error("Render to texture failed.")}finally{r.dispose(),I.dispose()}};async function o(t,b,Z){let J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,S=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;return!t.isReady()&&t._texture&&await new Promise(((b,Z)=>{null!==t._texture?t._texture.onLoadedObservable.addOnce((()=>{b(0)})):Z(0)})),await H(t,b,Z,J,S)}const O={CreateResizedCopy:function(t,b,Z){let P=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const v=t.et(),h=v.getEngine(),C=new S.b("resized"+t.name,{width:b,height:Z},v,!t.noMipmap,!0,t._texture.type,!1,t.samplingMode,!1);C.wrapU=t.wrapU,C.wrapV=t.wrapV,C.uOffset=t.uOffset,C.vOffset=t.vOffset,C.uScale=t.uScale,C.vScale=t.vScale,C.uAng=t.uAng,C.vAng=t.vAng,C.wAng=t.wAng,C.coordinatesIndex=t.coordinatesIndex,C.level=t.level,C.anisotropicFilteringLevel=t.anisotropicFilteringLevel,C._texture.isReady=!1,t.wrapU=J.c.CLAMP_ADDRESSMODE,t.wrapV=J.c.CLAMP_ADDRESSMODE;const Y=new a("pass",1,null,P?J.c.BILINEAR_SAMPLINGMODE:J.c.NEAREST_SAMPLINGMODE,h,!1,0);return Y.externalTextureSamplerBinding=!0,Y.onEffectCreatedObservable.addOnce((b=>{b.executeWhenCompiled((()=>{Y.onApply=function(b){b.setTexture("textureSampler",t)};const b=C.renderTarget;b&&(v.postProcessManager.directRender([Y],b),h.unBindFramebuffer(b),C.disposeFramebufferObjects(),Y.dispose(),C.getInternalTexture().isReady=!0)}))})),C},ApplyPostProcess:u,ToHalfFloat:E,FromHalfFloat:c,GetTextureDataAsync:o}},12829:(t,b,Z)=>{Z.d(b,{c:()=>T});var J=Z(12721),S=Z(12826),P=Z(12551),v=Z(12735),h=Z(12632),C=Z(12726),Y=Z(12760),g=Z(12688),I=Z(12623),r=Z(12702),M=Z(12838);I.e.prototype.setTextureFromPostProcess=function(t,b,Z){var J;let S=null;b&&(b._forcedOutputTexture?S=b._forcedOutputTexture:b._textures.data[b._currentRenderTextureInd]&&(S=b._textures.data[b._currentRenderTextureInd])),this._bindTexture(t,(null===(J=S)||void 0===J?void 0:J.texture)??null,Z)},I.e.prototype.setTextureFromPostProcessOutput=function(t,b,Z){var J;this._bindTexture(t,(null===b||void 0===b||null===(J=b._outputTexture)||void 0===J?void 0:J.texture)??null,Z)},h.Effect.prototype.setTextureFromPostProcess=function(t,b){this._engine.setTextureFromPostProcess(this._samplers[t],b,t)},h.Effect.prototype.setTextureFromPostProcessOutput=function(t,b){this._engine.setTextureFromPostProcessOutput(this._samplers[t],b,t)};class T{static get ForceGLSL(){return M.d.ForceGLSL}static set ForceGLSL(t){M.d.ForceGLSL=t}static RegisterShaderCodeProcessing(t,b){M.d.RegisterShaderCodeProcessing(t,b)}get name(){return this._effectWrapper.name}set name(t){this._effectWrapper.name=t}get alphaMode(){return this._effectWrapper.alphaMode}set alphaMode(t){this._effectWrapper.alphaMode=t}get samples(){return this._samples}set samples(t){this._samples=Math.min(t,this._engine.getCaps().maxMSAASamples),this._textures.forEach((t=>{t.setSamples(this._samples)}))}get shaderLanguage(){return this._shaderLanguage}getEffectName(){return this._fragmentUrl}set onActivate(t){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),t&&(this._onActivateObserver=this.onActivateObservable.add(t))}set onSizeChanged(t){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(t)}set onApply(t){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(t)}set onBeforeRender(t){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(t)}set onAfterRender(t){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(t)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(t){this._forcedOutputTexture=t}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.Ab(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(t,b,Z,J,h,C){var Y;let g=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,I=arguments.length>7?arguments[7]:void 0,r=arguments.length>8?arguments[8]:void 0,a=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,k=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0,u=arguments.length>11&&void 0!==arguments[11]?arguments[11]:"postprocess",l=arguments.length>12?arguments[12]:void 0,U=arguments.length>13&&void 0!==arguments[13]&&arguments[13],E=arguments.length>14&&void 0!==arguments[14]?arguments[14]:5,c=arguments.length>15?arguments[15]:void 0,H=arguments.length>16?arguments[16]:void 0;this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.eb=!0,this.forceAutoClearInAlphaMode=!1,this.animations=[],this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._webGPUReady=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new S.h(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new v.Vector2(1,1),this._texelSize=v.Vector2.Zero(),this.onActivateObservable=new P.d,this.onSizeChangedObservable=new P.d,this.onApplyObservable=new P.d,this.onBeforeRenderObservable=new P.d,this.onAfterRenderObservable=new P.d,this.lb=new P.d;let o,O=1,p=null;if(Z&&!Array.isArray(Z)){const t=Z;Z=t.uniforms??null,J=t.samplers??null,O=t.size??1,C=t.camera??null,g=t.samplingMode??1,I=t.ZZ,r=t.reusable,a=Array.isArray(t.defines)?t.defines.join("\n"):t.defines??null,k=t.textureType??0,u=t.vertexUrl??"postprocess",l=t.indexParameters,U=t.blockCompilation??!1,E=t.textureFormat??5,c=t.shaderLanguage??0,p=t.uniformBuffers??null,H=t.extraInitializations,o=t.effectWrapper}else h&&(O="number"===typeof h?h:{width:h.width,height:h.height});if(this._useExistingThinPostProcess=!!o,this._effectWrapper=o??new M.d({name:t,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:b,ZZ:I||(null===(Y=C)||void 0===Y?void 0:Y.et().getEngine()),uniforms:Z,samplers:J,uniformBuffers:p,defines:a,vertexUrl:u,indexParameters:l,blockCompilation:!0,shaderLanguage:c,extraInitializations:void 0}),this.name=t,this.onEffectCreatedObservable=this._effectWrapper.onEffectCreatedObservable,null!=C?(this._camera=C,this._scene=C.et(),C.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):I&&(this._engine=I,this._engine.postProcesses.push(this)),this._options=O,this.renderTargetSamplingMode=g||1,this._reusable=r||!1,this._textureType=k,this._textureFormat=E,this._shaderLanguage=c||0,this._samplers=J||[],-1===this._samplers.indexOf("textureSampler")&&this._samplers.push("textureSampler"),this._fragmentUrl=b,this._vertexUrl=u,this._parameters=Z||[],-1===this._parameters.indexOf("scale")&&this._parameters.push("scale"),this._uniformBuffers=p||[],this._indexParameters=l,!this._useExistingThinPostProcess){this._webGPUReady=1===this._shaderLanguage;const t=[];this._gatherImports(this._engine.isWebGPU&&!T.ForceGLSL,t),this._effectWrapper._webGPUReady=this._webGPUReady,this._effectWrapper._postConstructor(U,a,H,t)}}_gatherImports(){let t=arguments.length>1?arguments[1]:void 0;arguments.length>0&&void 0!==arguments[0]&&arguments[0]&&this._webGPUReady?t.push(Promise.all([Z.e(53).then(Z.bind(Z,15214))])):t.push(Promise.all([Promise.resolve().then(Z.bind(Z,12854))]))}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._effectWrapper.drawWrapper.effect}shareOutputWith(t){return this._disposeTextures(),this._shareOutputWithPostProcess=t,this}useOwnOutput(){0==this._textures.length&&(this._textures=new S.h(2)),this._shareOutputWithPostProcess=null}updateEffect(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,Z=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,J=arguments.length>3?arguments[3]:void 0,S=arguments.length>4?arguments[4]:void 0,P=arguments.length>5?arguments[5]:void 0,v=arguments.length>6?arguments[6]:void 0,h=arguments.length>7?arguments[7]:void 0;this._effectWrapper.updateEffect(t,b,Z,J,S,P,v,h),this._postProcessDefines=Array.isArray(this._effectWrapper.options.defines)?this._effectWrapper.options.defines.join("\n"):this._effectWrapper.options.defines}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(t,b){let Z=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;for(let S=0;S<this._textureCache.length;S++)if(this._textureCache[S].texture.width===t.width&&this._textureCache[S].texture.height===t.height&&this._textureCache[S].postProcessChannel===Z&&this._textureCache[S].texture._generateDepthBuffer===b.generateDepthBuffer&&this._textureCache[S].texture.samples===b.samples)return this._textureCache[S].texture;const J=this._engine.createRenderTargetTexture(t,b);return this._textureCache.push({texture:J,postProcessChannel:Z,lastUsedRenderId:-1}),J}_flushTextureCache(){const t=this._renderId;for(let b=this._textureCache.length-1;b>=0;b--)if(t-this._textureCache[b].lastUsedRenderId>100){let t=!1;for(let Z=0;Z<this._textures.length;Z++)if(this._textures.data[Z]===this._textureCache[b].texture){t=!0;break}t||(this._textureCache[b].texture.dispose(),this._textureCache.splice(b,1))}}resize(t,b){let Z=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,J=arguments.length>3&&void 0!==arguments[3]&&arguments[3],S=arguments.length>4&&void 0!==arguments[4]&&arguments[4];this._textures.length>0&&this._textures.reset(),this.width=t,this.height=b;let P=null;if(Z)for(let C=0;C<Z._postProcesses.length;C++)if(null!==Z._postProcesses[C]){P=Z._postProcesses[C];break}const v={width:this.width,height:this.height},h={generateMipMaps:J,generateDepthBuffer:S||P===this,generateStencilBuffer:(S||P===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples,label:"PostProcessRTT-"+this.name};this._textures.push(this._createRenderTargetTexture(v,h,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(v,h,1)),this._texelSize.Ab(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}_getTarget(){let t;if(this._shareOutputWithPostProcess)t=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)t=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{let b;t=this.inputTexture;for(let Z=0;Z<this._textureCache.length;Z++)if(this._textureCache[Z].texture===t){b=this._textureCache[Z];break}b&&(b.lastUsedRenderId=this._renderId)}return t}activate(t){var b,Z;let J=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,S=arguments.length>2?arguments[2]:void 0;const P=null===t||void 0!==t.cameraRigMode?t||this._camera:null,v=(null===P||void 0===P?void 0:P.et())??t,h=v.getEngine(),C=h.getCaps().maxTextureSize,Y=(J?J.width:this._engine.getRenderWidth(!0))*this._options|0,g=(J?J.height:this._engine.getRenderHeight(!0))*this._options|0;let I=this._options.width||Y,M=this._options.height||g;const T=7!==this.renderTargetSamplingMode&&1!==this.renderTargetSamplingMode&&2!==this.renderTargetSamplingMode;let a=null;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const t=h.currentViewport;t&&(I*=t.width,M*=t.height)}(T||this.alwaysForcePOT)&&(this._options.width||(I=h.needPOTTextures?(0,r.h)(I,C,this.scaleMode):I),this._options.height||(M=h.needPOTTextures?(0,r.h)(M,C,this.scaleMode):M)),this.width===I&&this.height===M&&(a=this._getTarget())||this.resize(I,M,P,T,S),this._textures.forEach((t=>{t.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(t,this.samples)})),this._flushTextureCache(),this._renderId++}return a||(a=this._getTarget()),this.enablePixelPerfectMode?(this._scaleRatio.Ab(Y/I,g/M),this._engine.bindFramebuffer(a,0,Y,g,this.forceFullscreenViewport)):(this._scaleRatio.Ab(1,1),this._engine.bindFramebuffer(a,0,void 0,void 0,this.forceFullscreenViewport)),null===(b=(Z=this._engine)._debugInsertMarker)||void 0===b||b.call(Z,`post process ${this.name} input`),this.onActivateObservable.notifyObservers(P),this.eb&&(0===this.alphaMode||this.forceAutoClearInAlphaMode)&&this._engine.clear(this.clearColor?this.clearColor:v.clearColor,v._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),a}get isSupported(){return this._effectWrapper.drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){return this._effectWrapper.isReady()}apply(){if(!this._effectWrapper.isReady())return null;let t;var b;(this._engine.enableEffect(this._effectWrapper.drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a),this._engine.setAlphaMode(this.alphaMode),t=this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?this._forcedOutputTexture:this.inputTexture,this.externalTextureSamplerBinding)||this._effectWrapper.drawWrapper.effect._bindTexture("textureSampler",null===(b=t)||void 0===b?void 0:b.texture);return this._effectWrapper.drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._effectWrapper.drawWrapper.effect),this._effectWrapper.bind(!0),this._effectWrapper.drawWrapper.effect}_disposeTextures(){this._shareOutputWithPostProcess||this._forcedOutputTexture?this._disposeTextureCache():(this._disposeTextureCache(),this._textures.dispose())}_disposeTextureCache(){for(let t=this._textureCache.length-1;t>=0;t--)this._textureCache[t].texture.dispose();this._textureCache.length=0}setPrePassRenderer(t){return!!this._prePassEffectConfiguration&&(this._prePassEffectConfiguration=t.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0)}dispose(t){let b;if(t=t||this._camera,this._useExistingThinPostProcess||this._effectWrapper.dispose(),this._disposeTextures(),this._scene&&(b=this._scene.postProcesses.indexOf(this),-1!==b&&this._scene.postProcesses.splice(b,1)),this._parentContainer){const t=this._parentContainer.postProcesses.indexOf(this);t>-1&&this._parentContainer.postProcesses.splice(t,1),this._parentContainer=null}if(b=this._engine.postProcesses.indexOf(this),-1!==b&&this._engine.postProcesses.splice(b,1),this.lb.notifyObservers(),t){if(t.detachPostProcess(this),b=t._postProcesses.indexOf(this),0===b&&t._postProcesses.length>0){const t=this._camera._getFirstPostProcess();t&&t.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear(),this.onEffectCreatedObservable.clear()}}serialize(){const t=Y.d.Serialize(this),b=this.getCamera()||this._scene&&this._scene.activeCamera;return t.customType="BABYLON."+this.getClassName(),t.cameraId=b?b.id:null,t.reusable=this._reusable,t.textureType=this._textureType,t.fragmentUrl=this._fragmentUrl,t.parameters=this._parameters,t.samplers=this._samplers,t.uniformBuffers=this._uniformBuffers,t.options=this._options,t.defines=this._postProcessDefines,t.textureFormat=this._textureFormat,t.vertexUrl=this._vertexUrl,t.indexParameters=this._indexParameters,t}clone(){const t=this.serialize();t._engine=this._engine,t.cameraId=null;const b=T.Parse(t,this._scene,"");return b?(b.onActivateObservable=this.onActivateObservable.clone(),b.onSizeChangedObservable=this.onSizeChangedObservable.clone(),b.onApplyObservable=this.onApplyObservable.clone(),b.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),b.onAfterRenderObservable=this.onAfterRenderObservable.clone(),b._prePassEffectConfiguration=this._prePassEffectConfiguration,b):null}static Parse(t,b,Z){const J=(0,g.d)(t.customType);if(!J||!J._Parse)return null;const S=b?b.getCameraById(t.cameraId):null;return J._Parse(t,S,b,Z)}static _Parse(t,b,Z,J){return Y.d.Parse((()=>new T(t.name,t.fragmentUrl,t.parameters,t.samplers,t.options,b,t.renderTargetSamplingMode,t._engine,t.reusable,t.defines,t.textureType,t.vertexUrl,t.indexParameters,!1,t.textureFormat)),t,Z,J)}}(0,J.e)([(0,C.N)()],T.prototype,"uniqueId",void 0),(0,J.e)([(0,C.N)()],T.prototype,"name",null),(0,J.e)([(0,C.N)()],T.prototype,"width",void 0),(0,J.e)([(0,C.N)()],T.prototype,"height",void 0),(0,J.e)([(0,C.N)()],T.prototype,"renderTargetSamplingMode",void 0),(0,J.e)([(0,C.n)()],T.prototype,"clearColor",void 0),(0,J.e)([(0,C.N)()],T.prototype,"eb",void 0),(0,J.e)([(0,C.N)()],T.prototype,"forceAutoClearInAlphaMode",void 0),(0,J.e)([(0,C.N)()],T.prototype,"alphaMode",null),(0,J.e)([(0,C.N)()],T.prototype,"alphaConstants",void 0),(0,J.e)([(0,C.N)()],T.prototype,"enablePixelPerfectMode",void 0),(0,J.e)([(0,C.N)()],T.prototype,"forceFullscreenViewport",void 0),(0,J.e)([(0,C.N)()],T.prototype,"scaleMode",void 0),(0,J.e)([(0,C.N)()],T.prototype,"alwaysForcePOT",void 0),(0,J.e)([(0,C.N)("samples")],T.prototype,"_samples",void 0),(0,J.e)([(0,C.N)()],T.prototype,"adaptScaleToCurrentViewport",void 0),(0,g.f)("BABYLON.PostProcess",T)},12854:(t,b,Z)=>{Z.r(b),Z.d(b,{postprocessVertexShader:()=>v});var J=Z(12636);const S="postprocessVertexShader",P="attribute vec2 position;uniform vec2 scale;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=(position*madd+madd)*scale;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";J.e.ShadersStore[S]||(J.e.ShadersStore[S]=P);const v={name:S,shader:P}}}]);