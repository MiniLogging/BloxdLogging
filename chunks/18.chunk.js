"use strict";(self.mo7o6813fhb=self.mo7o6813fhb||[]).push([[18],{12591:(t,U,y)=>{y(12285).e.prototype.createDepthStencilTexture=function(t,U,y){if(U.isCube){const y=t.width||t;return this._createDepthStencilCubeTexture(y,U)}return this._createDepthStencilTexture(t,U,y)}},12572:(t,U,y)=>{y(12543).ThinEngine.prototype.setAlphaMode=function(t){let U=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._alphaMode!==t){switch(t){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0}U||(this.depthCullingState.depthMask=0===t),this._alphaMode=t}else if(!U){const U=0===t;this.depthCullingState.depthMask!==U&&(this.depthCullingState.depthMask=U)}}},12579:(t,U,y)=>{var I=y(12543);I.ThinEngine.prototype.updateDynamicIndexBuffer=function(t,U){let y;this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(t),y=t.is32Bits?U instanceof Uint32Array?U:new Uint32Array(U):U instanceof Uint16Array?U:new Uint16Array(U),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,y,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()},I.ThinEngine.prototype.updateDynamicVertexBuffer=function(t,U,y,I){this.bindArrayBuffer(t),void 0===y&&(y=0);const r=U.byteLength||U.length;void 0===I||I>=r&&0===y?U instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,y,new Float32Array(U)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,y,U):U instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,y,new Float32Array(U).subarray(0,I/4)):(U=U instanceof ArrayBuffer?new Uint8Array(U,0,I):new Uint8Array(U.buffer,U.byteOffset,I),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,y,U)),this._resetVertexBufferBinding()}},12584:(t,U,y)=>{var I=y(12320),r=y(12221),Y=y(12543),mt=y(12589),X=y(12565);class P extends mt.c{setDepthStencilTexture(t){let U=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(super.setDepthStencilTexture(t,U),!t)return;const y=this._engine,I=this._context,r=t._hardwareTexture;if(r&&t._autoMSAAManagement&&this._MSAAFramebuffer){const U=y._currentFramebuffer;y._bindUnboundFramebuffer(this._MSAAFramebuffer),I.framebufferRenderbuffer(I.FRAMEBUFFER,(0,X.e)(t.format)?I.DEPTH_STENCIL_ATTACHMENT:I.DEPTH_ATTACHMENT,I.RENDERBUFFER,r.getMSAARenderBuffer()),y._bindUnboundFramebuffer(U)}}constructor(t,U,y,I,r){super(t,U,y,I),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._disposeOnlyFramebuffers=!1,this._currentLOD=0,this._context=r}_cloneRenderTargetWrapper(){let t=null;return this._colorTextureArray&&this._depthStencilTextureArray?(t=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),t.texture.isReady=!0):t=super._cloneRenderTargetWrapper(),t}_swapRenderTargetWrapper(t){super._swapRenderTargetWrapper(t),t._framebuffer=this._framebuffer,t._depthStencilBuffer=this._depthStencilBuffer,t._MSAAFramebuffer=this._MSAAFramebuffer,t._colorTextureArray=this._colorTextureArray,t._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}createDepthStencilTexture(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,U=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],y=arguments.length>2&&void 0!==arguments[2]&&arguments[2],I=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14,Y=arguments.length>5?arguments[5]:void 0;if(this._depthStencilBuffer){const t=this._engine,U=t._currentFramebuffer,y=this._context;t._bindUnboundFramebuffer(this._framebuffer),y.framebufferRenderbuffer(y.FRAMEBUFFER,y.DEPTH_STENCIL_ATTACHMENT,y.RENDERBUFFER,null),y.framebufferRenderbuffer(y.FRAMEBUFFER,y.DEPTH_ATTACHMENT,y.RENDERBUFFER,null),y.framebufferRenderbuffer(y.FRAMEBUFFER,y.STENCIL_ATTACHMENT,y.RENDERBUFFER,null),t._bindUnboundFramebuffer(U),y.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null}return super.createDepthStencilTexture(t,U,y,I,r,Y)}shareDepth(t){super.shareDepth(t);const U=this._context,y=this._depthStencilBuffer,I=t._MSAAFramebuffer||t._framebuffer,r=this._engine;t._depthStencilBuffer&&t._depthStencilBuffer!==y&&U.deleteRenderbuffer(t._depthStencilBuffer),t._depthStencilBuffer=y;const Y=t._generateStencilBuffer?U.DEPTH_STENCIL_ATTACHMENT:U.DEPTH_ATTACHMENT;r._bindUnboundFramebuffer(I),U.framebufferRenderbuffer(U.FRAMEBUFFER,Y,U.RENDERBUFFER,y),r._bindUnboundFramebuffer(null)}_bindTextureRenderTarget(t){let U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,y=arguments.length>2?arguments[2]:void 0,I=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const r=t._hardwareTexture;if(!r)return;const Y=this._framebuffer,mt=this._engine,X=mt._currentFramebuffer;let P;if(mt._bindUnboundFramebuffer(Y),mt.webGLVersion>1){const Y=this._context;var G;if(P=Y["COLOR_ATTACHMENT"+U],t.is2DArray||t.is3D)y=y??(null===(G=this.layerIndices)||void 0===G?void 0:G[U])??0,Y.framebufferTextureLayer(Y.FRAMEBUFFER,P,r.underlyingResource,I,y);else if(t.isCube){var M;y=y??(null===(M=this.faceIndices)||void 0===M?void 0:M[U])??0,Y.framebufferTexture2D(Y.FRAMEBUFFER,P,Y.TEXTURE_CUBE_MAP_POSITIVE_X+y,r.underlyingResource,I)}else Y.framebufferTexture2D(Y.FRAMEBUFFER,P,Y.TEXTURE_2D,r.underlyingResource,I)}else{const t=this._context;P=t["COLOR_ATTACHMENT"+U+"_WEBGL"];const Y=void 0!==y?t.TEXTURE_CUBE_MAP_POSITIVE_X+y:t.TEXTURE_2D;t.framebufferTexture2D(t.FRAMEBUFFER,P,Y,r.underlyingResource,I)}if(t._autoMSAAManagement&&this._MSAAFramebuffer){const t=this._context;mt._bindUnboundFramebuffer(this._MSAAFramebuffer),t.framebufferRenderbuffer(t.FRAMEBUFFER,P,t.RENDERBUFFER,r.getMSAARenderBuffer())}mt._bindUnboundFramebuffer(X)}setTexture(t){let U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,y=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];super.setTexture(t,U,y),this._bindTextureRenderTarget(t,U)}setLayerAndFaceIndices(t,U){var y;if(super.setLayerAndFaceIndices(t,U),!this.textures||!this.layerIndices||!this.faceIndices)return;const I=(null===(y=this._attachments)||void 0===y?void 0:y.length)??this.textures.length;for(let r=0;r<I;r++){const t=this.textures[r];t&&(t.is2DArray||t.is3D?this._bindTextureRenderTarget(t,r,this.layerIndices[r]):t.isCube?this._bindTextureRenderTarget(t,r,this.faceIndices[r]):this._bindTextureRenderTarget(t,r))}}setLayerAndFaceIndex(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,U=arguments.length>1?arguments[1]:void 0,y=arguments.length>2?arguments[2]:void 0;if(super.setLayerAndFaceIndex(t,U,y),!this.textures||!this.layerIndices||!this.faceIndices)return;const I=this.textures[t];I.is2DArray||I.is3D?this._bindTextureRenderTarget(this.textures[t],t,this.layerIndices[t]):I.isCube&&this._bindTextureRenderTarget(this.textures[t],t,this.faceIndices[t])}resolveMSAATextures(){const t=this._engine,U=t._currentFramebuffer;t._bindUnboundFramebuffer(this._MSAAFramebuffer),super.resolveMSAATextures(),t._bindUnboundFramebuffer(U)}dispose(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._disposeOnlyFramebuffers;const U=this._context;t||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(U.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(U.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(U.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(t)}}y(12591);Y.ThinEngine.prototype._createHardwareRenderTargetWrapper=function(t,U,y){const I=new P(t,U,y,this,this._gl);return this._renderTargetWrapperCache.push(I),I},Y.ThinEngine.prototype.createRenderTargetTexture=function(t,U){const y=this._createHardwareRenderTargetWrapper(!1,!1,t);let I,r,Y=!0,mt=!1,X=!1,P=1;void 0!==U&&"object"===typeof U&&(Y=U.generateDepthBuffer??!0,mt=!!U.generateStencilBuffer,X=!!U.noColorAttachment,I=U.colorAttachment,P=U.samples??1,r=U.label);const G=I||(X?null:this._createInternalTexture(t,U,!0,5)),M=t.width||t,L=t.height||t,h=this._currentFramebuffer,Q=this._gl,F=Q.createFramebuffer();if(this._bindUnboundFramebuffer(F),y._depthStencilBuffer=this._setupFramebufferDepthAttachments(mt,Y,M,L),!G||G.is2DArray||G.is3D||Q.framebufferTexture2D(Q.FRAMEBUFFER,Q.COLOR_ATTACHMENT0,Q.TEXTURE_2D,G._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(h),y.label=r??"RenderTargetWrapper",y._framebuffer=F,y._generateDepthBuffer=Y,y._generateStencilBuffer=mt,y.setTextures(G),I){if(y._samples=I.samples,I.samples>1){const t=I._hardwareTexture.getMSAARenderBuffer(0);y._MSAAFramebuffer=Q.createFramebuffer(),this._bindUnboundFramebuffer(y._MSAAFramebuffer),Q.framebufferRenderbuffer(Q.FRAMEBUFFER,Q.COLOR_ATTACHMENT0,Q.RENDERBUFFER,t),this._bindUnboundFramebuffer(null)}}else this.updateRenderTargetTextureSampleCount(y,P);return y},Y.ThinEngine.prototype._createDepthStencilTexture=function(t,U,y){const Y=this._gl,mt=t.layers||0,P=t.depth||0;let G=Y.TEXTURE_2D;0!==mt?G=Y.TEXTURE_2D_ARRAY:0!==P&&(G=Y.TEXTURE_3D);const M=new I.e(this,12);if(M.label=U.label,!this._caps.depthTextureExtension)return r.b.Error("Depth texture is not supported by your browser or hardware."),M;const L={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...U};if(this._bindTextureDirectly(G,M,!0),this._setupDepthStencilTexture(M,t,0!==L.comparisonFunction&&L.bilinearFiltering,L.comparisonFunction,L.samples),void 0!==L.depthTextureFormat){if(15!==L.depthTextureFormat&&16!==L.depthTextureFormat&&17!==L.depthTextureFormat&&13!==L.depthTextureFormat&&14!==L.depthTextureFormat&&18!==L.depthTextureFormat)return r.b.Error(`Depth texture ${L.depthTextureFormat} format is not supported.`),M;M.format=L.depthTextureFormat}else M.format=L.generateStencil?13:16;const h=(0,X.e)(M.format),Q=this._getWebGLTextureTypeFromDepthTextureFormat(M.format),F=h?Y.DEPTH_STENCIL:Y.DEPTH_COMPONENT,E=this._getInternalFormatFromDepthTextureFormat(M.format,!0,h);return M.is2DArray?Y.texImage3D(G,0,E,M.width,M.height,mt,0,F,Q,null):M.is3D?Y.texImage3D(G,0,E,M.width,M.height,P,0,F,Q,null):Y.texImage2D(G,0,E,M.width,M.height,0,F,Q,null),this._bindTextureDirectly(G,null),this._internalTexturesCache.push(M),y._depthStencilBuffer&&(Y.deleteRenderbuffer(y._depthStencilBuffer),y._depthStencilBuffer=null),this._bindUnboundFramebuffer(y._MSAAFramebuffer??y._framebuffer),y._generateStencilBuffer=h,y._depthStencilTextureWithStencil=h,y._depthStencilBuffer=this._setupFramebufferDepthAttachments(y._generateStencilBuffer,y._generateDepthBuffer,y.width,y.height,y.samples,M.format),this._bindUnboundFramebuffer(null),M},Y.ThinEngine.prototype.updateRenderTargetTextureSampleCount=function(t,U){var y;if(this.webGLVersion<2||!t)return 1;if(t.samples===U)return U;const I=this._gl;U=Math.min(U,this.getCaps().maxMSAASamples),t._depthStencilBuffer&&(I.deleteRenderbuffer(t._depthStencilBuffer),t._depthStencilBuffer=null),t._MSAAFramebuffer&&(I.deleteFramebuffer(t._MSAAFramebuffer),t._MSAAFramebuffer=null);const r=null===(y=t.texture)||void 0===y?void 0:y._hardwareTexture;if(null===r||void 0===r||r.releaseMSAARenderBuffers(),t.texture&&U>1&&"function"===typeof I.renderbufferStorageMultisample){const y=I.createFramebuffer();if(!y)throw new Error("Unable to create multi sampled framebuffer");t._MSAAFramebuffer=y,this._bindUnboundFramebuffer(t._MSAAFramebuffer);const Y=this._createRenderBuffer(t.texture.width,t.texture.height,U,-1,this._getRGBABufferInternalSizedFormat(t.texture.type,t.texture.format,t.texture._useSRGBBuffer),I.COLOR_ATTACHMENT0,!1);if(!Y)throw new Error("Unable to create multi sampled framebuffer");null===r||void 0===r||r.addMSAARenderBuffer(Y)}this._bindUnboundFramebuffer(t._MSAAFramebuffer??t._framebuffer),t.texture&&(t.texture.samples=U),t._samples=U;const Y=t._depthStencilTexture?t._depthStencilTexture.format:void 0;return t._depthStencilBuffer=this._setupFramebufferDepthAttachments(t._generateStencilBuffer,t._generateDepthBuffer,t.width,t.height,U,Y),this._bindUnboundFramebuffer(null),U},Y.ThinEngine.prototype._setupDepthStencilTexture=function(t,U,y,I){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;const Y=U.width??U,mt=U.height??U,X=U.layers||0,P=U.depth||0;t.baseWidth=Y,t.baseHeight=mt,t.width=Y,t.height=mt,t.is2DArray=X>0,t.depth=X||P,t.isReady=!0,t.samples=r,t.generateMipMaps=!1,t.samplingMode=y?2:1,t.type=0,t._comparisonFunction=I;const G=this._gl,M=this._getTextureTarget(t),L=this._getSamplingParameters(t.samplingMode,!1);G.texParameteri(M,G.TEXTURE_MAG_FILTER,L.mag),G.texParameteri(M,G.TEXTURE_MIN_FILTER,L.min),G.texParameteri(M,G.TEXTURE_WRAP_S,G.CLAMP_TO_EDGE),G.texParameteri(M,G.TEXTURE_WRAP_T,G.CLAMP_TO_EDGE),this.webGLVersion>1&&(0===I?(G.texParameteri(M,G.TEXTURE_COMPARE_FUNC,515),G.texParameteri(M,G.TEXTURE_COMPARE_MODE,G.NONE)):(G.texParameteri(M,G.TEXTURE_COMPARE_FUNC,I),G.texParameteri(M,G.TEXTURE_COMPARE_MODE,G.COMPARE_REF_TO_TEXTURE)))}},12560:(t,U,y)=>{y.d(U,{d:()=>I});class I{get underlyingResource(){return this._webGLTexture}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,U=arguments.length>1?arguments[1]:void 0;if(this._MSAARenderBuffers=null,this._context=U,!t&&(t=U.createTexture(),!t))throw new Error("Unable to create webGL texture");this.set(t)}setUsage(){}set(t){this._webGLTexture=t}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(t){this._MSAARenderBuffers||(this._MSAARenderBuffers=[]),this._MSAARenderBuffers.push(t)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(const t of this._MSAARenderBuffers)this._context.deleteRenderbuffer(t);this._MSAARenderBuffers=null}}getMSAARenderBuffer(){var t;let U=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return(null===(t=this._MSAARenderBuffers)||void 0===t?void 0:t[U])??null}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}},12537:(t,U,y)=>{y.d(U,{c:()=>f});var I=y(12320),r=y(12250),Y=y(12543),mt=y(12234);class X{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:30;this._enabled=!0,this._rollingFrameTime=new P(t)}sampleFrame(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:mt.b.Now;if(this._enabled){if(null!=this._lastFrameTimeMs){const U=t-this._lastFrameTimeMs;this._rollingFrameTime.add(U)}this._lastFrameTimeMs=t}}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){const t=this._rollingFrameTime.history(0);return 0===t?0:1e3/t}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}}class P{constructor(t){this._samples=new Array(t),this.reset()}add(t){let U;if(this.isSaturated()){const t=this._samples[this._pos];U=t-this.average,this.average-=U/(this._sampleCount-1),this._m2-=U*(t-this.average)}else this._sampleCount++;U=t-this.average,this.average+=U/this._sampleCount,this._m2+=U*(t-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=t,this._pos++,this._pos%=this._samples.length}history(t){if(t>=this._sampleCount||t>=this._samples.length)return 0;const U=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(U-t)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(t){const U=this._samples.length;return(t%U+U)%U}}var G=y(12552),M=y(12221),L=y(12560),h=(y(12572),y(12349));function Q(t,U,y,I){let r,Y=1;1===I?r=new Float32Array(U*y*4):2===I?(r=new Uint16Array(U*y*4),Y=15360):r=7===I?new Uint32Array(U*y*4):new Uint8Array(U*y*4);for(let mt=0;mt<U;mt++)for(let I=0;I<y;I++){const y=3*(I*U+mt),X=4*(I*U+mt);r[X+0]=t[y+0],r[X+1]=t[y+1],r[X+2]=t[y+2],r[X+3]=Y}return r}function F(t){return function(U,y,r,Y,mt,X,P,G){let M=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,L=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;const h=t?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,Q=t?10:11,F=new I.e(this,Q);F.baseWidth=y,F.baseHeight=r,F.baseDepth=Y,F.width=y,F.height=r,F.depth=Y,F.format=mt,F.type=L,F.generateMipMaps=X,F.samplingMode=G,t?F.is3D=!0:F.is2DArray=!0,this._doNotHandleContextLost||(F._bufferView=U),t?this.updateRawTexture3D(F,U,mt,P,M,L):this.updateRawTexture2DArray(F,U,mt,P,M,L),this._bindTextureDirectly(h,F,!0);const E=this._getSamplingParameters(G,X);return this._gl.texParameteri(h,this._gl.TEXTURE_MAG_FILTER,E.mag),this._gl.texParameteri(h,this._gl.TEXTURE_MIN_FILTER,E.min),X&&this._gl.generateMipmap(h),this._bindTextureDirectly(h,null),this._internalTexturesCache.push(F),F}}function E(t){return function(U,y,I,r){let Y=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,mt=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;const X=t?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,P=this._getWebGLTextureType(mt),G=this._getInternalFormat(I),M=this._getRGBABufferInternalSizedFormat(mt,I);this._bindTextureDirectly(X,U,!0),this._unpackFlipY(void 0===r||!!r),this._doNotHandleContextLost||(U._bufferView=y,U.format=I,U.invertY=r,U._compression=Y),U.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),Y&&y?this._gl.compressedTexImage3D(X,0,this.getCaps().s3tc[Y],U.width,U.height,U.depth,0,y):this._gl.texImage3D(X,0,M,U.width,U.height,U.depth,0,G,P,y),U.generateMipMaps&&this._gl.generateMipmap(X),this._bindTextureDirectly(X,null),U.isReady=!0}}Y.ThinEngine.prototype.updateRawTexture=function(t,U,y,I){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,Y=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,mt=arguments.length>6&&void 0!==arguments[6]&&arguments[6];if(!t)return;const X=this._getRGBABufferInternalSizedFormat(Y,y,mt),P=this._getInternalFormat(y),G=this._getWebGLTextureType(Y);this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),this._unpackFlipY(void 0===I||!!I),this._doNotHandleContextLost||(t._bufferView=U,t.format=y,t.type=Y,t.invertY=I,t._compression=r),t.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),r&&U?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[r],t.width,t.height,0,U):this._gl.texImage2D(this._gl.TEXTURE_2D,0,X,t.width,t.height,0,P,G,U),t.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),t.isReady=!0},Y.ThinEngine.prototype.createRawTexture=function(t,U,y,r,Y,mt,X){let P=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,G=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,M=arguments.length>10&&void 0!==arguments[10]&&arguments[10];const L=new I.e(this,3);L.baseWidth=U,L.baseHeight=y,L.width=U,L.height=y,L.format=r,L.generateMipMaps=Y,L.samplingMode=X,L.invertY=mt,L._compression=P,L.type=G,L._useSRGBBuffer=this._getUseSRGBBuffer(M,!Y),this._doNotHandleContextLost||(L._bufferView=t),this.updateRawTexture(L,t,r,mt,P,G,L._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,L,!0);const h=this._getSamplingParameters(X,Y);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,h.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,h.min),Y&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(L),L},Y.ThinEngine.prototype.createRawCubeTexture=function(t,U,y,r,Y,mt,X){let P=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;const G=this._gl,L=new I.e(this,8);L.isCube=!0,L.format=y,L.type=r,this._doNotHandleContextLost||(L._bufferViewArray=t);const Q=this._getWebGLTextureType(r);let F=this._getInternalFormat(y);F===G.RGB&&(F=G.RGBA),Q!==G.FLOAT||this._caps.textureFloatLinearFiltering?Q!==this._gl.HALF_FLOAT_OES||this._caps.textureHalfFloatLinearFiltering?Q!==G.FLOAT||this._caps.textureFloatRender?Q!==G.HALF_FLOAT||this._caps.colorBufferFloat||(Y=!1,M.b.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(Y=!1,M.b.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(Y=!1,X=1,M.b.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(Y=!1,X=1,M.b.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively."));const E=U,w=E;L.width=E,L.height=w,L.invertY=mt,L._compression=P;if(!this.needPOTTextures||(0,h.g)(L.width)&&(0,h.g)(L.height)||(Y=!1),t)this.updateRawCubeTexture(L,t,y,r,mt,P);else{const t=this._getRGBABufferInternalSizedFormat(r),U=0;this._bindTextureDirectly(G.TEXTURE_CUBE_MAP,L,!0);for(let y=0;y<6;y++)P?G.compressedTexImage2D(G.TEXTURE_CUBE_MAP_POSITIVE_X+y,U,this.getCaps().s3tc[P],L.width,L.height,0,void 0):G.texImage2D(G.TEXTURE_CUBE_MAP_POSITIVE_X+y,U,t,L.width,L.height,0,F,Q,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,L,!0),t&&Y&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);const D=this._getSamplingParameters(X,Y);return G.texParameteri(G.TEXTURE_CUBE_MAP,G.TEXTURE_MAG_FILTER,D.mag),G.texParameteri(G.TEXTURE_CUBE_MAP,G.TEXTURE_MIN_FILTER,D.min),G.texParameteri(G.TEXTURE_CUBE_MAP,G.TEXTURE_WRAP_S,G.CLAMP_TO_EDGE),G.texParameteri(G.TEXTURE_CUBE_MAP,G.TEXTURE_WRAP_T,G.CLAMP_TO_EDGE),this._bindTextureDirectly(G.TEXTURE_CUBE_MAP,null),L.generateMipMaps=Y,L.samplingMode=X,L.isReady=!0,L},Y.ThinEngine.prototype.updateRawCubeTexture=function(t,U,y,I,r){let Y=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,mt=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;t._bufferViewArray=U,t.format=y,t.type=I,t.invertY=r,t._compression=Y;const X=this._gl,P=this._getWebGLTextureType(I);let G=this._getInternalFormat(y);const M=this._getRGBABufferInternalSizedFormat(I);let L=!1;G===X.RGB&&(G=X.RGBA,L=!0),this._bindTextureDirectly(X.TEXTURE_CUBE_MAP,t,!0),this._unpackFlipY(void 0===r||!!r),t.width%4!==0&&X.pixelStorei(X.UNPACK_ALIGNMENT,1);for(let h=0;h<6;h++){let y=U[h];Y?X.compressedTexImage2D(X.TEXTURE_CUBE_MAP_POSITIVE_X+h,mt,this.getCaps().s3tc[Y],t.width,t.height,0,y):(L&&(y=Q(y,t.width,t.height,I)),X.texImage2D(X.TEXTURE_CUBE_MAP_POSITIVE_X+h,mt,M,t.width,t.height,0,G,P,y))}(!this.needPOTTextures||(0,h.g)(t.width)&&(0,h.g)(t.height))&&t.generateMipMaps&&0===mt&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),t.isReady=!0},Y.ThinEngine.prototype.createRawCubeTextureFromUrl=function(t,U,y,I,r,Y,mt,X){let P=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,G=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,M=arguments.length>10&&void 0!==arguments[10]?arguments[10]:3,L=arguments.length>11&&void 0!==arguments[11]&&arguments[11];const h=this._gl,F=this.createRawCubeTexture(null,y,I,r,!Y,L,M,null);null===U||void 0===U||U.addPendingData(F),F.url=t,F.isReady=!1,this._internalTexturesCache.push(F);const E=t=>{if(!F._hardwareTexture)return;const y=F.width,Y=mt(t);if(Y){if(X){const t=this._getWebGLTextureType(r);let U=this._getInternalFormat(I);const mt=this._getRGBABufferInternalSizedFormat(r);let P=!1;U===h.RGB&&(U=h.RGBA,P=!0),this._bindTextureDirectly(h.TEXTURE_CUBE_MAP,F,!0),this._unpackFlipY(!1);const G=X(Y);for(let I=0;I<G.length;I++){const Y=y>>I;for(let y=0;y<6;y++){let X=G[I][y];P&&(X=Q(X,Y,Y,r)),h.texImage2D(y,I,mt,Y,Y,0,U,t,X)}}this._bindTextureDirectly(h.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(F,Y,I,r,L);F.isReady=!0,null===U||void 0===U||U.removePendingData(F),F.onLoadedObservable.notifyObservers(F),F.onLoadedObservable.clear(),P&&P()}};return this._loadFile(t,(t=>{E(t)}),void 0,null===U||void 0===U?void 0:U.offlineProvider,!0,((t,y)=>{null===U||void 0===U||U.removePendingData(F),G&&t&&G(t.status+" "+t.statusText,y)})),F},Y.ThinEngine.prototype.createRawTexture2DArray=F(!1),Y.ThinEngine.prototype.createRawTexture3D=F(!0),Y.ThinEngine.prototype.updateRawTexture2DArray=E(!1),Y.ThinEngine.prototype.updateRawTexture3D=E(!0);var w=y(12273);Y.ThinEngine.prototype._readTexturePixelsSync=function(t,U,y){let I=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,Y=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,mt=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],X=arguments.length>7&&void 0!==arguments[7]&&arguments[7],P=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,G=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;const M=this._gl;if(!M)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){const t=M.createFramebuffer();if(!t)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=t}var L,h;(M.bindFramebuffer(M.FRAMEBUFFER,this._dummyFramebuffer),I>-1)?M.framebufferTexture2D(M.FRAMEBUFFER,M.COLOR_ATTACHMENT0,M.TEXTURE_CUBE_MAP_POSITIVE_X+I,null===(L=t._hardwareTexture)||void 0===L?void 0:L.underlyingResource,r):M.framebufferTexture2D(M.FRAMEBUFFER,M.COLOR_ATTACHMENT0,M.TEXTURE_2D,null===(h=t._hardwareTexture)||void 0===h?void 0:h.underlyingResource,r);let Q=void 0!==t.type?this._getWebGLTextureType(t.type):M.UNSIGNED_BYTE;if(X)Y||(Y=(0,w.o)(t.type,4*U*y));else if(Q===M.UNSIGNED_BYTE)Y||(Y=new Uint8Array(4*U*y)),Q=M.UNSIGNED_BYTE;else Y||(Y=new Float32Array(4*U*y)),Q=M.FLOAT;return mt&&this.flushFramebuffer(),M.readPixels(P,G,U,y,M.RGBA,Q,Y),M.bindFramebuffer(M.FRAMEBUFFER,this._currentFramebuffer),Y},Y.ThinEngine.prototype._readTexturePixels=function(t,U,y){let I=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,Y=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,mt=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],X=arguments.length>7&&void 0!==arguments[7]&&arguments[7],P=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,G=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;return Promise.resolve(this._readTexturePixelsSync(t,U,y,I,r,Y,mt,X,P,G))};y(12579);Y.ThinEngine.prototype._createDepthStencilCubeTexture=function(t,U){const y=new I.e(this,12);if(y.isCube=!0,1===this.webGLVersion)return M.b.Error("Depth cube texture is not supported by WebGL 1."),y;const r={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...U},Y=this._gl;this._bindTextureDirectly(Y.TEXTURE_CUBE_MAP,y,!0),this._setupDepthStencilTexture(y,t,r.bilinearFiltering,r.comparisonFunction);for(let I=0;I<6;I++)r.generateStencil?Y.texImage2D(Y.TEXTURE_CUBE_MAP_POSITIVE_X+I,0,Y.DEPTH24_STENCIL8,t,t,0,Y.DEPTH_STENCIL,Y.UNSIGNED_INT_24_8,null):Y.texImage2D(Y.TEXTURE_CUBE_MAP_POSITIVE_X+I,0,Y.DEPTH_COMPONENT24,t,t,0,Y.DEPTH_COMPONENT,Y.UNSIGNED_INT,null);return this._bindTextureDirectly(Y.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(y),y},Y.ThinEngine.prototype._setCubeMapTextureParams=function(t,U,y){const I=this._gl;I.texParameteri(I.TEXTURE_CUBE_MAP,I.TEXTURE_MAG_FILTER,I.LINEAR),I.texParameteri(I.TEXTURE_CUBE_MAP,I.TEXTURE_MIN_FILTER,U?I.LINEAR_MIPMAP_LINEAR:I.LINEAR),I.texParameteri(I.TEXTURE_CUBE_MAP,I.TEXTURE_WRAP_S,I.CLAMP_TO_EDGE),I.texParameteri(I.TEXTURE_CUBE_MAP,I.TEXTURE_WRAP_T,I.CLAMP_TO_EDGE),t.samplingMode=U?3:2,U&&this.getCaps().textureMaxLevel&&void 0!==y&&y>0&&(I.texParameteri(I.TEXTURE_CUBE_MAP,I.TEXTURE_MAX_LEVEL,y),t._maxLodLevel=y),this._bindTextureDirectly(I.TEXTURE_CUBE_MAP,null)},Y.ThinEngine.prototype.createCubeTexture=function(t,U,y,I){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,Y=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,mt=arguments.length>6?arguments[6]:void 0,X=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,P=arguments.length>8&&void 0!==arguments[8]&&arguments[8],G=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,L=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0,Q=arguments.length>11&&void 0!==arguments[11]?arguments[11]:null,F=arguments.length>13&&void 0!==arguments[13]&&arguments[13],E=arguments.length>14&&void 0!==arguments[14]?arguments[14]:null;const w=this._gl;return this.createCubeTextureBase(t,U,y,!!I,r,Y,mt,X,P,G,L,Q,(t=>this._bindTextureDirectly(w.TEXTURE_CUBE_MAP,t,!0)),((t,U)=>{const y=this.needPOTTextures?(0,h.f)(U[0].width,this._caps.maxCubemapTextureSize):U[0].width,Y=y,X=[w.TEXTURE_CUBE_MAP_POSITIVE_X,w.TEXTURE_CUBE_MAP_POSITIVE_Y,w.TEXTURE_CUBE_MAP_POSITIVE_Z,w.TEXTURE_CUBE_MAP_NEGATIVE_X,w.TEXTURE_CUBE_MAP_NEGATIVE_Y,w.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(w.TEXTURE_CUBE_MAP,t,!0),this._unpackFlipY(!1);const P=mt?this._getInternalFormat(mt,t._useSRGBBuffer):t._useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:w.RGBA;let G=mt?this._getInternalFormat(mt):w.RGBA;t._useSRGBBuffer&&1===this.webGLVersion&&(G=P);for(let I=0;I<X.length;I++)if(U[I].width!==y||U[I].height!==Y){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext)return void M.b.Warn("Cannot create canvas to resize texture.");this._workingCanvas.width=y,this._workingCanvas.height=Y,this._workingContext.drawImage(U[I],0,0,U[I].width,U[I].height,0,0,y,Y),w.texImage2D(X[I],0,P,G,w.UNSIGNED_BYTE,this._workingCanvas)}else w.texImage2D(X[I],0,P,G,w.UNSIGNED_BYTE,U[I]);I||w.generateMipmap(w.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(t,!I),t.width=y,t.height=Y,t.isReady=!0,mt&&(t.format=mt),t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),r&&r()}),!!F,E)},Y.ThinEngine.prototype.generateMipMapsForCubemap=function(t){let U=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(t.generateMipMaps){const y=this._gl;this._bindTextureDirectly(y.TEXTURE_CUBE_MAP,t,!0),y.generateMipmap(y.TEXTURE_CUBE_MAP),U&&this._bindTextureDirectly(y.TEXTURE_CUBE_MAP,null)}};y(12584);Y.ThinEngine.prototype.setDepthStencilTexture=function(t,U,y,I){void 0!==t&&(U&&(this._boundUniforms[t]=U),y&&y.depthStencilTexture?this._setTexture(t,y,!1,!0,I):this._setTexture(t,null,void 0,void 0,I))},Y.ThinEngine.prototype.createRenderTargetCubeTexture=function(t,U){const y=this._createHardwareRenderTargetWrapper(!1,!0,t),r={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,...U};r.generateStencilBuffer=r.generateDepthBuffer&&r.generateStencilBuffer,(1!==r.type||this._caps.textureFloatLinearFiltering)&&(2!==r.type||this._caps.textureHalfFloatLinearFiltering)||(r.samplingMode=1);const Y=this._gl,mt=new I.e(this,5);this._bindTextureDirectly(Y.TEXTURE_CUBE_MAP,mt,!0);const X=this._getSamplingParameters(r.samplingMode,r.generateMipMaps);1!==r.type||this._caps.textureFloat||(r.type=0,M.b.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),Y.texParameteri(Y.TEXTURE_CUBE_MAP,Y.TEXTURE_MAG_FILTER,X.mag),Y.texParameteri(Y.TEXTURE_CUBE_MAP,Y.TEXTURE_MIN_FILTER,X.min),Y.texParameteri(Y.TEXTURE_CUBE_MAP,Y.TEXTURE_WRAP_S,Y.CLAMP_TO_EDGE),Y.texParameteri(Y.TEXTURE_CUBE_MAP,Y.TEXTURE_WRAP_T,Y.CLAMP_TO_EDGE);for(let I=0;I<6;I++)Y.texImage2D(Y.TEXTURE_CUBE_MAP_POSITIVE_X+I,0,this._getRGBABufferInternalSizedFormat(r.type,r.format),t,t,0,this._getInternalFormat(r.format),this._getWebGLTextureType(r.type),null);const P=Y.createFramebuffer();return this._bindUnboundFramebuffer(P),y._depthStencilBuffer=this._setupFramebufferDepthAttachments(r.generateStencilBuffer,r.generateDepthBuffer,t,t),r.generateMipMaps&&Y.generateMipmap(Y.TEXTURE_CUBE_MAP),this._bindTextureDirectly(Y.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),y._framebuffer=P,y._generateDepthBuffer=r.generateDepthBuffer,y._generateStencilBuffer=r.generateStencilBuffer,mt.width=t,mt.height=t,mt.isReady=!0,mt.isCube=!0,mt.samples=1,mt.generateMipMaps=r.generateMipMaps,mt.samplingMode=r.samplingMode,mt.type=r.type,mt.format=r.format,this._internalTexturesCache.push(mt),y.setTextures(mt),y};var D=y(12597),l=y(12413);Y.ThinEngine.prototype.createPrefilteredCubeTexture=function(t,U,r,Y){let mt=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,X=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,P=arguments.length>6?arguments[6]:void 0,G=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,L=!(arguments.length>8&&void 0!==arguments[8])||arguments[8];return this.createCubeTexture(t,U,null,!1,(async t=>{if(!t)return void(mt&&mt(null));const X=t.texture;if(L?t.info.sphericalPolynomial&&(X._sphericalPolynomial=t.info.sphericalPolynomial):X._sphericalPolynomial=new D.e,X._source=9,this.getCaps().textureLOD)return void(mt&&mt(X));const P=this._gl,G=t.width;if(!G)return;const{DDSTools:h}=await y.e(29).then(y.bind(y,14605)),Q=[];for(let y=0;y<3;y++){const mt=1-y/2,L=Y,F=Math.log2(G)*r+Y,E=L+(F-L)*mt,w=Math.round(Math.min(Math.max(E,0),F)),D=new I.e(this,2);if(D.type=X.type,D.format=X.format,D.width=Math.pow(2,Math.max(Math.log2(G)-w,0)),D.height=D.width,D.isCube=!0,D._cachedWrapU=0,D._cachedWrapV=0,this._bindTextureDirectly(P.TEXTURE_CUBE_MAP,D,!0),D.samplingMode=2,P.texParameteri(P.TEXTURE_CUBE_MAP,P.TEXTURE_MAG_FILTER,P.LINEAR),P.texParameteri(P.TEXTURE_CUBE_MAP,P.TEXTURE_MIN_FILTER,P.LINEAR),P.texParameteri(P.TEXTURE_CUBE_MAP,P.TEXTURE_WRAP_S,P.CLAMP_TO_EDGE),P.texParameteri(P.TEXTURE_CUBE_MAP,P.TEXTURE_WRAP_T,P.CLAMP_TO_EDGE),t.isDDS){const U=t.info,y=t.data;this._unpackFlipY(U.isCompressed),h.UploadDDSLevels(this,D,y,U,!0,6,w)}else M.b.Warn("DDS is the only prefiltered cube map supported so far.");this._bindTextureDirectly(P.TEXTURE_CUBE_MAP,null);const g=new l.d(U);g._isCube=!0,g._texture=D,D.isReady=!0,Q.push(g)}X._lodTextureHigh=Q[2],X._lodTextureMid=Q[1],X._lodTextureLow=Q[0],mt&&mt(X)}),X,P,G,L,r,Y)},Y.ThinEngine.prototype.createUniformBuffer=function(t,U){const y=this._gl.createBuffer();if(!y)throw new Error("Unable to create uniform buffer");const I=new G.c(y);return this.bindUniformBuffer(I),t instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,t,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(t),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),I.references=1,I},Y.ThinEngine.prototype.createDynamicUniformBuffer=function(t,U){const y=this._gl.createBuffer();if(!y)throw new Error("Unable to create dynamic uniform buffer");const I=new G.c(y);return this.bindUniformBuffer(I),t instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,t,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(t),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),I.references=1,I},Y.ThinEngine.prototype.updateUniformBuffer=function(t,U,y,I){this.bindUniformBuffer(t),void 0===y&&(y=0),void 0===I?U instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,y,U):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,y,new Float32Array(U)):U instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,U.subarray(y,y+I)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(U).subarray(y,y+I)),this.bindUniformBuffer(null)},Y.ThinEngine.prototype.bindUniformBuffer=function(t){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,t?t.underlyingResource:null)},Y.ThinEngine.prototype.bindUniformBufferBase=function(t,U,y){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,U,t?t.underlyingResource:null)},Y.ThinEngine.prototype.bindUniformBlock=function(t,U,y){const I=t.program,r=this._gl.getUniformBlockIndex(I,U);4294967295!==r&&this._gl.uniformBlockBinding(I,r,y)};var g=y(12212),B=y(12285);B.e.prototype.displayLoadingUI=function(){if(!(0,g.p)())return;const t=this.loadingScreen;t&&t.displayLoadingUI()},B.e.prototype.hideLoadingUI=function(){if(!(0,g.p)())return;const t=this._loadingScreen;t&&t.hideLoadingUI()},Object.defineProperty(B.e.prototype,"loadingScreen",{get:function(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=B.e.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen},set:function(t){this._loadingScreen=t},enumerable:!0,configurable:!0}),Object.defineProperty(B.e.prototype,"loadingUIText",{set:function(t){this.loadingScreen.loadingUIText=t},enumerable:!0,configurable:!0}),Object.defineProperty(B.e.prototype,"loadingUIBackgroundColor",{set:function(t){this.loadingScreen.loadingUIBackgroundColor=t},enumerable:!0,configurable:!0}),B.e.prototype.getInputElement=function(){return this._renderingCanvas},B.e.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null},B.e.prototype.getInputElementClientRect=function(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null},B.e.prototype.getAspectRatio=function(t){let U=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const y=t.viewport;return this.getRenderWidth(U)*y.width/(this.getRenderHeight(U)*y.height)},B.e.prototype.getScreenAspectRatio=function(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)},B.e.prototype._verifyPointerLock=function(){var t;null===(t=this._onPointerLockChange)||void 0===t||t.call(this)},B.e.prototype.setAlphaEquation=function(t){if(this._alphaEquation!==t){switch(t){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774)}this._alphaEquation=t}},B.e.prototype.getInputElement=function(){return this._renderingCanvas},B.e.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc},B.e.prototype.setDepthFunction=function(t){this._depthCullingState.depthFunc=t},B.e.prototype.setDepthFunctionToGreater=function(){this.setDepthFunction(516)},B.e.prototype.setDepthFunctionToGreaterOrEqual=function(){this.setDepthFunction(518)},B.e.prototype.setDepthFunctionToLess=function(){this.setDepthFunction(513)},B.e.prototype.setDepthFunctionToLessOrEqual=function(){this.setDepthFunction(515)},B.e.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask},B.e.prototype.setDepthWrite=function(t){this._depthCullingState.depthMask=t},B.e.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest},B.e.prototype.setStencilBuffer=function(t){this._stencilState.stencilTest=t},B.e.prototype.getStencilMask=function(){return this._stencilState.stencilMask},B.e.prototype.setStencilMask=function(t){this._stencilState.stencilMask=t},B.e.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc},B.e.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef},B.e.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask},B.e.prototype.setStencilFunction=function(t){this._stencilState.stencilFunc=t},B.e.prototype.setStencilFunctionReference=function(t){this._stencilState.stencilFuncRef=t},B.e.prototype.setStencilFunctionMask=function(t){this._stencilState.stencilFuncMask=t},B.e.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail},B.e.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail},B.e.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass},B.e.prototype.setStencilOperationFail=function(t){this._stencilState.stencilOpStencilFail=t},B.e.prototype.setStencilOperationDepthFail=function(t){this._stencilState.stencilOpDepthFail=t},B.e.prototype.setStencilOperationPass=function(t){this._stencilState.stencilOpStencilDepthPass=t},B.e.prototype.cacheStencilState=function(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()},B.e.prototype.restoreStencilState=function(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)},B.e.prototype.setAlphaConstants=function(t,U,y,I){this._alphaState.setAlphaBlendConstants(t,U,y,I)},B.e.prototype.getAlphaMode=function(){return this._alphaMode},B.e.prototype.getAlphaEquation=function(){return this._alphaEquation},B.e.prototype.getRenderPassNames=function(){return this._renderPassNames},B.e.prototype.getCurrentRenderPassName=function(){return this._renderPassNames[this.currentRenderPassId]},B.e.prototype.createRenderPassId=function(t){const U=++B.e._RenderPassIdCounter;return this._renderPassNames[U]=t??"NONAME",U},B.e.prototype.releaseRenderPassId=function(t){this._renderPassNames[t]=void 0;for(let U=0;U<this.scenes.length;++U){const y=this.scenes[U];for(let U=0;U<y.meshes.length;++U){const I=y.meshes[U];if(I.BX)for(let U=0;U<I.BX.length;++U){I.BX[U]._removeDrawWrapper(t)}}}};y(12591);function b(t){if(t.requestPointerLock){const U=t.requestPointerLock();U instanceof Promise?U.then((()=>{t.focus()})).catch((()=>{})):t.focus()}}var p=y(12629),c=y(12277);class f extends Y.ThinEngine{static get NpmPackage(){return B.e.NpmPackage}static get Version(){return B.e.Version}static get Instances(){return r.d.Instances}static get LastCreatedEngine(){return r.d.LastCreatedEngine}static get LastCreatedScene(){return r.d.LastCreatedScene}static DefaultLoadingScreenFactory(t){return B.e.DefaultLoadingScreenFactory(t)}get _supportsHardwareTextureRescaling(){return!!f._RescalePostProcessFactory}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}get performanceMonitor(){return this._performanceMonitor}constructor(t,U,y){super(t,U,y,arguments.length>3&&void 0!==arguments[3]&&arguments[3]),this.customAnimationFrameRequester=null,this._performanceMonitor=new X,this._drawCalls=new p.e,t&&(this._features.supportRenderPasses=!0,y=this._creationOptions)}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(t){super._sharedInit(t),function(t,U,y){t._onCanvasFocus=()=>{t.onCanvasFocusObservable.notifyObservers(t)},t._onCanvasBlur=()=>{t.onCanvasBlurObservable.notifyObservers(t)},t._onCanvasContextMenu=U=>{t.disableContextMenu&&U.preventDefault()},U.addEventListener("focus",t._onCanvasFocus),U.addEventListener("blur",t._onCanvasBlur),U.addEventListener("contextmenu",t._onCanvasContextMenu),t._onBlur=()=>{t.disablePerformanceMonitorInBackground&&t.performanceMonitor.disable(),t._windowIsBackground=!0},t._onFocus=()=>{t.disablePerformanceMonitorInBackground&&t.performanceMonitor.enable(),t._windowIsBackground=!1},t._onCanvasPointerOut=y=>{document.elementFromPoint(y.clientX,y.clientY)!==U&&t.onCanvasPointerOutObservable.notifyObservers(y)};const I=t.getHostWindow();I&&"function"===typeof I.addEventListener&&(I.addEventListener("blur",t._onBlur),I.addEventListener("focus",t._onFocus)),U.addEventListener("pointerout",t._onCanvasPointerOut),y.doNotHandleTouchAction||function(t){t&&t.setAttribute&&(t.setAttribute("touch-action","none"),t.style.touchAction="none",t.style.webkitTapHighlightColor="transparent")}(U),!B.e.audioEngine&&y.audioEngine&&B.e.AudioEngineFactory&&(B.e.audioEngine=B.e.AudioEngineFactory(t.getRenderingCanvas(),t.getAudioContext(),t.getAudioDestination())),(0,g.h)()&&(t._onFullscreenChange=()=>{t.isFullscreen=!!document.fullscreenElement,t.isFullscreen&&t._pointerLockRequested&&U&&b(U)},document.addEventListener("fullscreenchange",t._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",t._onFullscreenChange,!1),t._onPointerLockChange=()=>{t.isPointerLock=document.pointerLockElement===U},document.addEventListener("pointerlockchange",t._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",t._onPointerLockChange,!1)),t.enableOfflineSupport=void 0!==B.e.OfflineProviderFactory,t._deterministicLockstep=!!y.deterministicLockstep,t._lockstepMaxSteps=y.lockstepMaxSteps||0,t._timeStep=y.timeStep||1/60}(this,t,this._creationOptions)}resizeImageBitmap(t,U,y){return function(t,U,y,I){const r=t.createCanvas(y,I).getContext("2d");if(!r)throw new Error("Unable to get 2d context for resizeImageBitmap");return r.drawImage(U,0,0),r.getImageData(0,0,y,I).data}(this,t,U,y)}async _createImageBitmapFromSource(t,U){return await async function(t,U,y){return await new Promise(((I,r)=>{const Y=new Image;Y.onload=()=>{Y.decode().then((()=>{t.createImageBitmap(Y,y).then((t=>{I(t)}))}))},Y.onerror=()=>{r(`Error loading image ${Y.src}`)},Y.src=U}))}(this,t,U)}switchFullscreen(t){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(t)}enterFullscreen(t){this.isFullscreen||(this._pointerLockRequested=t,this._renderingCanvas&&function(t){const U=t.requestFullscreen||t.webkitRequestFullscreen;U&&U.call(t)}(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&function(){const t=document;document.exitFullscreen?document.exitFullscreen():t.webkitCancelFullScreen&&t.webkitCancelFullScreen()}()}setDitheringState(t){t?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(t){t?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}setDirectViewport(t,U,y,I){const r=this._cachedViewport;return this._cachedViewport=null,this._viewport(t,U,y,I),r}scissorClear(t,U,y,I,r){this.enableScissor(t,U,y,I),this.clear(r,!0,!0,!0),this.disableScissor()}enableScissor(t,U,y,I){const r=this._gl;r.enable(r.SCISSOR_TEST),r.scissor(t,U,y,I)}disableScissor(){const t=this._gl;t.disable(t.SCISSOR_TEST)}async _loadFileAsync(t,U,y){return await new Promise(((I,r)=>{this._loadFile(t,(t=>{I(t)}),void 0,U,y,((t,U)=>{r(U)}))}))}getVertexShaderSource(t){const U=this._gl.getAttachedShaders(t);return U?this._gl.getShaderSource(U[0]):null}getFragmentShaderSource(t){const U=this._gl.getAttachedShaders(t);return U?this._gl.getShaderSource(U[1]):null}set framebufferDimensionsObject(t){this._framebufferDimensionsObject=t,this._framebufferDimensionsObject&&this.onResizeObservable.notifyObservers(this)}_rebuildBuffers(){for(const t of this.scenes)t.resetCachedMaterial(),t._rebuildGeometries();for(const t of this._virtualScenes)t.resetCachedMaterial(),t._rebuildGeometries();super._rebuildBuffers()}getFontOffset(t){return function(t){const U=document.createElement("span");U.textContent="Hg",U.style.font=t;const y=document.createElement("div");y.style.display="inline-block",y.style.width="1px",y.style.height="0px",y.style.verticalAlign="bottom";const I=document.createElement("div");I.style.whiteSpace="nowrap",I.appendChild(U),I.appendChild(y),document.body.appendChild(I);let r=0,Y=0;try{Y=y.getBoundingClientRect().top-U.getBoundingClientRect().top,y.style.verticalAlign="baseline",r=y.getBoundingClientRect().top-U.getBoundingClientRect().top}finally{document.body.removeChild(I)}return{ascent:r,height:Y,descent:Y-r}}(t)}_cancelFrame(){if(this.customAnimationFrameRequester){if(0!==this._frameHandler){this._frameHandler=0;const{cancelAnimationFrame:t}=this.customAnimationFrameRequester;t&&t(this.customAnimationFrameRequester.M)}}else super._cancelFrame()}_renderLoop(t){this._processFrame(t),this._activeRenderLoops.length>0&&0===this._frameHandler&&(this.customAnimationFrameRequester?(this.customAnimationFrameRequester.M=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.M):this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()))}enterPointerlock(){this._renderingCanvas&&b(this._renderingCanvas)}exitPointerlock(){document.exitPointerLock&&document.exitPointerLock()}hX(){this._measureFps(),super.hX()}_deletePipelineContext(t){const U=t;U&&U.program&&U.transformFeedback&&(this.deleteTransformFeedback(U.transformFeedback),U.transformFeedback=null),super._deletePipelineContext(t)}createShaderProgram(t,U,y,I,r){let Y=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;r=r||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);const mt=super.createShaderProgram(t,U,y,I,r,Y);return this.onAfterShaderCompilationObservable.notifyObservers(this),mt}_createShaderProgram(t,U,y,I){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const Y=I.createProgram();if(t.program=Y,!Y)throw new Error("Unable to create program");if(I.attachShader(Y,U),I.attachShader(Y,y),this.webGLVersion>1&&r){const U=this.createTransformFeedback();this.bindTransformFeedback(U),this.setTranformFeedbackVaryings(Y,r),t.transformFeedback=U}return I.linkProgram(Y),this.webGLVersion>1&&r&&this.bindTransformFeedback(null),t.context=I,t.vertexShader=U,t.fragmentShader=y,t.isParallelCompiled||this._finalizePipelineContext(t),Y}_releaseTexture(t){super._releaseTexture(t)}_releaseRenderTargetWrapper(t){super._releaseRenderTargetWrapper(t);for(const U of this.scenes){for(const y of U.postProcesses)y._outputTexture===t&&(y._outputTexture=null);for(const y of U.cameras)for(const U of y._postProcesses)U&&U._outputTexture===t&&(U._outputTexture=null)}}_rescaleTexture(t,U,y,I,r){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);const Y=this.createRenderTargetTexture({width:U.width,height:U.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});if(!this._rescalePostProcess&&f._RescalePostProcessFactory&&(this._rescalePostProcess=f._RescalePostProcessFactory(this)),this._rescalePostProcess){this._rescalePostProcess.externalTextureSamplerBinding=!0;const mt=()=>{this._rescalePostProcess.onApply=function(U){U._bindTexture("textureSampler",t)};let mt=y;mt||(mt=this.scenes[this.scenes.length-1]),mt.postProcessManager.directRender([this._rescalePostProcess],Y,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,U,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,I,0,0,U.width,U.height,0),this.unBindFramebuffer(Y),Y.dispose(),r&&r()},X=this._rescalePostProcess.getEffect();X?X.executeWhenCompiled(mt):this._rescalePostProcess.onEffectCreatedObservable.addOnce((t=>{t.executeWhenCompiled(mt)}))}}wrapWebGLTexture(t){let U=arguments.length>1&&void 0!==arguments[1]&&arguments[1],y=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,Y=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;const mt=new L.d(t,this._gl),X=new I.e(this,0,!0);return X._hardwareTexture=mt,X.baseWidth=r,X.baseHeight=Y,X.width=r,X.height=Y,X.isReady=!0,X.useMipMaps=U,this.updateTextureSamplingMode(y,X),X}_uploadImageToTexture(t,U){let y=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,I=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const r=this._gl,Y=this._getWebGLTextureType(t.type),mt=this._getInternalFormat(t.format),X=this._getRGBABufferInternalSizedFormat(t.type,mt),P=t.isCube?r.TEXTURE_CUBE_MAP:r.TEXTURE_2D;this._bindTextureDirectly(P,t,!0),this._unpackFlipY(t.invertY);let G=r.TEXTURE_2D;t.isCube&&(G=r.TEXTURE_CUBE_MAP_POSITIVE_X+y),r.texImage2D(G,I,X,mt,Y,U),this._bindTextureDirectly(P,null,!0)}updateTextureComparisonFunction(t,U){if(1===this.webGLVersion)return void M.b.Error("WebGL 1 does not support texture comparison.");const y=this._gl;t.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,t,!0),0===U?(y.texParameteri(y.TEXTURE_CUBE_MAP,y.TEXTURE_COMPARE_FUNC,515),y.texParameteri(y.TEXTURE_CUBE_MAP,y.TEXTURE_COMPARE_MODE,y.NONE)):(y.texParameteri(y.TEXTURE_CUBE_MAP,y.TEXTURE_COMPARE_FUNC,U),y.texParameteri(y.TEXTURE_CUBE_MAP,y.TEXTURE_COMPARE_MODE,y.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),0===U?(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_COMPARE_FUNC,515),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_COMPARE_MODE,y.NONE)):(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_COMPARE_FUNC,U),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_COMPARE_MODE,y.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),t._comparisonFunction=U}createInstancesBuffer(t){const U=this._gl.createBuffer();if(!U)throw new Error("Unable to create instance buffer");const y=new G.c(U);return y.fU=t,this.bindArrayBuffer(y),this._gl.bufferData(this._gl.ARRAY_BUFFER,t,this._gl.DYNAMIC_DRAW),y.references=1,y}deleteInstancesBuffer(t){this._gl.deleteBuffer(t)}async _clientWaitAsync(t){let U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,y=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;const I=this._gl;return await new Promise(((r,Y)=>{(0,c.g)((()=>{const y=I.clientWaitSync(t,U,0);if(y==I.WAIT_FAILED)throw new Error("clientWaitSync failed");return y!=I.TIMEOUT_EXPIRED}),r,Y,y)}))}_readPixelsAsync(t,U,y,I,r,Y,mt){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");const X=this._gl,P=X.createBuffer();X.bindBuffer(X.PIXEL_PACK_BUFFER,P),X.bufferData(X.PIXEL_PACK_BUFFER,mt.byteLength,X.STREAM_READ),X.readPixels(t,U,y,I,r,Y,0),X.bindBuffer(X.PIXEL_PACK_BUFFER,null);const G=X.fenceSync(X.SYNC_GPU_COMMANDS_COMPLETE,0);return G?(X.flush(),this._clientWaitAsync(G,0,10).then((()=>(X.deleteSync(G),X.bindBuffer(X.PIXEL_PACK_BUFFER,P),X.getBufferSubData(X.PIXEL_PACK_BUFFER,0,mt),X.bindBuffer(X.PIXEL_PACK_BUFFER,null),X.deleteBuffer(P),mt)))):null}dispose(){this.hideLoadingUI(),this._rescalePostProcess&&this._rescalePostProcess.dispose(),function(t,U){1===r.d.Instances.length&&B.e.audioEngine&&(B.e.audioEngine.dispose(),B.e.audioEngine=null);const y=t.getHostWindow();y&&"function"===typeof y.removeEventListener&&(y.removeEventListener("blur",t._onBlur),y.removeEventListener("focus",t._onFocus)),U&&(U.removeEventListener("focus",t._onCanvasFocus),U.removeEventListener("blur",t._onCanvasBlur),U.removeEventListener("pointerout",t._onCanvasPointerOut),U.removeEventListener("contextmenu",t._onCanvasContextMenu)),(0,g.h)()&&(document.removeEventListener("fullscreenchange",t._onFullscreenChange),document.removeEventListener("mozfullscreenchange",t._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",t._onFullscreenChange),document.removeEventListener("msfullscreenchange",t._onFullscreenChange),document.removeEventListener("pointerlockchange",t._onPointerLockChange),document.removeEventListener("mspointerlockchange",t._onPointerLockChange),document.removeEventListener("mozpointerlockchange",t._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",t._onPointerLockChange))}(this,this._renderingCanvas),super.dispose()}}f.ALPHA_DISABLE=0,f.ALPHA_ADD=1,f.ALPHA_COMBINE=2,f.ALPHA_SUBTRACT=3,f.ALPHA_MULTIPLY=4,f.ALPHA_MAXIMIZED=5,f.ALPHA_ONEONE=6,f.ALPHA_PREMULTIPLIED=7,f.ALPHA_PREMULTIPLIED_PORTERDUFF=8,f.ALPHA_INTERPOLATE=9,f.ALPHA_SCREENMODE=10,f.DELAYLOADSTATE_NONE=0,f.DELAYLOADSTATE_LOADED=1,f.DELAYLOADSTATE_LOADING=2,f.DELAYLOADSTATE_NOTLOADED=4,f.NEVER=512,f.ALWAYS=519,f.LESS=513,f.EQUAL=514,f.LEQUAL=515,f.GREATER=516,f.GEQUAL=518,f.NOTEQUAL=517,f.KEEP=7680,f.REPLACE=7681,f.INCR=7682,f.DECR=7683,f.INVERT=5386,f.INCR_WRAP=34055,f.DECR_WRAP=34056,f.TEXTURE_CLAMP_ADDRESSMODE=0,f.TEXTURE_WRAP_ADDRESSMODE=1,f.TEXTURE_MIRROR_ADDRESSMODE=2,f.TEXTUREFORMAT_ALPHA=0,f.TEXTUREFORMAT_LUMINANCE=1,f.TEXTUREFORMAT_LUMINANCE_ALPHA=2,f.TEXTUREFORMAT_RGB=4,f.TEXTUREFORMAT_RGBA=5,f.TEXTUREFORMAT_RED=6,f.TEXTUREFORMAT_R=6,f.TEXTUREFORMAT_R16_UNORM=33322,f.TEXTUREFORMAT_RG16_UNORM=33324,f.TEXTUREFORMAT_RGB16_UNORM=32852,f.TEXTUREFORMAT_RGBA16_UNORM=32859,f.TEXTUREFORMAT_R16_SNORM=36760,f.TEXTUREFORMAT_RG16_SNORM=36761,f.TEXTUREFORMAT_RGB16_SNORM=36762,f.TEXTUREFORMAT_RGBA16_SNORM=36763,f.TEXTUREFORMAT_RG=7,f.TEXTUREFORMAT_RED_INTEGER=8,f.TEXTUREFORMAT_R_INTEGER=8,f.TEXTUREFORMAT_RG_INTEGER=9,f.TEXTUREFORMAT_RGB_INTEGER=10,f.TEXTUREFORMAT_RGBA_INTEGER=11,f.TEXTURETYPE_UNSIGNED_BYTE=0,f.TEXTURETYPE_UNSIGNED_INT=0,f.TEXTURETYPE_FLOAT=1,f.TEXTURETYPE_HALF_FLOAT=2,f.TEXTURETYPE_BYTE=3,f.TEXTURETYPE_SHORT=4,f.TEXTURETYPE_UNSIGNED_SHORT=5,f.TEXTURETYPE_INT=6,f.TEXTURETYPE_UNSIGNED_INTEGER=7,f.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,f.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,f.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,f.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,f.TEXTURETYPE_UNSIGNED_INT_24_8=12,f.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,f.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,f.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,f.TEXTURE_NEAREST_SAMPLINGMODE=1,f.TEXTURE_BILINEAR_SAMPLINGMODE=2,f.TEXTURE_TRILINEAR_SAMPLINGMODE=3,f.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,f.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,f.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,f.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,f.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,f.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,f.TEXTURE_NEAREST_LINEAR=7,f.TEXTURE_NEAREST_NEAREST=1,f.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,f.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,f.TEXTURE_LINEAR_LINEAR=2,f.TEXTURE_LINEAR_NEAREST=12,f.TEXTURE_EXPLICIT_MODE=0,f.TEXTURE_SPHERICAL_MODE=1,f.TEXTURE_PLANAR_MODE=2,f.TEXTURE_CUBIC_MODE=3,f.TEXTURE_PROJECTION_MODE=4,f.TEXTURE_SKYBOX_MODE=5,f.TEXTURE_INVCUBIC_MODE=6,f.TEXTURE_EQUIRECTANGULAR_MODE=7,f.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,f.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,f.SCALEMODE_FLOOR=1,f.SCALEMODE_NEAREST=2,f.SCALEMODE_CEILING=3},12589:(t,U,y)=>{y.d(U,{c:()=>r});var I=y(12565);class r{get depthStencilTexture(){return this._depthStencilTexture}setDepthStencilTexture(t){(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&this._depthStencilTexture&&this._depthStencilTexture.dispose(),this._depthStencilTexture=t,this._generateDepthBuffer=this._generateStencilBuffer=this._depthStencilTextureWithStencil=!1,t&&(this._generateDepthBuffer=!0,this._generateStencilBuffer=this._depthStencilTextureWithStencil=(0,I.e)(t.format))}get depthStencilTextureWithStencil(){return this._depthStencilTextureWithStencil}get isCube(){return this._isCube}get isMulti(){return this._isMulti}get is2DArray(){return this.layers>0}get is3D(){return this.depth>0}get size(){return this.width}get width(){return this._size.width??this._size}get height(){return this._size.height??this._size}get layers(){return this._size.layers||0}get depth(){return this._size.depth||0}get texture(){var t;return(null===(t=this._textures)||void 0===t?void 0:t[0])??null}get textures(){return this._textures}get faceIndices(){return this._faceIndices}get layerIndices(){return this._layerIndices}getBaseArrayLayer(t){var U,y;if(!this._textures)return-1;const I=this._textures[t],r=(null===(U=this._layerIndices)||void 0===U?void 0:U[t])??0,Y=(null===(y=this._faceIndices)||void 0===y?void 0:y[t])??0;return I.isCube?6*r+Y:I.is3D?0:r}get samples(){return this._samples}setSamples(t){let U=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],y=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this.samples===t&&!y)return t;const I=this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,t,U):this._engine.updateRenderTargetTextureSampleCount(this,t);return this._samples=t,I}resolveMSAATextures(){this.isMulti?this._engine.resolveMultiFramebuffer(this):this._engine.resolveFramebuffer(this)}generateMipMaps(){this._engine._currentRenderTarget===this&&this._engine.unBindFramebuffer(this,!0),this.isMulti?this._engine.generateMipMapsMultiFramebuffer(this):this._engine.generateMipMapsFramebuffer(this)}constructor(t,U,y,I,r){this._textures=null,this._faceIndices=null,this._layerIndices=null,this._samples=1,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this.disableAutomaticMSAAResolve=!1,this.resolveMSAAColors=!0,this.resolveMSAADepth=!1,this.resolveMSAAStencil=!1,this._isMulti=t,this._isCube=U,this._size=y,this._engine=I,this._depthStencilTexture=null,this.label=r}setTextures(t){Array.isArray(t)?this._textures=t:this._textures=t?[t]:null}setTexture(t){let U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,y=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._textures||(this._textures=[]),this._textures[U]!==t&&(this._textures[U]&&y&&this._textures[U].dispose(),this._textures[U]=t)}setLayerAndFaceIndices(t,U){this._layerIndices=t,this._faceIndices=U}setLayerAndFaceIndex(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,U=arguments.length>1?arguments[1]:void 0,y=arguments.length>2?arguments[2]:void 0;this._layerIndices||(this._layerIndices=[]),this._faceIndices||(this._faceIndices=[]),void 0!==U&&U>=0&&(this._layerIndices[t]=U),void 0!==y&&y>=0&&(this._faceIndices[t]=y)}createDepthStencilTexture(){var t;let U=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,y=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],I=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,Y=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14,mt=arguments.length>5?arguments[5]:void 0;return null===(t=this._depthStencilTexture)||void 0===t||t.dispose(),this._depthStencilTextureWithStencil=I,this._depthStencilTextureLabel=mt,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:y,comparisonFunction:U,generateStencil:I,isCube:this._isCube,samples:r,depthTextureFormat:Y,label:mt},this),this._depthStencilTexture}_shareDepth(t){this.shareDepth(t)}shareDepth(t){this._depthStencilTexture&&(t._depthStencilTexture&&t._depthStencilTexture.dispose(),t._depthStencilTexture=this._depthStencilTexture,t._depthStencilTextureWithStencil=this._depthStencilTextureWithStencil,this._depthStencilTexture.incrementReferences())}_swapAndDie(t){this.texture&&this.texture._swapAndDie(t),this._textures=null,this.dispose(!0)}_cloneRenderTargetWrapper(){let t=null;if(this._isMulti){const U=this.textures;if(U&&U.length>0){let y=!1,I=U.length,r=-1;const Y=U[U.length-1]._source;14!==Y&&12!==Y||(y=!0,r=U[U.length-1].format,I--);const mt=[],X=[],P=[],G=[],M=[],L=[],h=[],Q={};for(let t=0;t<I;++t){const y=U[t];mt.push(y.samplingMode),X.push(y.type),P.push(y.format);void 0!==Q[y.uniqueId]?(G.push(-1),h.push(0)):(Q[y.uniqueId]=t,y.is2DArray?(G.push(35866),h.push(y.depth)):y.isCube?(G.push(34067),h.push(0)):y.is3D?(G.push(32879),h.push(y.depth)):(G.push(3553),h.push(0))),this._faceIndices&&M.push(this._faceIndices[t]??0),this._layerIndices&&L.push(this._layerIndices[t]??0)}const F={samplingModes:mt,generateMipMaps:U[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:y,depthTextureFormat:r,types:X,formats:P,textureCount:I,targetTypes:G,faceIndex:M,layerIndex:L,layerCounts:h,label:this.label},E={width:this.width,height:this.height,depth:this.depth};t=this._engine.createMultipleRenderTarget(E,F);for(let w=0;w<I;++w){if(-1!==G[w])continue;const y=Q[U[w].uniqueId];t.setTexture(t.textures[y],w)}}}else{var U,y,I,r;const mt={};if(mt.generateDepthBuffer=this._generateDepthBuffer,mt.generateMipMaps=(null===(U=this.texture)||void 0===U?void 0:U.generateMipMaps)??!1,mt.generateStencilBuffer=this._generateStencilBuffer,mt.samplingMode=null===(y=this.texture)||void 0===y?void 0:y.samplingMode,mt.type=null===(I=this.texture)||void 0===I?void 0:I.type,mt.format=null===(r=this.texture)||void 0===r?void 0:r.format,mt.noColorAttachment=!this._textures,mt.label=this.label,this.isCube)t=this._engine.createRenderTargetCubeTexture(this.width,mt);else{var Y;const U={width:this.width,height:this.height,layers:this.is2DArray||this.is3D?null===(Y=this.texture)||void 0===Y?void 0:Y.depth:void 0};t=this._engine.createRenderTargetTexture(U,mt)}t.texture&&(t.texture.isReady=!0)}return t}_swapRenderTargetWrapper(t){if(this._textures&&t._textures)for(let U=0;U<this._textures.length;++U)this._textures[U]._swapAndDie(t._textures[U],!1),t._textures[U].isReady=!0;this._depthStencilTexture&&t._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(t._depthStencilTexture),t._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null}_rebuild(){const t=this._cloneRenderTargetWrapper();if(t){if(this._depthStencilTexture){const U=this._depthStencilTexture.samplingMode,y=this._depthStencilTexture.format,I=2===U||3===U||11===U;t.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,I,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples,y,this._depthStencilTextureLabel)}this.samples>1&&t.setSamples(this.samples),t._swapRenderTargetWrapper(this),t.dispose()}}releaseTextures(){if(this._textures)for(let t=0;t<this._textures.length;++t)this._textures[t].dispose();this._textures=null}dispose(){var t;arguments.length>0&&void 0!==arguments[0]&&arguments[0]||(null===(t=this._depthStencilTexture)||void 0===t||t.dispose(),this._depthStencilTexture=null,this.releaseTextures());this._engine._releaseRenderTargetWrapper(this)}}},12543:(t,U,y)=>{y.r(U),y.d(U,{ThinEngine:()=>B});var I=y(12306),r=y(12545),Y=y(12221),mt=y(12212);class X{constructor(){this.shaderLanguage=0}postProcessor(t,U,y,I,r){if(r.drawBuffersExtensionDisabled){const U=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;t=t.replace(U,"")}return t}}const P=/(flat\s)?\s*varying\s*.*/;class G{constructor(){this.shaderLanguage=0}attributeProcessor(t){return t.replace("attribute","in")}varyingCheck(t,U){return P.test(t)}varyingProcessor(t,U){return t.replace("varying",U?"in":"out")}postProcessor(t,U,y){const I=-1!==t.search(/#extension.+GL_EXT_draw_buffers.+require/);if(t=(t=t.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),y){const U=-1!==t.search(/layout *\(location *= *0\) *out/g);t=(t=(t=(t=(t=(t=(t=t.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/void\s+?main\s*\(/g,(I||U?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(")}else{if(-1!==U.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+t}return t}}var M=y(12552),L=y(12349),h=y(12285),Q=y(12560),F=y(12320),E=y(12287),w=y(12273),D=y(12301),l=y(12565);class g{}class B extends h.e{get name(){return this._name}set name(t){this._name=t}get version(){return this._webGLVersion}static get ShadersRepository(){return E.Effect.ShadersRepository}static set ShadersRepository(t){E.Effect.ShadersRepository=t}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(t){this._framebufferDimensionsObject=t}snapshotRenderingReset(){this.snapshotRendering=!1}constructor(t,U,y,r){if(y=y||{},super(U??y.antialias,y,r),this._name="WebGL",this.forcePOTTextures=!1,this.validateShaderPrograms=!1,this.disableUniformBuffers=!1,this._webGLVersion=1,this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},!t)return;let mt=null;if(t.getContext){if(mt=t,void 0===y.o&&(y.o=!1),void 0===y.xrCompatible&&(y.xrCompatible=!1),navigator&&navigator.userAgent){this._setupMobileChecks();const t=navigator.userAgent;for(const U of B.ExceptionList){const I=U.key,r=U.targets;if(new RegExp(I).test(t)){if(U.capture&&U.captureConstraint){const y=U.capture,I=U.captureConstraint,r=new RegExp(y).exec(t);if(r&&r.length>0){if(parseInt(r[r.length-1])>=I)continue}}for(const t of r)switch(t){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":y.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1}}}}if(this._doNotHandleContextLost?this._onContextLost=()=>{(0,I.B)(this._gl)}:(this._onContextLost=t=>{t.preventDefault(),this._contextWasLost=!0,(0,I.B)(this._gl),Y.b.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost((()=>this._initGLContext()))},mt.addEventListener("webglcontextrestored",this._onContextRestored,!1),y.powerPreference=y.powerPreference||"high-performance"),mt.addEventListener("webglcontextlost",this._onContextLost,!1),this._badDesktopOS&&(y.xrCompatible=!1),!y.disableWebGL2Support)try{this._gl=mt.getContext("webgl2",y)||mt.getContext("experimental-webgl2",y),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch(L){}if(!this._gl){if(!mt)throw new Error("The provided canvas is null or undefined.");try{this._gl=mt.getContext("webgl",y)||mt.getContext("experimental-webgl",y)}catch(L){throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=t,mt=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const U=this._gl.getContextAttributes();U&&(y.EX=U.EX)}this._sharedInit(mt),this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),void 0!==y.useHighPrecisionFloats&&(this._highPrecisionShadersAllowed=y.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let I=0;I<this._caps.maxVertexAttribs;I++)this._currentBufferPointers[I]=new g;this._shaderProcessor=this.webGLVersion>1?new G:new X;const P=`Babylon.js v${B.Version}`;Y.b.Log(P+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",P);const M=(0,I.D)(this._gl);M.validateShaderPrograms=this.validateShaderPrograms,M.parallelShaderCompile=this._caps.parallelShaderCompile}_clearEmptyResources(){this._dummyFramebuffer=null,super._clearEmptyResources()}_getShaderProcessingContext(t){return null}areAllEffectsReady(){for(const t in this._compiledEffects){if(!this._compiledEffects[t].isReady())return!1}return!0}_initGLContext(){this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||null!==this._gl.getExtension("OES_standard_derivatives"),maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||null!==this._gl.getExtension("OES_element_index_uint"),fragmentDepthSupported:this._webGLVersion>1||null!==this._gl.getExtension("EXT_frag_depth"),highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,colorBufferHalfFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_half_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:1!==this._webGLVersion,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1,textureNorm16:!!this._gl.getExtension("EXT_texture_norm16")},this._caps.supportFloatTexturesResolve=this._caps.colorBufferFloat,this._caps.rg11b10ufColorRenderable=this._caps.colorBufferFloat,this._glVersion=this._gl.getParameter(this._gl.VERSION);const t=this._gl.getExtension("WEBGL_debug_renderer_info");if(null!=t&&(this._glRenderer=this._gl.getParameter(t.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(t.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),36193!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=36193),34842!==this._gl.RGBA16F&&(this._gl.RGBA16F=34842),34836!==this._gl.RGBA32F&&(this._gl.RGBA32F=34836),35056!==this._gl.DEPTH24_STENCIL8&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(1===this._webGLVersion&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=(this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)??0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!(!this._caps.textureFloat||!this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!(!this._caps.textureFloat||!this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.textureNorm16&&(this._gl.R16_EXT=33322,this._gl.RG16_EXT=33324,this._gl.RGB16_EXT=32852,this._gl.RGBA16_EXT=32859,this._gl.R16_SNORM_EXT=36760,this._gl.RG16_SNORM_EXT=36761,this._gl.RGB16_SNORM_EXT=36762,this._gl.RGBA16_SNORM_EXT=36763),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&5131!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=null!==this._maxMSAASamplesOverride?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES),this._caps.maxDrawBuffers=this._gl.getParameter(this._gl.MAX_DRAW_BUFFERS);else{const t=this._gl.getExtension("WEBGL_draw_buffers");if(null!==t){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=t.drawBuffersWEBGL.bind(t),this._caps.maxDrawBuffers=this._gl.getParameter(t.MAX_DRAW_BUFFERS_WEBGL),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let U=0;U<16;U++)this._gl["COLOR_ATTACHMENT"+U+"_WEBGL"]=t["COLOR_ATTACHMENT"+U+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{const t=this._gl.getExtension("WEBGL_depth_texture");null!=t&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=t.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{const t=this._gl.getExtension("OES_vertex_array_object");null!=t&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=t.createVertexArrayOES.bind(t),this._gl.bindVertexArray=t.bindVertexArrayOES.bind(t),this._gl.deleteVertexArray=t.deleteVertexArrayOES.bind(t))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{const t=this._gl.getExtension("ANGLE_instanced_arrays");null!=t?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=t.drawArraysInstancedANGLE.bind(t),this._gl.drawElementsInstanced=t.drawElementsInstancedANGLE.bind(t),this._gl.vertexAttribDivisor=t.vertexAttribDivisorANGLE.bind(t)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){const t=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),U=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);t&&U&&(this._caps.highPrecisionShaderSupported=0!==t.precision&&0!==U.precision)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{const t=this._gl.getExtension("EXT_blend_minmax");null!=t&&(this._caps.blendMinMax=!0,this._gl.MAX=t.MAX_EXT,this._gl.MIN=t.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:WebGL2RenderingContext.SRGB,SRGB8:WebGL2RenderingContext.SRGB8,SRGB8_ALPHA8:WebGL2RenderingContext.SRGB8_ALPHA8};else{const t=this._gl.getExtension("EXT_sRGB");null!=t&&(this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:t.SRGB_EXT,SRGB8:t.SRGB_ALPHA_EXT,SRGB8_ALPHA8:t.SRGB_ALPHA_EXT})}if(this._creationOptions){const t=this._creationOptions.forceSRGBBufferSupportState;void 0!==t&&(this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&t)}}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let U=0;U<this._maxSimultaneousTextures;U++)this._nextFreeTextureSlots.push(U);"Mali-G72"===this._glRenderer&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:"undefined"===typeof HTMLImageElement,supportRenderAndCopyToLodForFloatTextures:1!==this._webGLVersion,supportDepthStencilTexture:1!==this._webGLVersion,supportShadowSamplers:1!==this._webGLVersion,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:1!==this._webGLVersion,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:1!==this._webGLVersion,basisNeedsPOT:1===this._webGLVersion,support3DTextures:1!==this._webGLVersion,needTypeSuffixInShaderConstants:1!==this._webGLVersion,supportMSAA:1!==this._webGLVersion,supportSSAO2:1!==this._webGLVersion,supportIBLShadows:1!==this._webGLVersion,supportExtendedTextureFormats:1!==this._webGLVersion,supportSwitchCaseInShader:1!==this._webGLVersion,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,forceVertexBufferStrideAndOffsetMultiple4Bytes:!1,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const t=this._workingCanvas.getContext("2d");t&&(this._workingContext=t)}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}extractDriverInfo(){const t=this.getGlInfo();return t&&t.renderer?t.renderer:""}getRenderWidth(){return!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(){return!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}clear(t,U,y){let I=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const r=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=r;let Y=0;if(U&&t){let U=!0;if(this._currentRenderTarget){var mt;const y=null===(mt=this._currentRenderTarget.texture)||void 0===mt?void 0:mt.format;if(8===y||9===y||10===y||11===y){var X;const y=null===(X=this._currentRenderTarget.texture)||void 0===X?void 0:X.type;7===y||5===y?(B._TempClearColorUint32[0]=255*t.r,B._TempClearColorUint32[1]=255*t.g,B._TempClearColorUint32[2]=255*t.b,B._TempClearColorUint32[3]=255*t.a,this._gl.clearBufferuiv(this._gl.COLOR,0,B._TempClearColorUint32),U=!1):(B._TempClearColorInt32[0]=255*t.r,B._TempClearColorInt32[1]=255*t.g,B._TempClearColorInt32[2]=255*t.b,B._TempClearColorInt32[3]=255*t.a,this._gl.clearBufferiv(this._gl.COLOR,0,B._TempClearColorInt32),U=!1)}}U&&(this._gl.clearColor(t.r,t.g,t.b,void 0!==t.a?t.a:1),Y|=this._gl.COLOR_BUFFER_BIT)}y&&(this.LX?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),Y|=this._gl.DEPTH_BUFFER_BIT),I&&(this._gl.clearStencil(0),Y|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(Y)}_viewport(t,U,y,I){t===this._viewportCached.x&&U===this._viewportCached.y&&y===this._viewportCached.z&&I===this._viewportCached.w||(this._viewportCached.x=t,this._viewportCached.y=U,this._viewportCached.z=y,this._viewportCached.w=I,this._gl.viewport(t,U,y,I))}QX(){super.QX(),this._badOS&&this.flushFramebuffer()}get performanceMonitor(){throw new Error("Not Supported by ThinEngine")}bindFramebuffer(t){let U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,y=arguments.length>2?arguments[2]:void 0,I=arguments.length>3?arguments[3]:void 0,r=arguments.length>4?arguments[4]:void 0,mt=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,X=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;const P=t;this._currentRenderTarget&&this._resolveAndGenerateMipMapsFramebuffer(this._currentRenderTarget),this._currentRenderTarget=t,this._bindUnboundFramebuffer(P._framebuffer);const G=this._gl;var M;if(!t.isMulti)if(t.is2DArray||t.is3D)G.framebufferTextureLayer(G.FRAMEBUFFER,G.COLOR_ATTACHMENT0,null===(M=t.texture._hardwareTexture)||void 0===M?void 0:M.underlyingResource,mt,X),P._currentLOD=mt;else if(t.isCube){var L;G.framebufferTexture2D(G.FRAMEBUFFER,G.COLOR_ATTACHMENT0,G.TEXTURE_CUBE_MAP_POSITIVE_X+U,null===(L=t.texture._hardwareTexture)||void 0===L?void 0:L.underlyingResource,mt)}else if(P._currentLOD!==mt){var h;G.framebufferTexture2D(G.FRAMEBUFFER,G.COLOR_ATTACHMENT0,G.TEXTURE_2D,null===(h=t.texture._hardwareTexture)||void 0===h?void 0:h.underlyingResource,mt),P._currentLOD=mt}const Q=t._depthStencilTexture;if(Q){t.is3D&&(t.texture.width===Q.width&&t.texture.height===Q.height&&t.texture.depth===Q.depth||Y.b.Warn("Depth/Stencil attachment for 3D target must have same dimensions as color attachment"));const y=t._depthStencilTextureWithStencil?G.DEPTH_STENCIL_ATTACHMENT:G.DEPTH_ATTACHMENT;var F;if(t.is2DArray||t.is3D)G.framebufferTextureLayer(G.FRAMEBUFFER,y,null===(F=Q._hardwareTexture)||void 0===F?void 0:F.underlyingResource,mt,X);else if(t.isCube){var E;G.framebufferTexture2D(G.FRAMEBUFFER,y,G.TEXTURE_CUBE_MAP_POSITIVE_X+U,null===(E=Q._hardwareTexture)||void 0===E?void 0:E.underlyingResource,mt)}else{var w;G.framebufferTexture2D(G.FRAMEBUFFER,y,G.TEXTURE_2D,null===(w=Q._hardwareTexture)||void 0===w?void 0:w.underlyingResource,mt)}}P._MSAAFramebuffer&&this._bindUnboundFramebuffer(P._MSAAFramebuffer),this._cachedViewport&&!r?this.setViewport(this._cachedViewport,y,I):(y||(y=t.width,mt&&(y/=Math.pow(2,mt))),I||(I=t.height,mt&&(I/=Math.pow(2,mt))),this._viewport(0,0,y,I)),this.wipeCaches()}setStateCullFaceType(t,U){const y=this.cullBackFaces??t??1?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==y||U)&&(this._depthCullingState.cullFace=y)}setState(t){let U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,y=arguments.length>2?arguments[2]:void 0,I=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=arguments.length>4?arguments[4]:void 0,Y=arguments.length>5?arguments[5]:void 0,mt=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;(this._depthCullingState.cull!==t||y)&&(this._depthCullingState.cull=t),this.setStateCullFaceType(r,y),this.setZOffset(U),this.setZOffsetUnits(mt);const X=I?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==X||y)&&(this._depthCullingState.frontFace=X),this._stencilStateComposer.stencilMaterial=Y}_resolveAndGenerateMipMapsFramebuffer(t){let U=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t.disableAutomaticMSAAResolve||(t.isMulti?this.resolveMultiFramebuffer(t):this.resolveFramebuffer(t)),U||(t.isMulti?this.generateMipMapsMultiFramebuffer(t):this.generateMipMapsFramebuffer(t))}_bindUnboundFramebuffer(t){this._currentFramebuffer!==t&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,t),this._currentFramebuffer=t)}_currentFrameBufferIsDefaultFrameBuffer(){return null===this._currentFramebuffer}generateMipmaps(t){const U=this._getTextureTarget(t);this._bindTextureDirectly(U,t,!0),this._gl.generateMipmap(U),this._bindTextureDirectly(U,null)}unBindFramebuffer(t,U,y){const I=t;this._currentRenderTarget=null,this._resolveAndGenerateMipMapsFramebuffer(t,U),y&&(I._MSAAFramebuffer&&this._bindUnboundFramebuffer(I._framebuffer),y()),this._bindUnboundFramebuffer(null)}generateMipMapsFramebuffer(t){var U;t.isMulti||null===(U=t.texture)||void 0===U||!U.generateMipMaps||t.isCube||this.generateMipmaps(t.texture)}resolveFramebuffer(t){const U=t,y=this._gl;if(!U._MSAAFramebuffer||U.isMulti)return;let I=U.resolveMSAAColors?y.COLOR_BUFFER_BIT:0;I|=U._generateDepthBuffer&&U.resolveMSAADepth?y.DEPTH_BUFFER_BIT:0,I|=U._generateStencilBuffer&&U.resolveMSAAStencil?y.STENCIL_BUFFER_BIT:0,y.bindFramebuffer(y.READ_FRAMEBUFFER,U._MSAAFramebuffer),y.bindFramebuffer(y.DRAW_FRAMEBUFFER,U._framebuffer),y.blitFramebuffer(0,0,t.width,t.height,0,0,t.width,t.height,I,y.NEAREST)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(t,U,y){return this._createVertexBuffer(t,this._gl.STATIC_DRAW)}_createVertexBuffer(t,U){const y=this._gl.createBuffer();if(!y)throw new Error("Unable to create vertex buffer");const I=new M.c(y);return this.bindArrayBuffer(I),"number"!==typeof t?t instanceof Array?(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(t),U),I.fU=4*t.length):(this._gl.bufferData(this._gl.ARRAY_BUFFER,t,U),I.fU=t.byteLength):(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Uint8Array(t),U),I.fU=t),this._resetVertexBufferBinding(),I.references=1,I}createDynamicVertexBuffer(t,U){return this._createVertexBuffer(t,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(t,U,y){const I=this._gl.createBuffer(),r=new M.c(I);if(!I)throw new Error("Unable to create index buffer");this.bindIndexBuffer(r);const Y=this._normalizeIndexData(t);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,Y,U?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),r.references=1,r.is32Bits=4===Y.BYTES_PER_ELEMENT,r}_normalizeIndexData(t){if(2===t.BYTES_PER_ELEMENT)return t;if(this._caps.uintIndices){if(t instanceof Uint32Array)return t;for(let U=0;U<t.length;U++)if(t[U]>=65535)return new Uint32Array(t);return new Uint16Array(t)}return new Uint16Array(t)}bindArrayBuffer(t){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(t,this._gl.ARRAY_BUFFER)}bindUniformBlock(t,U,y){const I=t.program,r=this._gl.getUniformBlockIndex(I,U);this._gl.uniformBlockBinding(I,r,y)}bindIndexBuffer(t){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(t,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(t,U){(this._vaoRecordInProgress||this._currentBoundBuffer[U]!==t)&&(this._gl.bindBuffer(U,t?t.underlyingResource:null),this._currentBoundBuffer[U]=t)}updateArrayBuffer(t){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t)}_vertexAttribPointer(t,U,y,I,r,Y,mt){const X=this._currentBufferPointers[U];if(!X)return;let P=!1;X.active?(X.buffer!==t&&(X.buffer=t,P=!0),X.size!==y&&(X.size=y,P=!0),X.type!==I&&(X.type=I,P=!0),X.normalized!==r&&(X.normalized=r,P=!0),X.stride!==Y&&(X.stride=Y,P=!0),X.offset!==mt&&(X.offset=mt,P=!0)):(P=!0,X.active=!0,X.index=U,X.size=y,X.type=I,X.normalized=r,X.stride=Y,X.offset=mt,X.buffer=t),(P||this._vaoRecordInProgress)&&(this.bindArrayBuffer(t),I===this._gl.UNSIGNED_INT||I===this._gl.INT?this._gl.vertexAttribIPointer(U,y,I,Y,mt):this._gl.vertexAttribPointer(U,y,I,r,Y,mt))}_bindIndexBufferWithCache(t){null!=t&&this._cachedIndexBuffer!==t&&(this._cachedIndexBuffer=t,this.bindIndexBuffer(t),this._uintIndicesCurrentlySet=t.is32Bits)}_bindVertexBuffersAttributes(t,U,y){const I=U.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let r=0;r<I.length;r++){const Y=U.getAttributeLocation(r);if(Y>=0){const U=I[r];let mt=null;if(y&&(mt=y[U]),mt||(mt=t[U]),!mt)continue;this._gl.enableVertexAttribArray(Y),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[Y]=!0);const X=mt.getBuffer();X&&(this._vertexAttribPointer(X,Y,mt.getSize(),mt.type,mt.normalized,mt.byteStride,mt.byteOffset),mt.getIsInstanced()&&(this._gl.vertexAttribDivisor(Y,mt.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(Y),this._currentInstanceBuffers.push(X))))}}}recordVertexArrayObject(t,U,y,I){const r=this._gl.createVertexArray();if(!r)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(r),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(t,y,I),this.bindIndexBuffer(U),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),r}bindVertexArrayObject(t,U){this._cachedVertexArrayObject!==t&&(this._cachedVertexArrayObject=t,this._gl.bindVertexArray(t),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=null!=U&&U.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(t,U,y,I,r){if(this._cachedVertexBuffers!==t||this._cachedEffectForVertexBuffers!==r){this._cachedVertexBuffers=t,this._cachedEffectForVertexBuffers=r;const U=r.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let Y=0;for(let mt=0;mt<U;mt++)if(mt<y.length){const U=r.getAttributeLocation(mt);U>=0&&(this._gl.enableVertexAttribArray(U),this._vertexAttribArraysEnabled[U]=!0,this._vertexAttribPointer(t,U,y[mt],this._gl.FLOAT,!1,I,Y)),Y+=4*y[mt]}}this._bindIndexBufferWithCache(U)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(t,U,y,I){this._cachedVertexBuffers===t&&this._cachedEffectForVertexBuffers===y||(this._cachedVertexBuffers=t,this._cachedEffectForVertexBuffers=y,this._bindVertexBuffersAttributes(t,y,I)),this._bindIndexBufferWithCache(U)}unbindInstanceAttributes(){let t;for(let U=0,y=this._currentInstanceLocations.length;U<y;U++){const y=this._currentInstanceBuffers[U];t!=y&&y.references&&(t=y,this.bindArrayBuffer(y));const I=this._currentInstanceLocations[U];this._gl.vertexAttribDivisor(I,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(t){this._gl.deleteVertexArray(t)}_releaseBuffer(t){return t.references--,0===t.references&&(this._deleteBuffer(t),!0)}_deleteBuffer(t){this._gl.deleteBuffer(t.underlyingResource)}updateAndBindInstancesBuffer(t,U,y){if(this.bindArrayBuffer(t),U&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,U),void 0!==y[0].index)this.bindInstancesBuffer(t,y,!0);else for(let I=0;I<4;I++){const U=y[I];this._vertexAttribArraysEnabled[U]||(this._gl.enableVertexAttribArray(U),this._vertexAttribArraysEnabled[U]=!0),this._vertexAttribPointer(t,U,4,this._gl.FLOAT,!1,64,16*I),this._gl.vertexAttribDivisor(U,1),this._currentInstanceLocations.push(U),this._currentInstanceBuffers.push(t)}}bindInstancesBuffer(t,U){let y=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.bindArrayBuffer(t);let I=0;if(y)for(let r=0;r<U.length;r++){I+=4*U[r].attributeSize}for(let r=0;r<U.length;r++){const y=U[r];void 0===y.index&&(y.index=this._currentEffect.getAttributeLocationByName(y.attributeName)),y.index<0||(this._vertexAttribArraysEnabled[y.index]||(this._gl.enableVertexAttribArray(y.index),this._vertexAttribArraysEnabled[y.index]=!0),this._vertexAttribPointer(t,y.index,y.attributeSize,y.attributeType||this._gl.FLOAT,y.normalized||!1,I,y.offset),this._gl.vertexAttribDivisor(y.index,void 0===y.divisor?1:y.divisor),this._currentInstanceLocations.push(y.index),this._currentInstanceBuffers.push(t))}}disableInstanceAttributeByName(t){if(!this._currentEffect)return;const U=this._currentEffect.getAttributeLocationByName(t);this.disableInstanceAttribute(U)}disableInstanceAttribute(t){let U,y=!1;for(;-1!==(U=this._currentInstanceLocations.indexOf(t));)this._currentInstanceLocations.splice(U,1),this._currentInstanceBuffers.splice(U,1),y=!0,U=this._currentInstanceLocations.indexOf(t);y&&(this._gl.vertexAttribDivisor(t,0),this.disableAttributeByIndex(t))}disableAttributeByIndex(t){this._gl.disableVertexAttribArray(t),this._vertexAttribArraysEnabled[t]=!1,this._currentBufferPointers[t].active=!1}draw(t,U,y,I){this.drawElementsType(t?0:1,U,y,I)}drawPointClouds(t,U,y){this.drawArraysType(2,t,U,y)}drawUnIndexed(t,U,y,I){this.drawArraysType(t?0:1,U,y,I)}drawElementsType(t,U,y,I){this.applyStates(),this._reportDrawCall();const r=this._drawMode(t),Y=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,mt=this._uintIndicesCurrentlySet?4:2;I?this._gl.drawElementsInstanced(r,y,Y,U*mt,I):this._gl.drawElements(r,y,Y,U*mt)}drawArraysType(t,U,y,I){this.applyStates(),this._reportDrawCall();const r=this._drawMode(t);I?this._gl.drawArraysInstanced(r,U,y,I):this._gl.drawArrays(r,U,y)}_drawMode(t){switch(t){case 0:default:return this._gl.TRIANGLES;case 2:case 3:return this._gl.POINTS;case 1:case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN}}_releaseEffect(t){this._compiledEffects[t._key]&&delete this._compiledEffects[t._key];const U=t.getPipelineContext();U&&this._deletePipelineContext(U)}_deletePipelineContext(t){const U=t;U&&U.program&&(U.program.__SPECTOR_rebuildProgram=null,(0,D.h)(U),this._gl&&(this._currentProgram===U.program&&this._setProgram(null),this._gl.deleteProgram(U.program)))}_getGlobalDefines(t){return(0,w.k)(t,this.isNDCHalfZRange,this.LX,this.useExactSrgbConversions)}createEffect(t,U,y,r,Y,mt,X,P,G){let M=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,L=arguments.length>10?arguments[10]:void 0;const h="string"===typeof t?t:t.vertexToken||t.vertexSource||t.vertexElement||t.vertex,Q="string"===typeof t?t:t.fragmentToken||t.fragmentSource||t.fragmentElement||t.fragment,F=this._getGlobalDefines(),w=void 0!==U.attributes;let D=Y??U.defines??"";F&&(D+=F);const l=h+"+"+Q+"@"+D;if(this._compiledEffects[l]){const t=this._compiledEffects[l];return X&&t.isReady()&&X(t),t._refCount++,t}this._gl&&(0,I.D)(this._gl);const g=new E.Effect(t,U,w?this:y,r,this,Y,mt,X,P,G,l,U.shaderLanguage??M,U.extraInitializationsAsync??L);return this._compiledEffects[l]=g,g}_getShaderSource(t){return this._gl.getShaderSource(t)}createRawShaderProgram(t,U,y,r){let Y=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const mt=(0,I.D)(this._gl);return mt._contextWasLost=this._contextWasLost,mt.validateShaderPrograms=this.validateShaderPrograms,(0,I.v)(t,U,y,r||this._gl,Y)}createShaderProgram(t,U,y,r,Y){let mt=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;const X=(0,I.D)(this._gl);return X._contextWasLost=this._contextWasLost,X.validateShaderPrograms=this.validateShaderPrograms,(0,I.x)(t,U,y,r,Y||this._gl,mt)}inlineShaderCode(t){return t}createPipelineContext(t){if(this._gl){(0,I.D)(this._gl).parallelShaderCompile=this._caps.parallelShaderCompile}const U=(0,I.s)(this._gl,t);return U.wU=this,U}createMaterialContext(){}createDrawContext(){}_finalizePipelineContext(t){return(0,I.h)(t,this._gl,this.validateShaderPrograms)}_preparePipelineContextAsync(t,U,y,r,Y,mt,X,P,G,M,L){const h=(0,I.D)(this._gl);return h._contextWasLost=this._contextWasLost,h.validateShaderPrograms=this.validateShaderPrograms,h._createShaderProgramInjection=this._createShaderProgram.bind(this),h.createRawShaderProgramInjection=this.createRawShaderProgram.bind(this),h.createShaderProgramInjection=this.createShaderProgram.bind(this),h.loadFileInjection=this._loadFile.bind(this),(0,I.o)(t,U,y,r,Y,mt,X,P,G,M,L)}_createShaderProgram(t,U,y,r){let Y=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return(0,I.c)(t,U,y,r,Y)}_isRenderingStateCompiled(t){return!this._isDisposed&&(0,I.k)(t,this._gl,this.validateShaderPrograms)}_executeWhenRenderingStateIsCompiled(t,U){(0,I.e)(t,U)}getUniforms(t,U){const y=new Array,I=t;for(let r=0;r<U.length;r++)y.push(this._gl.getUniformLocation(I.program,U[r]));return y}getAttributes(t,U){const y=[],I=t;for(let Y=0;Y<U.length;Y++)try{y.push(this._gl.getAttribLocation(I.program,U[Y]))}catch(r){y.push(-1)}return y}enableEffect(t){(t=null!==t&&(0,r.c)(t)?t.effect:t)&&t!==this._currentEffect&&(this._stencilStateComposer.stencilMaterial=void 0,this.bindSamplers(t),this._currentEffect=t,t.onBind&&t.onBind(t),t._onBindObservable&&t._onBindObservable.notifyObservers(t))}setInt(t,U){return!!t&&(this._gl.uniform1i(t,U),!0)}setInt2(t,U,y){return!!t&&(this._gl.uniform2i(t,U,y),!0)}setInt3(t,U,y,I){return!!t&&(this._gl.uniform3i(t,U,y,I),!0)}setInt4(t,U,y,I,r){return!!t&&(this._gl.uniform4i(t,U,y,I,r),!0)}setIntArray(t,U){return!!t&&(this._gl.uniform1iv(t,U),!0)}setIntArray2(t,U){return!(!t||U.length%2!==0)&&(this._gl.uniform2iv(t,U),!0)}setIntArray3(t,U){return!(!t||U.length%3!==0)&&(this._gl.uniform3iv(t,U),!0)}setIntArray4(t,U){return!(!t||U.length%4!==0)&&(this._gl.uniform4iv(t,U),!0)}setUInt(t,U){return!!t&&(this._gl.uniform1ui(t,U),!0)}setUInt2(t,U,y){return!!t&&(this._gl.uniform2ui(t,U,y),!0)}setUInt3(t,U,y,I){return!!t&&(this._gl.uniform3ui(t,U,y,I),!0)}setUInt4(t,U,y,I,r){return!!t&&(this._gl.uniform4ui(t,U,y,I,r),!0)}setUIntArray(t,U){return!!t&&(this._gl.uniform1uiv(t,U),!0)}setUIntArray2(t,U){return!(!t||U.length%2!==0)&&(this._gl.uniform2uiv(t,U),!0)}setUIntArray3(t,U){return!(!t||U.length%3!==0)&&(this._gl.uniform3uiv(t,U),!0)}setUIntArray4(t,U){return!(!t||U.length%4!==0)&&(this._gl.uniform4uiv(t,U),!0)}setArray(t,U){return!!t&&(!(U.length<1)&&(this._gl.uniform1fv(t,U),!0))}setArray2(t,U){return!(!t||U.length%2!==0)&&(this._gl.uniform2fv(t,U),!0)}setArray3(t,U){return!(!t||U.length%3!==0)&&(this._gl.uniform3fv(t,U),!0)}setArray4(t,U){return!(!t||U.length%4!==0)&&(this._gl.uniform4fv(t,U),!0)}setMatrices(t,U){return!!t&&(this._gl.uniformMatrix4fv(t,!1,U),!0)}setMatrix3x3(t,U){return!!t&&(this._gl.uniformMatrix3fv(t,!1,U),!0)}setMatrix2x2(t,U){return!!t&&(this._gl.uniformMatrix2fv(t,!1,U),!0)}setFloat(t,U){return!!t&&(this._gl.uniform1f(t,U),!0)}setFloat2(t,U,y){return!!t&&(this._gl.uniform2f(t,U,y),!0)}setFloat3(t,U,y,I){return!!t&&(this._gl.uniform3f(t,U,y,I),!0)}setFloat4(t,U,y,I,r){return!!t&&(this._gl.uniform4f(t,U,y,I,r),!0)}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;const t=this._colorWrite;this._gl.colorMask(t,t,t,t)}}wipeCaches(t){this.preventCacheWipeBetweenFrames&&!t||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),t&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(t,U){const y=this._gl;let I=y.NEAREST,r=y.NEAREST,Y=!1;switch(t){case 11:I=y.LINEAR,r=U?y.LINEAR_MIPMAP_NEAREST:y.LINEAR;break;case 3:I=y.LINEAR,Y=!0,r=U?y.LINEAR_MIPMAP_LINEAR:y.LINEAR;break;case 8:Y=!0,I=y.NEAREST,r=U?y.NEAREST_MIPMAP_LINEAR:y.NEAREST;break;case 4:I=y.NEAREST,r=U?y.NEAREST_MIPMAP_NEAREST:y.NEAREST;break;case 5:I=y.NEAREST,r=U?y.LINEAR_MIPMAP_NEAREST:y.LINEAR;break;case 6:Y=!0,I=y.NEAREST,r=U?y.LINEAR_MIPMAP_LINEAR:y.LINEAR;break;case 7:I=y.NEAREST,r=y.LINEAR;break;case 1:I=y.NEAREST,r=y.NEAREST;break;case 9:I=y.LINEAR,r=U?y.NEAREST_MIPMAP_NEAREST:y.NEAREST;break;case 10:Y=!0,I=y.LINEAR,r=U?y.NEAREST_MIPMAP_LINEAR:y.NEAREST;break;case 2:I=y.LINEAR,r=y.LINEAR;break;case 12:I=y.LINEAR,r=y.NEAREST}return{min:r,mag:I,hasMipMaps:Y}}_createTexture(){const t=this._gl.createTexture();if(!t)throw new Error("Unable to create texture");return t}_createHardwareTexture(){return new Q.d(this._createTexture(),this._gl)}_createInternalTexture(t,U){let y,I=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=!1,mt=!1,X=0,P=3,G=5,M=!1,L=1,h=!1,Q=0;void 0!==U&&"object"===typeof U?(r=!!U.generateMipMaps,mt=!!U.createMipMaps,X=void 0===U.type?0:U.type,P=void 0===U.samplingMode?3:U.samplingMode,G=void 0===U.format?5:U.format,M=void 0!==U.useSRGBBuffer&&U.useSRGBBuffer,L=U.samples??1,y=U.label,h=!!U.createMSAATexture,Q=U.comparisonFunction||0):r=!!U,M&&(M=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(1!==X||this._caps.textureFloatLinearFiltering)&&(2!==X||this._caps.textureHalfFloatLinearFiltering)||(P=1),1!==X||this._caps.textureFloat||(X=0,Y.b.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const E=(0,l.f)(G),w=(0,l.e)(G),D=this._gl,g=new F.e(this,I),B=t.width||t,b=t.height||t,p=t.depth||0,c=t.layers||0,f=this._getSamplingParameters(P,(r||mt)&&!E),S=0!==c?D.TEXTURE_2D_ARRAY:0!==p?D.TEXTURE_3D:D.TEXTURE_2D,N=E?this._getInternalFormatFromDepthTextureFormat(G,!0,w):this._getRGBABufferInternalSizedFormat(X,G,M),j=E?w?D.DEPTH_STENCIL:D.DEPTH_COMPONENT:this._getInternalFormat(G),J=E?this._getWebGLTextureTypeFromDepthTextureFormat(G):this._getWebGLTextureType(X);if(this._bindTextureDirectly(S,g),0!==c?(g.is2DArray=!0,D.texImage3D(S,0,N,B,b,c,0,j,J,null)):0!==p?(g.is3D=!0,D.texImage3D(S,0,N,B,b,p,0,j,J,null)):D.texImage2D(S,0,N,B,b,0,j,J,null),D.texParameteri(S,D.TEXTURE_MAG_FILTER,f.mag),D.texParameteri(S,D.TEXTURE_MIN_FILTER,f.min),D.texParameteri(S,D.TEXTURE_WRAP_S,D.CLAMP_TO_EDGE),D.texParameteri(S,D.TEXTURE_WRAP_T,D.CLAMP_TO_EDGE),E&&this.webGLVersion>1&&(0===Q?(D.texParameteri(S,D.TEXTURE_COMPARE_FUNC,515),D.texParameteri(S,D.TEXTURE_COMPARE_MODE,D.NONE)):(D.texParameteri(S,D.TEXTURE_COMPARE_FUNC,Q),D.texParameteri(S,D.TEXTURE_COMPARE_MODE,D.COMPARE_REF_TO_TEXTURE))),(r||mt)&&this._gl.generateMipmap(S),this._bindTextureDirectly(S,null),g._useSRGBBuffer=M,g.baseWidth=B,g.baseHeight=b,g.width=B,g.height=b,g.depth=c||p,g.isReady=!0,g.samples=L,g.generateMipMaps=r,g.samplingMode=P,g.type=X,g.format=G,g.label=y,g.comparisonFunction=Q,this._internalTexturesCache.push(g),h){let t=null;if(t=(0,l.f)(g.format)?this._setupFramebufferDepthAttachments((0,l.e)(g.format),19!==g.format,g.width,g.height,L,g.format,!0):this._createRenderBuffer(g.width,g.height,L,-1,this._getRGBABufferInternalSizedFormat(g.type,g.format,g._useSRGBBuffer),-1),!t)throw new Error("Unable to create render buffer");g._autoMSAAManagement=!0;let U=g._hardwareTexture;U||(U=g._hardwareTexture=this._createHardwareTexture()),U.addMSAARenderBuffer(t)}return g}_getUseSRGBBuffer(t,U){return t&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||U)}createTexture(t,U,y,I){var r=this;let Y=arguments.length>4&&void 0!==arguments[4]?arguments[4]:3,mt=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,X=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,P=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,G=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,M=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,L=arguments.length>10&&void 0!==arguments[10]?arguments[10]:null,h=arguments.length>11?arguments[11]:void 0,Q=arguments.length>12?arguments[12]:void 0,E=arguments.length>13?arguments[13]:void 0,w=arguments.length>14?arguments[14]:void 0;return this._createTextureBase(t,U,y,I,Y,mt,X,(function(){for(var t=arguments.length,U=new Array(t),y=0;y<t;y++)U[y]=arguments[y];return r._prepareWebGLTexture(...U,M)}),((t,U,y,r,Y,mt)=>{const X=this._gl,P=y.width===t&&y.height===U;Y._creationFlags=E??0;const G=this._getTexImageParametersForCreateTexture(Y.format,Y._useSRGBBuffer);if(P)return X.texImage2D(X.TEXTURE_2D,0,G.internalFormat,G.format,G.type,y),!1;const M=this._caps.maxTextureSize;if(y.width>M||y.height>M||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!(!this._workingCanvas||!this._workingContext)&&(this._workingCanvas.width=t,this._workingCanvas.height=U,this._workingContext.drawImage(y,0,0,y.width,y.height,0,0,t,U),X.texImage2D(X.TEXTURE_2D,0,G.internalFormat,G.format,G.type,this._workingCanvas),Y.width=t,Y.height=U,!1);{const t=new F.e(this,2);this._bindTextureDirectly(X.TEXTURE_2D,t,!0),X.texImage2D(X.TEXTURE_2D,0,G.internalFormat,G.format,G.type,y),this._rescaleTexture(t,Y,I,G.format,(()=>{this._releaseTexture(t),this._bindTextureDirectly(X.TEXTURE_2D,Y,!0),mt()}))}return!0}),P,G,M,L,h,Q,w)}_getTexImageParametersForCreateTexture(t,U){let y,I;return 1===this.webGLVersion?(y=this._getInternalFormat(t,U),I=y):(y=this._getInternalFormat(t,!1),I=this._getRGBABufferInternalSizedFormat(0,t,U)),{internalFormat:I,format:y,type:this._gl.UNSIGNED_BYTE}}_rescaleTexture(t,U,y,I,r){}_unpackFlipY(t){this._unpackFlipYCached!==t&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,t?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=t))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(t){return t.isCube?this._gl.TEXTURE_CUBE_MAP:t.is3D?this._gl.TEXTURE_3D:t.is2DArray||t.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(t,U){let y=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const I=this._getTextureTarget(U),r=this._getSamplingParameters(t,U.useMipMaps||y);this._setTextureParameterInteger(I,this._gl.TEXTURE_MAG_FILTER,r.mag,U),this._setTextureParameterInteger(I,this._gl.TEXTURE_MIN_FILTER,r.min),y&&r.hasMipMaps&&(U.generateMipMaps=!0,this._gl.generateMipmap(I)),this._bindTextureDirectly(I,null),U.samplingMode=t}updateTextureDimensions(t,U,y){}updateTextureWrappingMode(t,U){let y=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,I=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;const r=this._getTextureTarget(t);null!==U&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(U),t),t._cachedWrapU=U),null!==y&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(y),t),t._cachedWrapV=y),(t.is2DArray||t.is3D)&&null!==I&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(I),t),t._cachedWrapR=I),this._bindTextureDirectly(r,null)}_uploadCompressedDataToTextureDirectly(t,U,y,I,r){let Y=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,mt=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;const X=this._gl;let P=X.TEXTURE_2D;if(t.isCube&&(P=X.TEXTURE_CUBE_MAP_POSITIVE_X+Y),t._useSRGBBuffer)switch(U){case 37492:case 36196:this._caps.etc2?U=X.COMPRESSED_SRGB8_ETC2:t._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?U=X.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:t._useSRGBBuffer=!1;break;case 36492:U=X.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:U=X.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?U=X.COMPRESSED_SRGB_S3TC_DXT1_EXT:t._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?U=X.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:t._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?U=X.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:t._useSRGBBuffer=!1;break;default:t._useSRGBBuffer=!1}this._gl.compressedTexImage2D(P,mt,U,y,I,0,r)}_uploadDataToTextureDirectly(t,U){let y=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,I=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4?arguments[4]:void 0,Y=arguments.length>5&&void 0!==arguments[5]&&arguments[5];const mt=this._gl,X=this._getWebGLTextureType(t.type),P=this._getInternalFormat(t.format),G=void 0===r?this._getRGBABufferInternalSizedFormat(t.type,t.format,t._useSRGBBuffer):this._getInternalFormat(r,t._useSRGBBuffer);this._unpackFlipY(t.invertY);let M=mt.TEXTURE_2D;t.isCube&&(M=mt.TEXTURE_CUBE_MAP_POSITIVE_X+y);const L=Math.round(Math.log(t.width)*Math.LOG2E),h=Math.round(Math.log(t.height)*Math.LOG2E),Q=Y?t.width:Math.pow(2,Math.max(L-I,0)),F=Y?t.height:Math.pow(2,Math.max(h-I,0));mt.texImage2D(M,I,G,Q,F,0,P,X,U)}updateTextureData(t,U,y,I,r,Y){let mt=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,X=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,P=arguments.length>8&&void 0!==arguments[8]&&arguments[8];const G=this._gl,M=this._getWebGLTextureType(t.type),L=this._getInternalFormat(t.format);this._unpackFlipY(t.invertY);let h=G.TEXTURE_2D,Q=G.TEXTURE_2D;t.isCube&&(Q=G.TEXTURE_CUBE_MAP_POSITIVE_X+mt,h=G.TEXTURE_CUBE_MAP),this._bindTextureDirectly(h,t,!0),G.texSubImage2D(Q,X,y,I,r,Y,L,M,U),P&&this._gl.generateMipmap(Q),this._bindTextureDirectly(h,null)}_uploadArrayBufferViewToTexture(t,U){let y=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,I=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const r=this._gl,Y=t.isCube?r.TEXTURE_CUBE_MAP:r.TEXTURE_2D;this._bindTextureDirectly(Y,t,!0),this._uploadDataToTextureDirectly(t,U,y,I),this._bindTextureDirectly(Y,null,!0)}_prepareWebGLTextureContinuation(t,U,y,I,r){const Y=this._gl;if(!Y)return;const mt=this._getSamplingParameters(r,!y);Y.texParameteri(Y.TEXTURE_2D,Y.TEXTURE_MAG_FILTER,mt.mag),Y.texParameteri(Y.TEXTURE_2D,Y.TEXTURE_MIN_FILTER,mt.min),y||I||Y.generateMipmap(Y.TEXTURE_2D),this._bindTextureDirectly(Y.TEXTURE_2D,null),U&&U.removePendingData(t),t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear()}_prepareWebGLTexture(t,U,y,I,r,Y,mt,X,P,G){const M=this.getCaps().maxTextureSize,h=Math.min(M,this.needPOTTextures?(0,L.f)(I.width,M):I.width),Q=Math.min(M,this.needPOTTextures?(0,L.f)(I.height,M):I.height),F=this._gl;F&&(t._hardwareTexture?(this._bindTextureDirectly(F.TEXTURE_2D,t,!0),this._unpackFlipY(void 0===r||!!r),t.baseWidth=I.width,t.baseHeight=I.height,t.width=h,t.height=Q,t.isReady=!0,t.type=-1!==t.type?t.type:0,t.format=-1!==t.format?t.format:G??(".jpg"!==U||t._useSRGBBuffer?5:4),X(h,Q,I,U,t,(()=>{this._prepareWebGLTextureContinuation(t,y,Y,mt,P)}))||this._prepareWebGLTextureContinuation(t,y,Y,mt,P)):y&&y.removePendingData(t))}_getInternalFormatFromDepthTextureFormat(t,U,y){const I=this._gl;if(!U)return I.STENCIL_INDEX8;let r=y?I.DEPTH_STENCIL:I.DEPTH_COMPONENT;return this.webGLVersion>1?15===t?r=I.DEPTH_COMPONENT16:16===t?r=I.DEPTH_COMPONENT24:17===t||13===t?r=y?I.DEPTH24_STENCIL8:I.DEPTH_COMPONENT24:14===t?r=I.DEPTH_COMPONENT32F:18===t&&(r=y?I.DEPTH32F_STENCIL8:I.DEPTH_COMPONENT32F):r=I.DEPTH_COMPONENT16,r}_getWebGLTextureTypeFromDepthTextureFormat(t){const U=this._gl;let y=U.UNSIGNED_INT;return 15===t?y=U.UNSIGNED_SHORT:17===t||13===t?y=U.UNSIGNED_INT_24_8:14===t?y=U.FLOAT:18===t?y=U.FLOAT_32_UNSIGNED_INT_24_8_REV:19===t&&(y=U.UNSIGNED_BYTE),y}_setupFramebufferDepthAttachments(t,U,y,I){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,Y=arguments.length>5?arguments[5]:void 0,mt=arguments.length>6&&void 0!==arguments[6]&&arguments[6];const X=this._gl;Y=Y??(t?13:14);const P=this._getInternalFormatFromDepthTextureFormat(Y,U,t);return t&&U?this._createRenderBuffer(y,I,r,X.DEPTH_STENCIL,P,mt?-1:X.DEPTH_STENCIL_ATTACHMENT):U?this._createRenderBuffer(y,I,r,P,P,mt?-1:X.DEPTH_ATTACHMENT):t?this._createRenderBuffer(y,I,r,P,P,mt?-1:X.STENCIL_ATTACHMENT):null}_createRenderBuffer(t,U,y,I,r,Y){let mt=!(arguments.length>6&&void 0!==arguments[6])||arguments[6];const X=this._gl.createRenderbuffer();return this._updateRenderBuffer(X,t,U,y,I,r,Y,mt)}_updateRenderBuffer(t,U,y,I,r,Y,mt){let X=!(arguments.length>7&&void 0!==arguments[7])||arguments[7];const P=this._gl;return P.bindRenderbuffer(P.RENDERBUFFER,t),I>1&&P.renderbufferStorageMultisample?P.renderbufferStorageMultisample(P.RENDERBUFFER,I,Y,U,y):P.renderbufferStorage(P.RENDERBUFFER,r,U,y),-1!==mt&&P.framebufferRenderbuffer(P.FRAMEBUFFER,mt,P.RENDERBUFFER,t),X&&P.bindRenderbuffer(P.RENDERBUFFER,null),t}_releaseTexture(t){this._deleteTexture(t._hardwareTexture),this.unbindAllTextures();const U=this._internalTexturesCache.indexOf(t);-1!==U&&this._internalTexturesCache.splice(U,1),t._lodTextureHigh&&t._lodTextureHigh.dispose(),t._lodTextureMid&&t._lodTextureMid.dispose(),t._lodTextureLow&&t._lodTextureLow.dispose(),t._irradianceTexture&&t._irradianceTexture.dispose()}_deleteTexture(t){null===t||void 0===t||t.release()}_setProgram(t){this._currentProgram!==t&&((0,I.r)(t,this._gl),this._currentProgram=t)}bindSamplers(t){const U=t.getPipelineContext();this._setProgram(U.program);const y=t.getSamplers();for(let I=0;I<y.length;I++){const U=t.getUniform(y[I]);U&&(this._boundUniforms[I]=U)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(t,U){let y=arguments.length>2&&void 0!==arguments[2]&&arguments[2],I=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=!1;const mt=U&&U._associatedChannel>-1;y&&mt&&(this._activeChannel=U._associatedChannel);if(this._boundTexturesCache[this._activeChannel]!==U||I){if(this._activateCurrentTexture(),U&&U.isMultiview)throw Y.b.Error(["_bindTextureDirectly called with a multiview texture!",t,U]),"_bindTextureDirectly called with a multiview texture!";var X;this._gl.bindTexture(t,(null===U||void 0===U||null===(X=U._hardwareTexture)||void 0===X?void 0:X.underlyingResource)??null),this._boundTexturesCache[this._activeChannel]=U,U&&(U._associatedChannel=this._activeChannel)}else y&&(r=!0,this._activateCurrentTexture());return mt&&!y&&this._bindSamplerUniformToChannel(U._associatedChannel,this._activeChannel),r}_bindTexture(t,U,y){if(void 0===t)return;U&&(U._associatedChannel=t),this._activeChannel=t;const I=U?this._getTextureTarget(U):this._gl.TEXTURE_2D;this._bindTextureDirectly(I,U)}unbindAllTextures(){for(let t=0;t<this._maxSimultaneousTextures;t++)this._activeChannel=t,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(t,U,y,I){void 0!==t&&(U&&(this._boundUniforms[t]=U),this._setTexture(t,y))}_bindSamplerUniformToChannel(t,U){const y=this._boundUniforms[t];y&&y._currentState!==U&&(this._gl.uniform1i(y,U),y._currentState=U)}_getTextureWrapMode(t){switch(t){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(t,U){let y,I=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!U)return null!=this._boundTexturesCache[t]&&(this._activeChannel=t,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(U.video){this._activeChannel=t;const y=U.getInternalTexture();y&&(y._associatedChannel=t),U.update()}else if(4===U.delayLoadState)return U.delayLoad(),!1;y=r?U.depthStencilTexture:U.isReady()?U.getInternalTexture():U.isCube?this.emptyCubeTexture:U.is3D?this.emptyTexture3D:U.is2DArray?this.emptyTexture2DArray:this.emptyTexture,!I&&y&&(y._associatedChannel=t);let Y=!0;this._boundTexturesCache[t]===y&&(I||this._bindSamplerUniformToChannel(y._associatedChannel,t),Y=!1),this._activeChannel=t;const mt=this._getTextureTarget(y);if(Y&&this._bindTextureDirectly(mt,y,I),y&&!y.isMultiview){if(y.isCube&&y._cachedCoordinatesMode!==U.coordinatesMode){y._cachedCoordinatesMode=U.coordinatesMode;const t=3!==U.coordinatesMode&&5!==U.coordinatesMode?1:0;U.wrapU=t,U.wrapV=t}y._cachedWrapU!==U.wrapU&&(y._cachedWrapU=U.wrapU,this._setTextureParameterInteger(mt,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(U.wrapU),y)),y._cachedWrapV!==U.wrapV&&(y._cachedWrapV=U.wrapV,this._setTextureParameterInteger(mt,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(U.wrapV),y)),y.is3D&&y._cachedWrapR!==U.wrapR&&(y._cachedWrapR=U.wrapR,this._setTextureParameterInteger(mt,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(U.wrapR),y)),this._setAnisotropicLevel(mt,y,U.anisotropicFilteringLevel)}return!0}setTextureArray(t,U,y,I){if(void 0!==t&&U){this._textureUnits&&this._textureUnits.length===y.length||(this._textureUnits=new Int32Array(y.length));for(let U=0;U<y.length;U++){const I=y[U].getInternalTexture();I?(this._textureUnits[U]=t+U,I._associatedChannel=t+U):this._textureUnits[U]=-1}this._gl.uniform1iv(U,this._textureUnits);for(let t=0;t<y.length;t++)this._setTexture(this._textureUnits[t],y[t],!0)}}_setAnisotropicLevel(t,U,y){const I=this._caps.textureAnisotropicFilterExtension;11!==U.samplingMode&&3!==U.samplingMode&&2!==U.samplingMode&&(y=1),I&&U._cachedAnisotropicFilteringLevel!==y&&(this._setTextureParameterFloat(t,I.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(y,this._caps.maxAnisotropy),U),U._cachedAnisotropicFilteringLevel=y)}_setTextureParameterFloat(t,U,y,I){this._bindTextureDirectly(t,I,!0,!0),this._gl.texParameterf(t,U,y)}_setTextureParameterInteger(t,U,y,I){I&&this._bindTextureDirectly(t,I,!0,!0),this._gl.texParameteri(t,U,y)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let t=0;t<this._caps.maxVertexAttribs;t++)this.disableAttributeByIndex(t)}else for(let t=0,U=this._vertexAttribArraysEnabled.length;t<U;t++)t>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[t]||this.disableAttributeByIndex(t)}releaseEffects(){this._compiledEffects={},this.onReleaseEffectsObservable.notifyObservers(this)}dispose(){var t;((0,mt.p)()&&this._renderingCanvas&&(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._onContextRestored&&this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),super.dispose(),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.unbindAllAttributes(),this._boundUniforms={},this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._currentProgram=null,this._creationOptions.loseContextOnDispose)&&(null===(t=this._gl.getExtension("WEBGL_lose_context"))||void 0===t||t.loseContext());(0,I.B)(this._gl)}attachContextLostEvent(t){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",t,!1)}attachContextRestoredEvent(t){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",t,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(t){const U=this._gl;for(;U.getError()!==U.NO_ERROR;);let y=!0;const I=U.createTexture();U.bindTexture(U.TEXTURE_2D,I),U.texImage2D(U.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(t),1,1,0,U.RGBA,this._getWebGLTextureType(t),null),U.texParameteri(U.TEXTURE_2D,U.TEXTURE_MIN_FILTER,U.NEAREST),U.texParameteri(U.TEXTURE_2D,U.TEXTURE_MAG_FILTER,U.NEAREST);const r=U.createFramebuffer();U.bindFramebuffer(U.FRAMEBUFFER,r),U.framebufferTexture2D(U.FRAMEBUFFER,U.COLOR_ATTACHMENT0,U.TEXTURE_2D,I,0);const Y=U.checkFramebufferStatus(U.FRAMEBUFFER);if(y=y&&Y===U.FRAMEBUFFER_COMPLETE,y=y&&U.getError()===U.NO_ERROR,y&&(U.clear(U.COLOR_BUFFER_BIT),y=y&&U.getError()===U.NO_ERROR),y){U.bindFramebuffer(U.FRAMEBUFFER,null);const t=U.RGBA,I=U.UNSIGNED_BYTE,r=new Uint8Array(4);U.readPixels(0,0,1,1,t,I,r),y=y&&U.getError()===U.NO_ERROR}for(U.deleteTexture(I),U.deleteFramebuffer(r),U.bindFramebuffer(U.FRAMEBUFFER,null);!y&&U.getError()!==U.NO_ERROR;);return y}_getWebGLTextureType(t){if(1===this._webGLVersion){switch(t){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(t){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(t){let U=arguments.length>1&&void 0!==arguments[1]&&arguments[1],y=U?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;switch(t){case 0:y=this._gl.ALPHA;break;case 1:y=this._gl.LUMINANCE;break;case 2:y=this._gl.LUMINANCE_ALPHA;break;case 6:case 33322:case 36760:y=this._gl.RED;break;case 7:case 33324:case 36761:y=this._gl.RG;break;case 4:case 32852:case 36762:y=U?this._glSRGBExtensionValues.SRGB:this._gl.RGB;break;case 5:case 32859:case 36763:y=U?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA}if(this._webGLVersion>1)switch(t){case 8:y=this._gl.RED_INTEGER;break;case 9:y=this._gl.RG_INTEGER;break;case 10:y=this._gl.RGB_INTEGER;break;case 11:y=this._gl.RGBA_INTEGER}return y}_getRGBABufferInternalSizedFormat(t,U){let y=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(1===this._webGLVersion){if(void 0!==U)switch(U){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return y?this._glSRGBExtensionValues.SRGB:this._gl.RGB}return this._gl.RGBA}switch(t){case 3:switch(U){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(U){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return y?this._glSRGBExtensionValues.SRGB8:this._gl.RGB8;case 5:return y?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(U){case 8:return this._gl.R16I;case 36760:return this._gl.R16_SNORM_EXT;case 36761:return this._gl.RG16_SNORM_EXT;case 36762:return this._gl.RGB16_SNORM_EXT;case 36763:return this._gl.RGBA16_SNORM_EXT;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;default:return this._gl.RGBA16I}case 5:switch(U){case 8:return this._gl.R16UI;case 33322:return this._gl.R16_EXT;case 33324:return this._gl.RG16_EXT;case 32852:return this._gl.RGB16_EXT;case 32859:return this._gl.RGBA16_EXT;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;default:return this._gl.RGBA16UI}case 6:switch(U){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;default:return this._gl.RGBA32I}case 7:switch(U){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;default:return this._gl.RGBA32UI}case 1:switch(U){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;default:return this._gl.RGBA32F}case 2:switch(U){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(U){case 5:default:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI}}return y?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8}readPixels(t,U,y,I){let r=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],mt=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],X=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;const P=r?4:3,G=r?this._gl.RGBA:this._gl.RGB,M=y*I*P;if(X){if(X.length<M)return Y.b.Error(`Data buffer is too small to store the read pixels (${X.length} should be more than ${M})`),Promise.resolve(X)}else X=new Uint8Array(M);return mt&&this.flushFramebuffer(),this._gl.readPixels(t,U,y,I,G,this._gl.UNSIGNED_BYTE,X),Promise.resolve(X)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(null!==this._HasMajorPerformanceCaveat)return!this._HasMajorPerformanceCaveat;if(null===this._IsSupported)try{const t=h.e._CreateCanvas(1,1),U=t.getContext("webgl")||t.getContext("experimental-webgl");this._IsSupported=null!=U&&!!window.WebGLRenderingContext}catch(t){this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(null===this._HasMajorPerformanceCaveat)try{const t=h.e._CreateCanvas(1,1),U=t.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||t.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!U}catch(t){this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}}B._TempClearColorUint32=new Uint32Array(4),B._TempClearColorInt32=new Int32Array(4),B.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/12\\d\\..+?Mobile",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}],B._ConcatenateShader=w.g,B._IsSupported=null,B._HasMajorPerformanceCaveat=null},12469:(t,U,y)=>{y.d(U,{d:()=>Q});var I=y(12204),r=y(12386),Y=y(12361),mt=y(12472),X=y(12349),P=y(12287),G=y(12221),M=y(12493),L=y(12399);class h{get renderList(){return this._renderList}set renderList(t){this._renderList!==t&&(this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),t&&(this._unObserveRenderList=(0,L.j)(t,this._renderListHasChanged)),this._renderList=t)}get disableImageProcessing(){return this._disableImageProcessing}set disableImageProcessing(t){t!==this._disableImageProcessing&&(this._disableImageProcessing=t,this._scene.markAllMaterialsAsDirty(64))}get name(){return this._name}set name(t){if(this._name===t)return;if(this._name=t,!this._scene)return;const U=this._scene.getEngine();for(let y=0;y<this._renderPassIds.length;++y){const t=this._renderPassIds[y];U._renderPassNames[t]=`${this._name}#${y}`}}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}setMaterialForRendering(t,U){let y;y=Array.isArray(t)?t:[t];for(let I=0;I<y.length;++I)for(let t=0;t<this.options.numPasses;++t){let r=y[I];y[I].isAnInstance&&(r=y[I].sourceMesh),r.setMaterialForRenderPass(this._renderPassIds[t],void 0!==U?Array.isArray(U)?U[t]:U:void 0)}}constructor(t,U,y){this._unObserveRenderList=null,this._renderListHasChanged=(t,U)=>{const y=this._renderList?this._renderList.length:0;if(0===U&&y>0||0===y)for(const I of this._scene.meshes)I._markSubMeshesAsLightDirty()},this.particleSystemList=null,this.getCustomRenderList=null,this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this._disableImageProcessing=!1,this.onBeforeRenderObservable=new I.b,this.onAfterRenderObservable=new I.b,this.onBeforeRenderingManagerRenderObservable=new I.b,this.onAfterRenderingManagerRenderObservable=new I.b,this.onFastPathRenderObservable=new I.b,this._currentRefreshId=-1,this._refreshRate=1,this._currentApplyByPostProcessSetting=!1,this._currentSceneCamera=null,this.name=t,this._scene=U,this.renderList=[],this._renderPassIds=[],this.options={numPasses:1,doNotChangeAspectRatio:!0,...y},this._createRenderPassId(),this.renderPassId=this._renderPassIds[0],this._renderingManager=new M.d(U),this._renderingManager._useSceneAutoClearSetup=!0}_releaseRenderPassId(){const t=this._scene.getEngine();for(let U=0;U<this.options.numPasses;++U)t.releaseRenderPassId(this._renderPassIds[U]);this._renderPassIds.length=0}_createRenderPassId(){this._releaseRenderPassId();const t=this._scene.getEngine();for(let U=0;U<this.options.numPasses;++U)this._renderPassIds[U]=t.createRenderPassId(`${this.name}#${U}`)}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(t){this._refreshRate=t,this.resetRefreshCounter()}shouldRender(){return-1===this._currentRefreshId||this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}isReadyForRendering(t,U){this.prepareRenderList(),this.initRender(t,U);const y=this._checkReadiness();return this.finishRender(),y}prepareRenderList(){const t=this._scene;if(this._waitingRenderList){if(!this.renderListPredicate){this.renderList=[];for(let U=0;U<this._waitingRenderList.length;U++){const y=this._waitingRenderList[U],I=t.getMeshById(y);I&&this.renderList.push(I)}}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const t=this._scene.meshes;for(let U=0;U<t.length;U++){const y=t[U];this.renderListPredicate(y)&&this.renderList.push(y)}}this._currentApplyByPostProcessSetting=this._scene.imageProcessingConfiguration.applyByPostProcess,this._disableImageProcessing&&(this._scene.imageProcessingConfiguration._applyByPostProcess=this._disableImageProcessing)}initRender(t,U){const y=this._scene.getEngine(),I=this.activeCamera??this._scene.activeCamera;this._currentSceneCamera=this._scene.activeCamera,I&&(I!==this._scene.activeCamera&&(this._scene.setTransformMatrix(I.getViewMatrix(),I.getProjectionMatrix(!0)),this._scene.activeCamera=I),y.setViewport(I.rigParent?I.rigParent.viewport:I.viewport,t,U)),this._defaultRenderListPrepared=!1}finishRender(){const t=this._scene;this._disableImageProcessing&&(t.imageProcessingConfiguration._applyByPostProcess=this._currentApplyByPostProcessSetting),t.activeCamera=this._currentSceneCamera,this._currentSceneCamera&&(this.activeCamera&&this.activeCamera!==t.activeCamera&&t.setTransformMatrix(this._currentSceneCamera.getViewMatrix(),this._currentSceneCamera.getProjectionMatrix(!0)),t.getEngine().setViewport(this._currentSceneCamera.viewport)),t.resetCachedMaterial()}render(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,U=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const y=this._scene,I=y.getEngine(),r=I.currentRenderPassId;I.currentRenderPassId=this._renderPassIds[t],this.onBeforeRenderObservable.notifyObservers(t);if(I.snapshotRendering&&1===I.snapshotRenderingMode)this.onFastPathRenderObservable.notifyObservers(t);else{let U=null;const I=this.renderList?this.renderList:y.getActiveMeshes().data,r=this.renderList?this.renderList.length:y.getActiveMeshes().length;this.getCustomRenderList&&(U=this.getCustomRenderList(t,I,r)),U?this._prepareRenderingManager(U,U.length,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(I,r,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),U=I),this.onBeforeRenderingManagerRenderObservable.notifyObservers(t),this._renderingManager.render(this.customRenderFunction,U,this.renderParticles,this.renderSprites),this.onAfterRenderingManagerRenderObservable.notifyObservers(t)}U||this.onAfterRenderObservable.notifyObservers(t),I.currentRenderPassId=r}_checkReadiness(){const t=this._scene,U=t.getEngine(),y=U.currentRenderPassId;let I=!0;t.getViewMatrix()||t.updateTransformMatrix();const r=this.options.numPasses;for(let mt=0;mt<r&&I;mt++){let y=null;const Y=this.renderList?this.renderList:t.getActiveMeshes().data,X=this.renderList?this.renderList.length:t.getActiveMeshes().length;U.currentRenderPassId=this._renderPassIds[mt],this.onBeforeRenderObservable.notifyObservers(mt),this.getCustomRenderList&&(y=this.getCustomRenderList(mt,Y,X)),y||(y=Y),this.options.doNotChangeAspectRatio||t.updateTransformMatrix(!0);for(let t=0;t<y.length&&I;++t){const U=y[t];if(U.isEnabled()&&!U.isBlocked&&U.isVisible&&U.BX)if(this.customIsReadyFunction){if(!this.customIsReadyFunction(U,this.refreshRate,!0)){I=!1;continue}}else if(!U.isReady(!0)){I=!1;continue}}this.onAfterRenderObservable.notifyObservers(mt),r>1&&(t.incrementRenderId(),t.resetCachedMaterial())}const Y=this.particleSystemList||t.mQ;for(const mt of Y)mt.isReady()||(I=!1);return U.currentRenderPassId=y,I}_prepareRenderingManager(t,U,y){const I=this._scene,r=I.activeCamera,Y=this.cameraForLOD??r;this._renderingManager.reset();const mt=I.getRenderId(),X=I.getFrameId();for(let G=0;G<U;G++){const U=t[G];if(U&&!U.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(U,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!U.isReady(0===this.refreshRate)){this.resetRefreshCounter();continue}let t,P=null;if(Y){const t=U._internalAbstractMeshDataInfo._currentLOD.get(Y);t&&t[1]===X?P=t[0]:(P=I.customLODSelector?I.customLODSelector(U,Y):U.getLOD(Y),t?(t[0]=P,t[1]=X):U._internalAbstractMeshDataInfo._currentLOD.set(Y,[P,X]))}else P=U;if(!P)continue;if(P!==U&&0!==P.billboardMode&&P.SX(),P._preActivateForIntermediateRendering(mt),t=!(!y||!r)&&0===(U.layerMask&r.layerMask),U.isEnabled()&&U.isVisible&&U.BX&&!t){if(P!==U&&P._activate(mt,!0),U._activate(mt,!0)&&U.BX.length){U.isAnInstance?U._internalAbstractMeshDataInfo._actAsRegularMesh&&(P=U):P._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,P._internalAbstractMeshDataInfo._isActiveIntermediate=!0,I._prepareSkeleton(P);for(let t=0;t<P.BX.length;t++){const U=P.BX[t];this._renderingManager.dispatch(U,P)}}U._postActivate()}}}const P=this.particleSystemList||I.mQ;for(let G=0;G<P.length;G++){const t=P[G],U=t.my;t.isStarted()&&U&&(!U.position||U.isEnabled())&&this._renderingManager.dispatchParticles(t)}}setRenderingOrder(t){let U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,y=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,I=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this._renderingManager.setRenderingOrder(t,U,y,I)}setRenderingAutoClearDepthStencil(t,U){let y=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],I=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];this._renderingManager.setRenderingAutoClearDepthStencil(t,U,y,I),this._renderingManager._useSceneAutoClearSetup=!1}clone(){const t=new h(this.name,this._scene,this.options);return this.renderList&&(t.renderList=this.renderList.slice(0)),t}dispose(){const t=this.renderList?this.renderList:this._scene.getActiveMeshes().data,U=this.renderList?this.renderList.length:this._scene.getActiveMeshes().length;for(let y=0;y<U;y++){const U=t[y];U&&void 0!==U.getMaterialForRenderPass(this.renderPassId)&&U.setMaterialForRenderPass(this.renderPassId,void 0)}this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderingManagerRenderObservable.clear(),this.onAfterRenderingManagerRenderObservable.clear(),this.onFastPathRenderObservable.clear(),this._releaseRenderPassId(),this.renderList=null}_rebuild(){this.refreshRate===h.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=h.REFRESHRATE_RENDER_ONCE)}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}}h.REFRESHRATE_RENDER_ONCE=0,h.REFRESHRATE_RENDER_ONEVERYFRAME=1,h.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,P.Effect.prototype.setDepthStencilTexture=function(t,U){this._engine.setDepthStencilTexture(this._samplers[t],this._uniforms[t],U,t)};class Q extends Y.d{get renderListPredicate(){return this._objectRenderer.renderListPredicate}set renderListPredicate(t){this._objectRenderer.renderListPredicate=t}get renderList(){return this._objectRenderer.renderList}set renderList(t){this._objectRenderer.renderList=t}get particleSystemList(){return this._objectRenderer.particleSystemList}set particleSystemList(t){this._objectRenderer.particleSystemList=t}get getCustomRenderList(){return this._objectRenderer.getCustomRenderList}set getCustomRenderList(t){this._objectRenderer.getCustomRenderList=t}get renderParticles(){return this._objectRenderer.renderParticles}set renderParticles(t){this._objectRenderer.renderParticles=t}get renderSprites(){return this._objectRenderer.renderSprites}set renderSprites(t){this._objectRenderer.renderSprites=t}get forceLayerMaskCheck(){return this._objectRenderer.forceLayerMaskCheck}set forceLayerMaskCheck(t){this._objectRenderer.forceLayerMaskCheck=t}get activeCamera(){return this._objectRenderer.activeCamera}set activeCamera(t){this._objectRenderer.activeCamera=t}get cameraForLOD(){return this._objectRenderer.cameraForLOD}set cameraForLOD(t){this._objectRenderer.cameraForLOD=t}get disableImageProcessing(){return this._objectRenderer.disableImageProcessing}set disableImageProcessing(t){this._objectRenderer.disableImageProcessing=t}get customIsReadyFunction(){return this._objectRenderer.customIsReadyFunction}set customIsReadyFunction(t){this._objectRenderer.customIsReadyFunction=t}get customRenderFunction(){return this._objectRenderer.customRenderFunction}set customRenderFunction(t){this._objectRenderer.customRenderFunction=t}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(t){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(t)}get onBeforeRenderObservable(){return this._objectRenderer.onBeforeRenderObservable}set onBeforeRender(t){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(t)}get onAfterRenderObservable(){return this._objectRenderer.onAfterRenderObservable}set onAfterRender(t){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(t)}set onClear(t){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(t)}get _waitingRenderList(){return this._objectRenderer._waitingRenderList}set _waitingRenderList(t){this._objectRenderer._waitingRenderList=t}get renderPassId(){return this._objectRenderer.renderPassId}get renderPassIds(){return this._objectRenderer.renderPassIds}get currentRefreshId(){return this._objectRenderer.currentRefreshId}setMaterialForRendering(t,U){this._objectRenderer.setMaterialForRendering(t,U)}get isMulti(){var t;return(null===(t=this._renderTarget)||void 0===t?void 0:t.isMulti)??!1}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(t){if(this._boundingBoxSize&&this._boundingBoxSize.equals(t))return;this._boundingBoxSize=t;const U=this.St();U&&U.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){var t;return(null===(t=this._renderTarget)||void 0===t?void 0:t._depthStencilTexture)??null}constructor(t,U,y){let mt,X,P=arguments.length>3&&void 0!==arguments[3]&&arguments[3],M=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],L=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,Q=arguments.length>6&&void 0!==arguments[6]&&arguments[6],F=arguments.length>7&&void 0!==arguments[7]?arguments[7]:Y.d.TRILINEAR_SAMPLINGMODE,E=!(arguments.length>8&&void 0!==arguments[8])||arguments[8],w=arguments.length>9&&void 0!==arguments[9]&&arguments[9],D=arguments.length>10&&void 0!==arguments[10]&&arguments[10],l=arguments.length>11&&void 0!==arguments[11]?arguments[11]:5,g=arguments.length>12&&void 0!==arguments[12]&&arguments[12],B=arguments.length>13?arguments[13]:void 0,b=arguments.length>14?arguments[14]:void 0,p=arguments.length>15&&void 0!==arguments[15]&&arguments[15],c=arguments.length>16&&void 0!==arguments[16]&&arguments[16],f=!0;if("object"===typeof P){const t=P;P=!!t.generateMipMaps,M=t.doNotChangeAspectRatio??!0,L=t.type??0,Q=!!t.isCube,F=t.samplingMode??Y.d.TRILINEAR_SAMPLINGMODE,E=t.generateDepthBuffer??!0,w=!!t.generateStencilBuffer,D=!!t.isMulti,l=t.format??5,g=!!t.delayAllocation,B=t.samples,b=t.creationFlags,p=!!t.noColorAttachment,c=!!t.useSRGBBuffer,mt=t.colorAttachment,f=t.gammaSpace??f,X=t.existingObjectRenderer}if(super(null,y,!P,void 0,F,void 0,void 0,void 0,void 0,l),this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new I.b,this.onAfterUnbindObservable=new I.b,this.onClearObservable=new I.b,this.onResizeObservable=new I.b,this._cleared=!1,this.skipInitialClear=!1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this._dontDisposeObjectRenderer=!1,this.boundingBoxPosition=r.DU.Zero(),this._disableEngineStages=!1,this._dumpToolsLoading=!1,!(y=this.St()))return;const S=this.St().getEngine();this._gammaSpace=f,this._coordinatesMode=Y.d.PROJECTION_MODE,this.name=t,this.isRenderTarget=!0,this._initialSizeParameter=U,this._dontDisposeObjectRenderer=!!X,this._processSizeParameter(U),this._objectRenderer=X??new h(t,y,{numPasses:Q?6:this.getRenderLayers()||1,doNotChangeAspectRatio:M}),this._onBeforeRenderingManagerRenderObserver=this._objectRenderer.onBeforeRenderingManagerRenderObservable.add((()=>{if(!this._disableEngineStages)for(const t of this._scene._beforeRenderTargetClearStage)t.action(this,this._currentFaceIndex,this._currentLayer);if(this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(S):this.skipInitialClear||S.clear(this.clearColor||this._scene.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),!this._disableEngineStages)for(const t of this._scene._beforeRenderTargetDrawStage)t.action(this,this._currentFaceIndex,this._currentLayer)})),this._onAfterRenderingManagerRenderObserver=this._objectRenderer.onAfterRenderingManagerRenderObservable.add((()=>{var t;if(!this._disableEngineStages)for(const y of this._scene._afterRenderTargetDrawStage)y.action(this,this._currentFaceIndex,this._currentLayer);const U=(null===(t=this._texture)||void 0===t?void 0:t.generateMipMaps)??!1;if(this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex,this._postProcesses,this.ignoreCameraViewport):this._currentUseCameraPostProcess&&this._scene.postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex),!this._disableEngineStages)for(const y of this._scene._afterRenderTargetPostProcessStage)y.action(this,this._currentFaceIndex,this._currentLayer);this._texture&&(this._texture.generateMipMaps=U),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),this._currentDumpForDebug&&(this._dumpTools?this._dumpTools.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),S):G.b.Error("dumpTools module is still being loaded. To speed up the process import dump tools directly in your project"))})),this._onFastPathRenderObserver=this._objectRenderer.onFastPathRenderObservable.add((()=>{this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(S):this.skipInitialClear||S.clear(this.clearColor||this._scene.clearColor,!0,!0,!0)})),this._resizeObserver=S.onResizeObservable.add((()=>{})),this._generateMipMaps=!!P,this._doNotChangeAspectRatio=M,D||(this._renderTargetOptions={generateMipMaps:P,type:L,format:this._format??void 0,samplingMode:this.samplingMode,generateDepthBuffer:E,generateStencilBuffer:w,samples:B,creationFlags:b,noColorAttachment:p,useSRGBBuffer:c,colorAttachment:mt,label:this.name},this.samplingMode===Y.d.NEAREST_SAMPLINGMODE&&(this.wrapU=Y.d.CLAMP_ADDRESSMODE,this.wrapV=Y.d.CLAMP_ADDRESSMODE),g||(Q?(this._renderTarget=y.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=Y.d.INVCUBIC_MODE,this._textureMatrix=r.Matrix.Identity()):this._renderTarget=y.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==B&&(this.samples=B)))}createDepthStencilTexture(){var t;let U=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,y=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],I=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,Y=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14,mt=arguments.length>5?arguments[5]:void 0;null===(t=this._renderTarget)||void 0===t||t.createDepthStencilTexture(U,y,I,r,Y,mt)}_processSizeParameter(t){if(t.ratio){this._sizeRatio=t.ratio;const U=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(U.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(U.getRenderHeight(),this._sizeRatio)}}else this._size=t}get samples(){var t;return(null===(t=this._renderTarget)||void 0===t?void 0:t.samples)??this._samples}set samples(t){this._renderTarget&&(this._samples=this._renderTarget.setSamples(t))}addPostProcess(t){if(!this._postProcessManager){const t=this.St();if(!t)return;this._postProcessManager=new mt.b(t),this._postProcesses=new Array}this._postProcesses.push(t),this._postProcesses[0].gX=!1}clearPostProcesses(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._postProcesses){if(t)for(const t of this._postProcesses)t.dispose();this._postProcesses=[]}}removePostProcess(t){if(!this._postProcesses)return;const U=this._postProcesses.indexOf(t);-1!==U&&(this._postProcesses.splice(U,1),this._postProcesses.length>0&&(this._postProcesses[0].gX=!1))}resetRefreshCounter(){this._objectRenderer.resetRefreshCounter()}get refreshRate(){return this._objectRenderer.refreshRate}set refreshRate(t){this._objectRenderer.refreshRate=t}_shouldRender(){return this._objectRenderer.shouldRender()}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){const t=this._size.layers;if(t)return t;const U=this._size.depth;return U||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(t){const U=Math.max(1,this.getRenderSize()*t);this.resize(U)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(t){var U;const y=this.isCube;null===(U=this._renderTarget)||void 0===U||U.dispose(),this._renderTarget=null;const I=this.St();I&&(this._processSizeParameter(t),this._renderTarget=y?I.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):I.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==this._renderTargetOptions.samples&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],U=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._render(t,U)}isReadyForRendering(){this._dumpToolsLoading||(this._dumpToolsLoading=!0,y.e(20).then(y.bind(y,12635)).then((t=>this._dumpTools=t))),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight());const t=this._objectRenderer._checkReadiness();return this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender(),t}_render(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],U=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const y=this.St();if(y){if(void 0!==this.useCameraPostProcesses&&(t=this.useCameraPostProcesses),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight()),!this.is2DArray&&!this.is3D||this.isMulti)if(this.isCube&&!this.isMulti)for(let I=0;I<6;I++)this._renderToTarget(I,t,U),y.incrementRenderId(),y.resetCachedMaterial();else this._renderToTarget(0,t,U);else for(let I=0;I<this.getRenderLayers();I++)this._renderToTarget(0,t,U,I),y.incrementRenderId(),y.resetCachedMaterial();this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender()}}_bestReflectionRenderTargetDimension(t,U){const y=t*U,I=(0,X.k)(y+16384/(128+y));return Math.min((0,X.e)(t),I)}_bindFrameBuffer(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const y=this.St();if(!y)return;const I=y.getEngine();this._renderTarget&&I.bindFramebuffer(this._renderTarget,this.isCube?t:void 0,void 0,void 0,this.ignoreCameraViewport,0,U)}_unbindFrameBuffer(t,U){this._renderTarget&&t.unBindFramebuffer(this._renderTarget,this.isCube,(()=>{this.onAfterRenderObservable.notifyObservers(U)}))}_prepareFrame(t,U,y,I){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses)||this._bindFrameBuffer(U,y):I&&t.postProcessManager._prepareFrame(this._texture)||this._bindFrameBuffer(U,y)}_renderToTarget(t,U,y){var I,r;let Y=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const mt=this.St();if(!mt)return;const X=mt.getEngine();this._currentFaceIndex=t,this._currentLayer=Y,this._currentUseCameraPostProcess=U,this._currentDumpForDebug=y,this._prepareFrame(mt,t,Y,U),null===(I=X._debugPushGroup)||void 0===I||I.call(X,`render to face #${t} layer #${Y}`,2),this._objectRenderer.render(t+Y,!0),null===(r=X._debugPopGroup)||void 0===r||r.call(X,2),this._unbindFrameBuffer(X,t),this._texture&&this.isCube&&5===t&&X.generateMipMapsForCubemap(this._texture,!0)}setRenderingOrder(t){let U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,y=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,I=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this._objectRenderer.setRenderingOrder(t,U,y,I)}setRenderingAutoClearDepthStencil(t,U){this._objectRenderer.setRenderingAutoClearDepthStencil(t,U)}clone(){const t=this.getSize(),U=new Q(this.name,t,this.St(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return U.pX=this.pX,U.level=this.level,U.coordinatesMode=this.coordinatesMode,this.renderList&&(U.renderList=this.renderList.slice(0)),U}serialize(){if(!this.name)return null;const t=super.serialize();if(t.renderTargetSize=this.getRenderSize(),t.renderList=[],this.renderList)for(let U=0;U<this.renderList.length;U++)t.renderList.push(this.renderList[U].id);return t}disposeFramebufferObjects(){var t;null===(t=this._renderTarget)||void 0===t||t.dispose(!0)}releaseInternalTexture(){var t;null===(t=this._renderTarget)||void 0===t||t.releaseTextures(),this._texture=null}dispose(){var t;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._objectRenderer.onBeforeRenderingManagerRenderObservable.remove(this._onBeforeRenderingManagerRenderObserver),this._objectRenderer.onAfterRenderingManagerRenderObservable.remove(this._onAfterRenderingManagerRenderObserver),this._objectRenderer.onFastPathRenderObservable.remove(this._onFastPathRenderObserver),this._dontDisposeObjectRenderer||this._objectRenderer.dispose(),this.clearPostProcesses(!0),this._resizeObserver&&(this.St().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null);const U=this.St();if(!U)return;let y=U.customRenderTargets.indexOf(this);y>=0&&U.customRenderTargets.splice(y,1);for(const I of U.cameras)y=I.customRenderTargets.indexOf(this),y>=0&&I.customRenderTargets.splice(y,1);null===(t=this._renderTarget)||void 0===t||t.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this._objectRenderer._rebuild(),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._objectRenderer.freeRenderingGroups()}getViewCount(){return 1}}Q.REFRESHRATE_RENDER_ONCE=h.REFRESHRATE_RENDER_ONCE,Q.REFRESHRATE_RENDER_ONEVERYFRAME=h.REFRESHRATE_RENDER_ONEVERYFRAME,Q.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=h.REFRESHRATE_RENDER_ONEVERYTWOFRAMES,Y.d._CreateRenderTargetTexture=(t,U,y,I,r)=>new Q(t,U,y,I)},12565:(t,U,y)=>{function I(t){return 13===t||14===t||15===t||16===t||17===t||18===t||19===t}function r(t){return 13===t||17===t||18===t||19===t}y.d(U,{e:()=>r,f:()=>I})},12545:(t,U,y)=>{function I(t){return void 0===t.getPipelineContext}y.d(U,{c:()=>I})},12505:(t,U,y)=>{y.d(U,{c:()=>G,f:()=>M});var I=y(12480),r=y(12512),Y=y(12204),mt=y(12287),X=y(12521);y(12528);const P={jt:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class G{constructor(t){let U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:P;this._fullscreenViewport=new r.e(0,0,1,1);const y=U.jt??P.jt,Y=U.indices??P.indices;this.wU=t,this._vertexBuffers={[I.e.PositionKind]:new I.e(t,y,I.e.PositionKind,!1,!1,2)},this._indexBuffer=t.createIndexBuffer(Y),this._indexBufferLength=Y.length,this._onContextRestoredObserver=t.onContextRestoredObservable.add((()=>{this._indexBuffer=t.createIndexBuffer(Y);for(const t in this._vertexBuffers){this._vertexBuffers[t]._rebuild()}}))}setViewport(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._fullscreenViewport;this.wU.setViewport(t)}bindBuffers(t){this.wU.bindBuffers(this._vertexBuffers,this._indexBuffer,t)}applyEffectWrapper(t){this.wU.setState(!0),this.wU.depthCullingState.depthTest=!1,this.wU.stencilState.stencilTest=!1,this.wU.enableEffect(t.drawWrapper),this.bindBuffers(t.effect),t.onApplyObservable.notifyObservers({})}saveStates(){this._savedStateDepthTest=this.wU.depthCullingState.depthTest,this._savedStateStencilTest=this.wU.stencilState.stencilTest}restoreStates(){this.wU.depthCullingState.depthTest=this._savedStateDepthTest,this.wU.stencilState.stencilTest=this._savedStateStencilTest}draw(){this.wU.drawElementsType(0,0,this._indexBufferLength)}_isRenderTargetTexture(t){return void 0!==t.renderTarget}render(t){let U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!t.effect.isReady())return;this.saveStates(),this.setViewport();const y=null===U?null:this._isRenderTargetTexture(U)?U.renderTarget:U;y&&this.wU.bindFramebuffer(y),this.applyEffectWrapper(t),this.draw(),y&&this.wU.unBindFramebuffer(y),this.restoreStates()}dispose(){const t=this._vertexBuffers[I.e.PositionKind];t&&(t.dispose(),delete this._vertexBuffers[I.e.PositionKind]),this._indexBuffer&&this.wU._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.wU.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}}class M{static RegisterShaderCodeProcessing(t,U){U?M._CustomShaderCodeProcessing[t??""]=U:delete M._CustomShaderCodeProcessing[t??""]}static _GetShaderCodeProcessing(t){return M._CustomShaderCodeProcessing[t]??M._CustomShaderCodeProcessing[""]}get name(){return this.options.name}set name(t){this.options.name=t}isReady(){var t;return(null===(t=this._drawWrapper.effect)||void 0===t?void 0:t.isReady())??!1}get drawWrapper(){return this._drawWrapper}get effect(){return this._drawWrapper.effect}set effect(t){this._drawWrapper.effect=t}constructor(t){this.alphaMode=0,this.onEffectCreatedObservable=new Y.b(void 0,!0),this.onApplyObservable=new Y.b,this._shadersLoaded=!1,this._webGPUReady=!1,this._importPromises=[],this.options={...t,name:t.name||"effectWrapper",wU:t.wU,uniforms:t.uniforms||t.uniformNames||[],uniformNames:void 0,samplers:t.samplers||t.samplerNames||[],samplerNames:void 0,attributeNames:t.attributeNames||["position"],uniformBuffers:t.uniformBuffers||[],defines:t.defines||"",useShaderStore:t.useShaderStore||!1,vertexUrl:t.vertexUrl||t.vertexShader||"postprocess",vertexShader:void 0,fragmentShader:t.fragmentShader||"pass",indexParameters:t.indexParameters,blockCompilation:t.blockCompilation||!1,shaderLanguage:t.shaderLanguage||0,onCompiled:t.onCompiled||void 0,extraInitializations:t.extraInitializations||void 0,extraInitializationsAsync:t.extraInitializationsAsync||void 0,useAsPostProcess:t.useAsPostProcess??!1},this.options.uniformNames=this.options.uniforms,this.options.samplerNames=this.options.samplers,this.options.vertexShader=this.options.vertexUrl,this.options.useAsPostProcess&&(-1===this.options.samplers.indexOf("textureSampler")&&this.options.samplers.push("textureSampler"),-1===this.options.uniforms.indexOf("scale")&&this.options.uniforms.push("scale")),t.vertexUrl||t.vertexShader?this._shaderPath={vertexSource:this.options.vertexShader}:(this.options.useAsPostProcess||(this.options.uniforms.push("scale"),this.onApplyObservable.add((()=>{this.effect.setFloat2("scale",1,1)}))),this._shaderPath={vertex:this.options.vertexShader}),this._shaderPath.fragmentSource=this.options.fragmentShader,this._shaderPath.spectorName=this.options.name,this.options.useShaderStore&&(this._shaderPath.fragment=this._shaderPath.fragmentSource,this._shaderPath.vertex||(this._shaderPath.vertex=this._shaderPath.vertexSource),delete this._shaderPath.fragmentSource,delete this._shaderPath.vertexSource),this.onApplyObservable.add((()=>{this.bind()})),this.options.useShaderStore||(this._onContextRestoredObserver=this.options.wU.onContextRestoredObservable.add((()=>{this.effect._pipelineContext=null,this.effect._prepareEffect()}))),this._drawWrapper=new X.e(this.options.wU),this._webGPUReady=1===this.options.shaderLanguage;const U=Array.isArray(this.options.defines)?this.options.defines.join("\n"):this.options.defines;this._postConstructor(this.options.blockCompilation,U,this.options.extraInitializations)}_gatherImports(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],U=arguments.length>1?arguments[1]:void 0;this.options.useAsPostProcess&&(t&&this._webGPUReady?U.push(Promise.all([y.e(53).then(y.bind(y,14655))])):U.push(Promise.all([Promise.resolve().then(y.bind(y,12528))])))}_postConstructor(t){let U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,y=arguments.length>2?arguments[2]:void 0,I=arguments.length>3?arguments[3]:void 0;this._importPromises.length=0,I&&this._importPromises.push(...I);const r=this.options.wU.isWebGPU&&!M.ForceGLSL;this._gatherImports(r,this._importPromises),void 0!==y&&y(r,this._importPromises),r&&this._webGPUReady&&(this.options.shaderLanguage=1),t||this.updateEffect(U)}updateEffect(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,y=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,I=arguments.length>3?arguments[3]:void 0,r=arguments.length>4?arguments[4]:void 0,Y=arguments.length>5?arguments[5]:void 0,X=arguments.length>6?arguments[6]:void 0,P=arguments.length>7?arguments[7]:void 0;const G=M._GetShaderCodeProcessing(this.name);if(null!==G&&void 0!==G&&G.defineCustomBindings){var L,h;const I=(null===(L=U)||void 0===L?void 0:L.slice())??[];I.push(...this.options.uniforms);const r=(null===(h=y)||void 0===h?void 0:h.slice())??[];r.push(...this.options.samplers),t=G.defineCustomBindings(this.name,t,I,r),U=I,y=r}this.options.defines=t||"";const Q=this._shadersLoaded||0===this._importPromises.length?void 0:async()=>{await Promise.all(this._importPromises),this._shadersLoaded=!0};let F;F=this.options.extraInitializationsAsync?async()=>{null===Q||void 0===Q||Q(),await this.options.extraInitializationsAsync()}:Q,this.options.useShaderStore?this._drawWrapper.effect=this.options.wU.createEffect({vertex:X??this._shaderPath.vertex,fragment:P??this._shaderPath.fragment},{attributes:this.options.attributeNames,uniformsNames:U||this.options.uniforms,uniformBuffersNames:this.options.uniformBuffers,samplers:y||this.options.samplers,defines:null!==t?t:"",fallbacks:null,onCompiled:r??this.options.onCompiled,onError:Y??null,indexParameters:I||this.options.indexParameters,processCodeAfterIncludes:null!==G&&void 0!==G&&G.processCodeAfterIncludes?(t,U)=>G.processCodeAfterIncludes(this.name,t,U):null,processFinalCode:null!==G&&void 0!==G&&G.processFinalCode?(t,U)=>G.processFinalCode(this.name,t,U):null,shaderLanguage:this.options.shaderLanguage,extraInitializationsAsync:F},this.options.wU):this._drawWrapper.effect=new mt.Effect(this._shaderPath,this.options.attributeNames,U||this.options.uniforms,y||this.options.samplerNames,this.options.wU,t,void 0,r||this.options.onCompiled,void 0,void 0,void 0,this.options.shaderLanguage,F),this.onEffectCreatedObservable.notifyObservers(this._drawWrapper.effect)}bind(){var t,U;let y=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.options.useAsPostProcess&&!y&&(this.options.wU.setAlphaMode(this.alphaMode),this.drawWrapper.effect.setFloat2("scale",1,1)),null===(t=M._GetShaderCodeProcessing(this.name))||void 0===t||null===(U=t.bindCustomBindings)||void 0===U||U.call(t,this.name,this._drawWrapper.effect)}dispose(){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.onEffectCreatedObservable.clear(),this._drawWrapper.dispose(!0)}}M.ForceGLSL=!1,M._CustomShaderCodeProcessing={}},12612:(t,U,y)=>{y.d(U,{d:()=>mt});var I,r,Y=y(12386);!function(t){t[t.LOCAL=0]="LOCAL",t[t.WORLD=1]="WORLD",t[t.BONE=2]="BONE"}(I||(I={}));class mt{}mt.X=new Y.DU(1,0,0),mt.Y=new Y.DU(0,1,0),mt.Z=new Y.DU(0,0,1),function(t){t[t.X=0]="X",t[t.Y=1]="Y",t[t.Z=2]="Z"}(r||(r={}))},12605:(t,U,y)=>{y.d(U,{d:()=>I.Matrix,g:()=>I.Quaternion,i:()=>I.TmpVectors,m:()=>I.DU});y(12612),y(12442),y(12392),y(12618),y(12623),y(12451),y(12422);var I=y(12386);y(12512)},12623:(t,U,y)=>{y.d(U,{d:()=>X,h:()=>h,j:()=>M,k:()=>L});var I,r=y(12404),Y=y(12386),mt=y(12392);!function(t){t[t.CW=0]="CW",t[t.CCW=1]="CCW"}(I||(I={}));class X{static Interpolate(t,U,y,I,r){if(0===t)return 0;const Y=1-3*I+3*U,mt=3*I-6*U,X=3*U;let P=t;for(let G=0;G<5;G++){const U=P*P;P-=(Y*(U*P)+mt*U+X*P-t)*(1/(3*Y*U+2*mt*P+X)),P=Math.min(1,Math.max(0,P))}return 3*Math.pow(1-P,2)*P*y+3*(1-P)*Math.pow(P,2)*r+Math.pow(P,3)}}class P{constructor(t){this._radians=t,this._radians<0&&(this._radians+=2*Math.PI)}degrees(){return 180*this._radians/Math.PI}radians(){return this._radians}static BetweenTwoPoints(t,U){const y=U.lU(t),I=Math.atan2(y.y,y.x);return new P(I)}static BetweenTwoVectors(t,U){let y=t.lengthSquared()*U.lengthSquared();if(0===y)return new P(Math.PI/2);y=Math.sqrt(y);let I=t.dot(U)/y;I=(0,r.Clamp)(I,-1,1);const Y=Math.acos(I);return new P(Y)}static FromRadians(t){return new P(t)}static FromDegrees(t){return new P(t*Math.PI/180)}}class G{constructor(t,U,y){this.startPoint=t,this.midPoint=U,this.endPoint=y;const I=Math.pow(U.x,2)+Math.pow(U.y,2),r=(Math.pow(t.x,2)+Math.pow(t.y,2)-I)/2,mt=(I-Math.pow(y.x,2)-Math.pow(y.y,2))/2,X=(t.x-U.x)*(U.y-y.y)-(U.x-y.x)*(t.y-U.y);this.centerPoint=new Y.Vector2((r*(U.y-y.y)-mt*(t.y-U.y))/X,((t.x-U.x)*mt-(U.x-y.x)*r)/X),this.radius=this.centerPoint.lU(this.startPoint).length(),this.startAngle=P.BetweenTwoPoints(this.centerPoint,this.startPoint);const G=this.startAngle.degrees();let M=P.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),L=P.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();M-G>180&&(M-=360),M-G<-180&&(M+=360),L-M>180&&(L-=360),L-M<-180&&(L+=360),this.orientation=M-G<0?0:1,this.angle=P.FromDegrees(0===this.orientation?G-L:L-G)}}class M{constructor(t,U){this._points=new Array,this._length=0,this.closed=!1,this._points.push(new Y.Vector2(t,U))}addLineTo(t,U){if(this.closed)return this;const y=new Y.Vector2(t,U),I=this._points[this._points.length-1];return this._points.push(y),this._length+=y.lU(I).length(),this}addArcTo(t,U,y,I){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:36;if(this.closed)return this;const mt=this._points[this._points.length-1],X=new Y.Vector2(t,U),P=new Y.Vector2(y,I),M=new G(mt,X,P);let L=M.angle.radians()/r;0===M.orientation&&(L*=-1);let h=M.startAngle.radians()+L;for(let Y=0;Y<r;Y++){const t=Math.cos(h)*M.radius+M.centerPoint.x,U=Math.sin(h)*M.radius+M.centerPoint.y;this.addLineTo(t,U),h+=L}return this}addQuadraticCurveTo(t,U,y,I){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:36;if(this.closed)return this;const Y=(t,U,y,I)=>(1-t)*(1-t)*U+2*t*(1-t)*y+t*t*I,mt=this._points[this._points.length-1];for(let X=0;X<=r;X++){const P=X/r,G=Y(P,mt.x,t,y),M=Y(P,mt.y,U,I);this.addLineTo(G,M)}return this}addBezierCurveTo(t,U,y,I,r,Y){let mt=arguments.length>6&&void 0!==arguments[6]?arguments[6]:36;if(this.closed)return this;const X=(t,U,y,I,r)=>(1-t)*(1-t)*(1-t)*U+3*t*(1-t)*(1-t)*y+3*t*t*(1-t)*I+t*t*t*r,P=this._points[this._points.length-1];for(let G=0;G<=mt;G++){const M=G/mt,L=X(M,P.x,t,y,r),h=X(M,P.y,U,I,Y);this.addLineTo(L,h)}return this}isPointInside(t){let U=!1;const y=this._points.length;for(let I=y-1,r=0;r<y;I=r++){let y=this._points[I],Y=this._points[r],mt=Y.x-y.x,X=Y.y-y.y;if(Math.abs(X)>Number.EPSILON){if(X<0&&(y=this._points[r],mt=-mt,Y=this._points[I],X=-X),t.y<y.y||t.y>Y.y)continue;if(t.y===y.y&&t.x===y.x)return!0;{const I=X*(t.x-y.x)-mt*(t.y-y.y);if(0===I)return!0;if(I<0)continue;U=!U}}else{if(t.y!==y.y)continue;if(Y.x<=t.x&&t.x<=y.x||y.x<=t.x&&t.x<=Y.x)return!0}}return U}close(){return this.closed=!0,this}length(){let t=this._length;if(this.closed){const U=this._points[this._points.length-1];t+=this._points[0].lU(U).length()}return t}area(){const t=this._points.length;let U=0;for(let y=t-1,I=0;I<t;y=I++)U+=this._points[y].x*this._points[I].y-this._points[I].x*this._points[y].y;return.5*U}getPoints(){return this._points}getPointAtLengthPosition(t){if(t<0||t>1)return Y.Vector2.Zero();const U=t*this.length();let y=0;for(let I=0;I<this._points.length;I++){const t=(I+1)%this._points.length,r=this._points[I],mt=this._points[t].lU(r),X=mt.length()+y;if(U>=y&&U<=X){const t=mt.normalize(),I=U-y;return new Y.Vector2(r.x+t.x*I,r.y+t.y*I)}y=X}return Y.Vector2.Zero()}static StartingAt(t,U){return new M(t,U)}}class L{constructor(t){let U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,y=arguments.length>2?arguments[2]:void 0,I=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.path=t,this._curve=new Array,this._distances=new Array,this._tangents=new Array,this._normals=new Array,this._binormals=new Array,this._pointAtData={id:0,point:Y.DU.Zero(),previousPointArrayIndex:0,position:0,subPosition:0,interpolateReady:!1,interpolationMatrix:Y.Matrix.Identity()};for(let r=0;r<t.length;r++)this._curve[r]=t[r].clone();this._raw=y||!1,this._alignTangentsWithPath=I,this._compute(U,I)}getCurve(){return this._curve}getPoints(){return this._curve}length(){return this._distances[this._distances.length-1]}getTangents(){return this._tangents}getNormals(){return this._normals}getBinormals(){return this._binormals}getDistances(){return this._distances}getPointAt(t){return this._updatePointAtData(t).point}getTangentAt(t){let U=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(t,U),U?Y.DU.TransformCoordinates(Y.DU.Forward(),this._pointAtData.interpolationMatrix):this._tangents[this._pointAtData.previousPointArrayIndex]}getNormalAt(t){let U=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(t,U),U?Y.DU.TransformCoordinates(Y.DU.Right(),this._pointAtData.interpolationMatrix):this._normals[this._pointAtData.previousPointArrayIndex]}getBinormalAt(t){let U=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(t,U),U?Y.DU.TransformCoordinates(Y.DU.UpReadOnly,this._pointAtData.interpolationMatrix):this._binormals[this._pointAtData.previousPointArrayIndex]}getDistanceAt(t){return this.length()*t}getPreviousPointIndexAt(t){return this._updatePointAtData(t),this._pointAtData.previousPointArrayIndex}getSubPositionAt(t){return this._updatePointAtData(t),this._pointAtData.subPosition}getClosestPositionTo(t){let U=Number.MAX_VALUE,y=0;for(let I=0;I<this._curve.length-1;I++){const r=this._curve[I+0],mt=this._curve[I+1].lU(r).normalize(),X=this._distances[I+1]-this._distances[I+0],P=Math.min(Math.max(Y.DU.Dot(mt,t.lU(r).normalize()),0)*Y.DU.Distance(r,t)/X,1),G=Y.DU.Distance(r.add(mt.scale(P*X)),t);G<U&&(U=G,y=(this._distances[I+0]+X*P)/this.length())}return y}slice(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(t<0&&(t=1- -1*t%1),U<0&&(U=1- -1*U%1),t>U){const y=t;t=U,U=y}const y=this.getCurve(),I=this.getPointAt(t);let r=this.getPreviousPointIndexAt(t);const Y=this.getPointAt(U),mt=this.getPreviousPointIndexAt(U)+1,X=[];return 0!==t&&(r++,X.push(I)),X.push(...y.slice(r,mt)),1===U&&1!==t||X.push(Y),new L(X,this.getNormalAt(t),this._raw,this._alignTangentsWithPath)}update(t){let U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,y=arguments.length>2&&void 0!==arguments[2]&&arguments[2];for(let I=0;I<t.length;I++)this._curve[I].x=t[I].x,this._curve[I].y=t[I].y,this._curve[I].z=t[I].z;return this._compute(U,y),this}_compute(t){let U=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const y=this._curve.length;if(y<2)return;this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[y-1]=this._curve[y-1].lU(this._curve[y-2]),this._raw||this._tangents[y-1].normalize();const I=this._tangents[0],r=this._normalVector(I,t);let mt,X,P,G,M;this._normals[0]=r,this._raw||this._normals[0].normalize(),this._binormals[0]=Y.DU.Cross(I,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;for(let L=1;L<y;L++)mt=this._getLastNonNullVector(L),L<y-1&&(X=this._getFirstNonNullVector(L),this._tangents[L]=U?X:mt.add(X),this._tangents[L].normalize()),this._distances[L]=this._distances[L-1]+this._curve[L].lU(this._curve[L-1]).length(),P=this._tangents[L],M=this._binormals[L-1],this._normals[L]=Y.DU.Cross(M,P),this._raw||(0===this._normals[L].length()?(G=this._normals[L-1],this._normals[L]=G.clone()):this._normals[L].normalize()),this._binormals[L]=Y.DU.Cross(P,this._normals[L]),this._raw||this._binormals[L].normalize();this._pointAtData.id=NaN}_getFirstNonNullVector(t){let U=1,y=this._curve[t+U].lU(this._curve[t]);for(;0===y.length()&&t+U+1<this._curve.length;)U++,y=this._curve[t+U].lU(this._curve[t]);return y}_getLastNonNullVector(t){let U=1,y=this._curve[t].lU(this._curve[t-U]);for(;0===y.length()&&t>U+1;)U++,y=this._curve[t].lU(this._curve[t-U]);return y}_normalVector(t,U){let y,I=t.length();if(0===I&&(I=1),void 0===U||null===U){let U;U=(0,r.WithinEpsilon)(Math.abs(t.y)/I,1,mt.b)?(0,r.WithinEpsilon)(Math.abs(t.x)/I,1,mt.b)?(0,r.WithinEpsilon)(Math.abs(t.z)/I,1,mt.b)?Y.DU.Zero():new Y.DU(0,0,1):new Y.DU(1,0,0):new Y.DU(0,-1,0),y=Y.DU.Cross(t,U)}else y=Y.DU.Cross(t,U),Y.DU.CrossToRef(y,t,y);return y.normalize(),y}_updatePointAtData(t){let U=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._pointAtData.id===t)return this._pointAtData.interpolateReady||this._updateInterpolationMatrix(),this._pointAtData;this._pointAtData.id=t;const y=this.getPoints();if(t<=0)return this._setPointAtData(0,0,y[0],0,U);if(t>=1)return this._setPointAtData(1,1,y[y.length-1],y.length-1,U);let I,r=y[0],mt=0;const X=t*this.length();for(let P=1;P<y.length;P++){I=y[P];const G=Y.DU.Distance(r,I);if(mt+=G,mt===X)return this._setPointAtData(t,1,I,P,U);if(mt>X){const y=(mt-X)/G,Y=r.lU(I),M=I.add(Y.scaleInPlace(y));return this._setPointAtData(t,1-y,M,P-1,U)}r=I}return this._pointAtData}_setPointAtData(t,U,y,I,r){return this._pointAtData.point=y,this._pointAtData.position=t,this._pointAtData.subPosition=U,this._pointAtData.previousPointArrayIndex=I,this._pointAtData.interpolateReady=r,r&&this._updateInterpolationMatrix(),this._pointAtData}_updateInterpolationMatrix(){this._pointAtData.interpolationMatrix=Y.Matrix.Identity();const t=this._pointAtData.previousPointArrayIndex;if(t!==this._tangents.length-1){const U=t+1,y=this._tangents[t].clone(),I=this._normals[t].clone(),r=this._binormals[t].clone(),mt=this._tangents[U].clone(),X=this._normals[U].clone(),P=this._binormals[U].clone(),G=Y.Quaternion.RotationQuaternionFromAxis(I,r,y),M=Y.Quaternion.RotationQuaternionFromAxis(X,P,mt);Y.Quaternion.Slerp(G,M,this._pointAtData.subPosition).toRotationMatrix(this._pointAtData.interpolationMatrix)}}}class h{static CreateQuadraticBezier(t,U,y,I){I=I>2?I:3;const r=[],mt=(t,U,y,I)=>(1-t)*(1-t)*U+2*t*(1-t)*y+t*t*I;for(let X=0;X<=I;X++)r.push(new Y.DU(mt(X/I,t.x,U.x,y.x),mt(X/I,t.y,U.y,y.y),mt(X/I,t.z,U.z,y.z)));return new h(r)}static CreateCubicBezier(t,U,y,I,r){r=r>3?r:4;const mt=[],X=(t,U,y,I,r)=>(1-t)*(1-t)*(1-t)*U+3*t*(1-t)*(1-t)*y+3*t*t*(1-t)*I+t*t*t*r;for(let P=0;P<=r;P++)mt.push(new Y.DU(X(P/r,t.x,U.x,y.x,I.x),X(P/r,t.y,U.y,y.y,I.y),X(P/r,t.z,U.z,y.z,I.z)));return new h(mt)}static CreateHermiteSpline(t,U,y,I,r){const mt=[],X=1/r;for(let P=0;P<=r;P++)mt.push(Y.DU.Hermite(t,U,y,I,P*X));return new h(mt)}static CreateCatmullRomSpline(t,U,y){const I=[],r=1/U;let mt=0;if(y){const y=t.length;for(let X=0;X<y;X++){mt=0;for(let P=0;P<U;P++)I.push(Y.DU.CatmullRom(t[X%y],t[(X+1)%y],t[(X+2)%y],t[(X+3)%y],mt)),mt+=r}I.push(I[0])}else{const y=[];y.push(t[0].clone()),Array.prototype.push.apply(y,t),y.push(t[t.length-1].clone());let X=0;for(;X<y.length-3;X++){mt=0;for(let t=0;t<U;t++)I.push(Y.DU.CatmullRom(y[X],y[X+1],y[X+2],y[X+3],mt)),mt+=r}X--,I.push(Y.DU.CatmullRom(y[X],y[X+1],y[X+2],y[X+3],mt))}return new h(I)}static ArcThru3Points(t,U,y){let I=arguments.length>3&&void 0!==arguments[3]?arguments[3]:32,r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],mt=arguments.length>5&&void 0!==arguments[5]&&arguments[5];const X=[],P=U.lU(t),G=y.lU(U),M=t.lU(y),L=Y.DU.Cross(P,G),Q=L.length();if(Q<Math.pow(10,-8))return new h(X);const F=P.lengthSquared(),E=G.lengthSquared(),w=M.lengthSquared(),D=L.lengthSquared(),l=.5*P.length()*G.length()*M.length()/Q,g=-.5*E*Y.DU.Dot(P,M)/D,B=-.5*w*Y.DU.Dot(P,G)/D,b=-.5*F*Y.DU.Dot(G,M)/D,p=t.scale(g).add(U.scale(B)).add(y.scale(b)),c=t.lU(p).normalize(),f=Y.DU.Cross(L,c).normalize();if(mt){const U=2*Math.PI/I;for(let t=0;t<=2*Math.PI;t+=U)X.push(p.add(c.scale(l*Math.cos(t)).add(f.scale(l*Math.sin(t)))));X.push(t)}else{const U=1/I;let mt=0,P=Y.DU.Zero();do{P=p.add(c.scale(l*Math.cos(mt)).add(f.scale(l*Math.sin(mt)))),X.push(P),mt+=U}while(!P.equalsWithEpsilon(y,l*U*1.1));X.push(y),r&&X.push(t)}return new h(X)}constructor(t){this._length=0,this._points=t,this._length=this._computeLength(t)}getPoints(){return this._points}length(){return this._length}continue(t){const U=this._points[this._points.length-1],y=this._points.slice(),I=t.getPoints();for(let r=1;r<I.length;r++)y.push(I[r].lU(I[0]).add(U));return new h(y)}_computeLength(t){let U=0;for(let y=1;y<t.length;y++)U+=t[y].lU(t[y-1]).length();return U}}},12512:(t,U,y)=>{y.d(U,{e:()=>I});class I{constructor(t,U,y,I){this.x=t,this.y=U,this.width=y,this.height=I}toGlobal(t,U){return new I(this.x*t,this.y*U,this.width*t,this.height*U)}toGlobalToRef(t,U,y){return y.x=this.x*t,y.y=this.y*U,y.width=this.width*t,y.height=this.height*U,this}clone(){return new I(this.x,this.y,this.width,this.height)}}},12597:(t,U,y)=>{y.d(U,{b:()=>G,e:()=>M});var I=y(12386),r=y(12605);const Y=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],mt=[()=>1,t=>t.y,t=>t.z,t=>t.x,t=>t.x*t.y,t=>t.y*t.z,t=>3*t.z*t.z-1,t=>t.x*t.z,t=>t.x*t.x-t.y*t.y],X=(t,U)=>Y[t]*mt[t](U),P=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4];class G{constructor(){this.preScaled=!1,this.l00=I.DU.Zero(),this.l1_1=I.DU.Zero(),this.l10=I.DU.Zero(),this.l11=I.DU.Zero(),this.l2_2=I.DU.Zero(),this.l2_1=I.DU.Zero(),this.l20=I.DU.Zero(),this.l21=I.DU.Zero(),this.l22=I.DU.Zero()}addLight(t,U,y){r.i.DU[0].set(U.r,U.g,U.b);const I=r.i.DU[0],Y=r.i.DU[1];I.scaleToRef(y,Y),Y.scaleToRef(X(0,t),r.i.DU[2]),this.l00.addInPlace(r.i.DU[2]),Y.scaleToRef(X(1,t),r.i.DU[2]),this.l1_1.addInPlace(r.i.DU[2]),Y.scaleToRef(X(2,t),r.i.DU[2]),this.l10.addInPlace(r.i.DU[2]),Y.scaleToRef(X(3,t),r.i.DU[2]),this.l11.addInPlace(r.i.DU[2]),Y.scaleToRef(X(4,t),r.i.DU[2]),this.l2_2.addInPlace(r.i.DU[2]),Y.scaleToRef(X(5,t),r.i.DU[2]),this.l2_1.addInPlace(r.i.DU[2]),Y.scaleToRef(X(6,t),r.i.DU[2]),this.l20.addInPlace(r.i.DU[2]),Y.scaleToRef(X(7,t),r.i.DU[2]),this.l21.addInPlace(r.i.DU[2]),Y.scaleToRef(X(8,t),r.i.DU[2]),this.l22.addInPlace(r.i.DU[2])}scaleInPlace(t){this.l00.scaleInPlace(t),this.l1_1.scaleInPlace(t),this.l10.scaleInPlace(t),this.l11.scaleInPlace(t),this.l2_2.scaleInPlace(t),this.l2_1.scaleInPlace(t),this.l20.scaleInPlace(t),this.l21.scaleInPlace(t),this.l22.scaleInPlace(t)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(P[0]),this.l1_1.scaleInPlace(P[1]),this.l10.scaleInPlace(P[2]),this.l11.scaleInPlace(P[3]),this.l2_2.scaleInPlace(P[4]),this.l2_1.scaleInPlace(P[5]),this.l20.scaleInPlace(P[6]),this.l21.scaleInPlace(P[7]),this.l22.scaleInPlace(P[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(Y[0]),this.l1_1.scaleInPlace(Y[1]),this.l10.scaleInPlace(Y[2]),this.l11.scaleInPlace(Y[3]),this.l2_2.scaleInPlace(Y[4]),this.l2_1.scaleInPlace(Y[5]),this.l20.scaleInPlace(Y[6]),this.l21.scaleInPlace(Y[7]),this.l22.scaleInPlace(Y[8])}updateFromArray(t){return I.DU.FromArrayToRef(t[0],0,this.l00),I.DU.FromArrayToRef(t[1],0,this.l1_1),I.DU.FromArrayToRef(t[2],0,this.l10),I.DU.FromArrayToRef(t[3],0,this.l11),I.DU.FromArrayToRef(t[4],0,this.l2_2),I.DU.FromArrayToRef(t[5],0,this.l2_1),I.DU.FromArrayToRef(t[6],0,this.l20),I.DU.FromArrayToRef(t[7],0,this.l21),I.DU.FromArrayToRef(t[8],0,this.l22),this}updateFromFloatsArray(t){return I.DU.FromFloatsToRef(t[0],t[1],t[2],this.l00),I.DU.FromFloatsToRef(t[3],t[4],t[5],this.l1_1),I.DU.FromFloatsToRef(t[6],t[7],t[8],this.l10),I.DU.FromFloatsToRef(t[9],t[10],t[11],this.l11),I.DU.FromFloatsToRef(t[12],t[13],t[14],this.l2_2),I.DU.FromFloatsToRef(t[15],t[16],t[17],this.l2_1),I.DU.FromFloatsToRef(t[18],t[19],t[20],this.l20),I.DU.FromFloatsToRef(t[21],t[22],t[23],this.l21),I.DU.FromFloatsToRef(t[24],t[25],t[26],this.l22),this}static pU(t){return(new G).updateFromArray(t)}static FromPolynomial(t){const U=new G;return U.l00=t.xx.scale(.376127).add(t.yy.scale(.376127)).add(t.zz.scale(.376126)),U.l1_1=t.y.scale(.977204),U.l10=t.z.scale(.977204),U.l11=t.x.scale(.977204),U.l2_2=t.xy.scale(1.16538),U.l2_1=t.yz.scale(1.16538),U.l20=t.zz.scale(1.34567).lU(t.xx.scale(.672834)).lU(t.yy.scale(.672834)),U.l21=t.zx.scale(1.16538),U.l22=t.xx.scale(1.16538).lU(t.yy.scale(1.16538)),U.l1_1.scaleInPlace(-1),U.l11.scaleInPlace(-1),U.l2_1.scaleInPlace(-1),U.l21.scaleInPlace(-1),U.scaleInPlace(Math.PI),U}}class M{constructor(){this.x=I.DU.Zero(),this.y=I.DU.Zero(),this.z=I.DU.Zero(),this.xx=I.DU.Zero(),this.yy=I.DU.Zero(),this.zz=I.DU.Zero(),this.xy=I.DU.Zero(),this.yz=I.DU.Zero(),this.zx=I.DU.Zero()}get preScaledHarmonics(){return this._harmonics||(this._harmonics=G.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(t){r.i.DU[0].aX(t.r,t.g,t.b);const U=r.i.DU[0];this.xx.addInPlace(U),this.yy.addInPlace(U),this.zz.addInPlace(U)}scaleInPlace(t){this.x.scaleInPlace(t),this.y.scaleInPlace(t),this.z.scaleInPlace(t),this.xx.scaleInPlace(t),this.yy.scaleInPlace(t),this.zz.scaleInPlace(t),this.yz.scaleInPlace(t),this.zx.scaleInPlace(t),this.xy.scaleInPlace(t)}updateFromHarmonics(t){return this._harmonics=t,this.x.Y(t.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.Y(t.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.Y(t.l10),this.z.scaleInPlace(1.02333),this.xx.Y(t.l00),r.i.DU[0].Y(t.l20).scaleInPlace(.247708),r.i.DU[1].Y(t.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).GL(r.i.DU[0]).addInPlace(r.i.DU[1]),this.yy.Y(t.l00),this.yy.scaleInPlace(.886277).GL(r.i.DU[0]).GL(r.i.DU[1]),this.zz.Y(t.l00),r.i.DU[0].Y(t.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(r.i.DU[0]),this.yz.Y(t.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.Y(t.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.Y(t.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(t){return(new M).updateFromHarmonics(t)}static pU(t){const U=new M;return I.DU.FromArrayToRef(t[0],0,U.x),I.DU.FromArrayToRef(t[1],0,U.y),I.DU.FromArrayToRef(t[2],0,U.z),I.DU.FromArrayToRef(t[3],0,U.xx),I.DU.FromArrayToRef(t[4],0,U.yy),I.DU.FromArrayToRef(t[5],0,U.zz),I.DU.FromArrayToRef(t[6],0,U.yz),I.DU.FromArrayToRef(t[7],0,U.zx),I.DU.FromArrayToRef(t[8],0,U.xy),U}}},12552:(t,U,y)=>{y.d(U,{c:()=>r});var I=y(12484);class r extends I.d{constructor(t){super(),this._buffer=t}get underlyingResource(){return this._buffer}}},12640:(t,U,y)=>{y.d(U,{c:()=>D,e:()=>b,g:()=>c,j:()=>f,n:()=>B});var I=y(12361),r=y(12469),Y=y(12366),mt=y(12501),X=y(12285),P=y(12338),G=y(12426),M=y(12505),L=y(12537);class h extends M.f{_gatherImports(t,U){t?(this._webGPUReady=!0,U.push(Promise.all([y.e(51).then(y.bind(y,14638))]))):U.push(Promise.all([y.e(52).then(y.bind(y,14647))])),super._gatherImports(t,U)}constructor(t){super({...arguments.length>2?arguments[2]:void 0,name:t,wU:(arguments.length>1&&void 0!==arguments[1]?arguments[1]:null)||L.c.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:h.FragmentUrl})}}h.FragmentUrl="pass";class Q extends M.f{_gatherImports(t,U){t?(this._webGPUReady=!0,U.push(Promise.all([y.e(62).then(y.bind(y,14714))]))):U.push(Promise.all([y.e(63).then(y.bind(y,14717))])),super._gatherImports(t,U)}constructor(t){super({...arguments.length>2?arguments[2]:void 0,name:t,wU:(arguments.length>1&&void 0!==arguments[1]?arguments[1]:null)||L.c.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Q.FragmentUrl,defines:"#define POSITIVEX"}),this._face=0}get face(){return this._face}set face(t){if(!(t<0||t>5))switch(this._face=t,this._face){case 0:this.updateEffect("#define POSITIVEX");break;case 1:this.updateEffect("#define NEGATIVEX");break;case 2:this.updateEffect("#define POSITIVEY");break;case 3:this.updateEffect("#define NEGATIVEY");break;case 4:this.updateEffect("#define POSITIVEZ");break;case 5:this.updateEffect("#define NEGATIVEZ")}}}Q.FragmentUrl="passCube";var F=y(12375);class E extends mt.e{getClassName(){return"PassPostProcess"}constructor(t,U){let y=arguments.length>4?arguments[4]:void 0;const I={size:"number"===typeof U?U:void 0,camera:arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,samplingMode:arguments.length>3?arguments[3]:void 0,wU:y,reusable:arguments.length>5?arguments[5]:void 0,textureType:arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,blockCompilation:arguments.length>7&&void 0!==arguments[7]&&arguments[7],...U};super(t,h.FragmentUrl,{effectWrapper:"number"!==typeof U&&U.effectWrapper?void 0:new h(t,y,I),...I})}static _Parse(t,U,y,I){return G.b.Parse((()=>new E(t.name,t.options,U,t.renderTargetSamplingMode,t._engine,t.reusable)),t,y,I)}}(0,P.f)("BABYLON.PassPostProcess",E);class w extends mt.e{get face(){return this._effectWrapper.face}set face(t){this._effectWrapper.face=t}getClassName(){return"PassCubePostProcess"}constructor(t,U){let y=arguments.length>4?arguments[4]:void 0;const I={size:"number"===typeof U?U:void 0,camera:arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,samplingMode:arguments.length>3?arguments[3]:void 0,wU:y,reusable:arguments.length>5?arguments[5]:void 0,textureType:arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,blockCompilation:arguments.length>7&&void 0!==arguments[7]&&arguments[7],...U};super(t,h.FragmentUrl,{effectWrapper:"number"!==typeof U&&U.effectWrapper?void 0:new Q(t,y,I),...I})}static _Parse(t,U,y,I){return G.b.Parse((()=>new w(t.name,t.options,U,t.renderTargetSamplingMode,t._engine,t.reusable)),t,y,I)}}function D(t,U,y,I,r,Y,X,P){const G=U.getEngine();return U.isReady=!1,r=r??U.samplingMode,I=I??U.type,Y=Y??U.format,X=X??U.width,P=P??U.height,-1===I&&(I=0),new Promise((M=>{const L=new mt.e("postprocess",t,null,null,1,null,r,G,!1,void 0,I,void 0,null,!1,Y);L.externalTextureSamplerBinding=!0;const h=G.createRenderTargetTexture({width:X,height:P},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:r,type:I,format:Y});L.onEffectCreatedObservable.addOnce((t=>{t.executeWhenCompiled((()=>{L.onApply=t=>{t._bindTexture("textureSampler",U),t.setFloat2("scale",1,1)},y.postProcessManager.directRender([L],h,!0),G.restoreDefaultFramebuffer(),G._releaseTexture(U),L&&L.dispose(),h._swapAndDie(U),U.type=I,U.format=5,U.isReady=!0,M(U)}))}))}))}let l,g;function B(t){l||(l=new Float32Array(1),g=new Int32Array(l.buffer)),l[0]=t;const U=g[0];let y=U>>16&32768,I=U>>12&2047;const r=U>>23&255;return r<103?y:r>142?(y|=31744,y|=(255==r?0:1)&&8388607&U,y):r<113?(I|=2048,y|=(I>>114-r)+(I>>113-r&1),y):(y|=r-112<<10|I>>1,y+=1&I,y)}function b(t){const U=(32768&t)>>15,y=(31744&t)>>10,I=1023&t;return 0===y?(U?-1:1)*Math.pow(2,-14)*(I/Math.pow(2,10)):31==y?I?NaN:1/0*(U?-1:1):(U?-1:1)*Math.pow(2,y-15)*(1+I/Math.pow(2,10))}(0,Y.b)([(0,F.I)()],w.prototype,"face",null),X.e._RescalePostProcessFactory=t=>new E("rescale",1,null,2,t,!1,0);const p=async(t,U,Y,X,P)=>{const G=t.St(),M=G.getEngine();let L;if(M.isWebGPU?t.isCube?await y.e(60).then(y.bind(y,14696)):await y.e(61).then(y.bind(y,14705)):t.isCube?await y.e(58).then(y.bind(y,14687)):await y.e(59).then(y.bind(y,14691)),t.isCube){const t=["#define POSITIVEX","#define NEGATIVEX","#define POSITIVEY","#define NEGATIVEY","#define POSITIVEZ","#define NEGATIVEZ"];L=new mt.e("lodCube","lodCube",{uniforms:["lod","gamma"],samplingMode:I.d.NEAREST_NEAREST_MIPNEAREST,wU:M,defines:t[X],shaderLanguage:M.isWebGPU?1:0})}else L=new mt.e("lod","lod",{uniforms:["lod","gamma"],samplingMode:I.d.NEAREST_NEAREST_MIPNEAREST,wU:M,shaderLanguage:M.isWebGPU?1:0});await new Promise((t=>{L.onEffectCreatedObservable.addOnce((U=>{U.executeWhenCompiled((()=>{t(0)}))}))}));const h=new r.d("temp",{width:U,height:Y},G,!1);L.onApply=function(U){U.setTexture("textureSampler",t),U.setFloat("lod",P),U.setInt("gamma",t.gammaSpace?1:0)};const Q=t.getInternalTexture();try{if(h.renderTarget&&Q){const y=Q.samplingMode;0!==P?t.updateSamplingMode(I.d.NEAREST_NEAREST_MIPNEAREST):t.updateSamplingMode(I.d.NEAREST_NEAREST),G.postProcessManager.directRender([L],h.renderTarget,!0),t.updateSamplingMode(y);const r=await M.readPixels(0,0,U,Y),mt=new Uint8Array(r.buffer,0,r.byteLength);return M.unBindFramebuffer(h.renderTarget),mt}throw Error("Render to texture failed.")}finally{h.dispose(),L.dispose()}};async function c(t,U,y){let I=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;return!t.isReady()&&t._texture&&await new Promise(((U,y)=>{null!==t._texture?t._texture.onLoadedObservable.addOnce((()=>{U(0)})):y(0)})),await p(t,U,y,I,r)}const f={CreateResizedCopy:function(t,U,y){let Y=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const mt=t.St(),X=mt.getEngine(),P=new r.d("resized"+t.name,{width:U,height:y},mt,!t.noMipmap,!0,t._texture.type,!1,t.samplingMode,!1);P.wrapU=t.wrapU,P.wrapV=t.wrapV,P.uOffset=t.uOffset,P.vOffset=t.vOffset,P.uScale=t.uScale,P.vScale=t.vScale,P.uAng=t.uAng,P.vAng=t.vAng,P.wAng=t.wAng,P.coordinatesIndex=t.coordinatesIndex,P.level=t.level,P.anisotropicFilteringLevel=t.anisotropicFilteringLevel,P._texture.isReady=!1,t.wrapU=I.d.CLAMP_ADDRESSMODE,t.wrapV=I.d.CLAMP_ADDRESSMODE;const G=new E("pass",1,null,Y?I.d.BILINEAR_SAMPLINGMODE:I.d.NEAREST_SAMPLINGMODE,X,!1,0);return G.externalTextureSamplerBinding=!0,G.onEffectCreatedObservable.addOnce((U=>{U.executeWhenCompiled((()=>{G.onApply=function(U){U.setTexture("textureSampler",t)};const U=P.renderTarget;U&&(mt.postProcessManager.directRender([G],U),X.unBindFramebuffer(U),P.disposeFramebufferObjects(),G.dispose(),P.getInternalTexture().isReady=!0)}))})),P},ApplyPostProcess:D,ToHalfFloat:B,FromHalfFloat:b,GetTextureDataAsync:c}},12501:(t,U,y)=>{y.d(U,{e:()=>F});var I=y(12366),r=y(12496),Y=y(12204),mt=y(12386),X=y(12287),P=y(12375),G=y(12426),M=y(12338),L=y(12285),h=y(12349),Q=y(12505);L.e.prototype.setTextureFromPostProcess=function(t,U,y){var I;let r=null;U&&(U._forcedOutputTexture?r=U._forcedOutputTexture:U._textures.data[U._currentRenderTextureInd]&&(r=U._textures.data[U._currentRenderTextureInd])),this._bindTexture(t,(null===(I=r)||void 0===I?void 0:I.texture)??null,y)},L.e.prototype.setTextureFromPostProcessOutput=function(t,U,y){var I;this._bindTexture(t,(null===U||void 0===U||null===(I=U._outputTexture)||void 0===I?void 0:I.texture)??null,y)},X.Effect.prototype.setTextureFromPostProcess=function(t,U){this._engine.setTextureFromPostProcess(this._samplers[t],U,t)},X.Effect.prototype.setTextureFromPostProcessOutput=function(t,U){this._engine.setTextureFromPostProcessOutput(this._samplers[t],U,t)};class F{static get ForceGLSL(){return Q.f.ForceGLSL}static set ForceGLSL(t){Q.f.ForceGLSL=t}static RegisterShaderCodeProcessing(t,U){Q.f.RegisterShaderCodeProcessing(t,U)}get name(){return this._effectWrapper.name}set name(t){this._effectWrapper.name=t}get alphaMode(){return this._effectWrapper.alphaMode}set alphaMode(t){this._effectWrapper.alphaMode=t}get samples(){return this._samples}set samples(t){this._samples=Math.min(t,this._engine.getCaps().maxMSAASamples),this._textures.forEach((t=>{t.setSamples(this._samples)}))}get shaderLanguage(){return this._shaderLanguage}getEffectName(){return this._fragmentUrl}set onActivate(t){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),t&&(this._onActivateObserver=this.onActivateObservable.add(t))}set onSizeChanged(t){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(t)}set onApply(t){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(t)}set onBeforeRender(t){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(t)}set onAfterRender(t){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(t)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(t){this._forcedOutputTexture=t}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.aX(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(t,U,y,I,X,P){var G;let M=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,L=arguments.length>7?arguments[7]:void 0,h=arguments.length>8?arguments[8]:void 0,E=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,w=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0,D=arguments.length>11&&void 0!==arguments[11]?arguments[11]:"postprocess",l=arguments.length>12?arguments[12]:void 0,g=arguments.length>13&&void 0!==arguments[13]&&arguments[13],B=arguments.length>14&&void 0!==arguments[14]?arguments[14]:5,b=arguments.length>15?arguments[15]:void 0,p=arguments.length>16?arguments[16]:void 0;this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.gX=!0,this.forceAutoClearInAlphaMode=!1,this.animations=[],this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._webGPUReady=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new r.e(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new mt.Vector2(1,1),this._texelSize=mt.Vector2.Zero(),this.onActivateObservable=new Y.b,this.onSizeChangedObservable=new Y.b,this.onApplyObservable=new Y.b,this.onBeforeRenderObservable=new Y.b,this.onAfterRenderObservable=new Y.b,this.FX=new Y.b;let c,f=1,S=null;if(y&&!Array.isArray(y)){const t=y;y=t.uniforms??null,I=t.samplers??null,f=t.size??1,P=t.camera??null,M=t.samplingMode??1,L=t.wU,h=t.reusable,E=Array.isArray(t.defines)?t.defines.join("\n"):t.defines??null,w=t.textureType??0,D=t.vertexUrl??"postprocess",l=t.indexParameters,g=t.blockCompilation??!1,B=t.textureFormat??5,b=t.shaderLanguage??0,S=t.uniformBuffers??null,p=t.extraInitializations,c=t.effectWrapper}else X&&(f="number"===typeof X?X:{width:X.width,height:X.height});if(this._useExistingThinPostProcess=!!c,this._effectWrapper=c??new Q.f({name:t,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:U,wU:L||(null===(G=P)||void 0===G?void 0:G.St().getEngine()),uniforms:y,samplers:I,uniformBuffers:S,defines:E,vertexUrl:D,indexParameters:l,blockCompilation:!0,shaderLanguage:b,extraInitializations:void 0}),this.name=t,this.onEffectCreatedObservable=this._effectWrapper.onEffectCreatedObservable,null!=P?(this._camera=P,this._scene=P.St(),P.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):L&&(this._engine=L,this._engine.postProcesses.push(this)),this._options=f,this.renderTargetSamplingMode=M||1,this._reusable=h||!1,this._textureType=w,this._textureFormat=B,this._shaderLanguage=b||0,this._samplers=I||[],-1===this._samplers.indexOf("textureSampler")&&this._samplers.push("textureSampler"),this._fragmentUrl=U,this._vertexUrl=D,this._parameters=y||[],-1===this._parameters.indexOf("scale")&&this._parameters.push("scale"),this._uniformBuffers=S||[],this._indexParameters=l,!this._useExistingThinPostProcess){this._webGPUReady=1===this._shaderLanguage;const t=[];this._gatherImports(this._engine.isWebGPU&&!F.ForceGLSL,t),this._effectWrapper._webGPUReady=this._webGPUReady,this._effectWrapper._postConstructor(g,E,p,t)}}_gatherImports(){let t=arguments.length>1?arguments[1]:void 0;arguments.length>0&&void 0!==arguments[0]&&arguments[0]&&this._webGPUReady?t.push(Promise.all([y.e(53).then(y.bind(y,14655))])):t.push(Promise.all([Promise.resolve().then(y.bind(y,12528))]))}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._effectWrapper.drawWrapper.effect}shareOutputWith(t){return this._disposeTextures(),this._shareOutputWithPostProcess=t,this}useOwnOutput(){0==this._textures.length&&(this._textures=new r.e(2)),this._shareOutputWithPostProcess=null}updateEffect(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,U=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,y=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,I=arguments.length>3?arguments[3]:void 0,r=arguments.length>4?arguments[4]:void 0,Y=arguments.length>5?arguments[5]:void 0,mt=arguments.length>6?arguments[6]:void 0,X=arguments.length>7?arguments[7]:void 0;this._effectWrapper.updateEffect(t,U,y,I,r,Y,mt,X),this._postProcessDefines=Array.isArray(this._effectWrapper.options.defines)?this._effectWrapper.options.defines.join("\n"):this._effectWrapper.options.defines}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(t,U){let y=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;for(let r=0;r<this._textureCache.length;r++)if(this._textureCache[r].texture.width===t.width&&this._textureCache[r].texture.height===t.height&&this._textureCache[r].postProcessChannel===y&&this._textureCache[r].texture._generateDepthBuffer===U.generateDepthBuffer&&this._textureCache[r].texture.samples===U.samples)return this._textureCache[r].texture;const I=this._engine.createRenderTargetTexture(t,U);return this._textureCache.push({texture:I,postProcessChannel:y,lastUsedRenderId:-1}),I}_flushTextureCache(){const t=this._renderId;for(let U=this._textureCache.length-1;U>=0;U--)if(t-this._textureCache[U].lastUsedRenderId>100){let t=!1;for(let y=0;y<this._textures.length;y++)if(this._textures.data[y]===this._textureCache[U].texture){t=!0;break}t||(this._textureCache[U].texture.dispose(),this._textureCache.splice(U,1))}}resize(t,U){let y=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,I=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=arguments.length>4&&void 0!==arguments[4]&&arguments[4];this._textures.length>0&&this._textures.reset(),this.width=t,this.height=U;let Y=null;if(y)for(let P=0;P<y._postProcesses.length;P++)if(null!==y._postProcesses[P]){Y=y._postProcesses[P];break}const mt={width:this.width,height:this.height},X={generateMipMaps:I,generateDepthBuffer:r||Y===this,generateStencilBuffer:(r||Y===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples,label:"PostProcessRTT-"+this.name};this._textures.push(this._createRenderTargetTexture(mt,X,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(mt,X,1)),this._texelSize.aX(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}_getTarget(){let t;if(this._shareOutputWithPostProcess)t=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)t=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{let U;t=this.inputTexture;for(let y=0;y<this._textureCache.length;y++)if(this._textureCache[y].texture===t){U=this._textureCache[y];break}U&&(U.lastUsedRenderId=this._renderId)}return t}activate(t){var U,y;let I=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2?arguments[2]:void 0;const Y=null===t||void 0!==t.cameraRigMode?t||this._camera:null,mt=(null===Y||void 0===Y?void 0:Y.St())??t,X=mt.getEngine(),P=X.getCaps().maxTextureSize,G=(I?I.width:this._engine.getRenderWidth(!0))*this._options|0,M=(I?I.height:this._engine.getRenderHeight(!0))*this._options|0;let L=this._options.width||G,Q=this._options.height||M;const F=7!==this.renderTargetSamplingMode&&1!==this.renderTargetSamplingMode&&2!==this.renderTargetSamplingMode;let E=null;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const t=X.currentViewport;t&&(L*=t.width,Q*=t.height)}(F||this.alwaysForcePOT)&&(this._options.width||(L=X.needPOTTextures?(0,h.f)(L,P,this.scaleMode):L),this._options.height||(Q=X.needPOTTextures?(0,h.f)(Q,P,this.scaleMode):Q)),this.width===L&&this.height===Q&&(E=this._getTarget())||this.resize(L,Q,Y,F,r),this._textures.forEach((t=>{t.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(t,this.samples)})),this._flushTextureCache(),this._renderId++}return E||(E=this._getTarget()),this.enablePixelPerfectMode?(this._scaleRatio.aX(G/L,M/Q),this._engine.bindFramebuffer(E,0,G,M,this.forceFullscreenViewport)):(this._scaleRatio.aX(1,1),this._engine.bindFramebuffer(E,0,void 0,void 0,this.forceFullscreenViewport)),null===(U=(y=this._engine)._debugInsertMarker)||void 0===U||U.call(y,`post process ${this.name} input`),this.onActivateObservable.notifyObservers(Y),this.gX&&(0===this.alphaMode||this.forceAutoClearInAlphaMode)&&this._engine.clear(this.clearColor?this.clearColor:mt.clearColor,mt._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),E}get isSupported(){return this._effectWrapper.drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){return this._effectWrapper.isReady()}apply(){if(!this._effectWrapper.isReady())return null;let t;var U;(this._engine.enableEffect(this._effectWrapper.drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a),this._engine.setAlphaMode(this.alphaMode),t=this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?this._forcedOutputTexture:this.inputTexture,this.externalTextureSamplerBinding)||this._effectWrapper.drawWrapper.effect._bindTexture("textureSampler",null===(U=t)||void 0===U?void 0:U.texture);return this._effectWrapper.drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._effectWrapper.drawWrapper.effect),this._effectWrapper.bind(!0),this._effectWrapper.drawWrapper.effect}_disposeTextures(){this._shareOutputWithPostProcess||this._forcedOutputTexture?this._disposeTextureCache():(this._disposeTextureCache(),this._textures.dispose())}_disposeTextureCache(){for(let t=this._textureCache.length-1;t>=0;t--)this._textureCache[t].texture.dispose();this._textureCache.length=0}setPrePassRenderer(t){return!!this._prePassEffectConfiguration&&(this._prePassEffectConfiguration=t.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0)}dispose(t){let U;if(t=t||this._camera,this._useExistingThinPostProcess||this._effectWrapper.dispose(),this._disposeTextures(),this._scene&&(U=this._scene.postProcesses.indexOf(this),-1!==U&&this._scene.postProcesses.splice(U,1)),this._parentContainer){const t=this._parentContainer.postProcesses.indexOf(this);t>-1&&this._parentContainer.postProcesses.splice(t,1),this._parentContainer=null}if(U=this._engine.postProcesses.indexOf(this),-1!==U&&this._engine.postProcesses.splice(U,1),this.FX.notifyObservers(),t){if(t.detachPostProcess(this),U=t._postProcesses.indexOf(this),0===U&&t._postProcesses.length>0){const t=this._camera._getFirstPostProcess();t&&t.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear(),this.onEffectCreatedObservable.clear()}}serialize(){const t=G.b.Serialize(this),U=this.getCamera()||this._scene&&this._scene.activeCamera;return t.customType="BABYLON."+this.getClassName(),t.cameraId=U?U.id:null,t.reusable=this._reusable,t.textureType=this._textureType,t.fragmentUrl=this._fragmentUrl,t.parameters=this._parameters,t.samplers=this._samplers,t.uniformBuffers=this._uniformBuffers,t.options=this._options,t.defines=this._postProcessDefines,t.textureFormat=this._textureFormat,t.vertexUrl=this._vertexUrl,t.indexParameters=this._indexParameters,t}clone(){const t=this.serialize();t._engine=this._engine,t.cameraId=null;const U=F.Parse(t,this._scene,"");return U?(U.onActivateObservable=this.onActivateObservable.clone(),U.onSizeChangedObservable=this.onSizeChangedObservable.clone(),U.onApplyObservable=this.onApplyObservable.clone(),U.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),U.onAfterRenderObservable=this.onAfterRenderObservable.clone(),U._prePassEffectConfiguration=this._prePassEffectConfiguration,U):null}static Parse(t,U,y){const I=(0,M.d)(t.customType);if(!I||!I._Parse)return null;const r=U?U.getCameraById(t.cameraId):null;return I._Parse(t,r,U,y)}static _Parse(t,U,y,I){return G.b.Parse((()=>new F(t.name,t.fragmentUrl,t.parameters,t.samplers,t.options,U,t.renderTargetSamplingMode,t._engine,t.reusable,t.defines,t.textureType,t.vertexUrl,t.indexParameters,!1,t.textureFormat)),t,y,I)}}(0,I.b)([(0,P.I)()],F.prototype,"uniqueId",void 0),(0,I.b)([(0,P.I)()],F.prototype,"name",null),(0,I.b)([(0,P.I)()],F.prototype,"width",void 0),(0,I.b)([(0,P.I)()],F.prototype,"height",void 0),(0,I.b)([(0,P.I)()],F.prototype,"renderTargetSamplingMode",void 0),(0,I.b)([(0,P.n)()],F.prototype,"clearColor",void 0),(0,I.b)([(0,P.I)()],F.prototype,"gX",void 0),(0,I.b)([(0,P.I)()],F.prototype,"forceAutoClearInAlphaMode",void 0),(0,I.b)([(0,P.I)()],F.prototype,"alphaMode",null),(0,I.b)([(0,P.I)()],F.prototype,"alphaConstants",void 0),(0,I.b)([(0,P.I)()],F.prototype,"enablePixelPerfectMode",void 0),(0,I.b)([(0,P.I)()],F.prototype,"forceFullscreenViewport",void 0),(0,I.b)([(0,P.I)()],F.prototype,"scaleMode",void 0),(0,I.b)([(0,P.I)()],F.prototype,"alwaysForcePOT",void 0),(0,I.b)([(0,P.I)("samples")],F.prototype,"_samples",void 0),(0,I.b)([(0,P.I)()],F.prototype,"adaptScaleToCurrentViewport",void 0),(0,M.f)("BABYLON.PostProcess",F)},12528:(t,U,y)=>{y.r(U),y.d(U,{postprocessVertexShader:()=>mt});var I=y(12296);const r="postprocessVertexShader",Y="attribute vec2 position;uniform vec2 scale;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=(position*madd+madd)*scale;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";I.e.ShadersStore[r]||(I.e.ShadersStore[r]=Y);const mt={name:r,shader:Y}}}]);