"use strict";(self["7c63p8lin4r"]=self["7c63p8lin4r"]||[]).push([[18],{13108:(z,u,U)=>{U(12827).b.prototype.createDepthStencilTexture=function(z,u,U){if(u.isCube){const U=z.width||z;return this._createDepthStencilCubeTexture(U,u)}return this._createDepthStencilTexture(z,u,U)}},13085:(z,u,U)=>{U(13054).ThinEngine.prototype.setAlphaMode=function(z){let u=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._alphaMode!==z){switch(z){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0}u||(this.depthCullingState.depthMask=0===z),this._alphaMode=z}else if(!u){const u=0===z;this.depthCullingState.depthMask!==u&&(this.depthCullingState.depthMask=u)}}},13092:(z,u,U)=>{var J=U(13054);J.ThinEngine.prototype.updateDynamicIndexBuffer=function(z,u){let U;this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(z),U=z.is32Bits?u instanceof Uint32Array?u:new Uint32Array(u):u instanceof Uint16Array?u:new Uint16Array(u),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,U,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()},J.ThinEngine.prototype.updateDynamicVertexBuffer=function(z,u,U,J){this.bindArrayBuffer(z),void 0===U&&(U=0);const v=u.byteLength||u.length;void 0===J||J>=v&&0===U?u instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,U,new Float32Array(u)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,U,u):u instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,U,new Float32Array(u).subarray(0,J/4)):(u=u instanceof ArrayBuffer?new Uint8Array(u,0,J):new Uint8Array(u.buffer,u.byteOffset,J),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,U,u)),this._resetVertexBufferBinding()}},13098:(z,u,U)=>{var J=U(21),v=U(12853),f=U(12760),g=U(13054),w=U(13100),P=U(13083);class R extends w.c{setDepthStencilTexture(z){let u=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(super.setDepthStencilTexture(z,u),!z)return;const U=this._engine,J=this._context,v=z._hardwareTexture;if(v&&z._autoMSAAManagement&&this._MSAAFramebuffer){const u=U._currentFramebuffer;U._bindUnboundFramebuffer(this._MSAAFramebuffer),J.framebufferRenderbuffer(J.FRAMEBUFFER,(0,P.c)(z.format)?J.DEPTH_STENCIL_ATTACHMENT:J.DEPTH_ATTACHMENT,J.RENDERBUFFER,v.getMSAARenderBuffer()),U._bindUnboundFramebuffer(u)}}constructor(z,u,U,J,v){super(z,u,U,J),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._disposeOnlyFramebuffers=!1,this._currentLOD=0,this._context=v}_cloneRenderTargetWrapper(){let z=null;return this._colorTextureArray&&this._depthStencilTextureArray?(z=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),z.texture.isReady=!0):z=super._cloneRenderTargetWrapper(),z}_swapRenderTargetWrapper(z){super._swapRenderTargetWrapper(z),z._framebuffer=this._framebuffer,z._depthStencilBuffer=this._depthStencilBuffer,z._MSAAFramebuffer=this._MSAAFramebuffer,z._colorTextureArray=this._colorTextureArray,z._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}createDepthStencilTexture(){let z=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,u=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],U=arguments.length>2&&void 0!==arguments[2]&&arguments[2],J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,v=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14,f=arguments.length>5?arguments[5]:void 0;if(this._depthStencilBuffer){const z=this._engine,u=z._currentFramebuffer,U=this._context;z._bindUnboundFramebuffer(this._framebuffer),U.framebufferRenderbuffer(U.FRAMEBUFFER,U.DEPTH_STENCIL_ATTACHMENT,U.RENDERBUFFER,null),U.framebufferRenderbuffer(U.FRAMEBUFFER,U.DEPTH_ATTACHMENT,U.RENDERBUFFER,null),U.framebufferRenderbuffer(U.FRAMEBUFFER,U.STENCIL_ATTACHMENT,U.RENDERBUFFER,null),z._bindUnboundFramebuffer(u),U.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null}return super.createDepthStencilTexture(z,u,U,J,v,f)}shareDepth(z){super.shareDepth(z);const u=this._context,U=this._depthStencilBuffer,J=z._MSAAFramebuffer||z._framebuffer,v=this._engine;z._depthStencilBuffer&&z._depthStencilBuffer!==U&&u.deleteRenderbuffer(z._depthStencilBuffer),z._depthStencilBuffer=U;const f=z._generateStencilBuffer?u.DEPTH_STENCIL_ATTACHMENT:u.DEPTH_ATTACHMENT;v._bindUnboundFramebuffer(J),u.framebufferRenderbuffer(u.FRAMEBUFFER,f,u.RENDERBUFFER,U),v._bindUnboundFramebuffer(null)}_bindTextureRenderTarget(z){let u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,U=arguments.length>2?arguments[2]:void 0,J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const v=z._hardwareTexture;if(!v)return;const f=this._framebuffer,g=this._engine,w=g._currentFramebuffer;let P;if(g._bindUnboundFramebuffer(f),g.webGLVersion>1){const f=this._context;var R,S,d;if(P=f["COLOR_ATTACHMENT"+u],z.is2DArray||z.is3D)U=null!==(R=null!==(S=U)&&void 0!==S?S:null===(d=this.layerIndices)||void 0===d?void 0:d[u])&&void 0!==R?R:0,f.framebufferTextureLayer(f.FRAMEBUFFER,P,v.underlyingResource,J,U);else if(z.isCube){var mz,Z,A;U=null!==(mz=null!==(Z=U)&&void 0!==Z?Z:null===(A=this.faceIndices)||void 0===A?void 0:A[u])&&void 0!==mz?mz:0,f.framebufferTexture2D(f.FRAMEBUFFER,P,f.TEXTURE_CUBE_MAP_POSITIVE_X+U,v.underlyingResource,J)}else f.framebufferTexture2D(f.FRAMEBUFFER,P,f.TEXTURE_2D,v.underlyingResource,J)}else{const z=this._context;P=z["COLOR_ATTACHMENT"+u+"_WEBGL"];const f=void 0!==U?z.TEXTURE_CUBE_MAP_POSITIVE_X+U:z.TEXTURE_2D;z.framebufferTexture2D(z.FRAMEBUFFER,P,f,v.underlyingResource,J)}if(z._autoMSAAManagement&&this._MSAAFramebuffer){const z=this._context;g._bindUnboundFramebuffer(this._MSAAFramebuffer),z.framebufferRenderbuffer(z.FRAMEBUFFER,P,z.RENDERBUFFER,v.getMSAARenderBuffer())}g._bindUnboundFramebuffer(w)}setTexture(z){let u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,U=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];super.setTexture(z,u,U),this._bindTextureRenderTarget(z,u)}setLayerAndFaceIndices(z,u){var U,J;if(super.setLayerAndFaceIndices(z,u),!this.textures||!this.layerIndices||!this.faceIndices)return;const v=null!==(U=null===(J=this._attachments)||void 0===J?void 0:J.length)&&void 0!==U?U:this.textures.length;for(let f=0;f<v;f++){const z=this.textures[f];z&&(z.is2DArray||z.is3D?this._bindTextureRenderTarget(z,f,this.layerIndices[f]):z.isCube?this._bindTextureRenderTarget(z,f,this.faceIndices[f]):this._bindTextureRenderTarget(z,f))}}setLayerAndFaceIndex(){let z=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,u=arguments.length>1?arguments[1]:void 0,U=arguments.length>2?arguments[2]:void 0;if(super.setLayerAndFaceIndex(z,u,U),!this.textures||!this.layerIndices||!this.faceIndices)return;const J=this.textures[z];J.is2DArray||J.is3D?this._bindTextureRenderTarget(this.textures[z],z,this.layerIndices[z]):J.isCube&&this._bindTextureRenderTarget(this.textures[z],z,this.faceIndices[z])}resolveMSAATextures(){const z=this._engine,u=z._currentFramebuffer;z._bindUnboundFramebuffer(this._MSAAFramebuffer),super.resolveMSAATextures(),z._bindUnboundFramebuffer(u)}dispose(){let z=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._disposeOnlyFramebuffers;const u=this._context;z||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(u.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(u.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(u.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(z)}}U(13108);g.ThinEngine.prototype._createHardwareRenderTargetWrapper=function(z,u,U){const J=new R(z,u,U,this,this._gl);return this._renderTargetWrapperCache.push(J),J},g.ThinEngine.prototype.createRenderTargetTexture=function(z,u){var U;const J=this._createHardwareRenderTargetWrapper(!1,!1,z);let v,f,g=!0,w=!1,P=!1,R=1;var S,d;void 0!==u&&"object"===typeof u&&(g=null===(S=u.generateDepthBuffer)||void 0===S||S,w=!!u.generateStencilBuffer,P=!!u.noColorAttachment,v=u.colorAttachment,R=null!==(d=u.samples)&&void 0!==d?d:1,f=u.label);const mz=v||(P?null:this._createInternalTexture(z,u,!0,5)),Z=z.width||z,A=z.height||z,E=this._currentFramebuffer,C=this._gl,r=C.createFramebuffer();if(this._bindUnboundFramebuffer(r),J._depthStencilBuffer=this._setupFramebufferDepthAttachments(w,g,Z,A),!mz||mz.is2DArray||mz.is3D||C.framebufferTexture2D(C.FRAMEBUFFER,C.COLOR_ATTACHMENT0,C.TEXTURE_2D,mz._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(E),J.label=null!==(U=f)&&void 0!==U?U:"RenderTargetWrapper",J._framebuffer=r,J._generateDepthBuffer=g,J._generateStencilBuffer=w,J.setTextures(mz),v){if(J._samples=v.samples,v.samples>1){const z=v._hardwareTexture.getMSAARenderBuffer(0);J._MSAAFramebuffer=C.createFramebuffer(),this._bindUnboundFramebuffer(J._MSAAFramebuffer),C.framebufferRenderbuffer(C.FRAMEBUFFER,C.COLOR_ATTACHMENT0,C.RENDERBUFFER,z),this._bindUnboundFramebuffer(null)}}else this.updateRenderTargetTextureSampleCount(J,R);return J},g.ThinEngine.prototype._createDepthStencilTexture=function(z,u,U){var g;const w=this._gl,R=z.layers||0,S=z.depth||0;let d=w.TEXTURE_2D;0!==R?d=w.TEXTURE_2D_ARRAY:0!==S&&(d=w.TEXTURE_3D);const mz=new v.c(this,12);if(mz.label=u.label,!this._caps.depthTextureExtension)return f.d.Error("Depth texture is not supported by your browser or hardware."),mz;const Z=(0,J.e)({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},u);if(this._bindTextureDirectly(d,mz,!0),this._setupDepthStencilTexture(mz,z,0!==Z.comparisonFunction&&Z.bilinearFiltering,Z.comparisonFunction,Z.samples),void 0!==Z.depthTextureFormat){if(15!==Z.depthTextureFormat&&16!==Z.depthTextureFormat&&17!==Z.depthTextureFormat&&13!==Z.depthTextureFormat&&14!==Z.depthTextureFormat&&18!==Z.depthTextureFormat)return f.d.Error("Depth texture ".concat(Z.depthTextureFormat," format is not supported.")),mz;mz.format=Z.depthTextureFormat}else mz.format=Z.generateStencil?13:16;const A=(0,P.c)(mz.format),E=this._getWebGLTextureTypeFromDepthTextureFormat(mz.format),C=A?w.DEPTH_STENCIL:w.DEPTH_COMPONENT,r=this._getInternalFormatFromDepthTextureFormat(mz.format,!0,A);return mz.is2DArray?w.texImage3D(d,0,r,mz.width,mz.height,R,0,C,E,null):mz.is3D?w.texImage3D(d,0,r,mz.width,mz.height,S,0,C,E,null):w.texImage2D(d,0,r,mz.width,mz.height,0,C,E,null),this._bindTextureDirectly(d,null),this._internalTexturesCache.push(mz),U._depthStencilBuffer&&(w.deleteRenderbuffer(U._depthStencilBuffer),U._depthStencilBuffer=null),this._bindUnboundFramebuffer(null!==(g=U._MSAAFramebuffer)&&void 0!==g?g:U._framebuffer),U._generateStencilBuffer=A,U._depthStencilTextureWithStencil=A,U._depthStencilBuffer=this._setupFramebufferDepthAttachments(U._generateStencilBuffer,U._generateDepthBuffer,U.width,U.height,U.samples,mz.format),this._bindUnboundFramebuffer(null),mz},g.ThinEngine.prototype.updateRenderTargetTextureSampleCount=function(z,u){var U,J;if(this.webGLVersion<2||!z)return 1;if(z.samples===u)return u;const v=this._gl;u=Math.min(u,this.getCaps().maxMSAASamples),z._depthStencilBuffer&&(v.deleteRenderbuffer(z._depthStencilBuffer),z._depthStencilBuffer=null),z._MSAAFramebuffer&&(v.deleteFramebuffer(z._MSAAFramebuffer),z._MSAAFramebuffer=null);const f=null===(U=z.texture)||void 0===U?void 0:U._hardwareTexture;if(null===f||void 0===f||f.releaseMSAARenderBuffers(),z.texture&&u>1&&"function"===typeof v.renderbufferStorageMultisample){const U=v.createFramebuffer();if(!U)throw new Error("Unable to create multi sampled framebuffer");z._MSAAFramebuffer=U,this._bindUnboundFramebuffer(z._MSAAFramebuffer);const J=this._createRenderBuffer(z.texture.width,z.texture.height,u,-1,this._getRGBABufferInternalSizedFormat(z.texture.type,z.texture.format,z.texture._useSRGBBuffer),v.COLOR_ATTACHMENT0,!1);if(!J)throw new Error("Unable to create multi sampled framebuffer");null===f||void 0===f||f.addMSAARenderBuffer(J)}this._bindUnboundFramebuffer(null!==(J=z._MSAAFramebuffer)&&void 0!==J?J:z._framebuffer),z.texture&&(z.texture.samples=u),z._samples=u;const g=z._depthStencilTexture?z._depthStencilTexture.format:void 0;return z._depthStencilBuffer=this._setupFramebufferDepthAttachments(z._generateStencilBuffer,z._generateDepthBuffer,z.width,z.height,u,g),this._bindUnboundFramebuffer(null),u},g.ThinEngine.prototype._setupDepthStencilTexture=function(z,u,U,J){var v,f;let g=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;const w=null!==(v=u.width)&&void 0!==v?v:u,P=null!==(f=u.height)&&void 0!==f?f:u,R=u.layers||0,S=u.depth||0;z.baseWidth=w,z.baseHeight=P,z.width=w,z.height=P,z.is2DArray=R>0,z.depth=R||S,z.isReady=!0,z.samples=g,z.generateMipMaps=!1,z.samplingMode=U?2:1,z.type=0,z._comparisonFunction=J;const d=this._gl,mz=this._getTextureTarget(z),Z=this._getSamplingParameters(z.samplingMode,!1);d.texParameteri(mz,d.TEXTURE_MAG_FILTER,Z.mag),d.texParameteri(mz,d.TEXTURE_MIN_FILTER,Z.min),d.texParameteri(mz,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(mz,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),this.webGLVersion>1&&(0===J?(d.texParameteri(mz,d.TEXTURE_COMPARE_FUNC,515),d.texParameteri(mz,d.TEXTURE_COMPARE_MODE,d.NONE)):(d.texParameteri(mz,d.TEXTURE_COMPARE_FUNC,J),d.texParameteri(mz,d.TEXTURE_COMPARE_MODE,d.COMPARE_REF_TO_TEXTURE)))}},13076:(z,u,U)=>{U.d(u,{d:()=>J});class J{get underlyingResource(){return this._webGLTexture}constructor(){let z=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,u=arguments.length>1?arguments[1]:void 0;if(this._MSAARenderBuffers=null,this._context=u,!z&&(z=u.createTexture(),!z))throw new Error("Unable to create webGL texture");this.set(z)}setUsage(){}set(z){this._webGLTexture=z}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(z){this._MSAARenderBuffers||(this._MSAARenderBuffers=[]),this._MSAARenderBuffers.push(z)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(const z of this._MSAARenderBuffers)this._context.deleteRenderbuffer(z);this._MSAARenderBuffers=null}}getMSAARenderBuffer(){var z,u;let U=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return null!==(z=null===(u=this._MSAARenderBuffers)||void 0===u?void 0:u[U])&&void 0!==z?z:null}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}},13050:(z,u,U)=>{U.d(u,{b:()=>O});var J=U(12853),v=U(12797),f=U(13054),g=U(12777);class w{constructor(){let z=arguments.length>0&&void 0!==arguments[0]?arguments[0]:30;this._enabled=!0,this._rollingFrameTime=new P(z)}sampleFrame(){let z=arguments.length>0&&void 0!==arguments[0]?arguments[0]:g.e.Now;if(this._enabled){if(null!=this._lastFrameTimeMs){const u=z-this._lastFrameTimeMs;this._rollingFrameTime.add(u)}this._lastFrameTimeMs=z}}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){const z=this._rollingFrameTime.history(0);return 0===z?0:1e3/z}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}}class P{constructor(z){this._samples=new Array(z),this.reset()}add(z){let u;if(this.isSaturated()){const z=this._samples[this._pos];u=z-this.average,this.average-=u/(this._sampleCount-1),this._m2-=u*(z-this.average)}else this._sampleCount++;u=z-this.average,this.average+=u/this._sampleCount,this._m2+=u*(z-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=z,this._pos++,this._pos%=this._samples.length}history(z){if(z>=this._sampleCount||z>=this._samples.length)return 0;const u=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(u-z)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(z){const u=this._samples.length;return(z%u+u)%u}}var R=U(13072),S=U(12760),d=U(13076),mz=(U(13085),U(12882));function Z(z,u,U,J){let v,f=1;1===J?v=new Float32Array(u*U*4):2===J?(v=new Uint16Array(u*U*4),f=15360):v=7===J?new Uint32Array(u*U*4):new Uint8Array(u*U*4);for(let g=0;g<u;g++)for(let J=0;J<U;J++){const U=3*(J*u+g),w=4*(J*u+g);v[w+0]=z[U+0],v[w+1]=z[U+1],v[w+2]=z[U+2],v[w+3]=f}return v}function A(z){return function(u,U,v,f,g,w,P,R){let S=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,d=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;const mz=z?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,Z=z?10:11,A=new J.c(this,Z);A.baseWidth=U,A.baseHeight=v,A.baseDepth=f,A.width=U,A.height=v,A.depth=f,A.format=g,A.type=d,A.generateMipMaps=w,A.samplingMode=R,z?A.is3D=!0:A.is2DArray=!0,this._doNotHandleContextLost||(A._bufferView=u),z?this.updateRawTexture3D(A,u,g,P,S,d):this.updateRawTexture2DArray(A,u,g,P,S,d),this._bindTextureDirectly(mz,A,!0);const E=this._getSamplingParameters(R,w);return this._gl.texParameteri(mz,this._gl.TEXTURE_MAG_FILTER,E.mag),this._gl.texParameteri(mz,this._gl.TEXTURE_MIN_FILTER,E.min),w&&this._gl.generateMipmap(mz),this._bindTextureDirectly(mz,null),this._internalTexturesCache.push(A),A}}function E(z){return function(u,U,J,v){let f=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,g=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;const w=z?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,P=this._getWebGLTextureType(g),R=this._getInternalFormat(J),S=this._getRGBABufferInternalSizedFormat(g,J);this._bindTextureDirectly(w,u,!0),this._unpackFlipY(void 0===v||!!v),this._doNotHandleContextLost||(u._bufferView=U,u.format=J,u.invertY=v,u._compression=f),u.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),f&&U?this._gl.compressedTexImage3D(w,0,this.getCaps().s3tc[f],u.width,u.height,u.depth,0,U):this._gl.texImage3D(w,0,S,u.width,u.height,u.depth,0,R,P,U),u.generateMipMaps&&this._gl.generateMipmap(w),this._bindTextureDirectly(w,null),u.isReady=!0}}f.ThinEngine.prototype.updateRawTexture=function(z,u,U,J){let v=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,f=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,g=arguments.length>6&&void 0!==arguments[6]&&arguments[6];if(!z)return;const w=this._getRGBABufferInternalSizedFormat(f,U,g),P=this._getInternalFormat(U),R=this._getWebGLTextureType(f);this._bindTextureDirectly(this._gl.TEXTURE_2D,z,!0),this._unpackFlipY(void 0===J||!!J),this._doNotHandleContextLost||(z._bufferView=u,z.format=U,z.type=f,z.invertY=J,z._compression=v),z.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),v&&u?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[v],z.width,z.height,0,u):this._gl.texImage2D(this._gl.TEXTURE_2D,0,w,z.width,z.height,0,P,R,u),z.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),z.isReady=!0},f.ThinEngine.prototype.createRawTexture=function(z,u,U,v,f,g,w){let P=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,R=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,S=arguments.length>10&&void 0!==arguments[10]&&arguments[10];const d=new J.c(this,3);d.baseWidth=u,d.baseHeight=U,d.width=u,d.height=U,d.format=v,d.generateMipMaps=f,d.samplingMode=w,d.invertY=g,d._compression=P,d.type=R,d._useSRGBBuffer=this._getUseSRGBBuffer(S,!f),this._doNotHandleContextLost||(d._bufferView=z),this.updateRawTexture(d,z,v,g,P,R,d._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,d,!0);const mz=this._getSamplingParameters(w,f);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,mz.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,mz.min),f&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(d),d},f.ThinEngine.prototype.createRawCubeTexture=function(z,u,U,v,f,g,w){let P=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;const R=this._gl,d=new J.c(this,8);d.isCube=!0,d.format=U,d.type=v,this._doNotHandleContextLost||(d._bufferViewArray=z);const Z=this._getWebGLTextureType(v);let A=this._getInternalFormat(U);A===R.RGB&&(A=R.RGBA),Z!==R.FLOAT||this._caps.textureFloatLinearFiltering?Z!==this._gl.HALF_FLOAT_OES||this._caps.textureHalfFloatLinearFiltering?Z!==R.FLOAT||this._caps.textureFloatRender?Z!==R.HALF_FLOAT||this._caps.colorBufferFloat||(f=!1,S.d.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(f=!1,S.d.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(f=!1,w=1,S.d.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(f=!1,w=1,S.d.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively."));const E=u,C=E;d.width=E,d.height=C,d.invertY=g,d._compression=P;if(!this.needPOTTextures||(0,mz.e)(d.width)&&(0,mz.e)(d.height)||(f=!1),z)this.updateRawCubeTexture(d,z,U,v,g,P);else{const z=this._getRGBABufferInternalSizedFormat(v),u=0;this._bindTextureDirectly(R.TEXTURE_CUBE_MAP,d,!0);for(let U=0;U<6;U++)P?R.compressedTexImage2D(R.TEXTURE_CUBE_MAP_POSITIVE_X+U,u,this.getCaps().s3tc[P],d.width,d.height,0,void 0):R.texImage2D(R.TEXTURE_CUBE_MAP_POSITIVE_X+U,u,z,d.width,d.height,0,A,Z,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,d,!0),z&&f&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);const r=this._getSamplingParameters(w,f);return R.texParameteri(R.TEXTURE_CUBE_MAP,R.TEXTURE_MAG_FILTER,r.mag),R.texParameteri(R.TEXTURE_CUBE_MAP,R.TEXTURE_MIN_FILTER,r.min),R.texParameteri(R.TEXTURE_CUBE_MAP,R.TEXTURE_WRAP_S,R.CLAMP_TO_EDGE),R.texParameteri(R.TEXTURE_CUBE_MAP,R.TEXTURE_WRAP_T,R.CLAMP_TO_EDGE),this._bindTextureDirectly(R.TEXTURE_CUBE_MAP,null),d.generateMipMaps=f,d.samplingMode=w,d.isReady=!0,d},f.ThinEngine.prototype.updateRawCubeTexture=function(z,u,U,J,v){let f=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,g=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;z._bufferViewArray=u,z.format=U,z.type=J,z.invertY=v,z._compression=f;const w=this._gl,P=this._getWebGLTextureType(J);let R=this._getInternalFormat(U);const S=this._getRGBABufferInternalSizedFormat(J);let d=!1;R===w.RGB&&(R=w.RGBA,d=!0),this._bindTextureDirectly(w.TEXTURE_CUBE_MAP,z,!0),this._unpackFlipY(void 0===v||!!v),z.width%4!==0&&w.pixelStorei(w.UNPACK_ALIGNMENT,1);for(let mz=0;mz<6;mz++){let U=u[mz];f?w.compressedTexImage2D(w.TEXTURE_CUBE_MAP_POSITIVE_X+mz,g,this.getCaps().s3tc[f],z.width,z.height,0,U):(d&&(U=Z(U,z.width,z.height,J)),w.texImage2D(w.TEXTURE_CUBE_MAP_POSITIVE_X+mz,g,S,z.width,z.height,0,R,P,U))}(!this.needPOTTextures||(0,mz.e)(z.width)&&(0,mz.e)(z.height))&&z.generateMipMaps&&0===g&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),z.isReady=!0},f.ThinEngine.prototype.createRawCubeTextureFromUrl=function(z,u,U,J,v,f,g,w){let P=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,R=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,S=arguments.length>10&&void 0!==arguments[10]?arguments[10]:3,d=arguments.length>11&&void 0!==arguments[11]&&arguments[11];const mz=this._gl,A=this.createRawCubeTexture(null,U,J,v,!f,d,S,null);null===u||void 0===u||u.addPendingData(A),A.url=z,A.isReady=!1,this._internalTexturesCache.push(A);const E=z=>{if(!A._hardwareTexture)return;const U=A.width,f=g(z);if(f){if(w){const z=this._getWebGLTextureType(v);let u=this._getInternalFormat(J);const g=this._getRGBABufferInternalSizedFormat(v);let P=!1;u===mz.RGB&&(u=mz.RGBA,P=!0),this._bindTextureDirectly(mz.TEXTURE_CUBE_MAP,A,!0),this._unpackFlipY(!1);const R=w(f);for(let J=0;J<R.length;J++){const f=U>>J;for(let U=0;U<6;U++){let w=R[J][U];P&&(w=Z(w,f,f,v)),mz.texImage2D(U,J,g,f,f,0,u,z,w)}}this._bindTextureDirectly(mz.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(A,f,J,v,d);A.isReady=!0,null===u||void 0===u||u.removePendingData(A),A.onLoadedObservable.notifyObservers(A),A.onLoadedObservable.clear(),P&&P()}};return this._loadFile(z,(z=>{E(z)}),void 0,null===u||void 0===u?void 0:u.offlineProvider,!0,((z,U)=>{null===u||void 0===u||u.removePendingData(A),R&&z&&R(z.status+" "+z.statusText,U)})),A},f.ThinEngine.prototype.createRawTexture2DArray=A(!1),f.ThinEngine.prototype.createRawTexture3D=A(!0),f.ThinEngine.prototype.updateRawTexture2DArray=E(!1),f.ThinEngine.prototype.updateRawTexture3D=E(!0);var C=U(12817);f.ThinEngine.prototype._readTexturePixelsSync=function(z,u,U){let J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,v=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,f=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,g=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],w=arguments.length>7&&void 0!==arguments[7]&&arguments[7],P=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,R=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;const S=this._gl;if(!S)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){const z=S.createFramebuffer();if(!z)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=z}var d,mz;(S.bindFramebuffer(S.FRAMEBUFFER,this._dummyFramebuffer),J>-1)?S.framebufferTexture2D(S.FRAMEBUFFER,S.COLOR_ATTACHMENT0,S.TEXTURE_CUBE_MAP_POSITIVE_X+J,null===(d=z._hardwareTexture)||void 0===d?void 0:d.underlyingResource,v):S.framebufferTexture2D(S.FRAMEBUFFER,S.COLOR_ATTACHMENT0,S.TEXTURE_2D,null===(mz=z._hardwareTexture)||void 0===mz?void 0:mz.underlyingResource,v);let Z=void 0!==z.type?this._getWebGLTextureType(z.type):S.UNSIGNED_BYTE;if(w)f||(f=(0,C.m)(z.type,4*u*U));else if(Z===S.UNSIGNED_BYTE)f||(f=new Uint8Array(4*u*U)),Z=S.UNSIGNED_BYTE;else f||(f=new Float32Array(4*u*U)),Z=S.FLOAT;return g&&this.flushFramebuffer(),S.readPixels(P,R,u,U,S.RGBA,Z,f),S.bindFramebuffer(S.FRAMEBUFFER,this._currentFramebuffer),f},f.ThinEngine.prototype._readTexturePixels=function(z,u,U){let J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,v=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,f=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,g=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],w=arguments.length>7&&void 0!==arguments[7]&&arguments[7],P=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,R=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;return Promise.resolve(this._readTexturePixelsSync(z,u,U,J,v,f,g,w,P,R))};U(13092);var r=U(21);f.ThinEngine.prototype._createDepthStencilCubeTexture=function(z,u){const U=new J.c(this,12);if(U.isCube=!0,1===this.webGLVersion)return S.d.Error("Depth cube texture is not supported by WebGL 1."),U;const v=(0,r.e)({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},u),f=this._gl;this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,U,!0),this._setupDepthStencilTexture(U,z,v.bilinearFiltering,v.comparisonFunction);for(let J=0;J<6;J++)v.generateStencil?f.texImage2D(f.TEXTURE_CUBE_MAP_POSITIVE_X+J,0,f.DEPTH24_STENCIL8,z,z,0,f.DEPTH_STENCIL,f.UNSIGNED_INT_24_8,null):f.texImage2D(f.TEXTURE_CUBE_MAP_POSITIVE_X+J,0,f.DEPTH_COMPONENT24,z,z,0,f.DEPTH_COMPONENT,f.UNSIGNED_INT,null);return this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(U),U},f.ThinEngine.prototype._setCubeMapTextureParams=function(z,u,U){const J=this._gl;J.texParameteri(J.TEXTURE_CUBE_MAP,J.TEXTURE_MAG_FILTER,J.LINEAR),J.texParameteri(J.TEXTURE_CUBE_MAP,J.TEXTURE_MIN_FILTER,u?J.LINEAR_MIPMAP_LINEAR:J.LINEAR),J.texParameteri(J.TEXTURE_CUBE_MAP,J.TEXTURE_WRAP_S,J.CLAMP_TO_EDGE),J.texParameteri(J.TEXTURE_CUBE_MAP,J.TEXTURE_WRAP_T,J.CLAMP_TO_EDGE),z.samplingMode=u?3:2,u&&this.getCaps().textureMaxLevel&&void 0!==U&&U>0&&(J.texParameteri(J.TEXTURE_CUBE_MAP,J.TEXTURE_MAX_LEVEL,U),z._maxLodLevel=U),this._bindTextureDirectly(J.TEXTURE_CUBE_MAP,null)},f.ThinEngine.prototype.createCubeTexture=function(z,u,U,J){let v=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,f=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,g=arguments.length>6?arguments[6]:void 0,w=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,P=arguments.length>8&&void 0!==arguments[8]&&arguments[8],R=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,d=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0,Z=arguments.length>11&&void 0!==arguments[11]?arguments[11]:null,A=arguments.length>13&&void 0!==arguments[13]&&arguments[13],E=arguments.length>14&&void 0!==arguments[14]?arguments[14]:null;const C=this._gl;return this.createCubeTextureBase(z,u,U,!!J,v,f,g,w,P,R,d,Z,(z=>this._bindTextureDirectly(C.TEXTURE_CUBE_MAP,z,!0)),((z,u)=>{const U=this.needPOTTextures?(0,mz.c)(u[0].width,this._caps.maxCubemapTextureSize):u[0].width,f=U,w=[C.TEXTURE_CUBE_MAP_POSITIVE_X,C.TEXTURE_CUBE_MAP_POSITIVE_Y,C.TEXTURE_CUBE_MAP_POSITIVE_Z,C.TEXTURE_CUBE_MAP_NEGATIVE_X,C.TEXTURE_CUBE_MAP_NEGATIVE_Y,C.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(C.TEXTURE_CUBE_MAP,z,!0),this._unpackFlipY(!1);const P=g?this._getInternalFormat(g,z._useSRGBBuffer):z._useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:C.RGBA;let R=g?this._getInternalFormat(g):C.RGBA;z._useSRGBBuffer&&1===this.webGLVersion&&(R=P);for(let J=0;J<w.length;J++)if(u[J].width!==U||u[J].height!==f){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext)return void S.d.Warn("Cannot create canvas to resize texture.");this._workingCanvas.width=U,this._workingCanvas.height=f,this._workingContext.drawImage(u[J],0,0,u[J].width,u[J].height,0,0,U,f),C.texImage2D(w[J],0,P,R,C.UNSIGNED_BYTE,this._workingCanvas)}else C.texImage2D(w[J],0,P,R,C.UNSIGNED_BYTE,u[J]);J||C.generateMipmap(C.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(z,!J),z.width=U,z.height=f,z.isReady=!0,g&&(z.format=g),z.onLoadedObservable.notifyObservers(z),z.onLoadedObservable.clear(),v&&v()}),!!A,E)},f.ThinEngine.prototype.generateMipMapsForCubemap=function(z){let u=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(z.generateMipMaps){const U=this._gl;this._bindTextureDirectly(U.TEXTURE_CUBE_MAP,z,!0),U.generateMipmap(U.TEXTURE_CUBE_MAP),u&&this._bindTextureDirectly(U.TEXTURE_CUBE_MAP,null)}};U(13098);f.ThinEngine.prototype.setDepthStencilTexture=function(z,u,U,J){void 0!==z&&(u&&(this._boundUniforms[z]=u),U&&U.depthStencilTexture?this._setTexture(z,U,!1,!0,J):this._setTexture(z,null,void 0,void 0,J))},f.ThinEngine.prototype.createRenderTargetCubeTexture=function(z,u){const U=this._createHardwareRenderTargetWrapper(!1,!0,z),v=(0,r.e)({generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5},u);v.generateStencilBuffer=v.generateDepthBuffer&&v.generateStencilBuffer,(1!==v.type||this._caps.textureFloatLinearFiltering)&&(2!==v.type||this._caps.textureHalfFloatLinearFiltering)||(v.samplingMode=1);const f=this._gl,g=new J.c(this,5);this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,g,!0);const w=this._getSamplingParameters(v.samplingMode,v.generateMipMaps);1!==v.type||this._caps.textureFloat||(v.type=0,S.d.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_MAG_FILTER,w.mag),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_MIN_FILTER,w.min),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE);for(let J=0;J<6;J++)f.texImage2D(f.TEXTURE_CUBE_MAP_POSITIVE_X+J,0,this._getRGBABufferInternalSizedFormat(v.type,v.format),z,z,0,this._getInternalFormat(v.format),this._getWebGLTextureType(v.type),null);const P=f.createFramebuffer();return this._bindUnboundFramebuffer(P),U._depthStencilBuffer=this._setupFramebufferDepthAttachments(v.generateStencilBuffer,v.generateDepthBuffer,z,z),v.generateMipMaps&&f.generateMipmap(f.TEXTURE_CUBE_MAP),this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),U._framebuffer=P,U._generateDepthBuffer=v.generateDepthBuffer,U._generateStencilBuffer=v.generateStencilBuffer,g.width=z,g.height=z,g.isReady=!0,g.isCube=!0,g.samples=1,g.generateMipMaps=v.generateMipMaps,g.samplingMode=v.samplingMode,g.type=v.type,g.format=v.format,this._internalTexturesCache.push(g),U.setTextures(g),U};var M=U(13116),T=U(12940);f.ThinEngine.prototype.createPrefilteredCubeTexture=function(z,u,v,f){let g=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,w=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,P=arguments.length>6?arguments[6]:void 0,R=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,d=!(arguments.length>8&&void 0!==arguments[8])||arguments[8];return this.createCubeTexture(z,u,null,!1,(async z=>{if(!z)return void(g&&g(null));const w=z.texture;if(d?z.info.sphericalPolynomial&&(w._sphericalPolynomial=z.info.sphericalPolynomial):w._sphericalPolynomial=new M.f,w._source=9,this.getCaps().textureLOD)return void(g&&g(w));const P=this._gl,R=z.width;if(!R)return;const{DDSTools:mz}=await U.e(29).then(U.bind(U,14991)),Z=[];for(let U=0;U<3;U++){const g=1-U/2,d=f,A=Math.log2(R)*v+f,E=d+(A-d)*g,C=Math.round(Math.min(Math.max(E,0),A)),r=new J.c(this,2);if(r.type=w.type,r.format=w.format,r.width=Math.pow(2,Math.max(Math.log2(R)-C,0)),r.height=r.width,r.isCube=!0,r._cachedWrapU=0,r._cachedWrapV=0,this._bindTextureDirectly(P.TEXTURE_CUBE_MAP,r,!0),r.samplingMode=2,P.texParameteri(P.TEXTURE_CUBE_MAP,P.TEXTURE_MAG_FILTER,P.LINEAR),P.texParameteri(P.TEXTURE_CUBE_MAP,P.TEXTURE_MIN_FILTER,P.LINEAR),P.texParameteri(P.TEXTURE_CUBE_MAP,P.TEXTURE_WRAP_S,P.CLAMP_TO_EDGE),P.texParameteri(P.TEXTURE_CUBE_MAP,P.TEXTURE_WRAP_T,P.CLAMP_TO_EDGE),z.isDDS){const u=z.info,U=z.data;this._unpackFlipY(u.isCompressed),mz.UploadDDSLevels(this,r,U,u,!0,6,C)}else S.d.Warn("DDS is the only prefiltered cube map supported so far.");this._bindTextureDirectly(P.TEXTURE_CUBE_MAP,null);const M=new T.c(u);M._isCube=!0,M._texture=r,r.isReady=!0,Z.push(M)}w._lodTextureHigh=Z[2],w._lodTextureMid=Z[1],w._lodTextureLow=Z[0],g&&g(w)}),w,P,R,d,v,f)},f.ThinEngine.prototype.createUniformBuffer=function(z,u){const U=this._gl.createBuffer();if(!U)throw new Error("Unable to create uniform buffer");const J=new R.d(U);return this.bindUniformBuffer(J),z instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,z,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(z),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),J.references=1,J},f.ThinEngine.prototype.createDynamicUniformBuffer=function(z,u){const U=this._gl.createBuffer();if(!U)throw new Error("Unable to create dynamic uniform buffer");const J=new R.d(U);return this.bindUniformBuffer(J),z instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,z,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(z),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),J.references=1,J},f.ThinEngine.prototype.updateUniformBuffer=function(z,u,U,J){this.bindUniformBuffer(z),void 0===U&&(U=0),void 0===J?u instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,U,u):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,U,new Float32Array(u)):u instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,u.subarray(U,U+J)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(u).subarray(U,U+J)),this.bindUniformBuffer(null)},f.ThinEngine.prototype.bindUniformBuffer=function(z){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,z?z.underlyingResource:null)},f.ThinEngine.prototype.bindUniformBufferBase=function(z,u,U){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,u,z?z.underlyingResource:null)},f.ThinEngine.prototype.bindUniformBlock=function(z,u,U){const J=z.program,v=this._gl.getUniformBlockIndex(J,u);4294967295!==v&&this._gl.uniformBlockBinding(J,v,U)};var X=U(12758),h=U(12827);h.b.prototype.displayLoadingUI=function(){if(!(0,X.i)())return;const z=this.loadingScreen;z&&z.displayLoadingUI()},h.b.prototype.hideLoadingUI=function(){if(!(0,X.i)())return;const z=this._loadingScreen;z&&z.hideLoadingUI()},Object.defineProperty(h.b.prototype,"loadingScreen",{get:function(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=h.b.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen},set:function(z){this._loadingScreen=z},enumerable:!0,configurable:!0}),Object.defineProperty(h.b.prototype,"loadingUIText",{set:function(z){this.loadingScreen.loadingUIText=z},enumerable:!0,configurable:!0}),Object.defineProperty(h.b.prototype,"loadingUIBackgroundColor",{set:function(z){this.loadingScreen.loadingUIBackgroundColor=z},enumerable:!0,configurable:!0}),h.b.prototype.getInputElement=function(){return this._renderingCanvas},h.b.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null},h.b.prototype.getInputElementClientRect=function(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null},h.b.prototype.getAspectRatio=function(z){let u=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const U=z.viewport;return this.getRenderWidth(u)*U.width/(this.getRenderHeight(u)*U.height)},h.b.prototype.getScreenAspectRatio=function(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)},h.b.prototype._verifyPointerLock=function(){var z;null===(z=this._onPointerLockChange)||void 0===z||z.call(this)},h.b.prototype.setAlphaEquation=function(z){if(this._alphaEquation!==z){switch(z){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774)}this._alphaEquation=z}},h.b.prototype.getInputElement=function(){return this._renderingCanvas},h.b.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc},h.b.prototype.setDepthFunction=function(z){this._depthCullingState.depthFunc=z},h.b.prototype.setDepthFunctionToGreater=function(){this.setDepthFunction(516)},h.b.prototype.setDepthFunctionToGreaterOrEqual=function(){this.setDepthFunction(518)},h.b.prototype.setDepthFunctionToLess=function(){this.setDepthFunction(513)},h.b.prototype.setDepthFunctionToLessOrEqual=function(){this.setDepthFunction(515)},h.b.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask},h.b.prototype.setDepthWrite=function(z){this._depthCullingState.depthMask=z},h.b.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest},h.b.prototype.setStencilBuffer=function(z){this._stencilState.stencilTest=z},h.b.prototype.getStencilMask=function(){return this._stencilState.stencilMask},h.b.prototype.setStencilMask=function(z){this._stencilState.stencilMask=z},h.b.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc},h.b.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef},h.b.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask},h.b.prototype.setStencilFunction=function(z){this._stencilState.stencilFunc=z},h.b.prototype.setStencilFunctionReference=function(z){this._stencilState.stencilFuncRef=z},h.b.prototype.setStencilFunctionMask=function(z){this._stencilState.stencilFuncMask=z},h.b.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail},h.b.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail},h.b.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass},h.b.prototype.setStencilOperationFail=function(z){this._stencilState.stencilOpStencilFail=z},h.b.prototype.setStencilOperationDepthFail=function(z){this._stencilState.stencilOpDepthFail=z},h.b.prototype.setStencilOperationPass=function(z){this._stencilState.stencilOpStencilDepthPass=z},h.b.prototype.cacheStencilState=function(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()},h.b.prototype.restoreStencilState=function(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)},h.b.prototype.setAlphaConstants=function(z,u,U,J){this._alphaState.setAlphaBlendConstants(z,u,U,J)},h.b.prototype.getAlphaMode=function(){return this._alphaMode},h.b.prototype.getAlphaEquation=function(){return this._alphaEquation},h.b.prototype.getRenderPassNames=function(){return this._renderPassNames},h.b.prototype.getCurrentRenderPassName=function(){return this._renderPassNames[this.currentRenderPassId]},h.b.prototype.createRenderPassId=function(z){const u=++h.b._RenderPassIdCounter;return this._renderPassNames[u]=null!==z&&void 0!==z?z:"NONAME",u},h.b.prototype.releaseRenderPassId=function(z){this._renderPassNames[z]=void 0;for(let u=0;u<this.scenes.length;++u){const U=this.scenes[u];for(let u=0;u<U.meshes.length;++u){const J=U.meshes[u];if(J.cf)for(let u=0;u<J.cf.length;++u){J.cf[u]._removeDrawWrapper(z)}}}};U(13108);function t(z){if(z.requestPointerLock){const u=z.requestPointerLock();u instanceof Promise?u.then((()=>{z.focus()})).catch((()=>{})):z.focus()}}var V=U(13141),L=U(12825);class O extends f.ThinEngine{static get NpmPackage(){return h.b.NpmPackage}static get Version(){return h.b.Version}static get Instances(){return v.e.Instances}static get LastCreatedEngine(){return v.e.LastCreatedEngine}static get LastCreatedScene(){return v.e.LastCreatedScene}static DefaultLoadingScreenFactory(z){return h.b.DefaultLoadingScreenFactory(z)}get _supportsHardwareTextureRescaling(){return!!O._RescalePostProcessFactory}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}get performanceMonitor(){return this._performanceMonitor}constructor(z,u,U){super(z,u,U,arguments.length>3&&void 0!==arguments[3]&&arguments[3]),this.customAnimationFrameRequester=null,this._performanceMonitor=new w,this._drawCalls=new V.e,z&&(this._features.supportRenderPasses=!0,U=this._creationOptions)}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(z){super._sharedInit(z),function(z,u,U){z._onCanvasFocus=()=>{z.onCanvasFocusObservable.notifyObservers(z)},z._onCanvasBlur=()=>{z.onCanvasBlurObservable.notifyObservers(z)},z._onCanvasContextMenu=u=>{z.disableContextMenu&&u.preventDefault()},u.addEventListener("focus",z._onCanvasFocus),u.addEventListener("blur",z._onCanvasBlur),u.addEventListener("contextmenu",z._onCanvasContextMenu),z._onBlur=()=>{z.disablePerformanceMonitorInBackground&&z.performanceMonitor.disable(),z._windowIsBackground=!0},z._onFocus=()=>{z.disablePerformanceMonitorInBackground&&z.performanceMonitor.enable(),z._windowIsBackground=!1},z._onCanvasPointerOut=U=>{document.elementFromPoint(U.clientX,U.clientY)!==u&&z.onCanvasPointerOutObservable.notifyObservers(U)};const J=z.getHostWindow();J&&"function"===typeof J.addEventListener&&(J.addEventListener("blur",z._onBlur),J.addEventListener("focus",z._onFocus)),u.addEventListener("pointerout",z._onCanvasPointerOut),U.doNotHandleTouchAction||function(z){z&&z.setAttribute&&(z.setAttribute("touch-action","none"),z.style.touchAction="none",z.style.webkitTapHighlightColor="transparent")}(u),!h.b.audioEngine&&U.audioEngine&&h.b.AudioEngineFactory&&(h.b.audioEngine=h.b.AudioEngineFactory(z.getRenderingCanvas(),z.getAudioContext(),z.getAudioDestination())),(0,X.d)()&&(z._onFullscreenChange=()=>{z.isFullscreen=!!document.fullscreenElement,z.isFullscreen&&z._pointerLockRequested&&u&&t(u)},document.addEventListener("fullscreenchange",z._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",z._onFullscreenChange,!1),z._onPointerLockChange=()=>{z.isPointerLock=document.pointerLockElement===u},document.addEventListener("pointerlockchange",z._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",z._onPointerLockChange,!1)),z.enableOfflineSupport=void 0!==h.b.OfflineProviderFactory,z._deterministicLockstep=!!U.deterministicLockstep,z._lockstepMaxSteps=U.lockstepMaxSteps||0,z._timeStep=U.timeStep||1/60}(this,z,this._creationOptions)}resizeImageBitmap(z,u,U){return function(z,u,U,J){const v=z.createCanvas(U,J).getContext("2d");if(!v)throw new Error("Unable to get 2d context for resizeImageBitmap");return v.drawImage(u,0,0),v.getImageData(0,0,U,J).data}(this,z,u,U)}async _createImageBitmapFromSource(z,u){return await async function(z,u,U){return await new Promise(((J,v)=>{const f=new Image;f.onload=()=>{f.decode().then((()=>{z.createImageBitmap(f,U).then((z=>{J(z)}))}))},f.onerror=()=>{v("Error loading image ".concat(f.src))},f.src=u}))}(this,z,u)}switchFullscreen(z){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(z)}enterFullscreen(z){this.isFullscreen||(this._pointerLockRequested=z,this._renderingCanvas&&function(z){const u=z.requestFullscreen||z.webkitRequestFullscreen;u&&u.call(z)}(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&function(){const z=document;document.exitFullscreen?document.exitFullscreen():z.webkitCancelFullScreen&&z.webkitCancelFullScreen()}()}setDitheringState(z){z?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(z){z?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}setDirectViewport(z,u,U,J){const v=this._cachedViewport;return this._cachedViewport=null,this._viewport(z,u,U,J),v}scissorClear(z,u,U,J,v){this.enableScissor(z,u,U,J),this.clear(v,!0,!0,!0),this.disableScissor()}enableScissor(z,u,U,J){const v=this._gl;v.enable(v.SCISSOR_TEST),v.scissor(z,u,U,J)}disableScissor(){const z=this._gl;z.disable(z.SCISSOR_TEST)}async _loadFileAsync(z,u,U){return await new Promise(((J,v)=>{this._loadFile(z,(z=>{J(z)}),void 0,u,U,((z,u)=>{v(u)}))}))}getVertexShaderSource(z){const u=this._gl.getAttachedShaders(z);return u?this._gl.getShaderSource(u[0]):null}getFragmentShaderSource(z){const u=this._gl.getAttachedShaders(z);return u?this._gl.getShaderSource(u[1]):null}set framebufferDimensionsObject(z){this._framebufferDimensionsObject=z,this._framebufferDimensionsObject&&this.onResizeObservable.notifyObservers(this)}_rebuildBuffers(){for(const z of this.scenes)z.resetCachedMaterial(),z._rebuildGeometries();for(const z of this._virtualScenes)z.resetCachedMaterial(),z._rebuildGeometries();super._rebuildBuffers()}getFontOffset(z){return function(z){const u=document.createElement("span");u.textContent="Hg",u.style.font=z;const U=document.createElement("div");U.style.display="inline-block",U.style.width="1px",U.style.height="0px",U.style.verticalAlign="bottom";const J=document.createElement("div");J.style.whiteSpace="nowrap",J.appendChild(u),J.appendChild(U),document.body.appendChild(J);let v=0,f=0;try{f=U.getBoundingClientRect().top-u.getBoundingClientRect().top,U.style.verticalAlign="baseline",v=U.getBoundingClientRect().top-u.getBoundingClientRect().top}finally{document.body.removeChild(J)}return{ascent:v,height:f,descent:f-v}}(z)}_cancelFrame(){if(this.customAnimationFrameRequester){if(0!==this._frameHandler){this._frameHandler=0;const{cancelAnimationFrame:z}=this.customAnimationFrameRequester;z&&z(this.customAnimationFrameRequester.mz)}}else super._cancelFrame()}_renderLoop(z){this._processFrame(z),this._activeRenderLoops.length>0&&0===this._frameHandler&&(this.customAnimationFrameRequester?(this.customAnimationFrameRequester.mz=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.mz):this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()))}enterPointerlock(){this._renderingCanvas&&t(this._renderingCanvas)}exitPointerlock(){document.exitPointerLock&&document.exitPointerLock()}rf(){this._measureFps(),super.rf()}_deletePipelineContext(z){const u=z;u&&u.program&&u.transformFeedback&&(this.deleteTransformFeedback(u.transformFeedback),u.transformFeedback=null),super._deletePipelineContext(z)}createShaderProgram(z,u,U,J,v){let f=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;v=v||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);const g=super.createShaderProgram(z,u,U,J,v,f);return this.onAfterShaderCompilationObservable.notifyObservers(this),g}_createShaderProgram(z,u,U,J){let v=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const f=J.createProgram();if(z.program=f,!f)throw new Error("Unable to create program");if(J.attachShader(f,u),J.attachShader(f,U),this.webGLVersion>1&&v){const u=this.createTransformFeedback();this.bindTransformFeedback(u),this.setTranformFeedbackVaryings(f,v),z.transformFeedback=u}return J.linkProgram(f),this.webGLVersion>1&&v&&this.bindTransformFeedback(null),z.context=J,z.vertexShader=u,z.fragmentShader=U,z.isParallelCompiled||this._finalizePipelineContext(z),f}_releaseTexture(z){super._releaseTexture(z)}_releaseRenderTargetWrapper(z){super._releaseRenderTargetWrapper(z);for(const u of this.scenes){for(const U of u.postProcesses)U._outputTexture===z&&(U._outputTexture=null);for(const U of u.cameras)for(const u of U._postProcesses)u&&u._outputTexture===z&&(u._outputTexture=null)}}_rescaleTexture(z,u,U,J,v){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);const f=this.createRenderTargetTexture({width:u.width,height:u.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});if(!this._rescalePostProcess&&O._RescalePostProcessFactory&&(this._rescalePostProcess=O._RescalePostProcessFactory(this)),this._rescalePostProcess){this._rescalePostProcess.externalTextureSamplerBinding=!0;const g=()=>{this._rescalePostProcess.onApply=function(u){u._bindTexture("textureSampler",z)};let g=U;g||(g=this.scenes[this.scenes.length-1]),g.postProcessManager.directRender([this._rescalePostProcess],f,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,u,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,J,0,0,u.width,u.height,0),this.unBindFramebuffer(f),f.dispose(),v&&v()},w=this._rescalePostProcess.getEffect();w?w.executeWhenCompiled(g):this._rescalePostProcess.onEffectCreatedObservable.addOnce((z=>{z.executeWhenCompiled(g)}))}}wrapWebGLTexture(z){let u=arguments.length>1&&void 0!==arguments[1]&&arguments[1],U=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3,v=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,f=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;const g=new d.d(z,this._gl),w=new J.c(this,0,!0);return w._hardwareTexture=g,w.baseWidth=v,w.baseHeight=f,w.width=v,w.height=f,w.isReady=!0,w.useMipMaps=u,this.updateTextureSamplingMode(U,w),w}_uploadImageToTexture(z,u){let U=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const v=this._gl,f=this._getWebGLTextureType(z.type),g=this._getInternalFormat(z.format),w=this._getRGBABufferInternalSizedFormat(z.type,g),P=z.isCube?v.TEXTURE_CUBE_MAP:v.TEXTURE_2D;this._bindTextureDirectly(P,z,!0),this._unpackFlipY(z.invertY);let R=v.TEXTURE_2D;z.isCube&&(R=v.TEXTURE_CUBE_MAP_POSITIVE_X+U),v.texImage2D(R,J,w,g,f,u),this._bindTextureDirectly(P,null,!0)}updateTextureComparisonFunction(z,u){if(1===this.webGLVersion)return void S.d.Error("WebGL 1 does not support texture comparison.");const U=this._gl;z.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,z,!0),0===u?(U.texParameteri(U.TEXTURE_CUBE_MAP,U.TEXTURE_COMPARE_FUNC,515),U.texParameteri(U.TEXTURE_CUBE_MAP,U.TEXTURE_COMPARE_MODE,U.NONE)):(U.texParameteri(U.TEXTURE_CUBE_MAP,U.TEXTURE_COMPARE_FUNC,u),U.texParameteri(U.TEXTURE_CUBE_MAP,U.TEXTURE_COMPARE_MODE,U.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,z,!0),0===u?(U.texParameteri(U.TEXTURE_2D,U.TEXTURE_COMPARE_FUNC,515),U.texParameteri(U.TEXTURE_2D,U.TEXTURE_COMPARE_MODE,U.NONE)):(U.texParameteri(U.TEXTURE_2D,U.TEXTURE_COMPARE_FUNC,u),U.texParameteri(U.TEXTURE_2D,U.TEXTURE_COMPARE_MODE,U.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),z._comparisonFunction=u}createInstancesBuffer(z){const u=this._gl.createBuffer();if(!u)throw new Error("Unable to create instance buffer");const U=new R.d(u);return U.MU=z,this.bindArrayBuffer(U),this._gl.bufferData(this._gl.ARRAY_BUFFER,z,this._gl.DYNAMIC_DRAW),U.references=1,U}deleteInstancesBuffer(z){this._gl.deleteBuffer(z)}async _clientWaitAsync(z){let u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,U=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;const J=this._gl;return await new Promise(((v,f)=>{(0,L.e)((()=>{const U=J.clientWaitSync(z,u,0);if(U==J.WAIT_FAILED)throw new Error("clientWaitSync failed");return U!=J.TIMEOUT_EXPIRED}),v,f,U)}))}_readPixelsAsync(z,u,U,J,v,f,g){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");const w=this._gl,P=w.createBuffer();w.bindBuffer(w.PIXEL_PACK_BUFFER,P),w.bufferData(w.PIXEL_PACK_BUFFER,g.byteLength,w.STREAM_READ),w.readPixels(z,u,U,J,v,f,0),w.bindBuffer(w.PIXEL_PACK_BUFFER,null);const R=w.fenceSync(w.SYNC_GPU_COMMANDS_COMPLETE,0);return R?(w.flush(),this._clientWaitAsync(R,0,10).then((()=>(w.deleteSync(R),w.bindBuffer(w.PIXEL_PACK_BUFFER,P),w.getBufferSubData(w.PIXEL_PACK_BUFFER,0,g),w.bindBuffer(w.PIXEL_PACK_BUFFER,null),w.deleteBuffer(P),g)))):null}dispose(){this.hideLoadingUI(),this._rescalePostProcess&&this._rescalePostProcess.dispose(),function(z,u){1===v.e.Instances.length&&h.b.audioEngine&&(h.b.audioEngine.dispose(),h.b.audioEngine=null);const U=z.getHostWindow();U&&"function"===typeof U.removeEventListener&&(U.removeEventListener("blur",z._onBlur),U.removeEventListener("focus",z._onFocus)),u&&(u.removeEventListener("focus",z._onCanvasFocus),u.removeEventListener("blur",z._onCanvasBlur),u.removeEventListener("pointerout",z._onCanvasPointerOut),u.removeEventListener("contextmenu",z._onCanvasContextMenu)),(0,X.d)()&&(document.removeEventListener("fullscreenchange",z._onFullscreenChange),document.removeEventListener("mozfullscreenchange",z._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",z._onFullscreenChange),document.removeEventListener("msfullscreenchange",z._onFullscreenChange),document.removeEventListener("pointerlockchange",z._onPointerLockChange),document.removeEventListener("mspointerlockchange",z._onPointerLockChange),document.removeEventListener("mozpointerlockchange",z._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",z._onPointerLockChange))}(this,this._renderingCanvas),super.dispose()}}O.ALPHA_DISABLE=0,O.ALPHA_ADD=1,O.ALPHA_COMBINE=2,O.ALPHA_SUBTRACT=3,O.ALPHA_MULTIPLY=4,O.ALPHA_MAXIMIZED=5,O.ALPHA_ONEONE=6,O.ALPHA_PREMULTIPLIED=7,O.ALPHA_PREMULTIPLIED_PORTERDUFF=8,O.ALPHA_INTERPOLATE=9,O.ALPHA_SCREENMODE=10,O.DELAYLOADSTATE_NONE=0,O.DELAYLOADSTATE_LOADED=1,O.DELAYLOADSTATE_LOADING=2,O.DELAYLOADSTATE_NOTLOADED=4,O.NEVER=512,O.ALWAYS=519,O.LESS=513,O.EQUAL=514,O.LEQUAL=515,O.GREATER=516,O.GEQUAL=518,O.NOTEQUAL=517,O.KEEP=7680,O.REPLACE=7681,O.INCR=7682,O.DECR=7683,O.INVERT=5386,O.INCR_WRAP=34055,O.DECR_WRAP=34056,O.TEXTURE_CLAMP_ADDRESSMODE=0,O.TEXTURE_WRAP_ADDRESSMODE=1,O.TEXTURE_MIRROR_ADDRESSMODE=2,O.TEXTUREFORMAT_ALPHA=0,O.TEXTUREFORMAT_LUMINANCE=1,O.TEXTUREFORMAT_LUMINANCE_ALPHA=2,O.TEXTUREFORMAT_RGB=4,O.TEXTUREFORMAT_RGBA=5,O.TEXTUREFORMAT_RED=6,O.TEXTUREFORMAT_R=6,O.TEXTUREFORMAT_R16_UNORM=33322,O.TEXTUREFORMAT_RG16_UNORM=33324,O.TEXTUREFORMAT_RGB16_UNORM=32852,O.TEXTUREFORMAT_RGBA16_UNORM=32859,O.TEXTUREFORMAT_R16_SNORM=36760,O.TEXTUREFORMAT_RG16_SNORM=36761,O.TEXTUREFORMAT_RGB16_SNORM=36762,O.TEXTUREFORMAT_RGBA16_SNORM=36763,O.TEXTUREFORMAT_RG=7,O.TEXTUREFORMAT_RED_INTEGER=8,O.TEXTUREFORMAT_R_INTEGER=8,O.TEXTUREFORMAT_RG_INTEGER=9,O.TEXTUREFORMAT_RGB_INTEGER=10,O.TEXTUREFORMAT_RGBA_INTEGER=11,O.TEXTURETYPE_UNSIGNED_BYTE=0,O.TEXTURETYPE_UNSIGNED_INT=0,O.TEXTURETYPE_FLOAT=1,O.TEXTURETYPE_HALF_FLOAT=2,O.TEXTURETYPE_BYTE=3,O.TEXTURETYPE_SHORT=4,O.TEXTURETYPE_UNSIGNED_SHORT=5,O.TEXTURETYPE_INT=6,O.TEXTURETYPE_UNSIGNED_INTEGER=7,O.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,O.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,O.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,O.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,O.TEXTURETYPE_UNSIGNED_INT_24_8=12,O.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,O.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,O.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,O.TEXTURE_NEAREST_SAMPLINGMODE=1,O.TEXTURE_BILINEAR_SAMPLINGMODE=2,O.TEXTURE_TRILINEAR_SAMPLINGMODE=3,O.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,O.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,O.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,O.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,O.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,O.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,O.TEXTURE_NEAREST_LINEAR=7,O.TEXTURE_NEAREST_NEAREST=1,O.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,O.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,O.TEXTURE_LINEAR_LINEAR=2,O.TEXTURE_LINEAR_NEAREST=12,O.TEXTURE_EXPLICIT_MODE=0,O.TEXTURE_SPHERICAL_MODE=1,O.TEXTURE_PLANAR_MODE=2,O.TEXTURE_CUBIC_MODE=3,O.TEXTURE_PROJECTION_MODE=4,O.TEXTURE_SKYBOX_MODE=5,O.TEXTURE_INVCUBIC_MODE=6,O.TEXTURE_EQUIRECTANGULAR_MODE=7,O.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,O.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,O.SCALEMODE_FLOOR=1,O.SCALEMODE_NEAREST=2,O.SCALEMODE_CEILING=3},13100:(z,u,U)=>{U.d(u,{c:()=>v});var J=U(13083);class v{get depthStencilTexture(){return this._depthStencilTexture}setDepthStencilTexture(z){(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&this._depthStencilTexture&&this._depthStencilTexture.dispose(),this._depthStencilTexture=z,this._generateDepthBuffer=this._generateStencilBuffer=this._depthStencilTextureWithStencil=!1,z&&(this._generateDepthBuffer=!0,this._generateStencilBuffer=this._depthStencilTextureWithStencil=(0,J.c)(z.format))}get depthStencilTextureWithStencil(){return this._depthStencilTextureWithStencil}get isCube(){return this._isCube}get isMulti(){return this._isMulti}get is2DArray(){return this.layers>0}get is3D(){return this.depth>0}get size(){return this.width}get width(){var z;return null!==(z=this._size.width)&&void 0!==z?z:this._size}get height(){var z;return null!==(z=this._size.height)&&void 0!==z?z:this._size}get layers(){return this._size.layers||0}get depth(){return this._size.depth||0}get texture(){var z,u;return null!==(z=null===(u=this._textures)||void 0===u?void 0:u[0])&&void 0!==z?z:null}get textures(){return this._textures}get faceIndices(){return this._faceIndices}get layerIndices(){return this._layerIndices}getBaseArrayLayer(z){var u,U,J,v;if(!this._textures)return-1;const f=this._textures[z],g=null!==(u=null===(U=this._layerIndices)||void 0===U?void 0:U[z])&&void 0!==u?u:0,w=null!==(J=null===(v=this._faceIndices)||void 0===v?void 0:v[z])&&void 0!==J?J:0;return f.isCube?6*g+w:f.is3D?0:g}get samples(){return this._samples}setSamples(z){let u=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],U=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this.samples===z&&!U)return z;const J=this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,z,u):this._engine.updateRenderTargetTextureSampleCount(this,z);return this._samples=z,J}resolveMSAATextures(){this.isMulti?this._engine.resolveMultiFramebuffer(this):this._engine.resolveFramebuffer(this)}generateMipMaps(){this._engine._currentRenderTarget===this&&this._engine.unBindFramebuffer(this,!0),this.isMulti?this._engine.generateMipMapsMultiFramebuffer(this):this._engine.generateMipMapsFramebuffer(this)}constructor(z,u,U,J,v){this._textures=null,this._faceIndices=null,this._layerIndices=null,this._samples=1,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this.disableAutomaticMSAAResolve=!1,this.resolveMSAAColors=!0,this.resolveMSAADepth=!1,this.resolveMSAAStencil=!1,this._isMulti=z,this._isCube=u,this._size=U,this._engine=J,this._depthStencilTexture=null,this.label=v}setTextures(z){Array.isArray(z)?this._textures=z:this._textures=z?[z]:null}setTexture(z){let u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,U=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._textures||(this._textures=[]),this._textures[u]!==z&&(this._textures[u]&&U&&this._textures[u].dispose(),this._textures[u]=z)}setLayerAndFaceIndices(z,u){this._layerIndices=z,this._faceIndices=u}setLayerAndFaceIndex(){let z=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,u=arguments.length>1?arguments[1]:void 0,U=arguments.length>2?arguments[2]:void 0;this._layerIndices||(this._layerIndices=[]),this._faceIndices||(this._faceIndices=[]),void 0!==u&&u>=0&&(this._layerIndices[z]=u),void 0!==U&&U>=0&&(this._faceIndices[z]=U)}createDepthStencilTexture(){var z;let u=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,U=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],J=arguments.length>2&&void 0!==arguments[2]&&arguments[2],v=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,f=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14,g=arguments.length>5?arguments[5]:void 0;return null===(z=this._depthStencilTexture)||void 0===z||z.dispose(),this._depthStencilTextureWithStencil=J,this._depthStencilTextureLabel=g,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:U,comparisonFunction:u,generateStencil:J,isCube:this._isCube,samples:v,depthTextureFormat:f,label:g},this),this._depthStencilTexture}_shareDepth(z){this.shareDepth(z)}shareDepth(z){this._depthStencilTexture&&(z._depthStencilTexture&&z._depthStencilTexture.dispose(),z._depthStencilTexture=this._depthStencilTexture,z._depthStencilTextureWithStencil=this._depthStencilTextureWithStencil,this._depthStencilTexture.incrementReferences())}_swapAndDie(z){this.texture&&this.texture._swapAndDie(z),this._textures=null,this.dispose(!0)}_cloneRenderTargetWrapper(){let z=null;if(this._isMulti){const J=this.textures;if(J&&J.length>0){let v=!1,f=J.length,g=-1;const w=J[J.length-1]._source;14!==w&&12!==w||(v=!0,g=J[J.length-1].format,f--);const P=[],R=[],S=[],d=[],mz=[],Z=[],A=[],E={};for(let z=0;z<f;++z){const v=J[z];P.push(v.samplingMode),R.push(v.type),S.push(v.format);var u,U;if(void 0!==E[v.uniqueId]?(d.push(-1),A.push(0)):(E[v.uniqueId]=z,v.is2DArray?(d.push(35866),A.push(v.depth)):v.isCube?(d.push(34067),A.push(0)):v.is3D?(d.push(32879),A.push(v.depth)):(d.push(3553),A.push(0))),this._faceIndices)mz.push(null!==(u=this._faceIndices[z])&&void 0!==u?u:0);if(this._layerIndices)Z.push(null!==(U=this._layerIndices[z])&&void 0!==U?U:0)}const C={samplingModes:P,generateMipMaps:J[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:v,depthTextureFormat:g,types:R,formats:S,textureCount:f,targetTypes:d,faceIndex:mz,layerIndex:Z,layerCounts:A,label:this.label},r={width:this.width,height:this.height,depth:this.depth};z=this._engine.createMultipleRenderTarget(r,C);for(let u=0;u<f;++u){if(-1!==d[u])continue;const U=E[J[u].uniqueId];z.setTexture(z.textures[U],u)}}}else{var J,v,f,g,w;const u={};if(u.generateDepthBuffer=this._generateDepthBuffer,u.generateMipMaps=null!==(J=null===(v=this.texture)||void 0===v?void 0:v.generateMipMaps)&&void 0!==J&&J,u.generateStencilBuffer=this._generateStencilBuffer,u.samplingMode=null===(f=this.texture)||void 0===f?void 0:f.samplingMode,u.type=null===(g=this.texture)||void 0===g?void 0:g.type,u.format=null===(w=this.texture)||void 0===w?void 0:w.format,u.noColorAttachment=!this._textures,u.label=this.label,this.isCube)z=this._engine.createRenderTargetCubeTexture(this.width,u);else{var P;const U={width:this.width,height:this.height,layers:this.is2DArray||this.is3D?null===(P=this.texture)||void 0===P?void 0:P.depth:void 0};z=this._engine.createRenderTargetTexture(U,u)}z.texture&&(z.texture.isReady=!0)}return z}_swapRenderTargetWrapper(z){if(this._textures&&z._textures)for(let u=0;u<this._textures.length;++u)this._textures[u]._swapAndDie(z._textures[u],!1),z._textures[u].isReady=!0;this._depthStencilTexture&&z._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(z._depthStencilTexture),z._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null}_rebuild(){const z=this._cloneRenderTargetWrapper();if(z){if(this._depthStencilTexture){const u=this._depthStencilTexture.samplingMode,U=this._depthStencilTexture.format,J=2===u||3===u||11===u;z.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,J,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples,U,this._depthStencilTextureLabel)}this.samples>1&&z.setSamples(this.samples),z._swapRenderTargetWrapper(this),z.dispose()}}releaseTextures(){if(this._textures)for(let z=0;z<this._textures.length;++z)this._textures[z].dispose();this._textures=null}dispose(){var z;arguments.length>0&&void 0!==arguments[0]&&arguments[0]||(null===(z=this._depthStencilTexture)||void 0===z||z.dispose(),this._depthStencilTexture=null,this.releaseTextures());this._engine._releaseRenderTargetWrapper(this)}}},13054:(z,u,U)=>{U.r(u),U.d(u,{ThinEngine:()=>X});var J=U(12845),v=U(13063),f=U(12760),g=U(12758);class w{constructor(){this.shaderLanguage=0}postProcessor(z,u,U,J,v){if(v.drawBuffersExtensionDisabled){const u=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;z=z.replace(u,"")}return z}}const P=/(flat\s)?\s*varying\s*.*/;class R{constructor(){this.shaderLanguage=0}attributeProcessor(z){return z.replace("attribute","in")}varyingCheck(z,u){return P.test(z)}varyingProcessor(z,u){return z.replace("varying",u?"in":"out")}postProcessor(z,u,U){const J=-1!==z.search(/#extension.+GL_EXT_draw_buffers.+require/);if(z=(z=z.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),U){const u=-1!==z.search(/layout *\(location *= *0\) *out/g);z=(z=(z=(z=(z=(z=(z=z.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/void\s+?main\s*\(/g,(J||u?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(")}else{if(-1!==u.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+z}return z}}var S=U(13072),d=U(12882),mz=U(12827),Z=U(13076),A=U(12853),E=U(12829),C=U(12817),r=U(12841),M=U(13083);class T{}class X extends mz.b{get name(){return this._name}set name(z){this._name=z}get version(){return this._webGLVersion}static get ShadersRepository(){return E.Effect.ShadersRepository}static set ShadersRepository(z){E.Effect.ShadersRepository=z}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(z){this._framebufferDimensionsObject=z}snapshotRenderingReset(){this.snapshotRendering=!1}constructor(z,u,U,v){if(U=U||{},super(null!==u&&void 0!==u?u:U.antialias,U,v),this._name="WebGL",this.forcePOTTextures=!1,this.validateShaderPrograms=!1,this.disableUniformBuffers=!1,this._webGLVersion=1,this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},!z)return;let g=null;if(z.getContext){if(g=z,void 0===U.Yf&&(U.Yf=!1),void 0===U.xrCompatible&&(U.xrCompatible=!1),navigator&&navigator.userAgent){this._setupMobileChecks();const z=navigator.userAgent;for(const u of X.ExceptionList){const J=u.key,v=u.targets;if(new RegExp(J).test(z)){if(u.capture&&u.captureConstraint){const U=u.capture,J=u.captureConstraint,v=new RegExp(U).exec(z);if(v&&v.length>0){if(parseInt(v[v.length-1])>=J)continue}}for(const z of v)switch(z){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":U.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1}}}}if(this._doNotHandleContextLost?this._onContextLost=()=>{(0,J.y)(this._gl)}:(this._onContextLost=z=>{z.preventDefault(),this._contextWasLost=!0,(0,J.y)(this._gl),f.d.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost((()=>this._initGLContext()))},g.addEventListener("webglcontextrestored",this._onContextRestored,!1),U.powerPreference=U.powerPreference||"high-performance"),g.addEventListener("webglcontextlost",this._onContextLost,!1),this._badDesktopOS&&(U.xrCompatible=!1),!U.disableWebGL2Support)try{this._gl=g.getContext("webgl2",U)||g.getContext("experimental-webgl2",U),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch(d){}if(!this._gl){if(!g)throw new Error("The provided canvas is null or undefined.");try{this._gl=g.getContext("webgl",U)||g.getContext("experimental-webgl",U)}catch(d){throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=z,g=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const u=this._gl.getContextAttributes();u&&(U.tf=u.tf)}this._sharedInit(g),this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),void 0!==U.useHighPrecisionFloats&&(this._highPrecisionShadersAllowed=U.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let J=0;J<this._caps.maxVertexAttribs;J++)this._currentBufferPointers[J]=new T;this._shaderProcessor=this.webGLVersion>1?new R:new w;const P="Babylon.js v".concat(X.Version);f.d.Log(P+" - ".concat(this.description)),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",P);const S=(0,J.C)(this._gl);S.validateShaderPrograms=this.validateShaderPrograms,S.parallelShaderCompile=this._caps.parallelShaderCompile}_clearEmptyResources(){this._dummyFramebuffer=null,super._clearEmptyResources()}_getShaderProcessingContext(z){return null}areAllEffectsReady(){for(const z in this._compiledEffects){if(!this._compiledEffects[z].isReady())return!1}return!0}_initGLContext(){this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||null!==this._gl.getExtension("OES_standard_derivatives"),maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||null!==this._gl.getExtension("OES_element_index_uint"),fragmentDepthSupported:this._webGLVersion>1||null!==this._gl.getExtension("EXT_frag_depth"),highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,colorBufferHalfFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_half_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:1!==this._webGLVersion,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1,textureNorm16:!!this._gl.getExtension("EXT_texture_norm16")},this._caps.supportFloatTexturesResolve=this._caps.colorBufferFloat,this._caps.rg11b10ufColorRenderable=this._caps.colorBufferFloat,this._glVersion=this._gl.getParameter(this._gl.VERSION);const z=this._gl.getExtension("WEBGL_debug_renderer_info");var u;(null!=z&&(this._glRenderer=this._gl.getParameter(z.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(z.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),36193!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=36193),34842!==this._gl.RGBA16F&&(this._gl.RGBA16F=34842),34836!==this._gl.RGBA32F&&(this._gl.RGBA32F=34836),35056!==this._gl.DEPTH24_STENCIL8&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery)&&(1===this._webGLVersion&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=(null!==(u=this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT))&&void 0!==u?u:0)>0);if(this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!(!this._caps.textureFloat||!this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!(!this._caps.textureFloat||!this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.textureNorm16&&(this._gl.R16_EXT=33322,this._gl.RG16_EXT=33324,this._gl.RGB16_EXT=32852,this._gl.RGBA16_EXT=32859,this._gl.R16_SNORM_EXT=36760,this._gl.RG16_SNORM_EXT=36761,this._gl.RGB16_SNORM_EXT=36762,this._gl.RGBA16_SNORM_EXT=36763),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&5131!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=null!==this._maxMSAASamplesOverride?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES),this._caps.maxDrawBuffers=this._gl.getParameter(this._gl.MAX_DRAW_BUFFERS);else{const z=this._gl.getExtension("WEBGL_draw_buffers");if(null!==z){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=z.drawBuffersWEBGL.bind(z),this._caps.maxDrawBuffers=this._gl.getParameter(z.MAX_DRAW_BUFFERS_WEBGL),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let u=0;u<16;u++)this._gl["COLOR_ATTACHMENT"+u+"_WEBGL"]=z["COLOR_ATTACHMENT"+u+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{const z=this._gl.getExtension("WEBGL_depth_texture");null!=z&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=z.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{const z=this._gl.getExtension("OES_vertex_array_object");null!=z&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=z.createVertexArrayOES.bind(z),this._gl.bindVertexArray=z.bindVertexArrayOES.bind(z),this._gl.deleteVertexArray=z.deleteVertexArrayOES.bind(z))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{const z=this._gl.getExtension("ANGLE_instanced_arrays");null!=z?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=z.drawArraysInstancedANGLE.bind(z),this._gl.drawElementsInstanced=z.drawElementsInstancedANGLE.bind(z),this._gl.vertexAttribDivisor=z.vertexAttribDivisorANGLE.bind(z)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){const z=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),u=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);z&&u&&(this._caps.highPrecisionShaderSupported=0!==z.precision&&0!==u.precision)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{const z=this._gl.getExtension("EXT_blend_minmax");null!=z&&(this._caps.blendMinMax=!0,this._gl.MAX=z.MAX_EXT,this._gl.MIN=z.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:WebGL2RenderingContext.SRGB,SRGB8:WebGL2RenderingContext.SRGB8,SRGB8_ALPHA8:WebGL2RenderingContext.SRGB8_ALPHA8};else{const z=this._gl.getExtension("EXT_sRGB");null!=z&&(this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:z.SRGB_EXT,SRGB8:z.SRGB_ALPHA_EXT,SRGB8_ALPHA8:z.SRGB_ALPHA_EXT})}if(this._creationOptions){const z=this._creationOptions.forceSRGBBufferSupportState;void 0!==z&&(this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&z)}}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let U=0;U<this._maxSimultaneousTextures;U++)this._nextFreeTextureSlots.push(U);"Mali-G72"===this._glRenderer&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:"undefined"===typeof HTMLImageElement,supportRenderAndCopyToLodForFloatTextures:1!==this._webGLVersion,supportDepthStencilTexture:1!==this._webGLVersion,supportShadowSamplers:1!==this._webGLVersion,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:1!==this._webGLVersion,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:1!==this._webGLVersion,basisNeedsPOT:1===this._webGLVersion,support3DTextures:1!==this._webGLVersion,needTypeSuffixInShaderConstants:1!==this._webGLVersion,supportMSAA:1!==this._webGLVersion,supportSSAO2:1!==this._webGLVersion,supportIBLShadows:1!==this._webGLVersion,supportExtendedTextureFormats:1!==this._webGLVersion,supportSwitchCaseInShader:1!==this._webGLVersion,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,forceVertexBufferStrideAndOffsetMultiple4Bytes:!1,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const z=this._workingCanvas.getContext("2d");z&&(this._workingContext=z)}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}extractDriverInfo(){const z=this.getGlInfo();return z&&z.renderer?z.renderer:""}getRenderWidth(){return!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(){return!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}clear(z,u,U){let J=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const v=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=v;let f=0;if(u&&z){let u=!0;if(this._currentRenderTarget){var g;const U=null===(g=this._currentRenderTarget.texture)||void 0===g?void 0:g.format;if(8===U||9===U||10===U||11===U){var w;const U=null===(w=this._currentRenderTarget.texture)||void 0===w?void 0:w.type;7===U||5===U?(X._TempClearColorUint32[0]=255*z.r,X._TempClearColorUint32[1]=255*z.g,X._TempClearColorUint32[2]=255*z.b,X._TempClearColorUint32[3]=255*z.a,this._gl.clearBufferuiv(this._gl.COLOR,0,X._TempClearColorUint32),u=!1):(X._TempClearColorInt32[0]=255*z.r,X._TempClearColorInt32[1]=255*z.g,X._TempClearColorInt32[2]=255*z.b,X._TempClearColorInt32[3]=255*z.a,this._gl.clearBufferiv(this._gl.COLOR,0,X._TempClearColorInt32),u=!1)}}u&&(this._gl.clearColor(z.r,z.g,z.b,void 0!==z.a?z.a:1),f|=this._gl.COLOR_BUFFER_BIT)}U&&(this.df?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),f|=this._gl.DEPTH_BUFFER_BIT),J&&(this._gl.clearStencil(0),f|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(f)}_viewport(z,u,U,J){z===this._viewportCached.x&&u===this._viewportCached.y&&U===this._viewportCached.z&&J===this._viewportCached.w||(this._viewportCached.x=z,this._viewportCached.y=u,this._viewportCached.z=U,this._viewportCached.w=J,this._gl.viewport(z,u,U,J))}Tf(){super.Tf(),this._badOS&&this.flushFramebuffer()}get performanceMonitor(){throw new Error("Not Supported by ThinEngine")}bindFramebuffer(z){let u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,U=arguments.length>2?arguments[2]:void 0,J=arguments.length>3?arguments[3]:void 0,v=arguments.length>4?arguments[4]:void 0,g=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,w=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;const P=z;this._currentRenderTarget&&this._resolveAndGenerateMipMapsFramebuffer(this._currentRenderTarget),this._currentRenderTarget=z,this._bindUnboundFramebuffer(P._framebuffer);const R=this._gl;var S;if(!z.isMulti)if(z.is2DArray||z.is3D)R.framebufferTextureLayer(R.FRAMEBUFFER,R.COLOR_ATTACHMENT0,null===(S=z.texture._hardwareTexture)||void 0===S?void 0:S.underlyingResource,g,w),P._currentLOD=g;else if(z.isCube){var d;R.framebufferTexture2D(R.FRAMEBUFFER,R.COLOR_ATTACHMENT0,R.TEXTURE_CUBE_MAP_POSITIVE_X+u,null===(d=z.texture._hardwareTexture)||void 0===d?void 0:d.underlyingResource,g)}else if(P._currentLOD!==g){var mz;R.framebufferTexture2D(R.FRAMEBUFFER,R.COLOR_ATTACHMENT0,R.TEXTURE_2D,null===(mz=z.texture._hardwareTexture)||void 0===mz?void 0:mz.underlyingResource,g),P._currentLOD=g}const Z=z._depthStencilTexture;if(Z){z.is3D&&(z.texture.width===Z.width&&z.texture.height===Z.height&&z.texture.depth===Z.depth||f.d.Warn("Depth/Stencil attachment for 3D target must have same dimensions as color attachment"));const U=z._depthStencilTextureWithStencil?R.DEPTH_STENCIL_ATTACHMENT:R.DEPTH_ATTACHMENT;var A;if(z.is2DArray||z.is3D)R.framebufferTextureLayer(R.FRAMEBUFFER,U,null===(A=Z._hardwareTexture)||void 0===A?void 0:A.underlyingResource,g,w);else if(z.isCube){var E;R.framebufferTexture2D(R.FRAMEBUFFER,U,R.TEXTURE_CUBE_MAP_POSITIVE_X+u,null===(E=Z._hardwareTexture)||void 0===E?void 0:E.underlyingResource,g)}else{var C;R.framebufferTexture2D(R.FRAMEBUFFER,U,R.TEXTURE_2D,null===(C=Z._hardwareTexture)||void 0===C?void 0:C.underlyingResource,g)}}P._MSAAFramebuffer&&this._bindUnboundFramebuffer(P._MSAAFramebuffer),this._cachedViewport&&!v?this.setViewport(this._cachedViewport,U,J):(U||(U=z.width,g&&(U/=Math.pow(2,g))),J||(J=z.height,g&&(J/=Math.pow(2,g))),this._viewport(0,0,U,J)),this.wipeCaches()}setStateCullFaceType(z,u){var U,J;const v=null===(U=null!==(J=this.cullBackFaces)&&void 0!==J?J:z)||void 0===U||U?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==v||u)&&(this._depthCullingState.cullFace=v)}setState(z){let u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,U=arguments.length>2?arguments[2]:void 0,J=arguments.length>3&&void 0!==arguments[3]&&arguments[3],v=arguments.length>4?arguments[4]:void 0,f=arguments.length>5?arguments[5]:void 0,g=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;(this._depthCullingState.cull!==z||U)&&(this._depthCullingState.cull=z),this.setStateCullFaceType(v,U),this.setZOffset(u),this.setZOffsetUnits(g);const w=J?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==w||U)&&(this._depthCullingState.frontFace=w),this._stencilStateComposer.stencilMaterial=f}_resolveAndGenerateMipMapsFramebuffer(z){let u=arguments.length>1&&void 0!==arguments[1]&&arguments[1];z.disableAutomaticMSAAResolve||(z.isMulti?this.resolveMultiFramebuffer(z):this.resolveFramebuffer(z)),u||(z.isMulti?this.generateMipMapsMultiFramebuffer(z):this.generateMipMapsFramebuffer(z))}_bindUnboundFramebuffer(z){this._currentFramebuffer!==z&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,z),this._currentFramebuffer=z)}_currentFrameBufferIsDefaultFrameBuffer(){return null===this._currentFramebuffer}generateMipmaps(z){const u=this._getTextureTarget(z);this._bindTextureDirectly(u,z,!0),this._gl.generateMipmap(u),this._bindTextureDirectly(u,null)}unBindFramebuffer(z,u,U){const J=z;this._currentRenderTarget=null,this._resolveAndGenerateMipMapsFramebuffer(z,u),U&&(J._MSAAFramebuffer&&this._bindUnboundFramebuffer(J._framebuffer),U()),this._bindUnboundFramebuffer(null)}generateMipMapsFramebuffer(z){var u;z.isMulti||null===(u=z.texture)||void 0===u||!u.generateMipMaps||z.isCube||this.generateMipmaps(z.texture)}resolveFramebuffer(z){const u=z,U=this._gl;if(!u._MSAAFramebuffer||u.isMulti)return;let J=u.resolveMSAAColors?U.COLOR_BUFFER_BIT:0;J|=u._generateDepthBuffer&&u.resolveMSAADepth?U.DEPTH_BUFFER_BIT:0,J|=u._generateStencilBuffer&&u.resolveMSAAStencil?U.STENCIL_BUFFER_BIT:0,U.bindFramebuffer(U.READ_FRAMEBUFFER,u._MSAAFramebuffer),U.bindFramebuffer(U.DRAW_FRAMEBUFFER,u._framebuffer),U.blitFramebuffer(0,0,z.width,z.height,0,0,z.width,z.height,J,U.NEAREST)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(z,u,U){return this._createVertexBuffer(z,this._gl.STATIC_DRAW)}_createVertexBuffer(z,u){const U=this._gl.createBuffer();if(!U)throw new Error("Unable to create vertex buffer");const J=new S.d(U);return this.bindArrayBuffer(J),"number"!==typeof z?z instanceof Array?(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(z),u),J.MU=4*z.length):(this._gl.bufferData(this._gl.ARRAY_BUFFER,z,u),J.MU=z.byteLength):(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Uint8Array(z),u),J.MU=z),this._resetVertexBufferBinding(),J.references=1,J}createDynamicVertexBuffer(z,u){return this._createVertexBuffer(z,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(z,u,U){const J=this._gl.createBuffer(),v=new S.d(J);if(!J)throw new Error("Unable to create index buffer");this.bindIndexBuffer(v);const f=this._normalizeIndexData(z);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,f,u?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),v.references=1,v.is32Bits=4===f.BYTES_PER_ELEMENT,v}_normalizeIndexData(z){if(2===z.BYTES_PER_ELEMENT)return z;if(this._caps.uintIndices){if(z instanceof Uint32Array)return z;for(let u=0;u<z.length;u++)if(z[u]>=65535)return new Uint32Array(z);return new Uint16Array(z)}return new Uint16Array(z)}bindArrayBuffer(z){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(z,this._gl.ARRAY_BUFFER)}bindUniformBlock(z,u,U){const J=z.program,v=this._gl.getUniformBlockIndex(J,u);this._gl.uniformBlockBinding(J,v,U)}bindIndexBuffer(z){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(z,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(z,u){(this._vaoRecordInProgress||this._currentBoundBuffer[u]!==z)&&(this._gl.bindBuffer(u,z?z.underlyingResource:null),this._currentBoundBuffer[u]=z)}updateArrayBuffer(z){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,z)}_vertexAttribPointer(z,u,U,J,v,f,g){const w=this._currentBufferPointers[u];if(!w)return;let P=!1;w.active?(w.buffer!==z&&(w.buffer=z,P=!0),w.size!==U&&(w.size=U,P=!0),w.type!==J&&(w.type=J,P=!0),w.normalized!==v&&(w.normalized=v,P=!0),w.stride!==f&&(w.stride=f,P=!0),w.offset!==g&&(w.offset=g,P=!0)):(P=!0,w.active=!0,w.index=u,w.size=U,w.type=J,w.normalized=v,w.stride=f,w.offset=g,w.buffer=z),(P||this._vaoRecordInProgress)&&(this.bindArrayBuffer(z),J===this._gl.UNSIGNED_INT||J===this._gl.INT?this._gl.vertexAttribIPointer(u,U,J,f,g):this._gl.vertexAttribPointer(u,U,J,v,f,g))}_bindIndexBufferWithCache(z){null!=z&&this._cachedIndexBuffer!==z&&(this._cachedIndexBuffer=z,this.bindIndexBuffer(z),this._uintIndicesCurrentlySet=z.is32Bits)}_bindVertexBuffersAttributes(z,u,U){const J=u.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let v=0;v<J.length;v++){const f=u.getAttributeLocation(v);if(f>=0){const u=J[v];let g=null;if(U&&(g=U[u]),g||(g=z[u]),!g)continue;this._gl.enableVertexAttribArray(f),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[f]=!0);const w=g.getBuffer();w&&(this._vertexAttribPointer(w,f,g.getSize(),g.type,g.normalized,g.byteStride,g.byteOffset),g.getIsInstanced()&&(this._gl.vertexAttribDivisor(f,g.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(f),this._currentInstanceBuffers.push(w))))}}}recordVertexArrayObject(z,u,U,J){const v=this._gl.createVertexArray();if(!v)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(v),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(z,U,J),this.bindIndexBuffer(u),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),v}bindVertexArrayObject(z,u){this._cachedVertexArrayObject!==z&&(this._cachedVertexArrayObject=z,this._gl.bindVertexArray(z),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=null!=u&&u.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(z,u,U,J,v){if(this._cachedVertexBuffers!==z||this._cachedEffectForVertexBuffers!==v){this._cachedVertexBuffers=z,this._cachedEffectForVertexBuffers=v;const u=v.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let f=0;for(let g=0;g<u;g++)if(g<U.length){const u=v.getAttributeLocation(g);u>=0&&(this._gl.enableVertexAttribArray(u),this._vertexAttribArraysEnabled[u]=!0,this._vertexAttribPointer(z,u,U[g],this._gl.FLOAT,!1,J,f)),f+=4*U[g]}}this._bindIndexBufferWithCache(u)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(z,u,U,J){this._cachedVertexBuffers===z&&this._cachedEffectForVertexBuffers===U||(this._cachedVertexBuffers=z,this._cachedEffectForVertexBuffers=U,this._bindVertexBuffersAttributes(z,U,J)),this._bindIndexBufferWithCache(u)}unbindInstanceAttributes(){let z;for(let u=0,U=this._currentInstanceLocations.length;u<U;u++){const U=this._currentInstanceBuffers[u];z!=U&&U.references&&(z=U,this.bindArrayBuffer(U));const J=this._currentInstanceLocations[u];this._gl.vertexAttribDivisor(J,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(z){this._gl.deleteVertexArray(z)}_releaseBuffer(z){return z.references--,0===z.references&&(this._deleteBuffer(z),!0)}_deleteBuffer(z){this._gl.deleteBuffer(z.underlyingResource)}updateAndBindInstancesBuffer(z,u,U){if(this.bindArrayBuffer(z),u&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,u),void 0!==U[0].index)this.bindInstancesBuffer(z,U,!0);else for(let J=0;J<4;J++){const u=U[J];this._vertexAttribArraysEnabled[u]||(this._gl.enableVertexAttribArray(u),this._vertexAttribArraysEnabled[u]=!0),this._vertexAttribPointer(z,u,4,this._gl.FLOAT,!1,64,16*J),this._gl.vertexAttribDivisor(u,1),this._currentInstanceLocations.push(u),this._currentInstanceBuffers.push(z)}}bindInstancesBuffer(z,u){let U=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.bindArrayBuffer(z);let J=0;if(U)for(let v=0;v<u.length;v++){J+=4*u[v].attributeSize}for(let v=0;v<u.length;v++){const U=u[v];void 0===U.index&&(U.index=this._currentEffect.getAttributeLocationByName(U.attributeName)),U.index<0||(this._vertexAttribArraysEnabled[U.index]||(this._gl.enableVertexAttribArray(U.index),this._vertexAttribArraysEnabled[U.index]=!0),this._vertexAttribPointer(z,U.index,U.attributeSize,U.attributeType||this._gl.FLOAT,U.normalized||!1,J,U.offset),this._gl.vertexAttribDivisor(U.index,void 0===U.divisor?1:U.divisor),this._currentInstanceLocations.push(U.index),this._currentInstanceBuffers.push(z))}}disableInstanceAttributeByName(z){if(!this._currentEffect)return;const u=this._currentEffect.getAttributeLocationByName(z);this.disableInstanceAttribute(u)}disableInstanceAttribute(z){let u,U=!1;for(;-1!==(u=this._currentInstanceLocations.indexOf(z));)this._currentInstanceLocations.splice(u,1),this._currentInstanceBuffers.splice(u,1),U=!0,u=this._currentInstanceLocations.indexOf(z);U&&(this._gl.vertexAttribDivisor(z,0),this.disableAttributeByIndex(z))}disableAttributeByIndex(z){this._gl.disableVertexAttribArray(z),this._vertexAttribArraysEnabled[z]=!1,this._currentBufferPointers[z].active=!1}draw(z,u,U,J){this.drawElementsType(z?0:1,u,U,J)}drawPointClouds(z,u,U){this.drawArraysType(2,z,u,U)}drawUnIndexed(z,u,U,J){this.drawArraysType(z?0:1,u,U,J)}drawElementsType(z,u,U,J){this.applyStates(),this._reportDrawCall();const v=this._drawMode(z),f=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,g=this._uintIndicesCurrentlySet?4:2;J?this._gl.drawElementsInstanced(v,U,f,u*g,J):this._gl.drawElements(v,U,f,u*g)}drawArraysType(z,u,U,J){this.applyStates(),this._reportDrawCall();const v=this._drawMode(z);J?this._gl.drawArraysInstanced(v,u,U,J):this._gl.drawArrays(v,u,U)}_drawMode(z){switch(z){case 0:default:return this._gl.TRIANGLES;case 2:case 3:return this._gl.POINTS;case 1:case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN}}_releaseEffect(z){this._compiledEffects[z._key]&&delete this._compiledEffects[z._key];const u=z.getPipelineContext();u&&this._deletePipelineContext(u)}_deletePipelineContext(z){const u=z;u&&u.program&&(u.program.__SPECTOR_rebuildProgram=null,(0,r.l)(u),this._gl&&(this._currentProgram===u.program&&this._setProgram(null),this._gl.deleteProgram(u.program)))}_getGlobalDefines(z){return(0,C.h)(z,this.isNDCHalfZRange,this.df,this.useExactSrgbConversions)}createEffect(z,u,U,v,f,g,w,P,R){var S,d,mz;let Z=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,A=arguments.length>10?arguments[10]:void 0;const C="string"===typeof z?z:z.vertexToken||z.vertexSource||z.vertexElement||z.vertex,r="string"===typeof z?z:z.fragmentToken||z.fragmentSource||z.fragmentElement||z.fragment,M=this._getGlobalDefines(),T=void 0!==u.attributes;let X=null!==(S=null!==f&&void 0!==f?f:u.defines)&&void 0!==S?S:"";M&&(X+=M);const h=C+"+"+r+"@"+X;if(this._compiledEffects[h]){const z=this._compiledEffects[h];return w&&z.isReady()&&w(z),z._refCount++,z}this._gl&&(0,J.C)(this._gl);const t=new E.Effect(z,u,T?this:U,v,this,f,g,w,P,R,h,null!==(d=u.shaderLanguage)&&void 0!==d?d:Z,null!==(mz=u.extraInitializationsAsync)&&void 0!==mz?mz:A);return this._compiledEffects[h]=t,t}_getShaderSource(z){return this._gl.getShaderSource(z)}createRawShaderProgram(z,u,U,v){let f=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const g=(0,J.C)(this._gl);return g._contextWasLost=this._contextWasLost,g.validateShaderPrograms=this.validateShaderPrograms,(0,J.t)(z,u,U,v||this._gl,f)}createShaderProgram(z,u,U,v,f){let g=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;const w=(0,J.C)(this._gl);return w._contextWasLost=this._contextWasLost,w.validateShaderPrograms=this.validateShaderPrograms,(0,J.v)(z,u,U,v,f||this._gl,g)}inlineShaderCode(z){return z}createPipelineContext(z){if(this._gl){(0,J.C)(this._gl).parallelShaderCompile=this._caps.parallelShaderCompile}const u=(0,J.s)(this._gl,z);return u.Au=this,u}createMaterialContext(){}createDrawContext(){}_finalizePipelineContext(z){return(0,J.f)(z,this._gl,this.validateShaderPrograms)}_preparePipelineContextAsync(z,u,U,v,f,g,w,P,R,S,d){const mz=(0,J.C)(this._gl);return mz._contextWasLost=this._contextWasLost,mz.validateShaderPrograms=this.validateShaderPrograms,mz._createShaderProgramInjection=this._createShaderProgram.bind(this),mz.createRawShaderProgramInjection=this.createRawShaderProgram.bind(this),mz.createShaderProgramInjection=this.createShaderProgram.bind(this),mz.loadFileInjection=this._loadFile.bind(this),(0,J.n)(z,u,U,v,f,g,w,P,R,S,d)}_createShaderProgram(z,u,U,v){let f=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return(0,J.c)(z,u,U,v,f)}_isRenderingStateCompiled(z){return!this._isDisposed&&(0,J.j)(z,this._gl,this.validateShaderPrograms)}_executeWhenRenderingStateIsCompiled(z,u){(0,J.e)(z,u)}getUniforms(z,u){const U=new Array,J=z;for(let v=0;v<u.length;v++)U.push(this._gl.getUniformLocation(J.program,u[v]));return U}getAttributes(z,u){const U=[],J=z;for(let f=0;f<u.length;f++)try{U.push(this._gl.getAttribLocation(J.program,u[f]))}catch(v){U.push(-1)}return U}enableEffect(z){(z=null!==z&&(0,v.c)(z)?z.effect:z)&&z!==this._currentEffect&&(this._stencilStateComposer.stencilMaterial=void 0,this.bindSamplers(z),this._currentEffect=z,z.onBind&&z.onBind(z),z._onBindObservable&&z._onBindObservable.notifyObservers(z))}setInt(z,u){return!!z&&(this._gl.uniform1i(z,u),!0)}setInt2(z,u,U){return!!z&&(this._gl.uniform2i(z,u,U),!0)}setInt3(z,u,U,J){return!!z&&(this._gl.uniform3i(z,u,U,J),!0)}setInt4(z,u,U,J,v){return!!z&&(this._gl.uniform4i(z,u,U,J,v),!0)}setIntArray(z,u){return!!z&&(this._gl.uniform1iv(z,u),!0)}setIntArray2(z,u){return!(!z||u.length%2!==0)&&(this._gl.uniform2iv(z,u),!0)}setIntArray3(z,u){return!(!z||u.length%3!==0)&&(this._gl.uniform3iv(z,u),!0)}setIntArray4(z,u){return!(!z||u.length%4!==0)&&(this._gl.uniform4iv(z,u),!0)}setUInt(z,u){return!!z&&(this._gl.uniform1ui(z,u),!0)}setUInt2(z,u,U){return!!z&&(this._gl.uniform2ui(z,u,U),!0)}setUInt3(z,u,U,J){return!!z&&(this._gl.uniform3ui(z,u,U,J),!0)}setUInt4(z,u,U,J,v){return!!z&&(this._gl.uniform4ui(z,u,U,J,v),!0)}setUIntArray(z,u){return!!z&&(this._gl.uniform1uiv(z,u),!0)}setUIntArray2(z,u){return!(!z||u.length%2!==0)&&(this._gl.uniform2uiv(z,u),!0)}setUIntArray3(z,u){return!(!z||u.length%3!==0)&&(this._gl.uniform3uiv(z,u),!0)}setUIntArray4(z,u){return!(!z||u.length%4!==0)&&(this._gl.uniform4uiv(z,u),!0)}setArray(z,u){return!!z&&(!(u.length<1)&&(this._gl.uniform1fv(z,u),!0))}setArray2(z,u){return!(!z||u.length%2!==0)&&(this._gl.uniform2fv(z,u),!0)}setArray3(z,u){return!(!z||u.length%3!==0)&&(this._gl.uniform3fv(z,u),!0)}setArray4(z,u){return!(!z||u.length%4!==0)&&(this._gl.uniform4fv(z,u),!0)}setMatrices(z,u){return!!z&&(this._gl.uniformMatrix4fv(z,!1,u),!0)}setMatrix3x3(z,u){return!!z&&(this._gl.uniformMatrix3fv(z,!1,u),!0)}setMatrix2x2(z,u){return!!z&&(this._gl.uniformMatrix2fv(z,!1,u),!0)}setFloat(z,u){return!!z&&(this._gl.uniform1f(z,u),!0)}setFloat2(z,u,U){return!!z&&(this._gl.uniform2f(z,u,U),!0)}setFloat3(z,u,U,J){return!!z&&(this._gl.uniform3f(z,u,U,J),!0)}setFloat4(z,u,U,J,v){return!!z&&(this._gl.uniform4f(z,u,U,J,v),!0)}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;const z=this._colorWrite;this._gl.colorMask(z,z,z,z)}}wipeCaches(z){this.preventCacheWipeBetweenFrames&&!z||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),z&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(z,u){const U=this._gl;let J=U.NEAREST,v=U.NEAREST,f=!1;switch(z){case 11:J=U.LINEAR,v=u?U.LINEAR_MIPMAP_NEAREST:U.LINEAR;break;case 3:J=U.LINEAR,f=!0,v=u?U.LINEAR_MIPMAP_LINEAR:U.LINEAR;break;case 8:f=!0,J=U.NEAREST,v=u?U.NEAREST_MIPMAP_LINEAR:U.NEAREST;break;case 4:J=U.NEAREST,v=u?U.NEAREST_MIPMAP_NEAREST:U.NEAREST;break;case 5:J=U.NEAREST,v=u?U.LINEAR_MIPMAP_NEAREST:U.LINEAR;break;case 6:f=!0,J=U.NEAREST,v=u?U.LINEAR_MIPMAP_LINEAR:U.LINEAR;break;case 7:J=U.NEAREST,v=U.LINEAR;break;case 1:J=U.NEAREST,v=U.NEAREST;break;case 9:J=U.LINEAR,v=u?U.NEAREST_MIPMAP_NEAREST:U.NEAREST;break;case 10:f=!0,J=U.LINEAR,v=u?U.NEAREST_MIPMAP_LINEAR:U.NEAREST;break;case 2:J=U.LINEAR,v=U.LINEAR;break;case 12:J=U.LINEAR,v=U.NEAREST}return{min:v,mag:J,hasMipMaps:f}}_createTexture(){const z=this._gl.createTexture();if(!z)throw new Error("Unable to create texture");return z}_createHardwareTexture(){return new Z.d(this._createTexture(),this._gl)}_createInternalTexture(z,u){let U,J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,v=!1,g=!1,w=0,P=3,R=5,S=!1,d=1,mz=!1,Z=0;var E;void 0!==u&&"object"===typeof u?(v=!!u.generateMipMaps,g=!!u.createMipMaps,w=void 0===u.type?0:u.type,P=void 0===u.samplingMode?3:u.samplingMode,R=void 0===u.format?5:u.format,S=void 0!==u.useSRGBBuffer&&u.useSRGBBuffer,d=null!==(E=u.samples)&&void 0!==E?E:1,U=u.label,mz=!!u.createMSAATexture,Z=u.comparisonFunction||0):v=!!u;S&&(S=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(1!==w||this._caps.textureFloatLinearFiltering)&&(2!==w||this._caps.textureHalfFloatLinearFiltering)||(P=1),1!==w||this._caps.textureFloat||(w=0,f.d.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const C=(0,M.f)(R),r=(0,M.c)(R),T=this._gl,X=new A.c(this,J),h=z.width||z,t=z.height||z,V=z.depth||0,L=z.layers||0,O=this._getSamplingParameters(P,(v||g)&&!C),x=0!==L?T.TEXTURE_2D_ARRAY:0!==V?T.TEXTURE_3D:T.TEXTURE_2D,Q=C?this._getInternalFormatFromDepthTextureFormat(R,!0,r):this._getRGBABufferInternalSizedFormat(w,R,S),K=C?r?T.DEPTH_STENCIL:T.DEPTH_COMPONENT:this._getInternalFormat(R),Y=C?this._getWebGLTextureTypeFromDepthTextureFormat(R):this._getWebGLTextureType(w);if(this._bindTextureDirectly(x,X),0!==L?(X.is2DArray=!0,T.texImage3D(x,0,Q,h,t,L,0,K,Y,null)):0!==V?(X.is3D=!0,T.texImage3D(x,0,Q,h,t,V,0,K,Y,null)):T.texImage2D(x,0,Q,h,t,0,K,Y,null),T.texParameteri(x,T.TEXTURE_MAG_FILTER,O.mag),T.texParameteri(x,T.TEXTURE_MIN_FILTER,O.min),T.texParameteri(x,T.TEXTURE_WRAP_S,T.CLAMP_TO_EDGE),T.texParameteri(x,T.TEXTURE_WRAP_T,T.CLAMP_TO_EDGE),C&&this.webGLVersion>1&&(0===Z?(T.texParameteri(x,T.TEXTURE_COMPARE_FUNC,515),T.texParameteri(x,T.TEXTURE_COMPARE_MODE,T.NONE)):(T.texParameteri(x,T.TEXTURE_COMPARE_FUNC,Z),T.texParameteri(x,T.TEXTURE_COMPARE_MODE,T.COMPARE_REF_TO_TEXTURE))),(v||g)&&this._gl.generateMipmap(x),this._bindTextureDirectly(x,null),X._useSRGBBuffer=S,X.baseWidth=h,X.baseHeight=t,X.width=h,X.height=t,X.depth=L||V,X.isReady=!0,X.samples=d,X.generateMipMaps=v,X.samplingMode=P,X.type=w,X.format=R,X.label=U,X.comparisonFunction=Z,this._internalTexturesCache.push(X),mz){let z=null;if(z=(0,M.f)(X.format)?this._setupFramebufferDepthAttachments((0,M.c)(X.format),19!==X.format,X.width,X.height,d,X.format,!0):this._createRenderBuffer(X.width,X.height,d,-1,this._getRGBABufferInternalSizedFormat(X.type,X.format,X._useSRGBBuffer),-1),!z)throw new Error("Unable to create render buffer");X._autoMSAAManagement=!0;let u=X._hardwareTexture;u||(u=X._hardwareTexture=this._createHardwareTexture()),u.addMSAARenderBuffer(z)}return X}_getUseSRGBBuffer(z,u){return z&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||u)}createTexture(z,u,U,J){var v=this;let f=arguments.length>4&&void 0!==arguments[4]?arguments[4]:3,g=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,w=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,P=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,R=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,S=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,d=arguments.length>10&&void 0!==arguments[10]?arguments[10]:null,mz=arguments.length>11?arguments[11]:void 0,Z=arguments.length>12?arguments[12]:void 0,E=arguments.length>13?arguments[13]:void 0,C=arguments.length>14?arguments[14]:void 0;return this._createTextureBase(z,u,U,J,f,g,w,(function(){for(var z=arguments.length,u=new Array(z),U=0;U<z;U++)u[U]=arguments[U];return v._prepareWebGLTexture(...u,S)}),((z,u,U,v,f,g)=>{const w=this._gl,P=U.width===z&&U.height===u;f._creationFlags=null!==E&&void 0!==E?E:0;const R=this._getTexImageParametersForCreateTexture(f.format,f._useSRGBBuffer);if(P)return w.texImage2D(w.TEXTURE_2D,0,R.internalFormat,R.format,R.type,U),!1;const S=this._caps.maxTextureSize;if(U.width>S||U.height>S||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!(!this._workingCanvas||!this._workingContext)&&(this._workingCanvas.width=z,this._workingCanvas.height=u,this._workingContext.drawImage(U,0,0,U.width,U.height,0,0,z,u),w.texImage2D(w.TEXTURE_2D,0,R.internalFormat,R.format,R.type,this._workingCanvas),f.width=z,f.height=u,!1);{const z=new A.c(this,2);this._bindTextureDirectly(w.TEXTURE_2D,z,!0),w.texImage2D(w.TEXTURE_2D,0,R.internalFormat,R.format,R.type,U),this._rescaleTexture(z,f,J,R.format,(()=>{this._releaseTexture(z),this._bindTextureDirectly(w.TEXTURE_2D,f,!0),g()}))}return!0}),P,R,S,d,mz,Z,C)}_getTexImageParametersForCreateTexture(z,u){let U,J;return 1===this.webGLVersion?(U=this._getInternalFormat(z,u),J=U):(U=this._getInternalFormat(z,!1),J=this._getRGBABufferInternalSizedFormat(0,z,u)),{internalFormat:J,format:U,type:this._gl.UNSIGNED_BYTE}}_rescaleTexture(z,u,U,J,v){}_unpackFlipY(z){this._unpackFlipYCached!==z&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,z?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=z))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(z){return z.isCube?this._gl.TEXTURE_CUBE_MAP:z.is3D?this._gl.TEXTURE_3D:z.is2DArray||z.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(z,u){let U=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const J=this._getTextureTarget(u),v=this._getSamplingParameters(z,u.useMipMaps||U);this._setTextureParameterInteger(J,this._gl.TEXTURE_MAG_FILTER,v.mag,u),this._setTextureParameterInteger(J,this._gl.TEXTURE_MIN_FILTER,v.min),U&&v.hasMipMaps&&(u.generateMipMaps=!0,this._gl.generateMipmap(J)),this._bindTextureDirectly(J,null),u.samplingMode=z}updateTextureDimensions(z,u,U){}updateTextureWrappingMode(z,u){let U=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;const v=this._getTextureTarget(z);null!==u&&(this._setTextureParameterInteger(v,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(u),z),z._cachedWrapU=u),null!==U&&(this._setTextureParameterInteger(v,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(U),z),z._cachedWrapV=U),(z.is2DArray||z.is3D)&&null!==J&&(this._setTextureParameterInteger(v,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(J),z),z._cachedWrapR=J),this._bindTextureDirectly(v,null)}_uploadCompressedDataToTextureDirectly(z,u,U,J,v){let f=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,g=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;const w=this._gl;let P=w.TEXTURE_2D;if(z.isCube&&(P=w.TEXTURE_CUBE_MAP_POSITIVE_X+f),z._useSRGBBuffer)switch(u){case 37492:case 36196:this._caps.etc2?u=w.COMPRESSED_SRGB8_ETC2:z._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?u=w.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:z._useSRGBBuffer=!1;break;case 36492:u=w.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:u=w.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?u=w.COMPRESSED_SRGB_S3TC_DXT1_EXT:z._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?u=w.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:z._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?u=w.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:z._useSRGBBuffer=!1;break;default:z._useSRGBBuffer=!1}this._gl.compressedTexImage2D(P,g,u,U,J,0,v)}_uploadDataToTextureDirectly(z,u){let U=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,v=arguments.length>4?arguments[4]:void 0,f=arguments.length>5&&void 0!==arguments[5]&&arguments[5];const g=this._gl,w=this._getWebGLTextureType(z.type),P=this._getInternalFormat(z.format),R=void 0===v?this._getRGBABufferInternalSizedFormat(z.type,z.format,z._useSRGBBuffer):this._getInternalFormat(v,z._useSRGBBuffer);this._unpackFlipY(z.invertY);let S=g.TEXTURE_2D;z.isCube&&(S=g.TEXTURE_CUBE_MAP_POSITIVE_X+U);const d=Math.round(Math.log(z.width)*Math.LOG2E),mz=Math.round(Math.log(z.height)*Math.LOG2E),Z=f?z.width:Math.pow(2,Math.max(d-J,0)),A=f?z.height:Math.pow(2,Math.max(mz-J,0));g.texImage2D(S,J,R,Z,A,0,P,w,u)}updateTextureData(z,u,U,J,v,f){let g=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,w=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,P=arguments.length>8&&void 0!==arguments[8]&&arguments[8];const R=this._gl,S=this._getWebGLTextureType(z.type),d=this._getInternalFormat(z.format);this._unpackFlipY(z.invertY);let mz=R.TEXTURE_2D,Z=R.TEXTURE_2D;z.isCube&&(Z=R.TEXTURE_CUBE_MAP_POSITIVE_X+g,mz=R.TEXTURE_CUBE_MAP),this._bindTextureDirectly(mz,z,!0),R.texSubImage2D(Z,w,U,J,v,f,d,S,u),P&&this._gl.generateMipmap(Z),this._bindTextureDirectly(mz,null)}_uploadArrayBufferViewToTexture(z,u){let U=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const v=this._gl,f=z.isCube?v.TEXTURE_CUBE_MAP:v.TEXTURE_2D;this._bindTextureDirectly(f,z,!0),this._uploadDataToTextureDirectly(z,u,U,J),this._bindTextureDirectly(f,null,!0)}_prepareWebGLTextureContinuation(z,u,U,J,v){const f=this._gl;if(!f)return;const g=this._getSamplingParameters(v,!U);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,g.mag),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,g.min),U||J||f.generateMipmap(f.TEXTURE_2D),this._bindTextureDirectly(f.TEXTURE_2D,null),u&&u.removePendingData(z),z.onLoadedObservable.notifyObservers(z),z.onLoadedObservable.clear()}_prepareWebGLTexture(z,u,U,J,v,f,g,w,P,R){const S=this.getCaps().maxTextureSize,mz=Math.min(S,this.needPOTTextures?(0,d.c)(J.width,S):J.width),Z=Math.min(S,this.needPOTTextures?(0,d.c)(J.height,S):J.height),A=this._gl;A&&(z._hardwareTexture?(this._bindTextureDirectly(A.TEXTURE_2D,z,!0),this._unpackFlipY(void 0===v||!!v),z.baseWidth=J.width,z.baseHeight=J.height,z.width=mz,z.height=Z,z.isReady=!0,z.type=-1!==z.type?z.type:0,z.format=-1!==z.format?z.format:null!==R&&void 0!==R?R:".jpg"!==u||z._useSRGBBuffer?5:4,w(mz,Z,J,u,z,(()=>{this._prepareWebGLTextureContinuation(z,U,f,g,P)}))||this._prepareWebGLTextureContinuation(z,U,f,g,P)):U&&U.removePendingData(z))}_getInternalFormatFromDepthTextureFormat(z,u,U){const J=this._gl;if(!u)return J.STENCIL_INDEX8;let v=U?J.DEPTH_STENCIL:J.DEPTH_COMPONENT;return this.webGLVersion>1?15===z?v=J.DEPTH_COMPONENT16:16===z?v=J.DEPTH_COMPONENT24:17===z||13===z?v=U?J.DEPTH24_STENCIL8:J.DEPTH_COMPONENT24:14===z?v=J.DEPTH_COMPONENT32F:18===z&&(v=U?J.DEPTH32F_STENCIL8:J.DEPTH_COMPONENT32F):v=J.DEPTH_COMPONENT16,v}_getWebGLTextureTypeFromDepthTextureFormat(z){const u=this._gl;let U=u.UNSIGNED_INT;return 15===z?U=u.UNSIGNED_SHORT:17===z||13===z?U=u.UNSIGNED_INT_24_8:14===z?U=u.FLOAT:18===z?U=u.FLOAT_32_UNSIGNED_INT_24_8_REV:19===z&&(U=u.UNSIGNED_BYTE),U}_setupFramebufferDepthAttachments(z,u,U,J){var v;let f=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,g=arguments.length>5?arguments[5]:void 0,w=arguments.length>6&&void 0!==arguments[6]&&arguments[6];const P=this._gl;g=null!==(v=g)&&void 0!==v?v:z?13:14;const R=this._getInternalFormatFromDepthTextureFormat(g,u,z);return z&&u?this._createRenderBuffer(U,J,f,P.DEPTH_STENCIL,R,w?-1:P.DEPTH_STENCIL_ATTACHMENT):u?this._createRenderBuffer(U,J,f,R,R,w?-1:P.DEPTH_ATTACHMENT):z?this._createRenderBuffer(U,J,f,R,R,w?-1:P.STENCIL_ATTACHMENT):null}_createRenderBuffer(z,u,U,J,v,f){let g=!(arguments.length>6&&void 0!==arguments[6])||arguments[6];const w=this._gl.createRenderbuffer();return this._updateRenderBuffer(w,z,u,U,J,v,f,g)}_updateRenderBuffer(z,u,U,J,v,f,g){let w=!(arguments.length>7&&void 0!==arguments[7])||arguments[7];const P=this._gl;return P.bindRenderbuffer(P.RENDERBUFFER,z),J>1&&P.renderbufferStorageMultisample?P.renderbufferStorageMultisample(P.RENDERBUFFER,J,f,u,U):P.renderbufferStorage(P.RENDERBUFFER,v,u,U),-1!==g&&P.framebufferRenderbuffer(P.FRAMEBUFFER,g,P.RENDERBUFFER,z),w&&P.bindRenderbuffer(P.RENDERBUFFER,null),z}_releaseTexture(z){this._deleteTexture(z._hardwareTexture),this.unbindAllTextures();const u=this._internalTexturesCache.indexOf(z);-1!==u&&this._internalTexturesCache.splice(u,1),z._lodTextureHigh&&z._lodTextureHigh.dispose(),z._lodTextureMid&&z._lodTextureMid.dispose(),z._lodTextureLow&&z._lodTextureLow.dispose(),z._irradianceTexture&&z._irradianceTexture.dispose()}_deleteTexture(z){null===z||void 0===z||z.release()}_setProgram(z){this._currentProgram!==z&&((0,J.o)(z,this._gl),this._currentProgram=z)}bindSamplers(z){const u=z.getPipelineContext();this._setProgram(u.program);const U=z.getSamplers();for(let J=0;J<U.length;J++){const u=z.getUniform(U[J]);u&&(this._boundUniforms[J]=u)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(z,u){let U=arguments.length>2&&void 0!==arguments[2]&&arguments[2],J=arguments.length>3&&void 0!==arguments[3]&&arguments[3],v=!1;const g=u&&u._associatedChannel>-1;U&&g&&(this._activeChannel=u._associatedChannel);if(this._boundTexturesCache[this._activeChannel]!==u||J){if(this._activateCurrentTexture(),u&&u.isMultiview)throw f.d.Error(["_bindTextureDirectly called with a multiview texture!",z,u]),"_bindTextureDirectly called with a multiview texture!";var w,P;this._gl.bindTexture(z,null!==(w=null===u||void 0===u||null===(P=u._hardwareTexture)||void 0===P?void 0:P.underlyingResource)&&void 0!==w?w:null),this._boundTexturesCache[this._activeChannel]=u,u&&(u._associatedChannel=this._activeChannel)}else U&&(v=!0,this._activateCurrentTexture());return g&&!U&&this._bindSamplerUniformToChannel(u._associatedChannel,this._activeChannel),v}_bindTexture(z,u,U){if(void 0===z)return;u&&(u._associatedChannel=z),this._activeChannel=z;const J=u?this._getTextureTarget(u):this._gl.TEXTURE_2D;this._bindTextureDirectly(J,u)}unbindAllTextures(){for(let z=0;z<this._maxSimultaneousTextures;z++)this._activeChannel=z,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(z,u,U,J){void 0!==z&&(u&&(this._boundUniforms[z]=u),this._setTexture(z,U))}_bindSamplerUniformToChannel(z,u){const U=this._boundUniforms[z];U&&U._currentState!==u&&(this._gl.uniform1i(U,u),U._currentState=u)}_getTextureWrapMode(z){switch(z){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(z,u){let U,J=arguments.length>2&&void 0!==arguments[2]&&arguments[2],v=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!u)return null!=this._boundTexturesCache[z]&&(this._activeChannel=z,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(u.video){this._activeChannel=z;const U=u.getInternalTexture();U&&(U._associatedChannel=z),u.update()}else if(4===u.delayLoadState)return u.delayLoad(),!1;U=v?u.depthStencilTexture:u.isReady()?u.getInternalTexture():u.isCube?this.emptyCubeTexture:u.is3D?this.emptyTexture3D:u.is2DArray?this.emptyTexture2DArray:this.emptyTexture,!J&&U&&(U._associatedChannel=z);let f=!0;this._boundTexturesCache[z]===U&&(J||this._bindSamplerUniformToChannel(U._associatedChannel,z),f=!1),this._activeChannel=z;const g=this._getTextureTarget(U);if(f&&this._bindTextureDirectly(g,U,J),U&&!U.isMultiview){if(U.isCube&&U._cachedCoordinatesMode!==u.coordinatesMode){U._cachedCoordinatesMode=u.coordinatesMode;const z=3!==u.coordinatesMode&&5!==u.coordinatesMode?1:0;u.wrapU=z,u.wrapV=z}U._cachedWrapU!==u.wrapU&&(U._cachedWrapU=u.wrapU,this._setTextureParameterInteger(g,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(u.wrapU),U)),U._cachedWrapV!==u.wrapV&&(U._cachedWrapV=u.wrapV,this._setTextureParameterInteger(g,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(u.wrapV),U)),U.is3D&&U._cachedWrapR!==u.wrapR&&(U._cachedWrapR=u.wrapR,this._setTextureParameterInteger(g,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(u.wrapR),U)),this._setAnisotropicLevel(g,U,u.anisotropicFilteringLevel)}return!0}setTextureArray(z,u,U,J){if(void 0!==z&&u){this._textureUnits&&this._textureUnits.length===U.length||(this._textureUnits=new Int32Array(U.length));for(let u=0;u<U.length;u++){const J=U[u].getInternalTexture();J?(this._textureUnits[u]=z+u,J._associatedChannel=z+u):this._textureUnits[u]=-1}this._gl.uniform1iv(u,this._textureUnits);for(let z=0;z<U.length;z++)this._setTexture(this._textureUnits[z],U[z],!0)}}_setAnisotropicLevel(z,u,U){const J=this._caps.textureAnisotropicFilterExtension;11!==u.samplingMode&&3!==u.samplingMode&&2!==u.samplingMode&&(U=1),J&&u._cachedAnisotropicFilteringLevel!==U&&(this._setTextureParameterFloat(z,J.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(U,this._caps.maxAnisotropy),u),u._cachedAnisotropicFilteringLevel=U)}_setTextureParameterFloat(z,u,U,J){this._bindTextureDirectly(z,J,!0,!0),this._gl.texParameterf(z,u,U)}_setTextureParameterInteger(z,u,U,J){J&&this._bindTextureDirectly(z,J,!0,!0),this._gl.texParameteri(z,u,U)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let z=0;z<this._caps.maxVertexAttribs;z++)this.disableAttributeByIndex(z)}else for(let z=0,u=this._vertexAttribArraysEnabled.length;z<u;z++)z>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[z]||this.disableAttributeByIndex(z)}releaseEffects(){this._compiledEffects={},this.onReleaseEffectsObservable.notifyObservers(this)}dispose(){var z;((0,g.i)()&&this._renderingCanvas&&(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._onContextRestored&&this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),super.dispose(),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.unbindAllAttributes(),this._boundUniforms={},this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._currentProgram=null,this._creationOptions.loseContextOnDispose)&&(null===(z=this._gl.getExtension("WEBGL_lose_context"))||void 0===z||z.loseContext());(0,J.y)(this._gl)}attachContextLostEvent(z){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",z,!1)}attachContextRestoredEvent(z){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",z,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(z){const u=this._gl;for(;u.getError()!==u.NO_ERROR;);let U=!0;const J=u.createTexture();u.bindTexture(u.TEXTURE_2D,J),u.texImage2D(u.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(z),1,1,0,u.RGBA,this._getWebGLTextureType(z),null),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,u.NEAREST),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,u.NEAREST);const v=u.createFramebuffer();u.bindFramebuffer(u.FRAMEBUFFER,v),u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_2D,J,0);const f=u.checkFramebufferStatus(u.FRAMEBUFFER);if(U=U&&f===u.FRAMEBUFFER_COMPLETE,U=U&&u.getError()===u.NO_ERROR,U&&(u.clear(u.COLOR_BUFFER_BIT),U=U&&u.getError()===u.NO_ERROR),U){u.bindFramebuffer(u.FRAMEBUFFER,null);const z=u.RGBA,J=u.UNSIGNED_BYTE,v=new Uint8Array(4);u.readPixels(0,0,1,1,z,J,v),U=U&&u.getError()===u.NO_ERROR}for(u.deleteTexture(J),u.deleteFramebuffer(v),u.bindFramebuffer(u.FRAMEBUFFER,null);!U&&u.getError()!==u.NO_ERROR;);return U}_getWebGLTextureType(z){if(1===this._webGLVersion){switch(z){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(z){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(z){let u=arguments.length>1&&void 0!==arguments[1]&&arguments[1],U=u?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;switch(z){case 0:U=this._gl.ALPHA;break;case 1:U=this._gl.LUMINANCE;break;case 2:U=this._gl.LUMINANCE_ALPHA;break;case 6:case 33322:case 36760:U=this._gl.RED;break;case 7:case 33324:case 36761:U=this._gl.RG;break;case 4:case 32852:case 36762:U=u?this._glSRGBExtensionValues.SRGB:this._gl.RGB;break;case 5:case 32859:case 36763:U=u?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA}if(this._webGLVersion>1)switch(z){case 8:U=this._gl.RED_INTEGER;break;case 9:U=this._gl.RG_INTEGER;break;case 10:U=this._gl.RGB_INTEGER;break;case 11:U=this._gl.RGBA_INTEGER}return U}_getRGBABufferInternalSizedFormat(z,u){let U=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(1===this._webGLVersion){if(void 0!==u)switch(u){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return U?this._glSRGBExtensionValues.SRGB:this._gl.RGB}return this._gl.RGBA}switch(z){case 3:switch(u){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(u){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return U?this._glSRGBExtensionValues.SRGB8:this._gl.RGB8;case 5:return U?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(u){case 8:return this._gl.R16I;case 36760:return this._gl.R16_SNORM_EXT;case 36761:return this._gl.RG16_SNORM_EXT;case 36762:return this._gl.RGB16_SNORM_EXT;case 36763:return this._gl.RGBA16_SNORM_EXT;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;default:return this._gl.RGBA16I}case 5:switch(u){case 8:return this._gl.R16UI;case 33322:return this._gl.R16_EXT;case 33324:return this._gl.RG16_EXT;case 32852:return this._gl.RGB16_EXT;case 32859:return this._gl.RGBA16_EXT;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;default:return this._gl.RGBA16UI}case 6:switch(u){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;default:return this._gl.RGBA32I}case 7:switch(u){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;default:return this._gl.RGBA32UI}case 1:switch(u){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;default:return this._gl.RGBA32F}case 2:switch(u){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(u){case 5:default:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI}}return U?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8}readPixels(z,u,U,J){let v=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],g=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],w=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;const P=v?4:3,R=v?this._gl.RGBA:this._gl.RGB,S=U*J*P;if(w){if(w.length<S)return f.d.Error("Data buffer is too small to store the read pixels (".concat(w.length," should be more than ").concat(S,")")),Promise.resolve(w)}else w=new Uint8Array(S);return g&&this.flushFramebuffer(),this._gl.readPixels(z,u,U,J,R,this._gl.UNSIGNED_BYTE,w),Promise.resolve(w)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(null!==this._HasMajorPerformanceCaveat)return!this._HasMajorPerformanceCaveat;if(null===this._IsSupported)try{const z=mz.b._CreateCanvas(1,1),u=z.getContext("webgl")||z.getContext("experimental-webgl");this._IsSupported=null!=u&&!!window.WebGLRenderingContext}catch(z){this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(null===this._HasMajorPerformanceCaveat)try{const z=mz.b._CreateCanvas(1,1),u=z.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||z.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!u}catch(z){this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}}X._TempClearColorUint32=new Uint32Array(4),X._TempClearColorInt32=new Int32Array(4),X.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/12\\d\\..+?Mobile",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}],X._ConcatenateShader=C.f,X._IsSupported=null,X._HasMajorPerformanceCaveat=null},12986:(z,u,U)=>{U.d(u,{c:()=>A});var J=U(12756),v=U(12914),f=U(12894),g=U(12994),w=U(12882),P=U(12829),R=U(12760),S=U(21),d=U(13008),mz=U(12926);class Z{get renderList(){return this._renderList}set renderList(z){this._renderList!==z&&(this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),z&&(this._unObserveRenderList=(0,mz.m)(z,this._renderListHasChanged)),this._renderList=z)}get disableImageProcessing(){return this._disableImageProcessing}set disableImageProcessing(z){z!==this._disableImageProcessing&&(this._disableImageProcessing=z,this._scene.markAllMaterialsAsDirty(64))}get name(){return this._name}set name(z){if(this._name===z)return;if(this._name=z,!this._scene)return;const u=this._scene.getEngine();for(let U=0;U<this._renderPassIds.length;++U){const z=this._renderPassIds[U];u._renderPassNames[z]="".concat(this._name,"#").concat(U)}}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}setMaterialForRendering(z,u){let U;U=Array.isArray(z)?z:[z];for(let J=0;J<U.length;++J)for(let z=0;z<this.options.numPasses;++z){let v=U[J];U[J].isAnInstance&&(v=U[J].sourceMesh),v.setMaterialForRenderPass(this._renderPassIds[z],void 0!==u?Array.isArray(u)?u[z]:u:void 0)}}constructor(z,u,U){this._unObserveRenderList=null,this._renderListHasChanged=(z,u)=>{const U=this._renderList?this._renderList.length:0;if(0===u&&U>0||0===U)for(const J of this._scene.meshes)J._markSubMeshesAsLightDirty()},this.particleSystemList=null,this.getCustomRenderList=null,this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this._disableImageProcessing=!1,this.onBeforeRenderObservable=new J.e,this.onAfterRenderObservable=new J.e,this.onBeforeRenderingManagerRenderObservable=new J.e,this.onAfterRenderingManagerRenderObservable=new J.e,this.onFastPathRenderObservable=new J.e,this._currentRefreshId=-1,this._refreshRate=1,this._currentApplyByPostProcessSetting=!1,this._currentSceneCamera=null,this.name=z,this._scene=u,this.renderList=[],this._renderPassIds=[],this.options=(0,S.e)({numPasses:1,doNotChangeAspectRatio:!0},U),this._createRenderPassId(),this.renderPassId=this._renderPassIds[0],this._renderingManager=new d.d(u),this._renderingManager._useSceneAutoClearSetup=!0}_releaseRenderPassId(){const z=this._scene.getEngine();for(let u=0;u<this.options.numPasses;++u)z.releaseRenderPassId(this._renderPassIds[u]);this._renderPassIds.length=0}_createRenderPassId(){this._releaseRenderPassId();const z=this._scene.getEngine();for(let u=0;u<this.options.numPasses;++u)this._renderPassIds[u]=z.createRenderPassId("".concat(this.name,"#").concat(u))}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(z){this._refreshRate=z,this.resetRefreshCounter()}shouldRender(){return-1===this._currentRefreshId||this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}isReadyForRendering(z,u){this.prepareRenderList(),this.initRender(z,u);const U=this._checkReadiness();return this.finishRender(),U}prepareRenderList(){const z=this._scene;if(this._waitingRenderList){if(!this.renderListPredicate){this.renderList=[];for(let u=0;u<this._waitingRenderList.length;u++){const U=this._waitingRenderList[u],J=z.getMeshById(U);J&&this.renderList.push(J)}}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const z=this._scene.meshes;for(let u=0;u<z.length;u++){const U=z[u];this.renderListPredicate(U)&&this.renderList.push(U)}}this._currentApplyByPostProcessSetting=this._scene.imageProcessingConfiguration.applyByPostProcess,this._disableImageProcessing&&(this._scene.imageProcessingConfiguration._applyByPostProcess=this._disableImageProcessing)}initRender(z,u){var U;const J=this._scene.getEngine(),v=null!==(U=this.activeCamera)&&void 0!==U?U:this._scene.activeCamera;this._currentSceneCamera=this._scene.activeCamera,v&&(v!==this._scene.activeCamera&&(this._scene.setTransformMatrix(v.getViewMatrix(),v.getProjectionMatrix(!0)),this._scene.activeCamera=v),J.setViewport(v.rigParent?v.rigParent.viewport:v.viewport,z,u)),this._defaultRenderListPrepared=!1}finishRender(){const z=this._scene;this._disableImageProcessing&&(z.imageProcessingConfiguration._applyByPostProcess=this._currentApplyByPostProcessSetting),z.activeCamera=this._currentSceneCamera,this._currentSceneCamera&&(this.activeCamera&&this.activeCamera!==z.activeCamera&&z.setTransformMatrix(this._currentSceneCamera.getViewMatrix(),this._currentSceneCamera.getProjectionMatrix(!0)),z.getEngine().setViewport(this._currentSceneCamera.viewport)),z.resetCachedMaterial()}render(){let z=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,u=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const U=this._scene,J=U.getEngine(),v=J.currentRenderPassId;J.currentRenderPassId=this._renderPassIds[z],this.onBeforeRenderObservable.notifyObservers(z);if(J.snapshotRendering&&1===J.snapshotRenderingMode)this.onFastPathRenderObservable.notifyObservers(z);else{let u=null;const J=this.renderList?this.renderList:U.getActiveMeshes().data,v=this.renderList?this.renderList.length:U.getActiveMeshes().length;this.getCustomRenderList&&(u=this.getCustomRenderList(z,J,v)),u?this._prepareRenderingManager(u,u.length,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(J,v,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),u=J),this.onBeforeRenderingManagerRenderObservable.notifyObservers(z),this._renderingManager.render(this.customRenderFunction,u,this.renderParticles,this.renderSprites),this.onAfterRenderingManagerRenderObservable.notifyObservers(z)}u||this.onAfterRenderObservable.notifyObservers(z),J.currentRenderPassId=v}_checkReadiness(){const z=this._scene,u=z.getEngine(),U=u.currentRenderPassId;let J=!0;z.getViewMatrix()||z.updateTransformMatrix();const v=this.options.numPasses;for(let g=0;g<v&&J;g++){let U=null;const f=this.renderList?this.renderList:z.getActiveMeshes().data,w=this.renderList?this.renderList.length:z.getActiveMeshes().length;u.currentRenderPassId=this._renderPassIds[g],this.onBeforeRenderObservable.notifyObservers(g),this.getCustomRenderList&&(U=this.getCustomRenderList(g,f,w)),U||(U=f),this.options.doNotChangeAspectRatio||z.updateTransformMatrix(!0);for(let z=0;z<U.length&&J;++z){const u=U[z];if(u.isEnabled()&&!u.isBlocked&&u.isVisible&&u.cf)if(this.customIsReadyFunction){if(!this.customIsReadyFunction(u,this.refreshRate,!0)){J=!1;continue}}else if(!u.isReady(!0)){J=!1;continue}}this.onAfterRenderObservable.notifyObservers(g),v>1&&(z.incrementRenderId(),z.resetCachedMaterial())}const f=this.particleSystemList||z.mA;for(const g of f)g.isReady()||(J=!1);return u.currentRenderPassId=U,J}_prepareRenderingManager(z,u,U){var J;const v=this._scene,f=v.activeCamera,g=null!==(J=this.cameraForLOD)&&void 0!==J?J:f;this._renderingManager.reset();const w=v.getRenderId(),P=v.getFrameId();for(let S=0;S<u;S++){const u=z[S];if(u&&!u.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(u,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!u.isReady(0===this.refreshRate)){this.resetRefreshCounter();continue}let z,J=null;if(g){const z=u._internalAbstractMeshDataInfo._currentLOD.get(g);z&&z[1]===P?J=z[0]:(J=v.customLODSelector?v.customLODSelector(u,g):u.getLOD(g),z?(z[0]=J,z[1]=P):u._internalAbstractMeshDataInfo._currentLOD.set(g,[J,P]))}else J=u;if(!J)continue;if(J!==u&&0!==J.billboardMode&&J.af(),J._preActivateForIntermediateRendering(w),z=!(!U||!f)&&0===(u.layerMask&f.layerMask),u.isEnabled()&&u.isVisible&&u.cf&&!z){if(J!==u&&J._activate(w,!0),u._activate(w,!0)&&u.cf.length){u.isAnInstance?u._internalAbstractMeshDataInfo._actAsRegularMesh&&(J=u):J._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,J._internalAbstractMeshDataInfo._isActiveIntermediate=!0,v._prepareSkeleton(J);for(let z=0;z<J.cf.length;z++){const u=J.cf[z];this._renderingManager.dispatch(u,J)}}u._postActivate()}}}const R=this.particleSystemList||v.mA;for(let S=0;S<R.length;S++){const z=R[S],u=z.vu;z.isStarted()&&u&&(!u.position||u.isEnabled())&&this._renderingManager.dispatchParticles(z)}}setRenderingOrder(z){let u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,U=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this._renderingManager.setRenderingOrder(z,u,U,J)}setRenderingAutoClearDepthStencil(z,u){let U=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],J=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];this._renderingManager.setRenderingAutoClearDepthStencil(z,u,U,J),this._renderingManager._useSceneAutoClearSetup=!1}clone(){const z=new Z(this.name,this._scene,this.options);return this.renderList&&(z.renderList=this.renderList.slice(0)),z}dispose(){const z=this.renderList?this.renderList:this._scene.getActiveMeshes().data,u=this.renderList?this.renderList.length:this._scene.getActiveMeshes().length;for(let U=0;U<u;U++){const u=z[U];u&&void 0!==u.getMaterialForRenderPass(this.renderPassId)&&u.setMaterialForRenderPass(this.renderPassId,void 0)}this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderingManagerRenderObservable.clear(),this.onAfterRenderingManagerRenderObservable.clear(),this.onFastPathRenderObservable.clear(),this._releaseRenderPassId(),this.renderList=null}_rebuild(){this.refreshRate===Z.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=Z.REFRESHRATE_RENDER_ONCE)}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}}Z.REFRESHRATE_RENDER_ONCE=0,Z.REFRESHRATE_RENDER_ONEVERYFRAME=1,Z.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,P.Effect.prototype.setDepthStencilTexture=function(z,u){this._engine.setDepthStencilTexture(this._samplers[z],this._uniforms[z],u,z)};class A extends f.e{get renderListPredicate(){return this._objectRenderer.renderListPredicate}set renderListPredicate(z){this._objectRenderer.renderListPredicate=z}get renderList(){return this._objectRenderer.renderList}set renderList(z){this._objectRenderer.renderList=z}get particleSystemList(){return this._objectRenderer.particleSystemList}set particleSystemList(z){this._objectRenderer.particleSystemList=z}get getCustomRenderList(){return this._objectRenderer.getCustomRenderList}set getCustomRenderList(z){this._objectRenderer.getCustomRenderList=z}get renderParticles(){return this._objectRenderer.renderParticles}set renderParticles(z){this._objectRenderer.renderParticles=z}get renderSprites(){return this._objectRenderer.renderSprites}set renderSprites(z){this._objectRenderer.renderSprites=z}get forceLayerMaskCheck(){return this._objectRenderer.forceLayerMaskCheck}set forceLayerMaskCheck(z){this._objectRenderer.forceLayerMaskCheck=z}get activeCamera(){return this._objectRenderer.activeCamera}set activeCamera(z){this._objectRenderer.activeCamera=z}get cameraForLOD(){return this._objectRenderer.cameraForLOD}set cameraForLOD(z){this._objectRenderer.cameraForLOD=z}get disableImageProcessing(){return this._objectRenderer.disableImageProcessing}set disableImageProcessing(z){this._objectRenderer.disableImageProcessing=z}get customIsReadyFunction(){return this._objectRenderer.customIsReadyFunction}set customIsReadyFunction(z){this._objectRenderer.customIsReadyFunction=z}get customRenderFunction(){return this._objectRenderer.customRenderFunction}set customRenderFunction(z){this._objectRenderer.customRenderFunction=z}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(z){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(z)}get onBeforeRenderObservable(){return this._objectRenderer.onBeforeRenderObservable}set onBeforeRender(z){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(z)}get onAfterRenderObservable(){return this._objectRenderer.onAfterRenderObservable}set onAfterRender(z){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(z)}set onClear(z){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(z)}get _waitingRenderList(){return this._objectRenderer._waitingRenderList}set _waitingRenderList(z){this._objectRenderer._waitingRenderList=z}get renderPassId(){return this._objectRenderer.renderPassId}get renderPassIds(){return this._objectRenderer.renderPassIds}get currentRefreshId(){return this._objectRenderer.currentRefreshId}setMaterialForRendering(z,u){this._objectRenderer.setMaterialForRendering(z,u)}get isMulti(){var z,u;return null!==(z=null===(u=this._renderTarget)||void 0===u?void 0:u.isMulti)&&void 0!==z&&z}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(z){if(this._boundingBoxSize&&this._boundingBoxSize.equals(z))return;this._boundingBoxSize=z;const u=this.Vz();u&&u.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){var z,u;return null!==(z=null===(u=this._renderTarget)||void 0===u?void 0:u._depthStencilTexture)&&void 0!==z?z:null}constructor(z,u,U){var g,w;let P,S,d=arguments.length>3&&void 0!==arguments[3]&&arguments[3],mz=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],A=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,E=arguments.length>6&&void 0!==arguments[6]&&arguments[6],C=arguments.length>7&&void 0!==arguments[7]?arguments[7]:f.e.TRILINEAR_SAMPLINGMODE,r=!(arguments.length>8&&void 0!==arguments[8])||arguments[8],M=arguments.length>9&&void 0!==arguments[9]&&arguments[9],T=arguments.length>10&&void 0!==arguments[10]&&arguments[10],X=arguments.length>11&&void 0!==arguments[11]?arguments[11]:5,h=arguments.length>12&&void 0!==arguments[12]&&arguments[12],t=arguments.length>13?arguments[13]:void 0,V=arguments.length>14?arguments[14]:void 0,L=arguments.length>15&&void 0!==arguments[15]&&arguments[15],O=arguments.length>16&&void 0!==arguments[16]&&arguments[16],x=!0;if("object"===typeof d){var Q,K,Y,p,N,D;const z=d;d=!!z.generateMipMaps,mz=null===(Q=z.doNotChangeAspectRatio)||void 0===Q||Q,A=null!==(K=z.type)&&void 0!==K?K:0,E=!!z.isCube,C=null!==(Y=z.samplingMode)&&void 0!==Y?Y:f.e.TRILINEAR_SAMPLINGMODE,r=null===(p=z.generateDepthBuffer)||void 0===p||p,M=!!z.generateStencilBuffer,T=!!z.isMulti,X=null!==(N=z.format)&&void 0!==N?N:5,h=!!z.delayAllocation,t=z.samples,V=z.creationFlags,L=!!z.noColorAttachment,O=!!z.useSRGBBuffer,P=z.colorAttachment,x=null!==(D=z.gammaSpace)&&void 0!==D?D:x,S=z.existingObjectRenderer}if(super(null,U,!d,void 0,C,void 0,void 0,void 0,void 0,X),this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new J.e,this.onAfterUnbindObservable=new J.e,this.onClearObservable=new J.e,this.onResizeObservable=new J.e,this._cleared=!1,this.skipInitialClear=!1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this._dontDisposeObjectRenderer=!1,this.boundingBoxPosition=v.Eu.Zero(),this._disableEngineStages=!1,this._dumpToolsLoading=!1,!(U=this.Vz()))return;const c=this.Vz().getEngine();this._gammaSpace=x,this._coordinatesMode=f.e.PROJECTION_MODE,this.name=z,this.isRenderTarget=!0,this._initialSizeParameter=u,this._dontDisposeObjectRenderer=!!S,this._processSizeParameter(u),this._objectRenderer=null!==(g=S)&&void 0!==g?g:new Z(z,U,{numPasses:E?6:this.getRenderLayers()||1,doNotChangeAspectRatio:mz}),this._onBeforeRenderingManagerRenderObserver=this._objectRenderer.onBeforeRenderingManagerRenderObservable.add((()=>{if(!this._disableEngineStages)for(const z of this._scene._beforeRenderTargetClearStage)z.action(this,this._currentFaceIndex,this._currentLayer);if(this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(c):this.skipInitialClear||c.clear(this.clearColor||this._scene.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),!this._disableEngineStages)for(const z of this._scene._beforeRenderTargetDrawStage)z.action(this,this._currentFaceIndex,this._currentLayer)})),this._onAfterRenderingManagerRenderObserver=this._objectRenderer.onAfterRenderingManagerRenderObservable.add((()=>{var z,u;if(!this._disableEngineStages)for(const f of this._scene._afterRenderTargetDrawStage)f.action(this,this._currentFaceIndex,this._currentLayer);const U=null!==(z=null===(u=this._texture)||void 0===u?void 0:u.generateMipMaps)&&void 0!==z&&z;var J;if(this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager)this._postProcessManager._finalizeFrame(!1,null!==(J=this._renderTarget)&&void 0!==J?J:void 0,this._currentFaceIndex,this._postProcesses,this.ignoreCameraViewport);else if(this._currentUseCameraPostProcess){var v;this._scene.postProcessManager._finalizeFrame(!1,null!==(v=this._renderTarget)&&void 0!==v?v:void 0,this._currentFaceIndex)}if(!this._disableEngineStages)for(const f of this._scene._afterRenderTargetPostProcessStage)f.action(this,this._currentFaceIndex,this._currentLayer);this._texture&&(this._texture.generateMipMaps=U),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),this._currentDumpForDebug&&(this._dumpTools?this._dumpTools.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),c):R.d.Error("dumpTools module is still being loaded. To speed up the process import dump tools directly in your project"))})),this._onFastPathRenderObserver=this._objectRenderer.onFastPathRenderObservable.add((()=>{this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(c):this.skipInitialClear||c.clear(this.clearColor||this._scene.clearColor,!0,!0,!0)})),this._resizeObserver=c.onResizeObservable.add((()=>{})),this._generateMipMaps=!!d,this._doNotChangeAspectRatio=mz,T||(this._renderTargetOptions={generateMipMaps:d,type:A,format:null!==(w=this._format)&&void 0!==w?w:void 0,samplingMode:this.samplingMode,generateDepthBuffer:r,generateStencilBuffer:M,samples:t,creationFlags:V,noColorAttachment:L,useSRGBBuffer:O,colorAttachment:P,label:this.name},this.samplingMode===f.e.NEAREST_SAMPLINGMODE&&(this.wrapU=f.e.CLAMP_ADDRESSMODE,this.wrapV=f.e.CLAMP_ADDRESSMODE),h||(E?(this._renderTarget=U.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=f.e.INVCUBIC_MODE,this._textureMatrix=v.Matrix.Identity()):this._renderTarget=U.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==t&&(this.samples=t)))}createDepthStencilTexture(){var z;let u=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,U=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],J=arguments.length>2&&void 0!==arguments[2]&&arguments[2],v=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,f=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14,g=arguments.length>5?arguments[5]:void 0;null===(z=this._renderTarget)||void 0===z||z.createDepthStencilTexture(u,U,J,v,f,g)}_processSizeParameter(z){if(z.ratio){this._sizeRatio=z.ratio;const u=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(u.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(u.getRenderHeight(),this._sizeRatio)}}else this._size=z}get samples(){var z,u;return null!==(z=null===(u=this._renderTarget)||void 0===u?void 0:u.samples)&&void 0!==z?z:this._samples}set samples(z){this._renderTarget&&(this._samples=this._renderTarget.setSamples(z))}addPostProcess(z){if(!this._postProcessManager){const z=this.Vz();if(!z)return;this._postProcessManager=new g.c(z),this._postProcesses=new Array}this._postProcesses.push(z),this._postProcesses[0].Df=!1}clearPostProcesses(){let z=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._postProcesses){if(z)for(const z of this._postProcesses)z.dispose();this._postProcesses=[]}}removePostProcess(z){if(!this._postProcesses)return;const u=this._postProcesses.indexOf(z);-1!==u&&(this._postProcesses.splice(u,1),this._postProcesses.length>0&&(this._postProcesses[0].Df=!1))}resetRefreshCounter(){this._objectRenderer.resetRefreshCounter()}get refreshRate(){return this._objectRenderer.refreshRate}set refreshRate(z){this._objectRenderer.refreshRate=z}_shouldRender(){return this._objectRenderer.shouldRender()}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){const z=this._size.layers;if(z)return z;const u=this._size.depth;return u||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(z){const u=Math.max(1,this.getRenderSize()*z);this.resize(u)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(z){var u;const U=this.isCube;null===(u=this._renderTarget)||void 0===u||u.dispose(),this._renderTarget=null;const J=this.Vz();J&&(this._processSizeParameter(z),this._renderTarget=U?J.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):J.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==this._renderTargetOptions.samples&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(){let z=arguments.length>0&&void 0!==arguments[0]&&arguments[0],u=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._render(z,u)}isReadyForRendering(){this._dumpToolsLoading||(this._dumpToolsLoading=!0,U.e(20).then(U.bind(U,13144)).then((z=>this._dumpTools=z))),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight());const z=this._objectRenderer._checkReadiness();return this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender(),z}_render(){let z=arguments.length>0&&void 0!==arguments[0]&&arguments[0],u=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const U=this.Vz();if(U){if(void 0!==this.useCameraPostProcesses&&(z=this.useCameraPostProcesses),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight()),!this.is2DArray&&!this.is3D||this.isMulti)if(this.isCube&&!this.isMulti)for(let J=0;J<6;J++)this._renderToTarget(J,z,u),U.incrementRenderId(),U.resetCachedMaterial();else this._renderToTarget(0,z,u);else for(let J=0;J<this.getRenderLayers();J++)this._renderToTarget(0,z,u,J),U.incrementRenderId(),U.resetCachedMaterial();this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender()}}_bestReflectionRenderTargetDimension(z,u){const U=z*u,J=(0,w.l)(U+16384/(128+U));return Math.min((0,w.b)(z),J)}_bindFrameBuffer(){let z=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const U=this.Vz();if(!U)return;const J=U.getEngine();this._renderTarget&&J.bindFramebuffer(this._renderTarget,this.isCube?z:void 0,void 0,void 0,this.ignoreCameraViewport,0,u)}_unbindFrameBuffer(z,u){this._renderTarget&&z.unBindFramebuffer(this._renderTarget,this.isCube,(()=>{this.onAfterRenderObservable.notifyObservers(u)}))}_prepareFrame(z,u,U,J){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses)||this._bindFrameBuffer(u,U):J&&z.postProcessManager._prepareFrame(this._texture)||this._bindFrameBuffer(u,U)}_renderToTarget(z,u,U){var J,v;let f=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const g=this.Vz();if(!g)return;const w=g.getEngine();this._currentFaceIndex=z,this._currentLayer=f,this._currentUseCameraPostProcess=u,this._currentDumpForDebug=U,this._prepareFrame(g,z,f,u),null===(J=w._debugPushGroup)||void 0===J||J.call(w,"render to face #".concat(z," layer #").concat(f),2),this._objectRenderer.render(z+f,!0),null===(v=w._debugPopGroup)||void 0===v||v.call(w,2),this._unbindFrameBuffer(w,z),this._texture&&this.isCube&&5===z&&w.generateMipMapsForCubemap(this._texture,!0)}setRenderingOrder(z){let u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,U=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this._objectRenderer.setRenderingOrder(z,u,U,J)}setRenderingAutoClearDepthStencil(z,u){this._objectRenderer.setRenderingAutoClearDepthStencil(z,u)}clone(){const z=this.getSize(),u=new A(this.name,z,this.Vz(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return u.kf=this.kf,u.level=this.level,u.coordinatesMode=this.coordinatesMode,this.renderList&&(u.renderList=this.renderList.slice(0)),u}serialize(){if(!this.name)return null;const z=super.serialize();if(z.renderTargetSize=this.getRenderSize(),z.renderList=[],this.renderList)for(let u=0;u<this.renderList.length;u++)z.renderList.push(this.renderList[u].id);return z}disposeFramebufferObjects(){var z;null===(z=this._renderTarget)||void 0===z||z.dispose(!0)}releaseInternalTexture(){var z;null===(z=this._renderTarget)||void 0===z||z.releaseTextures(),this._texture=null}dispose(){var z;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._objectRenderer.onBeforeRenderingManagerRenderObservable.remove(this._onBeforeRenderingManagerRenderObserver),this._objectRenderer.onAfterRenderingManagerRenderObservable.remove(this._onAfterRenderingManagerRenderObserver),this._objectRenderer.onFastPathRenderObservable.remove(this._onFastPathRenderObserver),this._dontDisposeObjectRenderer||this._objectRenderer.dispose(),this.clearPostProcesses(!0),this._resizeObserver&&(this.Vz().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null);const u=this.Vz();if(!u)return;let U=u.customRenderTargets.indexOf(this);U>=0&&u.customRenderTargets.splice(U,1);for(const J of u.cameras)U=J.customRenderTargets.indexOf(this),U>=0&&J.customRenderTargets.splice(U,1);null===(z=this._renderTarget)||void 0===z||z.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this._objectRenderer._rebuild(),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._objectRenderer.freeRenderingGroups()}getViewCount(){return 1}}A.REFRESHRATE_RENDER_ONCE=Z.REFRESHRATE_RENDER_ONCE,A.REFRESHRATE_RENDER_ONEVERYFRAME=Z.REFRESHRATE_RENDER_ONEVERYFRAME,A.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=Z.REFRESHRATE_RENDER_ONEVERYTWOFRAMES,f.e._CreateRenderTargetTexture=(z,u,U,J,v)=>new A(z,u,U,J)},13083:(z,u,U)=>{function J(z){return 13===z||14===z||15===z||16===z||17===z||18===z||19===z}function v(z){return 13===z||17===z||18===z||19===z}U.d(u,{c:()=>v,f:()=>J})},13063:(z,u,U)=>{function J(z){return void 0===z.getPipelineContext}U.d(u,{c:()=>J})},13023:(z,u,U)=>{U.d(u,{b:()=>S,e:()=>d});var J=U(21),v=U(13e3),f=U(13027),g=U(12756),w=U(12829),P=U(13035);U(13044);const R={Oz:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class S{constructor(z){var u,U;let J=arguments.length>1&&void 0!==arguments[1]?arguments[1]:R;this._fullscreenViewport=new f.d(0,0,1,1);const g=null!==(u=J.Oz)&&void 0!==u?u:R.Oz,w=null!==(U=J.indices)&&void 0!==U?U:R.indices;this.Au=z,this._vertexBuffers={[v.g.PositionKind]:new v.g(z,g,v.g.PositionKind,!1,!1,2)},this._indexBuffer=z.createIndexBuffer(w),this._indexBufferLength=w.length,this._onContextRestoredObserver=z.onContextRestoredObservable.add((()=>{this._indexBuffer=z.createIndexBuffer(w);for(const z in this._vertexBuffers){this._vertexBuffers[z]._rebuild()}}))}setViewport(){let z=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._fullscreenViewport;this.Au.setViewport(z)}bindBuffers(z){this.Au.bindBuffers(this._vertexBuffers,this._indexBuffer,z)}applyEffectWrapper(z){this.Au.setState(!0),this.Au.depthCullingState.depthTest=!1,this.Au.stencilState.stencilTest=!1,this.Au.enableEffect(z.drawWrapper),this.bindBuffers(z.effect),z.onApplyObservable.notifyObservers({})}saveStates(){this._savedStateDepthTest=this.Au.depthCullingState.depthTest,this._savedStateStencilTest=this.Au.stencilState.stencilTest}restoreStates(){this.Au.depthCullingState.depthTest=this._savedStateDepthTest,this.Au.stencilState.stencilTest=this._savedStateStencilTest}draw(){this.Au.drawElementsType(0,0,this._indexBufferLength)}_isRenderTargetTexture(z){return void 0!==z.renderTarget}render(z){let u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!z.effect.isReady())return;this.saveStates(),this.setViewport();const U=null===u?null:this._isRenderTargetTexture(u)?u.renderTarget:u;U&&this.Au.bindFramebuffer(U),this.applyEffectWrapper(z),this.draw(),U&&this.Au.unBindFramebuffer(U),this.restoreStates()}dispose(){const z=this._vertexBuffers[v.g.PositionKind];z&&(z.dispose(),delete this._vertexBuffers[v.g.PositionKind]),this._indexBuffer&&this.Au._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.Au.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}}class d{static RegisterShaderCodeProcessing(z,u){u?d._CustomShaderCodeProcessing[null!==z&&void 0!==z?z:""]=u:delete d._CustomShaderCodeProcessing[null!==z&&void 0!==z?z:""]}static _GetShaderCodeProcessing(z){var u;return null!==(u=d._CustomShaderCodeProcessing[z])&&void 0!==u?u:d._CustomShaderCodeProcessing[""]}get name(){return this.options.name}set name(z){this.options.name=z}isReady(){var z,u;return null!==(z=null===(u=this._drawWrapper.effect)||void 0===u?void 0:u.isReady())&&void 0!==z&&z}get drawWrapper(){return this._drawWrapper}get effect(){return this._drawWrapper.effect}set effect(z){this._drawWrapper.effect=z}constructor(z){var u;this.alphaMode=0,this.onEffectCreatedObservable=new g.e(void 0,!0),this.onApplyObservable=new g.e,this._shadersLoaded=!1,this._webGPUReady=!1,this._importPromises=[],this.options=(0,J.e)((0,J.e)({},z),{},{name:z.name||"effectWrapper",Au:z.Au,uniforms:z.uniforms||z.uniformNames||[],uniformNames:void 0,samplers:z.samplers||z.samplerNames||[],samplerNames:void 0,attributeNames:z.attributeNames||["position"],uniformBuffers:z.uniformBuffers||[],defines:z.defines||"",useShaderStore:z.useShaderStore||!1,vertexUrl:z.vertexUrl||z.vertexShader||"postprocess",vertexShader:void 0,fragmentShader:z.fragmentShader||"pass",indexParameters:z.indexParameters,blockCompilation:z.blockCompilation||!1,shaderLanguage:z.shaderLanguage||0,onCompiled:z.onCompiled||void 0,extraInitializations:z.extraInitializations||void 0,extraInitializationsAsync:z.extraInitializationsAsync||void 0,useAsPostProcess:null!==(u=z.useAsPostProcess)&&void 0!==u&&u}),this.options.uniformNames=this.options.uniforms,this.options.samplerNames=this.options.samplers,this.options.vertexShader=this.options.vertexUrl,this.options.useAsPostProcess&&(-1===this.options.samplers.indexOf("textureSampler")&&this.options.samplers.push("textureSampler"),-1===this.options.uniforms.indexOf("scale")&&this.options.uniforms.push("scale")),z.vertexUrl||z.vertexShader?this._shaderPath={vertexSource:this.options.vertexShader}:(this.options.useAsPostProcess||(this.options.uniforms.push("scale"),this.onApplyObservable.add((()=>{this.effect.setFloat2("scale",1,1)}))),this._shaderPath={vertex:this.options.vertexShader}),this._shaderPath.fragmentSource=this.options.fragmentShader,this._shaderPath.spectorName=this.options.name,this.options.useShaderStore&&(this._shaderPath.fragment=this._shaderPath.fragmentSource,this._shaderPath.vertex||(this._shaderPath.vertex=this._shaderPath.vertexSource),delete this._shaderPath.fragmentSource,delete this._shaderPath.vertexSource),this.onApplyObservable.add((()=>{this.bind()})),this.options.useShaderStore||(this._onContextRestoredObserver=this.options.Au.onContextRestoredObservable.add((()=>{this.effect._pipelineContext=null,this.effect._prepareEffect()}))),this._drawWrapper=new P.d(this.options.Au),this._webGPUReady=1===this.options.shaderLanguage;const U=Array.isArray(this.options.defines)?this.options.defines.join("\n"):this.options.defines;this._postConstructor(this.options.blockCompilation,U,this.options.extraInitializations)}_gatherImports(){let z=arguments.length>0&&void 0!==arguments[0]&&arguments[0],u=arguments.length>1?arguments[1]:void 0;this.options.useAsPostProcess&&(z&&this._webGPUReady?u.push(Promise.all([U.e(53).then(U.bind(U,15039))])):u.push(Promise.all([Promise.resolve().then(U.bind(U,13044))])))}_postConstructor(z){let u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,U=arguments.length>2?arguments[2]:void 0,J=arguments.length>3?arguments[3]:void 0;this._importPromises.length=0,J&&this._importPromises.push(...J);const v=this.options.Au.isWebGPU&&!d.ForceGLSL;this._gatherImports(v,this._importPromises),void 0!==U&&U(v,this._importPromises),v&&this._webGPUReady&&(this.options.shaderLanguage=1),z||this.updateEffect(u)}updateEffect(){let z=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,U=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,J=arguments.length>3?arguments[3]:void 0,v=arguments.length>4?arguments[4]:void 0,f=arguments.length>5?arguments[5]:void 0,g=arguments.length>6?arguments[6]:void 0,P=arguments.length>7?arguments[7]:void 0;const R=d._GetShaderCodeProcessing(this.name);if(null!==R&&void 0!==R&&R.defineCustomBindings){var S,mz,Z,A;const J=null!==(S=null===(mz=u)||void 0===mz?void 0:mz.slice())&&void 0!==S?S:[];J.push(...this.options.uniforms);const v=null!==(Z=null===(A=U)||void 0===A?void 0:A.slice())&&void 0!==Z?Z:[];v.push(...this.options.samplers),z=R.defineCustomBindings(this.name,z,J,v),u=J,U=v}this.options.defines=z||"";const E=this._shadersLoaded||0===this._importPromises.length?void 0:async()=>{await Promise.all(this._importPromises),this._shadersLoaded=!0};let C;C=this.options.extraInitializationsAsync?async()=>{null===E||void 0===E||E(),await this.options.extraInitializationsAsync()}:E,this.options.useShaderStore?this._drawWrapper.effect=this.options.Au.createEffect({vertex:null!==g&&void 0!==g?g:this._shaderPath.vertex,fragment:null!==P&&void 0!==P?P:this._shaderPath.fragment},{attributes:this.options.attributeNames,uniformsNames:u||this.options.uniforms,uniformBuffersNames:this.options.uniformBuffers,samplers:U||this.options.samplers,defines:null!==z?z:"",fallbacks:null,onCompiled:null!==v&&void 0!==v?v:this.options.onCompiled,onError:null!==f&&void 0!==f?f:null,indexParameters:J||this.options.indexParameters,processCodeAfterIncludes:null!==R&&void 0!==R&&R.processCodeAfterIncludes?(z,u)=>R.processCodeAfterIncludes(this.name,z,u):null,processFinalCode:null!==R&&void 0!==R&&R.processFinalCode?(z,u)=>R.processFinalCode(this.name,z,u):null,shaderLanguage:this.options.shaderLanguage,extraInitializationsAsync:C},this.options.Au):this._drawWrapper.effect=new w.Effect(this._shaderPath,this.options.attributeNames,u||this.options.uniforms,U||this.options.samplerNames,this.options.Au,z,void 0,v||this.options.onCompiled,void 0,void 0,void 0,this.options.shaderLanguage,C),this.onEffectCreatedObservable.notifyObservers(this._drawWrapper.effect)}bind(){var z,u;let U=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.options.useAsPostProcess&&!U&&(this.options.Au.setAlphaMode(this.alphaMode),this.drawWrapper.effect.setFloat2("scale",1,1)),null===(z=d._GetShaderCodeProcessing(this.name))||void 0===z||null===(u=z.bindCustomBindings)||void 0===u||u.call(z,this.name,this._drawWrapper.effect)}dispose(){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.onEffectCreatedObservable.clear(),this._drawWrapper.dispose(!0)}}d.ForceGLSL=!1,d._CustomShaderCodeProcessing={}},13126:(z,u,U)=>{U.d(u,{c:()=>g});var J,v,f=U(12914);!function(z){z[z.LOCAL=0]="LOCAL",z[z.WORLD=1]="WORLD",z[z.BONE=2]="BONE"}(J||(J={}));class g{}g.X=new f.Eu(1,0,0),g.Y=new f.Eu(0,1,0),g.Z=new f.Eu(0,0,1),function(z){z[z.X=0]="X",z[z.Y=1]="Y",z[z.Z=2]="Z"}(v||(v={}))},13123:(z,u,U)=>{U.d(u,{c:()=>J.Matrix,f:()=>J.Quaternion,g:()=>J.TmpVectors,h:()=>J.Eu});U(13126),U(12967),U(12917),U(13128),U(13132),U(12976),U(12948);var J=U(12914);U(13027)},13132:(z,u,U)=>{U.d(u,{c:()=>w,f:()=>mz,g:()=>S,h:()=>d});var J,v=U(12935),f=U(12914),g=U(12917);!function(z){z[z.CW=0]="CW",z[z.CCW=1]="CCW"}(J||(J={}));class w{static Interpolate(z,u,U,J,v){if(0===z)return 0;const f=1-3*J+3*u,g=3*J-6*u,w=3*u;let P=z;for(let R=0;R<5;R++){const u=P*P;P-=(f*(u*P)+g*u+w*P-z)*(1/(3*f*u+2*g*P+w)),P=Math.min(1,Math.max(0,P))}return 3*Math.pow(1-P,2)*P*U+3*(1-P)*Math.pow(P,2)*v+Math.pow(P,3)}}class P{constructor(z){this._radians=z,this._radians<0&&(this._radians+=2*Math.PI)}degrees(){return 180*this._radians/Math.PI}radians(){return this._radians}static BetweenTwoPoints(z,u){const U=u.Cu(z),J=Math.atan2(U.y,U.x);return new P(J)}static BetweenTwoVectors(z,u){let U=z.lengthSquared()*u.lengthSquared();if(0===U)return new P(Math.PI/2);U=Math.sqrt(U);let J=z.dot(u)/U;J=(0,v.Clamp)(J,-1,1);const f=Math.acos(J);return new P(f)}static FromRadians(z){return new P(z)}static FromDegrees(z){return new P(z*Math.PI/180)}}class R{constructor(z,u,U){this.startPoint=z,this.midPoint=u,this.endPoint=U;const J=Math.pow(u.x,2)+Math.pow(u.y,2),v=(Math.pow(z.x,2)+Math.pow(z.y,2)-J)/2,g=(J-Math.pow(U.x,2)-Math.pow(U.y,2))/2,w=(z.x-u.x)*(u.y-U.y)-(u.x-U.x)*(z.y-u.y);this.centerPoint=new f.Vector2((v*(u.y-U.y)-g*(z.y-u.y))/w,((z.x-u.x)*g-(u.x-U.x)*v)/w),this.radius=this.centerPoint.Cu(this.startPoint).length(),this.startAngle=P.BetweenTwoPoints(this.centerPoint,this.startPoint);const R=this.startAngle.degrees();let S=P.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),d=P.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();S-R>180&&(S-=360),S-R<-180&&(S+=360),d-S>180&&(d-=360),d-S<-180&&(d+=360),this.orientation=S-R<0?0:1,this.angle=P.FromDegrees(0===this.orientation?R-d:d-R)}}class S{constructor(z,u){this._points=new Array,this._length=0,this.closed=!1,this._points.push(new f.Vector2(z,u))}addLineTo(z,u){if(this.closed)return this;const U=new f.Vector2(z,u),J=this._points[this._points.length-1];return this._points.push(U),this._length+=U.Cu(J).length(),this}addArcTo(z,u,U,J){let v=arguments.length>4&&void 0!==arguments[4]?arguments[4]:36;if(this.closed)return this;const g=this._points[this._points.length-1],w=new f.Vector2(z,u),P=new f.Vector2(U,J),S=new R(g,w,P);let d=S.angle.radians()/v;0===S.orientation&&(d*=-1);let mz=S.startAngle.radians()+d;for(let f=0;f<v;f++){const z=Math.cos(mz)*S.radius+S.centerPoint.x,u=Math.sin(mz)*S.radius+S.centerPoint.y;this.addLineTo(z,u),mz+=d}return this}addQuadraticCurveTo(z,u,U,J){let v=arguments.length>4&&void 0!==arguments[4]?arguments[4]:36;if(this.closed)return this;const f=(z,u,U,J)=>(1-z)*(1-z)*u+2*z*(1-z)*U+z*z*J,g=this._points[this._points.length-1];for(let w=0;w<=v;w++){const P=w/v,R=f(P,g.x,z,U),S=f(P,g.y,u,J);this.addLineTo(R,S)}return this}addBezierCurveTo(z,u,U,J,v,f){let g=arguments.length>6&&void 0!==arguments[6]?arguments[6]:36;if(this.closed)return this;const w=(z,u,U,J,v)=>(1-z)*(1-z)*(1-z)*u+3*z*(1-z)*(1-z)*U+3*z*z*(1-z)*J+z*z*z*v,P=this._points[this._points.length-1];for(let R=0;R<=g;R++){const S=R/g,d=w(S,P.x,z,U,v),mz=w(S,P.y,u,J,f);this.addLineTo(d,mz)}return this}isPointInside(z){let u=!1;const U=this._points.length;for(let J=U-1,v=0;v<U;J=v++){let U=this._points[J],f=this._points[v],g=f.x-U.x,w=f.y-U.y;if(Math.abs(w)>Number.EPSILON){if(w<0&&(U=this._points[v],g=-g,f=this._points[J],w=-w),z.y<U.y||z.y>f.y)continue;if(z.y===U.y&&z.x===U.x)return!0;{const J=w*(z.x-U.x)-g*(z.y-U.y);if(0===J)return!0;if(J<0)continue;u=!u}}else{if(z.y!==U.y)continue;if(f.x<=z.x&&z.x<=U.x||U.x<=z.x&&z.x<=f.x)return!0}}return u}close(){return this.closed=!0,this}length(){let z=this._length;if(this.closed){const u=this._points[this._points.length-1];z+=this._points[0].Cu(u).length()}return z}area(){const z=this._points.length;let u=0;for(let U=z-1,J=0;J<z;U=J++)u+=this._points[U].x*this._points[J].y-this._points[J].x*this._points[U].y;return.5*u}getPoints(){return this._points}getPointAtLengthPosition(z){if(z<0||z>1)return f.Vector2.Zero();const u=z*this.length();let U=0;for(let J=0;J<this._points.length;J++){const z=(J+1)%this._points.length,v=this._points[J],g=this._points[z].Cu(v),w=g.length()+U;if(u>=U&&u<=w){const z=g.normalize(),J=u-U;return new f.Vector2(v.x+z.x*J,v.y+z.y*J)}U=w}return f.Vector2.Zero()}static StartingAt(z,u){return new S(z,u)}}class d{constructor(z){let u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,U=arguments.length>2?arguments[2]:void 0,J=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.path=z,this._curve=new Array,this._distances=new Array,this._tangents=new Array,this._normals=new Array,this._binormals=new Array,this._pointAtData={id:0,point:f.Eu.Zero(),previousPointArrayIndex:0,position:0,subPosition:0,interpolateReady:!1,interpolationMatrix:f.Matrix.Identity()};for(let v=0;v<z.length;v++)this._curve[v]=z[v].clone();this._raw=U||!1,this._alignTangentsWithPath=J,this._compute(u,J)}getCurve(){return this._curve}getPoints(){return this._curve}length(){return this._distances[this._distances.length-1]}getTangents(){return this._tangents}getNormals(){return this._normals}getBinormals(){return this._binormals}getDistances(){return this._distances}getPointAt(z){return this._updatePointAtData(z).point}getTangentAt(z){let u=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(z,u),u?f.Eu.TransformCoordinates(f.Eu.Forward(),this._pointAtData.interpolationMatrix):this._tangents[this._pointAtData.previousPointArrayIndex]}getNormalAt(z){let u=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(z,u),u?f.Eu.TransformCoordinates(f.Eu.Right(),this._pointAtData.interpolationMatrix):this._normals[this._pointAtData.previousPointArrayIndex]}getBinormalAt(z){let u=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(z,u),u?f.Eu.TransformCoordinates(f.Eu.UpReadOnly,this._pointAtData.interpolationMatrix):this._binormals[this._pointAtData.previousPointArrayIndex]}getDistanceAt(z){return this.length()*z}getPreviousPointIndexAt(z){return this._updatePointAtData(z),this._pointAtData.previousPointArrayIndex}getSubPositionAt(z){return this._updatePointAtData(z),this._pointAtData.subPosition}getClosestPositionTo(z){let u=Number.MAX_VALUE,U=0;for(let J=0;J<this._curve.length-1;J++){const v=this._curve[J+0],g=this._curve[J+1].Cu(v).normalize(),w=this._distances[J+1]-this._distances[J+0],P=Math.min(Math.max(f.Eu.Dot(g,z.Cu(v).normalize()),0)*f.Eu.Distance(v,z)/w,1),R=f.Eu.Distance(v.add(g.scale(P*w)),z);R<u&&(u=R,U=(this._distances[J+0]+w*P)/this.length())}return U}slice(){let z=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(z<0&&(z=1- -1*z%1),u<0&&(u=1- -1*u%1),z>u){const U=z;z=u,u=U}const U=this.getCurve(),J=this.getPointAt(z);let v=this.getPreviousPointIndexAt(z);const f=this.getPointAt(u),g=this.getPreviousPointIndexAt(u)+1,w=[];return 0!==z&&(v++,w.push(J)),w.push(...U.slice(v,g)),1===u&&1!==z||w.push(f),new d(w,this.getNormalAt(z),this._raw,this._alignTangentsWithPath)}update(z){let u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,U=arguments.length>2&&void 0!==arguments[2]&&arguments[2];for(let J=0;J<z.length;J++)this._curve[J].x=z[J].x,this._curve[J].y=z[J].y,this._curve[J].z=z[J].z;return this._compute(u,U),this}_compute(z){let u=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const U=this._curve.length;if(U<2)return;this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[U-1]=this._curve[U-1].Cu(this._curve[U-2]),this._raw||this._tangents[U-1].normalize();const J=this._tangents[0],v=this._normalVector(J,z);let g,w,P,R,S;this._normals[0]=v,this._raw||this._normals[0].normalize(),this._binormals[0]=f.Eu.Cross(J,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;for(let d=1;d<U;d++)g=this._getLastNonNullVector(d),d<U-1&&(w=this._getFirstNonNullVector(d),this._tangents[d]=u?w:g.add(w),this._tangents[d].normalize()),this._distances[d]=this._distances[d-1]+this._curve[d].Cu(this._curve[d-1]).length(),P=this._tangents[d],S=this._binormals[d-1],this._normals[d]=f.Eu.Cross(S,P),this._raw||(0===this._normals[d].length()?(R=this._normals[d-1],this._normals[d]=R.clone()):this._normals[d].normalize()),this._binormals[d]=f.Eu.Cross(P,this._normals[d]),this._raw||this._binormals[d].normalize();this._pointAtData.id=NaN}_getFirstNonNullVector(z){let u=1,U=this._curve[z+u].Cu(this._curve[z]);for(;0===U.length()&&z+u+1<this._curve.length;)u++,U=this._curve[z+u].Cu(this._curve[z]);return U}_getLastNonNullVector(z){let u=1,U=this._curve[z].Cu(this._curve[z-u]);for(;0===U.length()&&z>u+1;)u++,U=this._curve[z].Cu(this._curve[z-u]);return U}_normalVector(z,u){let U,J=z.length();if(0===J&&(J=1),void 0===u||null===u){let u;u=(0,v.WithinEpsilon)(Math.abs(z.y)/J,1,g.d)?(0,v.WithinEpsilon)(Math.abs(z.x)/J,1,g.d)?(0,v.WithinEpsilon)(Math.abs(z.z)/J,1,g.d)?f.Eu.Zero():new f.Eu(0,0,1):new f.Eu(1,0,0):new f.Eu(0,-1,0),U=f.Eu.Cross(z,u)}else U=f.Eu.Cross(z,u),f.Eu.CrossToRef(U,z,U);return U.normalize(),U}_updatePointAtData(z){let u=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._pointAtData.id===z)return this._pointAtData.interpolateReady||this._updateInterpolationMatrix(),this._pointAtData;this._pointAtData.id=z;const U=this.getPoints();if(z<=0)return this._setPointAtData(0,0,U[0],0,u);if(z>=1)return this._setPointAtData(1,1,U[U.length-1],U.length-1,u);let J,v=U[0],g=0;const w=z*this.length();for(let P=1;P<U.length;P++){J=U[P];const R=f.Eu.Distance(v,J);if(g+=R,g===w)return this._setPointAtData(z,1,J,P,u);if(g>w){const U=(g-w)/R,f=v.Cu(J),S=J.add(f.scaleInPlace(U));return this._setPointAtData(z,1-U,S,P-1,u)}v=J}return this._pointAtData}_setPointAtData(z,u,U,J,v){return this._pointAtData.point=U,this._pointAtData.position=z,this._pointAtData.subPosition=u,this._pointAtData.previousPointArrayIndex=J,this._pointAtData.interpolateReady=v,v&&this._updateInterpolationMatrix(),this._pointAtData}_updateInterpolationMatrix(){this._pointAtData.interpolationMatrix=f.Matrix.Identity();const z=this._pointAtData.previousPointArrayIndex;if(z!==this._tangents.length-1){const u=z+1,U=this._tangents[z].clone(),J=this._normals[z].clone(),v=this._binormals[z].clone(),g=this._tangents[u].clone(),w=this._normals[u].clone(),P=this._binormals[u].clone(),R=f.Quaternion.RotationQuaternionFromAxis(J,v,U),S=f.Quaternion.RotationQuaternionFromAxis(w,P,g);f.Quaternion.Slerp(R,S,this._pointAtData.subPosition).toRotationMatrix(this._pointAtData.interpolationMatrix)}}}class mz{static CreateQuadraticBezier(z,u,U,J){J=J>2?J:3;const v=[],g=(z,u,U,J)=>(1-z)*(1-z)*u+2*z*(1-z)*U+z*z*J;for(let w=0;w<=J;w++)v.push(new f.Eu(g(w/J,z.x,u.x,U.x),g(w/J,z.y,u.y,U.y),g(w/J,z.z,u.z,U.z)));return new mz(v)}static CreateCubicBezier(z,u,U,J,v){v=v>3?v:4;const g=[],w=(z,u,U,J,v)=>(1-z)*(1-z)*(1-z)*u+3*z*(1-z)*(1-z)*U+3*z*z*(1-z)*J+z*z*z*v;for(let P=0;P<=v;P++)g.push(new f.Eu(w(P/v,z.x,u.x,U.x,J.x),w(P/v,z.y,u.y,U.y,J.y),w(P/v,z.z,u.z,U.z,J.z)));return new mz(g)}static CreateHermiteSpline(z,u,U,J,v){const g=[],w=1/v;for(let P=0;P<=v;P++)g.push(f.Eu.Hermite(z,u,U,J,P*w));return new mz(g)}static CreateCatmullRomSpline(z,u,U){const J=[],v=1/u;let g=0;if(U){const U=z.length;for(let w=0;w<U;w++){g=0;for(let P=0;P<u;P++)J.push(f.Eu.CatmullRom(z[w%U],z[(w+1)%U],z[(w+2)%U],z[(w+3)%U],g)),g+=v}J.push(J[0])}else{const U=[];U.push(z[0].clone()),Array.prototype.push.apply(U,z),U.push(z[z.length-1].clone());let w=0;for(;w<U.length-3;w++){g=0;for(let z=0;z<u;z++)J.push(f.Eu.CatmullRom(U[w],U[w+1],U[w+2],U[w+3],g)),g+=v}w--,J.push(f.Eu.CatmullRom(U[w],U[w+1],U[w+2],U[w+3],g))}return new mz(J)}static ArcThru3Points(z,u,U){let J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:32,v=arguments.length>4&&void 0!==arguments[4]&&arguments[4],g=arguments.length>5&&void 0!==arguments[5]&&arguments[5];const w=[],P=u.Cu(z),R=U.Cu(u),S=z.Cu(U),d=f.Eu.Cross(P,R),Z=d.length();if(Z<Math.pow(10,-8))return new mz(w);const A=P.lengthSquared(),E=R.lengthSquared(),C=S.lengthSquared(),r=d.lengthSquared(),M=.5*P.length()*R.length()*S.length()/Z,T=-.5*E*f.Eu.Dot(P,S)/r,X=-.5*C*f.Eu.Dot(P,R)/r,h=-.5*A*f.Eu.Dot(R,S)/r,t=z.scale(T).add(u.scale(X)).add(U.scale(h)),V=z.Cu(t).normalize(),L=f.Eu.Cross(d,V).normalize();if(g){const u=2*Math.PI/J;for(let z=0;z<=2*Math.PI;z+=u)w.push(t.add(V.scale(M*Math.cos(z)).add(L.scale(M*Math.sin(z)))));w.push(z)}else{const u=1/J;let g=0,P=f.Eu.Zero();do{P=t.add(V.scale(M*Math.cos(g)).add(L.scale(M*Math.sin(g)))),w.push(P),g+=u}while(!P.equalsWithEpsilon(U,M*u*1.1));w.push(U),v&&w.push(z)}return new mz(w)}constructor(z){this._length=0,this._points=z,this._length=this._computeLength(z)}getPoints(){return this._points}length(){return this._length}continue(z){const u=this._points[this._points.length-1],U=this._points.slice(),J=z.getPoints();for(let v=1;v<J.length;v++)U.push(J[v].Cu(J[0]).add(u));return new mz(U)}_computeLength(z){let u=0;for(let U=1;U<z.length;U++)u+=z[U].Cu(z[U-1]).length();return u}}},13027:(z,u,U)=>{U.d(u,{d:()=>J});class J{constructor(z,u,U,J){this.x=z,this.y=u,this.width=U,this.height=J}toGlobal(z,u){return new J(this.x*z,this.y*u,this.width*z,this.height*u)}toGlobalToRef(z,u,U){return U.x=this.x*z,U.y=this.y*u,U.width=this.width*z,U.height=this.height*u,this}clone(){return new J(this.x,this.y,this.width,this.height)}}},13116:(z,u,U)=>{U.d(u,{c:()=>R,f:()=>S});var J=U(12914),v=U(13123);const f=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],g=[()=>1,z=>z.y,z=>z.z,z=>z.x,z=>z.x*z.y,z=>z.y*z.z,z=>3*z.z*z.z-1,z=>z.x*z.z,z=>z.x*z.x-z.y*z.y],w=(z,u)=>f[z]*g[z](u),P=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4];class R{constructor(){this.preScaled=!1,this.l00=J.Eu.Zero(),this.l1_1=J.Eu.Zero(),this.l10=J.Eu.Zero(),this.l11=J.Eu.Zero(),this.l2_2=J.Eu.Zero(),this.l2_1=J.Eu.Zero(),this.l20=J.Eu.Zero(),this.l21=J.Eu.Zero(),this.l22=J.Eu.Zero()}addLight(z,u,U){v.g.Eu[0].set(u.r,u.g,u.b);const J=v.g.Eu[0],f=v.g.Eu[1];J.scaleToRef(U,f),f.scaleToRef(w(0,z),v.g.Eu[2]),this.l00.addInPlace(v.g.Eu[2]),f.scaleToRef(w(1,z),v.g.Eu[2]),this.l1_1.addInPlace(v.g.Eu[2]),f.scaleToRef(w(2,z),v.g.Eu[2]),this.l10.addInPlace(v.g.Eu[2]),f.scaleToRef(w(3,z),v.g.Eu[2]),this.l11.addInPlace(v.g.Eu[2]),f.scaleToRef(w(4,z),v.g.Eu[2]),this.l2_2.addInPlace(v.g.Eu[2]),f.scaleToRef(w(5,z),v.g.Eu[2]),this.l2_1.addInPlace(v.g.Eu[2]),f.scaleToRef(w(6,z),v.g.Eu[2]),this.l20.addInPlace(v.g.Eu[2]),f.scaleToRef(w(7,z),v.g.Eu[2]),this.l21.addInPlace(v.g.Eu[2]),f.scaleToRef(w(8,z),v.g.Eu[2]),this.l22.addInPlace(v.g.Eu[2])}scaleInPlace(z){this.l00.scaleInPlace(z),this.l1_1.scaleInPlace(z),this.l10.scaleInPlace(z),this.l11.scaleInPlace(z),this.l2_2.scaleInPlace(z),this.l2_1.scaleInPlace(z),this.l20.scaleInPlace(z),this.l21.scaleInPlace(z),this.l22.scaleInPlace(z)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(P[0]),this.l1_1.scaleInPlace(P[1]),this.l10.scaleInPlace(P[2]),this.l11.scaleInPlace(P[3]),this.l2_2.scaleInPlace(P[4]),this.l2_1.scaleInPlace(P[5]),this.l20.scaleInPlace(P[6]),this.l21.scaleInPlace(P[7]),this.l22.scaleInPlace(P[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(f[0]),this.l1_1.scaleInPlace(f[1]),this.l10.scaleInPlace(f[2]),this.l11.scaleInPlace(f[3]),this.l2_2.scaleInPlace(f[4]),this.l2_1.scaleInPlace(f[5]),this.l20.scaleInPlace(f[6]),this.l21.scaleInPlace(f[7]),this.l22.scaleInPlace(f[8])}updateFromArray(z){return J.Eu.FromArrayToRef(z[0],0,this.l00),J.Eu.FromArrayToRef(z[1],0,this.l1_1),J.Eu.FromArrayToRef(z[2],0,this.l10),J.Eu.FromArrayToRef(z[3],0,this.l11),J.Eu.FromArrayToRef(z[4],0,this.l2_2),J.Eu.FromArrayToRef(z[5],0,this.l2_1),J.Eu.FromArrayToRef(z[6],0,this.l20),J.Eu.FromArrayToRef(z[7],0,this.l21),J.Eu.FromArrayToRef(z[8],0,this.l22),this}updateFromFloatsArray(z){return J.Eu.FromFloatsToRef(z[0],z[1],z[2],this.l00),J.Eu.FromFloatsToRef(z[3],z[4],z[5],this.l1_1),J.Eu.FromFloatsToRef(z[6],z[7],z[8],this.l10),J.Eu.FromFloatsToRef(z[9],z[10],z[11],this.l11),J.Eu.FromFloatsToRef(z[12],z[13],z[14],this.l2_2),J.Eu.FromFloatsToRef(z[15],z[16],z[17],this.l2_1),J.Eu.FromFloatsToRef(z[18],z[19],z[20],this.l20),J.Eu.FromFloatsToRef(z[21],z[22],z[23],this.l21),J.Eu.FromFloatsToRef(z[24],z[25],z[26],this.l22),this}static Xu(z){return(new R).updateFromArray(z)}static FromPolynomial(z){const u=new R;return u.l00=z.xx.scale(.376127).add(z.yy.scale(.376127)).add(z.zz.scale(.376126)),u.l1_1=z.y.scale(.977204),u.l10=z.z.scale(.977204),u.l11=z.x.scale(.977204),u.l2_2=z.xy.scale(1.16538),u.l2_1=z.yz.scale(1.16538),u.l20=z.zz.scale(1.34567).Cu(z.xx.scale(.672834)).Cu(z.yy.scale(.672834)),u.l21=z.zx.scale(1.16538),u.l22=z.xx.scale(1.16538).Cu(z.yy.scale(1.16538)),u.l1_1.scaleInPlace(-1),u.l11.scaleInPlace(-1),u.l2_1.scaleInPlace(-1),u.l21.scaleInPlace(-1),u.scaleInPlace(Math.PI),u}}class S{constructor(){this.x=J.Eu.Zero(),this.y=J.Eu.Zero(),this.z=J.Eu.Zero(),this.xx=J.Eu.Zero(),this.yy=J.Eu.Zero(),this.zz=J.Eu.Zero(),this.xy=J.Eu.Zero(),this.yz=J.Eu.Zero(),this.zx=J.Eu.Zero()}get preScaledHarmonics(){return this._harmonics||(this._harmonics=R.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(z){v.g.Eu[0].zg(z.r,z.g,z.b);const u=v.g.Eu[0];this.xx.addInPlace(u),this.yy.addInPlace(u),this.zz.addInPlace(u)}scaleInPlace(z){this.x.scaleInPlace(z),this.y.scaleInPlace(z),this.z.scaleInPlace(z),this.xx.scaleInPlace(z),this.yy.scaleInPlace(z),this.zz.scaleInPlace(z),this.yz.scaleInPlace(z),this.zx.scaleInPlace(z),this.xy.scaleInPlace(z)}updateFromHarmonics(z){return this._harmonics=z,this.x.v(z.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.v(z.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.v(z.l10),this.z.scaleInPlace(1.02333),this.xx.v(z.l00),v.g.Eu[0].v(z.l20).scaleInPlace(.247708),v.g.Eu[1].v(z.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).dm(v.g.Eu[0]).addInPlace(v.g.Eu[1]),this.yy.v(z.l00),this.yy.scaleInPlace(.886277).dm(v.g.Eu[0]).dm(v.g.Eu[1]),this.zz.v(z.l00),v.g.Eu[0].v(z.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(v.g.Eu[0]),this.yz.v(z.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.v(z.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.v(z.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(z){return(new S).updateFromHarmonics(z)}static Xu(z){const u=new S;return J.Eu.FromArrayToRef(z[0],0,u.x),J.Eu.FromArrayToRef(z[1],0,u.y),J.Eu.FromArrayToRef(z[2],0,u.z),J.Eu.FromArrayToRef(z[3],0,u.xx),J.Eu.FromArrayToRef(z[4],0,u.yy),J.Eu.FromArrayToRef(z[5],0,u.zz),J.Eu.FromArrayToRef(z[6],0,u.yz),J.Eu.FromArrayToRef(z[7],0,u.zx),J.Eu.FromArrayToRef(z[8],0,u.xy),u}}},13072:(z,u,U)=>{U.d(u,{d:()=>v});var J=U(13002);class v extends J.e{constructor(z){super(),this._buffer=z}get underlyingResource(){return this._buffer}}},13148:(z,u,U)=>{U.d(u,{b:()=>M,f:()=>t,j:()=>L,k:()=>O,n:()=>h});var J=U(12894),v=U(12986),f=U(21),g=U(12899),w=U(13017),P=U(12827),R=U(12875),S=U(12955),d=U(13023),mz=U(13050);class Z extends d.e{_gatherImports(z,u){z?(this._webGPUReady=!0,u.push(Promise.all([U.e(51).then(U.bind(U,15032))]))):u.push(Promise.all([U.e(52).then(U.bind(U,15034))])),super._gatherImports(z,u)}constructor(z){let u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,U=arguments.length>2?arguments[2]:void 0;super((0,f.e)((0,f.e)({},U),{},{name:z,Au:u||mz.b.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Z.FragmentUrl}))}}Z.FragmentUrl="pass";class A extends d.e{_gatherImports(z,u){z?(this._webGPUReady=!0,u.push(Promise.all([U.e(62).then(U.bind(U,15081))]))):u.push(Promise.all([U.e(63).then(U.bind(U,15084))])),super._gatherImports(z,u)}constructor(z){let u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,U=arguments.length>2?arguments[2]:void 0;super((0,f.e)((0,f.e)({},U),{},{name:z,Au:u||mz.b.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:A.FragmentUrl,defines:"#define POSITIVEX"})),this._face=0}get face(){return this._face}set face(z){if(!(z<0||z>5))switch(this._face=z,this._face){case 0:this.updateEffect("#define POSITIVEX");break;case 1:this.updateEffect("#define NEGATIVEX");break;case 2:this.updateEffect("#define POSITIVEY");break;case 3:this.updateEffect("#define NEGATIVEY");break;case 4:this.updateEffect("#define POSITIVEZ");break;case 5:this.updateEffect("#define NEGATIVEZ")}}}A.FragmentUrl="passCube";var E=U(12901);class C extends w.c{getClassName(){return"PassPostProcess"}constructor(z,u){let U=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,J=arguments.length>3?arguments[3]:void 0,v=arguments.length>4?arguments[4]:void 0,g=arguments.length>5?arguments[5]:void 0,w=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,P=arguments.length>7&&void 0!==arguments[7]&&arguments[7];const R=(0,f.e)({size:"number"===typeof u?u:void 0,camera:U,samplingMode:J,Au:v,reusable:g,textureType:w,blockCompilation:P},u);super(z,Z.FragmentUrl,(0,f.e)({effectWrapper:"number"!==typeof u&&u.effectWrapper?void 0:new Z(z,v,R)},R))}static _Parse(z,u,U,J){return S.b.Parse((()=>new C(z.name,z.options,u,z.renderTargetSamplingMode,z._engine,z.reusable)),z,U,J)}}(0,R.f)("BABYLON.PassPostProcess",C);class r extends w.c{get face(){return this._effectWrapper.face}set face(z){this._effectWrapper.face=z}getClassName(){return"PassCubePostProcess"}constructor(z,u){let U=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,J=arguments.length>3?arguments[3]:void 0,v=arguments.length>4?arguments[4]:void 0,g=arguments.length>5?arguments[5]:void 0,w=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,P=arguments.length>7&&void 0!==arguments[7]&&arguments[7];const R=(0,f.e)({size:"number"===typeof u?u:void 0,camera:U,samplingMode:J,Au:v,reusable:g,textureType:w,blockCompilation:P},u);super(z,Z.FragmentUrl,(0,f.e)({effectWrapper:"number"!==typeof u&&u.effectWrapper?void 0:new A(z,v,R)},R))}static _Parse(z,u,U,J){return S.b.Parse((()=>new r(z.name,z.options,u,z.renderTargetSamplingMode,z._engine,z.reusable)),z,U,J)}}function M(z,u,U,J,v,f,g,P){var R,S,d,mz,Z;const A=u.getEngine();return u.isReady=!1,v=null!==(R=v)&&void 0!==R?R:u.samplingMode,J=null!==(S=J)&&void 0!==S?S:u.type,f=null!==(d=f)&&void 0!==d?d:u.format,g=null!==(mz=g)&&void 0!==mz?mz:u.width,P=null!==(Z=P)&&void 0!==Z?Z:u.height,-1===J&&(J=0),new Promise((R=>{const S=new w.c("postprocess",z,null,null,1,null,v,A,!1,void 0,J,void 0,null,!1,f);S.externalTextureSamplerBinding=!0;const d=A.createRenderTargetTexture({width:g,height:P},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:v,type:J,format:f});S.onEffectCreatedObservable.addOnce((z=>{z.executeWhenCompiled((()=>{S.onApply=z=>{z._bindTexture("textureSampler",u),z.setFloat2("scale",1,1)},U.postProcessManager.directRender([S],d,!0),A.restoreDefaultFramebuffer(),A._releaseTexture(u),S&&S.dispose(),d._swapAndDie(u),u.type=J,u.format=5,u.isReady=!0,R(u)}))}))}))}let T,X;function h(z){T||(T=new Float32Array(1),X=new Int32Array(T.buffer)),T[0]=z;const u=X[0];let U=u>>16&32768,J=u>>12&2047;const v=u>>23&255;return v<103?U:v>142?(U|=31744,U|=(255==v?0:1)&&8388607&u,U):v<113?(J|=2048,U|=(J>>114-v)+(J>>113-v&1),U):(U|=v-112<<10|J>>1,U+=1&J,U)}function t(z){const u=(32768&z)>>15,U=(31744&z)>>10,J=1023&z;return 0===U?(u?-1:1)*Math.pow(2,-14)*(J/Math.pow(2,10)):31==U?J?NaN:1/0*(u?-1:1):(u?-1:1)*Math.pow(2,U-15)*(1+J/Math.pow(2,10))}(0,g.b)([(0,E.K)()],r.prototype,"face",null),P.b._RescalePostProcessFactory=z=>new C("rescale",1,null,2,z,!1,0);const V=async(z,u,f,g,P)=>{const R=z.Vz(),S=R.getEngine();let d;if(S.isWebGPU?z.isCube?await U.e(60).then(U.bind(U,15070)):await U.e(61).then(U.bind(U,15073)):z.isCube?await U.e(58).then(U.bind(U,15060)):await U.e(59).then(U.bind(U,15067)),z.isCube){const z=["#define POSITIVEX","#define NEGATIVEX","#define POSITIVEY","#define NEGATIVEY","#define POSITIVEZ","#define NEGATIVEZ"];d=new w.c("lodCube","lodCube",{uniforms:["lod","gamma"],samplingMode:J.e.NEAREST_NEAREST_MIPNEAREST,Au:S,defines:z[g],shaderLanguage:S.isWebGPU?1:0})}else d=new w.c("lod","lod",{uniforms:["lod","gamma"],samplingMode:J.e.NEAREST_NEAREST_MIPNEAREST,Au:S,shaderLanguage:S.isWebGPU?1:0});await new Promise((z=>{d.onEffectCreatedObservable.addOnce((u=>{u.executeWhenCompiled((()=>{z(0)}))}))}));const mz=new v.c("temp",{width:u,height:f},R,!1);d.onApply=function(u){u.setTexture("textureSampler",z),u.setFloat("lod",P),u.setInt("gamma",z.gammaSpace?1:0)};const Z=z.getInternalTexture();try{if(mz.renderTarget&&Z){const U=Z.samplingMode;0!==P?z.updateSamplingMode(J.e.NEAREST_NEAREST_MIPNEAREST):z.updateSamplingMode(J.e.NEAREST_NEAREST),R.postProcessManager.directRender([d],mz.renderTarget,!0),z.updateSamplingMode(U);const v=await S.readPixels(0,0,u,f),g=new Uint8Array(v.buffer,0,v.byteLength);return S.unBindFramebuffer(mz.renderTarget),g}throw Error("Render to texture failed.")}finally{mz.dispose(),d.dispose()}};async function L(z,u,U){let J=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,v=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;return!z.isReady()&&z._texture&&await new Promise(((u,U)=>{null!==z._texture?z._texture.onLoadedObservable.addOnce((()=>{u(0)})):U(0)})),await V(z,u,U,J,v)}const O={CreateResizedCopy:function(z,u,U){let f=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const g=z.Vz(),w=g.getEngine(),P=new v.c("resized"+z.name,{width:u,height:U},g,!z.noMipmap,!0,z._texture.type,!1,z.samplingMode,!1);P.wrapU=z.wrapU,P.wrapV=z.wrapV,P.uOffset=z.uOffset,P.vOffset=z.vOffset,P.uScale=z.uScale,P.vScale=z.vScale,P.uAng=z.uAng,P.vAng=z.vAng,P.wAng=z.wAng,P.coordinatesIndex=z.coordinatesIndex,P.level=z.level,P.anisotropicFilteringLevel=z.anisotropicFilteringLevel,P._texture.isReady=!1,z.wrapU=J.e.CLAMP_ADDRESSMODE,z.wrapV=J.e.CLAMP_ADDRESSMODE;const R=new C("pass",1,null,f?J.e.BILINEAR_SAMPLINGMODE:J.e.NEAREST_SAMPLINGMODE,w,!1,0);return R.externalTextureSamplerBinding=!0,R.onEffectCreatedObservable.addOnce((u=>{u.executeWhenCompiled((()=>{R.onApply=function(u){u.setTexture("textureSampler",z)};const u=P.renderTarget;u&&(g.postProcessManager.directRender([R],u),w.unBindFramebuffer(u),P.disposeFramebufferObjects(),R.dispose(),P.getInternalTexture().isReady=!0)}))})),P},ApplyPostProcess:M,ToHalfFloat:h,FromHalfFloat:t,GetTextureDataAsync:L}},13017:(z,u,U)=>{U.d(u,{c:()=>A});var J=U(12899),v=U(13014),f=U(12756),g=U(12914),w=U(12829),P=U(12901),R=U(12955),S=U(12875),d=U(12827),mz=U(12882),Z=U(13023);d.b.prototype.setTextureFromPostProcess=function(z,u,U){var J,v;let f=null;u&&(u._forcedOutputTexture?f=u._forcedOutputTexture:u._textures.data[u._currentRenderTextureInd]&&(f=u._textures.data[u._currentRenderTextureInd])),this._bindTexture(z,null!==(J=null===(v=f)||void 0===v?void 0:v.texture)&&void 0!==J?J:null,U)},d.b.prototype.setTextureFromPostProcessOutput=function(z,u,U){var J,v;this._bindTexture(z,null!==(J=null===u||void 0===u||null===(v=u._outputTexture)||void 0===v?void 0:v.texture)&&void 0!==J?J:null,U)},w.Effect.prototype.setTextureFromPostProcess=function(z,u){this._engine.setTextureFromPostProcess(this._samplers[z],u,z)},w.Effect.prototype.setTextureFromPostProcessOutput=function(z,u){this._engine.setTextureFromPostProcessOutput(this._samplers[z],u,z)};class A{static get ForceGLSL(){return Z.e.ForceGLSL}static set ForceGLSL(z){Z.e.ForceGLSL=z}static RegisterShaderCodeProcessing(z,u){Z.e.RegisterShaderCodeProcessing(z,u)}get name(){return this._effectWrapper.name}set name(z){this._effectWrapper.name=z}get alphaMode(){return this._effectWrapper.alphaMode}set alphaMode(z){this._effectWrapper.alphaMode=z}get samples(){return this._samples}set samples(z){this._samples=Math.min(z,this._engine.getCaps().maxMSAASamples),this._textures.forEach((z=>{z.setSamples(this._samples)}))}get shaderLanguage(){return this._shaderLanguage}getEffectName(){return this._fragmentUrl}set onActivate(z){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),z&&(this._onActivateObserver=this.onActivateObservable.add(z))}set onSizeChanged(z){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(z)}set onApply(z){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(z)}set onBeforeRender(z){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(z)}set onAfterRender(z){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(z)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(z){this._forcedOutputTexture=z}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.zg(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(z,u,U,J,w,P){var R,S;let d=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,mz=arguments.length>7?arguments[7]:void 0,E=arguments.length>8?arguments[8]:void 0,C=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,r=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0,M=arguments.length>11&&void 0!==arguments[11]?arguments[11]:"postprocess",T=arguments.length>12?arguments[12]:void 0,X=arguments.length>13&&void 0!==arguments[13]&&arguments[13],h=arguments.length>14&&void 0!==arguments[14]?arguments[14]:5,t=arguments.length>15?arguments[15]:void 0,V=arguments.length>16?arguments[16]:void 0;this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.Df=!0,this.forceAutoClearInAlphaMode=!1,this.animations=[],this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._webGPUReady=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new v.f(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new g.Vector2(1,1),this._texelSize=g.Vector2.Zero(),this.onActivateObservable=new f.e,this.onSizeChangedObservable=new f.e,this.onApplyObservable=new f.e,this.onBeforeRenderObservable=new f.e,this.onAfterRenderObservable=new f.e,this.Xf=new f.e;let L,O=1,x=null;if(U&&!Array.isArray(U)){var Q,K,Y,p,N,D,c,W,j,I,F,b;const z=U;U=null!==(Q=z.uniforms)&&void 0!==Q?Q:null,J=null!==(K=z.samplers)&&void 0!==K?K:null,O=null!==(Y=z.size)&&void 0!==Y?Y:1,P=null!==(p=z.camera)&&void 0!==p?p:null,d=null!==(N=z.samplingMode)&&void 0!==N?N:1,mz=z.Au,E=z.reusable,C=Array.isArray(z.defines)?z.defines.join("\n"):null!==(D=z.defines)&&void 0!==D?D:null,r=null!==(c=z.textureType)&&void 0!==c?c:0,M=null!==(W=z.vertexUrl)&&void 0!==W?W:"postprocess",T=z.indexParameters,X=null!==(j=z.blockCompilation)&&void 0!==j&&j,h=null!==(I=z.textureFormat)&&void 0!==I?I:5,t=null!==(F=z.shaderLanguage)&&void 0!==F?F:0,x=null!==(b=z.uniformBuffers)&&void 0!==b?b:null,V=z.extraInitializations,L=z.effectWrapper}else w&&(O="number"===typeof w?w:{width:w.width,height:w.height});if(this._useExistingThinPostProcess=!!L,this._effectWrapper=null!==(R=L)&&void 0!==R?R:new Z.e({name:z,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:u,Au:mz||(null===(S=P)||void 0===S?void 0:S.Vz().getEngine()),uniforms:U,samplers:J,uniformBuffers:x,defines:C,vertexUrl:M,indexParameters:T,blockCompilation:!0,shaderLanguage:t,extraInitializations:void 0}),this.name=z,this.onEffectCreatedObservable=this._effectWrapper.onEffectCreatedObservable,null!=P?(this._camera=P,this._scene=P.Vz(),P.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):mz&&(this._engine=mz,this._engine.postProcesses.push(this)),this._options=O,this.renderTargetSamplingMode=d||1,this._reusable=E||!1,this._textureType=r,this._textureFormat=h,this._shaderLanguage=t||0,this._samplers=J||[],-1===this._samplers.indexOf("textureSampler")&&this._samplers.push("textureSampler"),this._fragmentUrl=u,this._vertexUrl=M,this._parameters=U||[],-1===this._parameters.indexOf("scale")&&this._parameters.push("scale"),this._uniformBuffers=x||[],this._indexParameters=T,!this._useExistingThinPostProcess){this._webGPUReady=1===this._shaderLanguage;const z=[];this._gatherImports(this._engine.isWebGPU&&!A.ForceGLSL,z),this._effectWrapper._webGPUReady=this._webGPUReady,this._effectWrapper._postConstructor(X,C,V,z)}}_gatherImports(){let z=arguments.length>1?arguments[1]:void 0;arguments.length>0&&void 0!==arguments[0]&&arguments[0]&&this._webGPUReady?z.push(Promise.all([U.e(53).then(U.bind(U,15039))])):z.push(Promise.all([Promise.resolve().then(U.bind(U,13044))]))}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._effectWrapper.drawWrapper.effect}shareOutputWith(z){return this._disposeTextures(),this._shareOutputWithPostProcess=z,this}useOwnOutput(){0==this._textures.length&&(this._textures=new v.f(2)),this._shareOutputWithPostProcess=null}updateEffect(){let z=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,U=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,J=arguments.length>3?arguments[3]:void 0,v=arguments.length>4?arguments[4]:void 0,f=arguments.length>5?arguments[5]:void 0,g=arguments.length>6?arguments[6]:void 0,w=arguments.length>7?arguments[7]:void 0;this._effectWrapper.updateEffect(z,u,U,J,v,f,g,w),this._postProcessDefines=Array.isArray(this._effectWrapper.options.defines)?this._effectWrapper.options.defines.join("\n"):this._effectWrapper.options.defines}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(z,u){let U=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;for(let v=0;v<this._textureCache.length;v++)if(this._textureCache[v].texture.width===z.width&&this._textureCache[v].texture.height===z.height&&this._textureCache[v].postProcessChannel===U&&this._textureCache[v].texture._generateDepthBuffer===u.generateDepthBuffer&&this._textureCache[v].texture.samples===u.samples)return this._textureCache[v].texture;const J=this._engine.createRenderTargetTexture(z,u);return this._textureCache.push({texture:J,postProcessChannel:U,lastUsedRenderId:-1}),J}_flushTextureCache(){const z=this._renderId;for(let u=this._textureCache.length-1;u>=0;u--)if(z-this._textureCache[u].lastUsedRenderId>100){let z=!1;for(let U=0;U<this._textures.length;U++)if(this._textures.data[U]===this._textureCache[u].texture){z=!0;break}z||(this._textureCache[u].texture.dispose(),this._textureCache.splice(u,1))}}resize(z,u){let U=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,J=arguments.length>3&&void 0!==arguments[3]&&arguments[3],v=arguments.length>4&&void 0!==arguments[4]&&arguments[4];this._textures.length>0&&this._textures.reset(),this.width=z,this.height=u;let f=null;if(U)for(let P=0;P<U._postProcesses.length;P++)if(null!==U._postProcesses[P]){f=U._postProcesses[P];break}const g={width:this.width,height:this.height},w={generateMipMaps:J,generateDepthBuffer:v||f===this,generateStencilBuffer:(v||f===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples,label:"PostProcessRTT-"+this.name};this._textures.push(this._createRenderTargetTexture(g,w,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(g,w,1)),this._texelSize.zg(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}_getTarget(){let z;if(this._shareOutputWithPostProcess)z=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)z=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{let u;z=this.inputTexture;for(let U=0;U<this._textureCache.length;U++)if(this._textureCache[U].texture===z){u=this._textureCache[U];break}u&&(u.lastUsedRenderId=this._renderId)}return z}activate(z){var u,U,J;let v=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,f=arguments.length>2?arguments[2]:void 0;const g=null===z||void 0!==z.cameraRigMode?z||this._camera:null,w=null!==(u=null===g||void 0===g?void 0:g.Vz())&&void 0!==u?u:z,P=w.getEngine(),R=P.getCaps().maxTextureSize,S=(v?v.width:this._engine.getRenderWidth(!0))*this._options|0,d=(v?v.height:this._engine.getRenderHeight(!0))*this._options|0;let Z=this._options.width||S,A=this._options.height||d;const E=7!==this.renderTargetSamplingMode&&1!==this.renderTargetSamplingMode&&2!==this.renderTargetSamplingMode;let C=null;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const z=P.currentViewport;z&&(Z*=z.width,A*=z.height)}(E||this.alwaysForcePOT)&&(this._options.width||(Z=P.needPOTTextures?(0,mz.c)(Z,R,this.scaleMode):Z),this._options.height||(A=P.needPOTTextures?(0,mz.c)(A,R,this.scaleMode):A)),this.width===Z&&this.height===A&&(C=this._getTarget())||this.resize(Z,A,g,E,f),this._textures.forEach((z=>{z.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(z,this.samples)})),this._flushTextureCache(),this._renderId++}return C||(C=this._getTarget()),this.enablePixelPerfectMode?(this._scaleRatio.zg(S/Z,d/A),this._engine.bindFramebuffer(C,0,S,d,this.forceFullscreenViewport)):(this._scaleRatio.zg(1,1),this._engine.bindFramebuffer(C,0,void 0,void 0,this.forceFullscreenViewport)),null===(U=(J=this._engine)._debugInsertMarker)||void 0===U||U.call(J,"post process ".concat(this.name," input")),this.onActivateObservable.notifyObservers(g),this.Df&&(0===this.alphaMode||this.forceAutoClearInAlphaMode)&&this._engine.clear(this.clearColor?this.clearColor:w.clearColor,w._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),C}get isSupported(){return this._effectWrapper.drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){return this._effectWrapper.isReady()}apply(){if(!this._effectWrapper.isReady())return null;let z;var u;(this._engine.enableEffect(this._effectWrapper.drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a),this._engine.setAlphaMode(this.alphaMode),z=this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?this._forcedOutputTexture:this.inputTexture,this.externalTextureSamplerBinding)||this._effectWrapper.drawWrapper.effect._bindTexture("textureSampler",null===(u=z)||void 0===u?void 0:u.texture);return this._effectWrapper.drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._effectWrapper.drawWrapper.effect),this._effectWrapper.bind(!0),this._effectWrapper.drawWrapper.effect}_disposeTextures(){this._shareOutputWithPostProcess||this._forcedOutputTexture?this._disposeTextureCache():(this._disposeTextureCache(),this._textures.dispose())}_disposeTextureCache(){for(let z=this._textureCache.length-1;z>=0;z--)this._textureCache[z].texture.dispose();this._textureCache.length=0}setPrePassRenderer(z){return!!this._prePassEffectConfiguration&&(this._prePassEffectConfiguration=z.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0)}dispose(z){let u;if(z=z||this._camera,this._useExistingThinPostProcess||this._effectWrapper.dispose(),this._disposeTextures(),this._scene&&(u=this._scene.postProcesses.indexOf(this),-1!==u&&this._scene.postProcesses.splice(u,1)),this._parentContainer){const z=this._parentContainer.postProcesses.indexOf(this);z>-1&&this._parentContainer.postProcesses.splice(z,1),this._parentContainer=null}if(u=this._engine.postProcesses.indexOf(this),-1!==u&&this._engine.postProcesses.splice(u,1),this.Xf.notifyObservers(),z){if(z.detachPostProcess(this),u=z._postProcesses.indexOf(this),0===u&&z._postProcesses.length>0){const z=this._camera._getFirstPostProcess();z&&z.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear(),this.onEffectCreatedObservable.clear()}}serialize(){const z=R.b.Serialize(this),u=this.getCamera()||this._scene&&this._scene.activeCamera;return z.customType="BABYLON."+this.getClassName(),z.cameraId=u?u.id:null,z.reusable=this._reusable,z.textureType=this._textureType,z.fragmentUrl=this._fragmentUrl,z.parameters=this._parameters,z.samplers=this._samplers,z.uniformBuffers=this._uniformBuffers,z.options=this._options,z.defines=this._postProcessDefines,z.textureFormat=this._textureFormat,z.vertexUrl=this._vertexUrl,z.indexParameters=this._indexParameters,z}clone(){const z=this.serialize();z._engine=this._engine,z.cameraId=null;const u=A.Parse(z,this._scene,"");return u?(u.onActivateObservable=this.onActivateObservable.clone(),u.onSizeChangedObservable=this.onSizeChangedObservable.clone(),u.onApplyObservable=this.onApplyObservable.clone(),u.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),u.onAfterRenderObservable=this.onAfterRenderObservable.clone(),u._prePassEffectConfiguration=this._prePassEffectConfiguration,u):null}static Parse(z,u,U){const J=(0,S.e)(z.customType);if(!J||!J._Parse)return null;const v=u?u.getCameraById(z.cameraId):null;return J._Parse(z,v,u,U)}static _Parse(z,u,U,J){return R.b.Parse((()=>new A(z.name,z.fragmentUrl,z.parameters,z.samplers,z.options,u,z.renderTargetSamplingMode,z._engine,z.reusable,z.defines,z.textureType,z.vertexUrl,z.indexParameters,!1,z.textureFormat)),z,U,J)}}(0,J.b)([(0,P.K)()],A.prototype,"uniqueId",void 0),(0,J.b)([(0,P.K)()],A.prototype,"name",null),(0,J.b)([(0,P.K)()],A.prototype,"width",void 0),(0,J.b)([(0,P.K)()],A.prototype,"height",void 0),(0,J.b)([(0,P.K)()],A.prototype,"renderTargetSamplingMode",void 0),(0,J.b)([(0,P.o)()],A.prototype,"clearColor",void 0),(0,J.b)([(0,P.K)()],A.prototype,"Df",void 0),(0,J.b)([(0,P.K)()],A.prototype,"forceAutoClearInAlphaMode",void 0),(0,J.b)([(0,P.K)()],A.prototype,"alphaMode",null),(0,J.b)([(0,P.K)()],A.prototype,"alphaConstants",void 0),(0,J.b)([(0,P.K)()],A.prototype,"enablePixelPerfectMode",void 0),(0,J.b)([(0,P.K)()],A.prototype,"forceFullscreenViewport",void 0),(0,J.b)([(0,P.K)()],A.prototype,"scaleMode",void 0),(0,J.b)([(0,P.K)()],A.prototype,"alwaysForcePOT",void 0),(0,J.b)([(0,P.K)("samples")],A.prototype,"_samples",void 0),(0,J.b)([(0,P.K)()],A.prototype,"adaptScaleToCurrentViewport",void 0),(0,S.f)("BABYLON.PostProcess",A)},13044:(z,u,U)=>{U.r(u),U.d(u,{postprocessVertexShader:()=>g});var J=U(12837);const v="postprocessVertexShader",f="attribute vec2 position;uniform vec2 scale;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=(position*madd+madd)*scale;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";J.d.ShadersStore[v]||(J.d.ShadersStore[v]=f);const g={name:v,shader:f}}}]);