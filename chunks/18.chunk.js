"use strict";(self.ksd6jhs1yr=self.ksd6jhs1yr||[]).push([[18],{12588:(C,c,d)=>{d(12283).c.prototype.createDepthStencilTexture=function(C,c,d){if(c.isCube){const d=C.width||C;return this._createDepthStencilCubeTexture(d,c)}return this._createDepthStencilTexture(C,c,d)}},12561:(C,c,d)=>{d(12538).ThinEngine.prototype.setAlphaMode=function(C){let c=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._alphaMode!==C){switch(C){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0}c||(this.depthCullingState.depthMask=0===C),this._alphaMode=C}else if(!c){const c=0===C;this.depthCullingState.depthMask!==c&&(this.depthCullingState.depthMask=c)}}},12570:(C,c,d)=>{var b=d(12538);b.ThinEngine.prototype.updateDynamicIndexBuffer=function(C,c){let d;this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(C),d=C.is32Bits?c instanceof Uint32Array?c:new Uint32Array(c):c instanceof Uint16Array?c:new Uint16Array(c),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,d,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()},b.ThinEngine.prototype.updateDynamicVertexBuffer=function(C,c,d,b){this.bindArrayBuffer(C),void 0===d&&(d=0);const X=c.byteLength||c.length;void 0===b||b>=X&&0===d?c instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,d,new Float32Array(c)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,d,c):c instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,d,new Float32Array(c).subarray(0,b/4)):(c=c instanceof ArrayBuffer?new Uint8Array(c,0,b):new Uint8Array(c.buffer,c.byteOffset,b),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,d,c)),this._resetVertexBufferBinding()}},12579:(C,c,d)=>{var b=d(12316),X=d(12233),P=d(12538),V=d(12584),R=d(12556);class p extends V.e{setDepthStencilTexture(C){let c=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(super.setDepthStencilTexture(C,c),!C)return;const d=this._engine,b=this._context,X=C._hardwareTexture;if(X&&C._autoMSAAManagement&&this._MSAAFramebuffer){const c=d._currentFramebuffer;d._bindUnboundFramebuffer(this._MSAAFramebuffer),b.framebufferRenderbuffer(b.FRAMEBUFFER,(0,R.b)(C.format)?b.DEPTH_STENCIL_ATTACHMENT:b.DEPTH_ATTACHMENT,b.RENDERBUFFER,X.getMSAARenderBuffer()),d._bindUnboundFramebuffer(c)}}constructor(C,c,d,b,X){super(C,c,d,b),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._disposeOnlyFramebuffers=!1,this._currentLOD=0,this._context=X}_cloneRenderTargetWrapper(){let C=null;return this._colorTextureArray&&this._depthStencilTextureArray?(C=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),C.texture.isReady=!0):C=super._cloneRenderTargetWrapper(),C}_swapRenderTargetWrapper(C){super._swapRenderTargetWrapper(C),C._framebuffer=this._framebuffer,C._depthStencilBuffer=this._depthStencilBuffer,C._MSAAFramebuffer=this._MSAAFramebuffer,C._colorTextureArray=this._colorTextureArray,C._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}createDepthStencilTexture(){let C=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,c=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],d=arguments.length>2&&void 0!==arguments[2]&&arguments[2],b=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,X=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14,P=arguments.length>5?arguments[5]:void 0;if(this._depthStencilBuffer){const C=this._engine,c=C._currentFramebuffer,d=this._context;C._bindUnboundFramebuffer(this._framebuffer),d.framebufferRenderbuffer(d.FRAMEBUFFER,d.DEPTH_STENCIL_ATTACHMENT,d.RENDERBUFFER,null),d.framebufferRenderbuffer(d.FRAMEBUFFER,d.DEPTH_ATTACHMENT,d.RENDERBUFFER,null),d.framebufferRenderbuffer(d.FRAMEBUFFER,d.STENCIL_ATTACHMENT,d.RENDERBUFFER,null),C._bindUnboundFramebuffer(c),d.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null}return super.createDepthStencilTexture(C,c,d,b,X,P)}shareDepth(C){super.shareDepth(C);const c=this._context,d=this._depthStencilBuffer,b=C._MSAAFramebuffer||C._framebuffer,X=this._engine;C._depthStencilBuffer&&C._depthStencilBuffer!==d&&c.deleteRenderbuffer(C._depthStencilBuffer),C._depthStencilBuffer=d;const P=C._generateStencilBuffer?c.DEPTH_STENCIL_ATTACHMENT:c.DEPTH_ATTACHMENT;X._bindUnboundFramebuffer(b),c.framebufferRenderbuffer(c.FRAMEBUFFER,P,c.RENDERBUFFER,d),X._bindUnboundFramebuffer(null)}_bindTextureRenderTarget(C){let c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,d=arguments.length>2?arguments[2]:void 0,b=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const X=C._hardwareTexture;if(!X)return;const P=this._framebuffer,V=this._engine,R=V._currentFramebuffer;let p;if(V._bindUnboundFramebuffer(P),V.webGLVersion>1){const P=this._context;var j;if(p=P["COLOR_ATTACHMENT"+c],C.is2DArray||C.is3D)d=d??(null===(j=this.layerIndices)||void 0===j?void 0:j[c])??0,P.framebufferTextureLayer(P.FRAMEBUFFER,p,X.underlyingResource,b,d);else if(C.isCube){var g;d=d??(null===(g=this.faceIndices)||void 0===g?void 0:g[c])??0,P.framebufferTexture2D(P.FRAMEBUFFER,p,P.TEXTURE_CUBE_MAP_POSITIVE_X+d,X.underlyingResource,b)}else P.framebufferTexture2D(P.FRAMEBUFFER,p,P.TEXTURE_2D,X.underlyingResource,b)}else{const C=this._context;p=C["COLOR_ATTACHMENT"+c+"_WEBGL"];const P=void 0!==d?C.TEXTURE_CUBE_MAP_POSITIVE_X+d:C.TEXTURE_2D;C.framebufferTexture2D(C.FRAMEBUFFER,p,P,X.underlyingResource,b)}if(C._autoMSAAManagement&&this._MSAAFramebuffer){const C=this._context;V._bindUnboundFramebuffer(this._MSAAFramebuffer),C.framebufferRenderbuffer(C.FRAMEBUFFER,p,C.RENDERBUFFER,X.getMSAARenderBuffer())}V._bindUnboundFramebuffer(R)}setTexture(C){let c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,d=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];super.setTexture(C,c,d),this._bindTextureRenderTarget(C,c)}setLayerAndFaceIndices(C,c){var d;if(super.setLayerAndFaceIndices(C,c),!this.textures||!this.layerIndices||!this.faceIndices)return;const b=(null===(d=this._attachments)||void 0===d?void 0:d.length)??this.textures.length;for(let X=0;X<b;X++){const C=this.textures[X];C&&(C.is2DArray||C.is3D?this._bindTextureRenderTarget(C,X,this.layerIndices[X]):C.isCube?this._bindTextureRenderTarget(C,X,this.faceIndices[X]):this._bindTextureRenderTarget(C,X))}}setLayerAndFaceIndex(){let C=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,c=arguments.length>1?arguments[1]:void 0,d=arguments.length>2?arguments[2]:void 0;if(super.setLayerAndFaceIndex(C,c,d),!this.textures||!this.layerIndices||!this.faceIndices)return;const b=this.textures[C];b.is2DArray||b.is3D?this._bindTextureRenderTarget(this.textures[C],C,this.layerIndices[C]):b.isCube&&this._bindTextureRenderTarget(this.textures[C],C,this.faceIndices[C])}resolveMSAATextures(){const C=this._engine,c=C._currentFramebuffer;C._bindUnboundFramebuffer(this._MSAAFramebuffer),super.resolveMSAATextures(),C._bindUnboundFramebuffer(c)}dispose(){let C=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._disposeOnlyFramebuffers;const c=this._context;C||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(c.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(c.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(c.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(C)}}d(12588);P.ThinEngine.prototype._createHardwareRenderTargetWrapper=function(C,c,d){const b=new p(C,c,d,this,this._gl);return this._renderTargetWrapperCache.push(b),b},P.ThinEngine.prototype.createRenderTargetTexture=function(C,c){const d=this._createHardwareRenderTargetWrapper(!1,!1,C);let b,X,P=!0,V=!1,R=!1,p=1;void 0!==c&&"object"===typeof c&&(P=c.generateDepthBuffer??!0,V=!!c.generateStencilBuffer,R=!!c.noColorAttachment,b=c.colorAttachment,p=c.samples??1,X=c.label);const j=b||(R?null:this._createInternalTexture(C,c,!0,5)),g=C.width||C,k=C.height||C,Z=this._currentFramebuffer,U=this._gl,A=U.createFramebuffer();if(this._bindUnboundFramebuffer(A),d._depthStencilBuffer=this._setupFramebufferDepthAttachments(V,P,g,k),!j||j.is2DArray||j.is3D||U.framebufferTexture2D(U.FRAMEBUFFER,U.COLOR_ATTACHMENT0,U.TEXTURE_2D,j._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(Z),d.label=X??"RenderTargetWrapper",d._framebuffer=A,d._generateDepthBuffer=P,d._generateStencilBuffer=V,d.setTextures(j),b){if(d._samples=b.samples,b.samples>1){const C=b._hardwareTexture.getMSAARenderBuffer(0);d._MSAAFramebuffer=U.createFramebuffer(),this._bindUnboundFramebuffer(d._MSAAFramebuffer),U.framebufferRenderbuffer(U.FRAMEBUFFER,U.COLOR_ATTACHMENT0,U.RENDERBUFFER,C),this._bindUnboundFramebuffer(null)}}else this.updateRenderTargetTextureSampleCount(d,p);return d},P.ThinEngine.prototype._createDepthStencilTexture=function(C,c,d){const P=this._gl,V=C.layers||0,p=C.depth||0;let j=P.TEXTURE_2D;0!==V?j=P.TEXTURE_2D_ARRAY:0!==p&&(j=P.TEXTURE_3D);const g=new b.d(this,12);if(g.label=c.label,!this._caps.depthTextureExtension)return X.d.Error("Depth texture is not supported by your browser or hardware."),g;const k={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...c};if(this._bindTextureDirectly(j,g,!0),this._setupDepthStencilTexture(g,C,0!==k.comparisonFunction&&k.bilinearFiltering,k.comparisonFunction,k.samples),void 0!==k.depthTextureFormat){if(15!==k.depthTextureFormat&&16!==k.depthTextureFormat&&17!==k.depthTextureFormat&&13!==k.depthTextureFormat&&14!==k.depthTextureFormat&&18!==k.depthTextureFormat)return X.d.Error(`Depth texture ${k.depthTextureFormat} format is not supported.`),g;g.format=k.depthTextureFormat}else g.format=k.generateStencil?13:16;const Z=(0,R.b)(g.format),U=this._getWebGLTextureTypeFromDepthTextureFormat(g.format),A=Z?P.DEPTH_STENCIL:P.DEPTH_COMPONENT,u=this._getInternalFormatFromDepthTextureFormat(g.format,!0,Z);return g.is2DArray?P.texImage3D(j,0,u,g.width,g.height,V,0,A,U,null):g.is3D?P.texImage3D(j,0,u,g.width,g.height,p,0,A,U,null):P.texImage2D(j,0,u,g.width,g.height,0,A,U,null),this._bindTextureDirectly(j,null),this._internalTexturesCache.push(g),d._depthStencilBuffer&&(P.deleteRenderbuffer(d._depthStencilBuffer),d._depthStencilBuffer=null),this._bindUnboundFramebuffer(d._MSAAFramebuffer??d._framebuffer),d._generateStencilBuffer=Z,d._depthStencilTextureWithStencil=Z,d._depthStencilBuffer=this._setupFramebufferDepthAttachments(d._generateStencilBuffer,d._generateDepthBuffer,d.width,d.height,d.samples,g.format),this._bindUnboundFramebuffer(null),g},P.ThinEngine.prototype.updateRenderTargetTextureSampleCount=function(C,c){var d;if(this.webGLVersion<2||!C)return 1;if(C.samples===c)return c;const b=this._gl;c=Math.min(c,this.getCaps().maxMSAASamples),C._depthStencilBuffer&&(b.deleteRenderbuffer(C._depthStencilBuffer),C._depthStencilBuffer=null),C._MSAAFramebuffer&&(b.deleteFramebuffer(C._MSAAFramebuffer),C._MSAAFramebuffer=null);const X=null===(d=C.texture)||void 0===d?void 0:d._hardwareTexture;if(null===X||void 0===X||X.releaseMSAARenderBuffers(),C.texture&&c>1&&"function"===typeof b.renderbufferStorageMultisample){const d=b.createFramebuffer();if(!d)throw new Error("Unable to create multi sampled framebuffer");C._MSAAFramebuffer=d,this._bindUnboundFramebuffer(C._MSAAFramebuffer);const P=this._createRenderBuffer(C.texture.width,C.texture.height,c,-1,this._getRGBABufferInternalSizedFormat(C.texture.type,C.texture.format,C.texture._useSRGBBuffer),b.COLOR_ATTACHMENT0,!1);if(!P)throw new Error("Unable to create multi sampled framebuffer");null===X||void 0===X||X.addMSAARenderBuffer(P)}this._bindUnboundFramebuffer(C._MSAAFramebuffer??C._framebuffer),C.texture&&(C.texture.samples=c),C._samples=c;const P=C._depthStencilTexture?C._depthStencilTexture.format:void 0;return C._depthStencilBuffer=this._setupFramebufferDepthAttachments(C._generateStencilBuffer,C._generateDepthBuffer,C.width,C.height,c,P),this._bindUnboundFramebuffer(null),c},P.ThinEngine.prototype._setupDepthStencilTexture=function(C,c,d,b){let X=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;const P=c.width??c,V=c.height??c,R=c.layers||0,p=c.depth||0;C.baseWidth=P,C.baseHeight=V,C.width=P,C.height=V,C.is2DArray=R>0,C.depth=R||p,C.isReady=!0,C.samples=X,C.generateMipMaps=!1,C.samplingMode=d?2:1,C.type=0,C._comparisonFunction=b;const j=this._gl,g=this._getTextureTarget(C),k=this._getSamplingParameters(C.samplingMode,!1);j.texParameteri(g,j.TEXTURE_MAG_FILTER,k.mag),j.texParameteri(g,j.TEXTURE_MIN_FILTER,k.min),j.texParameteri(g,j.TEXTURE_WRAP_S,j.CLAMP_TO_EDGE),j.texParameteri(g,j.TEXTURE_WRAP_T,j.CLAMP_TO_EDGE),this.webGLVersion>1&&(0===b?(j.texParameteri(g,j.TEXTURE_COMPARE_FUNC,515),j.texParameteri(g,j.TEXTURE_COMPARE_MODE,j.NONE)):(j.texParameteri(g,j.TEXTURE_COMPARE_FUNC,b),j.texParameteri(g,j.TEXTURE_COMPARE_MODE,j.COMPARE_REF_TO_TEXTURE)))}},12549:(C,c,d)=>{d.d(c,{b:()=>b});class b{get underlyingResource(){return this._webGLTexture}constructor(){let C=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,c=arguments.length>1?arguments[1]:void 0;if(this._MSAARenderBuffers=null,this._context=c,!C&&(C=c.createTexture(),!C))throw new Error("Unable to create webGL texture");this.set(C)}setUsage(){}set(C){this._webGLTexture=C}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(C){this._MSAARenderBuffers||(this._MSAARenderBuffers=[]),this._MSAARenderBuffers.push(C)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(const C of this._MSAARenderBuffers)this._context.deleteRenderbuffer(C);this._MSAARenderBuffers=null}}getMSAARenderBuffer(){var C;let c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return(null===(C=this._MSAARenderBuffers)||void 0===C?void 0:C[c])??null}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}},12529:(C,c,d)=>{d.d(c,{b:()=>r});var b=d(12316),X=d(12255),P=d(12538),V=d(12241);class R{constructor(){let C=arguments.length>0&&void 0!==arguments[0]?arguments[0]:30;this._enabled=!0,this._rollingFrameTime=new p(C)}sampleFrame(){let C=arguments.length>0&&void 0!==arguments[0]?arguments[0]:V.e.Now;if(this._enabled){if(null!=this._lastFrameTimeMs){const c=C-this._lastFrameTimeMs;this._rollingFrameTime.add(c)}this._lastFrameTimeMs=C}}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){const C=this._rollingFrameTime.history(0);return 0===C?0:1e3/C}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}}class p{constructor(C){this._samples=new Array(C),this.reset()}add(C){let c;if(this.isSaturated()){const C=this._samples[this._pos];c=C-this.average,this.average-=c/(this._sampleCount-1),this._m2-=c*(C-this.average)}else this._sampleCount++;c=C-this.average,this.average+=c/this._sampleCount,this._m2+=c*(C-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=C,this._pos++,this._pos%=this._samples.length}history(C){if(C>=this._sampleCount||C>=this._samples.length)return 0;const c=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(c-C)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(C){const c=this._samples.length;return(C%c+c)%c}}var j=d(12546),g=d(12233),k=d(12549),Z=(d(12561),d(12361));function U(C,c,d,b){let X,P=1;1===b?X=new Float32Array(c*d*4):2===b?(X=new Uint16Array(c*d*4),P=15360):X=7===b?new Uint32Array(c*d*4):new Uint8Array(c*d*4);for(let V=0;V<c;V++)for(let b=0;b<d;b++){const d=3*(b*c+V),R=4*(b*c+V);X[R+0]=C[d+0],X[R+1]=C[d+1],X[R+2]=C[d+2],X[R+3]=P}return X}function A(C){return function(c,d,X,P,V,R,p,j){let g=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,k=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;const Z=C?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,U=C?10:11,A=new b.d(this,U);A.baseWidth=d,A.baseHeight=X,A.baseDepth=P,A.width=d,A.height=X,A.depth=P,A.format=V,A.type=k,A.generateMipMaps=R,A.samplingMode=j,C?A.is3D=!0:A.is2DArray=!0,this._doNotHandleContextLost||(A._bufferView=c),C?this.updateRawTexture3D(A,c,V,p,g,k):this.updateRawTexture2DArray(A,c,V,p,g,k),this._bindTextureDirectly(Z,A,!0);const u=this._getSamplingParameters(j,R);return this._gl.texParameteri(Z,this._gl.TEXTURE_MAG_FILTER,u.mag),this._gl.texParameteri(Z,this._gl.TEXTURE_MIN_FILTER,u.min),R&&this._gl.generateMipmap(Z),this._bindTextureDirectly(Z,null),this._internalTexturesCache.push(A),A}}function u(C){return function(c,d,b,X){let P=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,V=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;const R=C?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,p=this._getWebGLTextureType(V),j=this._getInternalFormat(b),g=this._getRGBABufferInternalSizedFormat(V,b);this._bindTextureDirectly(R,c,!0),this._unpackFlipY(void 0===X||!!X),this._doNotHandleContextLost||(c._bufferView=d,c.format=b,c.invertY=X,c._compression=P),c.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),P&&d?this._gl.compressedTexImage3D(R,0,this.getCaps().s3tc[P],c.width,c.height,c.depth,0,d):this._gl.texImage3D(R,0,g,c.width,c.height,c.depth,0,j,p,d),c.generateMipMaps&&this._gl.generateMipmap(R),this._bindTextureDirectly(R,null),c.isReady=!0}}P.ThinEngine.prototype.updateRawTexture=function(C,c,d,b){let X=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,P=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,V=arguments.length>6&&void 0!==arguments[6]&&arguments[6];if(!C)return;const R=this._getRGBABufferInternalSizedFormat(P,d,V),p=this._getInternalFormat(d),j=this._getWebGLTextureType(P);this._bindTextureDirectly(this._gl.TEXTURE_2D,C,!0),this._unpackFlipY(void 0===b||!!b),this._doNotHandleContextLost||(C._bufferView=c,C.format=d,C.type=P,C.invertY=b,C._compression=X),C.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),X&&c?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[X],C.width,C.height,0,c):this._gl.texImage2D(this._gl.TEXTURE_2D,0,R,C.width,C.height,0,p,j,c),C.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),C.isReady=!0},P.ThinEngine.prototype.createRawTexture=function(C,c,d,X,P,V,R){let p=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,j=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,g=arguments.length>10&&void 0!==arguments[10]&&arguments[10];const k=new b.d(this,3);k.baseWidth=c,k.baseHeight=d,k.width=c,k.height=d,k.format=X,k.generateMipMaps=P,k.samplingMode=R,k.invertY=V,k._compression=p,k.type=j,k._useSRGBBuffer=this._getUseSRGBBuffer(g,!P),this._doNotHandleContextLost||(k._bufferView=C),this.updateRawTexture(k,C,X,V,p,j,k._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,k,!0);const Z=this._getSamplingParameters(R,P);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,Z.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,Z.min),P&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(k),k},P.ThinEngine.prototype.createRawCubeTexture=function(C,c,d,X,P,V,R){let p=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;const j=this._gl,k=new b.d(this,8);k.isCube=!0,k.format=d,k.type=X,this._doNotHandleContextLost||(k._bufferViewArray=C);const U=this._getWebGLTextureType(X);let A=this._getInternalFormat(d);A===j.RGB&&(A=j.RGBA),U!==j.FLOAT||this._caps.textureFloatLinearFiltering?U!==this._gl.HALF_FLOAT_OES||this._caps.textureHalfFloatLinearFiltering?U!==j.FLOAT||this._caps.textureFloatRender?U!==j.HALF_FLOAT||this._caps.colorBufferFloat||(P=!1,g.d.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(P=!1,g.d.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(P=!1,R=1,g.d.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(P=!1,R=1,g.d.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively."));const u=c,q=u;k.width=u,k.height=q,k.invertY=V,k._compression=p;if(!this.needPOTTextures||(0,Z.h)(k.width)&&(0,Z.h)(k.height)||(P=!1),C)this.updateRawCubeTexture(k,C,d,X,V,p);else{const C=this._getRGBABufferInternalSizedFormat(X),c=0;this._bindTextureDirectly(j.TEXTURE_CUBE_MAP,k,!0);for(let d=0;d<6;d++)p?j.compressedTexImage2D(j.TEXTURE_CUBE_MAP_POSITIVE_X+d,c,this.getCaps().s3tc[p],k.width,k.height,0,void 0):j.texImage2D(j.TEXTURE_CUBE_MAP_POSITIVE_X+d,c,C,k.width,k.height,0,A,U,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,k,!0),C&&P&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);const B=this._getSamplingParameters(R,P);return j.texParameteri(j.TEXTURE_CUBE_MAP,j.TEXTURE_MAG_FILTER,B.mag),j.texParameteri(j.TEXTURE_CUBE_MAP,j.TEXTURE_MIN_FILTER,B.min),j.texParameteri(j.TEXTURE_CUBE_MAP,j.TEXTURE_WRAP_S,j.CLAMP_TO_EDGE),j.texParameteri(j.TEXTURE_CUBE_MAP,j.TEXTURE_WRAP_T,j.CLAMP_TO_EDGE),this._bindTextureDirectly(j.TEXTURE_CUBE_MAP,null),k.generateMipMaps=P,k.samplingMode=R,k.isReady=!0,k},P.ThinEngine.prototype.updateRawCubeTexture=function(C,c,d,b,X){let P=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,V=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;C._bufferViewArray=c,C.format=d,C.type=b,C.invertY=X,C._compression=P;const R=this._gl,p=this._getWebGLTextureType(b);let j=this._getInternalFormat(d);const g=this._getRGBABufferInternalSizedFormat(b);let k=!1;j===R.RGB&&(j=R.RGBA,k=!0),this._bindTextureDirectly(R.TEXTURE_CUBE_MAP,C,!0),this._unpackFlipY(void 0===X||!!X),C.width%4!==0&&R.pixelStorei(R.UNPACK_ALIGNMENT,1);for(let Z=0;Z<6;Z++){let d=c[Z];P?R.compressedTexImage2D(R.TEXTURE_CUBE_MAP_POSITIVE_X+Z,V,this.getCaps().s3tc[P],C.width,C.height,0,d):(k&&(d=U(d,C.width,C.height,b)),R.texImage2D(R.TEXTURE_CUBE_MAP_POSITIVE_X+Z,V,g,C.width,C.height,0,j,p,d))}(!this.needPOTTextures||(0,Z.h)(C.width)&&(0,Z.h)(C.height))&&C.generateMipMaps&&0===V&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),C.isReady=!0},P.ThinEngine.prototype.createRawCubeTextureFromUrl=function(C,c,d,b,X,P,V,R){let p=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,j=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,g=arguments.length>10&&void 0!==arguments[10]?arguments[10]:3,k=arguments.length>11&&void 0!==arguments[11]&&arguments[11];const Z=this._gl,A=this.createRawCubeTexture(null,d,b,X,!P,k,g,null);null===c||void 0===c||c.addPendingData(A),A.url=C,A.isReady=!1,this._internalTexturesCache.push(A);const u=C=>{if(!A._hardwareTexture)return;const d=A.width,P=V(C);if(P){if(R){const C=this._getWebGLTextureType(X);let c=this._getInternalFormat(b);const V=this._getRGBABufferInternalSizedFormat(X);let p=!1;c===Z.RGB&&(c=Z.RGBA,p=!0),this._bindTextureDirectly(Z.TEXTURE_CUBE_MAP,A,!0),this._unpackFlipY(!1);const j=R(P);for(let b=0;b<j.length;b++){const P=d>>b;for(let d=0;d<6;d++){let R=j[b][d];p&&(R=U(R,P,P,X)),Z.texImage2D(d,b,V,P,P,0,c,C,R)}}this._bindTextureDirectly(Z.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(A,P,b,X,k);A.isReady=!0,null===c||void 0===c||c.removePendingData(A),A.onLoadedObservable.notifyObservers(A),A.onLoadedObservable.clear(),p&&p()}};return this._loadFile(C,(C=>{u(C)}),void 0,null===c||void 0===c?void 0:c.offlineProvider,!0,((C,d)=>{null===c||void 0===c||c.removePendingData(A),j&&C&&j(C.status+" "+C.statusText,d)})),A},P.ThinEngine.prototype.createRawTexture2DArray=A(!1),P.ThinEngine.prototype.createRawTexture3D=A(!0),P.ThinEngine.prototype.updateRawTexture2DArray=u(!1),P.ThinEngine.prototype.updateRawTexture3D=u(!0);var q=d(12274);P.ThinEngine.prototype._readTexturePixelsSync=function(C,c,d){let b=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,X=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,P=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,V=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],R=arguments.length>7&&void 0!==arguments[7]&&arguments[7],p=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,j=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;const g=this._gl;if(!g)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){const C=g.createFramebuffer();if(!C)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=C}var k,Z;(g.bindFramebuffer(g.FRAMEBUFFER,this._dummyFramebuffer),b>-1)?g.framebufferTexture2D(g.FRAMEBUFFER,g.COLOR_ATTACHMENT0,g.TEXTURE_CUBE_MAP_POSITIVE_X+b,null===(k=C._hardwareTexture)||void 0===k?void 0:k.underlyingResource,X):g.framebufferTexture2D(g.FRAMEBUFFER,g.COLOR_ATTACHMENT0,g.TEXTURE_2D,null===(Z=C._hardwareTexture)||void 0===Z?void 0:Z.underlyingResource,X);let U=void 0!==C.type?this._getWebGLTextureType(C.type):g.UNSIGNED_BYTE;if(R)P||(P=(0,q.n)(C.type,4*c*d));else if(U===g.UNSIGNED_BYTE)P||(P=new Uint8Array(4*c*d)),U=g.UNSIGNED_BYTE;else P||(P=new Float32Array(4*c*d)),U=g.FLOAT;return V&&this.flushFramebuffer(),g.readPixels(p,j,c,d,g.RGBA,U,P),g.bindFramebuffer(g.FRAMEBUFFER,this._currentFramebuffer),P},P.ThinEngine.prototype._readTexturePixels=function(C,c,d){let b=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,X=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,P=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,V=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],R=arguments.length>7&&void 0!==arguments[7]&&arguments[7],p=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,j=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;return Promise.resolve(this._readTexturePixelsSync(C,c,d,b,X,P,V,R,p,j))};d(12570);P.ThinEngine.prototype._createDepthStencilCubeTexture=function(C,c){const d=new b.d(this,12);if(d.isCube=!0,1===this.webGLVersion)return g.d.Error("Depth cube texture is not supported by WebGL 1."),d;const X={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...c},P=this._gl;this._bindTextureDirectly(P.TEXTURE_CUBE_MAP,d,!0),this._setupDepthStencilTexture(d,C,X.bilinearFiltering,X.comparisonFunction);for(let b=0;b<6;b++)X.generateStencil?P.texImage2D(P.TEXTURE_CUBE_MAP_POSITIVE_X+b,0,P.DEPTH24_STENCIL8,C,C,0,P.DEPTH_STENCIL,P.UNSIGNED_INT_24_8,null):P.texImage2D(P.TEXTURE_CUBE_MAP_POSITIVE_X+b,0,P.DEPTH_COMPONENT24,C,C,0,P.DEPTH_COMPONENT,P.UNSIGNED_INT,null);return this._bindTextureDirectly(P.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(d),d},P.ThinEngine.prototype._setCubeMapTextureParams=function(C,c,d){const b=this._gl;b.texParameteri(b.TEXTURE_CUBE_MAP,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_CUBE_MAP,b.TEXTURE_MIN_FILTER,c?b.LINEAR_MIPMAP_LINEAR:b.LINEAR),b.texParameteri(b.TEXTURE_CUBE_MAP,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_CUBE_MAP,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),C.samplingMode=c?3:2,c&&this.getCaps().textureMaxLevel&&void 0!==d&&d>0&&(b.texParameteri(b.TEXTURE_CUBE_MAP,b.TEXTURE_MAX_LEVEL,d),C._maxLodLevel=d),this._bindTextureDirectly(b.TEXTURE_CUBE_MAP,null)},P.ThinEngine.prototype.createCubeTexture=function(C,c,d,b){let X=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,P=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,V=arguments.length>6?arguments[6]:void 0,R=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,p=arguments.length>8&&void 0!==arguments[8]&&arguments[8],j=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,k=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0,U=arguments.length>11&&void 0!==arguments[11]?arguments[11]:null,A=arguments.length>13&&void 0!==arguments[13]&&arguments[13],u=arguments.length>14&&void 0!==arguments[14]?arguments[14]:null;const q=this._gl;return this.createCubeTextureBase(C,c,d,!!b,X,P,V,R,p,j,k,U,(C=>this._bindTextureDirectly(q.TEXTURE_CUBE_MAP,C,!0)),((C,c)=>{const d=this.needPOTTextures?(0,Z.g)(c[0].width,this._caps.maxCubemapTextureSize):c[0].width,P=d,R=[q.TEXTURE_CUBE_MAP_POSITIVE_X,q.TEXTURE_CUBE_MAP_POSITIVE_Y,q.TEXTURE_CUBE_MAP_POSITIVE_Z,q.TEXTURE_CUBE_MAP_NEGATIVE_X,q.TEXTURE_CUBE_MAP_NEGATIVE_Y,q.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(q.TEXTURE_CUBE_MAP,C,!0),this._unpackFlipY(!1);const p=V?this._getInternalFormat(V,C._useSRGBBuffer):C._useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:q.RGBA;let j=V?this._getInternalFormat(V):q.RGBA;C._useSRGBBuffer&&1===this.webGLVersion&&(j=p);for(let b=0;b<R.length;b++)if(c[b].width!==d||c[b].height!==P){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext)return void g.d.Warn("Cannot create canvas to resize texture.");this._workingCanvas.width=d,this._workingCanvas.height=P,this._workingContext.drawImage(c[b],0,0,c[b].width,c[b].height,0,0,d,P),q.texImage2D(R[b],0,p,j,q.UNSIGNED_BYTE,this._workingCanvas)}else q.texImage2D(R[b],0,p,j,q.UNSIGNED_BYTE,c[b]);b||q.generateMipmap(q.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(C,!b),C.width=d,C.height=P,C.isReady=!0,V&&(C.format=V),C.onLoadedObservable.notifyObservers(C),C.onLoadedObservable.clear(),X&&X()}),!!A,u)},P.ThinEngine.prototype.generateMipMapsForCubemap=function(C){let c=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(C.generateMipMaps){const d=this._gl;this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,C,!0),d.generateMipmap(d.TEXTURE_CUBE_MAP),c&&this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,null)}};d(12579);P.ThinEngine.prototype.setDepthStencilTexture=function(C,c,d,b){void 0!==C&&(c&&(this._boundUniforms[C]=c),d&&d.depthStencilTexture?this._setTexture(C,d,!1,!0,b):this._setTexture(C,null,void 0,void 0,b))},P.ThinEngine.prototype.createRenderTargetCubeTexture=function(C,c){const d=this._createHardwareRenderTargetWrapper(!1,!0,C),X={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,...c};X.generateStencilBuffer=X.generateDepthBuffer&&X.generateStencilBuffer,(1!==X.type||this._caps.textureFloatLinearFiltering)&&(2!==X.type||this._caps.textureHalfFloatLinearFiltering)||(X.samplingMode=1);const P=this._gl,V=new b.d(this,5);this._bindTextureDirectly(P.TEXTURE_CUBE_MAP,V,!0);const R=this._getSamplingParameters(X.samplingMode,X.generateMipMaps);1!==X.type||this._caps.textureFloat||(X.type=0,g.d.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),P.texParameteri(P.TEXTURE_CUBE_MAP,P.TEXTURE_MAG_FILTER,R.mag),P.texParameteri(P.TEXTURE_CUBE_MAP,P.TEXTURE_MIN_FILTER,R.min),P.texParameteri(P.TEXTURE_CUBE_MAP,P.TEXTURE_WRAP_S,P.CLAMP_TO_EDGE),P.texParameteri(P.TEXTURE_CUBE_MAP,P.TEXTURE_WRAP_T,P.CLAMP_TO_EDGE);for(let b=0;b<6;b++)P.texImage2D(P.TEXTURE_CUBE_MAP_POSITIVE_X+b,0,this._getRGBABufferInternalSizedFormat(X.type,X.format),C,C,0,this._getInternalFormat(X.format),this._getWebGLTextureType(X.type),null);const p=P.createFramebuffer();return this._bindUnboundFramebuffer(p),d._depthStencilBuffer=this._setupFramebufferDepthAttachments(X.generateStencilBuffer,X.generateDepthBuffer,C,C),X.generateMipMaps&&P.generateMipmap(P.TEXTURE_CUBE_MAP),this._bindTextureDirectly(P.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),d._framebuffer=p,d._generateDepthBuffer=X.generateDepthBuffer,d._generateStencilBuffer=X.generateStencilBuffer,V.width=C,V.height=C,V.isReady=!0,V.isCube=!0,V.samples=1,V.generateMipMaps=X.generateMipMaps,V.samplingMode=X.samplingMode,V.type=X.type,V.format=X.format,this._internalTexturesCache.push(V),d.setTextures(V),d};var B=d(12595),t=d(12426);P.ThinEngine.prototype.createPrefilteredCubeTexture=function(C,c,X,P){let V=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,R=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,p=arguments.length>6?arguments[6]:void 0,j=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,k=!(arguments.length>8&&void 0!==arguments[8])||arguments[8];return this.createCubeTexture(C,c,null,!1,(async C=>{if(!C)return void(V&&V(null));const R=C.texture;if(k?C.info.sphericalPolynomial&&(R._sphericalPolynomial=C.info.sphericalPolynomial):R._sphericalPolynomial=new B.e,R._source=9,this.getCaps().textureLOD)return void(V&&V(R));const p=this._gl,j=C.width;if(!j)return;const{DDSTools:Z}=await d.e(29).then(d.bind(d,14886)),U=[];for(let d=0;d<3;d++){const V=1-d/2,k=P,A=Math.log2(j)*X+P,u=k+(A-k)*V,q=Math.round(Math.min(Math.max(u,0),A)),B=new b.d(this,2);if(B.type=R.type,B.format=R.format,B.width=Math.pow(2,Math.max(Math.log2(j)-q,0)),B.height=B.width,B.isCube=!0,B._cachedWrapU=0,B._cachedWrapV=0,this._bindTextureDirectly(p.TEXTURE_CUBE_MAP,B,!0),B.samplingMode=2,p.texParameteri(p.TEXTURE_CUBE_MAP,p.TEXTURE_MAG_FILTER,p.LINEAR),p.texParameteri(p.TEXTURE_CUBE_MAP,p.TEXTURE_MIN_FILTER,p.LINEAR),p.texParameteri(p.TEXTURE_CUBE_MAP,p.TEXTURE_WRAP_S,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_CUBE_MAP,p.TEXTURE_WRAP_T,p.CLAMP_TO_EDGE),C.isDDS){const c=C.info,d=C.data;this._unpackFlipY(c.isCompressed),Z.UploadDDSLevels(this,B,d,c,!0,6,q)}else g.d.Warn("DDS is the only prefiltered cube map supported so far.");this._bindTextureDirectly(p.TEXTURE_CUBE_MAP,null);const e=new t.e(c);e._isCube=!0,e._texture=B,B.isReady=!0,U.push(e)}R._lodTextureHigh=U[2],R._lodTextureMid=U[1],R._lodTextureLow=U[0],V&&V(R)}),R,p,j,k,X,P)},P.ThinEngine.prototype.createUniformBuffer=function(C,c){const d=this._gl.createBuffer();if(!d)throw new Error("Unable to create uniform buffer");const b=new j.b(d);return this.bindUniformBuffer(b),C instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,C,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(C),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),b.references=1,b},P.ThinEngine.prototype.createDynamicUniformBuffer=function(C,c){const d=this._gl.createBuffer();if(!d)throw new Error("Unable to create dynamic uniform buffer");const b=new j.b(d);return this.bindUniformBuffer(b),C instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,C,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(C),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),b.references=1,b},P.ThinEngine.prototype.updateUniformBuffer=function(C,c,d,b){this.bindUniformBuffer(C),void 0===d&&(d=0),void 0===b?c instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,d,c):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,d,new Float32Array(c)):c instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,c.subarray(d,d+b)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(c).subarray(d,d+b)),this.bindUniformBuffer(null)},P.ThinEngine.prototype.bindUniformBuffer=function(C){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,C?C.underlyingResource:null)},P.ThinEngine.prototype.bindUniformBufferBase=function(C,c,d){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,c,C?C.underlyingResource:null)},P.ThinEngine.prototype.bindUniformBlock=function(C,c,d){const b=C.program,X=this._gl.getUniformBlockIndex(b,c);4294967295!==X&&this._gl.uniformBlockBinding(b,X,d)};var e=d(12227),n=d(12283);n.c.prototype.displayLoadingUI=function(){if(!(0,e.l)())return;const C=this.loadingScreen;C&&C.displayLoadingUI()},n.c.prototype.hideLoadingUI=function(){if(!(0,e.l)())return;const C=this._loadingScreen;C&&C.hideLoadingUI()},Object.defineProperty(n.c.prototype,"loadingScreen",{get:function(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=n.c.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen},set:function(C){this._loadingScreen=C},enumerable:!0,configurable:!0}),Object.defineProperty(n.c.prototype,"loadingUIText",{set:function(C){this.loadingScreen.loadingUIText=C},enumerable:!0,configurable:!0}),Object.defineProperty(n.c.prototype,"loadingUIBackgroundColor",{set:function(C){this.loadingScreen.loadingUIBackgroundColor=C},enumerable:!0,configurable:!0}),n.c.prototype.getInputElement=function(){return this._renderingCanvas},n.c.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null},n.c.prototype.getInputElementClientRect=function(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null},n.c.prototype.getAspectRatio=function(C){let c=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const d=C.viewport;return this.getRenderWidth(c)*d.width/(this.getRenderHeight(c)*d.height)},n.c.prototype.getScreenAspectRatio=function(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)},n.c.prototype._verifyPointerLock=function(){var C;null===(C=this._onPointerLockChange)||void 0===C||C.call(this)},n.c.prototype.setAlphaEquation=function(C){if(this._alphaEquation!==C){switch(C){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774)}this._alphaEquation=C}},n.c.prototype.getInputElement=function(){return this._renderingCanvas},n.c.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc},n.c.prototype.setDepthFunction=function(C){this._depthCullingState.depthFunc=C},n.c.prototype.setDepthFunctionToGreater=function(){this.setDepthFunction(516)},n.c.prototype.setDepthFunctionToGreaterOrEqual=function(){this.setDepthFunction(518)},n.c.prototype.setDepthFunctionToLess=function(){this.setDepthFunction(513)},n.c.prototype.setDepthFunctionToLessOrEqual=function(){this.setDepthFunction(515)},n.c.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask},n.c.prototype.setDepthWrite=function(C){this._depthCullingState.depthMask=C},n.c.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest},n.c.prototype.setStencilBuffer=function(C){this._stencilState.stencilTest=C},n.c.prototype.getStencilMask=function(){return this._stencilState.stencilMask},n.c.prototype.setStencilMask=function(C){this._stencilState.stencilMask=C},n.c.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc},n.c.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef},n.c.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask},n.c.prototype.setStencilFunction=function(C){this._stencilState.stencilFunc=C},n.c.prototype.setStencilFunctionReference=function(C){this._stencilState.stencilFuncRef=C},n.c.prototype.setStencilFunctionMask=function(C){this._stencilState.stencilFuncMask=C},n.c.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail},n.c.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail},n.c.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass},n.c.prototype.setStencilOperationFail=function(C){this._stencilState.stencilOpStencilFail=C},n.c.prototype.setStencilOperationDepthFail=function(C){this._stencilState.stencilOpDepthFail=C},n.c.prototype.setStencilOperationPass=function(C){this._stencilState.stencilOpStencilDepthPass=C},n.c.prototype.cacheStencilState=function(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()},n.c.prototype.restoreStencilState=function(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)},n.c.prototype.setAlphaConstants=function(C,c,d,b){this._alphaState.setAlphaBlendConstants(C,c,d,b)},n.c.prototype.getAlphaMode=function(){return this._alphaMode},n.c.prototype.getAlphaEquation=function(){return this._alphaEquation},n.c.prototype.getRenderPassNames=function(){return this._renderPassNames},n.c.prototype.getCurrentRenderPassName=function(){return this._renderPassNames[this.currentRenderPassId]},n.c.prototype.createRenderPassId=function(C){const c=++n.c._RenderPassIdCounter;return this._renderPassNames[c]=C??"NONAME",c},n.c.prototype.releaseRenderPassId=function(C){this._renderPassNames[C]=void 0;for(let c=0;c<this.scenes.length;++c){const d=this.scenes[c];for(let c=0;c<d.meshes.length;++c){const b=d.meshes[c];if(b.Nc)for(let c=0;c<b.Nc.length;++c){b.Nc[c]._removeDrawWrapper(C)}}}};d(12588);function W(C){if(C.requestPointerLock){const c=C.requestPointerLock();c instanceof Promise?c.then((()=>{C.focus()})).catch((()=>{})):C.focus()}}var E=d(12617),N=d(12281);class r extends P.ThinEngine{static get NpmPackage(){return n.c.NpmPackage}static get Version(){return n.c.Version}static get Instances(){return X.c.Instances}static get LastCreatedEngine(){return X.c.LastCreatedEngine}static get LastCreatedScene(){return X.c.LastCreatedScene}static DefaultLoadingScreenFactory(C){return n.c.DefaultLoadingScreenFactory(C)}get _supportsHardwareTextureRescaling(){return!!r._RescalePostProcessFactory}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}get performanceMonitor(){return this._performanceMonitor}constructor(C,c,d){super(C,c,d,arguments.length>3&&void 0!==arguments[3]&&arguments[3]),this.customAnimationFrameRequester=null,this._performanceMonitor=new R,this._drawCalls=new E.b,C&&(this._features.supportRenderPasses=!0,d=this._creationOptions)}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(C){super._sharedInit(C),function(C,c,d){C._onCanvasFocus=()=>{C.onCanvasFocusObservable.notifyObservers(C)},C._onCanvasBlur=()=>{C.onCanvasBlurObservable.notifyObservers(C)},C._onCanvasContextMenu=c=>{C.disableContextMenu&&c.preventDefault()},c.addEventListener("focus",C._onCanvasFocus),c.addEventListener("blur",C._onCanvasBlur),c.addEventListener("contextmenu",C._onCanvasContextMenu),C._onBlur=()=>{C.disablePerformanceMonitorInBackground&&C.performanceMonitor.disable(),C._windowIsBackground=!0},C._onFocus=()=>{C.disablePerformanceMonitorInBackground&&C.performanceMonitor.enable(),C._windowIsBackground=!1},C._onCanvasPointerOut=d=>{document.elementFromPoint(d.clientX,d.clientY)!==c&&C.onCanvasPointerOutObservable.notifyObservers(d)};const b=C.getHostWindow();b&&"function"===typeof b.addEventListener&&(b.addEventListener("blur",C._onBlur),b.addEventListener("focus",C._onFocus)),c.addEventListener("pointerout",C._onCanvasPointerOut),d.doNotHandleTouchAction||function(C){C&&C.setAttribute&&(C.setAttribute("touch-action","none"),C.style.touchAction="none",C.style.webkitTapHighlightColor="transparent")}(c),!n.c.audioEngine&&d.audioEngine&&n.c.AudioEngineFactory&&(n.c.audioEngine=n.c.AudioEngineFactory(C.getRenderingCanvas(),C.getAudioContext(),C.getAudioDestination())),(0,e.e)()&&(C._onFullscreenChange=()=>{C.isFullscreen=!!document.fullscreenElement,C.isFullscreen&&C._pointerLockRequested&&c&&W(c)},document.addEventListener("fullscreenchange",C._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",C._onFullscreenChange,!1),C._onPointerLockChange=()=>{C.isPointerLock=document.pointerLockElement===c},document.addEventListener("pointerlockchange",C._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",C._onPointerLockChange,!1)),C.enableOfflineSupport=void 0!==n.c.OfflineProviderFactory,C._deterministicLockstep=!!d.deterministicLockstep,C._lockstepMaxSteps=d.lockstepMaxSteps||0,C._timeStep=d.timeStep||1/60}(this,C,this._creationOptions)}resizeImageBitmap(C,c,d){return function(C,c,d,b){const X=C.createCanvas(d,b).getContext("2d");if(!X)throw new Error("Unable to get 2d context for resizeImageBitmap");return X.drawImage(c,0,0),X.getImageData(0,0,d,b).data}(this,C,c,d)}async _createImageBitmapFromSource(C,c){return await async function(C,c,d){return await new Promise(((b,X)=>{const P=new Image;P.onload=()=>{P.decode().then((()=>{C.createImageBitmap(P,d).then((C=>{b(C)}))}))},P.onerror=()=>{X(`Error loading image ${P.src}`)},P.src=c}))}(this,C,c)}switchFullscreen(C){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(C)}enterFullscreen(C){this.isFullscreen||(this._pointerLockRequested=C,this._renderingCanvas&&function(C){const c=C.requestFullscreen||C.webkitRequestFullscreen;c&&c.call(C)}(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&function(){const C=document;document.exitFullscreen?document.exitFullscreen():C.webkitCancelFullScreen&&C.webkitCancelFullScreen()}()}setDitheringState(C){C?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(C){C?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}setDirectViewport(C,c,d,b){const X=this._cachedViewport;return this._cachedViewport=null,this._viewport(C,c,d,b),X}scissorClear(C,c,d,b,X){this.enableScissor(C,c,d,b),this.clear(X,!0,!0,!0),this.disableScissor()}enableScissor(C,c,d,b){const X=this._gl;X.enable(X.SCISSOR_TEST),X.scissor(C,c,d,b)}disableScissor(){const C=this._gl;C.disable(C.SCISSOR_TEST)}async _loadFileAsync(C,c,d){return await new Promise(((b,X)=>{this._loadFile(C,(C=>{b(C)}),void 0,c,d,((C,c)=>{X(c)}))}))}getVertexShaderSource(C){const c=this._gl.getAttachedShaders(C);return c?this._gl.getShaderSource(c[0]):null}getFragmentShaderSource(C){const c=this._gl.getAttachedShaders(C);return c?this._gl.getShaderSource(c[1]):null}set framebufferDimensionsObject(C){this._framebufferDimensionsObject=C,this._framebufferDimensionsObject&&this.onResizeObservable.notifyObservers(this)}_rebuildBuffers(){for(const C of this.scenes)C.resetCachedMaterial(),C._rebuildGeometries();for(const C of this._virtualScenes)C.resetCachedMaterial(),C._rebuildGeometries();super._rebuildBuffers()}getFontOffset(C){return function(C){const c=document.createElement("span");c.textContent="Hg",c.style.font=C;const d=document.createElement("div");d.style.display="inline-block",d.style.width="1px",d.style.height="0px",d.style.verticalAlign="bottom";const b=document.createElement("div");b.style.whiteSpace="nowrap",b.appendChild(c),b.appendChild(d),document.body.appendChild(b);let X=0,P=0;try{P=d.getBoundingClientRect().top-c.getBoundingClientRect().top,d.style.verticalAlign="baseline",X=d.getBoundingClientRect().top-c.getBoundingClientRect().top}finally{document.body.removeChild(b)}return{ascent:X,height:P,descent:P-X}}(C)}_cancelFrame(){if(this.customAnimationFrameRequester){if(0!==this._frameHandler){this._frameHandler=0;const{cancelAnimationFrame:C}=this.customAnimationFrameRequester;C&&C(this.customAnimationFrameRequester.U)}}else super._cancelFrame()}_renderLoop(C){this._processFrame(C),this._activeRenderLoops.length>0&&0===this._frameHandler&&(this.customAnimationFrameRequester?(this.customAnimationFrameRequester.U=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.U):this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()))}enterPointerlock(){this._renderingCanvas&&W(this._renderingCanvas)}exitPointerlock(){document.exitPointerLock&&document.exitPointerLock()}kc(){this._measureFps(),super.kc()}_deletePipelineContext(C){const c=C;c&&c.program&&c.transformFeedback&&(this.deleteTransformFeedback(c.transformFeedback),c.transformFeedback=null),super._deletePipelineContext(C)}createShaderProgram(C,c,d,b,X){let P=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;X=X||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);const V=super.createShaderProgram(C,c,d,b,X,P);return this.onAfterShaderCompilationObservable.notifyObservers(this),V}_createShaderProgram(C,c,d,b){let X=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const P=b.createProgram();if(C.program=P,!P)throw new Error("Unable to create program");if(b.attachShader(P,c),b.attachShader(P,d),this.webGLVersion>1&&X){const c=this.createTransformFeedback();this.bindTransformFeedback(c),this.setTranformFeedbackVaryings(P,X),C.transformFeedback=c}return b.linkProgram(P),this.webGLVersion>1&&X&&this.bindTransformFeedback(null),C.context=b,C.vertexShader=c,C.fragmentShader=d,C.isParallelCompiled||this._finalizePipelineContext(C),P}_releaseTexture(C){super._releaseTexture(C)}_releaseRenderTargetWrapper(C){super._releaseRenderTargetWrapper(C);for(const c of this.scenes){for(const d of c.postProcesses)d._outputTexture===C&&(d._outputTexture=null);for(const d of c.cameras)for(const c of d._postProcesses)c&&c._outputTexture===C&&(c._outputTexture=null)}}_rescaleTexture(C,c,d,b,X){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);const P=this.createRenderTargetTexture({width:c.width,height:c.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});if(!this._rescalePostProcess&&r._RescalePostProcessFactory&&(this._rescalePostProcess=r._RescalePostProcessFactory(this)),this._rescalePostProcess){this._rescalePostProcess.externalTextureSamplerBinding=!0;const V=()=>{this._rescalePostProcess.onApply=function(c){c._bindTexture("textureSampler",C)};let V=d;V||(V=this.scenes[this.scenes.length-1]),V.postProcessManager.directRender([this._rescalePostProcess],P,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,c,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,b,0,0,c.width,c.height,0),this.unBindFramebuffer(P),P.dispose(),X&&X()},R=this._rescalePostProcess.getEffect();R?R.executeWhenCompiled(V):this._rescalePostProcess.onEffectCreatedObservable.addOnce((C=>{C.executeWhenCompiled(V)}))}}wrapWebGLTexture(C){let c=arguments.length>1&&void 0!==arguments[1]&&arguments[1],d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3,X=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,P=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;const V=new k.b(C,this._gl),R=new b.d(this,0,!0);return R._hardwareTexture=V,R.baseWidth=X,R.baseHeight=P,R.width=X,R.height=P,R.isReady=!0,R.useMipMaps=c,this.updateTextureSamplingMode(d,R),R}_uploadImageToTexture(C,c){let d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,b=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const X=this._gl,P=this._getWebGLTextureType(C.type),V=this._getInternalFormat(C.format),R=this._getRGBABufferInternalSizedFormat(C.type,V),p=C.isCube?X.TEXTURE_CUBE_MAP:X.TEXTURE_2D;this._bindTextureDirectly(p,C,!0),this._unpackFlipY(C.invertY);let j=X.TEXTURE_2D;C.isCube&&(j=X.TEXTURE_CUBE_MAP_POSITIVE_X+d),X.texImage2D(j,b,R,V,P,c),this._bindTextureDirectly(p,null,!0)}updateTextureComparisonFunction(C,c){if(1===this.webGLVersion)return void g.d.Error("WebGL 1 does not support texture comparison.");const d=this._gl;C.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,C,!0),0===c?(d.texParameteri(d.TEXTURE_CUBE_MAP,d.TEXTURE_COMPARE_FUNC,515),d.texParameteri(d.TEXTURE_CUBE_MAP,d.TEXTURE_COMPARE_MODE,d.NONE)):(d.texParameteri(d.TEXTURE_CUBE_MAP,d.TEXTURE_COMPARE_FUNC,c),d.texParameteri(d.TEXTURE_CUBE_MAP,d.TEXTURE_COMPARE_MODE,d.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,C,!0),0===c?(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_COMPARE_FUNC,515),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_COMPARE_MODE,d.NONE)):(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_COMPARE_FUNC,c),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_COMPARE_MODE,d.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),C._comparisonFunction=c}createInstancesBuffer(C){const c=this._gl.createBuffer();if(!c)throw new Error("Unable to create instance buffer");const d=new j.b(c);return d.wX=C,this.bindArrayBuffer(d),this._gl.bufferData(this._gl.ARRAY_BUFFER,C,this._gl.DYNAMIC_DRAW),d.references=1,d}deleteInstancesBuffer(C){this._gl.deleteBuffer(C)}async _clientWaitAsync(C){let c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;const b=this._gl;return await new Promise(((X,P)=>{(0,N.f)((()=>{const d=b.clientWaitSync(C,c,0);if(d==b.WAIT_FAILED)throw new Error("clientWaitSync failed");return d!=b.TIMEOUT_EXPIRED}),X,P,d)}))}_readPixelsAsync(C,c,d,b,X,P,V){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");const R=this._gl,p=R.createBuffer();R.bindBuffer(R.PIXEL_PACK_BUFFER,p),R.bufferData(R.PIXEL_PACK_BUFFER,V.byteLength,R.STREAM_READ),R.readPixels(C,c,d,b,X,P,0),R.bindBuffer(R.PIXEL_PACK_BUFFER,null);const j=R.fenceSync(R.SYNC_GPU_COMMANDS_COMPLETE,0);return j?(R.flush(),this._clientWaitAsync(j,0,10).then((()=>(R.deleteSync(j),R.bindBuffer(R.PIXEL_PACK_BUFFER,p),R.getBufferSubData(R.PIXEL_PACK_BUFFER,0,V),R.bindBuffer(R.PIXEL_PACK_BUFFER,null),R.deleteBuffer(p),V)))):null}dispose(){this.hideLoadingUI(),this._rescalePostProcess&&this._rescalePostProcess.dispose(),function(C,c){1===X.c.Instances.length&&n.c.audioEngine&&(n.c.audioEngine.dispose(),n.c.audioEngine=null);const d=C.getHostWindow();d&&"function"===typeof d.removeEventListener&&(d.removeEventListener("blur",C._onBlur),d.removeEventListener("focus",C._onFocus)),c&&(c.removeEventListener("focus",C._onCanvasFocus),c.removeEventListener("blur",C._onCanvasBlur),c.removeEventListener("pointerout",C._onCanvasPointerOut),c.removeEventListener("contextmenu",C._onCanvasContextMenu)),(0,e.e)()&&(document.removeEventListener("fullscreenchange",C._onFullscreenChange),document.removeEventListener("mozfullscreenchange",C._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",C._onFullscreenChange),document.removeEventListener("msfullscreenchange",C._onFullscreenChange),document.removeEventListener("pointerlockchange",C._onPointerLockChange),document.removeEventListener("mspointerlockchange",C._onPointerLockChange),document.removeEventListener("mozpointerlockchange",C._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",C._onPointerLockChange))}(this,this._renderingCanvas),super.dispose()}}r.ALPHA_DISABLE=0,r.ALPHA_ADD=1,r.ALPHA_COMBINE=2,r.ALPHA_SUBTRACT=3,r.ALPHA_MULTIPLY=4,r.ALPHA_MAXIMIZED=5,r.ALPHA_ONEONE=6,r.ALPHA_PREMULTIPLIED=7,r.ALPHA_PREMULTIPLIED_PORTERDUFF=8,r.ALPHA_INTERPOLATE=9,r.ALPHA_SCREENMODE=10,r.DELAYLOADSTATE_NONE=0,r.DELAYLOADSTATE_LOADED=1,r.DELAYLOADSTATE_LOADING=2,r.DELAYLOADSTATE_NOTLOADED=4,r.NEVER=512,r.ALWAYS=519,r.LESS=513,r.EQUAL=514,r.LEQUAL=515,r.GREATER=516,r.GEQUAL=518,r.NOTEQUAL=517,r.KEEP=7680,r.REPLACE=7681,r.INCR=7682,r.DECR=7683,r.INVERT=5386,r.INCR_WRAP=34055,r.DECR_WRAP=34056,r.TEXTURE_CLAMP_ADDRESSMODE=0,r.TEXTURE_WRAP_ADDRESSMODE=1,r.TEXTURE_MIRROR_ADDRESSMODE=2,r.TEXTUREFORMAT_ALPHA=0,r.TEXTUREFORMAT_LUMINANCE=1,r.TEXTUREFORMAT_LUMINANCE_ALPHA=2,r.TEXTUREFORMAT_RGB=4,r.TEXTUREFORMAT_RGBA=5,r.TEXTUREFORMAT_RED=6,r.TEXTUREFORMAT_R=6,r.TEXTUREFORMAT_R16_UNORM=33322,r.TEXTUREFORMAT_RG16_UNORM=33324,r.TEXTUREFORMAT_RGB16_UNORM=32852,r.TEXTUREFORMAT_RGBA16_UNORM=32859,r.TEXTUREFORMAT_R16_SNORM=36760,r.TEXTUREFORMAT_RG16_SNORM=36761,r.TEXTUREFORMAT_RGB16_SNORM=36762,r.TEXTUREFORMAT_RGBA16_SNORM=36763,r.TEXTUREFORMAT_RG=7,r.TEXTUREFORMAT_RED_INTEGER=8,r.TEXTUREFORMAT_R_INTEGER=8,r.TEXTUREFORMAT_RG_INTEGER=9,r.TEXTUREFORMAT_RGB_INTEGER=10,r.TEXTUREFORMAT_RGBA_INTEGER=11,r.TEXTURETYPE_UNSIGNED_BYTE=0,r.TEXTURETYPE_UNSIGNED_INT=0,r.TEXTURETYPE_FLOAT=1,r.TEXTURETYPE_HALF_FLOAT=2,r.TEXTURETYPE_BYTE=3,r.TEXTURETYPE_SHORT=4,r.TEXTURETYPE_UNSIGNED_SHORT=5,r.TEXTURETYPE_INT=6,r.TEXTURETYPE_UNSIGNED_INTEGER=7,r.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,r.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,r.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,r.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,r.TEXTURETYPE_UNSIGNED_INT_24_8=12,r.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,r.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,r.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,r.TEXTURE_NEAREST_SAMPLINGMODE=1,r.TEXTURE_BILINEAR_SAMPLINGMODE=2,r.TEXTURE_TRILINEAR_SAMPLINGMODE=3,r.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,r.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,r.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,r.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,r.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,r.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,r.TEXTURE_NEAREST_LINEAR=7,r.TEXTURE_NEAREST_NEAREST=1,r.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,r.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,r.TEXTURE_LINEAR_LINEAR=2,r.TEXTURE_LINEAR_NEAREST=12,r.TEXTURE_EXPLICIT_MODE=0,r.TEXTURE_SPHERICAL_MODE=1,r.TEXTURE_PLANAR_MODE=2,r.TEXTURE_CUBIC_MODE=3,r.TEXTURE_PROJECTION_MODE=4,r.TEXTURE_SKYBOX_MODE=5,r.TEXTURE_INVCUBIC_MODE=6,r.TEXTURE_EQUIRECTANGULAR_MODE=7,r.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,r.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,r.SCALEMODE_FLOOR=1,r.SCALEMODE_NEAREST=2,r.SCALEMODE_CEILING=3},12584:(C,c,d)=>{d.d(c,{e:()=>X});var b=d(12556);class X{get depthStencilTexture(){return this._depthStencilTexture}setDepthStencilTexture(C){(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&this._depthStencilTexture&&this._depthStencilTexture.dispose(),this._depthStencilTexture=C,this._generateDepthBuffer=this._generateStencilBuffer=this._depthStencilTextureWithStencil=!1,C&&(this._generateDepthBuffer=!0,this._generateStencilBuffer=this._depthStencilTextureWithStencil=(0,b.b)(C.format))}get depthStencilTextureWithStencil(){return this._depthStencilTextureWithStencil}get isCube(){return this._isCube}get isMulti(){return this._isMulti}get is2DArray(){return this.layers>0}get is3D(){return this.depth>0}get size(){return this.width}get width(){return this._size.width??this._size}get height(){return this._size.height??this._size}get layers(){return this._size.layers||0}get depth(){return this._size.depth||0}get texture(){var C;return(null===(C=this._textures)||void 0===C?void 0:C[0])??null}get textures(){return this._textures}get faceIndices(){return this._faceIndices}get layerIndices(){return this._layerIndices}getBaseArrayLayer(C){var c,d;if(!this._textures)return-1;const b=this._textures[C],X=(null===(c=this._layerIndices)||void 0===c?void 0:c[C])??0,P=(null===(d=this._faceIndices)||void 0===d?void 0:d[C])??0;return b.isCube?6*X+P:b.is3D?0:X}get samples(){return this._samples}setSamples(C){let c=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],d=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this.samples===C&&!d)return C;const b=this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,C,c):this._engine.updateRenderTargetTextureSampleCount(this,C);return this._samples=C,b}resolveMSAATextures(){this.isMulti?this._engine.resolveMultiFramebuffer(this):this._engine.resolveFramebuffer(this)}generateMipMaps(){this._engine._currentRenderTarget===this&&this._engine.unBindFramebuffer(this,!0),this.isMulti?this._engine.generateMipMapsMultiFramebuffer(this):this._engine.generateMipMapsFramebuffer(this)}constructor(C,c,d,b,X){this._textures=null,this._faceIndices=null,this._layerIndices=null,this._samples=1,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this.disableAutomaticMSAAResolve=!1,this.resolveMSAAColors=!0,this.resolveMSAADepth=!1,this.resolveMSAAStencil=!1,this._isMulti=C,this._isCube=c,this._size=d,this._engine=b,this._depthStencilTexture=null,this.label=X}setTextures(C){Array.isArray(C)?this._textures=C:this._textures=C?[C]:null}setTexture(C){let c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,d=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._textures||(this._textures=[]),this._textures[c]!==C&&(this._textures[c]&&d&&this._textures[c].dispose(),this._textures[c]=C)}setLayerAndFaceIndices(C,c){this._layerIndices=C,this._faceIndices=c}setLayerAndFaceIndex(){let C=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,c=arguments.length>1?arguments[1]:void 0,d=arguments.length>2?arguments[2]:void 0;this._layerIndices||(this._layerIndices=[]),this._faceIndices||(this._faceIndices=[]),void 0!==c&&c>=0&&(this._layerIndices[C]=c),void 0!==d&&d>=0&&(this._faceIndices[C]=d)}createDepthStencilTexture(){var C;let c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,d=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],b=arguments.length>2&&void 0!==arguments[2]&&arguments[2],X=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,P=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14,V=arguments.length>5?arguments[5]:void 0;return null===(C=this._depthStencilTexture)||void 0===C||C.dispose(),this._depthStencilTextureWithStencil=b,this._depthStencilTextureLabel=V,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:d,comparisonFunction:c,generateStencil:b,isCube:this._isCube,samples:X,depthTextureFormat:P,label:V},this),this._depthStencilTexture}_shareDepth(C){this.shareDepth(C)}shareDepth(C){this._depthStencilTexture&&(C._depthStencilTexture&&C._depthStencilTexture.dispose(),C._depthStencilTexture=this._depthStencilTexture,C._depthStencilTextureWithStencil=this._depthStencilTextureWithStencil,this._depthStencilTexture.incrementReferences())}_swapAndDie(C){this.texture&&this.texture._swapAndDie(C),this._textures=null,this.dispose(!0)}_cloneRenderTargetWrapper(){let C=null;if(this._isMulti){const c=this.textures;if(c&&c.length>0){let d=!1,b=c.length,X=-1;const P=c[c.length-1]._source;14!==P&&12!==P||(d=!0,X=c[c.length-1].format,b--);const V=[],R=[],p=[],j=[],g=[],k=[],Z=[],U={};for(let C=0;C<b;++C){const d=c[C];V.push(d.samplingMode),R.push(d.type),p.push(d.format);void 0!==U[d.uniqueId]?(j.push(-1),Z.push(0)):(U[d.uniqueId]=C,d.is2DArray?(j.push(35866),Z.push(d.depth)):d.isCube?(j.push(34067),Z.push(0)):d.is3D?(j.push(32879),Z.push(d.depth)):(j.push(3553),Z.push(0))),this._faceIndices&&g.push(this._faceIndices[C]??0),this._layerIndices&&k.push(this._layerIndices[C]??0)}const A={samplingModes:V,generateMipMaps:c[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:d,depthTextureFormat:X,types:R,formats:p,textureCount:b,targetTypes:j,faceIndex:g,layerIndex:k,layerCounts:Z,label:this.label},u={width:this.width,height:this.height,depth:this.depth};C=this._engine.createMultipleRenderTarget(u,A);for(let q=0;q<b;++q){if(-1!==j[q])continue;const d=U[c[q].uniqueId];C.setTexture(C.textures[d],q)}}}else{var c,d,b,X;const V={};if(V.generateDepthBuffer=this._generateDepthBuffer,V.generateMipMaps=(null===(c=this.texture)||void 0===c?void 0:c.generateMipMaps)??!1,V.generateStencilBuffer=this._generateStencilBuffer,V.samplingMode=null===(d=this.texture)||void 0===d?void 0:d.samplingMode,V.type=null===(b=this.texture)||void 0===b?void 0:b.type,V.format=null===(X=this.texture)||void 0===X?void 0:X.format,V.noColorAttachment=!this._textures,V.label=this.label,this.isCube)C=this._engine.createRenderTargetCubeTexture(this.width,V);else{var P;const c={width:this.width,height:this.height,layers:this.is2DArray||this.is3D?null===(P=this.texture)||void 0===P?void 0:P.depth:void 0};C=this._engine.createRenderTargetTexture(c,V)}C.texture&&(C.texture.isReady=!0)}return C}_swapRenderTargetWrapper(C){if(this._textures&&C._textures)for(let c=0;c<this._textures.length;++c)this._textures[c]._swapAndDie(C._textures[c],!1),C._textures[c].isReady=!0;this._depthStencilTexture&&C._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(C._depthStencilTexture),C._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null}_rebuild(){const C=this._cloneRenderTargetWrapper();if(C){if(this._depthStencilTexture){const c=this._depthStencilTexture.samplingMode,d=this._depthStencilTexture.format,b=2===c||3===c||11===c;C.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,b,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples,d,this._depthStencilTextureLabel)}this.samples>1&&C.setSamples(this.samples),C._swapRenderTargetWrapper(this),C.dispose()}}releaseTextures(){if(this._textures)for(let C=0;C<this._textures.length;++C)this._textures[C].dispose();this._textures=null}dispose(){var C;arguments.length>0&&void 0!==arguments[0]&&arguments[0]||(null===(C=this._depthStencilTexture)||void 0===C||C.dispose(),this._depthStencilTexture=null,this.releaseTextures());this._engine._releaseRenderTargetWrapper(this)}}},12538:(C,c,d)=>{d.r(c),d.d(c,{ThinEngine:()=>n});var b=d(12302),X=d(12542),P=d(12233),V=d(12227);class R{constructor(){this.shaderLanguage=0}postProcessor(C,c,d,b,X){if(X.drawBuffersExtensionDisabled){const c=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;C=C.replace(c,"")}return C}}const p=/(flat\s)?\s*varying\s*.*/;class j{constructor(){this.shaderLanguage=0}attributeProcessor(C){return C.replace("attribute","in")}varyingCheck(C,c){return p.test(C)}varyingProcessor(C,c){return C.replace("varying",c?"in":"out")}postProcessor(C,c,d){const b=-1!==C.search(/#extension.+GL_EXT_draw_buffers.+require/);if(C=(C=C.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),d){const c=-1!==C.search(/layout *\(location *= *0\) *out/g);C=(C=(C=(C=(C=(C=(C=C.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/void\s+?main\s*\(/g,(b||c?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(")}else{if(-1!==c.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+C}return C}}var g=d(12546),k=d(12361),Z=d(12283),U=d(12549),A=d(12316),u=d(12289),q=d(12274),B=d(12296),t=d(12556);class e{}class n extends Z.c{get name(){return this._name}set name(C){this._name=C}get version(){return this._webGLVersion}static get ShadersRepository(){return u.Effect.ShadersRepository}static set ShadersRepository(C){u.Effect.ShadersRepository=C}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(C){this._framebufferDimensionsObject=C}snapshotRenderingReset(){this.snapshotRendering=!1}constructor(C,c,d,X){if(d=d||{},super(c??d.antialias,d,X),this._name="WebGL",this.forcePOTTextures=!1,this.validateShaderPrograms=!1,this.disableUniformBuffers=!1,this._webGLVersion=1,this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},!C)return;let V=null;if(C.getContext){if(V=C,void 0===d.nc&&(d.nc=!1),void 0===d.xrCompatible&&(d.xrCompatible=!1),navigator&&navigator.userAgent){this._setupMobileChecks();const C=navigator.userAgent;for(const c of n.ExceptionList){const b=c.key,X=c.targets;if(new RegExp(b).test(C)){if(c.capture&&c.captureConstraint){const d=c.capture,b=c.captureConstraint,X=new RegExp(d).exec(C);if(X&&X.length>0){if(parseInt(X[X.length-1])>=b)continue}}for(const C of X)switch(C){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":d.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1}}}}if(this._doNotHandleContextLost?this._onContextLost=()=>{(0,b.A)(this._gl)}:(this._onContextLost=C=>{C.preventDefault(),this._contextWasLost=!0,(0,b.A)(this._gl),P.d.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost((()=>this._initGLContext()))},V.addEventListener("webglcontextrestored",this._onContextRestored,!1),d.powerPreference=d.powerPreference||"high-performance"),V.addEventListener("webglcontextlost",this._onContextLost,!1),this._badDesktopOS&&(d.xrCompatible=!1),!d.disableWebGL2Support)try{this._gl=V.getContext("webgl2",d)||V.getContext("experimental-webgl2",d),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch(k){}if(!this._gl){if(!V)throw new Error("The provided canvas is null or undefined.");try{this._gl=V.getContext("webgl",d)||V.getContext("experimental-webgl",d)}catch(k){throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=C,V=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const c=this._gl.getContextAttributes();c&&(d.uc=c.uc)}this._sharedInit(V),this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),void 0!==d.useHighPrecisionFloats&&(this._highPrecisionShadersAllowed=d.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let b=0;b<this._caps.maxVertexAttribs;b++)this._currentBufferPointers[b]=new e;this._shaderProcessor=this.webGLVersion>1?new j:new R;const p=`Babylon.js v${n.Version}`;P.d.Log(p+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",p);const g=(0,b.D)(this._gl);g.validateShaderPrograms=this.validateShaderPrograms,g.parallelShaderCompile=this._caps.parallelShaderCompile}_clearEmptyResources(){this._dummyFramebuffer=null,super._clearEmptyResources()}_getShaderProcessingContext(C){return null}areAllEffectsReady(){for(const C in this._compiledEffects){if(!this._compiledEffects[C].isReady())return!1}return!0}_initGLContext(){this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||null!==this._gl.getExtension("OES_standard_derivatives"),maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||null!==this._gl.getExtension("OES_element_index_uint"),fragmentDepthSupported:this._webGLVersion>1||null!==this._gl.getExtension("EXT_frag_depth"),highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,colorBufferHalfFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_half_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:1!==this._webGLVersion,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1,textureNorm16:!!this._gl.getExtension("EXT_texture_norm16")},this._caps.supportFloatTexturesResolve=this._caps.colorBufferFloat,this._caps.rg11b10ufColorRenderable=this._caps.colorBufferFloat,this._glVersion=this._gl.getParameter(this._gl.VERSION);const C=this._gl.getExtension("WEBGL_debug_renderer_info");if(null!=C&&(this._glRenderer=this._gl.getParameter(C.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(C.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),36193!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=36193),34842!==this._gl.RGBA16F&&(this._gl.RGBA16F=34842),34836!==this._gl.RGBA32F&&(this._gl.RGBA32F=34836),35056!==this._gl.DEPTH24_STENCIL8&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(1===this._webGLVersion&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=(this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)??0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!(!this._caps.textureFloat||!this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!(!this._caps.textureFloat||!this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.textureNorm16&&(this._gl.R16_EXT=33322,this._gl.RG16_EXT=33324,this._gl.RGB16_EXT=32852,this._gl.RGBA16_EXT=32859,this._gl.R16_SNORM_EXT=36760,this._gl.RG16_SNORM_EXT=36761,this._gl.RGB16_SNORM_EXT=36762,this._gl.RGBA16_SNORM_EXT=36763),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&5131!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=null!==this._maxMSAASamplesOverride?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES),this._caps.maxDrawBuffers=this._gl.getParameter(this._gl.MAX_DRAW_BUFFERS);else{const C=this._gl.getExtension("WEBGL_draw_buffers");if(null!==C){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=C.drawBuffersWEBGL.bind(C),this._caps.maxDrawBuffers=this._gl.getParameter(C.MAX_DRAW_BUFFERS_WEBGL),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let c=0;c<16;c++)this._gl["COLOR_ATTACHMENT"+c+"_WEBGL"]=C["COLOR_ATTACHMENT"+c+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{const C=this._gl.getExtension("WEBGL_depth_texture");null!=C&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=C.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{const C=this._gl.getExtension("OES_vertex_array_object");null!=C&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=C.createVertexArrayOES.bind(C),this._gl.bindVertexArray=C.bindVertexArrayOES.bind(C),this._gl.deleteVertexArray=C.deleteVertexArrayOES.bind(C))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{const C=this._gl.getExtension("ANGLE_instanced_arrays");null!=C?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=C.drawArraysInstancedANGLE.bind(C),this._gl.drawElementsInstanced=C.drawElementsInstancedANGLE.bind(C),this._gl.vertexAttribDivisor=C.vertexAttribDivisorANGLE.bind(C)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){const C=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),c=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);C&&c&&(this._caps.highPrecisionShaderSupported=0!==C.precision&&0!==c.precision)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{const C=this._gl.getExtension("EXT_blend_minmax");null!=C&&(this._caps.blendMinMax=!0,this._gl.MAX=C.MAX_EXT,this._gl.MIN=C.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:WebGL2RenderingContext.SRGB,SRGB8:WebGL2RenderingContext.SRGB8,SRGB8_ALPHA8:WebGL2RenderingContext.SRGB8_ALPHA8};else{const C=this._gl.getExtension("EXT_sRGB");null!=C&&(this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:C.SRGB_EXT,SRGB8:C.SRGB_ALPHA_EXT,SRGB8_ALPHA8:C.SRGB_ALPHA_EXT})}if(this._creationOptions){const C=this._creationOptions.forceSRGBBufferSupportState;void 0!==C&&(this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&C)}}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let c=0;c<this._maxSimultaneousTextures;c++)this._nextFreeTextureSlots.push(c);"Mali-G72"===this._glRenderer&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:"undefined"===typeof HTMLImageElement,supportRenderAndCopyToLodForFloatTextures:1!==this._webGLVersion,supportDepthStencilTexture:1!==this._webGLVersion,supportShadowSamplers:1!==this._webGLVersion,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:1!==this._webGLVersion,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:1!==this._webGLVersion,basisNeedsPOT:1===this._webGLVersion,support3DTextures:1!==this._webGLVersion,needTypeSuffixInShaderConstants:1!==this._webGLVersion,supportMSAA:1!==this._webGLVersion,supportSSAO2:1!==this._webGLVersion,supportIBLShadows:1!==this._webGLVersion,supportExtendedTextureFormats:1!==this._webGLVersion,supportSwitchCaseInShader:1!==this._webGLVersion,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,forceVertexBufferStrideAndOffsetMultiple4Bytes:!1,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const C=this._workingCanvas.getContext("2d");C&&(this._workingContext=C)}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}extractDriverInfo(){const C=this.getGlInfo();return C&&C.renderer?C.renderer:""}getRenderWidth(){return!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(){return!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}clear(C,c,d){let b=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const X=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=X;let P=0;if(c&&C){let c=!0;if(this._currentRenderTarget){var V;const d=null===(V=this._currentRenderTarget.texture)||void 0===V?void 0:V.format;if(8===d||9===d||10===d||11===d){var R;const d=null===(R=this._currentRenderTarget.texture)||void 0===R?void 0:R.type;7===d||5===d?(n._TempClearColorUint32[0]=255*C.r,n._TempClearColorUint32[1]=255*C.g,n._TempClearColorUint32[2]=255*C.b,n._TempClearColorUint32[3]=255*C.a,this._gl.clearBufferuiv(this._gl.COLOR,0,n._TempClearColorUint32),c=!1):(n._TempClearColorInt32[0]=255*C.r,n._TempClearColorInt32[1]=255*C.g,n._TempClearColorInt32[2]=255*C.b,n._TempClearColorInt32[3]=255*C.a,this._gl.clearBufferiv(this._gl.COLOR,0,n._TempClearColorInt32),c=!1)}}c&&(this._gl.clearColor(C.r,C.g,C.b,void 0!==C.a?C.a:1),P|=this._gl.COLOR_BUFFER_BIT)}d&&(this.o?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),P|=this._gl.DEPTH_BUFFER_BIT),b&&(this._gl.clearStencil(0),P|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(P)}_viewport(C,c,d,b){C===this._viewportCached.x&&c===this._viewportCached.y&&d===this._viewportCached.z&&b===this._viewportCached.w||(this._viewportCached.x=C,this._viewportCached.y=c,this._viewportCached.z=d,this._viewportCached.w=b,this._gl.viewport(C,c,d,b))}Zc(){super.Zc(),this._badOS&&this.flushFramebuffer()}get performanceMonitor(){throw new Error("Not Supported by ThinEngine")}bindFramebuffer(C){let c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,d=arguments.length>2?arguments[2]:void 0,b=arguments.length>3?arguments[3]:void 0,X=arguments.length>4?arguments[4]:void 0,V=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,R=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;const p=C;this._currentRenderTarget&&this._resolveAndGenerateMipMapsFramebuffer(this._currentRenderTarget),this._currentRenderTarget=C,this._bindUnboundFramebuffer(p._framebuffer);const j=this._gl;var g;if(!C.isMulti)if(C.is2DArray||C.is3D)j.framebufferTextureLayer(j.FRAMEBUFFER,j.COLOR_ATTACHMENT0,null===(g=C.texture._hardwareTexture)||void 0===g?void 0:g.underlyingResource,V,R),p._currentLOD=V;else if(C.isCube){var k;j.framebufferTexture2D(j.FRAMEBUFFER,j.COLOR_ATTACHMENT0,j.TEXTURE_CUBE_MAP_POSITIVE_X+c,null===(k=C.texture._hardwareTexture)||void 0===k?void 0:k.underlyingResource,V)}else if(p._currentLOD!==V){var Z;j.framebufferTexture2D(j.FRAMEBUFFER,j.COLOR_ATTACHMENT0,j.TEXTURE_2D,null===(Z=C.texture._hardwareTexture)||void 0===Z?void 0:Z.underlyingResource,V),p._currentLOD=V}const U=C._depthStencilTexture;if(U){C.is3D&&(C.texture.width===U.width&&C.texture.height===U.height&&C.texture.depth===U.depth||P.d.Warn("Depth/Stencil attachment for 3D target must have same dimensions as color attachment"));const d=C._depthStencilTextureWithStencil?j.DEPTH_STENCIL_ATTACHMENT:j.DEPTH_ATTACHMENT;var A;if(C.is2DArray||C.is3D)j.framebufferTextureLayer(j.FRAMEBUFFER,d,null===(A=U._hardwareTexture)||void 0===A?void 0:A.underlyingResource,V,R);else if(C.isCube){var u;j.framebufferTexture2D(j.FRAMEBUFFER,d,j.TEXTURE_CUBE_MAP_POSITIVE_X+c,null===(u=U._hardwareTexture)||void 0===u?void 0:u.underlyingResource,V)}else{var q;j.framebufferTexture2D(j.FRAMEBUFFER,d,j.TEXTURE_2D,null===(q=U._hardwareTexture)||void 0===q?void 0:q.underlyingResource,V)}}p._MSAAFramebuffer&&this._bindUnboundFramebuffer(p._MSAAFramebuffer),this._cachedViewport&&!X?this.setViewport(this._cachedViewport,d,b):(d||(d=C.width,V&&(d/=Math.pow(2,V))),b||(b=C.height,V&&(b/=Math.pow(2,V))),this._viewport(0,0,d,b)),this.wipeCaches()}setStateCullFaceType(C,c){const d=this.cullBackFaces??C??1?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==d||c)&&(this._depthCullingState.cullFace=d)}setState(C){let c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,d=arguments.length>2?arguments[2]:void 0,b=arguments.length>3&&void 0!==arguments[3]&&arguments[3],X=arguments.length>4?arguments[4]:void 0,P=arguments.length>5?arguments[5]:void 0,V=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;(this._depthCullingState.cull!==C||d)&&(this._depthCullingState.cull=C),this.setStateCullFaceType(X,d),this.setZOffset(c),this.setZOffsetUnits(V);const R=b?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==R||d)&&(this._depthCullingState.frontFace=R),this._stencilStateComposer.stencilMaterial=P}_resolveAndGenerateMipMapsFramebuffer(C){let c=arguments.length>1&&void 0!==arguments[1]&&arguments[1];C.disableAutomaticMSAAResolve||(C.isMulti?this.resolveMultiFramebuffer(C):this.resolveFramebuffer(C)),c||(C.isMulti?this.generateMipMapsMultiFramebuffer(C):this.generateMipMapsFramebuffer(C))}_bindUnboundFramebuffer(C){this._currentFramebuffer!==C&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,C),this._currentFramebuffer=C)}_currentFrameBufferIsDefaultFrameBuffer(){return null===this._currentFramebuffer}generateMipmaps(C){const c=this._getTextureTarget(C);this._bindTextureDirectly(c,C,!0),this._gl.generateMipmap(c),this._bindTextureDirectly(c,null)}unBindFramebuffer(C,c,d){const b=C;this._currentRenderTarget=null,this._resolveAndGenerateMipMapsFramebuffer(C,c),d&&(b._MSAAFramebuffer&&this._bindUnboundFramebuffer(b._framebuffer),d()),this._bindUnboundFramebuffer(null)}generateMipMapsFramebuffer(C){var c;C.isMulti||null===(c=C.texture)||void 0===c||!c.generateMipMaps||C.isCube||this.generateMipmaps(C.texture)}resolveFramebuffer(C){const c=C,d=this._gl;if(!c._MSAAFramebuffer||c.isMulti)return;let b=c.resolveMSAAColors?d.COLOR_BUFFER_BIT:0;b|=c._generateDepthBuffer&&c.resolveMSAADepth?d.DEPTH_BUFFER_BIT:0,b|=c._generateStencilBuffer&&c.resolveMSAAStencil?d.STENCIL_BUFFER_BIT:0,d.bindFramebuffer(d.READ_FRAMEBUFFER,c._MSAAFramebuffer),d.bindFramebuffer(d.DRAW_FRAMEBUFFER,c._framebuffer),d.blitFramebuffer(0,0,C.width,C.height,0,0,C.width,C.height,b,d.NEAREST)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(C,c,d){return this._createVertexBuffer(C,this._gl.STATIC_DRAW)}_createVertexBuffer(C,c){const d=this._gl.createBuffer();if(!d)throw new Error("Unable to create vertex buffer");const b=new g.b(d);return this.bindArrayBuffer(b),"number"!==typeof C?C instanceof Array?(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(C),c),b.wX=4*C.length):(this._gl.bufferData(this._gl.ARRAY_BUFFER,C,c),b.wX=C.byteLength):(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Uint8Array(C),c),b.wX=C),this._resetVertexBufferBinding(),b.references=1,b}createDynamicVertexBuffer(C,c){return this._createVertexBuffer(C,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(C,c,d){const b=this._gl.createBuffer(),X=new g.b(b);if(!b)throw new Error("Unable to create index buffer");this.bindIndexBuffer(X);const P=this._normalizeIndexData(C);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,P,c?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),X.references=1,X.is32Bits=4===P.BYTES_PER_ELEMENT,X}_normalizeIndexData(C){if(2===C.BYTES_PER_ELEMENT)return C;if(this._caps.uintIndices){if(C instanceof Uint32Array)return C;for(let c=0;c<C.length;c++)if(C[c]>=65535)return new Uint32Array(C);return new Uint16Array(C)}return new Uint16Array(C)}bindArrayBuffer(C){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(C,this._gl.ARRAY_BUFFER)}bindUniformBlock(C,c,d){const b=C.program,X=this._gl.getUniformBlockIndex(b,c);this._gl.uniformBlockBinding(b,X,d)}bindIndexBuffer(C){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(C,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(C,c){(this._vaoRecordInProgress||this._currentBoundBuffer[c]!==C)&&(this._gl.bindBuffer(c,C?C.underlyingResource:null),this._currentBoundBuffer[c]=C)}updateArrayBuffer(C){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,C)}_vertexAttribPointer(C,c,d,b,X,P,V){const R=this._currentBufferPointers[c];if(!R)return;let p=!1;R.active?(R.buffer!==C&&(R.buffer=C,p=!0),R.size!==d&&(R.size=d,p=!0),R.type!==b&&(R.type=b,p=!0),R.normalized!==X&&(R.normalized=X,p=!0),R.stride!==P&&(R.stride=P,p=!0),R.offset!==V&&(R.offset=V,p=!0)):(p=!0,R.active=!0,R.index=c,R.size=d,R.type=b,R.normalized=X,R.stride=P,R.offset=V,R.buffer=C),(p||this._vaoRecordInProgress)&&(this.bindArrayBuffer(C),b===this._gl.UNSIGNED_INT||b===this._gl.INT?this._gl.vertexAttribIPointer(c,d,b,P,V):this._gl.vertexAttribPointer(c,d,b,X,P,V))}_bindIndexBufferWithCache(C){null!=C&&this._cachedIndexBuffer!==C&&(this._cachedIndexBuffer=C,this.bindIndexBuffer(C),this._uintIndicesCurrentlySet=C.is32Bits)}_bindVertexBuffersAttributes(C,c,d){const b=c.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let X=0;X<b.length;X++){const P=c.getAttributeLocation(X);if(P>=0){const c=b[X];let V=null;if(d&&(V=d[c]),V||(V=C[c]),!V)continue;this._gl.enableVertexAttribArray(P),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[P]=!0);const R=V.getBuffer();R&&(this._vertexAttribPointer(R,P,V.getSize(),V.type,V.normalized,V.byteStride,V.byteOffset),V.getIsInstanced()&&(this._gl.vertexAttribDivisor(P,V.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(P),this._currentInstanceBuffers.push(R))))}}}recordVertexArrayObject(C,c,d,b){const X=this._gl.createVertexArray();if(!X)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(X),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(C,d,b),this.bindIndexBuffer(c),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),X}bindVertexArrayObject(C,c){this._cachedVertexArrayObject!==C&&(this._cachedVertexArrayObject=C,this._gl.bindVertexArray(C),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=null!=c&&c.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(C,c,d,b,X){if(this._cachedVertexBuffers!==C||this._cachedEffectForVertexBuffers!==X){this._cachedVertexBuffers=C,this._cachedEffectForVertexBuffers=X;const c=X.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let P=0;for(let V=0;V<c;V++)if(V<d.length){const c=X.getAttributeLocation(V);c>=0&&(this._gl.enableVertexAttribArray(c),this._vertexAttribArraysEnabled[c]=!0,this._vertexAttribPointer(C,c,d[V],this._gl.FLOAT,!1,b,P)),P+=4*d[V]}}this._bindIndexBufferWithCache(c)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(C,c,d,b){this._cachedVertexBuffers===C&&this._cachedEffectForVertexBuffers===d||(this._cachedVertexBuffers=C,this._cachedEffectForVertexBuffers=d,this._bindVertexBuffersAttributes(C,d,b)),this._bindIndexBufferWithCache(c)}unbindInstanceAttributes(){let C;for(let c=0,d=this._currentInstanceLocations.length;c<d;c++){const d=this._currentInstanceBuffers[c];C!=d&&d.references&&(C=d,this.bindArrayBuffer(d));const b=this._currentInstanceLocations[c];this._gl.vertexAttribDivisor(b,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(C){this._gl.deleteVertexArray(C)}_releaseBuffer(C){return C.references--,0===C.references&&(this._deleteBuffer(C),!0)}_deleteBuffer(C){this._gl.deleteBuffer(C.underlyingResource)}updateAndBindInstancesBuffer(C,c,d){if(this.bindArrayBuffer(C),c&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,c),void 0!==d[0].index)this.bindInstancesBuffer(C,d,!0);else for(let b=0;b<4;b++){const c=d[b];this._vertexAttribArraysEnabled[c]||(this._gl.enableVertexAttribArray(c),this._vertexAttribArraysEnabled[c]=!0),this._vertexAttribPointer(C,c,4,this._gl.FLOAT,!1,64,16*b),this._gl.vertexAttribDivisor(c,1),this._currentInstanceLocations.push(c),this._currentInstanceBuffers.push(C)}}bindInstancesBuffer(C,c){let d=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.bindArrayBuffer(C);let b=0;if(d)for(let X=0;X<c.length;X++){b+=4*c[X].attributeSize}for(let X=0;X<c.length;X++){const d=c[X];void 0===d.index&&(d.index=this._currentEffect.getAttributeLocationByName(d.attributeName)),d.index<0||(this._vertexAttribArraysEnabled[d.index]||(this._gl.enableVertexAttribArray(d.index),this._vertexAttribArraysEnabled[d.index]=!0),this._vertexAttribPointer(C,d.index,d.attributeSize,d.attributeType||this._gl.FLOAT,d.normalized||!1,b,d.offset),this._gl.vertexAttribDivisor(d.index,void 0===d.divisor?1:d.divisor),this._currentInstanceLocations.push(d.index),this._currentInstanceBuffers.push(C))}}disableInstanceAttributeByName(C){if(!this._currentEffect)return;const c=this._currentEffect.getAttributeLocationByName(C);this.disableInstanceAttribute(c)}disableInstanceAttribute(C){let c,d=!1;for(;-1!==(c=this._currentInstanceLocations.indexOf(C));)this._currentInstanceLocations.splice(c,1),this._currentInstanceBuffers.splice(c,1),d=!0,c=this._currentInstanceLocations.indexOf(C);d&&(this._gl.vertexAttribDivisor(C,0),this.disableAttributeByIndex(C))}disableAttributeByIndex(C){this._gl.disableVertexAttribArray(C),this._vertexAttribArraysEnabled[C]=!1,this._currentBufferPointers[C].active=!1}draw(C,c,d,b){this.drawElementsType(C?0:1,c,d,b)}drawPointClouds(C,c,d){this.drawArraysType(2,C,c,d)}drawUnIndexed(C,c,d,b){this.drawArraysType(C?0:1,c,d,b)}drawElementsType(C,c,d,b){this.applyStates(),this._reportDrawCall();const X=this._drawMode(C),P=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,V=this._uintIndicesCurrentlySet?4:2;b?this._gl.drawElementsInstanced(X,d,P,c*V,b):this._gl.drawElements(X,d,P,c*V)}drawArraysType(C,c,d,b){this.applyStates(),this._reportDrawCall();const X=this._drawMode(C);b?this._gl.drawArraysInstanced(X,c,d,b):this._gl.drawArrays(X,c,d)}_drawMode(C){switch(C){case 0:default:return this._gl.TRIANGLES;case 2:case 3:return this._gl.POINTS;case 1:case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN}}_releaseEffect(C){this._compiledEffects[C._key]&&delete this._compiledEffects[C._key];const c=C.getPipelineContext();c&&this._deletePipelineContext(c)}_deletePipelineContext(C){const c=C;c&&c.program&&(c.program.__SPECTOR_rebuildProgram=null,(0,B.i)(c),this._gl&&(this._currentProgram===c.program&&this._setProgram(null),this._gl.deleteProgram(c.program)))}_getGlobalDefines(C){return(0,q.k)(C,this.isNDCHalfZRange,this.o,this.useExactSrgbConversions)}createEffect(C,c,d,X,P,V,R,p,j){let g=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,k=arguments.length>10?arguments[10]:void 0;const Z="string"===typeof C?C:C.vertexToken||C.vertexSource||C.vertexElement||C.vertex,U="string"===typeof C?C:C.fragmentToken||C.fragmentSource||C.fragmentElement||C.fragment,A=this._getGlobalDefines(),q=void 0!==c.attributes;let B=P??c.defines??"";A&&(B+=A);const t=Z+"+"+U+"@"+B;if(this._compiledEffects[t]){const C=this._compiledEffects[t];return R&&C.isReady()&&R(C),C._refCount++,C}this._gl&&(0,b.D)(this._gl);const e=new u.Effect(C,c,q?this:d,X,this,P,V,R,p,j,t,c.shaderLanguage??g,c.extraInitializationsAsync??k);return this._compiledEffects[t]=e,e}_getShaderSource(C){return this._gl.getShaderSource(C)}createRawShaderProgram(C,c,d,X){let P=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const V=(0,b.D)(this._gl);return V._contextWasLost=this._contextWasLost,V.validateShaderPrograms=this.validateShaderPrograms,(0,b.v)(C,c,d,X||this._gl,P)}createShaderProgram(C,c,d,X,P){let V=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;const R=(0,b.D)(this._gl);return R._contextWasLost=this._contextWasLost,R.validateShaderPrograms=this.validateShaderPrograms,(0,b.z)(C,c,d,X,P||this._gl,V)}inlineShaderCode(C){return C}createPipelineContext(C){if(this._gl){(0,b.D)(this._gl).parallelShaderCompile=this._caps.parallelShaderCompile}const c=(0,b.s)(this._gl,C);return c.Gc=this,c}createMaterialContext(){}createDrawContext(){}_finalizePipelineContext(C){return(0,b.i)(C,this._gl,this.validateShaderPrograms)}_preparePipelineContextAsync(C,c,d,X,P,V,R,p,j,g,k){const Z=(0,b.D)(this._gl);return Z._contextWasLost=this._contextWasLost,Z.validateShaderPrograms=this.validateShaderPrograms,Z._createShaderProgramInjection=this._createShaderProgram.bind(this),Z.createRawShaderProgramInjection=this.createRawShaderProgram.bind(this),Z.createShaderProgramInjection=this.createShaderProgram.bind(this),Z.loadFileInjection=this._loadFile.bind(this),(0,b.n)(C,c,d,X,P,V,R,p,j,g,k)}_createShaderProgram(C,c,d,X){let P=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return(0,b.d)(C,c,d,X,P)}_isRenderingStateCompiled(C){return!this._isDisposed&&(0,b.m)(C,this._gl,this.validateShaderPrograms)}_executeWhenRenderingStateIsCompiled(C,c){(0,b.e)(C,c)}getUniforms(C,c){const d=new Array,b=C;for(let X=0;X<c.length;X++)d.push(this._gl.getUniformLocation(b.program,c[X]));return d}getAttributes(C,c){const d=[],b=C;for(let P=0;P<c.length;P++)try{d.push(this._gl.getAttribLocation(b.program,c[P]))}catch(X){d.push(-1)}return d}enableEffect(C){(C=null!==C&&(0,X.b)(C)?C.effect:C)&&C!==this._currentEffect&&(this._stencilStateComposer.stencilMaterial=void 0,this.bindSamplers(C),this._currentEffect=C,C.onBind&&C.onBind(C),C._onBindObservable&&C._onBindObservable.notifyObservers(C))}setInt(C,c){return!!C&&(this._gl.uniform1i(C,c),!0)}setInt2(C,c,d){return!!C&&(this._gl.uniform2i(C,c,d),!0)}setInt3(C,c,d,b){return!!C&&(this._gl.uniform3i(C,c,d,b),!0)}setInt4(C,c,d,b,X){return!!C&&(this._gl.uniform4i(C,c,d,b,X),!0)}setIntArray(C,c){return!!C&&(this._gl.uniform1iv(C,c),!0)}setIntArray2(C,c){return!(!C||c.length%2!==0)&&(this._gl.uniform2iv(C,c),!0)}setIntArray3(C,c){return!(!C||c.length%3!==0)&&(this._gl.uniform3iv(C,c),!0)}setIntArray4(C,c){return!(!C||c.length%4!==0)&&(this._gl.uniform4iv(C,c),!0)}setUInt(C,c){return!!C&&(this._gl.uniform1ui(C,c),!0)}setUInt2(C,c,d){return!!C&&(this._gl.uniform2ui(C,c,d),!0)}setUInt3(C,c,d,b){return!!C&&(this._gl.uniform3ui(C,c,d,b),!0)}setUInt4(C,c,d,b,X){return!!C&&(this._gl.uniform4ui(C,c,d,b,X),!0)}setUIntArray(C,c){return!!C&&(this._gl.uniform1uiv(C,c),!0)}setUIntArray2(C,c){return!(!C||c.length%2!==0)&&(this._gl.uniform2uiv(C,c),!0)}setUIntArray3(C,c){return!(!C||c.length%3!==0)&&(this._gl.uniform3uiv(C,c),!0)}setUIntArray4(C,c){return!(!C||c.length%4!==0)&&(this._gl.uniform4uiv(C,c),!0)}setArray(C,c){return!!C&&(!(c.length<1)&&(this._gl.uniform1fv(C,c),!0))}setArray2(C,c){return!(!C||c.length%2!==0)&&(this._gl.uniform2fv(C,c),!0)}setArray3(C,c){return!(!C||c.length%3!==0)&&(this._gl.uniform3fv(C,c),!0)}setArray4(C,c){return!(!C||c.length%4!==0)&&(this._gl.uniform4fv(C,c),!0)}setMatrices(C,c){return!!C&&(this._gl.uniformMatrix4fv(C,!1,c),!0)}setMatrix3x3(C,c){return!!C&&(this._gl.uniformMatrix3fv(C,!1,c),!0)}setMatrix2x2(C,c){return!!C&&(this._gl.uniformMatrix2fv(C,!1,c),!0)}setFloat(C,c){return!!C&&(this._gl.uniform1f(C,c),!0)}setFloat2(C,c,d){return!!C&&(this._gl.uniform2f(C,c,d),!0)}setFloat3(C,c,d,b){return!!C&&(this._gl.uniform3f(C,c,d,b),!0)}setFloat4(C,c,d,b,X){return!!C&&(this._gl.uniform4f(C,c,d,b,X),!0)}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;const C=this._colorWrite;this._gl.colorMask(C,C,C,C)}}wipeCaches(C){this.preventCacheWipeBetweenFrames&&!C||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),C&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(C,c){const d=this._gl;let b=d.NEAREST,X=d.NEAREST,P=!1;switch(C){case 11:b=d.LINEAR,X=c?d.LINEAR_MIPMAP_NEAREST:d.LINEAR;break;case 3:b=d.LINEAR,P=!0,X=c?d.LINEAR_MIPMAP_LINEAR:d.LINEAR;break;case 8:P=!0,b=d.NEAREST,X=c?d.NEAREST_MIPMAP_LINEAR:d.NEAREST;break;case 4:b=d.NEAREST,X=c?d.NEAREST_MIPMAP_NEAREST:d.NEAREST;break;case 5:b=d.NEAREST,X=c?d.LINEAR_MIPMAP_NEAREST:d.LINEAR;break;case 6:P=!0,b=d.NEAREST,X=c?d.LINEAR_MIPMAP_LINEAR:d.LINEAR;break;case 7:b=d.NEAREST,X=d.LINEAR;break;case 1:b=d.NEAREST,X=d.NEAREST;break;case 9:b=d.LINEAR,X=c?d.NEAREST_MIPMAP_NEAREST:d.NEAREST;break;case 10:P=!0,b=d.LINEAR,X=c?d.NEAREST_MIPMAP_LINEAR:d.NEAREST;break;case 2:b=d.LINEAR,X=d.LINEAR;break;case 12:b=d.LINEAR,X=d.NEAREST}return{min:X,mag:b,hasMipMaps:P}}_createTexture(){const C=this._gl.createTexture();if(!C)throw new Error("Unable to create texture");return C}_createHardwareTexture(){return new U.b(this._createTexture(),this._gl)}_createInternalTexture(C,c){let d,b=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,X=!1,V=!1,R=0,p=3,j=5,g=!1,k=1,Z=!1,U=0;void 0!==c&&"object"===typeof c?(X=!!c.generateMipMaps,V=!!c.createMipMaps,R=void 0===c.type?0:c.type,p=void 0===c.samplingMode?3:c.samplingMode,j=void 0===c.format?5:c.format,g=void 0!==c.useSRGBBuffer&&c.useSRGBBuffer,k=c.samples??1,d=c.label,Z=!!c.createMSAATexture,U=c.comparisonFunction||0):X=!!c,g&&(g=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(1!==R||this._caps.textureFloatLinearFiltering)&&(2!==R||this._caps.textureHalfFloatLinearFiltering)||(p=1),1!==R||this._caps.textureFloat||(R=0,P.d.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const u=(0,t.c)(j),q=(0,t.b)(j),B=this._gl,e=new A.d(this,b),n=C.width||C,W=C.height||C,E=C.depth||0,N=C.layers||0,r=this._getSamplingParameters(p,(X||V)&&!u),M=0!==N?B.TEXTURE_2D_ARRAY:0!==E?B.TEXTURE_3D:B.TEXTURE_2D,K=u?this._getInternalFormatFromDepthTextureFormat(j,!0,q):this._getRGBABufferInternalSizedFormat(R,j,g),i=u?q?B.DEPTH_STENCIL:B.DEPTH_COMPONENT:this._getInternalFormat(j),h=u?this._getWebGLTextureTypeFromDepthTextureFormat(j):this._getWebGLTextureType(R);if(this._bindTextureDirectly(M,e),0!==N?(e.is2DArray=!0,B.texImage3D(M,0,K,n,W,N,0,i,h,null)):0!==E?(e.is3D=!0,B.texImage3D(M,0,K,n,W,E,0,i,h,null)):B.texImage2D(M,0,K,n,W,0,i,h,null),B.texParameteri(M,B.TEXTURE_MAG_FILTER,r.mag),B.texParameteri(M,B.TEXTURE_MIN_FILTER,r.min),B.texParameteri(M,B.TEXTURE_WRAP_S,B.CLAMP_TO_EDGE),B.texParameteri(M,B.TEXTURE_WRAP_T,B.CLAMP_TO_EDGE),u&&this.webGLVersion>1&&(0===U?(B.texParameteri(M,B.TEXTURE_COMPARE_FUNC,515),B.texParameteri(M,B.TEXTURE_COMPARE_MODE,B.NONE)):(B.texParameteri(M,B.TEXTURE_COMPARE_FUNC,U),B.texParameteri(M,B.TEXTURE_COMPARE_MODE,B.COMPARE_REF_TO_TEXTURE))),(X||V)&&this._gl.generateMipmap(M),this._bindTextureDirectly(M,null),e._useSRGBBuffer=g,e.baseWidth=n,e.baseHeight=W,e.width=n,e.height=W,e.depth=N||E,e.isReady=!0,e.samples=k,e.generateMipMaps=X,e.samplingMode=p,e.type=R,e.format=j,e.label=d,e.comparisonFunction=U,this._internalTexturesCache.push(e),Z){let C=null;if(C=(0,t.c)(e.format)?this._setupFramebufferDepthAttachments((0,t.b)(e.format),19!==e.format,e.width,e.height,k,e.format,!0):this._createRenderBuffer(e.width,e.height,k,-1,this._getRGBABufferInternalSizedFormat(e.type,e.format,e._useSRGBBuffer),-1),!C)throw new Error("Unable to create render buffer");e._autoMSAAManagement=!0;let c=e._hardwareTexture;c||(c=e._hardwareTexture=this._createHardwareTexture()),c.addMSAARenderBuffer(C)}return e}_getUseSRGBBuffer(C,c){return C&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||c)}createTexture(C,c,d,b){var X=this;let P=arguments.length>4&&void 0!==arguments[4]?arguments[4]:3,V=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,R=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,p=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,j=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,g=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,k=arguments.length>10&&void 0!==arguments[10]?arguments[10]:null,Z=arguments.length>11?arguments[11]:void 0,U=arguments.length>12?arguments[12]:void 0,u=arguments.length>13?arguments[13]:void 0,q=arguments.length>14?arguments[14]:void 0;return this._createTextureBase(C,c,d,b,P,V,R,(function(){for(var C=arguments.length,c=new Array(C),d=0;d<C;d++)c[d]=arguments[d];return X._prepareWebGLTexture(...c,g)}),((C,c,d,X,P,V)=>{const R=this._gl,p=d.width===C&&d.height===c;P._creationFlags=u??0;const j=this._getTexImageParametersForCreateTexture(P.format,P._useSRGBBuffer);if(p)return R.texImage2D(R.TEXTURE_2D,0,j.internalFormat,j.format,j.type,d),!1;const g=this._caps.maxTextureSize;if(d.width>g||d.height>g||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!(!this._workingCanvas||!this._workingContext)&&(this._workingCanvas.width=C,this._workingCanvas.height=c,this._workingContext.drawImage(d,0,0,d.width,d.height,0,0,C,c),R.texImage2D(R.TEXTURE_2D,0,j.internalFormat,j.format,j.type,this._workingCanvas),P.width=C,P.height=c,!1);{const C=new A.d(this,2);this._bindTextureDirectly(R.TEXTURE_2D,C,!0),R.texImage2D(R.TEXTURE_2D,0,j.internalFormat,j.format,j.type,d),this._rescaleTexture(C,P,b,j.format,(()=>{this._releaseTexture(C),this._bindTextureDirectly(R.TEXTURE_2D,P,!0),V()}))}return!0}),p,j,g,k,Z,U,q)}_getTexImageParametersForCreateTexture(C,c){let d,b;return 1===this.webGLVersion?(d=this._getInternalFormat(C,c),b=d):(d=this._getInternalFormat(C,!1),b=this._getRGBABufferInternalSizedFormat(0,C,c)),{internalFormat:b,format:d,type:this._gl.UNSIGNED_BYTE}}_rescaleTexture(C,c,d,b,X){}_unpackFlipY(C){this._unpackFlipYCached!==C&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,C?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=C))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(C){return C.isCube?this._gl.TEXTURE_CUBE_MAP:C.is3D?this._gl.TEXTURE_3D:C.is2DArray||C.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(C,c){let d=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const b=this._getTextureTarget(c),X=this._getSamplingParameters(C,c.useMipMaps||d);this._setTextureParameterInteger(b,this._gl.TEXTURE_MAG_FILTER,X.mag,c),this._setTextureParameterInteger(b,this._gl.TEXTURE_MIN_FILTER,X.min),d&&X.hasMipMaps&&(c.generateMipMaps=!0,this._gl.generateMipmap(b)),this._bindTextureDirectly(b,null),c.samplingMode=C}updateTextureDimensions(C,c,d){}updateTextureWrappingMode(C,c){let d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,b=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;const X=this._getTextureTarget(C);null!==c&&(this._setTextureParameterInteger(X,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(c),C),C._cachedWrapU=c),null!==d&&(this._setTextureParameterInteger(X,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(d),C),C._cachedWrapV=d),(C.is2DArray||C.is3D)&&null!==b&&(this._setTextureParameterInteger(X,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(b),C),C._cachedWrapR=b),this._bindTextureDirectly(X,null)}_uploadCompressedDataToTextureDirectly(C,c,d,b,X){let P=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,V=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;const R=this._gl;let p=R.TEXTURE_2D;if(C.isCube&&(p=R.TEXTURE_CUBE_MAP_POSITIVE_X+P),C._useSRGBBuffer)switch(c){case 37492:case 36196:this._caps.etc2?c=R.COMPRESSED_SRGB8_ETC2:C._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?c=R.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:C._useSRGBBuffer=!1;break;case 36492:c=R.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:c=R.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?c=R.COMPRESSED_SRGB_S3TC_DXT1_EXT:C._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?c=R.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:C._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?c=R.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:C._useSRGBBuffer=!1;break;default:C._useSRGBBuffer=!1}this._gl.compressedTexImage2D(p,V,c,d,b,0,X)}_uploadDataToTextureDirectly(C,c){let d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,b=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,X=arguments.length>4?arguments[4]:void 0,P=arguments.length>5&&void 0!==arguments[5]&&arguments[5];const V=this._gl,R=this._getWebGLTextureType(C.type),p=this._getInternalFormat(C.format),j=void 0===X?this._getRGBABufferInternalSizedFormat(C.type,C.format,C._useSRGBBuffer):this._getInternalFormat(X,C._useSRGBBuffer);this._unpackFlipY(C.invertY);let g=V.TEXTURE_2D;C.isCube&&(g=V.TEXTURE_CUBE_MAP_POSITIVE_X+d);const k=Math.round(Math.log(C.width)*Math.LOG2E),Z=Math.round(Math.log(C.height)*Math.LOG2E),U=P?C.width:Math.pow(2,Math.max(k-b,0)),A=P?C.height:Math.pow(2,Math.max(Z-b,0));V.texImage2D(g,b,j,U,A,0,p,R,c)}updateTextureData(C,c,d,b,X,P){let V=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,R=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,p=arguments.length>8&&void 0!==arguments[8]&&arguments[8];const j=this._gl,g=this._getWebGLTextureType(C.type),k=this._getInternalFormat(C.format);this._unpackFlipY(C.invertY);let Z=j.TEXTURE_2D,U=j.TEXTURE_2D;C.isCube&&(U=j.TEXTURE_CUBE_MAP_POSITIVE_X+V,Z=j.TEXTURE_CUBE_MAP),this._bindTextureDirectly(Z,C,!0),j.texSubImage2D(U,R,d,b,X,P,k,g,c),p&&this._gl.generateMipmap(U),this._bindTextureDirectly(Z,null)}_uploadArrayBufferViewToTexture(C,c){let d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,b=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const X=this._gl,P=C.isCube?X.TEXTURE_CUBE_MAP:X.TEXTURE_2D;this._bindTextureDirectly(P,C,!0),this._uploadDataToTextureDirectly(C,c,d,b),this._bindTextureDirectly(P,null,!0)}_prepareWebGLTextureContinuation(C,c,d,b,X){const P=this._gl;if(!P)return;const V=this._getSamplingParameters(X,!d);P.texParameteri(P.TEXTURE_2D,P.TEXTURE_MAG_FILTER,V.mag),P.texParameteri(P.TEXTURE_2D,P.TEXTURE_MIN_FILTER,V.min),d||b||P.generateMipmap(P.TEXTURE_2D),this._bindTextureDirectly(P.TEXTURE_2D,null),c&&c.removePendingData(C),C.onLoadedObservable.notifyObservers(C),C.onLoadedObservable.clear()}_prepareWebGLTexture(C,c,d,b,X,P,V,R,p,j){const g=this.getCaps().maxTextureSize,Z=Math.min(g,this.needPOTTextures?(0,k.g)(b.width,g):b.width),U=Math.min(g,this.needPOTTextures?(0,k.g)(b.height,g):b.height),A=this._gl;A&&(C._hardwareTexture?(this._bindTextureDirectly(A.TEXTURE_2D,C,!0),this._unpackFlipY(void 0===X||!!X),C.baseWidth=b.width,C.baseHeight=b.height,C.width=Z,C.height=U,C.isReady=!0,C.type=-1!==C.type?C.type:0,C.format=-1!==C.format?C.format:j??(".jpg"!==c||C._useSRGBBuffer?5:4),R(Z,U,b,c,C,(()=>{this._prepareWebGLTextureContinuation(C,d,P,V,p)}))||this._prepareWebGLTextureContinuation(C,d,P,V,p)):d&&d.removePendingData(C))}_getInternalFormatFromDepthTextureFormat(C,c,d){const b=this._gl;if(!c)return b.STENCIL_INDEX8;let X=d?b.DEPTH_STENCIL:b.DEPTH_COMPONENT;return this.webGLVersion>1?15===C?X=b.DEPTH_COMPONENT16:16===C?X=b.DEPTH_COMPONENT24:17===C||13===C?X=d?b.DEPTH24_STENCIL8:b.DEPTH_COMPONENT24:14===C?X=b.DEPTH_COMPONENT32F:18===C&&(X=d?b.DEPTH32F_STENCIL8:b.DEPTH_COMPONENT32F):X=b.DEPTH_COMPONENT16,X}_getWebGLTextureTypeFromDepthTextureFormat(C){const c=this._gl;let d=c.UNSIGNED_INT;return 15===C?d=c.UNSIGNED_SHORT:17===C||13===C?d=c.UNSIGNED_INT_24_8:14===C?d=c.FLOAT:18===C?d=c.FLOAT_32_UNSIGNED_INT_24_8_REV:19===C&&(d=c.UNSIGNED_BYTE),d}_setupFramebufferDepthAttachments(C,c,d,b){let X=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,P=arguments.length>5?arguments[5]:void 0,V=arguments.length>6&&void 0!==arguments[6]&&arguments[6];const R=this._gl;P=P??(C?13:14);const p=this._getInternalFormatFromDepthTextureFormat(P,c,C);return C&&c?this._createRenderBuffer(d,b,X,R.DEPTH_STENCIL,p,V?-1:R.DEPTH_STENCIL_ATTACHMENT):c?this._createRenderBuffer(d,b,X,p,p,V?-1:R.DEPTH_ATTACHMENT):C?this._createRenderBuffer(d,b,X,p,p,V?-1:R.STENCIL_ATTACHMENT):null}_createRenderBuffer(C,c,d,b,X,P){let V=!(arguments.length>6&&void 0!==arguments[6])||arguments[6];const R=this._gl.createRenderbuffer();return this._updateRenderBuffer(R,C,c,d,b,X,P,V)}_updateRenderBuffer(C,c,d,b,X,P,V){let R=!(arguments.length>7&&void 0!==arguments[7])||arguments[7];const p=this._gl;return p.bindRenderbuffer(p.RENDERBUFFER,C),b>1&&p.renderbufferStorageMultisample?p.renderbufferStorageMultisample(p.RENDERBUFFER,b,P,c,d):p.renderbufferStorage(p.RENDERBUFFER,X,c,d),-1!==V&&p.framebufferRenderbuffer(p.FRAMEBUFFER,V,p.RENDERBUFFER,C),R&&p.bindRenderbuffer(p.RENDERBUFFER,null),C}_releaseTexture(C){this._deleteTexture(C._hardwareTexture),this.unbindAllTextures();const c=this._internalTexturesCache.indexOf(C);-1!==c&&this._internalTexturesCache.splice(c,1),C._lodTextureHigh&&C._lodTextureHigh.dispose(),C._lodTextureMid&&C._lodTextureMid.dispose(),C._lodTextureLow&&C._lodTextureLow.dispose(),C._irradianceTexture&&C._irradianceTexture.dispose()}_deleteTexture(C){null===C||void 0===C||C.release()}_setProgram(C){this._currentProgram!==C&&((0,b.o)(C,this._gl),this._currentProgram=C)}bindSamplers(C){const c=C.getPipelineContext();this._setProgram(c.program);const d=C.getSamplers();for(let b=0;b<d.length;b++){const c=C.getUniform(d[b]);c&&(this._boundUniforms[b]=c)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(C,c){let d=arguments.length>2&&void 0!==arguments[2]&&arguments[2],b=arguments.length>3&&void 0!==arguments[3]&&arguments[3],X=!1;const V=c&&c._associatedChannel>-1;d&&V&&(this._activeChannel=c._associatedChannel);if(this._boundTexturesCache[this._activeChannel]!==c||b){if(this._activateCurrentTexture(),c&&c.isMultiview)throw P.d.Error(["_bindTextureDirectly called with a multiview texture!",C,c]),"_bindTextureDirectly called with a multiview texture!";var R;this._gl.bindTexture(C,(null===c||void 0===c||null===(R=c._hardwareTexture)||void 0===R?void 0:R.underlyingResource)??null),this._boundTexturesCache[this._activeChannel]=c,c&&(c._associatedChannel=this._activeChannel)}else d&&(X=!0,this._activateCurrentTexture());return V&&!d&&this._bindSamplerUniformToChannel(c._associatedChannel,this._activeChannel),X}_bindTexture(C,c,d){if(void 0===C)return;c&&(c._associatedChannel=C),this._activeChannel=C;const b=c?this._getTextureTarget(c):this._gl.TEXTURE_2D;this._bindTextureDirectly(b,c)}unbindAllTextures(){for(let C=0;C<this._maxSimultaneousTextures;C++)this._activeChannel=C,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(C,c,d,b){void 0!==C&&(c&&(this._boundUniforms[C]=c),this._setTexture(C,d))}_bindSamplerUniformToChannel(C,c){const d=this._boundUniforms[C];d&&d._currentState!==c&&(this._gl.uniform1i(d,c),d._currentState=c)}_getTextureWrapMode(C){switch(C){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(C,c){let d,b=arguments.length>2&&void 0!==arguments[2]&&arguments[2],X=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!c)return null!=this._boundTexturesCache[C]&&(this._activeChannel=C,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(c.video){this._activeChannel=C;const d=c.getInternalTexture();d&&(d._associatedChannel=C),c.update()}else if(4===c.delayLoadState)return c.delayLoad(),!1;d=X?c.depthStencilTexture:c.isReady()?c.getInternalTexture():c.isCube?this.emptyCubeTexture:c.is3D?this.emptyTexture3D:c.is2DArray?this.emptyTexture2DArray:this.emptyTexture,!b&&d&&(d._associatedChannel=C);let P=!0;this._boundTexturesCache[C]===d&&(b||this._bindSamplerUniformToChannel(d._associatedChannel,C),P=!1),this._activeChannel=C;const V=this._getTextureTarget(d);if(P&&this._bindTextureDirectly(V,d,b),d&&!d.isMultiview){if(d.isCube&&d._cachedCoordinatesMode!==c.coordinatesMode){d._cachedCoordinatesMode=c.coordinatesMode;const C=3!==c.coordinatesMode&&5!==c.coordinatesMode?1:0;c.wrapU=C,c.wrapV=C}d._cachedWrapU!==c.wrapU&&(d._cachedWrapU=c.wrapU,this._setTextureParameterInteger(V,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(c.wrapU),d)),d._cachedWrapV!==c.wrapV&&(d._cachedWrapV=c.wrapV,this._setTextureParameterInteger(V,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(c.wrapV),d)),d.is3D&&d._cachedWrapR!==c.wrapR&&(d._cachedWrapR=c.wrapR,this._setTextureParameterInteger(V,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(c.wrapR),d)),this._setAnisotropicLevel(V,d,c.anisotropicFilteringLevel)}return!0}setTextureArray(C,c,d,b){if(void 0!==C&&c){this._textureUnits&&this._textureUnits.length===d.length||(this._textureUnits=new Int32Array(d.length));for(let c=0;c<d.length;c++){const b=d[c].getInternalTexture();b?(this._textureUnits[c]=C+c,b._associatedChannel=C+c):this._textureUnits[c]=-1}this._gl.uniform1iv(c,this._textureUnits);for(let C=0;C<d.length;C++)this._setTexture(this._textureUnits[C],d[C],!0)}}_setAnisotropicLevel(C,c,d){const b=this._caps.textureAnisotropicFilterExtension;11!==c.samplingMode&&3!==c.samplingMode&&2!==c.samplingMode&&(d=1),b&&c._cachedAnisotropicFilteringLevel!==d&&(this._setTextureParameterFloat(C,b.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(d,this._caps.maxAnisotropy),c),c._cachedAnisotropicFilteringLevel=d)}_setTextureParameterFloat(C,c,d,b){this._bindTextureDirectly(C,b,!0,!0),this._gl.texParameterf(C,c,d)}_setTextureParameterInteger(C,c,d,b){b&&this._bindTextureDirectly(C,b,!0,!0),this._gl.texParameteri(C,c,d)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let C=0;C<this._caps.maxVertexAttribs;C++)this.disableAttributeByIndex(C)}else for(let C=0,c=this._vertexAttribArraysEnabled.length;C<c;C++)C>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[C]||this.disableAttributeByIndex(C)}releaseEffects(){this._compiledEffects={},this.onReleaseEffectsObservable.notifyObservers(this)}dispose(){var C;((0,V.l)()&&this._renderingCanvas&&(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._onContextRestored&&this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),super.dispose(),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.unbindAllAttributes(),this._boundUniforms={},this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._currentProgram=null,this._creationOptions.loseContextOnDispose)&&(null===(C=this._gl.getExtension("WEBGL_lose_context"))||void 0===C||C.loseContext());(0,b.A)(this._gl)}attachContextLostEvent(C){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",C,!1)}attachContextRestoredEvent(C){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",C,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(C){const c=this._gl;for(;c.getError()!==c.NO_ERROR;);let d=!0;const b=c.createTexture();c.bindTexture(c.TEXTURE_2D,b),c.texImage2D(c.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(C),1,1,0,c.RGBA,this._getWebGLTextureType(C),null),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST);const X=c.createFramebuffer();c.bindFramebuffer(c.FRAMEBUFFER,X),c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,b,0);const P=c.checkFramebufferStatus(c.FRAMEBUFFER);if(d=d&&P===c.FRAMEBUFFER_COMPLETE,d=d&&c.getError()===c.NO_ERROR,d&&(c.clear(c.COLOR_BUFFER_BIT),d=d&&c.getError()===c.NO_ERROR),d){c.bindFramebuffer(c.FRAMEBUFFER,null);const C=c.RGBA,b=c.UNSIGNED_BYTE,X=new Uint8Array(4);c.readPixels(0,0,1,1,C,b,X),d=d&&c.getError()===c.NO_ERROR}for(c.deleteTexture(b),c.deleteFramebuffer(X),c.bindFramebuffer(c.FRAMEBUFFER,null);!d&&c.getError()!==c.NO_ERROR;);return d}_getWebGLTextureType(C){if(1===this._webGLVersion){switch(C){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(C){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(C){let c=arguments.length>1&&void 0!==arguments[1]&&arguments[1],d=c?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;switch(C){case 0:d=this._gl.ALPHA;break;case 1:d=this._gl.LUMINANCE;break;case 2:d=this._gl.LUMINANCE_ALPHA;break;case 6:case 33322:case 36760:d=this._gl.RED;break;case 7:case 33324:case 36761:d=this._gl.RG;break;case 4:case 32852:case 36762:d=c?this._glSRGBExtensionValues.SRGB:this._gl.RGB;break;case 5:case 32859:case 36763:d=c?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA}if(this._webGLVersion>1)switch(C){case 8:d=this._gl.RED_INTEGER;break;case 9:d=this._gl.RG_INTEGER;break;case 10:d=this._gl.RGB_INTEGER;break;case 11:d=this._gl.RGBA_INTEGER}return d}_getRGBABufferInternalSizedFormat(C,c){let d=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(1===this._webGLVersion){if(void 0!==c)switch(c){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return d?this._glSRGBExtensionValues.SRGB:this._gl.RGB}return this._gl.RGBA}switch(C){case 3:switch(c){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(c){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return d?this._glSRGBExtensionValues.SRGB8:this._gl.RGB8;case 5:return d?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(c){case 8:return this._gl.R16I;case 36760:return this._gl.R16_SNORM_EXT;case 36761:return this._gl.RG16_SNORM_EXT;case 36762:return this._gl.RGB16_SNORM_EXT;case 36763:return this._gl.RGBA16_SNORM_EXT;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;default:return this._gl.RGBA16I}case 5:switch(c){case 8:return this._gl.R16UI;case 33322:return this._gl.R16_EXT;case 33324:return this._gl.RG16_EXT;case 32852:return this._gl.RGB16_EXT;case 32859:return this._gl.RGBA16_EXT;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;default:return this._gl.RGBA16UI}case 6:switch(c){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;default:return this._gl.RGBA32I}case 7:switch(c){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;default:return this._gl.RGBA32UI}case 1:switch(c){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;default:return this._gl.RGBA32F}case 2:switch(c){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(c){case 5:default:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI}}return d?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8}readPixels(C,c,d,b){let X=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],V=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],R=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;const p=X?4:3,j=X?this._gl.RGBA:this._gl.RGB,g=d*b*p;if(R){if(R.length<g)return P.d.Error(`Data buffer is too small to store the read pixels (${R.length} should be more than ${g})`),Promise.resolve(R)}else R=new Uint8Array(g);return V&&this.flushFramebuffer(),this._gl.readPixels(C,c,d,b,j,this._gl.UNSIGNED_BYTE,R),Promise.resolve(R)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(null!==this._HasMajorPerformanceCaveat)return!this._HasMajorPerformanceCaveat;if(null===this._IsSupported)try{const C=Z.c._CreateCanvas(1,1),c=C.getContext("webgl")||C.getContext("experimental-webgl");this._IsSupported=null!=c&&!!window.WebGLRenderingContext}catch(C){this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(null===this._HasMajorPerformanceCaveat)try{const C=Z.c._CreateCanvas(1,1),c=C.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||C.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!c}catch(C){this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}}n._TempClearColorUint32=new Uint32Array(4),n._TempClearColorInt32=new Int32Array(4),n.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/12\\d\\..+?Mobile",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}],n._ConcatenateShader=q.h,n._IsSupported=null,n._HasMajorPerformanceCaveat=null},12456:(C,c,d)=>{d.d(c,{c:()=>U});var b=d(12221),X=d(12403),P=d(12375),V=d(12462),R=d(12361),p=d(12289),j=d(12233),g=d(12489),k=d(12416);class Z{get renderList(){return this._renderList}set renderList(C){this._renderList!==C&&(this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),C&&(this._unObserveRenderList=(0,k.e)(C,this._renderListHasChanged)),this._renderList=C)}get disableImageProcessing(){return this._disableImageProcessing}set disableImageProcessing(C){C!==this._disableImageProcessing&&(this._disableImageProcessing=C,this._scene.markAllMaterialsAsDirty(64))}get name(){return this._name}set name(C){if(this._name===C)return;if(this._name=C,!this._scene)return;const c=this._scene.getEngine();for(let d=0;d<this._renderPassIds.length;++d){const C=this._renderPassIds[d];c._renderPassNames[C]=`${this._name}#${d}`}}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}setMaterialForRendering(C,c){let d;d=Array.isArray(C)?C:[C];for(let b=0;b<d.length;++b)for(let C=0;C<this.options.numPasses;++C){let X=d[b];d[b].isAnInstance&&(X=d[b].sourceMesh),X.setMaterialForRenderPass(this._renderPassIds[C],void 0!==c?Array.isArray(c)?c[C]:c:void 0)}}constructor(C,c,d){this._unObserveRenderList=null,this._renderListHasChanged=(C,c)=>{const d=this._renderList?this._renderList.length:0;if(0===c&&d>0||0===d)for(const b of this._scene.meshes)b._markSubMeshesAsLightDirty()},this.particleSystemList=null,this.getCustomRenderList=null,this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this._disableImageProcessing=!1,this.onBeforeRenderObservable=new b.b,this.onAfterRenderObservable=new b.b,this.onBeforeRenderingManagerRenderObservable=new b.b,this.onAfterRenderingManagerRenderObservable=new b.b,this.onFastPathRenderObservable=new b.b,this._currentRefreshId=-1,this._refreshRate=1,this._currentApplyByPostProcessSetting=!1,this._currentSceneCamera=null,this.name=C,this._scene=c,this.renderList=[],this._renderPassIds=[],this.options={numPasses:1,doNotChangeAspectRatio:!0,...d},this._createRenderPassId(),this.renderPassId=this._renderPassIds[0],this._renderingManager=new g.c(c),this._renderingManager._useSceneAutoClearSetup=!0}_releaseRenderPassId(){const C=this._scene.getEngine();for(let c=0;c<this.options.numPasses;++c)C.releaseRenderPassId(this._renderPassIds[c]);this._renderPassIds.length=0}_createRenderPassId(){this._releaseRenderPassId();const C=this._scene.getEngine();for(let c=0;c<this.options.numPasses;++c)this._renderPassIds[c]=C.createRenderPassId(`${this.name}#${c}`)}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(C){this._refreshRate=C,this.resetRefreshCounter()}shouldRender(){return-1===this._currentRefreshId||this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}isReadyForRendering(C,c){this.prepareRenderList(),this.initRender(C,c);const d=this._checkReadiness();return this.finishRender(),d}prepareRenderList(){const C=this._scene;if(this._waitingRenderList){if(!this.renderListPredicate){this.renderList=[];for(let c=0;c<this._waitingRenderList.length;c++){const d=this._waitingRenderList[c],b=C.getMeshById(d);b&&this.renderList.push(b)}}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const C=this._scene.meshes;for(let c=0;c<C.length;c++){const d=C[c];this.renderListPredicate(d)&&this.renderList.push(d)}}this._currentApplyByPostProcessSetting=this._scene.imageProcessingConfiguration.applyByPostProcess,this._disableImageProcessing&&(this._scene.imageProcessingConfiguration._applyByPostProcess=this._disableImageProcessing)}initRender(C,c){const d=this._scene.getEngine(),b=this.activeCamera??this._scene.activeCamera;this._currentSceneCamera=this._scene.activeCamera,b&&(b!==this._scene.activeCamera&&(this._scene.setTransformMatrix(b.getViewMatrix(),b.getProjectionMatrix(!0)),this._scene.activeCamera=b),d.setViewport(b.rigParent?b.rigParent.viewport:b.viewport,C,c)),this._defaultRenderListPrepared=!1}finishRender(){const C=this._scene;this._disableImageProcessing&&(C.imageProcessingConfiguration._applyByPostProcess=this._currentApplyByPostProcessSetting),C.activeCamera=this._currentSceneCamera,this._currentSceneCamera&&(this.activeCamera&&this.activeCamera!==C.activeCamera&&C.setTransformMatrix(this._currentSceneCamera.getViewMatrix(),this._currentSceneCamera.getProjectionMatrix(!0)),C.getEngine().setViewport(this._currentSceneCamera.viewport)),C.resetCachedMaterial()}render(){let C=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,c=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const d=this._scene,b=d.getEngine(),X=b.currentRenderPassId;b.currentRenderPassId=this._renderPassIds[C],this.onBeforeRenderObservable.notifyObservers(C);if(b.snapshotRendering&&1===b.snapshotRenderingMode)this.onFastPathRenderObservable.notifyObservers(C);else{let c=null;const b=this.renderList?this.renderList:d.getActiveMeshes().data,X=this.renderList?this.renderList.length:d.getActiveMeshes().length;this.getCustomRenderList&&(c=this.getCustomRenderList(C,b,X)),c?this._prepareRenderingManager(c,c.length,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(b,X,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),c=b),this.onBeforeRenderingManagerRenderObservable.notifyObservers(C),this._renderingManager.render(this.customRenderFunction,c,this.renderParticles,this.renderSprites),this.onAfterRenderingManagerRenderObservable.notifyObservers(C)}c||this.onAfterRenderObservable.notifyObservers(C),b.currentRenderPassId=X}_checkReadiness(){const C=this._scene,c=C.getEngine(),d=c.currentRenderPassId;let b=!0;C.getViewMatrix()||C.updateTransformMatrix();const X=this.options.numPasses;for(let V=0;V<X&&b;V++){let d=null;const P=this.renderList?this.renderList:C.getActiveMeshes().data,R=this.renderList?this.renderList.length:C.getActiveMeshes().length;c.currentRenderPassId=this._renderPassIds[V],this.onBeforeRenderObservable.notifyObservers(V),this.getCustomRenderList&&(d=this.getCustomRenderList(V,P,R)),d||(d=P),this.options.doNotChangeAspectRatio||C.updateTransformMatrix(!0);for(let C=0;C<d.length&&b;++C){const c=d[C];if(c.isEnabled()&&!c.isBlocked&&c.isVisible&&c.Nc)if(this.customIsReadyFunction){if(!this.customIsReadyFunction(c,this.refreshRate,!0)){b=!1;continue}}else if(!c.isReady(!0)){b=!1;continue}}this.onAfterRenderObservable.notifyObservers(V),X>1&&(C.incrementRenderId(),C.resetCachedMaterial())}const P=this.particleSystemList||C.LU;for(const V of P)V.isReady()||(b=!1);return c.currentRenderPassId=d,b}_prepareRenderingManager(C,c,d){const b=this._scene,X=b.activeCamera,P=this.cameraForLOD??X;this._renderingManager.reset();const V=b.getRenderId(),R=b.getFrameId();for(let j=0;j<c;j++){const c=C[j];if(c&&!c.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(c,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!c.isReady(0===this.refreshRate)){this.resetRefreshCounter();continue}let C,p=null;if(P){const C=c._internalAbstractMeshDataInfo._currentLOD.get(P);C&&C[1]===R?p=C[0]:(p=b.customLODSelector?b.customLODSelector(c,P):c.getLOD(P),C?(C[0]=p,C[1]=R):c._internalAbstractMeshDataInfo._currentLOD.set(P,[p,R]))}else p=c;if(!p)continue;if(p!==c&&0!==p.billboardMode&&p.Tc(),p._preActivateForIntermediateRendering(V),C=!(!d||!X)&&0===(c.layerMask&X.layerMask),c.isEnabled()&&c.isVisible&&c.Nc&&!C){if(p!==c&&p._activate(V,!0),c._activate(V,!0)&&c.Nc.length){c.isAnInstance?c._internalAbstractMeshDataInfo._actAsRegularMesh&&(p=c):p._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,p._internalAbstractMeshDataInfo._isActiveIntermediate=!0,b._prepareSkeleton(p);for(let C=0;C<p.Nc.length;C++){const c=p.Nc[C];this._renderingManager.dispatch(c,p)}}c._postActivate()}}}const p=this.particleSystemList||b.LU;for(let j=0;j<p.length;j++){const C=p[j],c=C.bc;C.isStarted()&&c&&(!c.position||c.isEnabled())&&this._renderingManager.dispatchParticles(C)}}setRenderingOrder(C){let c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,b=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this._renderingManager.setRenderingOrder(C,c,d,b)}setRenderingAutoClearDepthStencil(C,c){let d=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],b=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];this._renderingManager.setRenderingAutoClearDepthStencil(C,c,d,b),this._renderingManager._useSceneAutoClearSetup=!1}clone(){const C=new Z(this.name,this._scene,this.options);return this.renderList&&(C.renderList=this.renderList.slice(0)),C}dispose(){const C=this.renderList?this.renderList:this._scene.getActiveMeshes().data,c=this.renderList?this.renderList.length:this._scene.getActiveMeshes().length;for(let d=0;d<c;d++){const c=C[d];c&&void 0!==c.getMaterialForRenderPass(this.renderPassId)&&c.setMaterialForRenderPass(this.renderPassId,void 0)}this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderingManagerRenderObservable.clear(),this.onAfterRenderingManagerRenderObservable.clear(),this.onFastPathRenderObservable.clear(),this._releaseRenderPassId(),this.renderList=null}_rebuild(){this.refreshRate===Z.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=Z.REFRESHRATE_RENDER_ONCE)}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}}Z.REFRESHRATE_RENDER_ONCE=0,Z.REFRESHRATE_RENDER_ONEVERYFRAME=1,Z.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,p.Effect.prototype.setDepthStencilTexture=function(C,c){this._engine.setDepthStencilTexture(this._samplers[C],this._uniforms[C],c,C)};class U extends P.b{get renderListPredicate(){return this._objectRenderer.renderListPredicate}set renderListPredicate(C){this._objectRenderer.renderListPredicate=C}get renderList(){return this._objectRenderer.renderList}set renderList(C){this._objectRenderer.renderList=C}get particleSystemList(){return this._objectRenderer.particleSystemList}set particleSystemList(C){this._objectRenderer.particleSystemList=C}get getCustomRenderList(){return this._objectRenderer.getCustomRenderList}set getCustomRenderList(C){this._objectRenderer.getCustomRenderList=C}get renderParticles(){return this._objectRenderer.renderParticles}set renderParticles(C){this._objectRenderer.renderParticles=C}get renderSprites(){return this._objectRenderer.renderSprites}set renderSprites(C){this._objectRenderer.renderSprites=C}get forceLayerMaskCheck(){return this._objectRenderer.forceLayerMaskCheck}set forceLayerMaskCheck(C){this._objectRenderer.forceLayerMaskCheck=C}get activeCamera(){return this._objectRenderer.activeCamera}set activeCamera(C){this._objectRenderer.activeCamera=C}get cameraForLOD(){return this._objectRenderer.cameraForLOD}set cameraForLOD(C){this._objectRenderer.cameraForLOD=C}get disableImageProcessing(){return this._objectRenderer.disableImageProcessing}set disableImageProcessing(C){this._objectRenderer.disableImageProcessing=C}get customIsReadyFunction(){return this._objectRenderer.customIsReadyFunction}set customIsReadyFunction(C){this._objectRenderer.customIsReadyFunction=C}get customRenderFunction(){return this._objectRenderer.customRenderFunction}set customRenderFunction(C){this._objectRenderer.customRenderFunction=C}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(C){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(C)}get onBeforeRenderObservable(){return this._objectRenderer.onBeforeRenderObservable}set onBeforeRender(C){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(C)}get onAfterRenderObservable(){return this._objectRenderer.onAfterRenderObservable}set onAfterRender(C){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(C)}set onClear(C){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(C)}get _waitingRenderList(){return this._objectRenderer._waitingRenderList}set _waitingRenderList(C){this._objectRenderer._waitingRenderList=C}get renderPassId(){return this._objectRenderer.renderPassId}get renderPassIds(){return this._objectRenderer.renderPassIds}get currentRefreshId(){return this._objectRenderer.currentRefreshId}setMaterialForRendering(C,c){this._objectRenderer.setMaterialForRendering(C,c)}get isMulti(){var C;return(null===(C=this._renderTarget)||void 0===C?void 0:C.isMulti)??!1}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(C){if(this._boundingBoxSize&&this._boundingBoxSize.equals(C))return;this._boundingBoxSize=C;const c=this.NC();c&&c.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){var C;return(null===(C=this._renderTarget)||void 0===C?void 0:C._depthStencilTexture)??null}constructor(C,c,d){let V,R,p=arguments.length>3&&void 0!==arguments[3]&&arguments[3],g=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],k=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,U=arguments.length>6&&void 0!==arguments[6]&&arguments[6],A=arguments.length>7&&void 0!==arguments[7]?arguments[7]:P.b.TRILINEAR_SAMPLINGMODE,u=!(arguments.length>8&&void 0!==arguments[8])||arguments[8],q=arguments.length>9&&void 0!==arguments[9]&&arguments[9],B=arguments.length>10&&void 0!==arguments[10]&&arguments[10],t=arguments.length>11&&void 0!==arguments[11]?arguments[11]:5,e=arguments.length>12&&void 0!==arguments[12]&&arguments[12],n=arguments.length>13?arguments[13]:void 0,W=arguments.length>14?arguments[14]:void 0,E=arguments.length>15&&void 0!==arguments[15]&&arguments[15],N=arguments.length>16&&void 0!==arguments[16]&&arguments[16],r=!0;if("object"===typeof p){const C=p;p=!!C.generateMipMaps,g=C.doNotChangeAspectRatio??!0,k=C.type??0,U=!!C.isCube,A=C.samplingMode??P.b.TRILINEAR_SAMPLINGMODE,u=C.generateDepthBuffer??!0,q=!!C.generateStencilBuffer,B=!!C.isMulti,t=C.format??5,e=!!C.delayAllocation,n=C.samples,W=C.creationFlags,E=!!C.noColorAttachment,N=!!C.useSRGBBuffer,V=C.colorAttachment,r=C.gammaSpace??r,R=C.existingObjectRenderer}if(super(null,d,!p,void 0,A,void 0,void 0,void 0,void 0,t),this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new b.b,this.onAfterUnbindObservable=new b.b,this.onClearObservable=new b.b,this.onResizeObservable=new b.b,this._cleared=!1,this.skipInitialClear=!1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this._dontDisposeObjectRenderer=!1,this.boundingBoxPosition=X.dd.Zero(),this._disableEngineStages=!1,this._dumpToolsLoading=!1,!(d=this.NC()))return;const M=this.NC().getEngine();this._gammaSpace=r,this._coordinatesMode=P.b.PROJECTION_MODE,this.name=C,this.isRenderTarget=!0,this._initialSizeParameter=c,this._dontDisposeObjectRenderer=!!R,this._processSizeParameter(c),this._objectRenderer=R??new Z(C,d,{numPasses:U?6:this.getRenderLayers()||1,doNotChangeAspectRatio:g}),this._onBeforeRenderingManagerRenderObserver=this._objectRenderer.onBeforeRenderingManagerRenderObservable.add((()=>{if(!this._disableEngineStages)for(const C of this._scene._beforeRenderTargetClearStage)C.action(this,this._currentFaceIndex,this._currentLayer);if(this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(M):this.skipInitialClear||M.clear(this.clearColor||this._scene.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),!this._disableEngineStages)for(const C of this._scene._beforeRenderTargetDrawStage)C.action(this,this._currentFaceIndex,this._currentLayer)})),this._onAfterRenderingManagerRenderObserver=this._objectRenderer.onAfterRenderingManagerRenderObservable.add((()=>{var C;if(!this._disableEngineStages)for(const d of this._scene._afterRenderTargetDrawStage)d.action(this,this._currentFaceIndex,this._currentLayer);const c=(null===(C=this._texture)||void 0===C?void 0:C.generateMipMaps)??!1;if(this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex,this._postProcesses,this.ignoreCameraViewport):this._currentUseCameraPostProcess&&this._scene.postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex),!this._disableEngineStages)for(const d of this._scene._afterRenderTargetPostProcessStage)d.action(this,this._currentFaceIndex,this._currentLayer);this._texture&&(this._texture.generateMipMaps=c),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),this._currentDumpForDebug&&(this._dumpTools?this._dumpTools.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),M):j.d.Error("dumpTools module is still being loaded. To speed up the process import dump tools directly in your project"))})),this._onFastPathRenderObserver=this._objectRenderer.onFastPathRenderObservable.add((()=>{this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(M):this.skipInitialClear||M.clear(this.clearColor||this._scene.clearColor,!0,!0,!0)})),this._resizeObserver=M.onResizeObservable.add((()=>{})),this._generateMipMaps=!!p,this._doNotChangeAspectRatio=g,B||(this._renderTargetOptions={generateMipMaps:p,type:k,format:this._format??void 0,samplingMode:this.samplingMode,generateDepthBuffer:u,generateStencilBuffer:q,samples:n,creationFlags:W,noColorAttachment:E,useSRGBBuffer:N,colorAttachment:V,label:this.name},this.samplingMode===P.b.NEAREST_SAMPLINGMODE&&(this.wrapU=P.b.CLAMP_ADDRESSMODE,this.wrapV=P.b.CLAMP_ADDRESSMODE),e||(U?(this._renderTarget=d.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=P.b.INVCUBIC_MODE,this._textureMatrix=X.Matrix.Identity()):this._renderTarget=d.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==n&&(this.samples=n)))}createDepthStencilTexture(){var C;let c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,d=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],b=arguments.length>2&&void 0!==arguments[2]&&arguments[2],X=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,P=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14,V=arguments.length>5?arguments[5]:void 0;null===(C=this._renderTarget)||void 0===C||C.createDepthStencilTexture(c,d,b,X,P,V)}_processSizeParameter(C){if(C.ratio){this._sizeRatio=C.ratio;const c=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(c.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(c.getRenderHeight(),this._sizeRatio)}}else this._size=C}get samples(){var C;return(null===(C=this._renderTarget)||void 0===C?void 0:C.samples)??this._samples}set samples(C){this._renderTarget&&(this._samples=this._renderTarget.setSamples(C))}addPostProcess(C){if(!this._postProcessManager){const C=this.NC();if(!C)return;this._postProcessManager=new V.e(C),this._postProcesses=new Array}this._postProcesses.push(C),this._postProcesses[0].Wc=!1}clearPostProcesses(){let C=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._postProcesses){if(C)for(const C of this._postProcesses)C.dispose();this._postProcesses=[]}}removePostProcess(C){if(!this._postProcesses)return;const c=this._postProcesses.indexOf(C);-1!==c&&(this._postProcesses.splice(c,1),this._postProcesses.length>0&&(this._postProcesses[0].Wc=!1))}resetRefreshCounter(){this._objectRenderer.resetRefreshCounter()}get refreshRate(){return this._objectRenderer.refreshRate}set refreshRate(C){this._objectRenderer.refreshRate=C}_shouldRender(){return this._objectRenderer.shouldRender()}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){const C=this._size.layers;if(C)return C;const c=this._size.depth;return c||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(C){const c=Math.max(1,this.getRenderSize()*C);this.resize(c)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(C){var c;const d=this.isCube;null===(c=this._renderTarget)||void 0===c||c.dispose(),this._renderTarget=null;const b=this.NC();b&&(this._processSizeParameter(C),this._renderTarget=d?b.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):b.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==this._renderTargetOptions.samples&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(){let C=arguments.length>0&&void 0!==arguments[0]&&arguments[0],c=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._render(C,c)}isReadyForRendering(){this._dumpToolsLoading||(this._dumpToolsLoading=!0,d.e(20).then(d.bind(d,12622)).then((C=>this._dumpTools=C))),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight());const C=this._objectRenderer._checkReadiness();return this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender(),C}_render(){let C=arguments.length>0&&void 0!==arguments[0]&&arguments[0],c=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const d=this.NC();if(d){if(void 0!==this.useCameraPostProcesses&&(C=this.useCameraPostProcesses),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight()),!this.is2DArray&&!this.is3D||this.isMulti)if(this.isCube&&!this.isMulti)for(let b=0;b<6;b++)this._renderToTarget(b,C,c),d.incrementRenderId(),d.resetCachedMaterial();else this._renderToTarget(0,C,c);else for(let b=0;b<this.getRenderLayers();b++)this._renderToTarget(0,C,c,b),d.incrementRenderId(),d.resetCachedMaterial();this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender()}}_bestReflectionRenderTargetDimension(C,c){const d=C*c,b=(0,R.m)(d+16384/(128+d));return Math.min((0,R.c)(C),b)}_bindFrameBuffer(){let C=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const d=this.NC();if(!d)return;const b=d.getEngine();this._renderTarget&&b.bindFramebuffer(this._renderTarget,this.isCube?C:void 0,void 0,void 0,this.ignoreCameraViewport,0,c)}_unbindFrameBuffer(C,c){this._renderTarget&&C.unBindFramebuffer(this._renderTarget,this.isCube,(()=>{this.onAfterRenderObservable.notifyObservers(c)}))}_prepareFrame(C,c,d,b){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses)||this._bindFrameBuffer(c,d):b&&C.postProcessManager._prepareFrame(this._texture)||this._bindFrameBuffer(c,d)}_renderToTarget(C,c,d){var b,X;let P=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const V=this.NC();if(!V)return;const R=V.getEngine();this._currentFaceIndex=C,this._currentLayer=P,this._currentUseCameraPostProcess=c,this._currentDumpForDebug=d,this._prepareFrame(V,C,P,c),null===(b=R._debugPushGroup)||void 0===b||b.call(R,`render to face #${C} layer #${P}`,2),this._objectRenderer.render(C+P,!0),null===(X=R._debugPopGroup)||void 0===X||X.call(R,2),this._unbindFrameBuffer(R,C),this._texture&&this.isCube&&5===C&&R.generateMipMapsForCubemap(this._texture,!0)}setRenderingOrder(C){let c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,b=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this._objectRenderer.setRenderingOrder(C,c,d,b)}setRenderingAutoClearDepthStencil(C,c){this._objectRenderer.setRenderingAutoClearDepthStencil(C,c)}clone(){const C=this.getSize(),c=new U(this.name,C,this.NC(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return c.Kc=this.Kc,c.level=this.level,c.coordinatesMode=this.coordinatesMode,this.renderList&&(c.renderList=this.renderList.slice(0)),c}serialize(){if(!this.name)return null;const C=super.serialize();if(C.renderTargetSize=this.getRenderSize(),C.renderList=[],this.renderList)for(let c=0;c<this.renderList.length;c++)C.renderList.push(this.renderList[c].id);return C}disposeFramebufferObjects(){var C;null===(C=this._renderTarget)||void 0===C||C.dispose(!0)}releaseInternalTexture(){var C;null===(C=this._renderTarget)||void 0===C||C.releaseTextures(),this._texture=null}dispose(){var C;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._objectRenderer.onBeforeRenderingManagerRenderObservable.remove(this._onBeforeRenderingManagerRenderObserver),this._objectRenderer.onAfterRenderingManagerRenderObservable.remove(this._onAfterRenderingManagerRenderObserver),this._objectRenderer.onFastPathRenderObservable.remove(this._onFastPathRenderObserver),this._dontDisposeObjectRenderer||this._objectRenderer.dispose(),this.clearPostProcesses(!0),this._resizeObserver&&(this.NC().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null);const c=this.NC();if(!c)return;let d=c.customRenderTargets.indexOf(this);d>=0&&c.customRenderTargets.splice(d,1);for(const b of c.cameras)d=b.customRenderTargets.indexOf(this),d>=0&&b.customRenderTargets.splice(d,1);null===(C=this._renderTarget)||void 0===C||C.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this._objectRenderer._rebuild(),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._objectRenderer.freeRenderingGroups()}getViewCount(){return 1}}U.REFRESHRATE_RENDER_ONCE=Z.REFRESHRATE_RENDER_ONCE,U.REFRESHRATE_RENDER_ONEVERYFRAME=Z.REFRESHRATE_RENDER_ONEVERYFRAME,U.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=Z.REFRESHRATE_RENDER_ONEVERYTWOFRAMES,P.b._CreateRenderTargetTexture=(C,c,d,b,X)=>new U(C,c,d,b)},12556:(C,c,d)=>{function b(C){return 13===C||14===C||15===C||16===C||17===C||18===C||19===C}function X(C){return 13===C||17===C||18===C||19===C}d.d(c,{b:()=>X,c:()=>b})},12542:(C,c,d)=>{function b(C){return void 0===C.getPipelineContext}d.d(c,{b:()=>b})},12508:(C,c,d)=>{d.d(c,{d:()=>j,e:()=>g});var b=d(12471),X=d(12510),P=d(12221),V=d(12289),R=d(12514);d(12521);const p={MC:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class j{constructor(C){let c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:p;this._fullscreenViewport=new X.d(0,0,1,1);const d=c.MC??p.MC,P=c.indices??p.indices;this.Gc=C,this._vertexBuffers={[b.g.PositionKind]:new b.g(C,d,b.g.PositionKind,!1,!1,2)},this._indexBuffer=C.createIndexBuffer(P),this._indexBufferLength=P.length,this._onContextRestoredObserver=C.onContextRestoredObservable.add((()=>{this._indexBuffer=C.createIndexBuffer(P);for(const C in this._vertexBuffers){this._vertexBuffers[C]._rebuild()}}))}setViewport(){let C=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._fullscreenViewport;this.Gc.setViewport(C)}bindBuffers(C){this.Gc.bindBuffers(this._vertexBuffers,this._indexBuffer,C)}applyEffectWrapper(C){this.Gc.setState(!0),this.Gc.depthCullingState.depthTest=!1,this.Gc.stencilState.stencilTest=!1,this.Gc.enableEffect(C.drawWrapper),this.bindBuffers(C.effect),C.onApplyObservable.notifyObservers({})}saveStates(){this._savedStateDepthTest=this.Gc.depthCullingState.depthTest,this._savedStateStencilTest=this.Gc.stencilState.stencilTest}restoreStates(){this.Gc.depthCullingState.depthTest=this._savedStateDepthTest,this.Gc.stencilState.stencilTest=this._savedStateStencilTest}draw(){this.Gc.drawElementsType(0,0,this._indexBufferLength)}_isRenderTargetTexture(C){return void 0!==C.renderTarget}render(C){let c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!C.effect.isReady())return;this.saveStates(),this.setViewport();const d=null===c?null:this._isRenderTargetTexture(c)?c.renderTarget:c;d&&this.Gc.bindFramebuffer(d),this.applyEffectWrapper(C),this.draw(),d&&this.Gc.unBindFramebuffer(d),this.restoreStates()}dispose(){const C=this._vertexBuffers[b.g.PositionKind];C&&(C.dispose(),delete this._vertexBuffers[b.g.PositionKind]),this._indexBuffer&&this.Gc._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.Gc.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}}class g{static RegisterShaderCodeProcessing(C,c){c?g._CustomShaderCodeProcessing[C??""]=c:delete g._CustomShaderCodeProcessing[C??""]}static _GetShaderCodeProcessing(C){return g._CustomShaderCodeProcessing[C]??g._CustomShaderCodeProcessing[""]}get name(){return this.options.name}set name(C){this.options.name=C}isReady(){var C;return(null===(C=this._drawWrapper.effect)||void 0===C?void 0:C.isReady())??!1}get drawWrapper(){return this._drawWrapper}get effect(){return this._drawWrapper.effect}set effect(C){this._drawWrapper.effect=C}constructor(C){this.alphaMode=0,this.onEffectCreatedObservable=new P.b(void 0,!0),this.onApplyObservable=new P.b,this._shadersLoaded=!1,this._webGPUReady=!1,this._importPromises=[],this.options={...C,name:C.name||"effectWrapper",Gc:C.Gc,uniforms:C.uniforms||C.uniformNames||[],uniformNames:void 0,samplers:C.samplers||C.samplerNames||[],samplerNames:void 0,attributeNames:C.attributeNames||["position"],uniformBuffers:C.uniformBuffers||[],defines:C.defines||"",useShaderStore:C.useShaderStore||!1,vertexUrl:C.vertexUrl||C.vertexShader||"postprocess",vertexShader:void 0,fragmentShader:C.fragmentShader||"pass",indexParameters:C.indexParameters,blockCompilation:C.blockCompilation||!1,shaderLanguage:C.shaderLanguage||0,onCompiled:C.onCompiled||void 0,extraInitializations:C.extraInitializations||void 0,extraInitializationsAsync:C.extraInitializationsAsync||void 0,useAsPostProcess:C.useAsPostProcess??!1},this.options.uniformNames=this.options.uniforms,this.options.samplerNames=this.options.samplers,this.options.vertexShader=this.options.vertexUrl,this.options.useAsPostProcess&&(-1===this.options.samplers.indexOf("textureSampler")&&this.options.samplers.push("textureSampler"),-1===this.options.uniforms.indexOf("scale")&&this.options.uniforms.push("scale")),C.vertexUrl||C.vertexShader?this._shaderPath={vertexSource:this.options.vertexShader}:(this.options.useAsPostProcess||(this.options.uniforms.push("scale"),this.onApplyObservable.add((()=>{this.effect.setFloat2("scale",1,1)}))),this._shaderPath={vertex:this.options.vertexShader}),this._shaderPath.fragmentSource=this.options.fragmentShader,this._shaderPath.spectorName=this.options.name,this.options.useShaderStore&&(this._shaderPath.fragment=this._shaderPath.fragmentSource,this._shaderPath.vertex||(this._shaderPath.vertex=this._shaderPath.vertexSource),delete this._shaderPath.fragmentSource,delete this._shaderPath.vertexSource),this.onApplyObservable.add((()=>{this.bind()})),this.options.useShaderStore||(this._onContextRestoredObserver=this.options.Gc.onContextRestoredObservable.add((()=>{this.effect._pipelineContext=null,this.effect._prepareEffect()}))),this._drawWrapper=new R.b(this.options.Gc),this._webGPUReady=1===this.options.shaderLanguage;const c=Array.isArray(this.options.defines)?this.options.defines.join("\n"):this.options.defines;this._postConstructor(this.options.blockCompilation,c,this.options.extraInitializations)}_gatherImports(){let C=arguments.length>0&&void 0!==arguments[0]&&arguments[0],c=arguments.length>1?arguments[1]:void 0;this.options.useAsPostProcess&&(C&&this._webGPUReady?c.push(Promise.all([d.e(53).then(d.bind(d,14925))])):c.push(Promise.all([Promise.resolve().then(d.bind(d,12521))])))}_postConstructor(C){let c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,d=arguments.length>2?arguments[2]:void 0,b=arguments.length>3?arguments[3]:void 0;this._importPromises.length=0,b&&this._importPromises.push(...b);const X=this.options.Gc.isWebGPU&&!g.ForceGLSL;this._gatherImports(X,this._importPromises),void 0!==d&&d(X,this._importPromises),X&&this._webGPUReady&&(this.options.shaderLanguage=1),C||this.updateEffect(c)}updateEffect(){let C=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,b=arguments.length>3?arguments[3]:void 0,X=arguments.length>4?arguments[4]:void 0,P=arguments.length>5?arguments[5]:void 0,R=arguments.length>6?arguments[6]:void 0,p=arguments.length>7?arguments[7]:void 0;const j=g._GetShaderCodeProcessing(this.name);if(null!==j&&void 0!==j&&j.defineCustomBindings){var k,Z;const b=(null===(k=c)||void 0===k?void 0:k.slice())??[];b.push(...this.options.uniforms);const X=(null===(Z=d)||void 0===Z?void 0:Z.slice())??[];X.push(...this.options.samplers),C=j.defineCustomBindings(this.name,C,b,X),c=b,d=X}this.options.defines=C||"";const U=this._shadersLoaded||0===this._importPromises.length?void 0:async()=>{await Promise.all(this._importPromises),this._shadersLoaded=!0};let A;A=this.options.extraInitializationsAsync?async()=>{null===U||void 0===U||U(),await this.options.extraInitializationsAsync()}:U,this.options.useShaderStore?this._drawWrapper.effect=this.options.Gc.createEffect({vertex:R??this._shaderPath.vertex,fragment:p??this._shaderPath.fragment},{attributes:this.options.attributeNames,uniformsNames:c||this.options.uniforms,uniformBuffersNames:this.options.uniformBuffers,samplers:d||this.options.samplers,defines:null!==C?C:"",fallbacks:null,onCompiled:X??this.options.onCompiled,onError:P??null,indexParameters:b||this.options.indexParameters,processCodeAfterIncludes:null!==j&&void 0!==j&&j.processCodeAfterIncludes?(C,c)=>j.processCodeAfterIncludes(this.name,C,c):null,processFinalCode:null!==j&&void 0!==j&&j.processFinalCode?(C,c)=>j.processFinalCode(this.name,C,c):null,shaderLanguage:this.options.shaderLanguage,extraInitializationsAsync:A},this.options.Gc):this._drawWrapper.effect=new V.Effect(this._shaderPath,this.options.attributeNames,c||this.options.uniforms,d||this.options.samplerNames,this.options.Gc,C,void 0,X||this.options.onCompiled,void 0,void 0,void 0,this.options.shaderLanguage,A),this.onEffectCreatedObservable.notifyObservers(this._drawWrapper.effect)}bind(){var C,c;let d=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.options.useAsPostProcess&&!d&&(this.options.Gc.setAlphaMode(this.alphaMode),this.drawWrapper.effect.setFloat2("scale",1,1)),null===(C=g._GetShaderCodeProcessing(this.name))||void 0===C||null===(c=C.bindCustomBindings)||void 0===c||c.call(C,this.name,this._drawWrapper.effect)}dispose(){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.onEffectCreatedObservable.clear(),this._drawWrapper.dispose(!0)}}g.ForceGLSL=!1,g._CustomShaderCodeProcessing={}},12604:(C,c,d)=>{d.d(c,{c:()=>V});var b,X,P=d(12403);!function(C){C[C.LOCAL=0]="LOCAL",C[C.WORLD=1]="WORLD",C[C.BONE=2]="BONE"}(b||(b={}));class V{}V.X=new P.dd(1,0,0),V.Y=new P.dd(0,1,0),V.Z=new P.dd(0,0,1),function(C){C[C.X=0]="X",C[C.Y=1]="Y",C[C.Z=2]="Z"}(X||(X={}))},12600:(C,c,d)=>{d.d(c,{d:()=>b.Matrix,e:()=>b.Quaternion,g:()=>b.TmpVectors,h:()=>b.dd});d(12604),d(12438),d(12412),d(12610),d(12614),d(12442),d(12428);var b=d(12403);d(12510)},12614:(C,c,d)=>{d.d(c,{e:()=>R,f:()=>Z,j:()=>g,k:()=>k});var b,X=d(12418),P=d(12403),V=d(12412);!function(C){C[C.CW=0]="CW",C[C.CCW=1]="CCW"}(b||(b={}));class R{static Interpolate(C,c,d,b,X){if(0===C)return 0;const P=1-3*b+3*c,V=3*b-6*c,R=3*c;let p=C;for(let j=0;j<5;j++){const c=p*p;p-=(P*(c*p)+V*c+R*p-C)*(1/(3*P*c+2*V*p+R)),p=Math.min(1,Math.max(0,p))}return 3*Math.pow(1-p,2)*p*d+3*(1-p)*Math.pow(p,2)*X+Math.pow(p,3)}}class p{constructor(C){this._radians=C,this._radians<0&&(this._radians+=2*Math.PI)}degrees(){return 180*this._radians/Math.PI}radians(){return this._radians}static BetweenTwoPoints(C,c){const d=c.Xd(C),b=Math.atan2(d.y,d.x);return new p(b)}static BetweenTwoVectors(C,c){let d=C.lengthSquared()*c.lengthSquared();if(0===d)return new p(Math.PI/2);d=Math.sqrt(d);let b=C.dot(c)/d;b=(0,X.Clamp)(b,-1,1);const P=Math.acos(b);return new p(P)}static FromRadians(C){return new p(C)}static FromDegrees(C){return new p(C*Math.PI/180)}}class j{constructor(C,c,d){this.startPoint=C,this.midPoint=c,this.endPoint=d;const b=Math.pow(c.x,2)+Math.pow(c.y,2),X=(Math.pow(C.x,2)+Math.pow(C.y,2)-b)/2,V=(b-Math.pow(d.x,2)-Math.pow(d.y,2))/2,R=(C.x-c.x)*(c.y-d.y)-(c.x-d.x)*(C.y-c.y);this.centerPoint=new P.Vector2((X*(c.y-d.y)-V*(C.y-c.y))/R,((C.x-c.x)*V-(c.x-d.x)*X)/R),this.radius=this.centerPoint.Xd(this.startPoint).length(),this.startAngle=p.BetweenTwoPoints(this.centerPoint,this.startPoint);const j=this.startAngle.degrees();let g=p.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),k=p.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();g-j>180&&(g-=360),g-j<-180&&(g+=360),k-g>180&&(k-=360),k-g<-180&&(k+=360),this.orientation=g-j<0?0:1,this.angle=p.FromDegrees(0===this.orientation?j-k:k-j)}}class g{constructor(C,c){this._points=new Array,this._length=0,this.closed=!1,this._points.push(new P.Vector2(C,c))}addLineTo(C,c){if(this.closed)return this;const d=new P.Vector2(C,c),b=this._points[this._points.length-1];return this._points.push(d),this._length+=d.Xd(b).length(),this}addArcTo(C,c,d,b){let X=arguments.length>4&&void 0!==arguments[4]?arguments[4]:36;if(this.closed)return this;const V=this._points[this._points.length-1],R=new P.Vector2(C,c),p=new P.Vector2(d,b),g=new j(V,R,p);let k=g.angle.radians()/X;0===g.orientation&&(k*=-1);let Z=g.startAngle.radians()+k;for(let P=0;P<X;P++){const C=Math.cos(Z)*g.radius+g.centerPoint.x,c=Math.sin(Z)*g.radius+g.centerPoint.y;this.addLineTo(C,c),Z+=k}return this}addQuadraticCurveTo(C,c,d,b){let X=arguments.length>4&&void 0!==arguments[4]?arguments[4]:36;if(this.closed)return this;const P=(C,c,d,b)=>(1-C)*(1-C)*c+2*C*(1-C)*d+C*C*b,V=this._points[this._points.length-1];for(let R=0;R<=X;R++){const p=R/X,j=P(p,V.x,C,d),g=P(p,V.y,c,b);this.addLineTo(j,g)}return this}addBezierCurveTo(C,c,d,b,X,P){let V=arguments.length>6&&void 0!==arguments[6]?arguments[6]:36;if(this.closed)return this;const R=(C,c,d,b,X)=>(1-C)*(1-C)*(1-C)*c+3*C*(1-C)*(1-C)*d+3*C*C*(1-C)*b+C*C*C*X,p=this._points[this._points.length-1];for(let j=0;j<=V;j++){const g=j/V,k=R(g,p.x,C,d,X),Z=R(g,p.y,c,b,P);this.addLineTo(k,Z)}return this}isPointInside(C){let c=!1;const d=this._points.length;for(let b=d-1,X=0;X<d;b=X++){let d=this._points[b],P=this._points[X],V=P.x-d.x,R=P.y-d.y;if(Math.abs(R)>Number.EPSILON){if(R<0&&(d=this._points[X],V=-V,P=this._points[b],R=-R),C.y<d.y||C.y>P.y)continue;if(C.y===d.y&&C.x===d.x)return!0;{const b=R*(C.x-d.x)-V*(C.y-d.y);if(0===b)return!0;if(b<0)continue;c=!c}}else{if(C.y!==d.y)continue;if(P.x<=C.x&&C.x<=d.x||d.x<=C.x&&C.x<=P.x)return!0}}return c}close(){return this.closed=!0,this}length(){let C=this._length;if(this.closed){const c=this._points[this._points.length-1];C+=this._points[0].Xd(c).length()}return C}area(){const C=this._points.length;let c=0;for(let d=C-1,b=0;b<C;d=b++)c+=this._points[d].x*this._points[b].y-this._points[b].x*this._points[d].y;return.5*c}getPoints(){return this._points}getPointAtLengthPosition(C){if(C<0||C>1)return P.Vector2.Zero();const c=C*this.length();let d=0;for(let b=0;b<this._points.length;b++){const C=(b+1)%this._points.length,X=this._points[b],V=this._points[C].Xd(X),R=V.length()+d;if(c>=d&&c<=R){const C=V.normalize(),b=c-d;return new P.Vector2(X.x+C.x*b,X.y+C.y*b)}d=R}return P.Vector2.Zero()}static StartingAt(C,c){return new g(C,c)}}class k{constructor(C){let c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,d=arguments.length>2?arguments[2]:void 0,b=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.path=C,this._curve=new Array,this._distances=new Array,this._tangents=new Array,this._normals=new Array,this._binormals=new Array,this._pointAtData={id:0,point:P.dd.Zero(),previousPointArrayIndex:0,position:0,subPosition:0,interpolateReady:!1,interpolationMatrix:P.Matrix.Identity()};for(let X=0;X<C.length;X++)this._curve[X]=C[X].clone();this._raw=d||!1,this._alignTangentsWithPath=b,this._compute(c,b)}getCurve(){return this._curve}getPoints(){return this._curve}length(){return this._distances[this._distances.length-1]}getTangents(){return this._tangents}getNormals(){return this._normals}getBinormals(){return this._binormals}getDistances(){return this._distances}getPointAt(C){return this._updatePointAtData(C).point}getTangentAt(C){let c=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(C,c),c?P.dd.TransformCoordinates(P.dd.Forward(),this._pointAtData.interpolationMatrix):this._tangents[this._pointAtData.previousPointArrayIndex]}getNormalAt(C){let c=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(C,c),c?P.dd.TransformCoordinates(P.dd.Right(),this._pointAtData.interpolationMatrix):this._normals[this._pointAtData.previousPointArrayIndex]}getBinormalAt(C){let c=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._updatePointAtData(C,c),c?P.dd.TransformCoordinates(P.dd.UpReadOnly,this._pointAtData.interpolationMatrix):this._binormals[this._pointAtData.previousPointArrayIndex]}getDistanceAt(C){return this.length()*C}getPreviousPointIndexAt(C){return this._updatePointAtData(C),this._pointAtData.previousPointArrayIndex}getSubPositionAt(C){return this._updatePointAtData(C),this._pointAtData.subPosition}getClosestPositionTo(C){let c=Number.MAX_VALUE,d=0;for(let b=0;b<this._curve.length-1;b++){const X=this._curve[b+0],V=this._curve[b+1].Xd(X).normalize(),R=this._distances[b+1]-this._distances[b+0],p=Math.min(Math.max(P.dd.Dot(V,C.Xd(X).normalize()),0)*P.dd.Distance(X,C)/R,1),j=P.dd.Distance(X.add(V.scale(p*R)),C);j<c&&(c=j,d=(this._distances[b+0]+R*p)/this.length())}return d}slice(){let C=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(C<0&&(C=1- -1*C%1),c<0&&(c=1- -1*c%1),C>c){const d=C;C=c,c=d}const d=this.getCurve(),b=this.getPointAt(C);let X=this.getPreviousPointIndexAt(C);const P=this.getPointAt(c),V=this.getPreviousPointIndexAt(c)+1,R=[];return 0!==C&&(X++,R.push(b)),R.push(...d.slice(X,V)),1===c&&1!==C||R.push(P),new k(R,this.getNormalAt(C),this._raw,this._alignTangentsWithPath)}update(C){let c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,d=arguments.length>2&&void 0!==arguments[2]&&arguments[2];for(let b=0;b<C.length;b++)this._curve[b].x=C[b].x,this._curve[b].y=C[b].y,this._curve[b].z=C[b].z;return this._compute(c,d),this}_compute(C){let c=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const d=this._curve.length;if(d<2)return;this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[d-1]=this._curve[d-1].Xd(this._curve[d-2]),this._raw||this._tangents[d-1].normalize();const b=this._tangents[0],X=this._normalVector(b,C);let V,R,p,j,g;this._normals[0]=X,this._raw||this._normals[0].normalize(),this._binormals[0]=P.dd.Cross(b,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;for(let k=1;k<d;k++)V=this._getLastNonNullVector(k),k<d-1&&(R=this._getFirstNonNullVector(k),this._tangents[k]=c?R:V.add(R),this._tangents[k].normalize()),this._distances[k]=this._distances[k-1]+this._curve[k].Xd(this._curve[k-1]).length(),p=this._tangents[k],g=this._binormals[k-1],this._normals[k]=P.dd.Cross(g,p),this._raw||(0===this._normals[k].length()?(j=this._normals[k-1],this._normals[k]=j.clone()):this._normals[k].normalize()),this._binormals[k]=P.dd.Cross(p,this._normals[k]),this._raw||this._binormals[k].normalize();this._pointAtData.id=NaN}_getFirstNonNullVector(C){let c=1,d=this._curve[C+c].Xd(this._curve[C]);for(;0===d.length()&&C+c+1<this._curve.length;)c++,d=this._curve[C+c].Xd(this._curve[C]);return d}_getLastNonNullVector(C){let c=1,d=this._curve[C].Xd(this._curve[C-c]);for(;0===d.length()&&C>c+1;)c++,d=this._curve[C].Xd(this._curve[C-c]);return d}_normalVector(C,c){let d,b=C.length();if(0===b&&(b=1),void 0===c||null===c){let c;c=(0,X.WithinEpsilon)(Math.abs(C.y)/b,1,V.d)?(0,X.WithinEpsilon)(Math.abs(C.x)/b,1,V.d)?(0,X.WithinEpsilon)(Math.abs(C.z)/b,1,V.d)?P.dd.Zero():new P.dd(0,0,1):new P.dd(1,0,0):new P.dd(0,-1,0),d=P.dd.Cross(C,c)}else d=P.dd.Cross(C,c),P.dd.CrossToRef(d,C,d);return d.normalize(),d}_updatePointAtData(C){let c=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._pointAtData.id===C)return this._pointAtData.interpolateReady||this._updateInterpolationMatrix(),this._pointAtData;this._pointAtData.id=C;const d=this.getPoints();if(C<=0)return this._setPointAtData(0,0,d[0],0,c);if(C>=1)return this._setPointAtData(1,1,d[d.length-1],d.length-1,c);let b,X=d[0],V=0;const R=C*this.length();for(let p=1;p<d.length;p++){b=d[p];const j=P.dd.Distance(X,b);if(V+=j,V===R)return this._setPointAtData(C,1,b,p,c);if(V>R){const d=(V-R)/j,P=X.Xd(b),g=b.add(P.scaleInPlace(d));return this._setPointAtData(C,1-d,g,p-1,c)}X=b}return this._pointAtData}_setPointAtData(C,c,d,b,X){return this._pointAtData.point=d,this._pointAtData.position=C,this._pointAtData.subPosition=c,this._pointAtData.previousPointArrayIndex=b,this._pointAtData.interpolateReady=X,X&&this._updateInterpolationMatrix(),this._pointAtData}_updateInterpolationMatrix(){this._pointAtData.interpolationMatrix=P.Matrix.Identity();const C=this._pointAtData.previousPointArrayIndex;if(C!==this._tangents.length-1){const c=C+1,d=this._tangents[C].clone(),b=this._normals[C].clone(),X=this._binormals[C].clone(),V=this._tangents[c].clone(),R=this._normals[c].clone(),p=this._binormals[c].clone(),j=P.Quaternion.RotationQuaternionFromAxis(b,X,d),g=P.Quaternion.RotationQuaternionFromAxis(R,p,V);P.Quaternion.Slerp(j,g,this._pointAtData.subPosition).toRotationMatrix(this._pointAtData.interpolationMatrix)}}}class Z{static CreateQuadraticBezier(C,c,d,b){b=b>2?b:3;const X=[],V=(C,c,d,b)=>(1-C)*(1-C)*c+2*C*(1-C)*d+C*C*b;for(let R=0;R<=b;R++)X.push(new P.dd(V(R/b,C.x,c.x,d.x),V(R/b,C.y,c.y,d.y),V(R/b,C.z,c.z,d.z)));return new Z(X)}static CreateCubicBezier(C,c,d,b,X){X=X>3?X:4;const V=[],R=(C,c,d,b,X)=>(1-C)*(1-C)*(1-C)*c+3*C*(1-C)*(1-C)*d+3*C*C*(1-C)*b+C*C*C*X;for(let p=0;p<=X;p++)V.push(new P.dd(R(p/X,C.x,c.x,d.x,b.x),R(p/X,C.y,c.y,d.y,b.y),R(p/X,C.z,c.z,d.z,b.z)));return new Z(V)}static CreateHermiteSpline(C,c,d,b,X){const V=[],R=1/X;for(let p=0;p<=X;p++)V.push(P.dd.Hermite(C,c,d,b,p*R));return new Z(V)}static CreateCatmullRomSpline(C,c,d){const b=[],X=1/c;let V=0;if(d){const d=C.length;for(let R=0;R<d;R++){V=0;for(let p=0;p<c;p++)b.push(P.dd.CatmullRom(C[R%d],C[(R+1)%d],C[(R+2)%d],C[(R+3)%d],V)),V+=X}b.push(b[0])}else{const d=[];d.push(C[0].clone()),Array.prototype.push.apply(d,C),d.push(C[C.length-1].clone());let R=0;for(;R<d.length-3;R++){V=0;for(let C=0;C<c;C++)b.push(P.dd.CatmullRom(d[R],d[R+1],d[R+2],d[R+3],V)),V+=X}R--,b.push(P.dd.CatmullRom(d[R],d[R+1],d[R+2],d[R+3],V))}return new Z(b)}static ArcThru3Points(C,c,d){let b=arguments.length>3&&void 0!==arguments[3]?arguments[3]:32,X=arguments.length>4&&void 0!==arguments[4]&&arguments[4],V=arguments.length>5&&void 0!==arguments[5]&&arguments[5];const R=[],p=c.Xd(C),j=d.Xd(c),g=C.Xd(d),k=P.dd.Cross(p,j),U=k.length();if(U<Math.pow(10,-8))return new Z(R);const A=p.lengthSquared(),u=j.lengthSquared(),q=g.lengthSquared(),B=k.lengthSquared(),t=.5*p.length()*j.length()*g.length()/U,e=-.5*u*P.dd.Dot(p,g)/B,n=-.5*q*P.dd.Dot(p,j)/B,W=-.5*A*P.dd.Dot(j,g)/B,E=C.scale(e).add(c.scale(n)).add(d.scale(W)),N=C.Xd(E).normalize(),r=P.dd.Cross(k,N).normalize();if(V){const c=2*Math.PI/b;for(let C=0;C<=2*Math.PI;C+=c)R.push(E.add(N.scale(t*Math.cos(C)).add(r.scale(t*Math.sin(C)))));R.push(C)}else{const c=1/b;let V=0,p=P.dd.Zero();do{p=E.add(N.scale(t*Math.cos(V)).add(r.scale(t*Math.sin(V)))),R.push(p),V+=c}while(!p.equalsWithEpsilon(d,t*c*1.1));R.push(d),X&&R.push(C)}return new Z(R)}constructor(C){this._length=0,this._points=C,this._length=this._computeLength(C)}getPoints(){return this._points}length(){return this._length}continue(C){const c=this._points[this._points.length-1],d=this._points.slice(),b=C.getPoints();for(let X=1;X<b.length;X++)d.push(b[X].Xd(b[0]).add(c));return new Z(d)}_computeLength(C){let c=0;for(let d=1;d<C.length;d++)c+=C[d].Xd(C[d-1]).length();return c}}},12510:(C,c,d)=>{d.d(c,{d:()=>b});class b{constructor(C,c,d,b){this.x=C,this.y=c,this.width=d,this.height=b}toGlobal(C,c){return new b(this.x*C,this.y*c,this.width*C,this.height*c)}toGlobalToRef(C,c,d){return d.x=this.x*C,d.y=this.y*c,d.width=this.width*C,d.height=this.height*c,this}clone(){return new b(this.x,this.y,this.width,this.height)}}},12595:(C,c,d)=>{d.d(c,{d:()=>j,e:()=>g});var b=d(12403),X=d(12600);const P=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],V=[()=>1,C=>C.y,C=>C.z,C=>C.x,C=>C.x*C.y,C=>C.y*C.z,C=>3*C.z*C.z-1,C=>C.x*C.z,C=>C.x*C.x-C.y*C.y],R=(C,c)=>P[C]*V[C](c),p=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4];class j{constructor(){this.preScaled=!1,this.l00=b.dd.Zero(),this.l1_1=b.dd.Zero(),this.l10=b.dd.Zero(),this.l11=b.dd.Zero(),this.l2_2=b.dd.Zero(),this.l2_1=b.dd.Zero(),this.l20=b.dd.Zero(),this.l21=b.dd.Zero(),this.l22=b.dd.Zero()}addLight(C,c,d){X.g.dd[0].set(c.r,c.g,c.b);const b=X.g.dd[0],P=X.g.dd[1];b.scaleToRef(d,P),P.scaleToRef(R(0,C),X.g.dd[2]),this.l00.addInPlace(X.g.dd[2]),P.scaleToRef(R(1,C),X.g.dd[2]),this.l1_1.addInPlace(X.g.dd[2]),P.scaleToRef(R(2,C),X.g.dd[2]),this.l10.addInPlace(X.g.dd[2]),P.scaleToRef(R(3,C),X.g.dd[2]),this.l11.addInPlace(X.g.dd[2]),P.scaleToRef(R(4,C),X.g.dd[2]),this.l2_2.addInPlace(X.g.dd[2]),P.scaleToRef(R(5,C),X.g.dd[2]),this.l2_1.addInPlace(X.g.dd[2]),P.scaleToRef(R(6,C),X.g.dd[2]),this.l20.addInPlace(X.g.dd[2]),P.scaleToRef(R(7,C),X.g.dd[2]),this.l21.addInPlace(X.g.dd[2]),P.scaleToRef(R(8,C),X.g.dd[2]),this.l22.addInPlace(X.g.dd[2])}scaleInPlace(C){this.l00.scaleInPlace(C),this.l1_1.scaleInPlace(C),this.l10.scaleInPlace(C),this.l11.scaleInPlace(C),this.l2_2.scaleInPlace(C),this.l2_1.scaleInPlace(C),this.l20.scaleInPlace(C),this.l21.scaleInPlace(C),this.l22.scaleInPlace(C)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(p[0]),this.l1_1.scaleInPlace(p[1]),this.l10.scaleInPlace(p[2]),this.l11.scaleInPlace(p[3]),this.l2_2.scaleInPlace(p[4]),this.l2_1.scaleInPlace(p[5]),this.l20.scaleInPlace(p[6]),this.l21.scaleInPlace(p[7]),this.l22.scaleInPlace(p[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(P[0]),this.l1_1.scaleInPlace(P[1]),this.l10.scaleInPlace(P[2]),this.l11.scaleInPlace(P[3]),this.l2_2.scaleInPlace(P[4]),this.l2_1.scaleInPlace(P[5]),this.l20.scaleInPlace(P[6]),this.l21.scaleInPlace(P[7]),this.l22.scaleInPlace(P[8])}updateFromArray(C){return b.dd.FromArrayToRef(C[0],0,this.l00),b.dd.FromArrayToRef(C[1],0,this.l1_1),b.dd.FromArrayToRef(C[2],0,this.l10),b.dd.FromArrayToRef(C[3],0,this.l11),b.dd.FromArrayToRef(C[4],0,this.l2_2),b.dd.FromArrayToRef(C[5],0,this.l2_1),b.dd.FromArrayToRef(C[6],0,this.l20),b.dd.FromArrayToRef(C[7],0,this.l21),b.dd.FromArrayToRef(C[8],0,this.l22),this}updateFromFloatsArray(C){return b.dd.FromFloatsToRef(C[0],C[1],C[2],this.l00),b.dd.FromFloatsToRef(C[3],C[4],C[5],this.l1_1),b.dd.FromFloatsToRef(C[6],C[7],C[8],this.l10),b.dd.FromFloatsToRef(C[9],C[10],C[11],this.l11),b.dd.FromFloatsToRef(C[12],C[13],C[14],this.l2_2),b.dd.FromFloatsToRef(C[15],C[16],C[17],this.l2_1),b.dd.FromFloatsToRef(C[18],C[19],C[20],this.l20),b.dd.FromFloatsToRef(C[21],C[22],C[23],this.l21),b.dd.FromFloatsToRef(C[24],C[25],C[26],this.l22),this}static jd(C){return(new j).updateFromArray(C)}static FromPolynomial(C){const c=new j;return c.l00=C.xx.scale(.376127).add(C.yy.scale(.376127)).add(C.zz.scale(.376126)),c.l1_1=C.y.scale(.977204),c.l10=C.z.scale(.977204),c.l11=C.x.scale(.977204),c.l2_2=C.xy.scale(1.16538),c.l2_1=C.yz.scale(1.16538),c.l20=C.zz.scale(1.34567).Xd(C.xx.scale(.672834)).Xd(C.yy.scale(.672834)),c.l21=C.zx.scale(1.16538),c.l22=C.xx.scale(1.16538).Xd(C.yy.scale(1.16538)),c.l1_1.scaleInPlace(-1),c.l11.scaleInPlace(-1),c.l2_1.scaleInPlace(-1),c.l21.scaleInPlace(-1),c.scaleInPlace(Math.PI),c}}class g{constructor(){this.x=b.dd.Zero(),this.y=b.dd.Zero(),this.z=b.dd.Zero(),this.xx=b.dd.Zero(),this.yy=b.dd.Zero(),this.zz=b.dd.Zero(),this.xy=b.dd.Zero(),this.yz=b.dd.Zero(),this.zx=b.dd.Zero()}get preScaledHarmonics(){return this._harmonics||(this._harmonics=j.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(C){X.g.dd[0].yc(C.r,C.g,C.b);const c=X.g.dd[0];this.xx.addInPlace(c),this.yy.addInPlace(c),this.zz.addInPlace(c)}scaleInPlace(C){this.x.scaleInPlace(C),this.y.scaleInPlace(C),this.z.scaleInPlace(C),this.xx.scaleInPlace(C),this.yy.scaleInPlace(C),this.zz.scaleInPlace(C),this.yz.scaleInPlace(C),this.zx.scaleInPlace(C),this.xy.scaleInPlace(C)}updateFromHarmonics(C){return this._harmonics=C,this.x.V(C.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.V(C.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.V(C.l10),this.z.scaleInPlace(1.02333),this.xx.V(C.l00),X.g.dd[0].V(C.l20).scaleInPlace(.247708),X.g.dd[1].V(C.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).wZ(X.g.dd[0]).addInPlace(X.g.dd[1]),this.yy.V(C.l00),this.yy.scaleInPlace(.886277).wZ(X.g.dd[0]).wZ(X.g.dd[1]),this.zz.V(C.l00),X.g.dd[0].V(C.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(X.g.dd[0]),this.yz.V(C.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.V(C.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.V(C.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(C){return(new g).updateFromHarmonics(C)}static jd(C){const c=new g;return b.dd.FromArrayToRef(C[0],0,c.x),b.dd.FromArrayToRef(C[1],0,c.y),b.dd.FromArrayToRef(C[2],0,c.z),b.dd.FromArrayToRef(C[3],0,c.xx),b.dd.FromArrayToRef(C[4],0,c.yy),b.dd.FromArrayToRef(C[5],0,c.zz),b.dd.FromArrayToRef(C[6],0,c.yz),b.dd.FromArrayToRef(C[7],0,c.zx),b.dd.FromArrayToRef(C[8],0,c.xy),c}}},12546:(C,c,d)=>{d.d(c,{b:()=>X});var b=d(12477);class X extends b.b{constructor(C){super(),this._buffer=C}get underlyingResource(){return this._buffer}}},12628:(C,c,d)=>{d.d(c,{c:()=>B,d:()=>W,e:()=>N,f:()=>r,g:()=>n});var b=d(12375),X=d(12456),P=d(12384),V=d(12499),R=d(12283),p=d(12345),j=d(12431),g=d(12508),k=d(12529);class Z extends g.e{_gatherImports(C,c){C?(this._webGPUReady=!0,c.push(Promise.all([d.e(51).then(d.bind(d,14919))]))):c.push(Promise.all([d.e(52).then(d.bind(d,14923))])),super._gatherImports(C,c)}constructor(C){super({...arguments.length>2?arguments[2]:void 0,name:C,Gc:(arguments.length>1&&void 0!==arguments[1]?arguments[1]:null)||k.b.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Z.FragmentUrl})}}Z.FragmentUrl="pass";class U extends g.e{_gatherImports(C,c){C?(this._webGPUReady=!0,c.push(Promise.all([d.e(62).then(d.bind(d,14963))]))):c.push(Promise.all([d.e(63).then(d.bind(d,14966))])),super._gatherImports(C,c)}constructor(C){super({...arguments.length>2?arguments[2]:void 0,name:C,Gc:(arguments.length>1&&void 0!==arguments[1]?arguments[1]:null)||k.b.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:U.FragmentUrl,defines:"#define POSITIVEX"}),this._face=0}get face(){return this._face}set face(C){if(!(C<0||C>5))switch(this._face=C,this._face){case 0:this.updateEffect("#define POSITIVEX");break;case 1:this.updateEffect("#define NEGATIVEX");break;case 2:this.updateEffect("#define POSITIVEY");break;case 3:this.updateEffect("#define NEGATIVEY");break;case 4:this.updateEffect("#define POSITIVEZ");break;case 5:this.updateEffect("#define NEGATIVEZ")}}}U.FragmentUrl="passCube";var A=d(12388);class u extends V.d{getClassName(){return"PassPostProcess"}constructor(C,c){let d=arguments.length>4?arguments[4]:void 0;const b={size:"number"===typeof c?c:void 0,camera:arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,samplingMode:arguments.length>3?arguments[3]:void 0,Gc:d,reusable:arguments.length>5?arguments[5]:void 0,textureType:arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,blockCompilation:arguments.length>7&&void 0!==arguments[7]&&arguments[7],...c};super(C,Z.FragmentUrl,{effectWrapper:"number"!==typeof c&&c.effectWrapper?void 0:new Z(C,d,b),...b})}static _Parse(C,c,d,b){return j.e.Parse((()=>new u(C.name,C.options,c,C.renderTargetSamplingMode,C._engine,C.reusable)),C,d,b)}}(0,p.e)("BABYLON.PassPostProcess",u);class q extends V.d{get face(){return this._effectWrapper.face}set face(C){this._effectWrapper.face=C}getClassName(){return"PassCubePostProcess"}constructor(C,c){let d=arguments.length>4?arguments[4]:void 0;const b={size:"number"===typeof c?c:void 0,camera:arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,samplingMode:arguments.length>3?arguments[3]:void 0,Gc:d,reusable:arguments.length>5?arguments[5]:void 0,textureType:arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,blockCompilation:arguments.length>7&&void 0!==arguments[7]&&arguments[7],...c};super(C,Z.FragmentUrl,{effectWrapper:"number"!==typeof c&&c.effectWrapper?void 0:new U(C,d,b),...b})}static _Parse(C,c,d,b){return j.e.Parse((()=>new q(C.name,C.options,c,C.renderTargetSamplingMode,C._engine,C.reusable)),C,d,b)}}function B(C,c,d,b,X,P,R,p){const j=c.getEngine();return c.isReady=!1,X=X??c.samplingMode,b=b??c.type,P=P??c.format,R=R??c.width,p=p??c.height,-1===b&&(b=0),new Promise((g=>{const k=new V.d("postprocess",C,null,null,1,null,X,j,!1,void 0,b,void 0,null,!1,P);k.externalTextureSamplerBinding=!0;const Z=j.createRenderTargetTexture({width:R,height:p},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:X,type:b,format:P});k.onEffectCreatedObservable.addOnce((C=>{C.executeWhenCompiled((()=>{k.onApply=C=>{C._bindTexture("textureSampler",c),C.setFloat2("scale",1,1)},d.postProcessManager.directRender([k],Z,!0),j.restoreDefaultFramebuffer(),j._releaseTexture(c),k&&k.dispose(),Z._swapAndDie(c),c.type=b,c.format=5,c.isReady=!0,g(c)}))}))}))}let t,e;function n(C){t||(t=new Float32Array(1),e=new Int32Array(t.buffer)),t[0]=C;const c=e[0];let d=c>>16&32768,b=c>>12&2047;const X=c>>23&255;return X<103?d:X>142?(d|=31744,d|=(255==X?0:1)&&8388607&c,d):X<113?(b|=2048,d|=(b>>114-X)+(b>>113-X&1),d):(d|=X-112<<10|b>>1,d+=1&b,d)}function W(C){const c=(32768&C)>>15,d=(31744&C)>>10,b=1023&C;return 0===d?(c?-1:1)*Math.pow(2,-14)*(b/Math.pow(2,10)):31==d?b?NaN:1/0*(c?-1:1):(c?-1:1)*Math.pow(2,d-15)*(1+b/Math.pow(2,10))}(0,P.e)([(0,A.P)()],q.prototype,"face",null),R.c._RescalePostProcessFactory=C=>new u("rescale",1,null,2,C,!1,0);const E=async(C,c,P,R,p)=>{const j=C.NC(),g=j.getEngine();let k;if(g.isWebGPU?C.isCube?await d.e(60).then(d.bind(d,14956)):await d.e(61).then(d.bind(d,14960)):C.isCube?await d.e(58).then(d.bind(d,14948)):await d.e(59).then(d.bind(d,14951)),C.isCube){const C=["#define POSITIVEX","#define NEGATIVEX","#define POSITIVEY","#define NEGATIVEY","#define POSITIVEZ","#define NEGATIVEZ"];k=new V.d("lodCube","lodCube",{uniforms:["lod","gamma"],samplingMode:b.b.NEAREST_NEAREST_MIPNEAREST,Gc:g,defines:C[R],shaderLanguage:g.isWebGPU?1:0})}else k=new V.d("lod","lod",{uniforms:["lod","gamma"],samplingMode:b.b.NEAREST_NEAREST_MIPNEAREST,Gc:g,shaderLanguage:g.isWebGPU?1:0});await new Promise((C=>{k.onEffectCreatedObservable.addOnce((c=>{c.executeWhenCompiled((()=>{C(0)}))}))}));const Z=new X.c("temp",{width:c,height:P},j,!1);k.onApply=function(c){c.setTexture("textureSampler",C),c.setFloat("lod",p),c.setInt("gamma",C.gammaSpace?1:0)};const U=C.getInternalTexture();try{if(Z.renderTarget&&U){const d=U.samplingMode;0!==p?C.updateSamplingMode(b.b.NEAREST_NEAREST_MIPNEAREST):C.updateSamplingMode(b.b.NEAREST_NEAREST),j.postProcessManager.directRender([k],Z.renderTarget,!0),C.updateSamplingMode(d);const X=await g.readPixels(0,0,c,P),V=new Uint8Array(X.buffer,0,X.byteLength);return g.unBindFramebuffer(Z.renderTarget),V}throw Error("Render to texture failed.")}finally{Z.dispose(),k.dispose()}};async function N(C,c,d){let b=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,X=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;return!C.isReady()&&C._texture&&await new Promise(((c,d)=>{null!==C._texture?C._texture.onLoadedObservable.addOnce((()=>{c(0)})):d(0)})),await E(C,c,d,b,X)}const r={CreateResizedCopy:function(C,c,d){let P=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const V=C.NC(),R=V.getEngine(),p=new X.c("resized"+C.name,{width:c,height:d},V,!C.noMipmap,!0,C._texture.type,!1,C.samplingMode,!1);p.wrapU=C.wrapU,p.wrapV=C.wrapV,p.uOffset=C.uOffset,p.vOffset=C.vOffset,p.uScale=C.uScale,p.vScale=C.vScale,p.uAng=C.uAng,p.vAng=C.vAng,p.wAng=C.wAng,p.coordinatesIndex=C.coordinatesIndex,p.level=C.level,p.anisotropicFilteringLevel=C.anisotropicFilteringLevel,p._texture.isReady=!1,C.wrapU=b.b.CLAMP_ADDRESSMODE,C.wrapV=b.b.CLAMP_ADDRESSMODE;const j=new u("pass",1,null,P?b.b.BILINEAR_SAMPLINGMODE:b.b.NEAREST_SAMPLINGMODE,R,!1,0);return j.externalTextureSamplerBinding=!0,j.onEffectCreatedObservable.addOnce((c=>{c.executeWhenCompiled((()=>{j.onApply=function(c){c.setTexture("textureSampler",C)};const c=p.renderTarget;c&&(V.postProcessManager.directRender([j],c),R.unBindFramebuffer(c),p.disposeFramebufferObjects(),j.dispose(),p.getInternalTexture().isReady=!0)}))})),p},ApplyPostProcess:B,ToHalfFloat:n,FromHalfFloat:W,GetTextureDataAsync:N}},12499:(C,c,d)=>{d.d(c,{d:()=>A});var b=d(12384),X=d(12496),P=d(12221),V=d(12403),R=d(12289),p=d(12388),j=d(12431),g=d(12345),k=d(12283),Z=d(12361),U=d(12508);k.c.prototype.setTextureFromPostProcess=function(C,c,d){var b;let X=null;c&&(c._forcedOutputTexture?X=c._forcedOutputTexture:c._textures.data[c._currentRenderTextureInd]&&(X=c._textures.data[c._currentRenderTextureInd])),this._bindTexture(C,(null===(b=X)||void 0===b?void 0:b.texture)??null,d)},k.c.prototype.setTextureFromPostProcessOutput=function(C,c,d){var b;this._bindTexture(C,(null===c||void 0===c||null===(b=c._outputTexture)||void 0===b?void 0:b.texture)??null,d)},R.Effect.prototype.setTextureFromPostProcess=function(C,c){this._engine.setTextureFromPostProcess(this._samplers[C],c,C)},R.Effect.prototype.setTextureFromPostProcessOutput=function(C,c){this._engine.setTextureFromPostProcessOutput(this._samplers[C],c,C)};class A{static get ForceGLSL(){return U.e.ForceGLSL}static set ForceGLSL(C){U.e.ForceGLSL=C}static RegisterShaderCodeProcessing(C,c){U.e.RegisterShaderCodeProcessing(C,c)}get name(){return this._effectWrapper.name}set name(C){this._effectWrapper.name=C}get alphaMode(){return this._effectWrapper.alphaMode}set alphaMode(C){this._effectWrapper.alphaMode=C}get samples(){return this._samples}set samples(C){this._samples=Math.min(C,this._engine.getCaps().maxMSAASamples),this._textures.forEach((C=>{C.setSamples(this._samples)}))}get shaderLanguage(){return this._shaderLanguage}getEffectName(){return this._fragmentUrl}set onActivate(C){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),C&&(this._onActivateObserver=this.onActivateObservable.add(C))}set onSizeChanged(C){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(C)}set onApply(C){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(C)}set onBeforeRender(C){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(C)}set onAfterRender(C){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(C)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(C){this._forcedOutputTexture=C}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.yc(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(C,c,d,b,R,p){var j;let g=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,k=arguments.length>7?arguments[7]:void 0,Z=arguments.length>8?arguments[8]:void 0,u=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,q=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0,B=arguments.length>11&&void 0!==arguments[11]?arguments[11]:"postprocess",t=arguments.length>12?arguments[12]:void 0,e=arguments.length>13&&void 0!==arguments[13]&&arguments[13],n=arguments.length>14&&void 0!==arguments[14]?arguments[14]:5,W=arguments.length>15?arguments[15]:void 0,E=arguments.length>16?arguments[16]:void 0;this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.Wc=!0,this.forceAutoClearInAlphaMode=!1,this.animations=[],this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._webGPUReady=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new X.f(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new V.Vector2(1,1),this._texelSize=V.Vector2.Zero(),this.onActivateObservable=new P.b,this.onSizeChangedObservable=new P.b,this.onApplyObservable=new P.b,this.onBeforeRenderObservable=new P.b,this.onAfterRenderObservable=new P.b,this.Uc=new P.b;let N,r=1,M=null;if(d&&!Array.isArray(d)){const C=d;d=C.uniforms??null,b=C.samplers??null,r=C.size??1,p=C.camera??null,g=C.samplingMode??1,k=C.Gc,Z=C.reusable,u=Array.isArray(C.defines)?C.defines.join("\n"):C.defines??null,q=C.textureType??0,B=C.vertexUrl??"postprocess",t=C.indexParameters,e=C.blockCompilation??!1,n=C.textureFormat??5,W=C.shaderLanguage??0,M=C.uniformBuffers??null,E=C.extraInitializations,N=C.effectWrapper}else R&&(r="number"===typeof R?R:{width:R.width,height:R.height});if(this._useExistingThinPostProcess=!!N,this._effectWrapper=N??new U.e({name:C,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:c,Gc:k||(null===(j=p)||void 0===j?void 0:j.NC().getEngine()),uniforms:d,samplers:b,uniformBuffers:M,defines:u,vertexUrl:B,indexParameters:t,blockCompilation:!0,shaderLanguage:W,extraInitializations:void 0}),this.name=C,this.onEffectCreatedObservable=this._effectWrapper.onEffectCreatedObservable,null!=p?(this._camera=p,this._scene=p.NC(),p.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):k&&(this._engine=k,this._engine.postProcesses.push(this)),this._options=r,this.renderTargetSamplingMode=g||1,this._reusable=Z||!1,this._textureType=q,this._textureFormat=n,this._shaderLanguage=W||0,this._samplers=b||[],-1===this._samplers.indexOf("textureSampler")&&this._samplers.push("textureSampler"),this._fragmentUrl=c,this._vertexUrl=B,this._parameters=d||[],-1===this._parameters.indexOf("scale")&&this._parameters.push("scale"),this._uniformBuffers=M||[],this._indexParameters=t,!this._useExistingThinPostProcess){this._webGPUReady=1===this._shaderLanguage;const C=[];this._gatherImports(this._engine.isWebGPU&&!A.ForceGLSL,C),this._effectWrapper._webGPUReady=this._webGPUReady,this._effectWrapper._postConstructor(e,u,E,C)}}_gatherImports(){let C=arguments.length>1?arguments[1]:void 0;arguments.length>0&&void 0!==arguments[0]&&arguments[0]&&this._webGPUReady?C.push(Promise.all([d.e(53).then(d.bind(d,14925))])):C.push(Promise.all([Promise.resolve().then(d.bind(d,12521))]))}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._effectWrapper.drawWrapper.effect}shareOutputWith(C){return this._disposeTextures(),this._shareOutputWithPostProcess=C,this}useOwnOutput(){0==this._textures.length&&(this._textures=new X.f(2)),this._shareOutputWithPostProcess=null}updateEffect(){let C=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,b=arguments.length>3?arguments[3]:void 0,X=arguments.length>4?arguments[4]:void 0,P=arguments.length>5?arguments[5]:void 0,V=arguments.length>6?arguments[6]:void 0,R=arguments.length>7?arguments[7]:void 0;this._effectWrapper.updateEffect(C,c,d,b,X,P,V,R),this._postProcessDefines=Array.isArray(this._effectWrapper.options.defines)?this._effectWrapper.options.defines.join("\n"):this._effectWrapper.options.defines}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(C,c){let d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;for(let X=0;X<this._textureCache.length;X++)if(this._textureCache[X].texture.width===C.width&&this._textureCache[X].texture.height===C.height&&this._textureCache[X].postProcessChannel===d&&this._textureCache[X].texture._generateDepthBuffer===c.generateDepthBuffer&&this._textureCache[X].texture.samples===c.samples)return this._textureCache[X].texture;const b=this._engine.createRenderTargetTexture(C,c);return this._textureCache.push({texture:b,postProcessChannel:d,lastUsedRenderId:-1}),b}_flushTextureCache(){const C=this._renderId;for(let c=this._textureCache.length-1;c>=0;c--)if(C-this._textureCache[c].lastUsedRenderId>100){let C=!1;for(let d=0;d<this._textures.length;d++)if(this._textures.data[d]===this._textureCache[c].texture){C=!0;break}C||(this._textureCache[c].texture.dispose(),this._textureCache.splice(c,1))}}resize(C,c){let d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,b=arguments.length>3&&void 0!==arguments[3]&&arguments[3],X=arguments.length>4&&void 0!==arguments[4]&&arguments[4];this._textures.length>0&&this._textures.reset(),this.width=C,this.height=c;let P=null;if(d)for(let p=0;p<d._postProcesses.length;p++)if(null!==d._postProcesses[p]){P=d._postProcesses[p];break}const V={width:this.width,height:this.height},R={generateMipMaps:b,generateDepthBuffer:X||P===this,generateStencilBuffer:(X||P===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples,label:"PostProcessRTT-"+this.name};this._textures.push(this._createRenderTargetTexture(V,R,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(V,R,1)),this._texelSize.yc(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}_getTarget(){let C;if(this._shareOutputWithPostProcess)C=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)C=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{let c;C=this.inputTexture;for(let d=0;d<this._textureCache.length;d++)if(this._textureCache[d].texture===C){c=this._textureCache[d];break}c&&(c.lastUsedRenderId=this._renderId)}return C}activate(C){var c,d;let b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,X=arguments.length>2?arguments[2]:void 0;const P=null===C||void 0!==C.cameraRigMode?C||this._camera:null,V=(null===P||void 0===P?void 0:P.NC())??C,R=V.getEngine(),p=R.getCaps().maxTextureSize,j=(b?b.width:this._engine.getRenderWidth(!0))*this._options|0,g=(b?b.height:this._engine.getRenderHeight(!0))*this._options|0;let k=this._options.width||j,U=this._options.height||g;const A=7!==this.renderTargetSamplingMode&&1!==this.renderTargetSamplingMode&&2!==this.renderTargetSamplingMode;let u=null;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const C=R.currentViewport;C&&(k*=C.width,U*=C.height)}(A||this.alwaysForcePOT)&&(this._options.width||(k=R.needPOTTextures?(0,Z.g)(k,p,this.scaleMode):k),this._options.height||(U=R.needPOTTextures?(0,Z.g)(U,p,this.scaleMode):U)),this.width===k&&this.height===U&&(u=this._getTarget())||this.resize(k,U,P,A,X),this._textures.forEach((C=>{C.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(C,this.samples)})),this._flushTextureCache(),this._renderId++}return u||(u=this._getTarget()),this.enablePixelPerfectMode?(this._scaleRatio.yc(j/k,g/U),this._engine.bindFramebuffer(u,0,j,g,this.forceFullscreenViewport)):(this._scaleRatio.yc(1,1),this._engine.bindFramebuffer(u,0,void 0,void 0,this.forceFullscreenViewport)),null===(c=(d=this._engine)._debugInsertMarker)||void 0===c||c.call(d,`post process ${this.name} input`),this.onActivateObservable.notifyObservers(P),this.Wc&&(0===this.alphaMode||this.forceAutoClearInAlphaMode)&&this._engine.clear(this.clearColor?this.clearColor:V.clearColor,V._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),u}get isSupported(){return this._effectWrapper.drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){return this._effectWrapper.isReady()}apply(){if(!this._effectWrapper.isReady())return null;let C;var c;(this._engine.enableEffect(this._effectWrapper.drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a),this._engine.setAlphaMode(this.alphaMode),C=this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?this._forcedOutputTexture:this.inputTexture,this.externalTextureSamplerBinding)||this._effectWrapper.drawWrapper.effect._bindTexture("textureSampler",null===(c=C)||void 0===c?void 0:c.texture);return this._effectWrapper.drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._effectWrapper.drawWrapper.effect),this._effectWrapper.bind(!0),this._effectWrapper.drawWrapper.effect}_disposeTextures(){this._shareOutputWithPostProcess||this._forcedOutputTexture?this._disposeTextureCache():(this._disposeTextureCache(),this._textures.dispose())}_disposeTextureCache(){for(let C=this._textureCache.length-1;C>=0;C--)this._textureCache[C].texture.dispose();this._textureCache.length=0}setPrePassRenderer(C){return!!this._prePassEffectConfiguration&&(this._prePassEffectConfiguration=C.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0)}dispose(C){let c;if(C=C||this._camera,this._useExistingThinPostProcess||this._effectWrapper.dispose(),this._disposeTextures(),this._scene&&(c=this._scene.postProcesses.indexOf(this),-1!==c&&this._scene.postProcesses.splice(c,1)),this._parentContainer){const C=this._parentContainer.postProcesses.indexOf(this);C>-1&&this._parentContainer.postProcesses.splice(C,1),this._parentContainer=null}if(c=this._engine.postProcesses.indexOf(this),-1!==c&&this._engine.postProcesses.splice(c,1),this.Uc.notifyObservers(),C){if(C.detachPostProcess(this),c=C._postProcesses.indexOf(this),0===c&&C._postProcesses.length>0){const C=this._camera._getFirstPostProcess();C&&C.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear(),this.onEffectCreatedObservable.clear()}}serialize(){const C=j.e.Serialize(this),c=this.getCamera()||this._scene&&this._scene.activeCamera;return C.customType="BABYLON."+this.getClassName(),C.cameraId=c?c.id:null,C.reusable=this._reusable,C.textureType=this._textureType,C.fragmentUrl=this._fragmentUrl,C.parameters=this._parameters,C.samplers=this._samplers,C.uniformBuffers=this._uniformBuffers,C.options=this._options,C.defines=this._postProcessDefines,C.textureFormat=this._textureFormat,C.vertexUrl=this._vertexUrl,C.indexParameters=this._indexParameters,C}clone(){const C=this.serialize();C._engine=this._engine,C.cameraId=null;const c=A.Parse(C,this._scene,"");return c?(c.onActivateObservable=this.onActivateObservable.clone(),c.onSizeChangedObservable=this.onSizeChangedObservable.clone(),c.onApplyObservable=this.onApplyObservable.clone(),c.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),c.onAfterRenderObservable=this.onAfterRenderObservable.clone(),c._prePassEffectConfiguration=this._prePassEffectConfiguration,c):null}static Parse(C,c,d){const b=(0,g.b)(C.customType);if(!b||!b._Parse)return null;const X=c?c.getCameraById(C.cameraId):null;return b._Parse(C,X,c,d)}static _Parse(C,c,d,b){return j.e.Parse((()=>new A(C.name,C.fragmentUrl,C.parameters,C.samplers,C.options,c,C.renderTargetSamplingMode,C._engine,C.reusable,C.defines,C.textureType,C.vertexUrl,C.indexParameters,!1,C.textureFormat)),C,d,b)}}(0,b.e)([(0,p.P)()],A.prototype,"uniqueId",void 0),(0,b.e)([(0,p.P)()],A.prototype,"name",null),(0,b.e)([(0,p.P)()],A.prototype,"width",void 0),(0,b.e)([(0,p.P)()],A.prototype,"height",void 0),(0,b.e)([(0,p.P)()],A.prototype,"renderTargetSamplingMode",void 0),(0,b.e)([(0,p.s)()],A.prototype,"clearColor",void 0),(0,b.e)([(0,p.P)()],A.prototype,"Wc",void 0),(0,b.e)([(0,p.P)()],A.prototype,"forceAutoClearInAlphaMode",void 0),(0,b.e)([(0,p.P)()],A.prototype,"alphaMode",null),(0,b.e)([(0,p.P)()],A.prototype,"alphaConstants",void 0),(0,b.e)([(0,p.P)()],A.prototype,"enablePixelPerfectMode",void 0),(0,b.e)([(0,p.P)()],A.prototype,"forceFullscreenViewport",void 0),(0,b.e)([(0,p.P)()],A.prototype,"scaleMode",void 0),(0,b.e)([(0,p.P)()],A.prototype,"alwaysForcePOT",void 0),(0,b.e)([(0,p.P)("samples")],A.prototype,"_samples",void 0),(0,b.e)([(0,p.P)()],A.prototype,"adaptScaleToCurrentViewport",void 0),(0,g.e)("BABYLON.PostProcess",A)},12521:(C,c,d)=>{d.r(c),d.d(c,{postprocessVertexShader:()=>V});var b=d(12292);const X="postprocessVertexShader",P="attribute vec2 position;uniform vec2 scale;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=(position*madd+madd)*scale;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";b.e.ShadersStore[X]||(b.e.ShadersStore[X]=P);const V={name:X,shader:P}}}]);