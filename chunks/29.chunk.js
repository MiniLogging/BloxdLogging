"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[29],{13220:(z,u,Y)=>{Y.r(u),Y.d(u,{_BasisTextureLoader:()=>o});var H,E=Y(10945),J=Y(11415),l=Y(11046);function T(){const z=0,u=1,Y=2,H=3,E=6,J=8,l=9,T=10,b=14;let L=null;function D(z,u,Y,H,E){const J=z.getImageTranscodedSizeInBytes(u,Y,H);let l=new Uint8Array(J);if(!z.transcodeImage(l,u,Y,H,1,0))return null;if(E){l=function(z,u,Y,H){const E=new Uint16Array(4),J=new Uint16Array(Y*H),l=Y/4,T=H/4;for(let b=0;b<T;b++)for(let H=0;H<l;H++){const T=u+8*(b*l+H);E[0]=z[T]|z[T+1]<<8,E[1]=z[T+2]|z[T+3]<<8,E[2]=(2*(31&E[0])+1*(31&E[1]))/3|(2*(2016&E[0])+1*(2016&E[1]))/3&2016|(2*(63488&E[0])+1*(63488&E[1]))/3&63488,E[3]=(2*(31&E[1])+1*(31&E[0]))/3|(2*(2016&E[1])+1*(2016&E[0]))/3&2016|(2*(63488&E[1])+1*(63488&E[0]))/3&63488;for(let u=0;u<4;u++){const l=z[T+4+u];let L=(4*b+u)*Y+4*H;J[L++]=E[3&l],J[L++]=E[l>>2&3],J[L++]=E[l>>4&3],J[L++]=E[l>>6&3]}}return J}(l,0,z.getImageWidth(u,Y)+3&-4,z.getImageHeight(u,Y)+3&-4)}return l}onmessage=g=>{if("init"===g.data.action){if(g.data.url)try{importScripts(g.data.url)}catch(M){postMessage({action:"error",error:M})}L||(L=BASIS({wasmBinary:g.data.wasmBinary})),null!==L&&L.then((z=>{BASIS=z,z.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===g.data.action){const L=g.data.config,M=g.data.imageData,q=new BASIS.BasisFile(M),C=function(z){const u=z.getHasAlpha(),Y=z.getNumImages(),H=[];for(let E=0;E<Y;E++){const u={levels:[]},Y=z.getNumLevels(E);for(let H=0;H<Y;H++){const Y={width:z.getImageWidth(E,H),height:z.getImageHeight(E,H)};u.levels.push(Y)}H.push(u)}return{jl:u,images:H}}(q);let K=g.data.ignoreSupportedFormats?null:function(L,D){let g=null;L.supportedCompressionFormats&&(g=L.supportedCompressionFormats.astc?T:L.supportedCompressionFormats.bc7?E:L.supportedCompressionFormats.s3tc?D.jl?H:Y:L.supportedCompressionFormats.pvrtc?D.jl?l:J:L.supportedCompressionFormats.etc2?u:L.supportedCompressionFormats.etc1?z:b);return g}(g.data.config,C),h=!1;null===K&&(h=!0,K=C.jl?H:Y);let o=!0;q.startTranscoding()||(o=!1);const d=[];for(let z=0;z<C.images.length&&o;z++){const u=C.images[z];if(void 0===L.loadSingleImage||L.loadSingleImage===z){let Y=u.levels.length;!1===L.loadMipmapLevels&&(Y=1);for(let H=0;H<Y;H++){const Y=u.levels[H],E=D(q,z,H,K,h);if(!E){o=!1;break}Y.transcodedPixels=E,d.push(Y.transcodedPixels.buffer)}}}q.close(),q.delete(),h&&(K=-1),o?postMessage({action:"transcode",success:o,id:g.data.id,fileInfo:C,format:K},d):postMessage({action:"transcode",success:o,id:g.data.id})}}}!function(z){z[z.cTFETC1=0]="cTFETC1",z[z.cTFETC2=1]="cTFETC2",z[z.cTFBC1=2]="cTFBC1",z[z.cTFBC3=3]="cTFBC3",z[z.cTFBC4=4]="cTFBC4",z[z.cTFBC5=5]="cTFBC5",z[z.cTFBC7=6]="cTFBC7",z[z.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",z[z.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",z[z.cTFASTC_4x4=10]="cTFASTC_4x4",z[z.cTFATC_RGB=11]="cTFATC_RGB",z[z.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",z[z.cTFRGBA32=13]="cTFRGBA32",z[z.cTFRGB565=14]="cTFRGB565",z[z.cTFBGR565=15]="cTFBGR565",z[z.cTFRGBA4444=16]="cTFRGBA4444",z[z.cTFFXT1_RGB=17]="cTFFXT1_RGB",z[z.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",z[z.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",z[z.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",z[z.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(H||(H={}));const b={JSModuleURL:`${E.e._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${E.e._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let L=null,D=null,g=0;const M=async()=>(L||(L=new Promise(((z,u)=>{D?z(D):E.e.LoadFileAsync(E.e.GetBabylonScriptURL(b.WasmModuleURL)).then((Y=>{if("function"!==typeof URL)return u("Basis transcoder requires an environment with a URL constructor");const H=URL.createObjectURL(new Blob([`(${T})()`],{type:"application/javascript"}));D=new Worker(H),async function(z,u,Y){return await new Promise(((H,J)=>{const l=u=>{"init"===u.data.action?(z.removeEventListener("message",l),H(z)):"error"===u.data.action&&J(u.data.error||"error initializing worker")};z.addEventListener("message",l),z.postMessage({action:"init",url:Y?E.e.GetBabylonScriptURL(Y):void 0,wasmBinary:u},[u])}))}(D,Y,b.JSModuleURL).then(z,u)})).catch(u)}))),await L),q=async(z,u)=>{const Y=z instanceof ArrayBuffer?new Uint8Array(z):z;return await new Promise(((z,H)=>{M().then((()=>{const E=g++,J=u=>{"transcode"===u.data.action&&u.data.id===E&&(D.removeEventListener("message",J),u.data.success?z(u.data):H("Transcode is not supported on this device"))};D.addEventListener("message",J);const l=new Uint8Array(Y.byteLength);l.set(new Uint8Array(Y.buffer,Y.byteOffset,Y.byteLength)),D.postMessage({action:"transcode",id:E,imageData:l,config:u,ignoreSupportedFormats:false},[l.buffer])}),(z=>{H(z)}))}))},C=(z,u)=>{var Y;let H=null===(Y=u._gl)||void 0===Y?void 0:Y.TEXTURE_2D;var E;z.isCube&&(H=null===(E=u._gl)||void 0===E?void 0:E.TEXTURE_CUBE_MAP);u._bindTextureDirectly(H,z,!0)},K=(z,u)=>{const Y=z.getEngine();for(let T=0;T<u.fileInfo.images.length;T++){const b=u.fileInfo.images[T].levels[0];if(z._invertVScale=z.invertY,-1===u.format||u.format===H.cTFRGB565)if(z.type=10,z.format=4,!Y._features.basisNeedsPOT||Math.log2(b.width)%1===0&&Math.log2(b.height)%1===0)z._invertVScale=!z.invertY,z.width=b.width+3&-4,z.height=b.height+3&-4,z.samplingMode=2,C(z,Y),Y._uploadDataToTextureDirectly(z,new Uint16Array(b.transcodedPixels.buffer),T,0,4,!0);else{const u=new l.d(Y,2);z._invertVScale=z.invertY,u.type=10,u.format=4,u.width=b.width+3&-4,u.height=b.height+3&-4,C(u,Y),Y._uploadDataToTextureDirectly(u,new Uint16Array(b.transcodedPixels.buffer),T,0,4,!0),Y._rescaleTexture(u,z,Y.scenes[0],Y._getInternalFormat(4),(()=>{Y._releaseTexture(u),C(z,Y)}))}else{z.width=b.width,z.height=b.height,z.generateMipMaps=u.fileInfo.images[T].levels.length>1;const H=h.GetInternalFormatFromBasisFormat(u.format,Y);z.format=H,C(z,Y);const l=u.fileInfo.images[T].levels;for(let u=0;u<l.length;u++){const E=l[u];Y._uploadCompressedDataToTextureDirectly(z,H,E.width,E.height,E.transcodedPixels,T,u)}!Y._features.basisNeedsPOT||Math.log2(z.width)%1===0&&Math.log2(z.height)%1===0||(E.e.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),z._cachedWrapU=J.b.CLAMP_ADDRESSMODE,z._cachedWrapV=J.b.CLAMP_ADDRESSMODE)}}},h={JSModuleURL:b.JSModuleURL,WasmModuleURL:b.WasmModuleURL,GetInternalFormatFromBasisFormat:(z,u)=>{let Y;switch(z){case H.cTFETC1:Y=36196;break;case H.cTFBC1:Y=33776;break;case H.cTFBC4:Y=33779;break;case H.cTFASTC_4x4:Y=37808;break;case H.cTFETC2:Y=37496;break;case H.cTFBC7:Y=36492}if(void 0===Y)throw"The chosen Basis transcoder format is not currently supported";return Y},TranscodeAsync:q,LoadTextureFromTranscodeResult:K};Object.defineProperty(h,"JSModuleURL",{get:function(){return b.JSModuleURL},set:function(z){b.JSModuleURL=z}}),Object.defineProperty(h,"WasmModuleURL",{get:function(){return b.WasmModuleURL},set:function(z){b.WasmModuleURL=z}});class o{constructor(){this.supportCascades=!1}loadCubeData(z,u,Y,H,J){if(Array.isArray(z))return;const l=u.getEngine().getCaps(),T={supportedCompressionFormats:{etc1:!!l.etc1,s3tc:!!l.s3tc,pvrtc:!!l.pvrtc,etc2:!!l.etc2,astc:!!l.astc,bc7:!!l.bptc}};q(z,T).then((z=>{const Y=z.fileInfo.images[0].levels.length>1&&u.generateMipMaps;K(u,z),u.getEngine()._setCubeMapTextureParams(u,Y),u.isReady=!0,u.onLoadedObservable.notifyObservers(u),u.onLoadedObservable.clear(),H&&H()})).catch((z=>{E.e.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),u.isReady=!0,J&&J(z)}))}loadData(z,u,Y){const H=u.getEngine().getCaps(),J={supportedCompressionFormats:{etc1:!!H.etc1,s3tc:!!H.s3tc,pvrtc:!!H.pvrtc,etc2:!!H.etc2,astc:!!H.astc,bc7:!!H.bptc}};q(z,J).then((z=>{const H=z.fileInfo.images[0].levels[0],E=z.fileInfo.images[0].levels.length>1&&u.generateMipMaps;Y(H.width,H.height,E,-1!==z.format,(()=>{K(u,z)}))})).catch((z=>{E.e.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),E.e.Warn(`Failed to transcode Basis file: ${z}`),Y(0,0,!1,!1,(()=>{}),!0)}))}}}}]);