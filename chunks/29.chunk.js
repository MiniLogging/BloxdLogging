"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[29],{13342:(h,d,m)=>{m.r(d),m.d(d,{_BasisTextureLoader:()=>B});var j,A=m(11107),b=m(11543),w=m(11216);function a(){const h=0,d=1,m=2,j=3,A=6,b=8,w=9,a=10,D=14;let S=null;function M(h,d,m,j,A){const b=h.getImageTranscodedSizeInBytes(d,m,j);let w=new Uint8Array(b);if(!h.transcodeImage(w,d,m,j,1,0))return null;if(A){w=function(h,d,m,j){const A=new Uint16Array(4),b=new Uint16Array(m*j),w=m/4,a=j/4;for(let D=0;D<a;D++)for(let j=0;j<w;j++){const a=d+8*(D*w+j);A[0]=h[a]|h[a+1]<<8,A[1]=h[a+2]|h[a+3]<<8,A[2]=(2*(31&A[0])+1*(31&A[1]))/3|(2*(2016&A[0])+1*(2016&A[1]))/3&2016|(2*(63488&A[0])+1*(63488&A[1]))/3&63488,A[3]=(2*(31&A[1])+1*(31&A[0]))/3|(2*(2016&A[1])+1*(2016&A[0]))/3&2016|(2*(63488&A[1])+1*(63488&A[0]))/3&63488;for(let d=0;d<4;d++){const w=h[a+4+d];let S=(4*D+d)*m+4*j;b[S++]=A[3&w],b[S++]=A[w>>2&3],b[S++]=A[w>>4&3],b[S++]=A[w>>6&3]}}return b}(w,0,h.getImageWidth(d,m)+3&-4,h.getImageHeight(d,m)+3&-4)}return w}onmessage=q=>{if("init"===q.data.action){if(q.data.url)try{importScripts(q.data.url)}catch(E){postMessage({action:"error",error:E})}S||(S=BASIS({wasmBinary:q.data.wasmBinary})),null!==S&&S.then((h=>{BASIS=h,h.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===q.data.action){const S=q.data.config,E=q.data.imageData,I=new BASIS.BasisFile(E),R=function(h){const d=h.getHasAlpha(),m=h.getNumImages(),j=[];for(let A=0;A<m;A++){const d={levels:[]},m=h.getNumLevels(A);for(let j=0;j<m;j++){const m={width:h.getImageWidth(A,j),height:h.getImageHeight(A,j)};d.levels.push(m)}j.push(d)}return{Nd:d,images:j}}(I);let Z=q.data.ignoreSupportedFormats?null:function(S,M){let q=null;S.supportedCompressionFormats&&(q=S.supportedCompressionFormats.astc?a:S.supportedCompressionFormats.bc7?A:S.supportedCompressionFormats.s3tc?M.Nd?j:m:S.supportedCompressionFormats.pvrtc?M.Nd?w:b:S.supportedCompressionFormats.etc2?d:S.supportedCompressionFormats.etc1?h:D);return q}(q.data.config,R),L=!1;null===Z&&(L=!0,Z=R.Nd?j:m);let B=!0;I.startTranscoding()||(B=!1);const V=[];for(let h=0;h<R.images.length&&B;h++){const d=R.images[h];if(void 0===S.loadSingleImage||S.loadSingleImage===h){let m=d.levels.length;!1===S.loadMipmapLevels&&(m=1);for(let j=0;j<m;j++){const m=d.levels[j],A=M(I,h,j,Z,L);if(!A){B=!1;break}m.transcodedPixels=A,V.push(m.transcodedPixels.buffer)}}}I.close(),I.delete(),L&&(Z=-1),B?postMessage({action:"transcode",success:B,id:q.data.id,fileInfo:R,format:Z},V):postMessage({action:"transcode",success:B,id:q.data.id})}}}!function(h){h[h.cTFETC1=0]="cTFETC1",h[h.cTFETC2=1]="cTFETC2",h[h.cTFBC1=2]="cTFBC1",h[h.cTFBC3=3]="cTFBC3",h[h.cTFBC4=4]="cTFBC4",h[h.cTFBC5=5]="cTFBC5",h[h.cTFBC7=6]="cTFBC7",h[h.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",h[h.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",h[h.cTFASTC_4x4=10]="cTFASTC_4x4",h[h.cTFATC_RGB=11]="cTFATC_RGB",h[h.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",h[h.cTFRGBA32=13]="cTFRGBA32",h[h.cTFRGB565=14]="cTFRGB565",h[h.cTFBGR565=15]="cTFBGR565",h[h.cTFRGBA4444=16]="cTFRGBA4444",h[h.cTFFXT1_RGB=17]="cTFFXT1_RGB",h[h.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",h[h.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",h[h.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",h[h.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(j||(j={}));const D={JSModuleURL:`${A.e._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${A.e._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let S=null,M=null,q=0;const E=async()=>(S||(S=new Promise(((h,d)=>{M?h(M):A.e.LoadFileAsync(A.e.GetBabylonScriptURL(D.WasmModuleURL)).then((m=>{if("function"!==typeof URL)return d("Basis transcoder requires an environment with a URL constructor");const j=URL.createObjectURL(new Blob([`(${a})()`],{type:"application/javascript"}));M=new Worker(j),async function(h,d,m){return await new Promise(((j,b)=>{const w=d=>{"init"===d.data.action?(h.removeEventListener("message",w),j(h)):"error"===d.data.action&&b(d.data.error||"error initializing worker")};h.addEventListener("message",w),h.postMessage({action:"init",url:m?A.e.GetBabylonScriptURL(m):void 0,wasmBinary:d},[d])}))}(M,m,D.JSModuleURL).then(h,d)})).catch(d)}))),await S),I=async(h,d)=>{const m=h instanceof ArrayBuffer?new Uint8Array(h):h;return await new Promise(((h,j)=>{E().then((()=>{const A=q++,b=d=>{"transcode"===d.data.action&&d.data.id===A&&(M.removeEventListener("message",b),d.data.success?h(d.data):j("Transcode is not supported on this device"))};M.addEventListener("message",b);const w=new Uint8Array(m.byteLength);w.set(new Uint8Array(m.buffer,m.byteOffset,m.byteLength)),M.postMessage({action:"transcode",id:A,imageData:w,config:d,ignoreSupportedFormats:false},[w.buffer])}),(h=>{j(h)}))}))},R=(h,d)=>{var m;let j=null===(m=d._gl)||void 0===m?void 0:m.TEXTURE_2D;var A;h.isCube&&(j=null===(A=d._gl)||void 0===A?void 0:A.TEXTURE_CUBE_MAP);d._bindTextureDirectly(j,h,!0)},Z=(h,d)=>{const m=h.getEngine();for(let a=0;a<d.fileInfo.images.length;a++){const D=d.fileInfo.images[a].levels[0];if(h._invertVScale=h.invertY,-1===d.format||d.format===j.cTFRGB565)if(h.type=10,h.format=4,!m._features.basisNeedsPOT||Math.log2(D.width)%1===0&&Math.log2(D.height)%1===0)h._invertVScale=!h.invertY,h.width=D.width+3&-4,h.height=D.height+3&-4,h.samplingMode=2,R(h,m),m._uploadDataToTextureDirectly(h,new Uint16Array(D.transcodedPixels.buffer),a,0,4,!0);else{const d=new w.c(m,2);h._invertVScale=h.invertY,d.type=10,d.format=4,d.width=D.width+3&-4,d.height=D.height+3&-4,R(d,m),m._uploadDataToTextureDirectly(d,new Uint16Array(D.transcodedPixels.buffer),a,0,4,!0),m._rescaleTexture(d,h,m.scenes[0],m._getInternalFormat(4),(()=>{m._releaseTexture(d),R(h,m)}))}else{h.width=D.width,h.height=D.height,h.generateMipMaps=d.fileInfo.images[a].levels.length>1;const j=L.GetInternalFormatFromBasisFormat(d.format,m);h.format=j,R(h,m);const w=d.fileInfo.images[a].levels;for(let d=0;d<w.length;d++){const A=w[d];m._uploadCompressedDataToTextureDirectly(h,j,A.width,A.height,A.transcodedPixels,a,d)}!m._features.basisNeedsPOT||Math.log2(h.width)%1===0&&Math.log2(h.height)%1===0||(A.e.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),h._cachedWrapU=b.e.CLAMP_ADDRESSMODE,h._cachedWrapV=b.e.CLAMP_ADDRESSMODE)}}},L={JSModuleURL:D.JSModuleURL,WasmModuleURL:D.WasmModuleURL,GetInternalFormatFromBasisFormat:(h,d)=>{let m;switch(h){case j.cTFETC1:m=36196;break;case j.cTFBC1:m=33776;break;case j.cTFBC4:m=33779;break;case j.cTFASTC_4x4:m=37808;break;case j.cTFETC2:m=37496;break;case j.cTFBC7:m=36492}if(void 0===m)throw"The chosen Basis transcoder format is not currently supported";return m},TranscodeAsync:I,LoadTextureFromTranscodeResult:Z};Object.defineProperty(L,"JSModuleURL",{get:function(){return D.JSModuleURL},set:function(h){D.JSModuleURL=h}}),Object.defineProperty(L,"WasmModuleURL",{get:function(){return D.WasmModuleURL},set:function(h){D.WasmModuleURL=h}});class B{constructor(){this.supportCascades=!1}loadCubeData(h,d,m,j,b){if(Array.isArray(h))return;const w=d.getEngine().getCaps(),a={supportedCompressionFormats:{etc1:!!w.etc1,s3tc:!!w.s3tc,pvrtc:!!w.pvrtc,etc2:!!w.etc2,astc:!!w.astc,bc7:!!w.bptc}};I(h,a).then((h=>{const m=h.fileInfo.images[0].levels.length>1&&d.generateMipMaps;Z(d,h),d.getEngine()._setCubeMapTextureParams(d,m),d.isReady=!0,d.onLoadedObservable.notifyObservers(d),d.onLoadedObservable.clear(),j&&j()})).catch((h=>{A.e.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),d.isReady=!0,b&&b(h)}))}loadData(h,d,m){const j=d.getEngine().getCaps(),b={supportedCompressionFormats:{etc1:!!j.etc1,s3tc:!!j.s3tc,pvrtc:!!j.pvrtc,etc2:!!j.etc2,astc:!!j.astc,bc7:!!j.bptc}};I(h,b).then((h=>{const j=h.fileInfo.images[0].levels[0],A=h.fileInfo.images[0].levels.length>1&&d.generateMipMaps;m(j.width,j.height,A,-1!==h.format,(()=>{Z(d,h)}))})).catch((h=>{A.e.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),A.e.Warn(`Failed to transcode Basis file: ${h}`),m(0,0,!1,!1,(()=>{}),!0)}))}}}}]);