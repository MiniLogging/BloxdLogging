"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[30],{13680:(P,f,Y)=>{Y.r(f),Y.d(f,{_KTXTextureLoader:()=>i});var C=Y(11025);class q{constructor(P,f){if(this.data=P,this.isInvalid=!1,!q.IsValid(P))return this.isInvalid=!0,void C.e.Error("texture missing KTX identifier");const Y=Uint32Array.BYTES_PER_ELEMENT,m=new DataView(this.data.buffer,this.data.byteOffset+12,13*Y),L=67305985===m.getUint32(0,!0);return this.glType=m.getUint32(1*Y,L),this.glTypeSize=m.getUint32(2*Y,L),this.glFormat=m.getUint32(3*Y,L),this.glInternalFormat=m.getUint32(4*Y,L),this.glBaseInternalFormat=m.getUint32(5*Y,L),this.pixelWidth=m.getUint32(6*Y,L),this.pixelHeight=m.getUint32(7*Y,L),this.pixelDepth=m.getUint32(8*Y,L),this.numberOfArrayElements=m.getUint32(9*Y,L),this.numberOfFaces=m.getUint32(10*Y,L),this.numberOfMipmapLevels=m.getUint32(11*Y,L),this.bytesOfKeyValueData=m.getUint32(12*Y,L),0!==this.glType?(C.e.Error("only compressed formats currently supported"),void(this.isInvalid=!0)):(this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels),0===this.pixelHeight||0!==this.pixelDepth?(C.e.Error("only 2D textures currently supported"),void(this.isInvalid=!0)):0!==this.numberOfArrayElements?(C.e.Error("texture arrays not currently supported"),void(this.isInvalid=!0)):this.numberOfFaces!==f?(C.e.Error("number of faces expected"+f+", but found "+this.numberOfFaces),void(this.isInvalid=!0)):void(this.loadType=q.COMPRESSED_2D))}uploadLevels(P,f){switch(this.loadType){case q.COMPRESSED_2D:this._upload2DCompressedLevels(P,f);case q.TEX_2D:case q.COMPRESSED_3D:case q.TEX_3D:}}_upload2DCompressedLevels(P,f){let Y=q.HEADER_LEN+this.bytesOfKeyValueData,C=this.pixelWidth,m=this.pixelHeight;const L=f?this.numberOfMipmapLevels:1;for(let q=0;q<L;q++){const f=new Int32Array(this.data.buffer,this.data.byteOffset+Y,1)[0];Y+=4;for(let L=0;L<this.numberOfFaces;L++){const o=new Uint8Array(this.data.buffer,this.data.byteOffset+Y,f);P.getEngine()._uploadCompressedDataToTextureDirectly(P,P.format,C,m,o,L,q),Y+=f,Y+=3-(f+3)%4}C=Math.max(1,.5*C),m=Math.max(1,.5*m)}}static IsValid(P){if(P.byteLength>=12){const f=new Uint8Array(P.buffer,P.byteOffset,12);if(171===f[0]&&75===f[1]&&84===f[2]&&88===f[3]&&32===f[4]&&49===f[5]&&49===f[6]&&187===f[7]&&13===f[8]&&10===f[9]&&26===f[10]&&10===f[11])return!0}return!1}}q.HEADER_LEN=64,q.COMPRESSED_2D=0,q.COMPRESSED_3D=1,q.TEX_2D=2,q.TEX_3D=3;var m,L,o,w=Y(11790),d=Y(11014);function R(P,f){const Y=(null===f||void 0===f?void 0:f.jsDecoderModule)||KTX2DECODER;P&&(P.wasmUASTCToASTC&&(Y.LiteTranscoder_UASTC_ASTC.WasmModuleURL=P.wasmUASTCToASTC),P.wasmUASTCToBC7&&(Y.LiteTranscoder_UASTC_BC7.WasmModuleURL=P.wasmUASTCToBC7),P.wasmUASTCToRGBA_UNORM&&(Y.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=P.wasmUASTCToRGBA_UNORM),P.wasmUASTCToRGBA_SRGB&&(Y.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=P.wasmUASTCToRGBA_SRGB),P.wasmUASTCToR8_UNORM&&(Y.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=P.wasmUASTCToR8_UNORM),P.wasmUASTCToRG8_UNORM&&(Y.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=P.wasmUASTCToRG8_UNORM),P.jsMSCTranscoder&&(Y.MSCTranscoder.JSModuleURL=P.jsMSCTranscoder),P.wasmMSCTranscoder&&(Y.MSCTranscoder.WasmModuleURL=P.wasmMSCTranscoder),P.wasmZSTDDecoder&&(Y.ZSTDDecoder.WasmModuleURL=P.wasmZSTDDecoder)),f&&(f.wasmUASTCToASTC&&(Y.LiteTranscoder_UASTC_ASTC.WasmBinary=f.wasmUASTCToASTC),f.wasmUASTCToBC7&&(Y.LiteTranscoder_UASTC_BC7.WasmBinary=f.wasmUASTCToBC7),f.wasmUASTCToRGBA_UNORM&&(Y.LiteTranscoder_UASTC_RGBA_UNORM.WasmBinary=f.wasmUASTCToRGBA_UNORM),f.wasmUASTCToRGBA_SRGB&&(Y.LiteTranscoder_UASTC_RGBA_SRGB.WasmBinary=f.wasmUASTCToRGBA_SRGB),f.wasmUASTCToR8_UNORM&&(Y.LiteTranscoder_UASTC_R8_UNORM.WasmBinary=f.wasmUASTCToR8_UNORM),f.wasmUASTCToRG8_UNORM&&(Y.LiteTranscoder_UASTC_RG8_UNORM.WasmBinary=f.wasmUASTCToRG8_UNORM),f.jsMSCTranscoder&&(Y.MSCTranscoder.JSModule=f.jsMSCTranscoder),f.wasmMSCTranscoder&&(Y.MSCTranscoder.WasmBinary=f.wasmMSCTranscoder),f.wasmZSTDDecoder&&(Y.ZSTDDecoder.WasmBinary=f.wasmZSTDDecoder))}function y(P){let f;"undefined"===typeof P&&"undefined"!==typeof KTX2DECODER&&(P=KTX2DECODER),onmessage=Y=>{if(Y.data)switch(Y.data.action){case"init":{const C=Y.data.urls;C&&(C.jsDecoderModule&&"undefined"===typeof P&&(importScripts(C.jsDecoderModule),P=KTX2DECODER),R(C)),Y.data.wasmBinaries&&R(void 0,{...Y.data.wasmBinaries,jsDecoderModule:P}),f=new P.KTX2Decoder,postMessage({action:"init"});break}case"setDefaultDecoderOptions":P.KTX2Decoder.DefaultDecoderOptions=Y.data.options;break;case"decode":f.decode(Y.data.data,Y.data.caps,Y.data.options).then((P=>{const f=[];for(let Y=0;Y<P.mipmaps.length;++Y){const C=P.mipmaps[Y];C&&C.data&&f.push(C.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:P},f)})).catch((P=>{postMessage({action:"decoded",success:!1,Rf:P})}))}}}!function(P){P[P.ETC1S=0]="ETC1S",P[P.UASTC4x4=1]="UASTC4x4"}(m||(m={})),function(P){P[P.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",P[P.BC7_RGBA=1]="BC7_RGBA",P[P.BC3_RGBA=2]="BC3_RGBA",P[P.BC1_RGB=3]="BC1_RGB",P[P.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",P[P.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",P[P.ETC2_RGBA=6]="ETC2_RGBA",P[P.ETC1_RGB=7]="ETC1_RGB",P[P.RGBA32=8]="RGBA32",P[P.R8=9]="R8",P[P.RG8=10]="RG8"}(L||(L={})),function(P){P[P.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",P[P.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",P[P.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",P[P.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",P[P.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",P[P.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",P[P.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",P[P.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",P[P.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",P[P.RGBA8Format=32856]="RGBA8Format",P[P.R8Format=33321]="R8Format",P[P.RG8Format=33323]="RG8Format"}(o||(o={}));class r{static GetDefaultNumWorkers(){return"object"===typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static _Initialize(P){if(r._WorkerPoolPromise||r._DecoderModulePromise)return;const f={jsDecoderModule:d.Tools.GetBabylonScriptURL(this.URLConfig.jsDecoderModule,!0),wasmUASTCToASTC:d.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToASTC,!0),wasmUASTCToBC7:d.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToBC7,!0),wasmUASTCToRGBA_UNORM:d.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_UNORM,!0),wasmUASTCToRGBA_SRGB:d.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_SRGB,!0),wasmUASTCToR8_UNORM:d.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToR8_UNORM,!0),wasmUASTCToRG8_UNORM:d.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRG8_UNORM,!0),jsMSCTranscoder:d.Tools.GetBabylonScriptURL(this.URLConfig.jsMSCTranscoder,!0),wasmMSCTranscoder:d.Tools.GetBabylonScriptURL(this.URLConfig.wasmMSCTranscoder,!0),wasmZSTDDecoder:d.Tools.GetBabylonScriptURL(this.URLConfig.wasmZSTDDecoder,!0)};P&&"function"===typeof Worker&&"undefined"!==typeof URL?r._WorkerPoolPromise=new Promise((Y=>{const C=`${R}(${y})()`,q=URL.createObjectURL(new Blob([C],{type:"application/javascript"}));Y(new w.d(P,(async()=>await async function(P,f,Y){return await new Promise(((C,q)=>{const m=f=>{P.removeEventListener("error",m),P.removeEventListener("message",L),q(f)},L=f=>{"init"===f.data.action&&(P.removeEventListener("error",m),P.removeEventListener("message",L),C(P))};P.addEventListener("error",m),P.addEventListener("message",L),P.postMessage({action:"init",urls:Y,wasmBinaries:f})}))}(new Worker(q),void 0,f))))})):"undefined"===typeof r._KTX2DecoderModule?r._DecoderModulePromise=d.Tools.LoadBabylonScriptAsync(f.jsDecoderModule).then((()=>(r._KTX2DecoderModule=KTX2DECODER,r._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,r._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,R(f,r._KTX2DecoderModule),new r._KTX2DecoderModule.KTX2Decoder))):(r._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,r._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,r._DecoderModulePromise=Promise.resolve(new r._KTX2DecoderModule.KTX2Decoder))}constructor(P){let f=arguments.length>1&&void 0!==arguments[1]?arguments[1]:r.DefaultNumWorkers;this._engine=P;const Y="object"===typeof f&&f.workerPool||r.WorkerPool;if(Y)r._WorkerPoolPromise=Promise.resolve(Y);else{var C;if("object"===typeof f)r._KTX2DecoderModule=null===f||void 0===f||null===(C=f.binariesAndModulesContainer)||void 0===C?void 0:C.jsDecoderModule;else"undefined"!==typeof KTX2DECODER&&(r._KTX2DecoderModule=KTX2DECODER);const P="number"===typeof f?f:f.numWorkers??r.DefaultNumWorkers;r._Initialize(P)}}async _uploadAsync(P,f,Y){const C=this._engine.getCaps(),q={astc:!!C.astc,bptc:!!C.bptc,s3tc:!!C.s3tc,pvrtc:!!C.pvrtc,etc2:!!C.etc2,etc1:!!C.etc1};if(r._WorkerPoolPromise){const C=await r._WorkerPoolPromise;return await new Promise(((m,L)=>{C.push(((C,o)=>{const w=P=>{C.removeEventListener("error",w),C.removeEventListener("message",d),L(P),o()},d=P=>{if("decoded"===P.data.action){if(C.removeEventListener("error",w),C.removeEventListener("message",d),P.data.success)try{this._createTexture(P.data.decodedData,f,Y),m()}catch(q){L({message:q})}else L({message:P.data.Rf});o()}};C.addEventListener("error",w),C.addEventListener("message",d),C.postMessage({action:"setDefaultDecoderOptions",options:r.DefaultDecoderOptions._getKTX2DecoderOptions()});const R=new Uint8Array(P.byteLength);R.set(new Uint8Array(P.buffer,P.byteOffset,P.byteLength)),C.postMessage({action:"decode",data:R,caps:q,options:Y},[R.buffer])}))}))}if(r._DecoderModulePromise){const Y=await r._DecoderModulePromise;return r.DefaultDecoderOptions.isDirty&&(r._KTX2DecoderModule.KTX2Decoder.DefaultDecoderOptions=r.DefaultDecoderOptions._getKTX2DecoderOptions()),await new Promise(((q,m)=>{Y.decode(P,C).then((P=>{this._createTexture(P,f),q()})).catch((P=>{m({message:P})}))}))}throw new Error("KTX2 decoder module is not available")}_createTexture(P,f,Y){this._engine._bindTextureDirectly(3553,f),Y&&(Y.transcodedFormat=P.transcodedFormat,Y.isInGammaSpace=P.isInGammaSpace,Y.Gf=P.Gf,Y.transcoderName=P.transcoderName);let C=!0;switch(P.transcodedFormat){case 32856:f.type=0,f.format=5;break;case 33321:f.type=0,f.format=6;break;case 33323:f.type=0,f.format=7;break;default:f.format=P.transcodedFormat,C=!1}if(f._gammaSpace=P.isInGammaSpace,f.generateMipMaps=P.mipmaps.length>1,P.errors)throw new Error("KTX2 container - could not transcode the data. "+P.errors);for(let q=0;q<P.mipmaps.length;++q){const Y=P.mipmaps[q];if(!Y||!Y.data)throw new Error("KTX2 container - could not transcode one of the image");C?(f.width=Y.width,f.height=Y.height,this._engine._uploadDataToTextureDirectly(f,Y.data,0,q,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(f,P.transcodedFormat,Y.width,Y.height,Y.data,0,q)}f._extension=".ktx2",f.width=P.mipmaps[0].width,f.height=P.mipmaps[0].height,f.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static IsValid(P){if(P.byteLength>=12){const f=new Uint8Array(P.buffer,P.byteOffset,12);if(171===f[0]&&75===f[1]&&84===f[2]&&88===f[3]&&32===f[4]&&50===f[5]&&48===f[6]&&187===f[7]&&13===f[8]&&10===f[9]&&26===f[10]&&10===f[11])return!0}return!1}}r.URLConfig={jsDecoderModule:"https://cdn.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null},r.DefaultNumWorkers=r.GetDefaultNumWorkers(),r.DefaultDecoderOptions=new class{constructor(){this._isDirty=!0,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=!0,this._ktx2DecoderOptions={}}get isDirty(){return this._isDirty}get useRGBAIfASTCBC7NotAvailableWhenUASTC(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set useRGBAIfASTCBC7NotAvailableWhenUASTC(P){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==P&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=P,this._isDirty=!0)}get useRGBAIfOnlyBC1BC3AvailableWhenUASTC(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set useRGBAIfOnlyBC1BC3AvailableWhenUASTC(P){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==P&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=P,this._isDirty=!0)}get forceRGBA(){return this._forceRGBA}set forceRGBA(P){this._forceRGBA!==P&&(this._forceRGBA=P,this._isDirty=!0)}get forceR8(){return this._forceR8}set forceR8(P){this._forceR8!==P&&(this._forceR8=P,this._isDirty=!0)}get forceRG8(){return this._forceRG8}set forceRG8(P){this._forceRG8!==P&&(this._forceRG8=P,this._isDirty=!0)}get bypassTranscoders(){return this._bypassTranscoders}set bypassTranscoders(P){this._bypassTranscoders!==P&&(this._bypassTranscoders=P,this._isDirty=!0)}_getKTX2DecoderOptions(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=!1;const P={useRGBAIfASTCBC7NotAvailableWhenUASTC:this._useRGBAIfASTCBC7NotAvailableWhenUASTC,forceRGBA:this._forceRGBA,forceR8:this._forceR8,forceRG8:this._forceRG8,bypassTranscoders:this._bypassTranscoders};return this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(P.transcodeFormatDecisionTree={UASTC:{transcodeFormat:[L.BC1_RGB,L.BC3_RGBA],yes:{transcodeFormat:L.RGBA32,engineFormat:32856,roundToMultiple4:!1}}}),this._ktx2DecoderOptions=P,P}};class i{constructor(){this.supportCascades=!1}loadCubeData(P,f,Y,C){if(Array.isArray(P))return;f._invertVScale=!f.invertY;const m=f.getEngine(),L=new q(P,6),o=L.numberOfMipmapLevels>1&&f.generateMipMaps;m._unpackFlipY(!0),L.uploadLevels(f,f.generateMipMaps),f.width=L.pixelWidth,f.height=L.pixelHeight,m._setCubeMapTextureParams(f,o,L.numberOfMipmapLevels-1),f.isReady=!0,f.onLoadedObservable.notifyObservers(f),f.onLoadedObservable.clear(),C&&C()}loadData(P,f,Y,m){if(q.IsValid(P)){f._invertVScale=!f.invertY;const C=new q(P,1),m=function(P){switch(P){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}(C.glInternalFormat);m?(f.format=m,f._useSRGBBuffer=f.getEngine()._getUseSRGBBuffer(!0,f.generateMipMaps),f._gammaSpace=!0):f.format=C.glInternalFormat,Y(C.pixelWidth,C.pixelHeight,f.generateMipMaps,!0,(()=>{C.uploadLevels(f,f.generateMipMaps)}),C.isInvalid)}else if(r.IsValid(P)){new r(f.getEngine())._uploadAsync(P,f,m).then((()=>{Y(f.width,f.height,f.generateMipMaps,!0,(()=>{}),!1)}),(P=>{C.e.Warn(`Failed to load KTX2 texture data: ${P.message}`),Y(0,0,!1,!1,(()=>{}),!0)}))}else C.e.Error("texture missing KTX identifier"),Y(0,0,!1,!1,(()=>{}),!0)}}},11790:(P,f,Y)=>{Y.d(f,{d:()=>q});class C{constructor(P){this._pendingActions=new Array,this._workerInfos=P.map((P=>({workerPromise:Promise.resolve(P),idle:!0})))}dispose(){for(const P of this._workerInfos)P.workerPromise.then((P=>{P.terminate()}));this._workerInfos.length=0,this._pendingActions.length=0}push(P){this._executeOnIdleWorker(P)||this._pendingActions.push(P)}_executeOnIdleWorker(P){for(const f of this._workerInfos)if(f.idle)return this._execute(f,P),!0;return!1}_execute(P,f){P.idle=!1,P.workerPromise.then((Y=>{f(Y,(()=>{const f=this._pendingActions.shift();f?this._execute(P,f):P.idle=!0}))}))}}class q extends C{constructor(P,f){let Y=arguments.length>2&&void 0!==arguments[2]?arguments[2]:q.DefaultOptions;super([]),this._maxWorkers=P,this._createWorkerAsync=f,this._options=Y}push(P){if(!this._executeOnIdleWorker(P))if(this._workerInfos.length<this._maxWorkers){const f={workerPromise:this._createWorkerAsync(),idle:!1};this._workerInfos.push(f),this._execute(f,P)}else this._pendingActions.push(P)}_execute(P,f){P.timeoutId&&(clearTimeout(P.timeoutId),delete P.timeoutId),super._execute(P,((Y,C)=>{f(Y,(()=>{C(),P.idle&&(P.timeoutId=setTimeout((()=>{P.workerPromise.then((P=>{P.terminate()}));const f=this._workerInfos.indexOf(P);-1!==f&&this._workerInfos.splice(f,1)}),this._options.idleTimeElapsedBeforeRelease))}))}))}}q.DefaultOptions={idleTimeElapsedBeforeRelease:1e3}}}]);