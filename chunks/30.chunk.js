"use strict";(self.bjbkv7h3qsd=self.bjbkv7h3qsd||[]).push([[30],{13650:(G,A,j)=>{j.r(A),j.d(A,{_KTXTextureLoader:()=>R});var u=j(11065);class k{constructor(G,A){if(this.data=G,this.isInvalid=!1,!k.IsValid(G))return this.isInvalid=!0,void u.e.Error("texture missing KTX identifier");const j=Uint32Array.BYTES_PER_ELEMENT,B=new DataView(this.data.buffer,this.data.byteOffset+12,13*j),x=67305985===B.getUint32(0,!0);return this.glType=B.getUint32(1*j,x),this.glTypeSize=B.getUint32(2*j,x),this.glFormat=B.getUint32(3*j,x),this.glInternalFormat=B.getUint32(4*j,x),this.glBaseInternalFormat=B.getUint32(5*j,x),this.pixelWidth=B.getUint32(6*j,x),this.pixelHeight=B.getUint32(7*j,x),this.pixelDepth=B.getUint32(8*j,x),this.numberOfArrayElements=B.getUint32(9*j,x),this.numberOfFaces=B.getUint32(10*j,x),this.numberOfMipmapLevels=B.getUint32(11*j,x),this.bytesOfKeyValueData=B.getUint32(12*j,x),0!==this.glType?(u.e.Error("only compressed formats currently supported"),void(this.isInvalid=!0)):(this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels),0===this.pixelHeight||0!==this.pixelDepth?(u.e.Error("only 2D textures currently supported"),void(this.isInvalid=!0)):0!==this.numberOfArrayElements?(u.e.Error("texture arrays not currently supported"),void(this.isInvalid=!0)):this.numberOfFaces!==A?(u.e.Error("number of faces expected"+A+", but found "+this.numberOfFaces),void(this.isInvalid=!0)):void(this.loadType=k.COMPRESSED_2D))}uploadLevels(G,A){switch(this.loadType){case k.COMPRESSED_2D:this._upload2DCompressedLevels(G,A);case k.TEX_2D:case k.COMPRESSED_3D:case k.TEX_3D:}}_upload2DCompressedLevels(G,A){let j=k.HEADER_LEN+this.bytesOfKeyValueData,u=this.pixelWidth,B=this.pixelHeight;const x=A?this.numberOfMipmapLevels:1;for(let k=0;k<x;k++){const A=new Int32Array(this.data.buffer,this.data.byteOffset+j,1)[0];j+=4;for(let x=0;x<this.numberOfFaces;x++){const s=new Uint8Array(this.data.buffer,this.data.byteOffset+j,A);G.getEngine()._uploadCompressedDataToTextureDirectly(G,G.format,u,B,s,x,k),j+=A,j+=3-(A+3)%4}u=Math.max(1,.5*u),B=Math.max(1,.5*B)}}static IsValid(G){if(G.byteLength>=12){const A=new Uint8Array(G.buffer,G.byteOffset,12);if(171===A[0]&&75===A[1]&&84===A[2]&&88===A[3]&&32===A[4]&&49===A[5]&&49===A[6]&&187===A[7]&&13===A[8]&&10===A[9]&&26===A[10]&&10===A[11])return!0}return!1}}k.HEADER_LEN=64,k.COMPRESSED_2D=0,k.COMPRESSED_3D=1,k.TEX_2D=2,k.TEX_3D=3;var B,x,s,O=j(11750),d=j(11043);function h(G,A){const j=(null===A||void 0===A?void 0:A.jsDecoderModule)||KTX2DECODER;G&&(G.wasmUASTCToASTC&&(j.LiteTranscoder_UASTC_ASTC.WasmModuleURL=G.wasmUASTCToASTC),G.wasmUASTCToBC7&&(j.LiteTranscoder_UASTC_BC7.WasmModuleURL=G.wasmUASTCToBC7),G.wasmUASTCToRGBA_UNORM&&(j.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=G.wasmUASTCToRGBA_UNORM),G.wasmUASTCToRGBA_SRGB&&(j.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=G.wasmUASTCToRGBA_SRGB),G.wasmUASTCToR8_UNORM&&(j.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=G.wasmUASTCToR8_UNORM),G.wasmUASTCToRG8_UNORM&&(j.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=G.wasmUASTCToRG8_UNORM),G.jsMSCTranscoder&&(j.MSCTranscoder.JSModuleURL=G.jsMSCTranscoder),G.wasmMSCTranscoder&&(j.MSCTranscoder.WasmModuleURL=G.wasmMSCTranscoder),G.wasmZSTDDecoder&&(j.ZSTDDecoder.WasmModuleURL=G.wasmZSTDDecoder)),A&&(A.wasmUASTCToASTC&&(j.LiteTranscoder_UASTC_ASTC.WasmBinary=A.wasmUASTCToASTC),A.wasmUASTCToBC7&&(j.LiteTranscoder_UASTC_BC7.WasmBinary=A.wasmUASTCToBC7),A.wasmUASTCToRGBA_UNORM&&(j.LiteTranscoder_UASTC_RGBA_UNORM.WasmBinary=A.wasmUASTCToRGBA_UNORM),A.wasmUASTCToRGBA_SRGB&&(j.LiteTranscoder_UASTC_RGBA_SRGB.WasmBinary=A.wasmUASTCToRGBA_SRGB),A.wasmUASTCToR8_UNORM&&(j.LiteTranscoder_UASTC_R8_UNORM.WasmBinary=A.wasmUASTCToR8_UNORM),A.wasmUASTCToRG8_UNORM&&(j.LiteTranscoder_UASTC_RG8_UNORM.WasmBinary=A.wasmUASTCToRG8_UNORM),A.jsMSCTranscoder&&(j.MSCTranscoder.JSModule=A.jsMSCTranscoder),A.wasmMSCTranscoder&&(j.MSCTranscoder.WasmBinary=A.wasmMSCTranscoder),A.wasmZSTDDecoder&&(j.ZSTDDecoder.WasmBinary=A.wasmZSTDDecoder))}function H(G){let A;"undefined"===typeof G&&"undefined"!==typeof KTX2DECODER&&(G=KTX2DECODER),onmessage=j=>{if(j.data)switch(j.data.action){case"init":{const u=j.data.urls;u&&(u.jsDecoderModule&&"undefined"===typeof G&&(importScripts(u.jsDecoderModule),G=KTX2DECODER),h(u)),j.data.wasmBinaries&&h(void 0,{...j.data.wasmBinaries,jsDecoderModule:G}),A=new G.KTX2Decoder,postMessage({action:"init"});break}case"setDefaultDecoderOptions":G.KTX2Decoder.DefaultDecoderOptions=j.data.options;break;case"decode":A.decode(j.data.data,j.data.caps,j.data.options).then((G=>{const A=[];for(let j=0;j<G.mipmaps.length;++j){const u=G.mipmaps[j];u&&u.data&&A.push(u.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:G},A)})).catch((G=>{postMessage({action:"decoded",success:!1,hA:G})}))}}}!function(G){G[G.ETC1S=0]="ETC1S",G[G.UASTC4x4=1]="UASTC4x4"}(B||(B={})),function(G){G[G.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",G[G.BC7_RGBA=1]="BC7_RGBA",G[G.BC3_RGBA=2]="BC3_RGBA",G[G.BC1_RGB=3]="BC1_RGB",G[G.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",G[G.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",G[G.ETC2_RGBA=6]="ETC2_RGBA",G[G.ETC1_RGB=7]="ETC1_RGB",G[G.RGBA32=8]="RGBA32",G[G.R8=9]="R8",G[G.RG8=10]="RG8"}(x||(x={})),function(G){G[G.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",G[G.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",G[G.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",G[G.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",G[G.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",G[G.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",G[G.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",G[G.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",G[G.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",G[G.RGBA8Format=32856]="RGBA8Format",G[G.R8Format=33321]="R8Format",G[G.RG8Format=33323]="RG8Format"}(s||(s={}));class F{static GetDefaultNumWorkers(){return"object"===typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static _Initialize(G){if(F._WorkerPoolPromise||F._DecoderModulePromise)return;const A={jsDecoderModule:d.Tools.GetBabylonScriptURL(this.URLConfig.jsDecoderModule,!0),wasmUASTCToASTC:d.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToASTC,!0),wasmUASTCToBC7:d.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToBC7,!0),wasmUASTCToRGBA_UNORM:d.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_UNORM,!0),wasmUASTCToRGBA_SRGB:d.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_SRGB,!0),wasmUASTCToR8_UNORM:d.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToR8_UNORM,!0),wasmUASTCToRG8_UNORM:d.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRG8_UNORM,!0),jsMSCTranscoder:d.Tools.GetBabylonScriptURL(this.URLConfig.jsMSCTranscoder,!0),wasmMSCTranscoder:d.Tools.GetBabylonScriptURL(this.URLConfig.wasmMSCTranscoder,!0),wasmZSTDDecoder:d.Tools.GetBabylonScriptURL(this.URLConfig.wasmZSTDDecoder,!0)};G&&"function"===typeof Worker&&"undefined"!==typeof URL?F._WorkerPoolPromise=new Promise((j=>{const u=`${h}(${H})()`,k=URL.createObjectURL(new Blob([u],{type:"application/javascript"}));j(new O.d(G,(async()=>await async function(G,A,j){return await new Promise(((u,k)=>{const B=A=>{G.removeEventListener("error",B),G.removeEventListener("message",x),k(A)},x=A=>{"init"===A.data.action&&(G.removeEventListener("error",B),G.removeEventListener("message",x),u(G))};G.addEventListener("error",B),G.addEventListener("message",x),G.postMessage({action:"init",urls:j,wasmBinaries:A})}))}(new Worker(k),void 0,A))))})):"undefined"===typeof F._KTX2DecoderModule?F._DecoderModulePromise=d.Tools.LoadBabylonScriptAsync(A.jsDecoderModule).then((()=>(F._KTX2DecoderModule=KTX2DECODER,F._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,F._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,h(A,F._KTX2DecoderModule),new F._KTX2DecoderModule.KTX2Decoder))):(F._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,F._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,F._DecoderModulePromise=Promise.resolve(new F._KTX2DecoderModule.KTX2Decoder))}constructor(G){let A=arguments.length>1&&void 0!==arguments[1]?arguments[1]:F.DefaultNumWorkers;this._engine=G;const j="object"===typeof A&&A.workerPool||F.WorkerPool;if(j)F._WorkerPoolPromise=Promise.resolve(j);else{var u;if("object"===typeof A)F._KTX2DecoderModule=null===A||void 0===A||null===(u=A.binariesAndModulesContainer)||void 0===u?void 0:u.jsDecoderModule;else"undefined"!==typeof KTX2DECODER&&(F._KTX2DecoderModule=KTX2DECODER);const G="number"===typeof A?A:A.numWorkers??F.DefaultNumWorkers;F._Initialize(G)}}async _uploadAsync(G,A,j){const u=this._engine.getCaps(),k={astc:!!u.astc,bptc:!!u.bptc,s3tc:!!u.s3tc,pvrtc:!!u.pvrtc,etc2:!!u.etc2,etc1:!!u.etc1};if(F._WorkerPoolPromise){const u=await F._WorkerPoolPromise;return await new Promise(((B,x)=>{u.push(((u,s)=>{const O=G=>{u.removeEventListener("error",O),u.removeEventListener("message",d),x(G),s()},d=G=>{if("decoded"===G.data.action){if(u.removeEventListener("error",O),u.removeEventListener("message",d),G.data.success)try{this._createTexture(G.data.decodedData,A,j),B()}catch(k){x({message:k})}else x({message:G.data.hA});s()}};u.addEventListener("error",O),u.addEventListener("message",d),u.postMessage({action:"setDefaultDecoderOptions",options:F.DefaultDecoderOptions._getKTX2DecoderOptions()});const h=new Uint8Array(G.byteLength);h.set(new Uint8Array(G.buffer,G.byteOffset,G.byteLength)),u.postMessage({action:"decode",data:h,caps:k,options:j},[h.buffer])}))}))}if(F._DecoderModulePromise){const j=await F._DecoderModulePromise;return F.DefaultDecoderOptions.isDirty&&(F._KTX2DecoderModule.KTX2Decoder.DefaultDecoderOptions=F.DefaultDecoderOptions._getKTX2DecoderOptions()),await new Promise(((k,B)=>{j.decode(G,u).then((G=>{this._createTexture(G,A),k()})).catch((G=>{B({message:G})}))}))}throw new Error("KTX2 decoder module is not available")}_createTexture(G,A,j){this._engine._bindTextureDirectly(3553,A),j&&(j.transcodedFormat=G.transcodedFormat,j.isInGammaSpace=G.isInGammaSpace,j.Hs=G.Hs,j.transcoderName=G.transcoderName);let u=!0;switch(G.transcodedFormat){case 32856:A.type=0,A.format=5;break;case 33321:A.type=0,A.format=6;break;case 33323:A.type=0,A.format=7;break;default:A.format=G.transcodedFormat,u=!1}if(A._gammaSpace=G.isInGammaSpace,A.generateMipMaps=G.mipmaps.length>1,G.errors)throw new Error("KTX2 container - could not transcode the data. "+G.errors);for(let k=0;k<G.mipmaps.length;++k){const j=G.mipmaps[k];if(!j||!j.data)throw new Error("KTX2 container - could not transcode one of the image");u?(A.width=j.width,A.height=j.height,this._engine._uploadDataToTextureDirectly(A,j.data,0,k,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(A,G.transcodedFormat,j.width,j.height,j.data,0,k)}A._extension=".ktx2",A.width=G.mipmaps[0].width,A.height=G.mipmaps[0].height,A.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static IsValid(G){if(G.byteLength>=12){const A=new Uint8Array(G.buffer,G.byteOffset,12);if(171===A[0]&&75===A[1]&&84===A[2]&&88===A[3]&&32===A[4]&&50===A[5]&&48===A[6]&&187===A[7]&&13===A[8]&&10===A[9]&&26===A[10]&&10===A[11])return!0}return!1}}F.URLConfig={jsDecoderModule:"https://cdn.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null},F.DefaultNumWorkers=F.GetDefaultNumWorkers(),F.DefaultDecoderOptions=new class{constructor(){this._isDirty=!0,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=!0,this._ktx2DecoderOptions={}}get isDirty(){return this._isDirty}get useRGBAIfASTCBC7NotAvailableWhenUASTC(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set useRGBAIfASTCBC7NotAvailableWhenUASTC(G){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==G&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=G,this._isDirty=!0)}get useRGBAIfOnlyBC1BC3AvailableWhenUASTC(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set useRGBAIfOnlyBC1BC3AvailableWhenUASTC(G){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==G&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=G,this._isDirty=!0)}get forceRGBA(){return this._forceRGBA}set forceRGBA(G){this._forceRGBA!==G&&(this._forceRGBA=G,this._isDirty=!0)}get forceR8(){return this._forceR8}set forceR8(G){this._forceR8!==G&&(this._forceR8=G,this._isDirty=!0)}get forceRG8(){return this._forceRG8}set forceRG8(G){this._forceRG8!==G&&(this._forceRG8=G,this._isDirty=!0)}get bypassTranscoders(){return this._bypassTranscoders}set bypassTranscoders(G){this._bypassTranscoders!==G&&(this._bypassTranscoders=G,this._isDirty=!0)}_getKTX2DecoderOptions(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=!1;const G={useRGBAIfASTCBC7NotAvailableWhenUASTC:this._useRGBAIfASTCBC7NotAvailableWhenUASTC,forceRGBA:this._forceRGBA,forceR8:this._forceR8,forceRG8:this._forceRG8,bypassTranscoders:this._bypassTranscoders};return this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(G.transcodeFormatDecisionTree={UASTC:{transcodeFormat:[x.BC1_RGB,x.BC3_RGBA],yes:{transcodeFormat:x.RGBA32,engineFormat:32856,roundToMultiple4:!1}}}),this._ktx2DecoderOptions=G,G}};class R{constructor(){this.supportCascades=!1}loadCubeData(G,A,j,u){if(Array.isArray(G))return;A._invertVScale=!A.invertY;const B=A.getEngine(),x=new k(G,6),s=x.numberOfMipmapLevels>1&&A.generateMipMaps;B._unpackFlipY(!0),x.uploadLevels(A,A.generateMipMaps),A.width=x.pixelWidth,A.height=x.pixelHeight,B._setCubeMapTextureParams(A,s,x.numberOfMipmapLevels-1),A.isReady=!0,A.onLoadedObservable.notifyObservers(A),A.onLoadedObservable.clear(),u&&u()}loadData(G,A,j,B){if(k.IsValid(G)){A._invertVScale=!A.invertY;const u=new k(G,1),B=function(G){switch(G){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}(u.glInternalFormat);B?(A.format=B,A._useSRGBBuffer=A.getEngine()._getUseSRGBBuffer(!0,A.generateMipMaps),A._gammaSpace=!0):A.format=u.glInternalFormat,j(u.pixelWidth,u.pixelHeight,A.generateMipMaps,!0,(()=>{u.uploadLevels(A,A.generateMipMaps)}),u.isInvalid)}else if(F.IsValid(G)){new F(A.getEngine())._uploadAsync(G,A,B).then((()=>{j(A.width,A.height,A.generateMipMaps,!0,(()=>{}),!1)}),(G=>{u.e.Warn(`Failed to load KTX2 texture data: ${G.message}`),j(0,0,!1,!1,(()=>{}),!0)}))}else u.e.Error("texture missing KTX identifier"),j(0,0,!1,!1,(()=>{}),!0)}}},11750:(G,A,j)=>{j.d(A,{d:()=>k});class u{constructor(G){this._pendingActions=new Array,this._workerInfos=G.map((G=>({workerPromise:Promise.resolve(G),idle:!0})))}dispose(){for(const G of this._workerInfos)G.workerPromise.then((G=>{G.terminate()}));this._workerInfos.length=0,this._pendingActions.length=0}push(G){this._executeOnIdleWorker(G)||this._pendingActions.push(G)}_executeOnIdleWorker(G){for(const A of this._workerInfos)if(A.idle)return this._execute(A,G),!0;return!1}_execute(G,A){G.idle=!1,G.workerPromise.then((j=>{A(j,(()=>{const A=this._pendingActions.shift();A?this._execute(G,A):G.idle=!0}))}))}}class k extends u{constructor(G,A){let j=arguments.length>2&&void 0!==arguments[2]?arguments[2]:k.DefaultOptions;super([]),this._maxWorkers=G,this._createWorkerAsync=A,this._options=j}push(G){if(!this._executeOnIdleWorker(G))if(this._workerInfos.length<this._maxWorkers){const A={workerPromise:this._createWorkerAsync(),idle:!1};this._workerInfos.push(A),this._execute(A,G)}else this._pendingActions.push(G)}_execute(G,A){G.timeoutId&&(clearTimeout(G.timeoutId),delete G.timeoutId),super._execute(G,((j,u)=>{A(j,(()=>{u(),G.idle&&(G.timeoutId=setTimeout((()=>{G.workerPromise.then((G=>{G.terminate()}));const A=this._workerInfos.indexOf(G);-1!==A&&this._workerInfos.splice(A,1)}),this._options.idleTimeElapsedBeforeRelease))}))}))}}k.DefaultOptions={idleTimeElapsedBeforeRelease:1e3}}}]);