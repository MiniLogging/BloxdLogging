"use strict";(self.z22hkk7o33f=self.z22hkk7o33f||[]).push([[30],{14924:(U,G,C)=>{C.r(G),C.d(G,{_KTXTextureLoader:()=>V});var L=C(12731);class X{constructor(U,G){if(this.data=U,this.isInvalid=!1,!X.IsValid(U))return this.isInvalid=!0,void L.d.Error("texture missing KTX identifier");const C=Uint32Array.BYTES_PER_ELEMENT,l=new DataView(this.data.buffer,this.data.byteOffset+12,13*C),t=67305985===l.getUint32(0,!0);return this.glType=l.getUint32(1*C,t),this.glTypeSize=l.getUint32(2*C,t),this.glFormat=l.getUint32(3*C,t),this.glInternalFormat=l.getUint32(4*C,t),this.glBaseInternalFormat=l.getUint32(5*C,t),this.pixelWidth=l.getUint32(6*C,t),this.pixelHeight=l.getUint32(7*C,t),this.pixelDepth=l.getUint32(8*C,t),this.numberOfArrayElements=l.getUint32(9*C,t),this.numberOfFaces=l.getUint32(10*C,t),this.numberOfMipmapLevels=l.getUint32(11*C,t),this.bytesOfKeyValueData=l.getUint32(12*C,t),0!==this.glType?(L.d.Error("only compressed formats currently supported"),void(this.isInvalid=!0)):(this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels),0===this.pixelHeight||0!==this.pixelDepth?(L.d.Error("only 2D textures currently supported"),void(this.isInvalid=!0)):0!==this.numberOfArrayElements?(L.d.Error("texture arrays not currently supported"),void(this.isInvalid=!0)):this.numberOfFaces!==G?(L.d.Error("number of faces expected"+G+", but found "+this.numberOfFaces),void(this.isInvalid=!0)):void(this.loadType=X.COMPRESSED_2D))}uploadLevels(U,G){switch(this.loadType){case X.COMPRESSED_2D:this._upload2DCompressedLevels(U,G);case X.TEX_2D:case X.COMPRESSED_3D:case X.TEX_3D:}}_upload2DCompressedLevels(U,G){let C=X.HEADER_LEN+this.bytesOfKeyValueData,L=this.pixelWidth,l=this.pixelHeight;const t=G?this.numberOfMipmapLevels:1;for(let X=0;X<t;X++){const G=new Int32Array(this.data.buffer,this.data.byteOffset+C,1)[0];C+=4;for(let t=0;t<this.numberOfFaces;t++){const E=new Uint8Array(this.data.buffer,this.data.byteOffset+C,G);U.getEngine()._uploadCompressedDataToTextureDirectly(U,U.format,L,l,E,t,X),C+=G,C+=3-(G+3)%4}L=Math.max(1,.5*L),l=Math.max(1,.5*l)}}static IsValid(U){if(U.byteLength>=12){const G=new Uint8Array(U.buffer,U.byteOffset,12);if(171===G[0]&&75===G[1]&&84===G[2]&&88===G[3]&&32===G[4]&&49===G[5]&&49===G[6]&&187===G[7]&&13===G[8]&&10===G[9]&&26===G[10]&&10===G[11])return!0}return!1}}X.HEADER_LEN=64,X.COMPRESSED_2D=0,X.COMPRESSED_3D=1,X.TEX_2D=2,X.TEX_3D=3;var l,t,E,K=C(13448),P=C(12718);!function(U){U[U.ETC1S=0]="ETC1S",U[U.UASTC4x4=1]="UASTC4x4"}(l||(l={})),function(U){U[U.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",U[U.BC7_RGBA=1]="BC7_RGBA",U[U.BC3_RGBA=2]="BC3_RGBA",U[U.BC1_RGB=3]="BC1_RGB",U[U.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",U[U.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",U[U.ETC2_RGBA=6]="ETC2_RGBA",U[U.ETC1_RGB=7]="ETC1_RGB",U[U.RGBA32=8]="RGBA32",U[U.R8=9]="R8",U[U.RG8=10]="RG8"}(t||(t={})),function(U){U[U.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",U[U.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",U[U.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",U[U.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",U[U.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",U[U.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",U[U.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",U[U.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",U[U.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",U[U.RGBA8Format=32856]="RGBA8Format",U[U.R8Format=33321]="R8Format",U[U.RG8Format=33323]="RG8Format"}(E||(E={}));var O=C(26);function T(U,G){const C=(null===G||void 0===G?void 0:G.jsDecoderModule)||KTX2DECODER;U&&(U.wasmUASTCToASTC&&(C.LiteTranscoder_UASTC_ASTC.WasmModuleURL=U.wasmUASTCToASTC),U.wasmUASTCToBC7&&(C.LiteTranscoder_UASTC_BC7.WasmModuleURL=U.wasmUASTCToBC7),U.wasmUASTCToRGBA_UNORM&&(C.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=U.wasmUASTCToRGBA_UNORM),U.wasmUASTCToRGBA_SRGB&&(C.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=U.wasmUASTCToRGBA_SRGB),U.wasmUASTCToR8_UNORM&&(C.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=U.wasmUASTCToR8_UNORM),U.wasmUASTCToRG8_UNORM&&(C.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=U.wasmUASTCToRG8_UNORM),U.jsMSCTranscoder&&(C.MSCTranscoder.JSModuleURL=U.jsMSCTranscoder),U.wasmMSCTranscoder&&(C.MSCTranscoder.WasmModuleURL=U.wasmMSCTranscoder),U.wasmZSTDDecoder&&(C.ZSTDDecoder.WasmModuleURL=U.wasmZSTDDecoder)),G&&(G.wasmUASTCToASTC&&(C.LiteTranscoder_UASTC_ASTC.WasmBinary=G.wasmUASTCToASTC),G.wasmUASTCToBC7&&(C.LiteTranscoder_UASTC_BC7.WasmBinary=G.wasmUASTCToBC7),G.wasmUASTCToRGBA_UNORM&&(C.LiteTranscoder_UASTC_RGBA_UNORM.WasmBinary=G.wasmUASTCToRGBA_UNORM),G.wasmUASTCToRGBA_SRGB&&(C.LiteTranscoder_UASTC_RGBA_SRGB.WasmBinary=G.wasmUASTCToRGBA_SRGB),G.wasmUASTCToR8_UNORM&&(C.LiteTranscoder_UASTC_R8_UNORM.WasmBinary=G.wasmUASTCToR8_UNORM),G.wasmUASTCToRG8_UNORM&&(C.LiteTranscoder_UASTC_RG8_UNORM.WasmBinary=G.wasmUASTCToRG8_UNORM),G.jsMSCTranscoder&&(C.MSCTranscoder.JSModule=G.jsMSCTranscoder),G.wasmMSCTranscoder&&(C.MSCTranscoder.WasmBinary=G.wasmMSCTranscoder),G.wasmZSTDDecoder&&(C.ZSTDDecoder.WasmBinary=G.wasmZSTDDecoder))}function D(U){let G;"undefined"===typeof U&&"undefined"!==typeof KTX2DECODER&&(U=KTX2DECODER),onmessage=C=>{if(C.data)switch(C.data.action){case"init":{const L=C.data.urls;L&&(L.jsDecoderModule&&"undefined"===typeof U&&(importScripts(L.jsDecoderModule),U=KTX2DECODER),T(L)),C.data.wasmBinaries&&T(void 0,(0,O.b)((0,O.b)({},C.data.wasmBinaries),{},{jsDecoderModule:U})),G=new U.KTX2Decoder,postMessage({action:"init"});break}case"setDefaultDecoderOptions":U.KTX2Decoder.DefaultDecoderOptions=C.data.options;break;case"decode":G.decode(C.data.data,C.data.caps,C.data.options).then((U=>{const G=[];for(let C=0;C<U.mipmaps.length;++C){const L=U.mipmaps[C];L&&L.data&&G.push(L.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:U},G)})).catch((U=>{postMessage({action:"decoded",success:!1,PG:U})}))}}}class y{static GetDefaultNumWorkers(){return"object"===typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static _Initialize(U){if(y._WorkerPoolPromise||y._DecoderModulePromise)return;const G={jsDecoderModule:P.Tools.GetBabylonScriptURL(this.URLConfig.jsDecoderModule,!0),wasmUASTCToASTC:P.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToASTC,!0),wasmUASTCToBC7:P.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToBC7,!0),wasmUASTCToRGBA_UNORM:P.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_UNORM,!0),wasmUASTCToRGBA_SRGB:P.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_SRGB,!0),wasmUASTCToR8_UNORM:P.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToR8_UNORM,!0),wasmUASTCToRG8_UNORM:P.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRG8_UNORM,!0),jsMSCTranscoder:P.Tools.GetBabylonScriptURL(this.URLConfig.jsMSCTranscoder,!0),wasmMSCTranscoder:P.Tools.GetBabylonScriptURL(this.URLConfig.wasmMSCTranscoder,!0),wasmZSTDDecoder:P.Tools.GetBabylonScriptURL(this.URLConfig.wasmZSTDDecoder,!0)};U&&"function"===typeof Worker&&"undefined"!==typeof URL?y._WorkerPoolPromise=new Promise((C=>{const L="".concat(T,"(").concat(D,")()"),X=URL.createObjectURL(new Blob([L],{type:"application/javascript"}));C(new K.d(U,(async()=>await async function(U,G,C){return await new Promise(((L,X)=>{const l=G=>{U.removeEventListener("error",l),U.removeEventListener("message",t),X(G)},t=G=>{"init"===G.data.action&&(U.removeEventListener("error",l),U.removeEventListener("message",t),L(U))};U.addEventListener("error",l),U.addEventListener("message",t),U.postMessage({action:"init",urls:C,wasmBinaries:G})}))}(new Worker(X),void 0,G))))})):"undefined"===typeof y._KTX2DecoderModule?y._DecoderModulePromise=P.Tools.LoadBabylonScriptAsync(G.jsDecoderModule).then((()=>(y._KTX2DecoderModule=KTX2DECODER,y._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,y._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,T(G,y._KTX2DecoderModule),new y._KTX2DecoderModule.KTX2Decoder))):(y._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,y._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,y._DecoderModulePromise=Promise.resolve(new y._KTX2DecoderModule.KTX2Decoder))}constructor(U){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:y.DefaultNumWorkers;this._engine=U;const C="object"===typeof G&&G.workerPool||y.WorkerPool;if(C)y._WorkerPoolPromise=Promise.resolve(C);else{var L,X;if("object"===typeof G)y._KTX2DecoderModule=null===G||void 0===G||null===(X=G.binariesAndModulesContainer)||void 0===X?void 0:X.jsDecoderModule;else"undefined"!==typeof KTX2DECODER&&(y._KTX2DecoderModule=KTX2DECODER);const U="number"===typeof G?G:null!==(L=G.numWorkers)&&void 0!==L?L:y.DefaultNumWorkers;y._Initialize(U)}}async _uploadAsync(U,G,C){const L=this._engine.getCaps(),X={astc:!!L.astc,bptc:!!L.bptc,s3tc:!!L.s3tc,pvrtc:!!L.pvrtc,etc2:!!L.etc2,etc1:!!L.etc1};if(y._WorkerPoolPromise){const L=await y._WorkerPoolPromise;return await new Promise(((l,t)=>{L.push(((L,E)=>{const K=U=>{L.removeEventListener("error",K),L.removeEventListener("message",P),t(U),E()},P=U=>{if("decoded"===U.data.action){if(L.removeEventListener("error",K),L.removeEventListener("message",P),U.data.success)try{this._createTexture(U.data.decodedData,G,C),l()}catch(X){t({message:X})}else t({message:U.data.PG});E()}};L.addEventListener("error",K),L.addEventListener("message",P),L.postMessage({action:"setDefaultDecoderOptions",options:y.DefaultDecoderOptions._getKTX2DecoderOptions()});const O=new Uint8Array(U.byteLength);O.set(new Uint8Array(U.buffer,U.byteOffset,U.byteLength)),L.postMessage({action:"decode",data:O,caps:X,options:C},[O.buffer])}))}))}if(y._DecoderModulePromise){const C=await y._DecoderModulePromise;return y.DefaultDecoderOptions.isDirty&&(y._KTX2DecoderModule.KTX2Decoder.DefaultDecoderOptions=y.DefaultDecoderOptions._getKTX2DecoderOptions()),await new Promise(((X,l)=>{C.decode(U,L).then((U=>{this._createTexture(U,G),X()})).catch((U=>{l({message:U})}))}))}throw new Error("KTX2 decoder module is not available")}_createTexture(U,G,C){this._engine._bindTextureDirectly(3553,G),C&&(C.transcodedFormat=U.transcodedFormat,C.isInGammaSpace=U.isInGammaSpace,C.jE=U.jE,C.transcoderName=U.transcoderName);let L=!0;switch(U.transcodedFormat){case 32856:G.type=0,G.format=5;break;case 33321:G.type=0,G.format=6;break;case 33323:G.type=0,G.format=7;break;default:G.format=U.transcodedFormat,L=!1}if(G._gammaSpace=U.isInGammaSpace,G.generateMipMaps=U.mipmaps.length>1,U.errors)throw new Error("KTX2 container - could not transcode the data. "+U.errors);for(let X=0;X<U.mipmaps.length;++X){const C=U.mipmaps[X];if(!C||!C.data)throw new Error("KTX2 container - could not transcode one of the image");L?(G.width=C.width,G.height=C.height,this._engine._uploadDataToTextureDirectly(G,C.data,0,X,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(G,U.transcodedFormat,C.width,C.height,C.data,0,X)}G._extension=".ktx2",G.width=U.mipmaps[0].width,G.height=U.mipmaps[0].height,G.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static IsValid(U){if(U.byteLength>=12){const G=new Uint8Array(U.buffer,U.byteOffset,12);if(171===G[0]&&75===G[1]&&84===G[2]&&88===G[3]&&32===G[4]&&50===G[5]&&48===G[6]&&187===G[7]&&13===G[8]&&10===G[9]&&26===G[10]&&10===G[11])return!0}return!1}}y.URLConfig={jsDecoderModule:"https://cdn.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null},y.DefaultNumWorkers=y.GetDefaultNumWorkers(),y.DefaultDecoderOptions=new class{constructor(){this._isDirty=!0,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=!0,this._ktx2DecoderOptions={}}get isDirty(){return this._isDirty}get useRGBAIfASTCBC7NotAvailableWhenUASTC(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set useRGBAIfASTCBC7NotAvailableWhenUASTC(U){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==U&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=U,this._isDirty=!0)}get useRGBAIfOnlyBC1BC3AvailableWhenUASTC(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set useRGBAIfOnlyBC1BC3AvailableWhenUASTC(U){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==U&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=U,this._isDirty=!0)}get forceRGBA(){return this._forceRGBA}set forceRGBA(U){this._forceRGBA!==U&&(this._forceRGBA=U,this._isDirty=!0)}get forceR8(){return this._forceR8}set forceR8(U){this._forceR8!==U&&(this._forceR8=U,this._isDirty=!0)}get forceRG8(){return this._forceRG8}set forceRG8(U){this._forceRG8!==U&&(this._forceRG8=U,this._isDirty=!0)}get bypassTranscoders(){return this._bypassTranscoders}set bypassTranscoders(U){this._bypassTranscoders!==U&&(this._bypassTranscoders=U,this._isDirty=!0)}_getKTX2DecoderOptions(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=!1;const U={useRGBAIfASTCBC7NotAvailableWhenUASTC:this._useRGBAIfASTCBC7NotAvailableWhenUASTC,forceRGBA:this._forceRGBA,forceR8:this._forceR8,forceRG8:this._forceRG8,bypassTranscoders:this._bypassTranscoders};return this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(U.transcodeFormatDecisionTree={UASTC:{transcodeFormat:[t.BC1_RGB,t.BC3_RGBA],yes:{transcodeFormat:t.RGBA32,engineFormat:32856,roundToMultiple4:!1}}}),this._ktx2DecoderOptions=U,U}};class V{constructor(){this.supportCascades=!1}loadCubeData(U,G,C,L){if(Array.isArray(U))return;G._invertVScale=!G.invertY;const l=G.getEngine(),t=new X(U,6),E=t.numberOfMipmapLevels>1&&G.generateMipMaps;l._unpackFlipY(!0),t.uploadLevels(G,G.generateMipMaps),G.width=t.pixelWidth,G.height=t.pixelHeight,l._setCubeMapTextureParams(G,E,t.numberOfMipmapLevels-1),G.isReady=!0,G.onLoadedObservable.notifyObservers(G),G.onLoadedObservable.clear(),L&&L()}loadData(U,G,C,l){if(X.IsValid(U)){G._invertVScale=!G.invertY;const L=new X(U,1),l=function(U){switch(U){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}(L.glInternalFormat);l?(G.format=l,G._useSRGBBuffer=G.getEngine()._getUseSRGBBuffer(!0,G.generateMipMaps),G._gammaSpace=!0):G.format=L.glInternalFormat,C(L.pixelWidth,L.pixelHeight,G.generateMipMaps,!0,(()=>{L.uploadLevels(G,G.generateMipMaps)}),L.isInvalid)}else if(y.IsValid(U)){new y(G.getEngine())._uploadAsync(U,G,l).then((()=>{C(G.width,G.height,G.generateMipMaps,!0,(()=>{}),!1)}),(U=>{L.d.Warn("Failed to load KTX2 texture data: ".concat(U.message)),C(0,0,!1,!1,(()=>{}),!0)}))}else L.d.Error("texture missing KTX identifier"),C(0,0,!1,!1,(()=>{}),!0)}}},13448:(U,G,C)=>{C.d(G,{d:()=>X});class L{constructor(U){this._pendingActions=new Array,this._workerInfos=U.map((U=>({workerPromise:Promise.resolve(U),idle:!0})))}dispose(){for(const U of this._workerInfos)U.workerPromise.then((U=>{U.terminate()}));this._workerInfos.length=0,this._pendingActions.length=0}push(U){this._executeOnIdleWorker(U)||this._pendingActions.push(U)}_executeOnIdleWorker(U){for(const G of this._workerInfos)if(G.idle)return this._execute(G,U),!0;return!1}_execute(U,G){U.idle=!1,U.workerPromise.then((C=>{G(C,(()=>{const G=this._pendingActions.shift();G?this._execute(U,G):U.idle=!0}))}))}}class X extends L{constructor(U,G){let C=arguments.length>2&&void 0!==arguments[2]?arguments[2]:X.DefaultOptions;super([]),this._maxWorkers=U,this._createWorkerAsync=G,this._options=C}push(U){if(!this._executeOnIdleWorker(U))if(this._workerInfos.length<this._maxWorkers){const G={workerPromise:this._createWorkerAsync(),idle:!1};this._workerInfos.push(G),this._execute(G,U)}else this._pendingActions.push(U)}_execute(U,G){U.timeoutId&&(clearTimeout(U.timeoutId),delete U.timeoutId),super._execute(U,((C,L)=>{G(C,(()=>{L(),U.idle&&(U.timeoutId=setTimeout((()=>{U.workerPromise.then((U=>{U.terminate()}));const G=this._workerInfos.indexOf(U);-1!==G&&this._workerInfos.splice(G,1)}),this._options.idleTimeElapsedBeforeRelease))}))}))}}X.DefaultOptions={idleTimeElapsedBeforeRelease:1e3}}}]);