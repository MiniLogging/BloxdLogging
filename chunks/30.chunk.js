"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[30],{13583:(g,w,q)=>{q.r(w),q.d(w,{_KTXTextureLoader:()=>y});var R=q(11011);class o{constructor(g,w){if(this.data=g,this.isInvalid=!1,!o.IsValid(g))return this.isInvalid=!0,void R.d.Error("texture missing KTX identifier");const q=Uint32Array.BYTES_PER_ELEMENT,r=new DataView(this.data.buffer,this.data.byteOffset+12,13*q),S=67305985===r.getUint32(0,!0);return this.glType=r.getUint32(1*q,S),this.glTypeSize=r.getUint32(2*q,S),this.glFormat=r.getUint32(3*q,S),this.glInternalFormat=r.getUint32(4*q,S),this.glBaseInternalFormat=r.getUint32(5*q,S),this.pixelWidth=r.getUint32(6*q,S),this.pixelHeight=r.getUint32(7*q,S),this.pixelDepth=r.getUint32(8*q,S),this.numberOfArrayElements=r.getUint32(9*q,S),this.numberOfFaces=r.getUint32(10*q,S),this.numberOfMipmapLevels=r.getUint32(11*q,S),this.bytesOfKeyValueData=r.getUint32(12*q,S),0!==this.glType?(R.d.Error("only compressed formats currently supported"),void(this.isInvalid=!0)):(this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels),0===this.pixelHeight||0!==this.pixelDepth?(R.d.Error("only 2D textures currently supported"),void(this.isInvalid=!0)):0!==this.numberOfArrayElements?(R.d.Error("texture arrays not currently supported"),void(this.isInvalid=!0)):this.numberOfFaces!==w?(R.d.Error("number of faces expected"+w+", but found "+this.numberOfFaces),void(this.isInvalid=!0)):void(this.loadType=o.COMPRESSED_2D))}uploadLevels(g,w){switch(this.loadType){case o.COMPRESSED_2D:this._upload2DCompressedLevels(g,w);case o.TEX_2D:case o.COMPRESSED_3D:case o.TEX_3D:}}_upload2DCompressedLevels(g,w){let q=o.HEADER_LEN+this.bytesOfKeyValueData,R=this.pixelWidth,r=this.pixelHeight;const S=w?this.numberOfMipmapLevels:1;for(let o=0;o<S;o++){const w=new Int32Array(this.data.buffer,this.data.byteOffset+q,1)[0];q+=4;for(let S=0;S<this.numberOfFaces;S++){const i=new Uint8Array(this.data.buffer,this.data.byteOffset+q,w);g.getEngine()._uploadCompressedDataToTextureDirectly(g,g.format,R,r,i,S,o),q+=w,q+=3-(w+3)%4}R=Math.max(1,.5*R),r=Math.max(1,.5*r)}}static IsValid(g){if(g.byteLength>=12){const w=new Uint8Array(g.buffer,g.byteOffset,12);if(171===w[0]&&75===w[1]&&84===w[2]&&88===w[3]&&32===w[4]&&49===w[5]&&49===w[6]&&187===w[7]&&13===w[8]&&10===w[9]&&26===w[10]&&10===w[11])return!0}return!1}}o.HEADER_LEN=64,o.COMPRESSED_2D=0,o.COMPRESSED_3D=1,o.TEX_2D=2,o.TEX_3D=3;var r,S,i,T=q(11710),z=q(10991);function t(g,w){const q=(null===w||void 0===w?void 0:w.jsDecoderModule)||KTX2DECODER;g&&(g.wasmUASTCToASTC&&(q.LiteTranscoder_UASTC_ASTC.WasmModuleURL=g.wasmUASTCToASTC),g.wasmUASTCToBC7&&(q.LiteTranscoder_UASTC_BC7.WasmModuleURL=g.wasmUASTCToBC7),g.wasmUASTCToRGBA_UNORM&&(q.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=g.wasmUASTCToRGBA_UNORM),g.wasmUASTCToRGBA_SRGB&&(q.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=g.wasmUASTCToRGBA_SRGB),g.wasmUASTCToR8_UNORM&&(q.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=g.wasmUASTCToR8_UNORM),g.wasmUASTCToRG8_UNORM&&(q.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=g.wasmUASTCToRG8_UNORM),g.jsMSCTranscoder&&(q.MSCTranscoder.JSModuleURL=g.jsMSCTranscoder),g.wasmMSCTranscoder&&(q.MSCTranscoder.WasmModuleURL=g.wasmMSCTranscoder),g.wasmZSTDDecoder&&(q.ZSTDDecoder.WasmModuleURL=g.wasmZSTDDecoder)),w&&(w.wasmUASTCToASTC&&(q.LiteTranscoder_UASTC_ASTC.WasmBinary=w.wasmUASTCToASTC),w.wasmUASTCToBC7&&(q.LiteTranscoder_UASTC_BC7.WasmBinary=w.wasmUASTCToBC7),w.wasmUASTCToRGBA_UNORM&&(q.LiteTranscoder_UASTC_RGBA_UNORM.WasmBinary=w.wasmUASTCToRGBA_UNORM),w.wasmUASTCToRGBA_SRGB&&(q.LiteTranscoder_UASTC_RGBA_SRGB.WasmBinary=w.wasmUASTCToRGBA_SRGB),w.wasmUASTCToR8_UNORM&&(q.LiteTranscoder_UASTC_R8_UNORM.WasmBinary=w.wasmUASTCToR8_UNORM),w.wasmUASTCToRG8_UNORM&&(q.LiteTranscoder_UASTC_RG8_UNORM.WasmBinary=w.wasmUASTCToRG8_UNORM),w.jsMSCTranscoder&&(q.MSCTranscoder.JSModule=w.jsMSCTranscoder),w.wasmMSCTranscoder&&(q.MSCTranscoder.WasmBinary=w.wasmMSCTranscoder),w.wasmZSTDDecoder&&(q.ZSTDDecoder.WasmBinary=w.wasmZSTDDecoder))}function m(g){let w;"undefined"===typeof g&&"undefined"!==typeof KTX2DECODER&&(g=KTX2DECODER),onmessage=q=>{if(q.data)switch(q.data.action){case"init":{const R=q.data.urls;R&&(R.jsDecoderModule&&"undefined"===typeof g&&(importScripts(R.jsDecoderModule),g=KTX2DECODER),t(R)),q.data.wasmBinaries&&t(void 0,{...q.data.wasmBinaries,jsDecoderModule:g}),w=new g.KTX2Decoder,postMessage({action:"init"});break}case"setDefaultDecoderOptions":g.KTX2Decoder.DefaultDecoderOptions=q.data.options;break;case"decode":w.decode(q.data.data,q.data.caps,q.data.options).then((g=>{const w=[];for(let q=0;q<g.mipmaps.length;++q){const R=g.mipmaps[q];R&&R.data&&w.push(R.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:g},w)})).catch((g=>{postMessage({action:"decoded",success:!1,iw:g})}))}}}!function(g){g[g.ETC1S=0]="ETC1S",g[g.UASTC4x4=1]="UASTC4x4"}(r||(r={})),function(g){g[g.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",g[g.BC7_RGBA=1]="BC7_RGBA",g[g.BC3_RGBA=2]="BC3_RGBA",g[g.BC1_RGB=3]="BC1_RGB",g[g.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",g[g.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",g[g.ETC2_RGBA=6]="ETC2_RGBA",g[g.ETC1_RGB=7]="ETC1_RGB",g[g.RGBA32=8]="RGBA32",g[g.R8=9]="R8",g[g.RG8=10]="RG8"}(S||(S={})),function(g){g[g.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",g[g.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",g[g.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",g[g.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",g[g.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",g[g.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",g[g.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",g[g.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",g[g.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",g[g.RGBA8Format=32856]="RGBA8Format",g[g.R8Format=33321]="R8Format",g[g.RG8Format=33323]="RG8Format"}(i||(i={}));class e{static GetDefaultNumWorkers(){return"object"===typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static _Initialize(g){if(e._WorkerPoolPromise||e._DecoderModulePromise)return;const w={jsDecoderModule:z.Tools.GetBabylonScriptURL(this.URLConfig.jsDecoderModule,!0),wasmUASTCToASTC:z.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToASTC,!0),wasmUASTCToBC7:z.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToBC7,!0),wasmUASTCToRGBA_UNORM:z.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_UNORM,!0),wasmUASTCToRGBA_SRGB:z.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_SRGB,!0),wasmUASTCToR8_UNORM:z.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToR8_UNORM,!0),wasmUASTCToRG8_UNORM:z.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRG8_UNORM,!0),jsMSCTranscoder:z.Tools.GetBabylonScriptURL(this.URLConfig.jsMSCTranscoder,!0),wasmMSCTranscoder:z.Tools.GetBabylonScriptURL(this.URLConfig.wasmMSCTranscoder,!0),wasmZSTDDecoder:z.Tools.GetBabylonScriptURL(this.URLConfig.wasmZSTDDecoder,!0)};g&&"function"===typeof Worker&&"undefined"!==typeof URL?e._WorkerPoolPromise=new Promise((q=>{const R=`${t}(${m})()`,o=URL.createObjectURL(new Blob([R],{type:"application/javascript"}));q(new T.b(g,(async()=>await async function(g,w,q){return await new Promise(((R,o)=>{const r=w=>{g.removeEventListener("error",r),g.removeEventListener("message",S),o(w)},S=w=>{"init"===w.data.action&&(g.removeEventListener("error",r),g.removeEventListener("message",S),R(g))};g.addEventListener("error",r),g.addEventListener("message",S),g.postMessage({action:"init",urls:q,wasmBinaries:w})}))}(new Worker(o),void 0,w))))})):"undefined"===typeof e._KTX2DecoderModule?e._DecoderModulePromise=z.Tools.LoadBabylonScriptAsync(w.jsDecoderModule).then((()=>(e._KTX2DecoderModule=KTX2DECODER,e._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,e._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,t(w,e._KTX2DecoderModule),new e._KTX2DecoderModule.KTX2Decoder))):(e._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,e._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,e._DecoderModulePromise=Promise.resolve(new e._KTX2DecoderModule.KTX2Decoder))}constructor(g){let w=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.DefaultNumWorkers;this._engine=g;const q="object"===typeof w&&w.workerPool||e.WorkerPool;if(q)e._WorkerPoolPromise=Promise.resolve(q);else{var R;if("object"===typeof w)e._KTX2DecoderModule=null===w||void 0===w||null===(R=w.binariesAndModulesContainer)||void 0===R?void 0:R.jsDecoderModule;else"undefined"!==typeof KTX2DECODER&&(e._KTX2DecoderModule=KTX2DECODER);const g="number"===typeof w?w:w.numWorkers??e.DefaultNumWorkers;e._Initialize(g)}}async _uploadAsync(g,w,q){const R=this._engine.getCaps(),o={astc:!!R.astc,bptc:!!R.bptc,s3tc:!!R.s3tc,pvrtc:!!R.pvrtc,etc2:!!R.etc2,etc1:!!R.etc1};if(e._WorkerPoolPromise){const R=await e._WorkerPoolPromise;return await new Promise(((r,S)=>{R.push(((R,i)=>{const T=g=>{R.removeEventListener("error",T),R.removeEventListener("message",z),S(g),i()},z=g=>{if("decoded"===g.data.action){if(R.removeEventListener("error",T),R.removeEventListener("message",z),g.data.success)try{this._createTexture(g.data.decodedData,w,q),r()}catch(o){S({message:o})}else S({message:g.data.iw});i()}};R.addEventListener("error",T),R.addEventListener("message",z),R.postMessage({action:"setDefaultDecoderOptions",options:e.DefaultDecoderOptions._getKTX2DecoderOptions()});const t=new Uint8Array(g.byteLength);t.set(new Uint8Array(g.buffer,g.byteOffset,g.byteLength)),R.postMessage({action:"decode",data:t,caps:o,options:q},[t.buffer])}))}))}if(e._DecoderModulePromise){const q=await e._DecoderModulePromise;return e.DefaultDecoderOptions.isDirty&&(e._KTX2DecoderModule.KTX2Decoder.DefaultDecoderOptions=e.DefaultDecoderOptions._getKTX2DecoderOptions()),await new Promise(((o,r)=>{q.decode(g,R).then((g=>{this._createTexture(g,w),o()})).catch((g=>{r({message:g})}))}))}throw new Error("KTX2 decoder module is not available")}_createTexture(g,w,q){this._engine._bindTextureDirectly(3553,w),q&&(q.transcodedFormat=g.transcodedFormat,q.isInGammaSpace=g.isInGammaSpace,q.oi=g.oi,q.transcoderName=g.transcoderName);let R=!0;switch(g.transcodedFormat){case 32856:w.type=0,w.format=5;break;case 33321:w.type=0,w.format=6;break;case 33323:w.type=0,w.format=7;break;default:w.format=g.transcodedFormat,R=!1}if(w._gammaSpace=g.isInGammaSpace,w.generateMipMaps=g.mipmaps.length>1,g.errors)throw new Error("KTX2 container - could not transcode the data. "+g.errors);for(let o=0;o<g.mipmaps.length;++o){const q=g.mipmaps[o];if(!q||!q.data)throw new Error("KTX2 container - could not transcode one of the image");R?(w.width=q.width,w.height=q.height,this._engine._uploadDataToTextureDirectly(w,q.data,0,o,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(w,g.transcodedFormat,q.width,q.height,q.data,0,o)}w._extension=".ktx2",w.width=g.mipmaps[0].width,w.height=g.mipmaps[0].height,w.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static IsValid(g){if(g.byteLength>=12){const w=new Uint8Array(g.buffer,g.byteOffset,12);if(171===w[0]&&75===w[1]&&84===w[2]&&88===w[3]&&32===w[4]&&50===w[5]&&48===w[6]&&187===w[7]&&13===w[8]&&10===w[9]&&26===w[10]&&10===w[11])return!0}return!1}}e.URLConfig={jsDecoderModule:"https://cdn.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null},e.DefaultNumWorkers=e.GetDefaultNumWorkers(),e.DefaultDecoderOptions=new class{constructor(){this._isDirty=!0,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=!0,this._ktx2DecoderOptions={}}get isDirty(){return this._isDirty}get useRGBAIfASTCBC7NotAvailableWhenUASTC(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set useRGBAIfASTCBC7NotAvailableWhenUASTC(g){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==g&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=g,this._isDirty=!0)}get useRGBAIfOnlyBC1BC3AvailableWhenUASTC(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set useRGBAIfOnlyBC1BC3AvailableWhenUASTC(g){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==g&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=g,this._isDirty=!0)}get forceRGBA(){return this._forceRGBA}set forceRGBA(g){this._forceRGBA!==g&&(this._forceRGBA=g,this._isDirty=!0)}get forceR8(){return this._forceR8}set forceR8(g){this._forceR8!==g&&(this._forceR8=g,this._isDirty=!0)}get forceRG8(){return this._forceRG8}set forceRG8(g){this._forceRG8!==g&&(this._forceRG8=g,this._isDirty=!0)}get bypassTranscoders(){return this._bypassTranscoders}set bypassTranscoders(g){this._bypassTranscoders!==g&&(this._bypassTranscoders=g,this._isDirty=!0)}_getKTX2DecoderOptions(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=!1;const g={useRGBAIfASTCBC7NotAvailableWhenUASTC:this._useRGBAIfASTCBC7NotAvailableWhenUASTC,forceRGBA:this._forceRGBA,forceR8:this._forceR8,forceRG8:this._forceRG8,bypassTranscoders:this._bypassTranscoders};return this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(g.transcodeFormatDecisionTree={UASTC:{transcodeFormat:[S.BC1_RGB,S.BC3_RGBA],yes:{transcodeFormat:S.RGBA32,engineFormat:32856,roundToMultiple4:!1}}}),this._ktx2DecoderOptions=g,g}};class y{constructor(){this.supportCascades=!1}loadCubeData(g,w,q,R){if(Array.isArray(g))return;w._invertVScale=!w.invertY;const r=w.getEngine(),S=new o(g,6),i=S.numberOfMipmapLevels>1&&w.generateMipMaps;r._unpackFlipY(!0),S.uploadLevels(w,w.generateMipMaps),w.width=S.pixelWidth,w.height=S.pixelHeight,r._setCubeMapTextureParams(w,i,S.numberOfMipmapLevels-1),w.isReady=!0,w.onLoadedObservable.notifyObservers(w),w.onLoadedObservable.clear(),R&&R()}loadData(g,w,q,r){if(o.IsValid(g)){w._invertVScale=!w.invertY;const R=new o(g,1),r=function(g){switch(g){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}(R.glInternalFormat);r?(w.format=r,w._useSRGBBuffer=w.getEngine()._getUseSRGBBuffer(!0,w.generateMipMaps),w._gammaSpace=!0):w.format=R.glInternalFormat,q(R.pixelWidth,R.pixelHeight,w.generateMipMaps,!0,(()=>{R.uploadLevels(w,w.generateMipMaps)}),R.isInvalid)}else if(e.IsValid(g)){new e(w.getEngine())._uploadAsync(g,w,r).then((()=>{q(w.width,w.height,w.generateMipMaps,!0,(()=>{}),!1)}),(g=>{R.d.Warn(`Failed to load KTX2 texture data: ${g.message}`),q(0,0,!1,!1,(()=>{}),!0)}))}else R.d.Error("texture missing KTX identifier"),q(0,0,!1,!1,(()=>{}),!0)}}},11710:(g,w,q)=>{q.d(w,{b:()=>o});class R{constructor(g){this._pendingActions=new Array,this._workerInfos=g.map((g=>({workerPromise:Promise.resolve(g),idle:!0})))}dispose(){for(const g of this._workerInfos)g.workerPromise.then((g=>{g.terminate()}));this._workerInfos.length=0,this._pendingActions.length=0}push(g){this._executeOnIdleWorker(g)||this._pendingActions.push(g)}_executeOnIdleWorker(g){for(const w of this._workerInfos)if(w.idle)return this._execute(w,g),!0;return!1}_execute(g,w){g.idle=!1,g.workerPromise.then((q=>{w(q,(()=>{const w=this._pendingActions.shift();w?this._execute(g,w):g.idle=!0}))}))}}class o extends R{constructor(g,w){let q=arguments.length>2&&void 0!==arguments[2]?arguments[2]:o.DefaultOptions;super([]),this._maxWorkers=g,this._createWorkerAsync=w,this._options=q}push(g){if(!this._executeOnIdleWorker(g))if(this._workerInfos.length<this._maxWorkers){const w={workerPromise:this._createWorkerAsync(),idle:!1};this._workerInfos.push(w),this._execute(w,g)}else this._pendingActions.push(g)}_execute(g,w){g.timeoutId&&(clearTimeout(g.timeoutId),delete g.timeoutId),super._execute(g,((q,R)=>{w(q,(()=>{R(),g.idle&&(g.timeoutId=setTimeout((()=>{g.workerPromise.then((g=>{g.terminate()}));const w=this._workerInfos.indexOf(g);-1!==w&&this._workerInfos.splice(w,1)}),this._options.idleTimeElapsedBeforeRelease))}))}))}}o.DefaultOptions={idleTimeElapsedBeforeRelease:1e3}}}]);