"use strict";(self["9s4i8ue3jq"]=self["9s4i8ue3jq"]||[]).push([[30],{15238:(a,c,o)=>{o.r(c),o.d(c,{_KTXTextureLoader:()=>e});var s=o(12649);class q{constructor(a,c){if(this.data=a,this.isInvalid=!1,!q.IsValid(a))return this.isInvalid=!0,void s.c.Error("texture missing KTX identifier");const o=Uint32Array.BYTES_PER_ELEMENT,t=new DataView(this.data.buffer,this.data.byteOffset+12,13*o),i=67305985===t.getUint32(0,!0);return this.glType=t.getUint32(1*o,i),this.glTypeSize=t.getUint32(2*o,i),this.glFormat=t.getUint32(3*o,i),this.glInternalFormat=t.getUint32(4*o,i),this.glBaseInternalFormat=t.getUint32(5*o,i),this.pixelWidth=t.getUint32(6*o,i),this.pixelHeight=t.getUint32(7*o,i),this.pixelDepth=t.getUint32(8*o,i),this.numberOfArrayElements=t.getUint32(9*o,i),this.numberOfFaces=t.getUint32(10*o,i),this.numberOfMipmapLevels=t.getUint32(11*o,i),this.bytesOfKeyValueData=t.getUint32(12*o,i),0!==this.glType?(s.c.Error("only compressed formats currently supported"),void(this.isInvalid=!0)):(this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels),0===this.pixelHeight||0!==this.pixelDepth?(s.c.Error("only 2D textures currently supported"),void(this.isInvalid=!0)):0!==this.numberOfArrayElements?(s.c.Error("texture arrays not currently supported"),void(this.isInvalid=!0)):this.numberOfFaces!==c?(s.c.Error("number of faces expected"+c+", but found "+this.numberOfFaces),void(this.isInvalid=!0)):void(this.loadType=q.COMPRESSED_2D))}uploadLevels(a,c){switch(this.loadType){case q.COMPRESSED_2D:this._upload2DCompressedLevels(a,c);case q.TEX_2D:case q.COMPRESSED_3D:case q.TEX_3D:}}_upload2DCompressedLevels(a,c){let o=q.HEADER_LEN+this.bytesOfKeyValueData,s=this.pixelWidth,t=this.pixelHeight;const i=c?this.numberOfMipmapLevels:1;for(let q=0;q<i;q++){const c=new Int32Array(this.data.buffer,this.data.byteOffset+o,1)[0];o+=4;for(let i=0;i<this.numberOfFaces;i++){const p=new Uint8Array(this.data.buffer,this.data.byteOffset+o,c);a.getEngine()._uploadCompressedDataToTextureDirectly(a,a.format,s,t,p,i,q),o+=c,o+=3-(c+3)%4}s=Math.max(1,.5*s),t=Math.max(1,.5*t)}}static IsValid(a){if(a.byteLength>=12){const c=new Uint8Array(a.buffer,a.byteOffset,12);if(171===c[0]&&75===c[1]&&84===c[2]&&88===c[3]&&32===c[4]&&49===c[5]&&49===c[6]&&187===c[7]&&13===c[8]&&10===c[9]&&26===c[10]&&10===c[11])return!0}return!1}}q.HEADER_LEN=64,q.COMPRESSED_2D=0,q.COMPRESSED_3D=1,q.TEX_2D=2,q.TEX_3D=3;var t,i,p,G=o(13372),T=o(12637);function C(a,c){const o=(null===c||void 0===c?void 0:c.jsDecoderModule)||KTX2DECODER;a&&(a.wasmUASTCToASTC&&(o.LiteTranscoder_UASTC_ASTC.WasmModuleURL=a.wasmUASTCToASTC),a.wasmUASTCToBC7&&(o.LiteTranscoder_UASTC_BC7.WasmModuleURL=a.wasmUASTCToBC7),a.wasmUASTCToRGBA_UNORM&&(o.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=a.wasmUASTCToRGBA_UNORM),a.wasmUASTCToRGBA_SRGB&&(o.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=a.wasmUASTCToRGBA_SRGB),a.wasmUASTCToR8_UNORM&&(o.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=a.wasmUASTCToR8_UNORM),a.wasmUASTCToRG8_UNORM&&(o.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=a.wasmUASTCToRG8_UNORM),a.jsMSCTranscoder&&(o.MSCTranscoder.JSModuleURL=a.jsMSCTranscoder),a.wasmMSCTranscoder&&(o.MSCTranscoder.WasmModuleURL=a.wasmMSCTranscoder),a.wasmZSTDDecoder&&(o.ZSTDDecoder.WasmModuleURL=a.wasmZSTDDecoder)),c&&(c.wasmUASTCToASTC&&(o.LiteTranscoder_UASTC_ASTC.WasmBinary=c.wasmUASTCToASTC),c.wasmUASTCToBC7&&(o.LiteTranscoder_UASTC_BC7.WasmBinary=c.wasmUASTCToBC7),c.wasmUASTCToRGBA_UNORM&&(o.LiteTranscoder_UASTC_RGBA_UNORM.WasmBinary=c.wasmUASTCToRGBA_UNORM),c.wasmUASTCToRGBA_SRGB&&(o.LiteTranscoder_UASTC_RGBA_SRGB.WasmBinary=c.wasmUASTCToRGBA_SRGB),c.wasmUASTCToR8_UNORM&&(o.LiteTranscoder_UASTC_R8_UNORM.WasmBinary=c.wasmUASTCToR8_UNORM),c.wasmUASTCToRG8_UNORM&&(o.LiteTranscoder_UASTC_RG8_UNORM.WasmBinary=c.wasmUASTCToRG8_UNORM),c.jsMSCTranscoder&&(o.MSCTranscoder.JSModule=c.jsMSCTranscoder),c.wasmMSCTranscoder&&(o.MSCTranscoder.WasmBinary=c.wasmMSCTranscoder),c.wasmZSTDDecoder&&(o.ZSTDDecoder.WasmBinary=c.wasmZSTDDecoder))}function j(a){let c;"undefined"===typeof a&&"undefined"!==typeof KTX2DECODER&&(a=KTX2DECODER),onmessage=o=>{if(o.data)switch(o.data.action){case"init":{const s=o.data.urls;s&&(s.jsDecoderModule&&"undefined"===typeof a&&(importScripts(s.jsDecoderModule),a=KTX2DECODER),C(s)),o.data.wasmBinaries&&C(void 0,{...o.data.wasmBinaries,jsDecoderModule:a}),c=new a.KTX2Decoder,postMessage({action:"init"});break}case"setDefaultDecoderOptions":a.KTX2Decoder.DefaultDecoderOptions=o.data.options;break;case"decode":c.decode(o.data.data,o.data.caps,o.data.options).then((a=>{const c=[];for(let o=0;o<a.mipmaps.length;++o){const s=a.mipmaps[o];s&&s.data&&c.push(s.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:a},c)})).catch((a=>{postMessage({action:"decoded",success:!1,Oc:a})}))}}}!function(a){a[a.ETC1S=0]="ETC1S",a[a.UASTC4x4=1]="UASTC4x4"}(t||(t={})),function(a){a[a.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",a[a.BC7_RGBA=1]="BC7_RGBA",a[a.BC3_RGBA=2]="BC3_RGBA",a[a.BC1_RGB=3]="BC1_RGB",a[a.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",a[a.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",a[a.ETC2_RGBA=6]="ETC2_RGBA",a[a.ETC1_RGB=7]="ETC1_RGB",a[a.RGBA32=8]="RGBA32",a[a.R8=9]="R8",a[a.RG8=10]="RG8"}(i||(i={})),function(a){a[a.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",a[a.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",a[a.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",a[a.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",a[a.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",a[a.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",a[a.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",a[a.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",a[a.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",a[a.RGBA8Format=32856]="RGBA8Format",a[a.R8Format=33321]="R8Format",a[a.RG8Format=33323]="RG8Format"}(p||(p={}));class L{static GetDefaultNumWorkers(){return"object"===typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static _Initialize(a){if(L._WorkerPoolPromise||L._DecoderModulePromise)return;const c={jsDecoderModule:T.Tools.GetBabylonScriptURL(this.URLConfig.jsDecoderModule,!0),wasmUASTCToASTC:T.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToASTC,!0),wasmUASTCToBC7:T.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToBC7,!0),wasmUASTCToRGBA_UNORM:T.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_UNORM,!0),wasmUASTCToRGBA_SRGB:T.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_SRGB,!0),wasmUASTCToR8_UNORM:T.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToR8_UNORM,!0),wasmUASTCToRG8_UNORM:T.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRG8_UNORM,!0),jsMSCTranscoder:T.Tools.GetBabylonScriptURL(this.URLConfig.jsMSCTranscoder,!0),wasmMSCTranscoder:T.Tools.GetBabylonScriptURL(this.URLConfig.wasmMSCTranscoder,!0),wasmZSTDDecoder:T.Tools.GetBabylonScriptURL(this.URLConfig.wasmZSTDDecoder,!0)};a&&"function"===typeof Worker&&"undefined"!==typeof URL?L._WorkerPoolPromise=new Promise((o=>{const s=`${C}(${j})()`,q=URL.createObjectURL(new Blob([s],{type:"application/javascript"}));o(new G.b(a,(async()=>await async function(a,c,o){return await new Promise(((s,q)=>{const t=c=>{a.removeEventListener("error",t),a.removeEventListener("message",i),q(c)},i=c=>{"init"===c.data.action&&(a.removeEventListener("error",t),a.removeEventListener("message",i),s(a))};a.addEventListener("error",t),a.addEventListener("message",i),a.postMessage({action:"init",urls:o,wasmBinaries:c})}))}(new Worker(q),void 0,c))))})):"undefined"===typeof L._KTX2DecoderModule?L._DecoderModulePromise=T.Tools.LoadBabylonScriptAsync(c.jsDecoderModule).then((()=>(L._KTX2DecoderModule=KTX2DECODER,L._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,L._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,C(c,L._KTX2DecoderModule),new L._KTX2DecoderModule.KTX2Decoder))):(L._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,L._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,L._DecoderModulePromise=Promise.resolve(new L._KTX2DecoderModule.KTX2Decoder))}constructor(a){let c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:L.DefaultNumWorkers;this._engine=a;const o="object"===typeof c&&c.workerPool||L.WorkerPool;if(o)L._WorkerPoolPromise=Promise.resolve(o);else{var s;if("object"===typeof c)L._KTX2DecoderModule=null===c||void 0===c||null===(s=c.binariesAndModulesContainer)||void 0===s?void 0:s.jsDecoderModule;else"undefined"!==typeof KTX2DECODER&&(L._KTX2DecoderModule=KTX2DECODER);const a="number"===typeof c?c:c.numWorkers??L.DefaultNumWorkers;L._Initialize(a)}}async _uploadAsync(a,c,o){const s=this._engine.getCaps(),q={astc:!!s.astc,bptc:!!s.bptc,s3tc:!!s.s3tc,pvrtc:!!s.pvrtc,etc2:!!s.etc2,etc1:!!s.etc1};if(L._WorkerPoolPromise){const s=await L._WorkerPoolPromise;return await new Promise(((t,i)=>{s.push(((s,p)=>{const G=a=>{s.removeEventListener("error",G),s.removeEventListener("message",T),i(a),p()},T=a=>{if("decoded"===a.data.action){if(s.removeEventListener("error",G),s.removeEventListener("message",T),a.data.success)try{this._createTexture(a.data.decodedData,c,o),t()}catch(q){i({message:q})}else i({message:a.data.Oc});p()}};s.addEventListener("error",G),s.addEventListener("message",T),s.postMessage({action:"setDefaultDecoderOptions",options:L.DefaultDecoderOptions._getKTX2DecoderOptions()});const C=new Uint8Array(a.byteLength);C.set(new Uint8Array(a.buffer,a.byteOffset,a.byteLength)),s.postMessage({action:"decode",data:C,caps:q,options:o},[C.buffer])}))}))}if(L._DecoderModulePromise){const o=await L._DecoderModulePromise;return L.DefaultDecoderOptions.isDirty&&(L._KTX2DecoderModule.KTX2Decoder.DefaultDecoderOptions=L.DefaultDecoderOptions._getKTX2DecoderOptions()),await new Promise(((q,t)=>{o.decode(a,s).then((a=>{this._createTexture(a,c),q()})).catch((a=>{t({message:a})}))}))}throw new Error("KTX2 decoder module is not available")}_createTexture(a,c,o){this._engine._bindTextureDirectly(3553,c),o&&(o.transcodedFormat=a.transcodedFormat,o.isInGammaSpace=a.isInGammaSpace,o.Uc=a.Uc,o.transcoderName=a.transcoderName);let s=!0;switch(a.transcodedFormat){case 32856:c.type=0,c.format=5;break;case 33321:c.type=0,c.format=6;break;case 33323:c.type=0,c.format=7;break;default:c.format=a.transcodedFormat,s=!1}if(c._gammaSpace=a.isInGammaSpace,c.generateMipMaps=a.mipmaps.length>1,a.errors)throw new Error("KTX2 container - could not transcode the data. "+a.errors);for(let q=0;q<a.mipmaps.length;++q){const o=a.mipmaps[q];if(!o||!o.data)throw new Error("KTX2 container - could not transcode one of the image");s?(c.width=o.width,c.height=o.height,this._engine._uploadDataToTextureDirectly(c,o.data,0,q,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(c,a.transcodedFormat,o.width,o.height,o.data,0,q)}c._extension=".ktx2",c.width=a.mipmaps[0].width,c.height=a.mipmaps[0].height,c.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static IsValid(a){if(a.byteLength>=12){const c=new Uint8Array(a.buffer,a.byteOffset,12);if(171===c[0]&&75===c[1]&&84===c[2]&&88===c[3]&&32===c[4]&&50===c[5]&&48===c[6]&&187===c[7]&&13===c[8]&&10===c[9]&&26===c[10]&&10===c[11])return!0}return!1}}L.URLConfig={jsDecoderModule:"https://cdn.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null},L.DefaultNumWorkers=L.GetDefaultNumWorkers(),L.DefaultDecoderOptions=new class{constructor(){this._isDirty=!0,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=!0,this._ktx2DecoderOptions={}}get isDirty(){return this._isDirty}get useRGBAIfASTCBC7NotAvailableWhenUASTC(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set useRGBAIfASTCBC7NotAvailableWhenUASTC(a){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==a&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=a,this._isDirty=!0)}get useRGBAIfOnlyBC1BC3AvailableWhenUASTC(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set useRGBAIfOnlyBC1BC3AvailableWhenUASTC(a){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==a&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=a,this._isDirty=!0)}get forceRGBA(){return this._forceRGBA}set forceRGBA(a){this._forceRGBA!==a&&(this._forceRGBA=a,this._isDirty=!0)}get forceR8(){return this._forceR8}set forceR8(a){this._forceR8!==a&&(this._forceR8=a,this._isDirty=!0)}get forceRG8(){return this._forceRG8}set forceRG8(a){this._forceRG8!==a&&(this._forceRG8=a,this._isDirty=!0)}get bypassTranscoders(){return this._bypassTranscoders}set bypassTranscoders(a){this._bypassTranscoders!==a&&(this._bypassTranscoders=a,this._isDirty=!0)}_getKTX2DecoderOptions(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=!1;const a={useRGBAIfASTCBC7NotAvailableWhenUASTC:this._useRGBAIfASTCBC7NotAvailableWhenUASTC,forceRGBA:this._forceRGBA,forceR8:this._forceR8,forceRG8:this._forceRG8,bypassTranscoders:this._bypassTranscoders};return this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(a.transcodeFormatDecisionTree={UASTC:{transcodeFormat:[i.BC1_RGB,i.BC3_RGBA],yes:{transcodeFormat:i.RGBA32,engineFormat:32856,roundToMultiple4:!1}}}),this._ktx2DecoderOptions=a,a}};class e{constructor(){this.supportCascades=!1}loadCubeData(a,c,o,s){if(Array.isArray(a))return;c._invertVScale=!c.invertY;const t=c.getEngine(),i=new q(a,6),p=i.numberOfMipmapLevels>1&&c.generateMipMaps;t._unpackFlipY(!0),i.uploadLevels(c,c.generateMipMaps),c.width=i.pixelWidth,c.height=i.pixelHeight,t._setCubeMapTextureParams(c,p,i.numberOfMipmapLevels-1),c.isReady=!0,c.onLoadedObservable.notifyObservers(c),c.onLoadedObservable.clear(),s&&s()}loadData(a,c,o,t){if(q.IsValid(a)){c._invertVScale=!c.invertY;const s=new q(a,1),t=function(a){switch(a){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}(s.glInternalFormat);t?(c.format=t,c._useSRGBBuffer=c.getEngine()._getUseSRGBBuffer(!0,c.generateMipMaps),c._gammaSpace=!0):c.format=s.glInternalFormat,o(s.pixelWidth,s.pixelHeight,c.generateMipMaps,!0,(()=>{s.uploadLevels(c,c.generateMipMaps)}),s.isInvalid)}else if(L.IsValid(a)){new L(c.getEngine())._uploadAsync(a,c,t).then((()=>{o(c.width,c.height,c.generateMipMaps,!0,(()=>{}),!1)}),(a=>{s.c.Warn(`Failed to load KTX2 texture data: ${a.message}`),o(0,0,!1,!1,(()=>{}),!0)}))}else s.c.Error("texture missing KTX identifier"),o(0,0,!1,!1,(()=>{}),!0)}}},13372:(a,c,o)=>{o.d(c,{b:()=>q});class s{constructor(a){this._pendingActions=new Array,this._workerInfos=a.map((a=>({workerPromise:Promise.resolve(a),idle:!0})))}dispose(){for(const a of this._workerInfos)a.workerPromise.then((a=>{a.terminate()}));this._workerInfos.length=0,this._pendingActions.length=0}push(a){this._executeOnIdleWorker(a)||this._pendingActions.push(a)}_executeOnIdleWorker(a){for(const c of this._workerInfos)if(c.idle)return this._execute(c,a),!0;return!1}_execute(a,c){a.idle=!1,a.workerPromise.then((o=>{c(o,(()=>{const c=this._pendingActions.shift();c?this._execute(a,c):a.idle=!0}))}))}}class q extends s{constructor(a,c){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:q.DefaultOptions;super([]),this._maxWorkers=a,this._createWorkerAsync=c,this._options=o}push(a){if(!this._executeOnIdleWorker(a))if(this._workerInfos.length<this._maxWorkers){const c={workerPromise:this._createWorkerAsync(),idle:!1};this._workerInfos.push(c),this._execute(c,a)}else this._pendingActions.push(a)}_execute(a,c){a.timeoutId&&(clearTimeout(a.timeoutId),delete a.timeoutId),super._execute(a,((o,s)=>{c(o,(()=>{s(),a.idle&&(a.timeoutId=setTimeout((()=>{a.workerPromise.then((a=>{a.terminate()}));const c=this._workerInfos.indexOf(a);-1!==c&&this._workerInfos.splice(c,1)}),this._options.idleTimeElapsedBeforeRelease))}))}))}}q.DefaultOptions={idleTimeElapsedBeforeRelease:1e3}}}]);