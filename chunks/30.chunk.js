"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[30],{13698:(o,H,n)=>{n.r(H),n.d(H,{_KTXTextureLoader:()=>l});var E=n(11038);class k{constructor(o,H){if(this.data=o,this.isInvalid=!1,!k.IsValid(o))return this.isInvalid=!0,void E.d.Error("texture missing KTX identifier");const n=Uint32Array.BYTES_PER_ELEMENT,g=new DataView(this.data.buffer,this.data.byteOffset+12,13*n),O=67305985===g.getUint32(0,!0);return this.glType=g.getUint32(1*n,O),this.glTypeSize=g.getUint32(2*n,O),this.glFormat=g.getUint32(3*n,O),this.glInternalFormat=g.getUint32(4*n,O),this.glBaseInternalFormat=g.getUint32(5*n,O),this.pixelWidth=g.getUint32(6*n,O),this.pixelHeight=g.getUint32(7*n,O),this.pixelDepth=g.getUint32(8*n,O),this.numberOfArrayElements=g.getUint32(9*n,O),this.numberOfFaces=g.getUint32(10*n,O),this.numberOfMipmapLevels=g.getUint32(11*n,O),this.bytesOfKeyValueData=g.getUint32(12*n,O),0!==this.glType?(E.d.Error("only compressed formats currently supported"),void(this.isInvalid=!0)):(this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels),0===this.pixelHeight||0!==this.pixelDepth?(E.d.Error("only 2D textures currently supported"),void(this.isInvalid=!0)):0!==this.numberOfArrayElements?(E.d.Error("texture arrays not currently supported"),void(this.isInvalid=!0)):this.numberOfFaces!==H?(E.d.Error("number of faces expected"+H+", but found "+this.numberOfFaces),void(this.isInvalid=!0)):void(this.loadType=k.COMPRESSED_2D))}uploadLevels(o,H){switch(this.loadType){case k.COMPRESSED_2D:this._upload2DCompressedLevels(o,H);case k.TEX_2D:case k.COMPRESSED_3D:case k.TEX_3D:}}_upload2DCompressedLevels(o,H){let n=k.HEADER_LEN+this.bytesOfKeyValueData,E=this.pixelWidth,g=this.pixelHeight;const O=H?this.numberOfMipmapLevels:1;for(let k=0;k<O;k++){const H=new Int32Array(this.data.buffer,this.data.byteOffset+n,1)[0];n+=4;for(let O=0;O<this.numberOfFaces;O++){const Y=new Uint8Array(this.data.buffer,this.data.byteOffset+n,H);o.getEngine()._uploadCompressedDataToTextureDirectly(o,o.format,E,g,Y,O,k),n+=H,n+=3-(H+3)%4}E=Math.max(1,.5*E),g=Math.max(1,.5*g)}}static IsValid(o){if(o.byteLength>=12){const H=new Uint8Array(o.buffer,o.byteOffset,12);if(171===H[0]&&75===H[1]&&84===H[2]&&88===H[3]&&32===H[4]&&49===H[5]&&49===H[6]&&187===H[7]&&13===H[8]&&10===H[9]&&26===H[10]&&10===H[11])return!0}return!1}}k.HEADER_LEN=64,k.COMPRESSED_2D=0,k.COMPRESSED_3D=1,k.TEX_2D=2,k.TEX_3D=3;var g,O,Y,y=n(11770),S=n(11024);function G(o,H){const n=(null===H||void 0===H?void 0:H.jsDecoderModule)||KTX2DECODER;o&&(o.wasmUASTCToASTC&&(n.LiteTranscoder_UASTC_ASTC.WasmModuleURL=o.wasmUASTCToASTC),o.wasmUASTCToBC7&&(n.LiteTranscoder_UASTC_BC7.WasmModuleURL=o.wasmUASTCToBC7),o.wasmUASTCToRGBA_UNORM&&(n.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=o.wasmUASTCToRGBA_UNORM),o.wasmUASTCToRGBA_SRGB&&(n.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=o.wasmUASTCToRGBA_SRGB),o.wasmUASTCToR8_UNORM&&(n.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=o.wasmUASTCToR8_UNORM),o.wasmUASTCToRG8_UNORM&&(n.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=o.wasmUASTCToRG8_UNORM),o.jsMSCTranscoder&&(n.MSCTranscoder.JSModuleURL=o.jsMSCTranscoder),o.wasmMSCTranscoder&&(n.MSCTranscoder.WasmModuleURL=o.wasmMSCTranscoder),o.wasmZSTDDecoder&&(n.ZSTDDecoder.WasmModuleURL=o.wasmZSTDDecoder)),H&&(H.wasmUASTCToASTC&&(n.LiteTranscoder_UASTC_ASTC.WasmBinary=H.wasmUASTCToASTC),H.wasmUASTCToBC7&&(n.LiteTranscoder_UASTC_BC7.WasmBinary=H.wasmUASTCToBC7),H.wasmUASTCToRGBA_UNORM&&(n.LiteTranscoder_UASTC_RGBA_UNORM.WasmBinary=H.wasmUASTCToRGBA_UNORM),H.wasmUASTCToRGBA_SRGB&&(n.LiteTranscoder_UASTC_RGBA_SRGB.WasmBinary=H.wasmUASTCToRGBA_SRGB),H.wasmUASTCToR8_UNORM&&(n.LiteTranscoder_UASTC_R8_UNORM.WasmBinary=H.wasmUASTCToR8_UNORM),H.wasmUASTCToRG8_UNORM&&(n.LiteTranscoder_UASTC_RG8_UNORM.WasmBinary=H.wasmUASTCToRG8_UNORM),H.jsMSCTranscoder&&(n.MSCTranscoder.JSModule=H.jsMSCTranscoder),H.wasmMSCTranscoder&&(n.MSCTranscoder.WasmBinary=H.wasmMSCTranscoder),H.wasmZSTDDecoder&&(n.ZSTDDecoder.WasmBinary=H.wasmZSTDDecoder))}function c(o){let H;"undefined"===typeof o&&"undefined"!==typeof KTX2DECODER&&(o=KTX2DECODER),onmessage=n=>{if(n.data)switch(n.data.action){case"init":{const E=n.data.urls;E&&(E.jsDecoderModule&&"undefined"===typeof o&&(importScripts(E.jsDecoderModule),o=KTX2DECODER),G(E)),n.data.wasmBinaries&&G(void 0,{...n.data.wasmBinaries,jsDecoderModule:o}),H=new o.KTX2Decoder,postMessage({action:"init"});break}case"setDefaultDecoderOptions":o.KTX2Decoder.DefaultDecoderOptions=n.data.options;break;case"decode":H.decode(n.data.data,n.data.caps,n.data.options).then((o=>{const H=[];for(let n=0;n<o.mipmaps.length;++n){const E=o.mipmaps[n];E&&E.data&&H.push(E.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:o},H)})).catch((o=>{postMessage({action:"decoded",success:!1,SH:o})}))}}}!function(o){o[o.ETC1S=0]="ETC1S",o[o.UASTC4x4=1]="UASTC4x4"}(g||(g={})),function(o){o[o.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",o[o.BC7_RGBA=1]="BC7_RGBA",o[o.BC3_RGBA=2]="BC3_RGBA",o[o.BC1_RGB=3]="BC1_RGB",o[o.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",o[o.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",o[o.ETC2_RGBA=6]="ETC2_RGBA",o[o.ETC1_RGB=7]="ETC1_RGB",o[o.RGBA32=8]="RGBA32",o[o.R8=9]="R8",o[o.RG8=10]="RG8"}(O||(O={})),function(o){o[o.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",o[o.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",o[o.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",o[o.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",o[o.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",o[o.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",o[o.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",o[o.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",o[o.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",o[o.RGBA8Format=32856]="RGBA8Format",o[o.R8Format=33321]="R8Format",o[o.RG8Format=33323]="RG8Format"}(Y||(Y={}));class A{static GetDefaultNumWorkers(){return"object"===typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static _Initialize(o){if(A._WorkerPoolPromise||A._DecoderModulePromise)return;const H={jsDecoderModule:S.Tools.GetBabylonScriptURL(this.URLConfig.jsDecoderModule,!0),wasmUASTCToASTC:S.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToASTC,!0),wasmUASTCToBC7:S.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToBC7,!0),wasmUASTCToRGBA_UNORM:S.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_UNORM,!0),wasmUASTCToRGBA_SRGB:S.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_SRGB,!0),wasmUASTCToR8_UNORM:S.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToR8_UNORM,!0),wasmUASTCToRG8_UNORM:S.Tools.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRG8_UNORM,!0),jsMSCTranscoder:S.Tools.GetBabylonScriptURL(this.URLConfig.jsMSCTranscoder,!0),wasmMSCTranscoder:S.Tools.GetBabylonScriptURL(this.URLConfig.wasmMSCTranscoder,!0),wasmZSTDDecoder:S.Tools.GetBabylonScriptURL(this.URLConfig.wasmZSTDDecoder,!0)};o&&"function"===typeof Worker&&"undefined"!==typeof URL?A._WorkerPoolPromise=new Promise((n=>{const E=`${G}(${c})()`,k=URL.createObjectURL(new Blob([E],{type:"application/javascript"}));n(new y.c(o,(async()=>await async function(o,H,n){return await new Promise(((E,k)=>{const g=H=>{o.removeEventListener("error",g),o.removeEventListener("message",O),k(H)},O=H=>{"init"===H.data.action&&(o.removeEventListener("error",g),o.removeEventListener("message",O),E(o))};o.addEventListener("error",g),o.addEventListener("message",O),o.postMessage({action:"init",urls:n,wasmBinaries:H})}))}(new Worker(k),void 0,H))))})):"undefined"===typeof A._KTX2DecoderModule?A._DecoderModulePromise=S.Tools.LoadBabylonScriptAsync(H.jsDecoderModule).then((()=>(A._KTX2DecoderModule=KTX2DECODER,A._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,A._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,G(H,A._KTX2DecoderModule),new A._KTX2DecoderModule.KTX2Decoder))):(A._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,A._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,A._DecoderModulePromise=Promise.resolve(new A._KTX2DecoderModule.KTX2Decoder))}constructor(o){let H=arguments.length>1&&void 0!==arguments[1]?arguments[1]:A.DefaultNumWorkers;this._engine=o;const n="object"===typeof H&&H.workerPool||A.WorkerPool;if(n)A._WorkerPoolPromise=Promise.resolve(n);else{var E;if("object"===typeof H)A._KTX2DecoderModule=null===H||void 0===H||null===(E=H.binariesAndModulesContainer)||void 0===E?void 0:E.jsDecoderModule;else"undefined"!==typeof KTX2DECODER&&(A._KTX2DecoderModule=KTX2DECODER);const o="number"===typeof H?H:H.numWorkers??A.DefaultNumWorkers;A._Initialize(o)}}async _uploadAsync(o,H,n){const E=this._engine.getCaps(),k={astc:!!E.astc,bptc:!!E.bptc,s3tc:!!E.s3tc,pvrtc:!!E.pvrtc,etc2:!!E.etc2,etc1:!!E.etc1};if(A._WorkerPoolPromise){const E=await A._WorkerPoolPromise;return await new Promise(((g,O)=>{E.push(((E,Y)=>{const y=o=>{E.removeEventListener("error",y),E.removeEventListener("message",S),O(o),Y()},S=o=>{if("decoded"===o.data.action){if(E.removeEventListener("error",y),E.removeEventListener("message",S),o.data.success)try{this._createTexture(o.data.decodedData,H,n),g()}catch(k){O({message:k})}else O({message:o.data.SH});Y()}};E.addEventListener("error",y),E.addEventListener("message",S),E.postMessage({action:"setDefaultDecoderOptions",options:A.DefaultDecoderOptions._getKTX2DecoderOptions()});const G=new Uint8Array(o.byteLength);G.set(new Uint8Array(o.buffer,o.byteOffset,o.byteLength)),E.postMessage({action:"decode",data:G,caps:k,options:n},[G.buffer])}))}))}if(A._DecoderModulePromise){const n=await A._DecoderModulePromise;return A.DefaultDecoderOptions.isDirty&&(A._KTX2DecoderModule.KTX2Decoder.DefaultDecoderOptions=A.DefaultDecoderOptions._getKTX2DecoderOptions()),await new Promise(((k,g)=>{n.decode(o,E).then((o=>{this._createTexture(o,H),k()})).catch((o=>{g({message:o})}))}))}throw new Error("KTX2 decoder module is not available")}_createTexture(o,H,n){this._engine._bindTextureDirectly(3553,H),n&&(n.transcodedFormat=o.transcodedFormat,n.isInGammaSpace=o.isInGammaSpace,n.fg=o.fg,n.transcoderName=o.transcoderName);let E=!0;switch(o.transcodedFormat){case 32856:H.type=0,H.format=5;break;case 33321:H.type=0,H.format=6;break;case 33323:H.type=0,H.format=7;break;default:H.format=o.transcodedFormat,E=!1}if(H._gammaSpace=o.isInGammaSpace,H.generateMipMaps=o.mipmaps.length>1,o.errors)throw new Error("KTX2 container - could not transcode the data. "+o.errors);for(let k=0;k<o.mipmaps.length;++k){const n=o.mipmaps[k];if(!n||!n.data)throw new Error("KTX2 container - could not transcode one of the image");E?(H.width=n.width,H.height=n.height,this._engine._uploadDataToTextureDirectly(H,n.data,0,k,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(H,o.transcodedFormat,n.width,n.height,n.data,0,k)}H._extension=".ktx2",H.width=o.mipmaps[0].width,H.height=o.mipmaps[0].height,H.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static IsValid(o){if(o.byteLength>=12){const H=new Uint8Array(o.buffer,o.byteOffset,12);if(171===H[0]&&75===H[1]&&84===H[2]&&88===H[3]&&32===H[4]&&50===H[5]&&48===H[6]&&187===H[7]&&13===H[8]&&10===H[9]&&26===H[10]&&10===H[11])return!0}return!1}}A.URLConfig={jsDecoderModule:"https://cdn.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null},A.DefaultNumWorkers=A.GetDefaultNumWorkers(),A.DefaultDecoderOptions=new class{constructor(){this._isDirty=!0,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=!0,this._ktx2DecoderOptions={}}get isDirty(){return this._isDirty}get useRGBAIfASTCBC7NotAvailableWhenUASTC(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set useRGBAIfASTCBC7NotAvailableWhenUASTC(o){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==o&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=o,this._isDirty=!0)}get useRGBAIfOnlyBC1BC3AvailableWhenUASTC(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set useRGBAIfOnlyBC1BC3AvailableWhenUASTC(o){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==o&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=o,this._isDirty=!0)}get forceRGBA(){return this._forceRGBA}set forceRGBA(o){this._forceRGBA!==o&&(this._forceRGBA=o,this._isDirty=!0)}get forceR8(){return this._forceR8}set forceR8(o){this._forceR8!==o&&(this._forceR8=o,this._isDirty=!0)}get forceRG8(){return this._forceRG8}set forceRG8(o){this._forceRG8!==o&&(this._forceRG8=o,this._isDirty=!0)}get bypassTranscoders(){return this._bypassTranscoders}set bypassTranscoders(o){this._bypassTranscoders!==o&&(this._bypassTranscoders=o,this._isDirty=!0)}_getKTX2DecoderOptions(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=!1;const o={useRGBAIfASTCBC7NotAvailableWhenUASTC:this._useRGBAIfASTCBC7NotAvailableWhenUASTC,forceRGBA:this._forceRGBA,forceR8:this._forceR8,forceRG8:this._forceRG8,bypassTranscoders:this._bypassTranscoders};return this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(o.transcodeFormatDecisionTree={UASTC:{transcodeFormat:[O.BC1_RGB,O.BC3_RGBA],yes:{transcodeFormat:O.RGBA32,engineFormat:32856,roundToMultiple4:!1}}}),this._ktx2DecoderOptions=o,o}};class l{constructor(){this.supportCascades=!1}loadCubeData(o,H,n,E){if(Array.isArray(o))return;H._invertVScale=!H.invertY;const g=H.getEngine(),O=new k(o,6),Y=O.numberOfMipmapLevels>1&&H.generateMipMaps;g._unpackFlipY(!0),O.uploadLevels(H,H.generateMipMaps),H.width=O.pixelWidth,H.height=O.pixelHeight,g._setCubeMapTextureParams(H,Y,O.numberOfMipmapLevels-1),H.isReady=!0,H.onLoadedObservable.notifyObservers(H),H.onLoadedObservable.clear(),E&&E()}loadData(o,H,n,g){if(k.IsValid(o)){H._invertVScale=!H.invertY;const E=new k(o,1),g=function(o){switch(o){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}(E.glInternalFormat);g?(H.format=g,H._useSRGBBuffer=H.getEngine()._getUseSRGBBuffer(!0,H.generateMipMaps),H._gammaSpace=!0):H.format=E.glInternalFormat,n(E.pixelWidth,E.pixelHeight,H.generateMipMaps,!0,(()=>{E.uploadLevels(H,H.generateMipMaps)}),E.isInvalid)}else if(A.IsValid(o)){new A(H.getEngine())._uploadAsync(o,H,g).then((()=>{n(H.width,H.height,H.generateMipMaps,!0,(()=>{}),!1)}),(o=>{E.d.Warn(`Failed to load KTX2 texture data: ${o.message}`),n(0,0,!1,!1,(()=>{}),!0)}))}else E.d.Error("texture missing KTX identifier"),n(0,0,!1,!1,(()=>{}),!0)}}},11770:(o,H,n)=>{n.d(H,{c:()=>k});class E{constructor(o){this._pendingActions=new Array,this._workerInfos=o.map((o=>({workerPromise:Promise.resolve(o),idle:!0})))}dispose(){for(const o of this._workerInfos)o.workerPromise.then((o=>{o.terminate()}));this._workerInfos.length=0,this._pendingActions.length=0}push(o){this._executeOnIdleWorker(o)||this._pendingActions.push(o)}_executeOnIdleWorker(o){for(const H of this._workerInfos)if(H.idle)return this._execute(H,o),!0;return!1}_execute(o,H){o.idle=!1,o.workerPromise.then((n=>{H(n,(()=>{const H=this._pendingActions.shift();H?this._execute(o,H):o.idle=!0}))}))}}class k extends E{constructor(o,H){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:k.DefaultOptions;super([]),this._maxWorkers=o,this._createWorkerAsync=H,this._options=n}push(o){if(!this._executeOnIdleWorker(o))if(this._workerInfos.length<this._maxWorkers){const H={workerPromise:this._createWorkerAsync(),idle:!1};this._workerInfos.push(H),this._execute(H,o)}else this._pendingActions.push(o)}_execute(o,H){o.timeoutId&&(clearTimeout(o.timeoutId),delete o.timeoutId),super._execute(o,((n,E)=>{H(n,(()=>{E(),o.idle&&(o.timeoutId=setTimeout((()=>{o.workerPromise.then((o=>{o.terminate()}));const H=this._workerInfos.indexOf(o);-1!==H&&this._workerInfos.splice(H,1)}),this._options.idleTimeElapsedBeforeRelease))}))}))}}k.DefaultOptions={idleTimeElapsedBeforeRelease:1e3}}}]);