"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[10],{2181:(c,b,A)=>{A.d(b,{b:()=>k,f:()=>j,i:()=>r,j:()=>z});var o=A(525),t=A(688),n=A(702),h=A(2031),s=A(615),L=A(2073),C=(A(2186),A(2087)),J=A(531);A(2226),A(2231),A(2235);const X="image/png",R=2,N=[134,22,135,150,246,214,150,54];function k(c){const b=new DataView(c.buffer,c.byteOffset,c.byteLength);let A=0;for(let h=0;h<N.length;h++)if(b.getUint8(A++)!==N[h])return J.c.Error("Not a babylon environment map"),null;let o="",t=0;for(;t=b.getUint8(A++);)o+=String.fromCharCode(t);let n=JSON.parse(o);return n=E(n),n.binaryDataPosition=A,n.pk&&(n.pk.lodGenerationScale=n.pk.lodGenerationScale||.8),n}function E(c){if(c.version>R)throw new Error(`Unsupported babylon environment map version "${c.version}". Latest supported version is "${R}".`);return 2===c.version?c:c={...c,version:2,imageType:X}}function V(c,b){const A=(b=E(b)).pk;let o=Math.log2(b.width);if(o=Math.round(o)+1,A.mipmaps.length!==6*o)throw new Error(`Unsupported specular mipmaps number "${A.mipmaps.length}"`);const t=new Array(o);for(let n=0;n<o;n++){t[n]=new Array(6);for(let o=0;o<6;o++){const h=A.mipmaps[6*n+o];t[n][o]=new Uint8Array(c.buffer,c.byteOffset+b.binaryDataPosition+h.position,h.length)}}return t}function y(c,b){var A;b=E(b);const o=new Array(6),t=null===(A=b.irradiance)||void 0===A?void 0:A.irradianceTexture;if(t){if(6!==t.faces.length)throw new Error(`Incorrect irradiance texture faces number "${t.faces.length}"`);for(let A=0;A<6;A++){const n=t.faces[A];o[A]=new Uint8Array(c.buffer,c.byteOffset+b.binaryDataPosition+n.position,n.length)}}return o}function j(c,b,A){var o;const n=(A=E(A)).pk;if(!n)return Promise.resolve([]);c._lodGenerationScale=n.lodGenerationScale;const h=[],s=V(b,A);h.push(M(c,s,A.imageType));const L=null===(o=A.irradiance)||void 0===o?void 0:o.irradianceTexture;if(L){var C,J;const o=y(b,A);let n=null;null!==(C=A.irradiance)&&void 0!==C&&null!==(J=C.irradianceTexture)&&void 0!==J&&J.dominantDirection&&(n=t.k.$j(A.irradiance.irradianceTexture.dominantDirection)),h.push(W(c,o,L.size,A.imageType,n))}return Promise.all(h)}async function F(c,b,A,o,t,n,h,s,L,C,J){return await new Promise(((X,R)=>{if(A){const A=b.createTexture(null,!0,!0,null,1,null,(c=>{R(c)}),c);null===o||void 0===o||o.onEffectCreatedObservable.addOnce((s=>{s.executeWhenCompiled((()=>{o.externalTextureSamplerBinding=!0,o.onApply=o=>{o._bindTexture("textureSampler",A),o.setFloat2("scale",1,b._features.needsInvertingBitmap&&c instanceof ImageBitmap?-1:1)},b.scenes.length&&(b.scenes[0].postProcessManager.directRender([o],C,!0,n,h),b.restoreDefaultFramebuffer(),A.dispose(),URL.revokeObjectURL(t),X())}))}))}else{if(b._uploadImageToTexture(J,c,n,h),s){const A=L[h];A&&b._uploadImageToTexture(A._texture,c,n,0)}X()}}))}async function M(c,b){let A=arguments.length>2&&void 0!==arguments[2]?arguments[2]:X;const o=c.getEngine();c.format=5,c.type=0,c.generateMipMaps=!0,c._cachedAnisotropicFilteringLevel=null,o.updateTextureSamplingMode(3,c),await d(c,b,!0,A),c.isReady=!0}async function W(c,b,A){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:X,t=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const n=c.getEngine(),h=new s.c(n,5),C=new L.b(n,h);c._irradianceTexture=C,C._dominantDirection=t,h.isCube=!0,h.format=5,h.type=0,h.generateMipMaps=!0,h._cachedAnisotropicFilteringLevel=null,h.generateMipMaps=!0,h.width=A,h.height=A,n.updateTextureSamplingMode(3,h),await d(h,[b],!1,o),n.generateMipMapsForCubemap(h),h.isReady=!0}async function d(c,b,t){let h=arguments.length>3&&void 0!==arguments[3]?arguments[3]:X;if(!o.d.IsExponentOfTwo(c.width))throw new Error("Texture size must be a power of two");const J=(0,n.ILog2)(c.width)+1,R=c.getEngine();let N=!1,k=!1,E=null,V=null,y=null;const j=R.getCaps();j.textureLOD?R._features.supportRenderAndCopyToLodForFloatTextures?j.textureHalfFloatRender&&j.textureHalfFloatLinearFiltering?(N=!0,c.type=2):j.textureFloatRender&&j.textureFloatLinearFiltering&&(N=!0,c.type=1):N=!1:(N=!1,k=t);let M=0;if(N)R.isWebGPU?(M=1,await A.e(36).then(A.bind(A,13346))):await A.e(29).then(A.bind(A,13348)),E=new C.d("rgbdDecode","rgbdDecode",null,null,1,null,3,R,!1,void 0,c.type,void 0,null,!1,void 0,M),c._isRGBD=!1,c.invertY=!1,V=R.createRenderTargetCubeTexture(c.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:c.type,format:5});else if(c._isRGBD=!0,c.invertY=!0,k){const b=3;y={};const A=c._lodGenerationScale,o=c._lodGenerationOffset;for(let t=0;t<b;t++){const n=(J-1)*A+o,h=o+(n-o)*(1-t/(b-1)),C=Math.round(Math.min(Math.max(h,0),n)),X=new s.c(R,2);X.isCube=!0,X.invertY=!0,X.generateMipMaps=!1,R.updateTextureSamplingMode(2,X);const N=new L.b(null);switch(N._isCube=!0,N._texture=X,y[C]=N,t){case 0:c._lodTextureLow=N;break;case 1:c._lodTextureMid=N;break;case 2:c._lodTextureHigh=N}}}const W=[];for(let A=0;A<b.length;A++)for(let o=0;o<6;o++){const t=b[A][o],n=new Blob([t],{type:h}),s=URL.createObjectURL(n);let L;if(R._features.forceBitmapOverHTMLImageElement)L=R.createImageBitmap(n,{premultiplyAlpha:"none"}).then((async b=>await F(b,R,N,E,s,o,A,k,y,V,c)));else{const b=new Image;b.src=s,L=new Promise(((t,n)=>{b.onload=()=>{F(b,R,N,E,s,o,A,k,y,V,c).then((()=>t())).catch((c=>{n(c)}))},b.onerror=c=>{n(c)}}))}W.push(L)}if(await Promise.all(W),b.length<J){let A;const o=Math.pow(2,J-1-b.length),t=o*o*4;switch(c.type){case 0:A=new Uint8Array(t);break;case 2:A=new Uint16Array(t);break;case 1:A=new Float32Array(t)}for(let n=b.length;n<J;n++)for(let b=0;b<6;b++){var d;R._uploadArrayBufferViewToTexture((null===(d=V)||void 0===d?void 0:d.texture)||c,A,b,n)}}if(V){const b=c._irradianceTexture;c._irradianceTexture=null,R._releaseTexture(c),V._swapAndDie(c),c._irradianceTexture=b}E&&E.dispose(),k&&(c._lodTextureHigh&&c._lodTextureHigh._texture&&(c._lodTextureHigh._texture.isReady=!0),c._lodTextureMid&&c._lodTextureMid._texture&&(c._lodTextureMid._texture.isReady=!0),c._lodTextureLow&&c._lodTextureLow._texture&&(c._lodTextureLow._texture.isReady=!0))}function r(c,b){const A=(b=E(b)).irradiance;if(!A)return;const o=new h.d;t.k.FromArrayToRef(A.x,0,o.x),t.k.FromArrayToRef(A.y,0,o.y),t.k.FromArrayToRef(A.z,0,o.z),t.k.FromArrayToRef(A.xx,0,o.xx),t.k.FromArrayToRef(A.yy,0,o.yy),t.k.FromArrayToRef(A.zz,0,o.zz),t.k.FromArrayToRef(A.yz,0,o.yz),t.k.FromArrayToRef(A.zx,0,o.zx),t.k.FromArrayToRef(A.xy,0,o.xy),c._sphericalPolynomial=o}function z(c,b,A,o,t){const n=M(c.getEngine().createRawCubeTexture(null,c.width,c.format,c.type,c.generateMipMaps,c.invertY,c.samplingMode,c._compression),b).then((()=>c));return c.onRebuildCallback=c=>({proxy:n,isReady:!0,isAsync:!0}),c._source=13,c._bufferViewArrayArray=b,c._lodGenerationScale=o,c._lodGenerationOffset=t,c._sphericalPolynomial=A,M(c,b).then((()=>(c.isReady=!0,c)))}}}]);