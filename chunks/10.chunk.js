"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[10],{2520:(Q,X,C)=>{C.d(X,{b:()=>a,d:()=>x,h:()=>Z,i:()=>g});var l=C(487),h=C(668),M=C(690),f=C(2354),O=C(594),m=C(2404),W=(C(2522),C(2426)),U=C(501);C(2573),C(2578),C(2583);const L="image/png",w=2,i=[134,22,135,150,246,214,150,54];function a(Q){const X=new DataView(Q.buffer,Q.byteOffset,Q.byteLength);let C=0;for(let f=0;f<i.length;f++)if(X.getUint8(C++)!==i[f])return U.c.Error("Not a babylon environment map"),null;let l="",h=0;for(;h=X.getUint8(C++);)l+=String.fromCharCode(h);let M=JSON.parse(l);return M=F(M),M.binaryDataPosition=C,M.kk&&(M.kk.lodGenerationScale=M.kk.lodGenerationScale||.8),M}function F(Q){if(Q.version>w)throw new Error(`Unsupported babylon environment map version "${Q.version}". Latest supported version is "${w}".`);return 2===Q.version?Q:Q={...Q,version:2,imageType:L}}function s(Q,X){const C=(X=F(X)).kk;let l=Math.log2(X.width);if(l=Math.round(l)+1,C.mipmaps.length!==6*l)throw new Error(`Unsupported specular mipmaps number "${C.mipmaps.length}"`);const h=new Array(l);for(let M=0;M<l;M++){h[M]=new Array(6);for(let l=0;l<6;l++){const f=C.mipmaps[6*M+l];h[M][l]=new Uint8Array(Q.buffer,Q.byteOffset+X.binaryDataPosition+f.position,f.length)}}return h}function z(Q,X){var C;X=F(X);const l=new Array(6),h=null===(C=X.irradiance)||void 0===C?void 0:C.irradianceTexture;if(h){if(6!==h.faces.length)throw new Error(`Incorrect irradiance texture faces number "${h.faces.length}"`);for(let C=0;C<6;C++){const M=h.faces[C];l[C]=new Uint8Array(Q.buffer,Q.byteOffset+X.binaryDataPosition+M.position,M.length)}}return l}function x(Q,X,C){var l;const M=(C=F(C)).kk;if(!M)return Promise.resolve([]);Q._lodGenerationScale=M.lodGenerationScale;const f=[],O=s(X,C);f.push(P(Q,O,C.imageType));const m=null===(l=C.irradiance)||void 0===l?void 0:l.irradianceTexture;if(m){var W,U;const l=z(X,C);let M=null;null!==(W=C.irradiance)&&void 0!==W&&null!==(U=W.irradianceTexture)&&void 0!==U&&U.dominantDirection&&(M=h.k.Wj(C.irradiance.irradianceTexture.dominantDirection)),f.push(j(Q,l,m.size,C.imageType,M))}return Promise.all(f)}async function r(Q,X,C,l,h,M,f,O,m,W,U){return await new Promise(((L,w)=>{if(C){const C=X.createTexture(null,!0,!0,null,1,null,(Q=>{w(Q)}),Q);null===l||void 0===l||l.onEffectCreatedObservable.addOnce((O=>{O.executeWhenCompiled((()=>{l.externalTextureSamplerBinding=!0,l.onApply=l=>{l._bindTexture("textureSampler",C),l.setFloat2("scale",1,X._features.needsInvertingBitmap&&Q instanceof ImageBitmap?-1:1)},X.scenes.length&&(X.scenes[0].postProcessManager.directRender([l],W,!0,M,f),X.restoreDefaultFramebuffer(),C.dispose(),URL.revokeObjectURL(h),L())}))}))}else{if(X._uploadImageToTexture(U,Q,M,f),O){const C=m[f];C&&X._uploadImageToTexture(C._texture,Q,M,0)}L()}}))}async function P(Q,X){let C=arguments.length>2&&void 0!==arguments[2]?arguments[2]:L;const l=Q.getEngine();Q.format=5,Q.type=0,Q.generateMipMaps=!0,Q._cachedAnisotropicFilteringLevel=null,l.updateTextureSamplingMode(3,Q),await v(Q,X,!0,C),Q.isReady=!0}async function j(Q,X,C){let l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:L,h=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const M=Q.getEngine(),f=new O.d(M,5),W=new m.d(M,f);Q._irradianceTexture=W,W._dominantDirection=h,f.isCube=!0,f.format=5,f.type=0,f.generateMipMaps=!0,f._cachedAnisotropicFilteringLevel=null,f.generateMipMaps=!0,f.width=C,f.height=C,M.updateTextureSamplingMode(3,f),await v(f,[X],!1,l),M.generateMipMapsForCubemap(f),f.isReady=!0}async function v(Q,X,h){let f=arguments.length>3&&void 0!==arguments[3]?arguments[3]:L;if(!l.i.IsExponentOfTwo(Q.width))throw new Error("Texture size must be a power of two");const U=(0,M.ILog2)(Q.width)+1,w=Q.getEngine();let i=!1,a=!1,F=null,s=null,z=null;const x=w.getCaps();x.textureLOD?w._features.supportRenderAndCopyToLodForFloatTextures?x.textureHalfFloatRender&&x.textureHalfFloatLinearFiltering?(i=!0,Q.type=2):x.textureFloatRender&&x.textureFloatLinearFiltering&&(i=!0,Q.type=1):i=!1:(i=!1,a=h);let P=0;if(i)w.isWebGPU?(P=1,await C.e(36).then(C.bind(C,13690))):await C.e(29).then(C.bind(C,13698)),F=new W.e("rgbdDecode","rgbdDecode",null,null,1,null,3,w,!1,void 0,Q.type,void 0,null,!1,void 0,P),Q._isRGBD=!1,Q.invertY=!1,s=w.createRenderTargetCubeTexture(Q.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:Q.type,format:5});else if(Q._isRGBD=!0,Q.invertY=!0,a){const X=3;z={};const C=Q._lodGenerationScale,l=Q._lodGenerationOffset;for(let h=0;h<X;h++){const M=(U-1)*C+l,f=l+(M-l)*(1-h/(X-1)),W=Math.round(Math.min(Math.max(f,0),M)),L=new O.d(w,2);L.isCube=!0,L.invertY=!0,L.generateMipMaps=!1,w.updateTextureSamplingMode(2,L);const i=new m.d(null);switch(i._isCube=!0,i._texture=L,z[W]=i,h){case 0:Q._lodTextureLow=i;break;case 1:Q._lodTextureMid=i;break;case 2:Q._lodTextureHigh=i}}}const j=[];for(let C=0;C<X.length;C++)for(let l=0;l<6;l++){const h=X[C][l],M=new Blob([h],{type:f}),O=URL.createObjectURL(M);let m;if(w._features.forceBitmapOverHTMLImageElement)m=w.createImageBitmap(M,{premultiplyAlpha:"none"}).then((async X=>await r(X,w,i,F,O,l,C,a,z,s,Q)));else{const X=new Image;X.src=O,m=new Promise(((h,M)=>{X.onload=()=>{r(X,w,i,F,O,l,C,a,z,s,Q).then((()=>h())).catch((Q=>{M(Q)}))},X.onerror=Q=>{M(Q)}}))}j.push(m)}if(await Promise.all(j),X.length<U){let C;const l=Math.pow(2,U-1-X.length),h=l*l*4;switch(Q.type){case 0:C=new Uint8Array(h);break;case 2:C=new Uint16Array(h);break;case 1:C=new Float32Array(h)}for(let M=X.length;M<U;M++)for(let X=0;X<6;X++){var v;w._uploadArrayBufferViewToTexture((null===(v=s)||void 0===v?void 0:v.texture)||Q,C,X,M)}}if(s){const X=Q._irradianceTexture;Q._irradianceTexture=null,w._releaseTexture(Q),s._swapAndDie(Q),Q._irradianceTexture=X}F&&F.dispose(),a&&(Q._lodTextureHigh&&Q._lodTextureHigh._texture&&(Q._lodTextureHigh._texture.isReady=!0),Q._lodTextureMid&&Q._lodTextureMid._texture&&(Q._lodTextureMid._texture.isReady=!0),Q._lodTextureLow&&Q._lodTextureLow._texture&&(Q._lodTextureLow._texture.isReady=!0))}function Z(Q,X){const C=(X=F(X)).irradiance;if(!C)return;const l=new f.h;h.k.FromArrayToRef(C.x,0,l.x),h.k.FromArrayToRef(C.y,0,l.y),h.k.FromArrayToRef(C.z,0,l.z),h.k.FromArrayToRef(C.xx,0,l.xx),h.k.FromArrayToRef(C.yy,0,l.yy),h.k.FromArrayToRef(C.zz,0,l.zz),h.k.FromArrayToRef(C.yz,0,l.yz),h.k.FromArrayToRef(C.zx,0,l.zx),h.k.FromArrayToRef(C.xy,0,l.xy),Q._sphericalPolynomial=l}function g(Q,X,C,l,h){const M=P(Q.getEngine().createRawCubeTexture(null,Q.width,Q.format,Q.type,Q.generateMipMaps,Q.invertY,Q.samplingMode,Q._compression),X).then((()=>Q));return Q.onRebuildCallback=Q=>({proxy:M,isReady:!0,isAsync:!0}),Q._source=13,Q._bufferViewArrayArray=X,Q._lodGenerationScale=l,Q._lodGenerationOffset=h,Q._sphericalPolynomial=C,P(Q,X).then((()=>(Q.isReady=!0,Q)))}}}]);