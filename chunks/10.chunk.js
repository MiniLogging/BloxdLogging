"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[10],{2415:(Z,U,n)=>{n.d(U,{e:()=>q,g:()=>O,h:()=>C,k:()=>D});var i=n(498),B=n(702),l=n(718),H=n(2274),V=n(615),G=n(2307),R=(n(2420),n(2328)),d=n(513);n(2464),n(2466),n(2472);const F="image/png",y=2,S=[134,22,135,150,246,214,150,54];function q(Z){const U=new DataView(Z.buffer,Z.byteOffset,Z.byteLength);let n=0;for(let H=0;H<S.length;H++)if(U.getUint8(n++)!==S[H])return d.c.Error("Not a babylon environment map"),null;let i="",B=0;for(;B=U.getUint8(n++);)i+=String.fromCharCode(B);let l=JSON.parse(i);return l=c(l),l.binaryDataPosition=n,l.ij&&(l.ij.lodGenerationScale=l.ij.lodGenerationScale||.8),l}function c(Z){if(Z.version>y)throw new Error(`Unsupported babylon environment map version "${Z.version}". Latest supported version is "${y}".`);return 2===Z.version?Z:Z={...Z,version:2,imageType:F}}function s(Z,U){const n=(U=c(U)).ij;let i=Math.log2(U.width);if(i=Math.round(i)+1,n.mipmaps.length!==6*i)throw new Error(`Unsupported specular mipmaps number "${n.mipmaps.length}"`);const B=new Array(i);for(let l=0;l<i;l++){B[l]=new Array(6);for(let i=0;i<6;i++){const H=n.mipmaps[6*l+i];B[l][i]=new Uint8Array(Z.buffer,Z.byteOffset+U.binaryDataPosition+H.position,H.length)}}return B}function z(Z,U){var n;U=c(U);const i=new Array(6),B=null===(n=U.irradiance)||void 0===n?void 0:n.irradianceTexture;if(B){if(6!==B.faces.length)throw new Error(`Incorrect irradiance texture faces number "${B.faces.length}"`);for(let n=0;n<6;n++){const l=B.faces[n];i[n]=new Uint8Array(Z.buffer,Z.byteOffset+U.binaryDataPosition+l.position,l.length)}}return i}function O(Z,U,n){var i;const l=(n=c(n)).ij;if(!l)return Promise.resolve([]);Z._lodGenerationScale=l.lodGenerationScale;const H=[],V=s(U,n);H.push(t(Z,V,n.imageType));const G=null===(i=n.irradiance)||void 0===i?void 0:i.irradianceTexture;if(G){var R,d;const i=z(U,n);let l=null;null!==(R=n.irradiance)&&void 0!==R&&null!==(d=R.irradianceTexture)&&void 0!==d&&d.dominantDirection&&(l=B.k.ri(n.irradiance.irradianceTexture.dominantDirection)),H.push(p(Z,i,G.size,n.imageType,l))}return Promise.all(H)}async function E(Z,U,n,i,B,l,H,V,G,R,d){return await new Promise(((F,y)=>{if(n){const n=U.createTexture(null,!0,!0,null,1,null,(Z=>{y(Z)}),Z);null===i||void 0===i||i.onEffectCreatedObservable.addOnce((V=>{V.executeWhenCompiled((()=>{i.externalTextureSamplerBinding=!0,i.onApply=i=>{i._bindTexture("textureSampler",n),i.setFloat2("scale",1,U._features.needsInvertingBitmap&&Z instanceof ImageBitmap?-1:1)},U.scenes.length&&(U.scenes[0].postProcessManager.directRender([i],R,!0,l,H),U.restoreDefaultFramebuffer(),n.dispose(),URL.revokeObjectURL(B),F())}))}))}else{if(U._uploadImageToTexture(d,Z,l,H),V){const n=G[H];n&&U._uploadImageToTexture(n._texture,Z,l,0)}F()}}))}async function t(Z,U){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:F;const i=Z.getEngine();Z.format=5,Z.type=0,Z.generateMipMaps=!0,Z._cachedAnisotropicFilteringLevel=null,i.updateTextureSamplingMode(3,Z),await K(Z,U,!0,n),Z.isReady=!0}async function p(Z,U,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:F,B=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const l=Z.getEngine(),H=new V.b(l,5),R=new G.c(l,H);Z._irradianceTexture=R,R._dominantDirection=B,H.isCube=!0,H.format=5,H.type=0,H.generateMipMaps=!0,H._cachedAnisotropicFilteringLevel=null,H.generateMipMaps=!0,H.width=n,H.height=n,l.updateTextureSamplingMode(3,H),await K(H,[U],!1,i),l.generateMipMapsForCubemap(H),H.isReady=!0}async function K(Z,U,B){let H=arguments.length>3&&void 0!==arguments[3]?arguments[3]:F;if(!i.e.IsExponentOfTwo(Z.width))throw new Error("Texture size must be a power of two");const d=(0,l.ILog2)(Z.width)+1,y=Z.getEngine();let S=!1,q=!1,c=null,s=null,z=null;const O=y.getCaps();O.textureLOD?y._features.supportRenderAndCopyToLodForFloatTextures?O.textureHalfFloatRender&&O.textureHalfFloatLinearFiltering?(S=!0,Z.type=2):O.textureFloatRender&&O.textureFloatLinearFiltering&&(S=!0,Z.type=1):S=!1:(S=!1,q=B);let t=0;if(S)y.isWebGPU?(t=1,await n.e(36).then(n.bind(n,13387))):await n.e(29).then(n.bind(n,13389)),c=new R.c("rgbdDecode","rgbdDecode",null,null,1,null,3,y,!1,void 0,Z.type,void 0,null,!1,void 0,t),Z._isRGBD=!1,Z.invertY=!1,s=y.createRenderTargetCubeTexture(Z.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:Z.type,format:5});else if(Z._isRGBD=!0,Z.invertY=!0,q){const U=3;z={};const n=Z._lodGenerationScale,i=Z._lodGenerationOffset;for(let B=0;B<U;B++){const l=(d-1)*n+i,H=i+(l-i)*(1-B/(U-1)),R=Math.round(Math.min(Math.max(H,0),l)),F=new V.b(y,2);F.isCube=!0,F.invertY=!0,F.generateMipMaps=!1,y.updateTextureSamplingMode(2,F);const S=new G.c(null);switch(S._isCube=!0,S._texture=F,z[R]=S,B){case 0:Z._lodTextureLow=S;break;case 1:Z._lodTextureMid=S;break;case 2:Z._lodTextureHigh=S}}}const p=[];for(let n=0;n<U.length;n++)for(let i=0;i<6;i++){const B=U[n][i],l=new Blob([B],{type:H}),V=URL.createObjectURL(l);let G;if(y._features.forceBitmapOverHTMLImageElement)G=y.createImageBitmap(l,{premultiplyAlpha:"none"}).then((async U=>await E(U,y,S,c,V,i,n,q,z,s,Z)));else{const U=new Image;U.src=V,G=new Promise(((B,l)=>{U.onload=()=>{E(U,y,S,c,V,i,n,q,z,s,Z).then((()=>B())).catch((Z=>{l(Z)}))},U.onerror=Z=>{l(Z)}}))}p.push(G)}if(await Promise.all(p),U.length<d){let n;const i=Math.pow(2,d-1-U.length),B=i*i*4;switch(Z.type){case 0:n=new Uint8Array(B);break;case 2:n=new Uint16Array(B);break;case 1:n=new Float32Array(B)}for(let l=U.length;l<d;l++)for(let U=0;U<6;U++){var K;y._uploadArrayBufferViewToTexture((null===(K=s)||void 0===K?void 0:K.texture)||Z,n,U,l)}}if(s){const U=Z._irradianceTexture;Z._irradianceTexture=null,y._releaseTexture(Z),s._swapAndDie(Z),Z._irradianceTexture=U}c&&c.dispose(),q&&(Z._lodTextureHigh&&Z._lodTextureHigh._texture&&(Z._lodTextureHigh._texture.isReady=!0),Z._lodTextureMid&&Z._lodTextureMid._texture&&(Z._lodTextureMid._texture.isReady=!0),Z._lodTextureLow&&Z._lodTextureLow._texture&&(Z._lodTextureLow._texture.isReady=!0))}function C(Z,U){const n=(U=c(U)).irradiance;if(!n)return;const i=new H.f;B.k.FromArrayToRef(n.x,0,i.x),B.k.FromArrayToRef(n.y,0,i.y),B.k.FromArrayToRef(n.z,0,i.z),B.k.FromArrayToRef(n.xx,0,i.xx),B.k.FromArrayToRef(n.yy,0,i.yy),B.k.FromArrayToRef(n.zz,0,i.zz),B.k.FromArrayToRef(n.yz,0,i.yz),B.k.FromArrayToRef(n.zx,0,i.zx),B.k.FromArrayToRef(n.xy,0,i.xy),Z._sphericalPolynomial=i}function D(Z,U,n,i,B){const l=t(Z.getEngine().createRawCubeTexture(null,Z.width,Z.format,Z.type,Z.generateMipMaps,Z.invertY,Z.samplingMode,Z._compression),U).then((()=>Z));return Z.onRebuildCallback=Z=>({proxy:l,isReady:!0,isAsync:!0}),Z._source=13,Z._bufferViewArrayArray=U,Z._lodGenerationScale=i,Z._lodGenerationOffset=B,Z._sphericalPolynomial=n,t(Z,U).then((()=>(Z.isReady=!0,Z)))}}}]);