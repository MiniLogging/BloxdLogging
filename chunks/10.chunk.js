"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[10],{2423:(t,q,S)=>{S.d(q,{e:()=>h,g:()=>v,i:()=>J,k:()=>U});var o=S(490),B=S(678),z=S(689),L=S(2270),r=S(599),e=S(2311),C=(S(2428),S(2339)),Z=S(496);S(2481),S(2488),S(2491);const b="image/png",O=2,i=[134,22,135,150,246,214,150,54];function h(t){const q=new DataView(t.buffer,t.byteOffset,t.byteLength);let S=0;for(let L=0;L<i.length;L++)if(q.getUint8(S++)!==i[L])return Z.c.Error("Not a babylon environment map"),null;let o="",B=0;for(;B=q.getUint8(S++);)o+=String.fromCharCode(B);let z=JSON.parse(o);return z=l(z),z.binaryDataPosition=S,z.kj&&(z.kj.lodGenerationScale=z.kj.lodGenerationScale||.8),z}function l(t){if(t.version>O)throw new Error(`Unsupported babylon environment map version "${t.version}". Latest supported version is "${O}".`);return 2===t.version?t:t={...t,version:2,imageType:b}}function I(t,q){const S=(q=l(q)).kj;let o=Math.log2(q.width);if(o=Math.round(o)+1,S.mipmaps.length!==6*o)throw new Error(`Unsupported specular mipmaps number "${S.mipmaps.length}"`);const B=new Array(o);for(let z=0;z<o;z++){B[z]=new Array(6);for(let o=0;o<6;o++){const L=S.mipmaps[6*z+o];B[z][o]=new Uint8Array(t.buffer,t.byteOffset+q.binaryDataPosition+L.position,L.length)}}return B}function a(t,q){var S;q=l(q);const o=new Array(6),B=null===(S=q.irradiance)||void 0===S?void 0:S.irradianceTexture;if(B){if(6!==B.faces.length)throw new Error(`Incorrect irradiance texture faces number "${B.faces.length}"`);for(let S=0;S<6;S++){const z=B.faces[S];o[S]=new Uint8Array(t.buffer,t.byteOffset+q.binaryDataPosition+z.position,z.length)}}return o}function v(t,q,S){var o;const z=(S=l(S)).kj;if(!z)return Promise.resolve([]);t._lodGenerationScale=z.lodGenerationScale;const L=[],r=I(q,S);L.push(x(t,r,S.imageType));const e=null===(o=S.irradiance)||void 0===o?void 0:o.irradianceTexture;if(e){var C,Z;const o=a(q,S);let z=null;null!==(C=S.irradiance)&&void 0!==C&&null!==(Z=C.irradianceTexture)&&void 0!==Z&&Z.dominantDirection&&(z=B.o.ti(S.irradiance.irradianceTexture.dominantDirection)),L.push(k(t,o,e.size,S.imageType,z))}return Promise.all(L)}async function M(t,q,S,o,B,z,L,r,e,C,Z){return await new Promise(((b,O)=>{if(S){const S=q.createTexture(null,!0,!0,null,1,null,(t=>{O(t)}),t);null===o||void 0===o||o.onEffectCreatedObservable.addOnce((r=>{r.executeWhenCompiled((()=>{o.externalTextureSamplerBinding=!0,o.onApply=o=>{o._bindTexture("textureSampler",S),o.setFloat2("scale",1,q._features.needsInvertingBitmap&&t instanceof ImageBitmap?-1:1)},q.scenes.length&&(q.scenes[0].postProcessManager.directRender([o],C,!0,z,L),q.restoreDefaultFramebuffer(),S.dispose(),URL.revokeObjectURL(B),b())}))}))}else{if(q._uploadImageToTexture(Z,t,z,L),r){const S=e[L];S&&q._uploadImageToTexture(S._texture,t,z,0)}b()}}))}async function x(t,q){let S=arguments.length>2&&void 0!==arguments[2]?arguments[2]:b;const o=t.getEngine();t.format=5,t.type=0,t.generateMipMaps=!0,t._cachedAnisotropicFilteringLevel=null,o.updateTextureSamplingMode(3,t),await V(t,q,!0,S),t.isReady=!0}async function k(t,q,S){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:b,B=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const z=t.getEngine(),L=new r.b(z,5),C=new e.b(z,L);t._irradianceTexture=C,C._dominantDirection=B,L.isCube=!0,L.format=5,L.type=0,L.generateMipMaps=!0,L._cachedAnisotropicFilteringLevel=null,L.generateMipMaps=!0,L.width=S,L.height=S,z.updateTextureSamplingMode(3,L),await V(L,[q],!1,o),z.generateMipMapsForCubemap(L),L.isReady=!0}async function V(t,q,B){let L=arguments.length>3&&void 0!==arguments[3]?arguments[3]:b;if(!o.f.IsExponentOfTwo(t.width))throw new Error("Texture size must be a power of two");const Z=(0,z.ILog2)(t.width)+1,O=t.getEngine();let i=!1,h=!1,l=null,I=null,a=null;const v=O.getCaps();v.textureLOD?O._features.supportRenderAndCopyToLodForFloatTextures?v.textureHalfFloatRender&&v.textureHalfFloatLinearFiltering?(i=!0,t.type=2):v.textureFloatRender&&v.textureFloatLinearFiltering&&(i=!0,t.type=1):i=!1:(i=!1,h=B);let x=0;if(i)O.isWebGPU?(x=1,await S.e(36).then(S.bind(S,13488))):await S.e(29).then(S.bind(S,13491)),l=new C.c("rgbdDecode","rgbdDecode",null,null,1,null,3,O,!1,void 0,t.type,void 0,null,!1,void 0,x),t._isRGBD=!1,t.invertY=!1,I=O.createRenderTargetCubeTexture(t.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:t.type,format:5});else if(t._isRGBD=!0,t.invertY=!0,h){const q=3;a={};const S=t._lodGenerationScale,o=t._lodGenerationOffset;for(let B=0;B<q;B++){const z=(Z-1)*S+o,L=o+(z-o)*(1-B/(q-1)),C=Math.round(Math.min(Math.max(L,0),z)),b=new r.b(O,2);b.isCube=!0,b.invertY=!0,b.generateMipMaps=!1,O.updateTextureSamplingMode(2,b);const i=new e.b(null);switch(i._isCube=!0,i._texture=b,a[C]=i,B){case 0:t._lodTextureLow=i;break;case 1:t._lodTextureMid=i;break;case 2:t._lodTextureHigh=i}}}const k=[];for(let S=0;S<q.length;S++)for(let o=0;o<6;o++){const B=q[S][o],z=new Blob([B],{type:L}),r=URL.createObjectURL(z);let e;if(O._features.forceBitmapOverHTMLImageElement)e=O.createImageBitmap(z,{premultiplyAlpha:"none"}).then((async q=>await M(q,O,i,l,r,o,S,h,a,I,t)));else{const q=new Image;q.src=r,e=new Promise(((B,z)=>{q.onload=()=>{M(q,O,i,l,r,o,S,h,a,I,t).then((()=>B())).catch((t=>{z(t)}))},q.onerror=t=>{z(t)}}))}k.push(e)}if(await Promise.all(k),q.length<Z){let S;const o=Math.pow(2,Z-1-q.length),B=o*o*4;switch(t.type){case 0:S=new Uint8Array(B);break;case 2:S=new Uint16Array(B);break;case 1:S=new Float32Array(B)}for(let z=q.length;z<Z;z++)for(let q=0;q<6;q++){var V;O._uploadArrayBufferViewToTexture((null===(V=I)||void 0===V?void 0:V.texture)||t,S,q,z)}}if(I){const q=t._irradianceTexture;t._irradianceTexture=null,O._releaseTexture(t),I._swapAndDie(t),t._irradianceTexture=q}l&&l.dispose(),h&&(t._lodTextureHigh&&t._lodTextureHigh._texture&&(t._lodTextureHigh._texture.isReady=!0),t._lodTextureMid&&t._lodTextureMid._texture&&(t._lodTextureMid._texture.isReady=!0),t._lodTextureLow&&t._lodTextureLow._texture&&(t._lodTextureLow._texture.isReady=!0))}function J(t,q){const S=(q=l(q)).irradiance;if(!S)return;const o=new L.h;B.o.FromArrayToRef(S.x,0,o.x),B.o.FromArrayToRef(S.y,0,o.y),B.o.FromArrayToRef(S.z,0,o.z),B.o.FromArrayToRef(S.xx,0,o.xx),B.o.FromArrayToRef(S.yy,0,o.yy),B.o.FromArrayToRef(S.zz,0,o.zz),B.o.FromArrayToRef(S.yz,0,o.yz),B.o.FromArrayToRef(S.zx,0,o.zx),B.o.FromArrayToRef(S.xy,0,o.xy),t._sphericalPolynomial=o}function U(t,q,S,o,B){const z=x(t.getEngine().createRawCubeTexture(null,t.width,t.format,t.type,t.generateMipMaps,t.invertY,t.samplingMode,t._compression),q).then((()=>t));return t.onRebuildCallback=t=>({proxy:z,isReady:!0,isAsync:!0}),t._source=13,t._bufferViewArrayArray=q,t._lodGenerationScale=o,t._lodGenerationOffset=B,t._sphericalPolynomial=S,x(t,q).then((()=>(t.isReady=!0,t)))}}}]);