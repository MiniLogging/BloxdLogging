"use strict";(self.gpkvekif0vo=self.gpkvekif0vo||[]).push([[47],{14857:(a,O,i)=>{i.r(O),i.d(O,{_BasisTextureLoader:()=>J});var H,b=i(12184),G=i(12370),q=i(12317);function Q(){const a=0,O=1,i=2,H=3,b=6,G=8,q=9,Q=10,k=14;let I=null;function P(a,O,i,H,b){const G=a.getImageTranscodedSizeInBytes(O,i,H);let q=new Uint8Array(G);if(!a.transcodeImage(q,O,i,H,1,0))return null;if(b){q=function(a,O,i,H){const b=new Uint16Array(4),G=new Uint16Array(i*H),q=i/4,Q=H/4;for(let k=0;k<Q;k++)for(let H=0;H<q;H++){const Q=O+8*(k*q+H);b[0]=a[Q]|a[Q+1]<<8,b[1]=a[Q+2]|a[Q+3]<<8,b[2]=(2*(31&b[0])+1*(31&b[1]))/3|(2*(2016&b[0])+1*(2016&b[1]))/3&2016|(2*(63488&b[0])+1*(63488&b[1]))/3&63488,b[3]=(2*(31&b[1])+1*(31&b[0]))/3|(2*(2016&b[1])+1*(2016&b[0]))/3&2016|(2*(63488&b[1])+1*(63488&b[0]))/3&63488;for(let O=0;O<4;O++){const q=a[Q+4+O];let I=(4*k+O)*i+4*H;G[I++]=b[3&q],G[I++]=b[q>>2&3],G[I++]=b[q>>4&3],G[I++]=b[q>>6&3]}}return G}(q,0,a.getImageWidth(O,i)+3&-4,a.getImageHeight(O,i)+3&-4)}return q}onmessage=e=>{if("init"===e.data.action){if(e.data.url)try{importScripts(e.data.url)}catch(h){postMessage({action:"error",error:h})}I||(I=BASIS({wasmBinary:e.data.wasmBinary})),null!==I&&I.then((a=>{BASIS=a,a.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===e.data.action){const I=e.data.config,h=e.data.imageData,j=new BASIS.BasisFile(h),Z=function(a){const O=a.getHasAlpha(),i=a.getNumImages(),H=[];for(let b=0;b<i;b++){const O={levels:[]},i=a.getNumLevels(b);for(let H=0;H<i;H++){const i={width:a.getImageWidth(b,H),height:a.getImageHeight(b,H)};O.levels.push(i)}H.push(O)}return{nb:O,images:H}}(j);let F=e.data.ignoreSupportedFormats?null:function(I,P){let e=null;I.supportedCompressionFormats&&(e=I.supportedCompressionFormats.astc?Q:I.supportedCompressionFormats.bc7?b:I.supportedCompressionFormats.s3tc?P.nb?H:i:I.supportedCompressionFormats.pvrtc?P.nb?q:G:I.supportedCompressionFormats.etc2?O:I.supportedCompressionFormats.etc1?a:k);return e}(e.data.config,Z),r=!1;null===F&&(r=!0,F=Z.nb?H:i);let J=!0;j.startTranscoding()||(J=!1);const ma=[];for(let a=0;a<Z.images.length&&J;a++){const O=Z.images[a];if(void 0===I.loadSingleImage||I.loadSingleImage===a){let i=O.levels.length;!1===I.loadMipmapLevels&&(i=1);for(let H=0;H<i;H++){const i=O.levels[H],b=P(j,a,H,F,r);if(!b){J=!1;break}i.transcodedPixels=b,ma.push(i.transcodedPixels.buffer)}}}j.close(),j.delete(),r&&(F=-1),J?postMessage({action:"transcode",success:J,id:e.data.id,fileInfo:Z,format:F},ma):postMessage({action:"transcode",success:J,id:e.data.id})}}}!function(a){a[a.cTFETC1=0]="cTFETC1",a[a.cTFETC2=1]="cTFETC2",a[a.cTFBC1=2]="cTFBC1",a[a.cTFBC3=3]="cTFBC3",a[a.cTFBC4=4]="cTFBC4",a[a.cTFBC5=5]="cTFBC5",a[a.cTFBC7=6]="cTFBC7",a[a.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",a[a.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",a[a.cTFASTC_4x4=10]="cTFASTC_4x4",a[a.cTFATC_RGB=11]="cTFATC_RGB",a[a.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",a[a.cTFRGBA32=13]="cTFRGBA32",a[a.cTFRGB565=14]="cTFRGB565",a[a.cTFBGR565=15]="cTFBGR565",a[a.cTFRGBA4444=16]="cTFRGBA4444",a[a.cTFFXT1_RGB=17]="cTFFXT1_RGB",a[a.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",a[a.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",a[a.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",a[a.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(H||(H={}));const k={JSModuleURL:`${b.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${b.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let I=null,P=null,e=0;const h=async()=>(I||(I=new Promise(((a,O)=>{P?a(P):b.Tools.LoadFileAsync(b.Tools.GetBabylonScriptURL(k.WasmModuleURL)).then((i=>{if("function"!==typeof URL)return O("Basis transcoder requires an environment with a URL constructor");const H=URL.createObjectURL(new Blob([`(${Q})()`],{type:"application/javascript"}));P=new Worker(H),async function(a,O,i){return await new Promise(((H,G)=>{const q=O=>{"init"===O.data.action?(a.removeEventListener("message",q),H(a)):"error"===O.data.action&&G(O.data.error||"error initializing worker")};a.addEventListener("message",q),a.postMessage({action:"init",url:i?b.Tools.GetBabylonScriptURL(i):void 0,wasmBinary:O},[O])}))}(P,i,k.JSModuleURL).then(a,O)})).catch(O)}))),await I),j=async(a,O)=>{const i=a instanceof ArrayBuffer?new Uint8Array(a):a;return await new Promise(((a,H)=>{h().then((()=>{const b=e++,G=O=>{"transcode"===O.data.action&&O.data.id===b&&(P.removeEventListener("message",G),O.data.success?a(O.data):H("Transcode is not supported on this device"))};P.addEventListener("message",G);const q=new Uint8Array(i.byteLength);q.set(new Uint8Array(i.buffer,i.byteOffset,i.byteLength)),P.postMessage({action:"transcode",id:b,imageData:q,config:O,ignoreSupportedFormats:false},[q.buffer])}),(a=>{H(a)}))}))},Z=(a,O)=>{var i;let H=null===(i=O._gl)||void 0===i?void 0:i.TEXTURE_2D;var b;a.isCube&&(H=null===(b=O._gl)||void 0===b?void 0:b.TEXTURE_CUBE_MAP);O._bindTextureDirectly(H,a,!0)},F=(a,O)=>{const i=a.getEngine();for(let Q=0;Q<O.fileInfo.images.length;Q++){const k=O.fileInfo.images[Q].levels[0];if(a._invertVScale=a.invertY,-1===O.format||O.format===H.cTFRGB565)if(a.type=10,a.format=4,!i._features.basisNeedsPOT||Math.log2(k.width)%1===0&&Math.log2(k.height)%1===0)a._invertVScale=!a.invertY,a.width=k.width+3&-4,a.height=k.height+3&-4,a.samplingMode=2,Z(a,i),i._uploadDataToTextureDirectly(a,new Uint16Array(k.transcodedPixels.buffer),Q,0,4,!0);else{const O=new q.c(i,2);a._invertVScale=a.invertY,O.type=10,O.format=4,O.width=k.width+3&-4,O.height=k.height+3&-4,Z(O,i),i._uploadDataToTextureDirectly(O,new Uint16Array(k.transcodedPixels.buffer),Q,0,4,!0),i._rescaleTexture(O,a,i.scenes[0],i._getInternalFormat(4),(()=>{i._releaseTexture(O),Z(a,i)}))}else{a.width=k.width,a.height=k.height,a.generateMipMaps=O.fileInfo.images[Q].levels.length>1;const H=r.GetInternalFormatFromBasisFormat(O.format,i);a.format=H,Z(a,i);const q=O.fileInfo.images[Q].levels;for(let O=0;O<q.length;O++){const b=q[O];i._uploadCompressedDataToTextureDirectly(a,H,b.width,b.height,b.transcodedPixels,Q,O)}!i._features.basisNeedsPOT||Math.log2(a.width)%1===0&&Math.log2(a.height)%1===0||(b.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),a._cachedWrapU=G.e.CLAMP_ADDRESSMODE,a._cachedWrapV=G.e.CLAMP_ADDRESSMODE)}}},r={JSModuleURL:k.JSModuleURL,WasmModuleURL:k.WasmModuleURL,GetInternalFormatFromBasisFormat:(a,O)=>{let i;switch(a){case H.cTFETC1:i=36196;break;case H.cTFBC1:i=33776;break;case H.cTFBC4:i=33779;break;case H.cTFASTC_4x4:i=37808;break;case H.cTFETC2:i=37496;break;case H.cTFBC7:i=36492}if(void 0===i)throw"The chosen Basis transcoder format is not currently supported";return i},TranscodeAsync:j,LoadTextureFromTranscodeResult:F};Object.defineProperty(r,"JSModuleURL",{get:function(){return k.JSModuleURL},set:function(a){k.JSModuleURL=a}}),Object.defineProperty(r,"WasmModuleURL",{get:function(){return k.WasmModuleURL},set:function(a){k.WasmModuleURL=a}});class J{constructor(){this.supportCascades=!1}loadCubeData(a,O,i,H,G){if(Array.isArray(a))return;const q=O.getEngine().getCaps(),Q={supportedCompressionFormats:{etc1:!!q.etc1,s3tc:!!q.s3tc,pvrtc:!!q.pvrtc,etc2:!!q.etc2,astc:!!q.astc,bc7:!!q.bptc}};j(a,Q).then((a=>{const i=a.fileInfo.images[0].levels.length>1&&O.generateMipMaps;F(O,a),O.getEngine()._setCubeMapTextureParams(O,i),O.isReady=!0,O.onLoadedObservable.notifyObservers(O),O.onLoadedObservable.clear(),H&&H()})).catch((a=>{b.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),O.isReady=!0,G&&G(a)}))}loadData(a,O,i){const H=O.getEngine().getCaps(),G={supportedCompressionFormats:{etc1:!!H.etc1,s3tc:!!H.s3tc,pvrtc:!!H.pvrtc,etc2:!!H.etc2,astc:!!H.astc,bc7:!!H.bptc}};j(a,G).then((a=>{const H=a.fileInfo.images[0].levels[0],b=a.fileInfo.images[0].levels.length>1&&O.generateMipMaps;i(H.width,H.height,b,-1!==a.format,(()=>{F(O,a)}))})).catch((a=>{b.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),b.Tools.Warn(`Failed to transcode Basis file: ${a}`),i(0,0,!1,!1,(()=>{}),!0)}))}}}}]);