"use strict";(self["5dou0t7wntc"]=self["5dou0t7wntc"]||[]).push([[47],{14173:(K,O,F)=>{F.r(O),F.d(O,{_BasisTextureLoader:()=>k});var f,r=F(11517),l=F(11688),q=F(11636);function J(){const K=0,O=1,F=2,f=3,r=6,l=8,q=9,J=10,c=14;let E=null;function M(K,O,F,f,r){const l=K.getImageTranscodedSizeInBytes(O,F,f);let q=new Uint8Array(l);if(!K.transcodeImage(q,O,F,f,1,0))return null;if(r){q=function(K,O,F,f){const r=new Uint16Array(4),l=new Uint16Array(F*f),q=F/4,J=f/4;for(let c=0;c<J;c++)for(let f=0;f<q;f++){const J=O+8*(c*q+f);r[0]=K[J]|K[J+1]<<8,r[1]=K[J+2]|K[J+3]<<8,r[2]=(2*(31&r[0])+1*(31&r[1]))/3|(2*(2016&r[0])+1*(2016&r[1]))/3&2016|(2*(63488&r[0])+1*(63488&r[1]))/3&63488,r[3]=(2*(31&r[1])+1*(31&r[0]))/3|(2*(2016&r[1])+1*(2016&r[0]))/3&2016|(2*(63488&r[1])+1*(63488&r[0]))/3&63488;for(let O=0;O<4;O++){const q=K[J+4+O];let E=(4*c+O)*F+4*f;l[E++]=r[3&q],l[E++]=r[q>>2&3],l[E++]=r[q>>4&3],l[E++]=r[q>>6&3]}}return l}(q,0,K.getImageWidth(O,F)+3&-4,K.getImageHeight(O,F)+3&-4)}return q}onmessage=t=>{if("init"===t.data.action){if(t.data.url)try{importScripts(t.data.url)}catch(j){postMessage({action:"error",error:j})}E||(E=BASIS({wasmBinary:t.data.wasmBinary})),null!==E&&E.then((K=>{BASIS=K,K.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===t.data.action){const E=t.data.config,j=t.data.imageData,X=new BASIS.BasisFile(j),u=function(K){const O=K.getHasAlpha(),F=K.getNumImages(),f=[];for(let r=0;r<F;r++){const O={levels:[]},F=K.getNumLevels(r);for(let f=0;f<F;f++){const F={width:K.getImageWidth(r,f),height:K.getImageHeight(r,f)};O.levels.push(F)}f.push(O)}return{bf:O,images:f}}(X);let T=t.data.ignoreSupportedFormats?null:function(E,M){let t=null;E.supportedCompressionFormats&&(t=E.supportedCompressionFormats.astc?J:E.supportedCompressionFormats.bc7?r:E.supportedCompressionFormats.s3tc?M.bf?f:F:E.supportedCompressionFormats.pvrtc?M.bf?q:l:E.supportedCompressionFormats.etc2?O:E.supportedCompressionFormats.etc1?K:c);return t}(t.data.config,u),o=!1;null===T&&(o=!0,T=u.bf?f:F);let k=!0;X.startTranscoding()||(k=!1);const N=[];for(let K=0;K<u.images.length&&k;K++){const O=u.images[K];if(void 0===E.loadSingleImage||E.loadSingleImage===K){let F=O.levels.length;!1===E.loadMipmapLevels&&(F=1);for(let f=0;f<F;f++){const F=O.levels[f],r=M(X,K,f,T,o);if(!r){k=!1;break}F.transcodedPixels=r,N.push(F.transcodedPixels.buffer)}}}X.close(),X.delete(),o&&(T=-1),k?postMessage({action:"transcode",success:k,id:t.data.id,fileInfo:u,format:T},N):postMessage({action:"transcode",success:k,id:t.data.id})}}}!function(K){K[K.cTFETC1=0]="cTFETC1",K[K.cTFETC2=1]="cTFETC2",K[K.cTFBC1=2]="cTFBC1",K[K.cTFBC3=3]="cTFBC3",K[K.cTFBC4=4]="cTFBC4",K[K.cTFBC5=5]="cTFBC5",K[K.cTFBC7=6]="cTFBC7",K[K.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",K[K.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",K[K.cTFASTC_4x4=10]="cTFASTC_4x4",K[K.cTFATC_RGB=11]="cTFATC_RGB",K[K.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",K[K.cTFRGBA32=13]="cTFRGBA32",K[K.cTFRGB565=14]="cTFRGB565",K[K.cTFBGR565=15]="cTFBGR565",K[K.cTFRGBA4444=16]="cTFRGBA4444",K[K.cTFFXT1_RGB=17]="cTFFXT1_RGB",K[K.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",K[K.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",K[K.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",K[K.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(f||(f={}));const c={JSModuleURL:`${r.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${r.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let E=null,M=null,t=0;const j=async()=>(E||(E=new Promise(((K,O)=>{M?K(M):r.Tools.LoadFileAsync(r.Tools.GetBabylonScriptURL(c.WasmModuleURL)).then((F=>{if("function"!==typeof URL)return O("Basis transcoder requires an environment with a URL constructor");const f=URL.createObjectURL(new Blob([`(${J})()`],{type:"application/javascript"}));M=new Worker(f),async function(K,O,F){return await new Promise(((f,l)=>{const q=O=>{"init"===O.data.action?(K.removeEventListener("message",q),f(K)):"error"===O.data.action&&l(O.data.error||"error initializing worker")};K.addEventListener("message",q),K.postMessage({action:"init",url:F?r.Tools.GetBabylonScriptURL(F):void 0,wasmBinary:O},[O])}))}(M,F,c.JSModuleURL).then(K,O)})).catch(O)}))),await E),X=async(K,O)=>{const F=K instanceof ArrayBuffer?new Uint8Array(K):K;return await new Promise(((K,f)=>{j().then((()=>{const r=t++,l=O=>{"transcode"===O.data.action&&O.data.id===r&&(M.removeEventListener("message",l),O.data.success?K(O.data):f("Transcode is not supported on this device"))};M.addEventListener("message",l);const q=new Uint8Array(F.byteLength);q.set(new Uint8Array(F.buffer,F.byteOffset,F.byteLength)),M.postMessage({action:"transcode",id:r,imageData:q,config:O,ignoreSupportedFormats:false},[q.buffer])}),(K=>{f(K)}))}))},u=(K,O)=>{var F;let f=null===(F=O._gl)||void 0===F?void 0:F.TEXTURE_2D;var r;K.isCube&&(f=null===(r=O._gl)||void 0===r?void 0:r.TEXTURE_CUBE_MAP);O._bindTextureDirectly(f,K,!0)},T=(K,O)=>{const F=K.getEngine();for(let J=0;J<O.fileInfo.images.length;J++){const c=O.fileInfo.images[J].levels[0];if(K._invertVScale=K.invertY,-1===O.format||O.format===f.cTFRGB565)if(K.type=10,K.format=4,!F._features.basisNeedsPOT||Math.log2(c.width)%1===0&&Math.log2(c.height)%1===0)K._invertVScale=!K.invertY,K.width=c.width+3&-4,K.height=c.height+3&-4,K.samplingMode=2,u(K,F),F._uploadDataToTextureDirectly(K,new Uint16Array(c.transcodedPixels.buffer),J,0,4,!0);else{const O=new q.e(F,2);K._invertVScale=K.invertY,O.type=10,O.format=4,O.width=c.width+3&-4,O.height=c.height+3&-4,u(O,F),F._uploadDataToTextureDirectly(O,new Uint16Array(c.transcodedPixels.buffer),J,0,4,!0),F._rescaleTexture(O,K,F.scenes[0],F._getInternalFormat(4),(()=>{F._releaseTexture(O),u(K,F)}))}else{K.width=c.width,K.height=c.height,K.generateMipMaps=O.fileInfo.images[J].levels.length>1;const f=o.GetInternalFormatFromBasisFormat(O.format,F);K.format=f,u(K,F);const q=O.fileInfo.images[J].levels;for(let O=0;O<q.length;O++){const r=q[O];F._uploadCompressedDataToTextureDirectly(K,f,r.width,r.height,r.transcodedPixels,J,O)}!F._features.basisNeedsPOT||Math.log2(K.width)%1===0&&Math.log2(K.height)%1===0||(r.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),K._cachedWrapU=l.b.CLAMP_ADDRESSMODE,K._cachedWrapV=l.b.CLAMP_ADDRESSMODE)}}},o={JSModuleURL:c.JSModuleURL,WasmModuleURL:c.WasmModuleURL,GetInternalFormatFromBasisFormat:(K,O)=>{let F;switch(K){case f.cTFETC1:F=36196;break;case f.cTFBC1:F=33776;break;case f.cTFBC4:F=33779;break;case f.cTFASTC_4x4:F=37808;break;case f.cTFETC2:F=37496;break;case f.cTFBC7:F=36492}if(void 0===F)throw"The chosen Basis transcoder format is not currently supported";return F},TranscodeAsync:X,LoadTextureFromTranscodeResult:T};Object.defineProperty(o,"JSModuleURL",{get:function(){return c.JSModuleURL},set:function(K){c.JSModuleURL=K}}),Object.defineProperty(o,"WasmModuleURL",{get:function(){return c.WasmModuleURL},set:function(K){c.WasmModuleURL=K}});class k{constructor(){this.supportCascades=!1}loadCubeData(K,O,F,f,l){if(Array.isArray(K))return;const q=O.getEngine().getCaps(),J={supportedCompressionFormats:{etc1:!!q.etc1,s3tc:!!q.s3tc,pvrtc:!!q.pvrtc,etc2:!!q.etc2,astc:!!q.astc,bc7:!!q.bptc}};X(K,J).then((K=>{const F=K.fileInfo.images[0].levels.length>1&&O.generateMipMaps;T(O,K),O.getEngine()._setCubeMapTextureParams(O,F),O.isReady=!0,O.onLoadedObservable.notifyObservers(O),O.onLoadedObservable.clear(),f&&f()})).catch((K=>{r.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),O.isReady=!0,l&&l(K)}))}loadData(K,O,F){const f=O.getEngine().getCaps(),l={supportedCompressionFormats:{etc1:!!f.etc1,s3tc:!!f.s3tc,pvrtc:!!f.pvrtc,etc2:!!f.etc2,astc:!!f.astc,bc7:!!f.bptc}};X(K,l).then((K=>{const f=K.fileInfo.images[0].levels[0],r=K.fileInfo.images[0].levels.length>1&&O.generateMipMaps;F(f.width,f.height,r,-1!==K.format,(()=>{T(O,K)}))})).catch((K=>{r.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),r.Tools.Warn(`Failed to transcode Basis file: ${K}`),F(0,0,!1,!1,(()=>{}),!0)}))}}}}]);