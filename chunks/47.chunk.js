"use strict";(self.a14qw1h7fq=self.a14qw1h7fq||[]).push([[47],{13646:(R,J,B)=>{B.r(J),B.d(J,{_BasisTextureLoader:()=>u});var Q,h=B(11030),y=B(11161),N=B(11124);function r(){const R=0,J=1,B=2,Q=3,h=6,y=8,N=9,r=10,q=14;let e=null;function D(R,J,B,Q,h){const y=R.getImageTranscodedSizeInBytes(J,B,Q);let N=new Uint8Array(y);if(!R.transcodeImage(N,J,B,Q,1,0))return null;if(h){N=function(R,J,B,Q){const h=new Uint16Array(4),y=new Uint16Array(B*Q),N=B/4,r=Q/4;for(let q=0;q<r;q++)for(let Q=0;Q<N;Q++){const r=J+8*(q*N+Q);h[0]=R[r]|R[r+1]<<8,h[1]=R[r+2]|R[r+3]<<8,h[2]=(2*(31&h[0])+1*(31&h[1]))/3|(2*(2016&h[0])+1*(2016&h[1]))/3&2016|(2*(63488&h[0])+1*(63488&h[1]))/3&63488,h[3]=(2*(31&h[1])+1*(31&h[0]))/3|(2*(2016&h[1])+1*(2016&h[0]))/3&2016|(2*(63488&h[1])+1*(63488&h[0]))/3&63488;for(let J=0;J<4;J++){const N=R[r+4+J];let e=(4*q+J)*B+4*Q;y[e++]=h[3&N],y[e++]=h[N>>2&3],y[e++]=h[N>>4&3],y[e++]=h[N>>6&3]}}return y}(N,0,R.getImageWidth(J,B)+3&-4,R.getImageHeight(J,B)+3&-4)}return N}onmessage=l=>{if("init"===l.data.action){if(l.data.url)try{importScripts(l.data.url)}catch(E){postMessage({action:"error",error:E})}e||(e=BASIS({wasmBinary:l.data.wasmBinary})),null!==e&&e.then((R=>{BASIS=R,R.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===l.data.action){const e=l.data.config,E=l.data.imageData,O=new BASIS.BasisFile(E),n=function(R){const J=R.getHasAlpha(),B=R.getNumImages(),Q=[];for(let h=0;h<B;h++){const J={levels:[]},B=R.getNumLevels(h);for(let Q=0;Q<B;Q++){const B={width:R.getImageWidth(h,Q),height:R.getImageHeight(h,Q)};J.levels.push(B)}Q.push(J)}return{bh:J,images:Q}}(O);let P=l.data.ignoreSupportedFormats?null:function(e,D){let l=null;e.supportedCompressionFormats&&(l=e.supportedCompressionFormats.astc?r:e.supportedCompressionFormats.bc7?h:e.supportedCompressionFormats.s3tc?D.bh?Q:B:e.supportedCompressionFormats.pvrtc?D.bh?N:y:e.supportedCompressionFormats.etc2?J:e.supportedCompressionFormats.etc1?R:q);return l}(l.data.config,n),A=!1;null===P&&(A=!0,P=n.bh?Q:B);let u=!0;O.startTranscoding()||(u=!1);const S=[];for(let R=0;R<n.images.length&&u;R++){const J=n.images[R];if(void 0===e.loadSingleImage||e.loadSingleImage===R){let B=J.levels.length;!1===e.loadMipmapLevels&&(B=1);for(let Q=0;Q<B;Q++){const B=J.levels[Q],h=D(O,R,Q,P,A);if(!h){u=!1;break}B.transcodedPixels=h,S.push(B.transcodedPixels.buffer)}}}O.close(),O.delete(),A&&(P=-1),u?postMessage({action:"transcode",success:u,id:l.data.id,fileInfo:n,format:P},S):postMessage({action:"transcode",success:u,id:l.data.id})}}}!function(R){R[R.cTFETC1=0]="cTFETC1",R[R.cTFETC2=1]="cTFETC2",R[R.cTFBC1=2]="cTFBC1",R[R.cTFBC3=3]="cTFBC3",R[R.cTFBC4=4]="cTFBC4",R[R.cTFBC5=5]="cTFBC5",R[R.cTFBC7=6]="cTFBC7",R[R.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",R[R.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",R[R.cTFASTC_4x4=10]="cTFASTC_4x4",R[R.cTFATC_RGB=11]="cTFATC_RGB",R[R.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",R[R.cTFRGBA32=13]="cTFRGBA32",R[R.cTFRGB565=14]="cTFRGB565",R[R.cTFBGR565=15]="cTFBGR565",R[R.cTFRGBA4444=16]="cTFRGBA4444",R[R.cTFFXT1_RGB=17]="cTFFXT1_RGB",R[R.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",R[R.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",R[R.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",R[R.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(Q||(Q={}));const q={JSModuleURL:`${h.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${h.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let e=null,D=null,l=0;const E=async()=>(e||(e=new Promise(((R,J)=>{D?R(D):h.Tools.LoadFileAsync(h.Tools.GetBabylonScriptURL(q.WasmModuleURL)).then((B=>{if("function"!==typeof URL)return J("Basis transcoder requires an environment with a URL constructor");const Q=URL.createObjectURL(new Blob([`(${r})()`],{type:"application/javascript"}));D=new Worker(Q),async function(R,J,B){return await new Promise(((Q,y)=>{const N=J=>{"init"===J.data.action?(R.removeEventListener("message",N),Q(R)):"error"===J.data.action&&y(J.data.error||"error initializing worker")};R.addEventListener("message",N),R.postMessage({action:"init",url:B?h.Tools.GetBabylonScriptURL(B):void 0,wasmBinary:J},[J])}))}(D,B,q.JSModuleURL).then(R,J)})).catch(J)}))),await e),O=async(R,J)=>{const B=R instanceof ArrayBuffer?new Uint8Array(R):R;return await new Promise(((R,Q)=>{E().then((()=>{const h=l++,y=J=>{"transcode"===J.data.action&&J.data.id===h&&(D.removeEventListener("message",y),J.data.success?R(J.data):Q("Transcode is not supported on this device"))};D.addEventListener("message",y);const N=new Uint8Array(B.byteLength);N.set(new Uint8Array(B.buffer,B.byteOffset,B.byteLength)),D.postMessage({action:"transcode",id:h,imageData:N,config:J,ignoreSupportedFormats:false},[N.buffer])}),(R=>{Q(R)}))}))},n=(R,J)=>{var B;let Q=null===(B=J._gl)||void 0===B?void 0:B.TEXTURE_2D;var h;R.isCube&&(Q=null===(h=J._gl)||void 0===h?void 0:h.TEXTURE_CUBE_MAP);J._bindTextureDirectly(Q,R,!0)},P=(R,J)=>{const B=R.getEngine();for(let r=0;r<J.fileInfo.images.length;r++){const q=J.fileInfo.images[r].levels[0];if(R._invertVScale=R.invertY,-1===J.format||J.format===Q.cTFRGB565)if(R.type=10,R.format=4,!B._features.basisNeedsPOT||Math.log2(q.width)%1===0&&Math.log2(q.height)%1===0)R._invertVScale=!R.invertY,R.width=q.width+3&-4,R.height=q.height+3&-4,R.samplingMode=2,n(R,B),B._uploadDataToTextureDirectly(R,new Uint16Array(q.transcodedPixels.buffer),r,0,4,!0);else{const J=new N.c(B,2);R._invertVScale=R.invertY,J.type=10,J.format=4,J.width=q.width+3&-4,J.height=q.height+3&-4,n(J,B),B._uploadDataToTextureDirectly(J,new Uint16Array(q.transcodedPixels.buffer),r,0,4,!0),B._rescaleTexture(J,R,B.scenes[0],B._getInternalFormat(4),(()=>{B._releaseTexture(J),n(R,B)}))}else{R.width=q.width,R.height=q.height,R.generateMipMaps=J.fileInfo.images[r].levels.length>1;const Q=A.GetInternalFormatFromBasisFormat(J.format,B);R.format=Q,n(R,B);const N=J.fileInfo.images[r].levels;for(let J=0;J<N.length;J++){const h=N[J];B._uploadCompressedDataToTextureDirectly(R,Q,h.width,h.height,h.transcodedPixels,r,J)}!B._features.basisNeedsPOT||Math.log2(R.width)%1===0&&Math.log2(R.height)%1===0||(h.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),R._cachedWrapU=y.d.CLAMP_ADDRESSMODE,R._cachedWrapV=y.d.CLAMP_ADDRESSMODE)}}},A={JSModuleURL:q.JSModuleURL,WasmModuleURL:q.WasmModuleURL,GetInternalFormatFromBasisFormat:(R,J)=>{let B;switch(R){case Q.cTFETC1:B=36196;break;case Q.cTFBC1:B=33776;break;case Q.cTFBC4:B=33779;break;case Q.cTFASTC_4x4:B=37808;break;case Q.cTFETC2:B=37496;break;case Q.cTFBC7:B=36492}if(void 0===B)throw"The chosen Basis transcoder format is not currently supported";return B},TranscodeAsync:O,LoadTextureFromTranscodeResult:P};Object.defineProperty(A,"JSModuleURL",{get:function(){return q.JSModuleURL},set:function(R){q.JSModuleURL=R}}),Object.defineProperty(A,"WasmModuleURL",{get:function(){return q.WasmModuleURL},set:function(R){q.WasmModuleURL=R}});class u{constructor(){this.supportCascades=!1}loadCubeData(R,J,B,Q,y){if(Array.isArray(R))return;const N=J.getEngine().getCaps(),r={supportedCompressionFormats:{etc1:!!N.etc1,s3tc:!!N.s3tc,pvrtc:!!N.pvrtc,etc2:!!N.etc2,astc:!!N.astc,bc7:!!N.bptc}};O(R,r).then((R=>{const B=R.fileInfo.images[0].levels.length>1&&J.generateMipMaps;P(J,R),J.getEngine()._setCubeMapTextureParams(J,B),J.isReady=!0,J.onLoadedObservable.notifyObservers(J),J.onLoadedObservable.clear(),Q&&Q()})).catch((R=>{h.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),J.isReady=!0,y&&y(R)}))}loadData(R,J,B){const Q=J.getEngine().getCaps(),y={supportedCompressionFormats:{etc1:!!Q.etc1,s3tc:!!Q.s3tc,pvrtc:!!Q.pvrtc,etc2:!!Q.etc2,astc:!!Q.astc,bc7:!!Q.bptc}};O(R,y).then((R=>{const Q=R.fileInfo.images[0].levels[0],h=R.fileInfo.images[0].levels.length>1&&J.generateMipMaps;B(Q.width,Q.height,h,-1!==R.format,(()=>{P(J,R)}))})).catch((R=>{h.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),h.Tools.Warn(`Failed to transcode Basis file: ${R}`),B(0,0,!1,!1,(()=>{}),!0)}))}}}}]);