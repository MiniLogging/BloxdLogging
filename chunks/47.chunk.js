"use strict";(self.v2pspxy442l=self.v2pspxy442l||[]).push([[47],{14886:(l,a,N)=>{N.r(a),N.d(a,{_BasisTextureLoader:()=>Y});var U,c=N(12254),K=N(12422),Z=N(12373);function w(){const l=0,a=1,N=2,U=3,c=6,K=8,Z=9,w=10,S=14;let T=null;function J(l,a,N,U,c){const K=l.getImageTranscodedSizeInBytes(a,N,U);let Z=new Uint8Array(K);if(!l.transcodeImage(Z,a,N,U,1,0))return null;if(c){Z=function(l,a,N,U){const c=new Uint16Array(4),K=new Uint16Array(N*U),Z=N/4,w=U/4;for(let S=0;S<w;S++)for(let U=0;U<Z;U++){const w=a+8*(S*Z+U);c[0]=l[w]|l[w+1]<<8,c[1]=l[w+2]|l[w+3]<<8,c[2]=(2*(31&c[0])+1*(31&c[1]))/3|(2*(2016&c[0])+1*(2016&c[1]))/3&2016|(2*(63488&c[0])+1*(63488&c[1]))/3&63488,c[3]=(2*(31&c[1])+1*(31&c[0]))/3|(2*(2016&c[1])+1*(2016&c[0]))/3&2016|(2*(63488&c[1])+1*(63488&c[0]))/3&63488;for(let a=0;a<4;a++){const Z=l[w+4+a];let T=(4*S+a)*N+4*U;K[T++]=c[3&Z],K[T++]=c[Z>>2&3],K[T++]=c[Z>>4&3],K[T++]=c[Z>>6&3]}}return K}(Z,0,l.getImageWidth(a,N)+3&-4,l.getImageHeight(a,N)+3&-4)}return Z}onmessage=n=>{if("init"===n.data.action){if(n.data.url)try{importScripts(n.data.url)}catch(y){postMessage({action:"error",error:y})}T||(T=BASIS({wasmBinary:n.data.wasmBinary})),null!==T&&T.then((l=>{BASIS=l,l.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===n.data.action){const T=n.data.config,y=n.data.imageData,H=new BASIS.BasisFile(y),u=function(l){const a=l.getHasAlpha(),N=l.getNumImages(),U=[];for(let c=0;c<N;c++){const a={levels:[]},N=l.getNumLevels(c);for(let U=0;U<N;U++){const N={width:l.getImageWidth(c,U),height:l.getImageHeight(c,U)};a.levels.push(N)}U.push(a)}return{Mc:a,images:U}}(H);let W=n.data.ignoreSupportedFormats?null:function(T,J){let n=null;T.supportedCompressionFormats&&(n=T.supportedCompressionFormats.astc?w:T.supportedCompressionFormats.bc7?c:T.supportedCompressionFormats.s3tc?J.Mc?U:N:T.supportedCompressionFormats.pvrtc?J.Mc?Z:K:T.supportedCompressionFormats.etc2?a:T.supportedCompressionFormats.etc1?l:S);return n}(n.data.config,u),B=!1;null===W&&(B=!0,W=u.Mc?U:N);let Y=!0;H.startTranscoding()||(Y=!1);const C=[];for(let l=0;l<u.images.length&&Y;l++){const a=u.images[l];if(void 0===T.loadSingleImage||T.loadSingleImage===l){let N=a.levels.length;!1===T.loadMipmapLevels&&(N=1);for(let U=0;U<N;U++){const N=a.levels[U],c=J(H,l,U,W,B);if(!c){Y=!1;break}N.transcodedPixels=c,C.push(N.transcodedPixels.buffer)}}}H.close(),H.delete(),B&&(W=-1),Y?postMessage({action:"transcode",success:Y,id:n.data.id,fileInfo:u,format:W},C):postMessage({action:"transcode",success:Y,id:n.data.id})}}}!function(l){l[l.cTFETC1=0]="cTFETC1",l[l.cTFETC2=1]="cTFETC2",l[l.cTFBC1=2]="cTFBC1",l[l.cTFBC3=3]="cTFBC3",l[l.cTFBC4=4]="cTFBC4",l[l.cTFBC5=5]="cTFBC5",l[l.cTFBC7=6]="cTFBC7",l[l.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",l[l.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",l[l.cTFASTC_4x4=10]="cTFASTC_4x4",l[l.cTFATC_RGB=11]="cTFATC_RGB",l[l.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",l[l.cTFRGBA32=13]="cTFRGBA32",l[l.cTFRGB565=14]="cTFRGB565",l[l.cTFBGR565=15]="cTFBGR565",l[l.cTFRGBA4444=16]="cTFRGBA4444",l[l.cTFFXT1_RGB=17]="cTFFXT1_RGB",l[l.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",l[l.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",l[l.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",l[l.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(U||(U={}));const S={JSModuleURL:`${c.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${c.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let T=null,J=null,n=0;const y=async()=>(T||(T=new Promise(((l,a)=>{J?l(J):c.Tools.LoadFileAsync(c.Tools.GetBabylonScriptURL(S.WasmModuleURL)).then((N=>{if("function"!==typeof URL)return a("Basis transcoder requires an environment with a URL constructor");const U=URL.createObjectURL(new Blob([`(${w})()`],{type:"application/javascript"}));J=new Worker(U),async function(l,a,N){return await new Promise(((U,K)=>{const Z=a=>{"init"===a.data.action?(l.removeEventListener("message",Z),U(l)):"error"===a.data.action&&K(a.data.error||"error initializing worker")};l.addEventListener("message",Z),l.postMessage({action:"init",url:N?c.Tools.GetBabylonScriptURL(N):void 0,wasmBinary:a},[a])}))}(J,N,S.JSModuleURL).then(l,a)})).catch(a)}))),await T),H=async(l,a)=>{const N=l instanceof ArrayBuffer?new Uint8Array(l):l;return await new Promise(((l,U)=>{y().then((()=>{const c=n++,K=a=>{"transcode"===a.data.action&&a.data.id===c&&(J.removeEventListener("message",K),a.data.success?l(a.data):U("Transcode is not supported on this device"))};J.addEventListener("message",K);const Z=new Uint8Array(N.byteLength);Z.set(new Uint8Array(N.buffer,N.byteOffset,N.byteLength)),J.postMessage({action:"transcode",id:c,imageData:Z,config:a,ignoreSupportedFormats:false},[Z.buffer])}),(l=>{U(l)}))}))},u=(l,a)=>{var N;let U=null===(N=a._gl)||void 0===N?void 0:N.TEXTURE_2D;var c;l.isCube&&(U=null===(c=a._gl)||void 0===c?void 0:c.TEXTURE_CUBE_MAP);a._bindTextureDirectly(U,l,!0)},W=(l,a)=>{const N=l.getEngine();for(let w=0;w<a.fileInfo.images.length;w++){const S=a.fileInfo.images[w].levels[0];if(l._invertVScale=l.invertY,-1===a.format||a.format===U.cTFRGB565)if(l.type=10,l.format=4,!N._features.basisNeedsPOT||Math.log2(S.width)%1===0&&Math.log2(S.height)%1===0)l._invertVScale=!l.invertY,l.width=S.width+3&-4,l.height=S.height+3&-4,l.samplingMode=2,u(l,N),N._uploadDataToTextureDirectly(l,new Uint16Array(S.transcodedPixels.buffer),w,0,4,!0);else{const a=new Z.c(N,2);l._invertVScale=l.invertY,a.type=10,a.format=4,a.width=S.width+3&-4,a.height=S.height+3&-4,u(a,N),N._uploadDataToTextureDirectly(a,new Uint16Array(S.transcodedPixels.buffer),w,0,4,!0),N._rescaleTexture(a,l,N.scenes[0],N._getInternalFormat(4),(()=>{N._releaseTexture(a),u(l,N)}))}else{l.width=S.width,l.height=S.height,l.generateMipMaps=a.fileInfo.images[w].levels.length>1;const U=B.GetInternalFormatFromBasisFormat(a.format,N);l.format=U,u(l,N);const Z=a.fileInfo.images[w].levels;for(let a=0;a<Z.length;a++){const c=Z[a];N._uploadCompressedDataToTextureDirectly(l,U,c.width,c.height,c.transcodedPixels,w,a)}!N._features.basisNeedsPOT||Math.log2(l.width)%1===0&&Math.log2(l.height)%1===0||(c.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),l._cachedWrapU=K.e.CLAMP_ADDRESSMODE,l._cachedWrapV=K.e.CLAMP_ADDRESSMODE)}}},B={JSModuleURL:S.JSModuleURL,WasmModuleURL:S.WasmModuleURL,GetInternalFormatFromBasisFormat:(l,a)=>{let N;switch(l){case U.cTFETC1:N=36196;break;case U.cTFBC1:N=33776;break;case U.cTFBC4:N=33779;break;case U.cTFASTC_4x4:N=37808;break;case U.cTFETC2:N=37496;break;case U.cTFBC7:N=36492}if(void 0===N)throw"The chosen Basis transcoder format is not currently supported";return N},TranscodeAsync:H,LoadTextureFromTranscodeResult:W};Object.defineProperty(B,"JSModuleURL",{get:function(){return S.JSModuleURL},set:function(l){S.JSModuleURL=l}}),Object.defineProperty(B,"WasmModuleURL",{get:function(){return S.WasmModuleURL},set:function(l){S.WasmModuleURL=l}});class Y{constructor(){this.supportCascades=!1}loadCubeData(l,a,N,U,K){if(Array.isArray(l))return;const Z=a.getEngine().getCaps(),w={supportedCompressionFormats:{etc1:!!Z.etc1,s3tc:!!Z.s3tc,pvrtc:!!Z.pvrtc,etc2:!!Z.etc2,astc:!!Z.astc,bc7:!!Z.bptc}};H(l,w).then((l=>{const N=l.fileInfo.images[0].levels.length>1&&a.generateMipMaps;W(a,l),a.getEngine()._setCubeMapTextureParams(a,N),a.isReady=!0,a.onLoadedObservable.notifyObservers(a),a.onLoadedObservable.clear(),U&&U()})).catch((l=>{c.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),a.isReady=!0,K&&K(l)}))}loadData(l,a,N){const U=a.getEngine().getCaps(),K={supportedCompressionFormats:{etc1:!!U.etc1,s3tc:!!U.s3tc,pvrtc:!!U.pvrtc,etc2:!!U.etc2,astc:!!U.astc,bc7:!!U.bptc}};H(l,K).then((l=>{const U=l.fileInfo.images[0].levels[0],c=l.fileInfo.images[0].levels.length>1&&a.generateMipMaps;N(U.width,U.height,c,-1!==l.format,(()=>{W(a,l)}))})).catch((l=>{c.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),c.Tools.Warn(`Failed to transcode Basis file: ${l}`),N(0,0,!1,!1,(()=>{}),!0)}))}}}}]);