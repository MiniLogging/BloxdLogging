"use strict";(self["80dd64vgxnn"]=self["80dd64vgxnn"]||[]).push([[47],{15068:(mm,o,u)=>{u.r(o),u.d(o,{_BasisTextureLoader:()=>l});var f,B=u(12549),O=u(12727),r=u(12675);function w(){const mm=0,o=1,u=2,f=3,B=6,O=8,r=9,w=10,p=14;let K=null;function z(mm,o,u,f,B){const O=mm.getImageTranscodedSizeInBytes(o,u,f);let r=new Uint8Array(O);if(!mm.transcodeImage(r,o,u,f,1,0))return null;if(B){r=function(mm,o,u,f){const B=new Uint16Array(4),O=new Uint16Array(u*f),r=u/4,w=f/4;for(let p=0;p<w;p++)for(let f=0;f<r;f++){const w=o+8*(p*r+f);B[0]=mm[w]|mm[w+1]<<8,B[1]=mm[w+2]|mm[w+3]<<8,B[2]=(2*(31&B[0])+1*(31&B[1]))/3|(2*(2016&B[0])+1*(2016&B[1]))/3&2016|(2*(63488&B[0])+1*(63488&B[1]))/3&63488,B[3]=(2*(31&B[1])+1*(31&B[0]))/3|(2*(2016&B[1])+1*(2016&B[0]))/3&2016|(2*(63488&B[1])+1*(63488&B[0]))/3&63488;for(let o=0;o<4;o++){const r=mm[w+4+o];let K=(4*p+o)*u+4*f;O[K++]=B[3&r],O[K++]=B[r>>2&3],O[K++]=B[r>>4&3],O[K++]=B[r>>6&3]}}return O}(r,0,mm.getImageWidth(o,u)+3&-4,mm.getImageHeight(o,u)+3&-4)}return r}onmessage=Y=>{if("init"===Y.data.action){if(Y.data.url)try{importScripts(Y.data.url)}catch(q){postMessage({action:"error",error:q})}K||(K=BASIS({wasmBinary:Y.data.wasmBinary})),null!==K&&K.then((mm=>{BASIS=mm,mm.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===Y.data.action){const K=Y.data.config,q=Y.data.imageData,x=new BASIS.BasisFile(q),H=function(mm){const o=mm.getHasAlpha(),u=mm.getNumImages(),f=[];for(let B=0;B<u;B++){const o={levels:[]},u=mm.getNumLevels(B);for(let f=0;f<u;f++){const u={width:mm.getImageWidth(B,f),height:mm.getImageHeight(B,f)};o.levels.push(u)}f.push(o)}return{Uf:o,images:f}}(x);let E=Y.data.ignoreSupportedFormats?null:function(K,z){let Y=null;K.supportedCompressionFormats&&(Y=K.supportedCompressionFormats.astc?w:K.supportedCompressionFormats.bc7?B:K.supportedCompressionFormats.s3tc?z.Uf?f:u:K.supportedCompressionFormats.pvrtc?z.Uf?r:O:K.supportedCompressionFormats.etc2?o:K.supportedCompressionFormats.etc1?mm:p);return Y}(Y.data.config,H),M=!1;null===E&&(M=!0,E=H.Uf?f:u);let l=!0;x.startTranscoding()||(l=!1);const t=[];for(let mm=0;mm<H.images.length&&l;mm++){const o=H.images[mm];if(void 0===K.loadSingleImage||K.loadSingleImage===mm){let u=o.levels.length;!1===K.loadMipmapLevels&&(u=1);for(let f=0;f<u;f++){const u=o.levels[f],B=z(x,mm,f,E,M);if(!B){l=!1;break}u.transcodedPixels=B,t.push(u.transcodedPixels.buffer)}}}x.close(),x.delete(),M&&(E=-1),l?postMessage({action:"transcode",success:l,id:Y.data.id,fileInfo:H,format:E},t):postMessage({action:"transcode",success:l,id:Y.data.id})}}}!function(mm){mm[mm.cTFETC1=0]="cTFETC1",mm[mm.cTFETC2=1]="cTFETC2",mm[mm.cTFBC1=2]="cTFBC1",mm[mm.cTFBC3=3]="cTFBC3",mm[mm.cTFBC4=4]="cTFBC4",mm[mm.cTFBC5=5]="cTFBC5",mm[mm.cTFBC7=6]="cTFBC7",mm[mm.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",mm[mm.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",mm[mm.cTFASTC_4x4=10]="cTFASTC_4x4",mm[mm.cTFATC_RGB=11]="cTFATC_RGB",mm[mm.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",mm[mm.cTFRGBA32=13]="cTFRGBA32",mm[mm.cTFRGB565=14]="cTFRGB565",mm[mm.cTFBGR565=15]="cTFBGR565",mm[mm.cTFRGBA4444=16]="cTFRGBA4444",mm[mm.cTFFXT1_RGB=17]="cTFFXT1_RGB",mm[mm.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",mm[mm.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",mm[mm.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",mm[mm.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(f||(f={}));const p={JSModuleURL:`${B.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${B.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let K=null,z=null,Y=0;const q=async()=>(K||(K=new Promise(((mm,o)=>{z?mm(z):B.Tools.LoadFileAsync(B.Tools.GetBabylonScriptURL(p.WasmModuleURL)).then((u=>{if("function"!==typeof URL)return o("Basis transcoder requires an environment with a URL constructor");const f=URL.createObjectURL(new Blob([`(${w})()`],{type:"application/javascript"}));z=new Worker(f),async function(mm,o,u){return await new Promise(((f,O)=>{const r=o=>{"init"===o.data.action?(mm.removeEventListener("message",r),f(mm)):"error"===o.data.action&&O(o.data.error||"error initializing worker")};mm.addEventListener("message",r),mm.postMessage({action:"init",url:u?B.Tools.GetBabylonScriptURL(u):void 0,wasmBinary:o},[o])}))}(z,u,p.JSModuleURL).then(mm,o)})).catch(o)}))),await K),x=async(mm,o)=>{const u=mm instanceof ArrayBuffer?new Uint8Array(mm):mm;return await new Promise(((mm,f)=>{q().then((()=>{const B=Y++,O=o=>{"transcode"===o.data.action&&o.data.id===B&&(z.removeEventListener("message",O),o.data.success?mm(o.data):f("Transcode is not supported on this device"))};z.addEventListener("message",O);const r=new Uint8Array(u.byteLength);r.set(new Uint8Array(u.buffer,u.byteOffset,u.byteLength)),z.postMessage({action:"transcode",id:B,imageData:r,config:o,ignoreSupportedFormats:false},[r.buffer])}),(mm=>{f(mm)}))}))},H=(mm,o)=>{var u;let f=null===(u=o._gl)||void 0===u?void 0:u.TEXTURE_2D;var B;mm.isCube&&(f=null===(B=o._gl)||void 0===B?void 0:B.TEXTURE_CUBE_MAP);o._bindTextureDirectly(f,mm,!0)},E=(mm,o)=>{const u=mm.getEngine();for(let w=0;w<o.fileInfo.images.length;w++){const p=o.fileInfo.images[w].levels[0];if(mm._invertVScale=mm.invertY,-1===o.format||o.format===f.cTFRGB565)if(mm.type=10,mm.format=4,!u._features.basisNeedsPOT||Math.log2(p.width)%1===0&&Math.log2(p.height)%1===0)mm._invertVScale=!mm.invertY,mm.width=p.width+3&-4,mm.height=p.height+3&-4,mm.samplingMode=2,H(mm,u),u._uploadDataToTextureDirectly(mm,new Uint16Array(p.transcodedPixels.buffer),w,0,4,!0);else{const o=new r.e(u,2);mm._invertVScale=mm.invertY,o.type=10,o.format=4,o.width=p.width+3&-4,o.height=p.height+3&-4,H(o,u),u._uploadDataToTextureDirectly(o,new Uint16Array(p.transcodedPixels.buffer),w,0,4,!0),u._rescaleTexture(o,mm,u.scenes[0],u._getInternalFormat(4),(()=>{u._releaseTexture(o),H(mm,u)}))}else{mm.width=p.width,mm.height=p.height,mm.generateMipMaps=o.fileInfo.images[w].levels.length>1;const f=M.GetInternalFormatFromBasisFormat(o.format,u);mm.format=f,H(mm,u);const r=o.fileInfo.images[w].levels;for(let o=0;o<r.length;o++){const B=r[o];u._uploadCompressedDataToTextureDirectly(mm,f,B.width,B.height,B.transcodedPixels,w,o)}!u._features.basisNeedsPOT||Math.log2(mm.width)%1===0&&Math.log2(mm.height)%1===0||(B.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),mm._cachedWrapU=O.b.CLAMP_ADDRESSMODE,mm._cachedWrapV=O.b.CLAMP_ADDRESSMODE)}}},M={JSModuleURL:p.JSModuleURL,WasmModuleURL:p.WasmModuleURL,GetInternalFormatFromBasisFormat:(mm,o)=>{let u;switch(mm){case f.cTFETC1:u=36196;break;case f.cTFBC1:u=33776;break;case f.cTFBC4:u=33779;break;case f.cTFASTC_4x4:u=37808;break;case f.cTFETC2:u=37496;break;case f.cTFBC7:u=36492}if(void 0===u)throw"The chosen Basis transcoder format is not currently supported";return u},TranscodeAsync:x,LoadTextureFromTranscodeResult:E};Object.defineProperty(M,"JSModuleURL",{get:function(){return p.JSModuleURL},set:function(mm){p.JSModuleURL=mm}}),Object.defineProperty(M,"WasmModuleURL",{get:function(){return p.WasmModuleURL},set:function(mm){p.WasmModuleURL=mm}});class l{constructor(){this.supportCascades=!1}loadCubeData(mm,o,u,f,O){if(Array.isArray(mm))return;const r=o.getEngine().getCaps(),w={supportedCompressionFormats:{etc1:!!r.etc1,s3tc:!!r.s3tc,pvrtc:!!r.pvrtc,etc2:!!r.etc2,astc:!!r.astc,bc7:!!r.bptc}};x(mm,w).then((mm=>{const u=mm.fileInfo.images[0].levels.length>1&&o.generateMipMaps;E(o,mm),o.getEngine()._setCubeMapTextureParams(o,u),o.isReady=!0,o.onLoadedObservable.notifyObservers(o),o.onLoadedObservable.clear(),f&&f()})).catch((mm=>{B.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),o.isReady=!0,O&&O(mm)}))}loadData(mm,o,u){const f=o.getEngine().getCaps(),O={supportedCompressionFormats:{etc1:!!f.etc1,s3tc:!!f.s3tc,pvrtc:!!f.pvrtc,etc2:!!f.etc2,astc:!!f.astc,bc7:!!f.bptc}};x(mm,O).then((mm=>{const f=mm.fileInfo.images[0].levels[0],B=mm.fileInfo.images[0].levels.length>1&&o.generateMipMaps;u(f.width,f.height,B,-1!==mm.format,(()=>{E(o,mm)}))})).catch((mm=>{B.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),B.Tools.Warn(`Failed to transcode Basis file: ${mm}`),u(0,0,!1,!1,(()=>{}),!0)}))}}}}]);