"use strict";(self.n52dyox90qa=self.n52dyox90qa||[]).push([[47],{14205:(E,t,z)=>{z.r(t),z.d(t,{_BasisTextureLoader:()=>L});var A,X=z(11630),R=z(11790),u=z(11751);function p(){const E=0,t=1,z=2,A=3,X=6,R=8,u=9,p=10,C=14;let Z=null;function H(E,t,z,A,X){const R=E.getImageTranscodedSizeInBytes(t,z,A);let u=new Uint8Array(R);if(!E.transcodeImage(u,t,z,A,1,0))return null;if(X){u=function(E,t,z,A){const X=new Uint16Array(4),R=new Uint16Array(z*A),u=z/4,p=A/4;for(let C=0;C<p;C++)for(let A=0;A<u;A++){const p=t+8*(C*u+A);X[0]=E[p]|E[p+1]<<8,X[1]=E[p+2]|E[p+3]<<8,X[2]=(2*(31&X[0])+1*(31&X[1]))/3|(2*(2016&X[0])+1*(2016&X[1]))/3&2016|(2*(63488&X[0])+1*(63488&X[1]))/3&63488,X[3]=(2*(31&X[1])+1*(31&X[0]))/3|(2*(2016&X[1])+1*(2016&X[0]))/3&2016|(2*(63488&X[1])+1*(63488&X[0]))/3&63488;for(let t=0;t<4;t++){const u=E[p+4+t];let Z=(4*C+t)*z+4*A;R[Z++]=X[3&u],R[Z++]=X[u>>2&3],R[Z++]=X[u>>4&3],R[Z++]=X[u>>6&3]}}return R}(u,0,E.getImageWidth(t,z)+3&-4,E.getImageHeight(t,z)+3&-4)}return u}onmessage=h=>{if("init"===h.data.action){if(h.data.url)try{importScripts(h.data.url)}catch(d){postMessage({action:"error",error:d})}Z||(Z=BASIS({wasmBinary:h.data.wasmBinary})),null!==Z&&Z.then((E=>{BASIS=E,E.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===h.data.action){const Z=h.data.config,d=h.data.imageData,y=new BASIS.BasisFile(d),O=function(E){const t=E.getHasAlpha(),z=E.getNumImages(),A=[];for(let X=0;X<z;X++){const t={levels:[]},z=E.getNumLevels(X);for(let A=0;A<z;A++){const z={width:E.getImageWidth(X,A),height:E.getImageHeight(X,A)};t.levels.push(z)}A.push(t)}return{pp:t,images:A}}(y);let c=h.data.ignoreSupportedFormats?null:function(Z,H){let h=null;Z.supportedCompressionFormats&&(h=Z.supportedCompressionFormats.astc?p:Z.supportedCompressionFormats.bc7?X:Z.supportedCompressionFormats.s3tc?H.pp?A:z:Z.supportedCompressionFormats.pvrtc?H.pp?u:R:Z.supportedCompressionFormats.etc2?t:Z.supportedCompressionFormats.etc1?E:C);return h}(h.data.config,O),a=!1;null===c&&(a=!0,c=O.pp?A:z);let L=!0;y.startTranscoding()||(L=!1);const mE=[];for(let E=0;E<O.images.length&&L;E++){const t=O.images[E];if(void 0===Z.loadSingleImage||Z.loadSingleImage===E){let z=t.levels.length;!1===Z.loadMipmapLevels&&(z=1);for(let A=0;A<z;A++){const z=t.levels[A],X=H(y,E,A,c,a);if(!X){L=!1;break}z.transcodedPixels=X,mE.push(z.transcodedPixels.buffer)}}}y.close(),y.delete(),a&&(c=-1),L?postMessage({action:"transcode",success:L,id:h.data.id,fileInfo:O,format:c},mE):postMessage({action:"transcode",success:L,id:h.data.id})}}}!function(E){E[E.cTFETC1=0]="cTFETC1",E[E.cTFETC2=1]="cTFETC2",E[E.cTFBC1=2]="cTFBC1",E[E.cTFBC3=3]="cTFBC3",E[E.cTFBC4=4]="cTFBC4",E[E.cTFBC5=5]="cTFBC5",E[E.cTFBC7=6]="cTFBC7",E[E.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",E[E.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",E[E.cTFASTC_4x4=10]="cTFASTC_4x4",E[E.cTFATC_RGB=11]="cTFATC_RGB",E[E.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",E[E.cTFRGBA32=13]="cTFRGBA32",E[E.cTFRGB565=14]="cTFRGB565",E[E.cTFBGR565=15]="cTFBGR565",E[E.cTFRGBA4444=16]="cTFRGBA4444",E[E.cTFFXT1_RGB=17]="cTFFXT1_RGB",E[E.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",E[E.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",E[E.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",E[E.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(A||(A={}));const C={JSModuleURL:`${X.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${X.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let Z=null,H=null,h=0;const d=async()=>(Z||(Z=new Promise(((E,t)=>{H?E(H):X.Tools.LoadFileAsync(X.Tools.GetBabylonScriptURL(C.WasmModuleURL)).then((z=>{if("function"!==typeof URL)return t("Basis transcoder requires an environment with a URL constructor");const A=URL.createObjectURL(new Blob([`(${p})()`],{type:"application/javascript"}));H=new Worker(A),async function(E,t,z){return await new Promise(((A,R)=>{const u=t=>{"init"===t.data.action?(E.removeEventListener("message",u),A(E)):"error"===t.data.action&&R(t.data.error||"error initializing worker")};E.addEventListener("message",u),E.postMessage({action:"init",url:z?X.Tools.GetBabylonScriptURL(z):void 0,wasmBinary:t},[t])}))}(H,z,C.JSModuleURL).then(E,t)})).catch(t)}))),await Z),y=async(E,t)=>{const z=E instanceof ArrayBuffer?new Uint8Array(E):E;return await new Promise(((E,A)=>{d().then((()=>{const X=h++,R=t=>{"transcode"===t.data.action&&t.data.id===X&&(H.removeEventListener("message",R),t.data.success?E(t.data):A("Transcode is not supported on this device"))};H.addEventListener("message",R);const u=new Uint8Array(z.byteLength);u.set(new Uint8Array(z.buffer,z.byteOffset,z.byteLength)),H.postMessage({action:"transcode",id:X,imageData:u,config:t,ignoreSupportedFormats:false},[u.buffer])}),(E=>{A(E)}))}))},O=(E,t)=>{var z;let A=null===(z=t._gl)||void 0===z?void 0:z.TEXTURE_2D;var X;E.isCube&&(A=null===(X=t._gl)||void 0===X?void 0:X.TEXTURE_CUBE_MAP);t._bindTextureDirectly(A,E,!0)},c=(E,t)=>{const z=E.getEngine();for(let p=0;p<t.fileInfo.images.length;p++){const C=t.fileInfo.images[p].levels[0];if(E._invertVScale=E.invertY,-1===t.format||t.format===A.cTFRGB565)if(E.type=10,E.format=4,!z._features.basisNeedsPOT||Math.log2(C.width)%1===0&&Math.log2(C.height)%1===0)E._invertVScale=!E.invertY,E.width=C.width+3&-4,E.height=C.height+3&-4,E.samplingMode=2,O(E,z),z._uploadDataToTextureDirectly(E,new Uint16Array(C.transcodedPixels.buffer),p,0,4,!0);else{const t=new u.e(z,2);E._invertVScale=E.invertY,t.type=10,t.format=4,t.width=C.width+3&-4,t.height=C.height+3&-4,O(t,z),z._uploadDataToTextureDirectly(t,new Uint16Array(C.transcodedPixels.buffer),p,0,4,!0),z._rescaleTexture(t,E,z.scenes[0],z._getInternalFormat(4),(()=>{z._releaseTexture(t),O(E,z)}))}else{E.width=C.width,E.height=C.height,E.generateMipMaps=t.fileInfo.images[p].levels.length>1;const A=a.GetInternalFormatFromBasisFormat(t.format,z);E.format=A,O(E,z);const u=t.fileInfo.images[p].levels;for(let t=0;t<u.length;t++){const X=u[t];z._uploadCompressedDataToTextureDirectly(E,A,X.width,X.height,X.transcodedPixels,p,t)}!z._features.basisNeedsPOT||Math.log2(E.width)%1===0&&Math.log2(E.height)%1===0||(X.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),E._cachedWrapU=R.d.CLAMP_ADDRESSMODE,E._cachedWrapV=R.d.CLAMP_ADDRESSMODE)}}},a={JSModuleURL:C.JSModuleURL,WasmModuleURL:C.WasmModuleURL,GetInternalFormatFromBasisFormat:(E,t)=>{let z;switch(E){case A.cTFETC1:z=36196;break;case A.cTFBC1:z=33776;break;case A.cTFBC4:z=33779;break;case A.cTFASTC_4x4:z=37808;break;case A.cTFETC2:z=37496;break;case A.cTFBC7:z=36492}if(void 0===z)throw"The chosen Basis transcoder format is not currently supported";return z},TranscodeAsync:y,LoadTextureFromTranscodeResult:c};Object.defineProperty(a,"JSModuleURL",{get:function(){return C.JSModuleURL},set:function(E){C.JSModuleURL=E}}),Object.defineProperty(a,"WasmModuleURL",{get:function(){return C.WasmModuleURL},set:function(E){C.WasmModuleURL=E}});class L{constructor(){this.supportCascades=!1}loadCubeData(E,t,z,A,R){if(Array.isArray(E))return;const u=t.getEngine().getCaps(),p={supportedCompressionFormats:{etc1:!!u.etc1,s3tc:!!u.s3tc,pvrtc:!!u.pvrtc,etc2:!!u.etc2,astc:!!u.astc,bc7:!!u.bptc}};y(E,p).then((E=>{const z=E.fileInfo.images[0].levels.length>1&&t.generateMipMaps;c(t,E),t.getEngine()._setCubeMapTextureParams(t,z),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),A&&A()})).catch((E=>{X.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),t.isReady=!0,R&&R(E)}))}loadData(E,t,z){const A=t.getEngine().getCaps(),R={supportedCompressionFormats:{etc1:!!A.etc1,s3tc:!!A.s3tc,pvrtc:!!A.pvrtc,etc2:!!A.etc2,astc:!!A.astc,bc7:!!A.bptc}};y(E,R).then((E=>{const A=E.fileInfo.images[0].levels[0],X=E.fileInfo.images[0].levels.length>1&&t.generateMipMaps;z(A.width,A.height,X,-1!==E.format,(()=>{c(t,E)}))})).catch((E=>{X.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),X.Tools.Warn(`Failed to transcode Basis file: ${E}`),z(0,0,!1,!1,(()=>{}),!0)}))}}}}]);