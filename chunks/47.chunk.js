"use strict";(self.agop5zpabxv=self.agop5zpabxv||[]).push([[47],{14744:(H,u,J)=>{J.r(u),J.d(u,{_BasisTextureLoader:()=>a});var O,U=J(12171),h=J(12321),w=J(12280);function g(){const H=0,u=1,J=2,O=3,U=6,h=8,w=9,g=10,B=14;let b=null;function d(H,u,J,O,U){const h=H.getImageTranscodedSizeInBytes(u,J,O);let w=new Uint8Array(h);if(!H.transcodeImage(w,u,J,O,1,0))return null;if(U){w=function(H,u,J,O){const U=new Uint16Array(4),h=new Uint16Array(J*O),w=J/4,g=O/4;for(let B=0;B<g;B++)for(let O=0;O<w;O++){const g=u+8*(B*w+O);U[0]=H[g]|H[g+1]<<8,U[1]=H[g+2]|H[g+3]<<8,U[2]=(2*(31&U[0])+1*(31&U[1]))/3|(2*(2016&U[0])+1*(2016&U[1]))/3&2016|(2*(63488&U[0])+1*(63488&U[1]))/3&63488,U[3]=(2*(31&U[1])+1*(31&U[0]))/3|(2*(2016&U[1])+1*(2016&U[0]))/3&2016|(2*(63488&U[1])+1*(63488&U[0]))/3&63488;for(let u=0;u<4;u++){const w=H[g+4+u];let b=(4*B+u)*J+4*O;h[b++]=U[3&w],h[b++]=U[w>>2&3],h[b++]=U[w>>4&3],h[b++]=U[w>>6&3]}}return h}(w,0,H.getImageWidth(u,J)+3&-4,H.getImageHeight(u,J)+3&-4)}return w}onmessage=G=>{if("init"===G.data.action){if(G.data.url)try{importScripts(G.data.url)}catch(P){postMessage({action:"error",error:P})}b||(b=BASIS({wasmBinary:G.data.wasmBinary})),null!==b&&b.then((H=>{BASIS=H,H.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===G.data.action){const b=G.data.config,P=G.data.imageData,mH=new BASIS.BasisFile(P),l=function(H){const u=H.getHasAlpha(),J=H.getNumImages(),O=[];for(let U=0;U<J;U++){const u={levels:[]},J=H.getNumLevels(U);for(let O=0;O<J;O++){const J={width:H.getImageWidth(U,O),height:H.getImageHeight(U,O)};u.levels.push(J)}O.push(u)}return{Og:u,images:O}}(mH);let r=G.data.ignoreSupportedFormats?null:function(b,d){let G=null;b.supportedCompressionFormats&&(G=b.supportedCompressionFormats.astc?g:b.supportedCompressionFormats.bc7?U:b.supportedCompressionFormats.s3tc?d.Og?O:J:b.supportedCompressionFormats.pvrtc?d.Og?w:h:b.supportedCompressionFormats.etc2?u:b.supportedCompressionFormats.etc1?H:B);return G}(G.data.config,l),p=!1;null===r&&(p=!0,r=l.Og?O:J);let a=!0;mH.startTranscoding()||(a=!1);const k=[];for(let H=0;H<l.images.length&&a;H++){const u=l.images[H];if(void 0===b.loadSingleImage||b.loadSingleImage===H){let J=u.levels.length;!1===b.loadMipmapLevels&&(J=1);for(let O=0;O<J;O++){const J=u.levels[O],U=d(mH,H,O,r,p);if(!U){a=!1;break}J.transcodedPixels=U,k.push(J.transcodedPixels.buffer)}}}mH.close(),mH.delete(),p&&(r=-1),a?postMessage({action:"transcode",success:a,id:G.data.id,fileInfo:l,format:r},k):postMessage({action:"transcode",success:a,id:G.data.id})}}}!function(H){H[H.cTFETC1=0]="cTFETC1",H[H.cTFETC2=1]="cTFETC2",H[H.cTFBC1=2]="cTFBC1",H[H.cTFBC3=3]="cTFBC3",H[H.cTFBC4=4]="cTFBC4",H[H.cTFBC5=5]="cTFBC5",H[H.cTFBC7=6]="cTFBC7",H[H.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",H[H.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",H[H.cTFASTC_4x4=10]="cTFASTC_4x4",H[H.cTFATC_RGB=11]="cTFATC_RGB",H[H.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",H[H.cTFRGBA32=13]="cTFRGBA32",H[H.cTFRGB565=14]="cTFRGB565",H[H.cTFBGR565=15]="cTFBGR565",H[H.cTFRGBA4444=16]="cTFRGBA4444",H[H.cTFFXT1_RGB=17]="cTFFXT1_RGB",H[H.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",H[H.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",H[H.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",H[H.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(O||(O={}));const B={JSModuleURL:`${U.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${U.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let b=null,d=null,G=0;const P=async()=>(b||(b=new Promise(((H,u)=>{d?H(d):U.Tools.LoadFileAsync(U.Tools.GetBabylonScriptURL(B.WasmModuleURL)).then((J=>{if("function"!==typeof URL)return u("Basis transcoder requires an environment with a URL constructor");const O=URL.createObjectURL(new Blob([`(${g})()`],{type:"application/javascript"}));d=new Worker(O),async function(H,u,J){return await new Promise(((O,h)=>{const w=u=>{"init"===u.data.action?(H.removeEventListener("message",w),O(H)):"error"===u.data.action&&h(u.data.error||"error initializing worker")};H.addEventListener("message",w),H.postMessage({action:"init",url:J?U.Tools.GetBabylonScriptURL(J):void 0,wasmBinary:u},[u])}))}(d,J,B.JSModuleURL).then(H,u)})).catch(u)}))),await b),mH=async(H,u)=>{const J=H instanceof ArrayBuffer?new Uint8Array(H):H;return await new Promise(((H,O)=>{P().then((()=>{const U=G++,h=u=>{"transcode"===u.data.action&&u.data.id===U&&(d.removeEventListener("message",h),u.data.success?H(u.data):O("Transcode is not supported on this device"))};d.addEventListener("message",h);const w=new Uint8Array(J.byteLength);w.set(new Uint8Array(J.buffer,J.byteOffset,J.byteLength)),d.postMessage({action:"transcode",id:U,imageData:w,config:u,ignoreSupportedFormats:false},[w.buffer])}),(H=>{O(H)}))}))},l=(H,u)=>{var J;let O=null===(J=u._gl)||void 0===J?void 0:J.TEXTURE_2D;var U;H.isCube&&(O=null===(U=u._gl)||void 0===U?void 0:U.TEXTURE_CUBE_MAP);u._bindTextureDirectly(O,H,!0)},r=(H,u)=>{const J=H.getEngine();for(let g=0;g<u.fileInfo.images.length;g++){const B=u.fileInfo.images[g].levels[0];if(H._invertVScale=H.invertY,-1===u.format||u.format===O.cTFRGB565)if(H.type=10,H.format=4,!J._features.basisNeedsPOT||Math.log2(B.width)%1===0&&Math.log2(B.height)%1===0)H._invertVScale=!H.invertY,H.width=B.width+3&-4,H.height=B.height+3&-4,H.samplingMode=2,l(H,J),J._uploadDataToTextureDirectly(H,new Uint16Array(B.transcodedPixels.buffer),g,0,4,!0);else{const u=new w.c(J,2);H._invertVScale=H.invertY,u.type=10,u.format=4,u.width=B.width+3&-4,u.height=B.height+3&-4,l(u,J),J._uploadDataToTextureDirectly(u,new Uint16Array(B.transcodedPixels.buffer),g,0,4,!0),J._rescaleTexture(u,H,J.scenes[0],J._getInternalFormat(4),(()=>{J._releaseTexture(u),l(H,J)}))}else{H.width=B.width,H.height=B.height,H.generateMipMaps=u.fileInfo.images[g].levels.length>1;const O=p.GetInternalFormatFromBasisFormat(u.format,J);H.format=O,l(H,J);const w=u.fileInfo.images[g].levels;for(let u=0;u<w.length;u++){const U=w[u];J._uploadCompressedDataToTextureDirectly(H,O,U.width,U.height,U.transcodedPixels,g,u)}!J._features.basisNeedsPOT||Math.log2(H.width)%1===0&&Math.log2(H.height)%1===0||(U.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),H._cachedWrapU=h.b.CLAMP_ADDRESSMODE,H._cachedWrapV=h.b.CLAMP_ADDRESSMODE)}}},p={JSModuleURL:B.JSModuleURL,WasmModuleURL:B.WasmModuleURL,GetInternalFormatFromBasisFormat:(H,u)=>{let J;switch(H){case O.cTFETC1:J=36196;break;case O.cTFBC1:J=33776;break;case O.cTFBC4:J=33779;break;case O.cTFASTC_4x4:J=37808;break;case O.cTFETC2:J=37496;break;case O.cTFBC7:J=36492}if(void 0===J)throw"The chosen Basis transcoder format is not currently supported";return J},TranscodeAsync:mH,LoadTextureFromTranscodeResult:r};Object.defineProperty(p,"JSModuleURL",{get:function(){return B.JSModuleURL},set:function(H){B.JSModuleURL=H}}),Object.defineProperty(p,"WasmModuleURL",{get:function(){return B.WasmModuleURL},set:function(H){B.WasmModuleURL=H}});class a{constructor(){this.supportCascades=!1}loadCubeData(H,u,J,O,h){if(Array.isArray(H))return;const w=u.getEngine().getCaps(),g={supportedCompressionFormats:{etc1:!!w.etc1,s3tc:!!w.s3tc,pvrtc:!!w.pvrtc,etc2:!!w.etc2,astc:!!w.astc,bc7:!!w.bptc}};mH(H,g).then((H=>{const J=H.fileInfo.images[0].levels.length>1&&u.generateMipMaps;r(u,H),u.getEngine()._setCubeMapTextureParams(u,J),u.isReady=!0,u.onLoadedObservable.notifyObservers(u),u.onLoadedObservable.clear(),O&&O()})).catch((H=>{U.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),u.isReady=!0,h&&h(H)}))}loadData(H,u,J){const O=u.getEngine().getCaps(),h={supportedCompressionFormats:{etc1:!!O.etc1,s3tc:!!O.s3tc,pvrtc:!!O.pvrtc,etc2:!!O.etc2,astc:!!O.astc,bc7:!!O.bptc}};mH(H,h).then((H=>{const O=H.fileInfo.images[0].levels[0],U=H.fileInfo.images[0].levels.length>1&&u.generateMipMaps;J(O.width,O.height,U,-1!==H.format,(()=>{r(u,H)}))})).catch((H=>{U.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),U.Tools.Warn(`Failed to transcode Basis file: ${H}`),J(0,0,!1,!1,(()=>{}),!0)}))}}}}]);