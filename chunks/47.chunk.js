"use strict";(self.i6szn8jgzh=self.i6szn8jgzh||[]).push([[47],{14310:(b,n,i)=>{i.r(n),i.d(n,{_BasisTextureLoader:()=>O});var e,V=i(11605),Q=i(11748),U=i(11706);function Y(){const b=0,n=1,i=2,e=3,V=6,Q=8,U=9,Y=10,L=14;let B=null;function mb(b,n,i,e,V){const Q=b.getImageTranscodedSizeInBytes(n,i,e);let U=new Uint8Array(Q);if(!b.transcodeImage(U,n,i,e,1,0))return null;if(V){U=function(b,n,i,e){const V=new Uint16Array(4),Q=new Uint16Array(i*e),U=i/4,Y=e/4;for(let L=0;L<Y;L++)for(let e=0;e<U;e++){const Y=n+8*(L*U+e);V[0]=b[Y]|b[Y+1]<<8,V[1]=b[Y+2]|b[Y+3]<<8,V[2]=(2*(31&V[0])+1*(31&V[1]))/3|(2*(2016&V[0])+1*(2016&V[1]))/3&2016|(2*(63488&V[0])+1*(63488&V[1]))/3&63488,V[3]=(2*(31&V[1])+1*(31&V[0]))/3|(2*(2016&V[1])+1*(2016&V[0]))/3&2016|(2*(63488&V[1])+1*(63488&V[0]))/3&63488;for(let n=0;n<4;n++){const U=b[Y+4+n];let B=(4*L+n)*i+4*e;Q[B++]=V[3&U],Q[B++]=V[U>>2&3],Q[B++]=V[U>>4&3],Q[B++]=V[U>>6&3]}}return Q}(U,0,b.getImageWidth(n,i)+3&-4,b.getImageHeight(n,i)+3&-4)}return U}onmessage=N=>{if("init"===N.data.action){if(N.data.url)try{importScripts(N.data.url)}catch(Z){postMessage({action:"error",error:Z})}B||(B=BASIS({wasmBinary:N.data.wasmBinary})),null!==B&&B.then((b=>{BASIS=b,b.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===N.data.action){const B=N.data.config,Z=N.data.imageData,T=new BASIS.BasisFile(Z),z=function(b){const n=b.getHasAlpha(),i=b.getNumImages(),e=[];for(let V=0;V<i;V++){const n={levels:[]},i=b.getNumLevels(V);for(let e=0;e<i;e++){const i={width:b.getImageWidth(V,e),height:b.getImageHeight(V,e)};n.levels.push(i)}e.push(n)}return{se:n,images:e}}(T);let K=N.data.ignoreSupportedFormats?null:function(B,mb){let N=null;B.supportedCompressionFormats&&(N=B.supportedCompressionFormats.astc?Y:B.supportedCompressionFormats.bc7?V:B.supportedCompressionFormats.s3tc?mb.se?e:i:B.supportedCompressionFormats.pvrtc?mb.se?U:Q:B.supportedCompressionFormats.etc2?n:B.supportedCompressionFormats.etc1?b:L);return N}(N.data.config,z),I=!1;null===K&&(I=!0,K=z.se?e:i);let O=!0;T.startTranscoding()||(O=!1);const u=[];for(let b=0;b<z.images.length&&O;b++){const n=z.images[b];if(void 0===B.loadSingleImage||B.loadSingleImage===b){let i=n.levels.length;!1===B.loadMipmapLevels&&(i=1);for(let e=0;e<i;e++){const i=n.levels[e],V=mb(T,b,e,K,I);if(!V){O=!1;break}i.transcodedPixels=V,u.push(i.transcodedPixels.buffer)}}}T.close(),T.delete(),I&&(K=-1),O?postMessage({action:"transcode",success:O,id:N.data.id,fileInfo:z,format:K},u):postMessage({action:"transcode",success:O,id:N.data.id})}}}!function(b){b[b.cTFETC1=0]="cTFETC1",b[b.cTFETC2=1]="cTFETC2",b[b.cTFBC1=2]="cTFBC1",b[b.cTFBC3=3]="cTFBC3",b[b.cTFBC4=4]="cTFBC4",b[b.cTFBC5=5]="cTFBC5",b[b.cTFBC7=6]="cTFBC7",b[b.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",b[b.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",b[b.cTFASTC_4x4=10]="cTFASTC_4x4",b[b.cTFATC_RGB=11]="cTFATC_RGB",b[b.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",b[b.cTFRGBA32=13]="cTFRGBA32",b[b.cTFRGB565=14]="cTFRGB565",b[b.cTFBGR565=15]="cTFBGR565",b[b.cTFRGBA4444=16]="cTFRGBA4444",b[b.cTFFXT1_RGB=17]="cTFFXT1_RGB",b[b.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",b[b.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",b[b.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",b[b.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(e||(e={}));const L={JSModuleURL:`${V.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${V.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let B=null,mb=null,N=0;const Z=async()=>(B||(B=new Promise(((b,n)=>{mb?b(mb):V.Tools.LoadFileAsync(V.Tools.GetBabylonScriptURL(L.WasmModuleURL)).then((i=>{if("function"!==typeof URL)return n("Basis transcoder requires an environment with a URL constructor");const e=URL.createObjectURL(new Blob([`(${Y})()`],{type:"application/javascript"}));mb=new Worker(e),async function(b,n,i){return await new Promise(((e,Q)=>{const U=n=>{"init"===n.data.action?(b.removeEventListener("message",U),e(b)):"error"===n.data.action&&Q(n.data.error||"error initializing worker")};b.addEventListener("message",U),b.postMessage({action:"init",url:i?V.Tools.GetBabylonScriptURL(i):void 0,wasmBinary:n},[n])}))}(mb,i,L.JSModuleURL).then(b,n)})).catch(n)}))),await B),T=async(b,n)=>{const i=b instanceof ArrayBuffer?new Uint8Array(b):b;return await new Promise(((b,e)=>{Z().then((()=>{const V=N++,Q=n=>{"transcode"===n.data.action&&n.data.id===V&&(mb.removeEventListener("message",Q),n.data.success?b(n.data):e("Transcode is not supported on this device"))};mb.addEventListener("message",Q);const U=new Uint8Array(i.byteLength);U.set(new Uint8Array(i.buffer,i.byteOffset,i.byteLength)),mb.postMessage({action:"transcode",id:V,imageData:U,config:n,ignoreSupportedFormats:false},[U.buffer])}),(b=>{e(b)}))}))},z=(b,n)=>{var i;let e=null===(i=n._gl)||void 0===i?void 0:i.TEXTURE_2D;var V;b.isCube&&(e=null===(V=n._gl)||void 0===V?void 0:V.TEXTURE_CUBE_MAP);n._bindTextureDirectly(e,b,!0)},K=(b,n)=>{const i=b.getEngine();for(let Y=0;Y<n.fileInfo.images.length;Y++){const L=n.fileInfo.images[Y].levels[0];if(b._invertVScale=b.invertY,-1===n.format||n.format===e.cTFRGB565)if(b.type=10,b.format=4,!i._features.basisNeedsPOT||Math.log2(L.width)%1===0&&Math.log2(L.height)%1===0)b._invertVScale=!b.invertY,b.width=L.width+3&-4,b.height=L.height+3&-4,b.samplingMode=2,z(b,i),i._uploadDataToTextureDirectly(b,new Uint16Array(L.transcodedPixels.buffer),Y,0,4,!0);else{const n=new U.e(i,2);b._invertVScale=b.invertY,n.type=10,n.format=4,n.width=L.width+3&-4,n.height=L.height+3&-4,z(n,i),i._uploadDataToTextureDirectly(n,new Uint16Array(L.transcodedPixels.buffer),Y,0,4,!0),i._rescaleTexture(n,b,i.scenes[0],i._getInternalFormat(4),(()=>{i._releaseTexture(n),z(b,i)}))}else{b.width=L.width,b.height=L.height,b.generateMipMaps=n.fileInfo.images[Y].levels.length>1;const e=I.GetInternalFormatFromBasisFormat(n.format,i);b.format=e,z(b,i);const U=n.fileInfo.images[Y].levels;for(let n=0;n<U.length;n++){const V=U[n];i._uploadCompressedDataToTextureDirectly(b,e,V.width,V.height,V.transcodedPixels,Y,n)}!i._features.basisNeedsPOT||Math.log2(b.width)%1===0&&Math.log2(b.height)%1===0||(V.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),b._cachedWrapU=Q.e.CLAMP_ADDRESSMODE,b._cachedWrapV=Q.e.CLAMP_ADDRESSMODE)}}},I={JSModuleURL:L.JSModuleURL,WasmModuleURL:L.WasmModuleURL,GetInternalFormatFromBasisFormat:(b,n)=>{let i;switch(b){case e.cTFETC1:i=36196;break;case e.cTFBC1:i=33776;break;case e.cTFBC4:i=33779;break;case e.cTFASTC_4x4:i=37808;break;case e.cTFETC2:i=37496;break;case e.cTFBC7:i=36492}if(void 0===i)throw"The chosen Basis transcoder format is not currently supported";return i},TranscodeAsync:T,LoadTextureFromTranscodeResult:K};Object.defineProperty(I,"JSModuleURL",{get:function(){return L.JSModuleURL},set:function(b){L.JSModuleURL=b}}),Object.defineProperty(I,"WasmModuleURL",{get:function(){return L.WasmModuleURL},set:function(b){L.WasmModuleURL=b}});class O{constructor(){this.supportCascades=!1}loadCubeData(b,n,i,e,Q){if(Array.isArray(b))return;const U=n.getEngine().getCaps(),Y={supportedCompressionFormats:{etc1:!!U.etc1,s3tc:!!U.s3tc,pvrtc:!!U.pvrtc,etc2:!!U.etc2,astc:!!U.astc,bc7:!!U.bptc}};T(b,Y).then((b=>{const i=b.fileInfo.images[0].levels.length>1&&n.generateMipMaps;K(n,b),n.getEngine()._setCubeMapTextureParams(n,i),n.isReady=!0,n.onLoadedObservable.notifyObservers(n),n.onLoadedObservable.clear(),e&&e()})).catch((b=>{V.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),n.isReady=!0,Q&&Q(b)}))}loadData(b,n,i){const e=n.getEngine().getCaps(),Q={supportedCompressionFormats:{etc1:!!e.etc1,s3tc:!!e.s3tc,pvrtc:!!e.pvrtc,etc2:!!e.etc2,astc:!!e.astc,bc7:!!e.bptc}};T(b,Q).then((b=>{const e=b.fileInfo.images[0].levels[0],V=b.fileInfo.images[0].levels.length>1&&n.generateMipMaps;i(e.width,e.height,V,-1!==b.format,(()=>{K(n,b)}))})).catch((b=>{V.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),V.Tools.Warn(`Failed to transcode Basis file: ${b}`),i(0,0,!1,!1,(()=>{}),!0)}))}}}}]);