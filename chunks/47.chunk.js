"use strict";(self.c2c3ycupenc=self.c2c3ycupenc||[]).push([[47],{14119:(c,r,D)=>{D.r(r),D.d(r,{_BasisTextureLoader:()=>Z});var W,B=D(11487),t=D(11656),u=D(11615);function a(){const c=0,r=1,D=2,W=3,B=6,t=8,u=9,a=10,H=14;let x=null;function M(c,r,D,W,B){const t=c.getImageTranscodedSizeInBytes(r,D,W);let u=new Uint8Array(t);if(!c.transcodeImage(u,r,D,W,1,0))return null;if(B){u=function(c,r,D,W){const B=new Uint16Array(4),t=new Uint16Array(D*W),u=D/4,a=W/4;for(let H=0;H<a;H++)for(let W=0;W<u;W++){const a=r+8*(H*u+W);B[0]=c[a]|c[a+1]<<8,B[1]=c[a+2]|c[a+3]<<8,B[2]=(2*(31&B[0])+1*(31&B[1]))/3|(2*(2016&B[0])+1*(2016&B[1]))/3&2016|(2*(63488&B[0])+1*(63488&B[1]))/3&63488,B[3]=(2*(31&B[1])+1*(31&B[0]))/3|(2*(2016&B[1])+1*(2016&B[0]))/3&2016|(2*(63488&B[1])+1*(63488&B[0]))/3&63488;for(let r=0;r<4;r++){const u=c[a+4+r];let x=(4*H+r)*D+4*W;t[x++]=B[3&u],t[x++]=B[u>>2&3],t[x++]=B[u>>4&3],t[x++]=B[u>>6&3]}}return t}(u,0,c.getImageWidth(r,D)+3&-4,c.getImageHeight(r,D)+3&-4)}return u}onmessage=E=>{if("init"===E.data.action){if(E.data.url)try{importScripts(E.data.url)}catch(m){postMessage({action:"error",error:m})}x||(x=BASIS({wasmBinary:E.data.wasmBinary})),null!==x&&x.then((c=>{BASIS=c,c.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===E.data.action){const x=E.data.config,m=E.data.imageData,Y=new BASIS.BasisFile(m),v=function(c){const r=c.getHasAlpha(),D=c.getNumImages(),W=[];for(let B=0;B<D;B++){const r={levels:[]},D=c.getNumLevels(B);for(let W=0;W<D;W++){const D={width:c.getImageWidth(B,W),height:c.getImageHeight(B,W)};r.levels.push(D)}W.push(r)}return{Ea:r,images:W}}(Y);let k=E.data.ignoreSupportedFormats?null:function(x,M){let E=null;x.supportedCompressionFormats&&(E=x.supportedCompressionFormats.astc?a:x.supportedCompressionFormats.bc7?B:x.supportedCompressionFormats.s3tc?M.Ea?W:D:x.supportedCompressionFormats.pvrtc?M.Ea?u:t:x.supportedCompressionFormats.etc2?r:x.supportedCompressionFormats.etc1?c:H);return E}(E.data.config,v),w=!1;null===k&&(w=!0,k=v.Ea?W:D);let Z=!0;Y.startTranscoding()||(Z=!1);const J=[];for(let c=0;c<v.images.length&&Z;c++){const r=v.images[c];if(void 0===x.loadSingleImage||x.loadSingleImage===c){let D=r.levels.length;!1===x.loadMipmapLevels&&(D=1);for(let W=0;W<D;W++){const D=r.levels[W],B=M(Y,c,W,k,w);if(!B){Z=!1;break}D.transcodedPixels=B,J.push(D.transcodedPixels.buffer)}}}Y.close(),Y.delete(),w&&(k=-1),Z?postMessage({action:"transcode",success:Z,id:E.data.id,fileInfo:v,format:k},J):postMessage({action:"transcode",success:Z,id:E.data.id})}}}!function(c){c[c.cTFETC1=0]="cTFETC1",c[c.cTFETC2=1]="cTFETC2",c[c.cTFBC1=2]="cTFBC1",c[c.cTFBC3=3]="cTFBC3",c[c.cTFBC4=4]="cTFBC4",c[c.cTFBC5=5]="cTFBC5",c[c.cTFBC7=6]="cTFBC7",c[c.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",c[c.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",c[c.cTFASTC_4x4=10]="cTFASTC_4x4",c[c.cTFATC_RGB=11]="cTFATC_RGB",c[c.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",c[c.cTFRGBA32=13]="cTFRGBA32",c[c.cTFRGB565=14]="cTFRGB565",c[c.cTFBGR565=15]="cTFBGR565",c[c.cTFRGBA4444=16]="cTFRGBA4444",c[c.cTFFXT1_RGB=17]="cTFFXT1_RGB",c[c.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",c[c.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",c[c.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",c[c.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(W||(W={}));const H={JSModuleURL:`${B.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${B.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let x=null,M=null,E=0;const m=async()=>(x||(x=new Promise(((c,r)=>{M?c(M):B.Tools.LoadFileAsync(B.Tools.GetBabylonScriptURL(H.WasmModuleURL)).then((D=>{if("function"!==typeof URL)return r("Basis transcoder requires an environment with a URL constructor");const W=URL.createObjectURL(new Blob([`(${a})()`],{type:"application/javascript"}));M=new Worker(W),async function(c,r,D){return await new Promise(((W,t)=>{const u=r=>{"init"===r.data.action?(c.removeEventListener("message",u),W(c)):"error"===r.data.action&&t(r.data.error||"error initializing worker")};c.addEventListener("message",u),c.postMessage({action:"init",url:D?B.Tools.GetBabylonScriptURL(D):void 0,wasmBinary:r},[r])}))}(M,D,H.JSModuleURL).then(c,r)})).catch(r)}))),await x),Y=async(c,r)=>{const D=c instanceof ArrayBuffer?new Uint8Array(c):c;return await new Promise(((c,W)=>{m().then((()=>{const B=E++,t=r=>{"transcode"===r.data.action&&r.data.id===B&&(M.removeEventListener("message",t),r.data.success?c(r.data):W("Transcode is not supported on this device"))};M.addEventListener("message",t);const u=new Uint8Array(D.byteLength);u.set(new Uint8Array(D.buffer,D.byteOffset,D.byteLength)),M.postMessage({action:"transcode",id:B,imageData:u,config:r,ignoreSupportedFormats:false},[u.buffer])}),(c=>{W(c)}))}))},v=(c,r)=>{var D;let W=null===(D=r._gl)||void 0===D?void 0:D.TEXTURE_2D;var B;c.isCube&&(W=null===(B=r._gl)||void 0===B?void 0:B.TEXTURE_CUBE_MAP);r._bindTextureDirectly(W,c,!0)},k=(c,r)=>{const D=c.getEngine();for(let a=0;a<r.fileInfo.images.length;a++){const H=r.fileInfo.images[a].levels[0];if(c._invertVScale=c.invertY,-1===r.format||r.format===W.cTFRGB565)if(c.type=10,c.format=4,!D._features.basisNeedsPOT||Math.log2(H.width)%1===0&&Math.log2(H.height)%1===0)c._invertVScale=!c.invertY,c.width=H.width+3&-4,c.height=H.height+3&-4,c.samplingMode=2,v(c,D),D._uploadDataToTextureDirectly(c,new Uint16Array(H.transcodedPixels.buffer),a,0,4,!0);else{const r=new u.e(D,2);c._invertVScale=c.invertY,r.type=10,r.format=4,r.width=H.width+3&-4,r.height=H.height+3&-4,v(r,D),D._uploadDataToTextureDirectly(r,new Uint16Array(H.transcodedPixels.buffer),a,0,4,!0),D._rescaleTexture(r,c,D.scenes[0],D._getInternalFormat(4),(()=>{D._releaseTexture(r),v(c,D)}))}else{c.width=H.width,c.height=H.height,c.generateMipMaps=r.fileInfo.images[a].levels.length>1;const W=w.GetInternalFormatFromBasisFormat(r.format,D);c.format=W,v(c,D);const u=r.fileInfo.images[a].levels;for(let r=0;r<u.length;r++){const B=u[r];D._uploadCompressedDataToTextureDirectly(c,W,B.width,B.height,B.transcodedPixels,a,r)}!D._features.basisNeedsPOT||Math.log2(c.width)%1===0&&Math.log2(c.height)%1===0||(B.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),c._cachedWrapU=t.b.CLAMP_ADDRESSMODE,c._cachedWrapV=t.b.CLAMP_ADDRESSMODE)}}},w={JSModuleURL:H.JSModuleURL,WasmModuleURL:H.WasmModuleURL,GetInternalFormatFromBasisFormat:(c,r)=>{let D;switch(c){case W.cTFETC1:D=36196;break;case W.cTFBC1:D=33776;break;case W.cTFBC4:D=33779;break;case W.cTFASTC_4x4:D=37808;break;case W.cTFETC2:D=37496;break;case W.cTFBC7:D=36492}if(void 0===D)throw"The chosen Basis transcoder format is not currently supported";return D},TranscodeAsync:Y,LoadTextureFromTranscodeResult:k};Object.defineProperty(w,"JSModuleURL",{get:function(){return H.JSModuleURL},set:function(c){H.JSModuleURL=c}}),Object.defineProperty(w,"WasmModuleURL",{get:function(){return H.WasmModuleURL},set:function(c){H.WasmModuleURL=c}});class Z{constructor(){this.supportCascades=!1}loadCubeData(c,r,D,W,t){if(Array.isArray(c))return;const u=r.getEngine().getCaps(),a={supportedCompressionFormats:{etc1:!!u.etc1,s3tc:!!u.s3tc,pvrtc:!!u.pvrtc,etc2:!!u.etc2,astc:!!u.astc,bc7:!!u.bptc}};Y(c,a).then((c=>{const D=c.fileInfo.images[0].levels.length>1&&r.generateMipMaps;k(r,c),r.getEngine()._setCubeMapTextureParams(r,D),r.isReady=!0,r.onLoadedObservable.notifyObservers(r),r.onLoadedObservable.clear(),W&&W()})).catch((c=>{B.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),r.isReady=!0,t&&t(c)}))}loadData(c,r,D){const W=r.getEngine().getCaps(),t={supportedCompressionFormats:{etc1:!!W.etc1,s3tc:!!W.s3tc,pvrtc:!!W.pvrtc,etc2:!!W.etc2,astc:!!W.astc,bc7:!!W.bptc}};Y(c,t).then((c=>{const W=c.fileInfo.images[0].levels[0],B=c.fileInfo.images[0].levels.length>1&&r.generateMipMaps;D(W.width,W.height,B,-1!==c.format,(()=>{k(r,c)}))})).catch((c=>{B.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),B.Tools.Warn(`Failed to transcode Basis file: ${c}`),D(0,0,!1,!1,(()=>{}),!0)}))}}}}]);