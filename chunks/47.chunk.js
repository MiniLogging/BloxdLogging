"use strict";(self["1kjc9ee3uyt"]=self["1kjc9ee3uyt"]||[]).push([[47],{14011:(w,E,G)=>{G.r(E),G.d(E,{_BasisTextureLoader:()=>Z});var P,h=G(11498),B=G(11663),y=G(11626);function x(){const w=0,E=1,G=2,P=3,h=6,B=8,y=9,x=10,U=14;let l=null;function i(w,E,G,P,h){const B=w.getImageTranscodedSizeInBytes(E,G,P);let y=new Uint8Array(B);if(!w.transcodeImage(y,E,G,P,1,0))return null;if(h){y=function(w,E,G,P){const h=new Uint16Array(4),B=new Uint16Array(G*P),y=G/4,x=P/4;for(let U=0;U<x;U++)for(let P=0;P<y;P++){const x=E+8*(U*y+P);h[0]=w[x]|w[x+1]<<8,h[1]=w[x+2]|w[x+3]<<8,h[2]=(2*(31&h[0])+1*(31&h[1]))/3|(2*(2016&h[0])+1*(2016&h[1]))/3&2016|(2*(63488&h[0])+1*(63488&h[1]))/3&63488,h[3]=(2*(31&h[1])+1*(31&h[0]))/3|(2*(2016&h[1])+1*(2016&h[0]))/3&2016|(2*(63488&h[1])+1*(63488&h[0]))/3&63488;for(let E=0;E<4;E++){const y=w[x+4+E];let l=(4*U+E)*G+4*P;B[l++]=h[3&y],B[l++]=h[y>>2&3],B[l++]=h[y>>4&3],B[l++]=h[y>>6&3]}}return B}(y,0,w.getImageWidth(E,G)+3&-4,w.getImageHeight(E,G)+3&-4)}return y}onmessage=O=>{if("init"===O.data.action){if(O.data.url)try{importScripts(O.data.url)}catch(u){postMessage({action:"error",error:u})}l||(l=BASIS({wasmBinary:O.data.wasmBinary})),null!==l&&l.then((w=>{BASIS=w,w.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===O.data.action){const l=O.data.config,u=O.data.imageData,V=new BASIS.BasisFile(u),a=function(w){const E=w.getHasAlpha(),G=w.getNumImages(),P=[];for(let h=0;h<G;h++){const E={levels:[]},G=w.getNumLevels(h);for(let P=0;P<G;P++){const G={width:w.getImageWidth(h,P),height:w.getImageHeight(h,P)};E.levels.push(G)}P.push(E)}return{mh:E,images:P}}(V);let Q=O.data.ignoreSupportedFormats?null:function(l,i){let O=null;l.supportedCompressionFormats&&(O=l.supportedCompressionFormats.astc?x:l.supportedCompressionFormats.bc7?h:l.supportedCompressionFormats.s3tc?i.mh?P:G:l.supportedCompressionFormats.pvrtc?i.mh?y:B:l.supportedCompressionFormats.etc2?E:l.supportedCompressionFormats.etc1?w:U);return O}(O.data.config,a),c=!1;null===Q&&(c=!0,Q=a.mh?P:G);let Z=!0;V.startTranscoding()||(Z=!1);const J=[];for(let w=0;w<a.images.length&&Z;w++){const E=a.images[w];if(void 0===l.loadSingleImage||l.loadSingleImage===w){let G=E.levels.length;!1===l.loadMipmapLevels&&(G=1);for(let P=0;P<G;P++){const G=E.levels[P],h=i(V,w,P,Q,c);if(!h){Z=!1;break}G.transcodedPixels=h,J.push(G.transcodedPixels.buffer)}}}V.close(),V.delete(),c&&(Q=-1),Z?postMessage({action:"transcode",success:Z,id:O.data.id,fileInfo:a,format:Q},J):postMessage({action:"transcode",success:Z,id:O.data.id})}}}!function(w){w[w.cTFETC1=0]="cTFETC1",w[w.cTFETC2=1]="cTFETC2",w[w.cTFBC1=2]="cTFBC1",w[w.cTFBC3=3]="cTFBC3",w[w.cTFBC4=4]="cTFBC4",w[w.cTFBC5=5]="cTFBC5",w[w.cTFBC7=6]="cTFBC7",w[w.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",w[w.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",w[w.cTFASTC_4x4=10]="cTFASTC_4x4",w[w.cTFATC_RGB=11]="cTFATC_RGB",w[w.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",w[w.cTFRGBA32=13]="cTFRGBA32",w[w.cTFRGB565=14]="cTFRGB565",w[w.cTFBGR565=15]="cTFBGR565",w[w.cTFRGBA4444=16]="cTFRGBA4444",w[w.cTFFXT1_RGB=17]="cTFFXT1_RGB",w[w.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",w[w.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",w[w.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",w[w.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(P||(P={}));const U={JSModuleURL:`${h.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${h.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let l=null,i=null,O=0;const u=async()=>(l||(l=new Promise(((w,E)=>{i?w(i):h.Tools.LoadFileAsync(h.Tools.GetBabylonScriptURL(U.WasmModuleURL)).then((G=>{if("function"!==typeof URL)return E("Basis transcoder requires an environment with a URL constructor");const P=URL.createObjectURL(new Blob([`(${x})()`],{type:"application/javascript"}));i=new Worker(P),async function(w,E,G){return await new Promise(((P,B)=>{const y=E=>{"init"===E.data.action?(w.removeEventListener("message",y),P(w)):"error"===E.data.action&&B(E.data.error||"error initializing worker")};w.addEventListener("message",y),w.postMessage({action:"init",url:G?h.Tools.GetBabylonScriptURL(G):void 0,wasmBinary:E},[E])}))}(i,G,U.JSModuleURL).then(w,E)})).catch(E)}))),await l),V=async(w,E)=>{const G=w instanceof ArrayBuffer?new Uint8Array(w):w;return await new Promise(((w,P)=>{u().then((()=>{const h=O++,B=E=>{"transcode"===E.data.action&&E.data.id===h&&(i.removeEventListener("message",B),E.data.success?w(E.data):P("Transcode is not supported on this device"))};i.addEventListener("message",B);const y=new Uint8Array(G.byteLength);y.set(new Uint8Array(G.buffer,G.byteOffset,G.byteLength)),i.postMessage({action:"transcode",id:h,imageData:y,config:E,ignoreSupportedFormats:false},[y.buffer])}),(w=>{P(w)}))}))},a=(w,E)=>{var G;let P=null===(G=E._gl)||void 0===G?void 0:G.TEXTURE_2D;var h;w.isCube&&(P=null===(h=E._gl)||void 0===h?void 0:h.TEXTURE_CUBE_MAP);E._bindTextureDirectly(P,w,!0)},Q=(w,E)=>{const G=w.getEngine();for(let x=0;x<E.fileInfo.images.length;x++){const U=E.fileInfo.images[x].levels[0];if(w._invertVScale=w.invertY,-1===E.format||E.format===P.cTFRGB565)if(w.type=10,w.format=4,!G._features.basisNeedsPOT||Math.log2(U.width)%1===0&&Math.log2(U.height)%1===0)w._invertVScale=!w.invertY,w.width=U.width+3&-4,w.height=U.height+3&-4,w.samplingMode=2,a(w,G),G._uploadDataToTextureDirectly(w,new Uint16Array(U.transcodedPixels.buffer),x,0,4,!0);else{const E=new y.e(G,2);w._invertVScale=w.invertY,E.type=10,E.format=4,E.width=U.width+3&-4,E.height=U.height+3&-4,a(E,G),G._uploadDataToTextureDirectly(E,new Uint16Array(U.transcodedPixels.buffer),x,0,4,!0),G._rescaleTexture(E,w,G.scenes[0],G._getInternalFormat(4),(()=>{G._releaseTexture(E),a(w,G)}))}else{w.width=U.width,w.height=U.height,w.generateMipMaps=E.fileInfo.images[x].levels.length>1;const P=c.GetInternalFormatFromBasisFormat(E.format,G);w.format=P,a(w,G);const y=E.fileInfo.images[x].levels;for(let E=0;E<y.length;E++){const h=y[E];G._uploadCompressedDataToTextureDirectly(w,P,h.width,h.height,h.transcodedPixels,x,E)}!G._features.basisNeedsPOT||Math.log2(w.width)%1===0&&Math.log2(w.height)%1===0||(h.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),w._cachedWrapU=B.c.CLAMP_ADDRESSMODE,w._cachedWrapV=B.c.CLAMP_ADDRESSMODE)}}},c={JSModuleURL:U.JSModuleURL,WasmModuleURL:U.WasmModuleURL,GetInternalFormatFromBasisFormat:(w,E)=>{let G;switch(w){case P.cTFETC1:G=36196;break;case P.cTFBC1:G=33776;break;case P.cTFBC4:G=33779;break;case P.cTFASTC_4x4:G=37808;break;case P.cTFETC2:G=37496;break;case P.cTFBC7:G=36492}if(void 0===G)throw"The chosen Basis transcoder format is not currently supported";return G},TranscodeAsync:V,LoadTextureFromTranscodeResult:Q};Object.defineProperty(c,"JSModuleURL",{get:function(){return U.JSModuleURL},set:function(w){U.JSModuleURL=w}}),Object.defineProperty(c,"WasmModuleURL",{get:function(){return U.WasmModuleURL},set:function(w){U.WasmModuleURL=w}});class Z{constructor(){this.supportCascades=!1}loadCubeData(w,E,G,P,B){if(Array.isArray(w))return;const y=E.getEngine().getCaps(),x={supportedCompressionFormats:{etc1:!!y.etc1,s3tc:!!y.s3tc,pvrtc:!!y.pvrtc,etc2:!!y.etc2,astc:!!y.astc,bc7:!!y.bptc}};V(w,x).then((w=>{const G=w.fileInfo.images[0].levels.length>1&&E.generateMipMaps;Q(E,w),E.getEngine()._setCubeMapTextureParams(E,G),E.isReady=!0,E.onLoadedObservable.notifyObservers(E),E.onLoadedObservable.clear(),P&&P()})).catch((w=>{h.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),E.isReady=!0,B&&B(w)}))}loadData(w,E,G){const P=E.getEngine().getCaps(),B={supportedCompressionFormats:{etc1:!!P.etc1,s3tc:!!P.s3tc,pvrtc:!!P.pvrtc,etc2:!!P.etc2,astc:!!P.astc,bc7:!!P.bptc}};V(w,B).then((w=>{const P=w.fileInfo.images[0].levels[0],h=w.fileInfo.images[0].levels.length>1&&E.generateMipMaps;G(P.width,P.height,h,-1!==w.format,(()=>{Q(E,w)}))})).catch((w=>{h.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),h.Tools.Warn(`Failed to transcode Basis file: ${w}`),G(0,0,!1,!1,(()=>{}),!0)}))}}}}]);