"use strict";(self["2fwzcez286e"]=self["2fwzcez286e"]||[]).push([[47],{15472:(B,u,F)=>{F.r(u),F.d(u,{_BasisTextureLoader:()=>W});var Z,V=F(12802),p=F(12969),G=F(12925);function R(){const B=0,u=1,F=2,Z=3,V=6,p=8,G=9,R=10,e=14;let s=null;function Y(B,u,F,Z,V){const p=B.getImageTranscodedSizeInBytes(u,F,Z);let G=new Uint8Array(p);if(!B.transcodeImage(G,u,F,Z,1,0))return null;if(V){G=function(B,u,F,Z){const V=new Uint16Array(4),p=new Uint16Array(F*Z),G=F/4,R=Z/4;for(let e=0;e<R;e++)for(let Z=0;Z<G;Z++){const R=u+8*(e*G+Z);V[0]=B[R]|B[R+1]<<8,V[1]=B[R+2]|B[R+3]<<8,V[2]=(2*(31&V[0])+1*(31&V[1]))/3|(2*(2016&V[0])+1*(2016&V[1]))/3&2016|(2*(63488&V[0])+1*(63488&V[1]))/3&63488,V[3]=(2*(31&V[1])+1*(31&V[0]))/3|(2*(2016&V[1])+1*(2016&V[0]))/3&2016|(2*(63488&V[1])+1*(63488&V[0]))/3&63488;for(let u=0;u<4;u++){const G=B[R+4+u];let s=(4*e+u)*F+4*Z;p[s++]=V[3&G],p[s++]=V[G>>2&3],p[s++]=V[G>>4&3],p[s++]=V[G>>6&3]}}return p}(G,0,B.getImageWidth(u,F)+3&-4,B.getImageHeight(u,F)+3&-4)}return G}onmessage=Q=>{if("init"===Q.data.action){if(Q.data.url)try{importScripts(Q.data.url)}catch(t){postMessage({action:"error",error:t})}s||(s=BASIS({wasmBinary:Q.data.wasmBinary})),null!==s&&s.then((B=>{BASIS=B,B.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===Q.data.action){const s=Q.data.config,t=Q.data.imageData,v=new BASIS.BasisFile(t),D=function(B){const u=B.getHasAlpha(),F=B.getNumImages(),Z=[];for(let V=0;V<F;V++){const u={levels:[]},F=B.getNumLevels(V);for(let Z=0;Z<F;Z++){const F={width:B.getImageWidth(V,Z),height:B.getImageHeight(V,Z)};u.levels.push(F)}Z.push(u)}return{LR:u,images:Z}}(v);let L=Q.data.ignoreSupportedFormats?null:function(s,Y){let Q=null;s.supportedCompressionFormats&&(Q=s.supportedCompressionFormats.astc?R:s.supportedCompressionFormats.bc7?V:s.supportedCompressionFormats.s3tc?Y.LR?Z:F:s.supportedCompressionFormats.pvrtc?Y.LR?G:p:s.supportedCompressionFormats.etc2?u:s.supportedCompressionFormats.etc1?B:e);return Q}(Q.data.config,D),q=!1;null===L&&(q=!0,L=D.LR?Z:F);let W=!0;v.startTranscoding()||(W=!1);const X=[];for(let B=0;B<D.images.length&&W;B++){const u=D.images[B];if(void 0===s.loadSingleImage||s.loadSingleImage===B){let F=u.levels.length;!1===s.loadMipmapLevels&&(F=1);for(let Z=0;Z<F;Z++){const F=u.levels[Z],V=Y(v,B,Z,L,q);if(!V){W=!1;break}F.transcodedPixels=V,X.push(F.transcodedPixels.buffer)}}}v.close(),v.delete(),q&&(L=-1),W?postMessage({action:"transcode",success:W,id:Q.data.id,fileInfo:D,format:L},X):postMessage({action:"transcode",success:W,id:Q.data.id})}}}!function(B){B[B.cTFETC1=0]="cTFETC1",B[B.cTFETC2=1]="cTFETC2",B[B.cTFBC1=2]="cTFBC1",B[B.cTFBC3=3]="cTFBC3",B[B.cTFBC4=4]="cTFBC4",B[B.cTFBC5=5]="cTFBC5",B[B.cTFBC7=6]="cTFBC7",B[B.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",B[B.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",B[B.cTFASTC_4x4=10]="cTFASTC_4x4",B[B.cTFATC_RGB=11]="cTFATC_RGB",B[B.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",B[B.cTFRGBA32=13]="cTFRGBA32",B[B.cTFRGB565=14]="cTFRGB565",B[B.cTFBGR565=15]="cTFBGR565",B[B.cTFRGBA4444=16]="cTFRGBA4444",B[B.cTFFXT1_RGB=17]="cTFFXT1_RGB",B[B.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",B[B.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",B[B.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",B[B.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(Z||(Z={}));const e={JSModuleURL:`${V.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${V.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let s=null,Y=null,Q=0;const t=async()=>(s||(s=new Promise(((B,u)=>{Y?B(Y):V.Tools.LoadFileAsync(V.Tools.GetBabylonScriptURL(e.WasmModuleURL)).then((F=>{if("function"!==typeof URL)return u("Basis transcoder requires an environment with a URL constructor");const Z=URL.createObjectURL(new Blob([`(${R})()`],{type:"application/javascript"}));Y=new Worker(Z),async function(B,u,F){return await new Promise(((Z,p)=>{const G=u=>{"init"===u.data.action?(B.removeEventListener("message",G),Z(B)):"error"===u.data.action&&p(u.data.error||"error initializing worker")};B.addEventListener("message",G),B.postMessage({action:"init",url:F?V.Tools.GetBabylonScriptURL(F):void 0,wasmBinary:u},[u])}))}(Y,F,e.JSModuleURL).then(B,u)})).catch(u)}))),await s),v=async(B,u)=>{const F=B instanceof ArrayBuffer?new Uint8Array(B):B;return await new Promise(((B,Z)=>{t().then((()=>{const V=Q++,p=u=>{"transcode"===u.data.action&&u.data.id===V&&(Y.removeEventListener("message",p),u.data.success?B(u.data):Z("Transcode is not supported on this device"))};Y.addEventListener("message",p);const G=new Uint8Array(F.byteLength);G.set(new Uint8Array(F.buffer,F.byteOffset,F.byteLength)),Y.postMessage({action:"transcode",id:V,imageData:G,config:u,ignoreSupportedFormats:false},[G.buffer])}),(B=>{Z(B)}))}))},D=(B,u)=>{var F;let Z=null===(F=u._gl)||void 0===F?void 0:F.TEXTURE_2D;var V;B.isCube&&(Z=null===(V=u._gl)||void 0===V?void 0:V.TEXTURE_CUBE_MAP);u._bindTextureDirectly(Z,B,!0)},L=(B,u)=>{const F=B.getEngine();for(let R=0;R<u.fileInfo.images.length;R++){const e=u.fileInfo.images[R].levels[0];if(B._invertVScale=B.invertY,-1===u.format||u.format===Z.cTFRGB565)if(B.type=10,B.format=4,!F._features.basisNeedsPOT||Math.log2(e.width)%1===0&&Math.log2(e.height)%1===0)B._invertVScale=!B.invertY,B.width=e.width+3&-4,B.height=e.height+3&-4,B.samplingMode=2,D(B,F),F._uploadDataToTextureDirectly(B,new Uint16Array(e.transcodedPixels.buffer),R,0,4,!0);else{const u=new G.b(F,2);B._invertVScale=B.invertY,u.type=10,u.format=4,u.width=e.width+3&-4,u.height=e.height+3&-4,D(u,F),F._uploadDataToTextureDirectly(u,new Uint16Array(e.transcodedPixels.buffer),R,0,4,!0),F._rescaleTexture(u,B,F.scenes[0],F._getInternalFormat(4),(()=>{F._releaseTexture(u),D(B,F)}))}else{B.width=e.width,B.height=e.height,B.generateMipMaps=u.fileInfo.images[R].levels.length>1;const Z=q.GetInternalFormatFromBasisFormat(u.format,F);B.format=Z,D(B,F);const G=u.fileInfo.images[R].levels;for(let u=0;u<G.length;u++){const V=G[u];F._uploadCompressedDataToTextureDirectly(B,Z,V.width,V.height,V.transcodedPixels,R,u)}!F._features.basisNeedsPOT||Math.log2(B.width)%1===0&&Math.log2(B.height)%1===0||(V.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),B._cachedWrapU=p.d.CLAMP_ADDRESSMODE,B._cachedWrapV=p.d.CLAMP_ADDRESSMODE)}}},q={JSModuleURL:e.JSModuleURL,WasmModuleURL:e.WasmModuleURL,GetInternalFormatFromBasisFormat:(B,u)=>{let F;switch(B){case Z.cTFETC1:F=36196;break;case Z.cTFBC1:F=33776;break;case Z.cTFBC4:F=33779;break;case Z.cTFASTC_4x4:F=37808;break;case Z.cTFETC2:F=37496;break;case Z.cTFBC7:F=36492}if(void 0===F)throw"The chosen Basis transcoder format is not currently supported";return F},TranscodeAsync:v,LoadTextureFromTranscodeResult:L};Object.defineProperty(q,"JSModuleURL",{get:function(){return e.JSModuleURL},set:function(B){e.JSModuleURL=B}}),Object.defineProperty(q,"WasmModuleURL",{get:function(){return e.WasmModuleURL},set:function(B){e.WasmModuleURL=B}});class W{constructor(){this.supportCascades=!1}loadCubeData(B,u,F,Z,p){if(Array.isArray(B))return;const G=u.getEngine().getCaps(),R={supportedCompressionFormats:{etc1:!!G.etc1,s3tc:!!G.s3tc,pvrtc:!!G.pvrtc,etc2:!!G.etc2,astc:!!G.astc,bc7:!!G.bptc}};v(B,R).then((B=>{const F=B.fileInfo.images[0].levels.length>1&&u.generateMipMaps;L(u,B),u.getEngine()._setCubeMapTextureParams(u,F),u.isReady=!0,u.onLoadedObservable.notifyObservers(u),u.onLoadedObservable.clear(),Z&&Z()})).catch((B=>{V.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),u.isReady=!0,p&&p(B)}))}loadData(B,u,F){const Z=u.getEngine().getCaps(),p={supportedCompressionFormats:{etc1:!!Z.etc1,s3tc:!!Z.s3tc,pvrtc:!!Z.pvrtc,etc2:!!Z.etc2,astc:!!Z.astc,bc7:!!Z.bptc}};v(B,p).then((B=>{const Z=B.fileInfo.images[0].levels[0],V=B.fileInfo.images[0].levels.length>1&&u.generateMipMaps;F(Z.width,Z.height,V,-1!==B.format,(()=>{L(u,B)}))})).catch((B=>{V.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),V.Tools.Warn(`Failed to transcode Basis file: ${B}`),F(0,0,!1,!1,(()=>{}),!0)}))}}}}]);