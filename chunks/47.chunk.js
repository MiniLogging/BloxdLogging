"use strict";(self.h66iwo8dvgq=self.h66iwo8dvgq||[]).push([[47],{14369:(b,X,P)=>{P.r(X),P.d(X,{_BasisTextureLoader:()=>B});var Q,S=P(11689),d=P(11814),N=P(11787);function a(){const b=0,X=1,P=2,Q=3,S=6,d=8,N=9,a=10,u=14;let w=null;function f(b,X,P,Q,S){const d=b.getImageTranscodedSizeInBytes(X,P,Q);let N=new Uint8Array(d);if(!b.transcodeImage(N,X,P,Q,1,0))return null;if(S){N=function(b,X,P,Q){const S=new Uint16Array(4),d=new Uint16Array(P*Q),N=P/4,a=Q/4;for(let u=0;u<a;u++)for(let Q=0;Q<N;Q++){const a=X+8*(u*N+Q);S[0]=b[a]|b[a+1]<<8,S[1]=b[a+2]|b[a+3]<<8,S[2]=(2*(31&S[0])+1*(31&S[1]))/3|(2*(2016&S[0])+1*(2016&S[1]))/3&2016|(2*(63488&S[0])+1*(63488&S[1]))/3&63488,S[3]=(2*(31&S[1])+1*(31&S[0]))/3|(2*(2016&S[1])+1*(2016&S[0]))/3&2016|(2*(63488&S[1])+1*(63488&S[0]))/3&63488;for(let X=0;X<4;X++){const N=b[a+4+X];let w=(4*u+X)*P+4*Q;d[w++]=S[3&N],d[w++]=S[N>>2&3],d[w++]=S[N>>4&3],d[w++]=S[N>>6&3]}}return d}(N,0,b.getImageWidth(X,P)+3&-4,b.getImageHeight(X,P)+3&-4)}return N}onmessage=O=>{if("init"===O.data.action){if(O.data.url)try{importScripts(O.data.url)}catch(e){postMessage({action:"error",error:e})}w||(w=BASIS({wasmBinary:O.data.wasmBinary})),null!==w&&w.then((b=>{BASIS=b,b.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===O.data.action){const w=O.data.config,e=O.data.imageData,Y=new BASIS.BasisFile(e),D=function(b){const X=b.getHasAlpha(),P=b.getNumImages(),Q=[];for(let S=0;S<P;S++){const X={levels:[]},P=b.getNumLevels(S);for(let Q=0;Q<P;Q++){const P={width:b.getImageWidth(S,Q),height:b.getImageHeight(S,Q)};X.levels.push(P)}Q.push(X)}return{Ad:X,images:Q}}(Y);let E=O.data.ignoreSupportedFormats?null:function(w,f){let O=null;w.supportedCompressionFormats&&(O=w.supportedCompressionFormats.astc?a:w.supportedCompressionFormats.bc7?S:w.supportedCompressionFormats.s3tc?f.Ad?Q:P:w.supportedCompressionFormats.pvrtc?f.Ad?N:d:w.supportedCompressionFormats.etc2?X:w.supportedCompressionFormats.etc1?b:u);return O}(O.data.config,D),t=!1;null===E&&(t=!0,E=D.Ad?Q:P);let B=!0;Y.startTranscoding()||(B=!1);const W=[];for(let b=0;b<D.images.length&&B;b++){const X=D.images[b];if(void 0===w.loadSingleImage||w.loadSingleImage===b){let P=X.levels.length;!1===w.loadMipmapLevels&&(P=1);for(let Q=0;Q<P;Q++){const P=X.levels[Q],S=f(Y,b,Q,E,t);if(!S){B=!1;break}P.transcodedPixels=S,W.push(P.transcodedPixels.buffer)}}}Y.close(),Y.delete(),t&&(E=-1),B?postMessage({action:"transcode",success:B,id:O.data.id,fileInfo:D,format:E},W):postMessage({action:"transcode",success:B,id:O.data.id})}}}!function(b){b[b.cTFETC1=0]="cTFETC1",b[b.cTFETC2=1]="cTFETC2",b[b.cTFBC1=2]="cTFBC1",b[b.cTFBC3=3]="cTFBC3",b[b.cTFBC4=4]="cTFBC4",b[b.cTFBC5=5]="cTFBC5",b[b.cTFBC7=6]="cTFBC7",b[b.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",b[b.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",b[b.cTFASTC_4x4=10]="cTFASTC_4x4",b[b.cTFATC_RGB=11]="cTFATC_RGB",b[b.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",b[b.cTFRGBA32=13]="cTFRGBA32",b[b.cTFRGB565=14]="cTFRGB565",b[b.cTFBGR565=15]="cTFBGR565",b[b.cTFRGBA4444=16]="cTFRGBA4444",b[b.cTFFXT1_RGB=17]="cTFFXT1_RGB",b[b.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",b[b.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",b[b.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",b[b.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(Q||(Q={}));const u={JSModuleURL:`${S.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${S.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let w=null,f=null,O=0;const e=async()=>(w||(w=new Promise(((b,X)=>{f?b(f):S.Tools.LoadFileAsync(S.Tools.GetBabylonScriptURL(u.WasmModuleURL)).then((P=>{if("function"!==typeof URL)return X("Basis transcoder requires an environment with a URL constructor");const Q=URL.createObjectURL(new Blob([`(${a})()`],{type:"application/javascript"}));f=new Worker(Q),async function(b,X,P){return await new Promise(((Q,d)=>{const N=X=>{"init"===X.data.action?(b.removeEventListener("message",N),Q(b)):"error"===X.data.action&&d(X.data.error||"error initializing worker")};b.addEventListener("message",N),b.postMessage({action:"init",url:P?S.Tools.GetBabylonScriptURL(P):void 0,wasmBinary:X},[X])}))}(f,P,u.JSModuleURL).then(b,X)})).catch(X)}))),await w),Y=async(b,X)=>{const P=b instanceof ArrayBuffer?new Uint8Array(b):b;return await new Promise(((b,Q)=>{e().then((()=>{const S=O++,d=X=>{"transcode"===X.data.action&&X.data.id===S&&(f.removeEventListener("message",d),X.data.success?b(X.data):Q("Transcode is not supported on this device"))};f.addEventListener("message",d);const N=new Uint8Array(P.byteLength);N.set(new Uint8Array(P.buffer,P.byteOffset,P.byteLength)),f.postMessage({action:"transcode",id:S,imageData:N,config:X,ignoreSupportedFormats:false},[N.buffer])}),(b=>{Q(b)}))}))},D=(b,X)=>{var P;let Q=null===(P=X._gl)||void 0===P?void 0:P.TEXTURE_2D;var S;b.isCube&&(Q=null===(S=X._gl)||void 0===S?void 0:S.TEXTURE_CUBE_MAP);X._bindTextureDirectly(Q,b,!0)},E=(b,X)=>{const P=b.getEngine();for(let a=0;a<X.fileInfo.images.length;a++){const u=X.fileInfo.images[a].levels[0];if(b._invertVScale=b.invertY,-1===X.format||X.format===Q.cTFRGB565)if(b.type=10,b.format=4,!P._features.basisNeedsPOT||Math.log2(u.width)%1===0&&Math.log2(u.height)%1===0)b._invertVScale=!b.invertY,b.width=u.width+3&-4,b.height=u.height+3&-4,b.samplingMode=2,D(b,P),P._uploadDataToTextureDirectly(b,new Uint16Array(u.transcodedPixels.buffer),a,0,4,!0);else{const X=new N.e(P,2);b._invertVScale=b.invertY,X.type=10,X.format=4,X.width=u.width+3&-4,X.height=u.height+3&-4,D(X,P),P._uploadDataToTextureDirectly(X,new Uint16Array(u.transcodedPixels.buffer),a,0,4,!0),P._rescaleTexture(X,b,P.scenes[0],P._getInternalFormat(4),(()=>{P._releaseTexture(X),D(b,P)}))}else{b.width=u.width,b.height=u.height,b.generateMipMaps=X.fileInfo.images[a].levels.length>1;const Q=t.GetInternalFormatFromBasisFormat(X.format,P);b.format=Q,D(b,P);const N=X.fileInfo.images[a].levels;for(let X=0;X<N.length;X++){const S=N[X];P._uploadCompressedDataToTextureDirectly(b,Q,S.width,S.height,S.transcodedPixels,a,X)}!P._features.basisNeedsPOT||Math.log2(b.width)%1===0&&Math.log2(b.height)%1===0||(S.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),b._cachedWrapU=d.d.CLAMP_ADDRESSMODE,b._cachedWrapV=d.d.CLAMP_ADDRESSMODE)}}},t={JSModuleURL:u.JSModuleURL,WasmModuleURL:u.WasmModuleURL,GetInternalFormatFromBasisFormat:(b,X)=>{let P;switch(b){case Q.cTFETC1:P=36196;break;case Q.cTFBC1:P=33776;break;case Q.cTFBC4:P=33779;break;case Q.cTFASTC_4x4:P=37808;break;case Q.cTFETC2:P=37496;break;case Q.cTFBC7:P=36492}if(void 0===P)throw"The chosen Basis transcoder format is not currently supported";return P},TranscodeAsync:Y,LoadTextureFromTranscodeResult:E};Object.defineProperty(t,"JSModuleURL",{get:function(){return u.JSModuleURL},set:function(b){u.JSModuleURL=b}}),Object.defineProperty(t,"WasmModuleURL",{get:function(){return u.WasmModuleURL},set:function(b){u.WasmModuleURL=b}});class B{constructor(){this.supportCascades=!1}loadCubeData(b,X,P,Q,d){if(Array.isArray(b))return;const N=X.getEngine().getCaps(),a={supportedCompressionFormats:{etc1:!!N.etc1,s3tc:!!N.s3tc,pvrtc:!!N.pvrtc,etc2:!!N.etc2,astc:!!N.astc,bc7:!!N.bptc}};Y(b,a).then((b=>{const P=b.fileInfo.images[0].levels.length>1&&X.generateMipMaps;E(X,b),X.getEngine()._setCubeMapTextureParams(X,P),X.isReady=!0,X.onLoadedObservable.notifyObservers(X),X.onLoadedObservable.clear(),Q&&Q()})).catch((b=>{S.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),X.isReady=!0,d&&d(b)}))}loadData(b,X,P){const Q=X.getEngine().getCaps(),d={supportedCompressionFormats:{etc1:!!Q.etc1,s3tc:!!Q.s3tc,pvrtc:!!Q.pvrtc,etc2:!!Q.etc2,astc:!!Q.astc,bc7:!!Q.bptc}};Y(b,d).then((b=>{const Q=b.fileInfo.images[0].levels[0],S=b.fileInfo.images[0].levels.length>1&&X.generateMipMaps;P(Q.width,Q.height,S,-1!==b.format,(()=>{E(X,b)}))})).catch((b=>{S.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),S.Tools.Warn(`Failed to transcode Basis file: ${b}`),P(0,0,!1,!1,(()=>{}),!0)}))}}}}]);