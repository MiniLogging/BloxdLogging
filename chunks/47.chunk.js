"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[47],{13673:(o,H,n)=>{n.r(H),n.d(H,{_BasisTextureLoader:()=>J});var E,k=n(11024),g=n(11168),O=n(11120);function Y(){const o=0,H=1,n=2,E=3,k=6,g=8,O=9,Y=10,y=14;let S=null;function G(o,H,n,E,k){const g=o.getImageTranscodedSizeInBytes(H,n,E);let O=new Uint8Array(g);if(!o.transcodeImage(O,H,n,E,1,0))return null;if(k){O=function(o,H,n,E){const k=new Uint16Array(4),g=new Uint16Array(n*E),O=n/4,Y=E/4;for(let y=0;y<Y;y++)for(let E=0;E<O;E++){const Y=H+8*(y*O+E);k[0]=o[Y]|o[Y+1]<<8,k[1]=o[Y+2]|o[Y+3]<<8,k[2]=(2*(31&k[0])+1*(31&k[1]))/3|(2*(2016&k[0])+1*(2016&k[1]))/3&2016|(2*(63488&k[0])+1*(63488&k[1]))/3&63488,k[3]=(2*(31&k[1])+1*(31&k[0]))/3|(2*(2016&k[1])+1*(2016&k[0]))/3&2016|(2*(63488&k[1])+1*(63488&k[0]))/3&63488;for(let H=0;H<4;H++){const O=o[Y+4+H];let S=(4*y+H)*n+4*E;g[S++]=k[3&O],g[S++]=k[O>>2&3],g[S++]=k[O>>4&3],g[S++]=k[O>>6&3]}}return g}(O,0,o.getImageWidth(H,n)+3&-4,o.getImageHeight(H,n)+3&-4)}return O}onmessage=c=>{if("init"===c.data.action){if(c.data.url)try{importScripts(c.data.url)}catch(A){postMessage({action:"error",error:A})}S||(S=BASIS({wasmBinary:c.data.wasmBinary})),null!==S&&S.then((o=>{BASIS=o,o.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===c.data.action){const S=c.data.config,A=c.data.imageData,l=new BASIS.BasisFile(A),x=function(o){const H=o.getHasAlpha(),n=o.getNumImages(),E=[];for(let k=0;k<n;k++){const H={levels:[]},n=o.getNumLevels(k);for(let E=0;E<n;E++){const n={width:o.getImageWidth(k,E),height:o.getImageHeight(k,E)};H.levels.push(n)}E.push(H)}return{fg:H,images:E}}(l);let z=c.data.ignoreSupportedFormats?null:function(S,G){let c=null;S.supportedCompressionFormats&&(c=S.supportedCompressionFormats.astc?Y:S.supportedCompressionFormats.bc7?k:S.supportedCompressionFormats.s3tc?G.fg?E:n:S.supportedCompressionFormats.pvrtc?G.fg?O:g:S.supportedCompressionFormats.etc2?H:S.supportedCompressionFormats.etc1?o:y);return c}(c.data.config,x),V=!1;null===z&&(V=!0,z=x.fg?E:n);let J=!0;l.startTranscoding()||(J=!1);const N=[];for(let o=0;o<x.images.length&&J;o++){const H=x.images[o];if(void 0===S.loadSingleImage||S.loadSingleImage===o){let n=H.levels.length;!1===S.loadMipmapLevels&&(n=1);for(let E=0;E<n;E++){const n=H.levels[E],k=G(l,o,E,z,V);if(!k){J=!1;break}n.transcodedPixels=k,N.push(n.transcodedPixels.buffer)}}}l.close(),l.delete(),V&&(z=-1),J?postMessage({action:"transcode",success:J,id:c.data.id,fileInfo:x,format:z},N):postMessage({action:"transcode",success:J,id:c.data.id})}}}!function(o){o[o.cTFETC1=0]="cTFETC1",o[o.cTFETC2=1]="cTFETC2",o[o.cTFBC1=2]="cTFBC1",o[o.cTFBC3=3]="cTFBC3",o[o.cTFBC4=4]="cTFBC4",o[o.cTFBC5=5]="cTFBC5",o[o.cTFBC7=6]="cTFBC7",o[o.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",o[o.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",o[o.cTFASTC_4x4=10]="cTFASTC_4x4",o[o.cTFATC_RGB=11]="cTFATC_RGB",o[o.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",o[o.cTFRGBA32=13]="cTFRGBA32",o[o.cTFRGB565=14]="cTFRGB565",o[o.cTFBGR565=15]="cTFBGR565",o[o.cTFRGBA4444=16]="cTFRGBA4444",o[o.cTFFXT1_RGB=17]="cTFFXT1_RGB",o[o.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",o[o.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",o[o.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",o[o.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(E||(E={}));const y={JSModuleURL:`${k.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${k.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let S=null,G=null,c=0;const A=async()=>(S||(S=new Promise(((o,H)=>{G?o(G):k.Tools.LoadFileAsync(k.Tools.GetBabylonScriptURL(y.WasmModuleURL)).then((n=>{if("function"!==typeof URL)return H("Basis transcoder requires an environment with a URL constructor");const E=URL.createObjectURL(new Blob([`(${Y})()`],{type:"application/javascript"}));G=new Worker(E),async function(o,H,n){return await new Promise(((E,g)=>{const O=H=>{"init"===H.data.action?(o.removeEventListener("message",O),E(o)):"error"===H.data.action&&g(H.data.error||"error initializing worker")};o.addEventListener("message",O),o.postMessage({action:"init",url:n?k.Tools.GetBabylonScriptURL(n):void 0,wasmBinary:H},[H])}))}(G,n,y.JSModuleURL).then(o,H)})).catch(H)}))),await S),l=async(o,H)=>{const n=o instanceof ArrayBuffer?new Uint8Array(o):o;return await new Promise(((o,E)=>{A().then((()=>{const k=c++,g=H=>{"transcode"===H.data.action&&H.data.id===k&&(G.removeEventListener("message",g),H.data.success?o(H.data):E("Transcode is not supported on this device"))};G.addEventListener("message",g);const O=new Uint8Array(n.byteLength);O.set(new Uint8Array(n.buffer,n.byteOffset,n.byteLength)),G.postMessage({action:"transcode",id:k,imageData:O,config:H,ignoreSupportedFormats:false},[O.buffer])}),(o=>{E(o)}))}))},x=(o,H)=>{var n;let E=null===(n=H._gl)||void 0===n?void 0:n.TEXTURE_2D;var k;o.isCube&&(E=null===(k=H._gl)||void 0===k?void 0:k.TEXTURE_CUBE_MAP);H._bindTextureDirectly(E,o,!0)},z=(o,H)=>{const n=o.getEngine();for(let Y=0;Y<H.fileInfo.images.length;Y++){const y=H.fileInfo.images[Y].levels[0];if(o._invertVScale=o.invertY,-1===H.format||H.format===E.cTFRGB565)if(o.type=10,o.format=4,!n._features.basisNeedsPOT||Math.log2(y.width)%1===0&&Math.log2(y.height)%1===0)o._invertVScale=!o.invertY,o.width=y.width+3&-4,o.height=y.height+3&-4,o.samplingMode=2,x(o,n),n._uploadDataToTextureDirectly(o,new Uint16Array(y.transcodedPixels.buffer),Y,0,4,!0);else{const H=new O.d(n,2);o._invertVScale=o.invertY,H.type=10,H.format=4,H.width=y.width+3&-4,H.height=y.height+3&-4,x(H,n),n._uploadDataToTextureDirectly(H,new Uint16Array(y.transcodedPixels.buffer),Y,0,4,!0),n._rescaleTexture(H,o,n.scenes[0],n._getInternalFormat(4),(()=>{n._releaseTexture(H),x(o,n)}))}else{o.width=y.width,o.height=y.height,o.generateMipMaps=H.fileInfo.images[Y].levels.length>1;const E=V.GetInternalFormatFromBasisFormat(H.format,n);o.format=E,x(o,n);const O=H.fileInfo.images[Y].levels;for(let H=0;H<O.length;H++){const k=O[H];n._uploadCompressedDataToTextureDirectly(o,E,k.width,k.height,k.transcodedPixels,Y,H)}!n._features.basisNeedsPOT||Math.log2(o.width)%1===0&&Math.log2(o.height)%1===0||(k.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),o._cachedWrapU=g.c.CLAMP_ADDRESSMODE,o._cachedWrapV=g.c.CLAMP_ADDRESSMODE)}}},V={JSModuleURL:y.JSModuleURL,WasmModuleURL:y.WasmModuleURL,GetInternalFormatFromBasisFormat:(o,H)=>{let n;switch(o){case E.cTFETC1:n=36196;break;case E.cTFBC1:n=33776;break;case E.cTFBC4:n=33779;break;case E.cTFASTC_4x4:n=37808;break;case E.cTFETC2:n=37496;break;case E.cTFBC7:n=36492}if(void 0===n)throw"The chosen Basis transcoder format is not currently supported";return n},TranscodeAsync:l,LoadTextureFromTranscodeResult:z};Object.defineProperty(V,"JSModuleURL",{get:function(){return y.JSModuleURL},set:function(o){y.JSModuleURL=o}}),Object.defineProperty(V,"WasmModuleURL",{get:function(){return y.WasmModuleURL},set:function(o){y.WasmModuleURL=o}});class J{constructor(){this.supportCascades=!1}loadCubeData(o,H,n,E,g){if(Array.isArray(o))return;const O=H.getEngine().getCaps(),Y={supportedCompressionFormats:{etc1:!!O.etc1,s3tc:!!O.s3tc,pvrtc:!!O.pvrtc,etc2:!!O.etc2,astc:!!O.astc,bc7:!!O.bptc}};l(o,Y).then((o=>{const n=o.fileInfo.images[0].levels.length>1&&H.generateMipMaps;z(H,o),H.getEngine()._setCubeMapTextureParams(H,n),H.isReady=!0,H.onLoadedObservable.notifyObservers(H),H.onLoadedObservable.clear(),E&&E()})).catch((o=>{k.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),H.isReady=!0,g&&g(o)}))}loadData(o,H,n){const E=H.getEngine().getCaps(),g={supportedCompressionFormats:{etc1:!!E.etc1,s3tc:!!E.s3tc,pvrtc:!!E.pvrtc,etc2:!!E.etc2,astc:!!E.astc,bc7:!!E.bptc}};l(o,g).then((o=>{const E=o.fileInfo.images[0].levels[0],k=o.fileInfo.images[0].levels.length>1&&H.generateMipMaps;n(E.width,E.height,k,-1!==o.format,(()=>{z(H,o)}))})).catch((o=>{k.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),k.Tools.Warn(`Failed to transcode Basis file: ${o}`),n(0,0,!1,!1,(()=>{}),!0)}))}}}}]);