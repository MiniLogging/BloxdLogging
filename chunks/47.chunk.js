"use strict";(self.kdlk57exiqh=self.kdlk57exiqh||[]).push([[47],{14605:(i,x,e)=>{e.r(x),e.d(x,{_BasisTextureLoader:()=>T});var j,E=e(12061),a=e(12227),Y=e(12181);function J(){const i=0,x=1,e=2,j=3,E=6,a=8,Y=9,J=10,u=14;let b=null;function g(i,x,e,j,E){const a=i.getImageTranscodedSizeInBytes(x,e,j);let Y=new Uint8Array(a);if(!i.transcodeImage(Y,x,e,j,1,0))return null;if(E){Y=function(i,x,e,j){const E=new Uint16Array(4),a=new Uint16Array(e*j),Y=e/4,J=j/4;for(let u=0;u<J;u++)for(let j=0;j<Y;j++){const J=x+8*(u*Y+j);E[0]=i[J]|i[J+1]<<8,E[1]=i[J+2]|i[J+3]<<8,E[2]=(2*(31&E[0])+1*(31&E[1]))/3|(2*(2016&E[0])+1*(2016&E[1]))/3&2016|(2*(63488&E[0])+1*(63488&E[1]))/3&63488,E[3]=(2*(31&E[1])+1*(31&E[0]))/3|(2*(2016&E[1])+1*(2016&E[0]))/3&2016|(2*(63488&E[1])+1*(63488&E[0]))/3&63488;for(let x=0;x<4;x++){const Y=i[J+4+x];let b=(4*u+x)*e+4*j;a[b++]=E[3&Y],a[b++]=E[Y>>2&3],a[b++]=E[Y>>4&3],a[b++]=E[Y>>6&3]}}return a}(Y,0,i.getImageWidth(x,e)+3&-4,i.getImageHeight(x,e)+3&-4)}return Y}onmessage=A=>{if("init"===A.data.action){if(A.data.url)try{importScripts(A.data.url)}catch(K){postMessage({action:"error",error:K})}b||(b=BASIS({wasmBinary:A.data.wasmBinary})),null!==b&&b.then((i=>{BASIS=i,i.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===A.data.action){const b=A.data.config,K=A.data.imageData,L=new BASIS.BasisFile(K),o=function(i){const x=i.getHasAlpha(),e=i.getNumImages(),j=[];for(let E=0;E<e;E++){const x={levels:[]},e=i.getNumLevels(E);for(let j=0;j<e;j++){const e={width:i.getImageWidth(E,j),height:i.getImageHeight(E,j)};x.levels.push(e)}j.push(x)}return{He:x,images:j}}(L);let M=A.data.ignoreSupportedFormats?null:function(b,g){let A=null;b.supportedCompressionFormats&&(A=b.supportedCompressionFormats.astc?J:b.supportedCompressionFormats.bc7?E:b.supportedCompressionFormats.s3tc?g.He?j:e:b.supportedCompressionFormats.pvrtc?g.He?Y:a:b.supportedCompressionFormats.etc2?x:b.supportedCompressionFormats.etc1?i:u);return A}(A.data.config,o),z=!1;null===M&&(z=!0,M=o.He?j:e);let T=!0;L.startTranscoding()||(T=!1);const Q=[];for(let i=0;i<o.images.length&&T;i++){const x=o.images[i];if(void 0===b.loadSingleImage||b.loadSingleImage===i){let e=x.levels.length;!1===b.loadMipmapLevels&&(e=1);for(let j=0;j<e;j++){const e=x.levels[j],E=g(L,i,j,M,z);if(!E){T=!1;break}e.transcodedPixels=E,Q.push(e.transcodedPixels.buffer)}}}L.close(),L.delete(),z&&(M=-1),T?postMessage({action:"transcode",success:T,id:A.data.id,fileInfo:o,format:M},Q):postMessage({action:"transcode",success:T,id:A.data.id})}}}!function(i){i[i.cTFETC1=0]="cTFETC1",i[i.cTFETC2=1]="cTFETC2",i[i.cTFBC1=2]="cTFBC1",i[i.cTFBC3=3]="cTFBC3",i[i.cTFBC4=4]="cTFBC4",i[i.cTFBC5=5]="cTFBC5",i[i.cTFBC7=6]="cTFBC7",i[i.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",i[i.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",i[i.cTFASTC_4x4=10]="cTFASTC_4x4",i[i.cTFATC_RGB=11]="cTFATC_RGB",i[i.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",i[i.cTFRGBA32=13]="cTFRGBA32",i[i.cTFRGB565=14]="cTFRGB565",i[i.cTFBGR565=15]="cTFBGR565",i[i.cTFRGBA4444=16]="cTFRGBA4444",i[i.cTFFXT1_RGB=17]="cTFFXT1_RGB",i[i.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",i[i.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",i[i.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",i[i.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(j||(j={}));const u={JSModuleURL:`${E.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${E.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let b=null,g=null,A=0;const K=async()=>(b||(b=new Promise(((i,x)=>{g?i(g):E.Tools.LoadFileAsync(E.Tools.GetBabylonScriptURL(u.WasmModuleURL)).then((e=>{if("function"!==typeof URL)return x("Basis transcoder requires an environment with a URL constructor");const j=URL.createObjectURL(new Blob([`(${J})()`],{type:"application/javascript"}));g=new Worker(j),async function(i,x,e){return await new Promise(((j,a)=>{const Y=x=>{"init"===x.data.action?(i.removeEventListener("message",Y),j(i)):"error"===x.data.action&&a(x.data.error||"error initializing worker")};i.addEventListener("message",Y),i.postMessage({action:"init",url:e?E.Tools.GetBabylonScriptURL(e):void 0,wasmBinary:x},[x])}))}(g,e,u.JSModuleURL).then(i,x)})).catch(x)}))),await b),L=async(i,x)=>{const e=i instanceof ArrayBuffer?new Uint8Array(i):i;return await new Promise(((i,j)=>{K().then((()=>{const E=A++,a=x=>{"transcode"===x.data.action&&x.data.id===E&&(g.removeEventListener("message",a),x.data.success?i(x.data):j("Transcode is not supported on this device"))};g.addEventListener("message",a);const Y=new Uint8Array(e.byteLength);Y.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),g.postMessage({action:"transcode",id:E,imageData:Y,config:x,ignoreSupportedFormats:false},[Y.buffer])}),(i=>{j(i)}))}))},o=(i,x)=>{var e;let j=null===(e=x._gl)||void 0===e?void 0:e.TEXTURE_2D;var E;i.isCube&&(j=null===(E=x._gl)||void 0===E?void 0:E.TEXTURE_CUBE_MAP);x._bindTextureDirectly(j,i,!0)},M=(i,x)=>{const e=i.getEngine();for(let J=0;J<x.fileInfo.images.length;J++){const u=x.fileInfo.images[J].levels[0];if(i._invertVScale=i.invertY,-1===x.format||x.format===j.cTFRGB565)if(i.type=10,i.format=4,!e._features.basisNeedsPOT||Math.log2(u.width)%1===0&&Math.log2(u.height)%1===0)i._invertVScale=!i.invertY,i.width=u.width+3&-4,i.height=u.height+3&-4,i.samplingMode=2,o(i,e),e._uploadDataToTextureDirectly(i,new Uint16Array(u.transcodedPixels.buffer),J,0,4,!0);else{const x=new Y.b(e,2);i._invertVScale=i.invertY,x.type=10,x.format=4,x.width=u.width+3&-4,x.height=u.height+3&-4,o(x,e),e._uploadDataToTextureDirectly(x,new Uint16Array(u.transcodedPixels.buffer),J,0,4,!0),e._rescaleTexture(x,i,e.scenes[0],e._getInternalFormat(4),(()=>{e._releaseTexture(x),o(i,e)}))}else{i.width=u.width,i.height=u.height,i.generateMipMaps=x.fileInfo.images[J].levels.length>1;const j=z.GetInternalFormatFromBasisFormat(x.format,e);i.format=j,o(i,e);const Y=x.fileInfo.images[J].levels;for(let x=0;x<Y.length;x++){const E=Y[x];e._uploadCompressedDataToTextureDirectly(i,j,E.width,E.height,E.transcodedPixels,J,x)}!e._features.basisNeedsPOT||Math.log2(i.width)%1===0&&Math.log2(i.height)%1===0||(E.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),i._cachedWrapU=a.d.CLAMP_ADDRESSMODE,i._cachedWrapV=a.d.CLAMP_ADDRESSMODE)}}},z={JSModuleURL:u.JSModuleURL,WasmModuleURL:u.WasmModuleURL,GetInternalFormatFromBasisFormat:(i,x)=>{let e;switch(i){case j.cTFETC1:e=36196;break;case j.cTFBC1:e=33776;break;case j.cTFBC4:e=33779;break;case j.cTFASTC_4x4:e=37808;break;case j.cTFETC2:e=37496;break;case j.cTFBC7:e=36492}if(void 0===e)throw"The chosen Basis transcoder format is not currently supported";return e},TranscodeAsync:L,LoadTextureFromTranscodeResult:M};Object.defineProperty(z,"JSModuleURL",{get:function(){return u.JSModuleURL},set:function(i){u.JSModuleURL=i}}),Object.defineProperty(z,"WasmModuleURL",{get:function(){return u.WasmModuleURL},set:function(i){u.WasmModuleURL=i}});class T{constructor(){this.supportCascades=!1}loadCubeData(i,x,e,j,a){if(Array.isArray(i))return;const Y=x.getEngine().getCaps(),J={supportedCompressionFormats:{etc1:!!Y.etc1,s3tc:!!Y.s3tc,pvrtc:!!Y.pvrtc,etc2:!!Y.etc2,astc:!!Y.astc,bc7:!!Y.bptc}};L(i,J).then((i=>{const e=i.fileInfo.images[0].levels.length>1&&x.generateMipMaps;M(x,i),x.getEngine()._setCubeMapTextureParams(x,e),x.isReady=!0,x.onLoadedObservable.notifyObservers(x),x.onLoadedObservable.clear(),j&&j()})).catch((i=>{E.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),x.isReady=!0,a&&a(i)}))}loadData(i,x,e){const j=x.getEngine().getCaps(),a={supportedCompressionFormats:{etc1:!!j.etc1,s3tc:!!j.s3tc,pvrtc:!!j.pvrtc,etc2:!!j.etc2,astc:!!j.astc,bc7:!!j.bptc}};L(i,a).then((i=>{const j=i.fileInfo.images[0].levels[0],E=i.fileInfo.images[0].levels.length>1&&x.generateMipMaps;e(j.width,j.height,E,-1!==i.format,(()=>{M(x,i)}))})).catch((i=>{E.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),E.Tools.Warn(`Failed to transcode Basis file: ${i}`),e(0,0,!1,!1,(()=>{}),!0)}))}}}}]);