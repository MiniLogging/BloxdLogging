"use strict";(self.n4ygn1cq9vg=self.n4ygn1cq9vg||[]).push([[47],{14882:(e,d,v)=>{v.r(d),v.d(d,{_BasisTextureLoader:()=>D});var P,p=v(12240),L=v(12399),B=v(12357);function X(){const e=0,d=1,v=2,P=3,p=6,L=8,B=9,X=10,z=14;let W=null;function V(e,d,v,P,p){const L=e.getImageTranscodedSizeInBytes(d,v,P);let B=new Uint8Array(L);if(!e.transcodeImage(B,d,v,P,1,0))return null;if(p){B=function(e,d,v,P){const p=new Uint16Array(4),L=new Uint16Array(v*P),B=v/4,X=P/4;for(let z=0;z<X;z++)for(let P=0;P<B;P++){const X=d+8*(z*B+P);p[0]=e[X]|e[X+1]<<8,p[1]=e[X+2]|e[X+3]<<8,p[2]=(2*(31&p[0])+1*(31&p[1]))/3|(2*(2016&p[0])+1*(2016&p[1]))/3&2016|(2*(63488&p[0])+1*(63488&p[1]))/3&63488,p[3]=(2*(31&p[1])+1*(31&p[0]))/3|(2*(2016&p[1])+1*(2016&p[0]))/3&2016|(2*(63488&p[1])+1*(63488&p[0]))/3&63488;for(let d=0;d<4;d++){const B=e[X+4+d];let W=(4*z+d)*v+4*P;L[W++]=p[3&B],L[W++]=p[B>>2&3],L[W++]=p[B>>4&3],L[W++]=p[B>>6&3]}}return L}(B,0,e.getImageWidth(d,v)+3&-4,e.getImageHeight(d,v)+3&-4)}return B}onmessage=k=>{if("init"===k.data.action){if(k.data.url)try{importScripts(k.data.url)}catch(g){postMessage({action:"error",error:g})}W||(W=BASIS({wasmBinary:k.data.wasmBinary})),null!==W&&W.then((e=>{BASIS=e,e.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===k.data.action){const W=k.data.config,g=k.data.imageData,F=new BASIS.BasisFile(g),w=function(e){const d=e.getHasAlpha(),v=e.getNumImages(),P=[];for(let p=0;p<v;p++){const d={levels:[]},v=e.getNumLevels(p);for(let P=0;P<v;P++){const v={width:e.getImageWidth(p,P),height:e.getImageHeight(p,P)};d.levels.push(v)}P.push(d)}return{Hd:d,images:P}}(F);let G=k.data.ignoreSupportedFormats?null:function(W,V){let k=null;W.supportedCompressionFormats&&(k=W.supportedCompressionFormats.astc?X:W.supportedCompressionFormats.bc7?p:W.supportedCompressionFormats.s3tc?V.Hd?P:v:W.supportedCompressionFormats.pvrtc?V.Hd?B:L:W.supportedCompressionFormats.etc2?d:W.supportedCompressionFormats.etc1?e:z);return k}(k.data.config,w),U=!1;null===G&&(U=!0,G=w.Hd?P:v);let D=!0;F.startTranscoding()||(D=!1);const C=[];for(let e=0;e<w.images.length&&D;e++){const d=w.images[e];if(void 0===W.loadSingleImage||W.loadSingleImage===e){let v=d.levels.length;!1===W.loadMipmapLevels&&(v=1);for(let P=0;P<v;P++){const v=d.levels[P],p=V(F,e,P,G,U);if(!p){D=!1;break}v.transcodedPixels=p,C.push(v.transcodedPixels.buffer)}}}F.close(),F.delete(),U&&(G=-1),D?postMessage({action:"transcode",success:D,id:k.data.id,fileInfo:w,format:G},C):postMessage({action:"transcode",success:D,id:k.data.id})}}}!function(e){e[e.cTFETC1=0]="cTFETC1",e[e.cTFETC2=1]="cTFETC2",e[e.cTFBC1=2]="cTFBC1",e[e.cTFBC3=3]="cTFBC3",e[e.cTFBC4=4]="cTFBC4",e[e.cTFBC5=5]="cTFBC5",e[e.cTFBC7=6]="cTFBC7",e[e.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",e[e.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",e[e.cTFASTC_4x4=10]="cTFASTC_4x4",e[e.cTFATC_RGB=11]="cTFATC_RGB",e[e.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",e[e.cTFRGBA32=13]="cTFRGBA32",e[e.cTFRGB565=14]="cTFRGB565",e[e.cTFBGR565=15]="cTFBGR565",e[e.cTFRGBA4444=16]="cTFRGBA4444",e[e.cTFFXT1_RGB=17]="cTFFXT1_RGB",e[e.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",e[e.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",e[e.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",e[e.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(P||(P={}));const z={JSModuleURL:`${p.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${p.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let W=null,V=null,k=0;const g=async()=>(W||(W=new Promise(((e,d)=>{V?e(V):p.Tools.LoadFileAsync(p.Tools.GetBabylonScriptURL(z.WasmModuleURL)).then((v=>{if("function"!==typeof URL)return d("Basis transcoder requires an environment with a URL constructor");const P=URL.createObjectURL(new Blob([`(${X})()`],{type:"application/javascript"}));V=new Worker(P),async function(e,d,v){return await new Promise(((P,L)=>{const B=d=>{"init"===d.data.action?(e.removeEventListener("message",B),P(e)):"error"===d.data.action&&L(d.data.error||"error initializing worker")};e.addEventListener("message",B),e.postMessage({action:"init",url:v?p.Tools.GetBabylonScriptURL(v):void 0,wasmBinary:d},[d])}))}(V,v,z.JSModuleURL).then(e,d)})).catch(d)}))),await W),F=async(e,d)=>{const v=e instanceof ArrayBuffer?new Uint8Array(e):e;return await new Promise(((e,P)=>{g().then((()=>{const p=k++,L=d=>{"transcode"===d.data.action&&d.data.id===p&&(V.removeEventListener("message",L),d.data.success?e(d.data):P("Transcode is not supported on this device"))};V.addEventListener("message",L);const B=new Uint8Array(v.byteLength);B.set(new Uint8Array(v.buffer,v.byteOffset,v.byteLength)),V.postMessage({action:"transcode",id:p,imageData:B,config:d,ignoreSupportedFormats:false},[B.buffer])}),(e=>{P(e)}))}))},w=(e,d)=>{var v;let P=null===(v=d._gl)||void 0===v?void 0:v.TEXTURE_2D;var p;e.isCube&&(P=null===(p=d._gl)||void 0===p?void 0:p.TEXTURE_CUBE_MAP);d._bindTextureDirectly(P,e,!0)},G=(e,d)=>{const v=e.getEngine();for(let X=0;X<d.fileInfo.images.length;X++){const z=d.fileInfo.images[X].levels[0];if(e._invertVScale=e.invertY,-1===d.format||d.format===P.cTFRGB565)if(e.type=10,e.format=4,!v._features.basisNeedsPOT||Math.log2(z.width)%1===0&&Math.log2(z.height)%1===0)e._invertVScale=!e.invertY,e.width=z.width+3&-4,e.height=z.height+3&-4,e.samplingMode=2,w(e,v),v._uploadDataToTextureDirectly(e,new Uint16Array(z.transcodedPixels.buffer),X,0,4,!0);else{const d=new B.b(v,2);e._invertVScale=e.invertY,d.type=10,d.format=4,d.width=z.width+3&-4,d.height=z.height+3&-4,w(d,v),v._uploadDataToTextureDirectly(d,new Uint16Array(z.transcodedPixels.buffer),X,0,4,!0),v._rescaleTexture(d,e,v.scenes[0],v._getInternalFormat(4),(()=>{v._releaseTexture(d),w(e,v)}))}else{e.width=z.width,e.height=z.height,e.generateMipMaps=d.fileInfo.images[X].levels.length>1;const P=U.GetInternalFormatFromBasisFormat(d.format,v);e.format=P,w(e,v);const B=d.fileInfo.images[X].levels;for(let d=0;d<B.length;d++){const p=B[d];v._uploadCompressedDataToTextureDirectly(e,P,p.width,p.height,p.transcodedPixels,X,d)}!v._features.basisNeedsPOT||Math.log2(e.width)%1===0&&Math.log2(e.height)%1===0||(p.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),e._cachedWrapU=L.e.CLAMP_ADDRESSMODE,e._cachedWrapV=L.e.CLAMP_ADDRESSMODE)}}},U={JSModuleURL:z.JSModuleURL,WasmModuleURL:z.WasmModuleURL,GetInternalFormatFromBasisFormat:(e,d)=>{let v;switch(e){case P.cTFETC1:v=36196;break;case P.cTFBC1:v=33776;break;case P.cTFBC4:v=33779;break;case P.cTFASTC_4x4:v=37808;break;case P.cTFETC2:v=37496;break;case P.cTFBC7:v=36492}if(void 0===v)throw"The chosen Basis transcoder format is not currently supported";return v},TranscodeAsync:F,LoadTextureFromTranscodeResult:G};Object.defineProperty(U,"JSModuleURL",{get:function(){return z.JSModuleURL},set:function(e){z.JSModuleURL=e}}),Object.defineProperty(U,"WasmModuleURL",{get:function(){return z.WasmModuleURL},set:function(e){z.WasmModuleURL=e}});class D{constructor(){this.supportCascades=!1}loadCubeData(e,d,v,P,L){if(Array.isArray(e))return;const B=d.getEngine().getCaps(),X={supportedCompressionFormats:{etc1:!!B.etc1,s3tc:!!B.s3tc,pvrtc:!!B.pvrtc,etc2:!!B.etc2,astc:!!B.astc,bc7:!!B.bptc}};F(e,X).then((e=>{const v=e.fileInfo.images[0].levels.length>1&&d.generateMipMaps;G(d,e),d.getEngine()._setCubeMapTextureParams(d,v),d.isReady=!0,d.onLoadedObservable.notifyObservers(d),d.onLoadedObservable.clear(),P&&P()})).catch((e=>{p.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),d.isReady=!0,L&&L(e)}))}loadData(e,d,v){const P=d.getEngine().getCaps(),L={supportedCompressionFormats:{etc1:!!P.etc1,s3tc:!!P.s3tc,pvrtc:!!P.pvrtc,etc2:!!P.etc2,astc:!!P.astc,bc7:!!P.bptc}};F(e,L).then((e=>{const P=e.fileInfo.images[0].levels[0],p=e.fileInfo.images[0].levels.length>1&&d.generateMipMaps;v(P.width,P.height,p,-1!==e.format,(()=>{G(d,e)}))})).catch((e=>{p.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),p.Tools.Warn(`Failed to transcode Basis file: ${e}`),v(0,0,!1,!1,(()=>{}),!0)}))}}}}]);