"use strict";(self.uw9p3pwwsje=self.uw9p3pwwsje||[]).push([[47],{15162:(D,h,o)=>{o.r(h),o.d(h,{_BasisTextureLoader:()=>U});var H,g=o(12642),j=o(12807),M=o(12771);function R(){const D=0,h=1,o=2,H=3,g=6,j=8,M=9,R=10,t=14;let S=null;function k(D,h,o,H,g){const j=D.getImageTranscodedSizeInBytes(h,o,H);let M=new Uint8Array(j);if(!D.transcodeImage(M,h,o,H,1,0))return null;if(g){M=function(D,h,o,H){const g=new Uint16Array(4),j=new Uint16Array(o*H),M=o/4,R=H/4;for(let t=0;t<R;t++)for(let H=0;H<M;H++){const R=h+8*(t*M+H);g[0]=D[R]|D[R+1]<<8,g[1]=D[R+2]|D[R+3]<<8,g[2]=(2*(31&g[0])+1*(31&g[1]))/3|(2*(2016&g[0])+1*(2016&g[1]))/3&2016|(2*(63488&g[0])+1*(63488&g[1]))/3&63488,g[3]=(2*(31&g[1])+1*(31&g[0]))/3|(2*(2016&g[1])+1*(2016&g[0]))/3&2016|(2*(63488&g[1])+1*(63488&g[0]))/3&63488;for(let h=0;h<4;h++){const M=D[R+4+h];let S=(4*t+h)*o+4*H;j[S++]=g[3&M],j[S++]=g[M>>2&3],j[S++]=g[M>>4&3],j[S++]=g[M>>6&3]}}return j}(M,0,D.getImageWidth(h,o)+3&-4,D.getImageHeight(h,o)+3&-4)}return M}onmessage=K=>{if("init"===K.data.action){if(K.data.url)try{importScripts(K.data.url)}catch(Q){postMessage({action:"error",error:Q})}S||(S=BASIS({wasmBinary:K.data.wasmBinary})),null!==S&&S.then((D=>{BASIS=D,D.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===K.data.action){const S=K.data.config,Q=K.data.imageData,v=new BASIS.BasisFile(Q),r=function(D){const h=D.getHasAlpha(),o=D.getNumImages(),H=[];for(let g=0;g<o;g++){const h={levels:[]},o=D.getNumLevels(g);for(let H=0;H<o;H++){const o={width:D.getImageWidth(g,H),height:D.getImageHeight(g,H)};h.levels.push(o)}H.push(h)}return{Yh:h,images:H}}(v);let B=K.data.ignoreSupportedFormats?null:function(S,k){let K=null;S.supportedCompressionFormats&&(K=S.supportedCompressionFormats.astc?R:S.supportedCompressionFormats.bc7?g:S.supportedCompressionFormats.s3tc?k.Yh?H:o:S.supportedCompressionFormats.pvrtc?k.Yh?M:j:S.supportedCompressionFormats.etc2?h:S.supportedCompressionFormats.etc1?D:t);return K}(K.data.config,r),s=!1;null===B&&(s=!0,B=r.Yh?H:o);let U=!0;v.startTranscoding()||(U=!1);const q=[];for(let D=0;D<r.images.length&&U;D++){const h=r.images[D];if(void 0===S.loadSingleImage||S.loadSingleImage===D){let o=h.levels.length;!1===S.loadMipmapLevels&&(o=1);for(let H=0;H<o;H++){const o=h.levels[H],g=k(v,D,H,B,s);if(!g){U=!1;break}o.transcodedPixels=g,q.push(o.transcodedPixels.buffer)}}}v.close(),v.delete(),s&&(B=-1),U?postMessage({action:"transcode",success:U,id:K.data.id,fileInfo:r,format:B},q):postMessage({action:"transcode",success:U,id:K.data.id})}}}!function(D){D[D.cTFETC1=0]="cTFETC1",D[D.cTFETC2=1]="cTFETC2",D[D.cTFBC1=2]="cTFBC1",D[D.cTFBC3=3]="cTFBC3",D[D.cTFBC4=4]="cTFBC4",D[D.cTFBC5=5]="cTFBC5",D[D.cTFBC7=6]="cTFBC7",D[D.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",D[D.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",D[D.cTFASTC_4x4=10]="cTFASTC_4x4",D[D.cTFATC_RGB=11]="cTFATC_RGB",D[D.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",D[D.cTFRGBA32=13]="cTFRGBA32",D[D.cTFRGB565=14]="cTFRGB565",D[D.cTFBGR565=15]="cTFBGR565",D[D.cTFRGBA4444=16]="cTFRGBA4444",D[D.cTFFXT1_RGB=17]="cTFFXT1_RGB",D[D.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",D[D.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",D[D.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",D[D.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(H||(H={}));const t={JSModuleURL:`${g.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${g.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let S=null,k=null,K=0;const Q=async()=>(S||(S=new Promise(((D,h)=>{k?D(k):g.Tools.LoadFileAsync(g.Tools.GetBabylonScriptURL(t.WasmModuleURL)).then((o=>{if("function"!==typeof URL)return h("Basis transcoder requires an environment with a URL constructor");const H=URL.createObjectURL(new Blob([`(${R})()`],{type:"application/javascript"}));k=new Worker(H),async function(D,h,o){return await new Promise(((H,j)=>{const M=h=>{"init"===h.data.action?(D.removeEventListener("message",M),H(D)):"error"===h.data.action&&j(h.data.error||"error initializing worker")};D.addEventListener("message",M),D.postMessage({action:"init",url:o?g.Tools.GetBabylonScriptURL(o):void 0,wasmBinary:h},[h])}))}(k,o,t.JSModuleURL).then(D,h)})).catch(h)}))),await S),v=async(D,h)=>{const o=D instanceof ArrayBuffer?new Uint8Array(D):D;return await new Promise(((D,H)=>{Q().then((()=>{const g=K++,j=h=>{"transcode"===h.data.action&&h.data.id===g&&(k.removeEventListener("message",j),h.data.success?D(h.data):H("Transcode is not supported on this device"))};k.addEventListener("message",j);const M=new Uint8Array(o.byteLength);M.set(new Uint8Array(o.buffer,o.byteOffset,o.byteLength)),k.postMessage({action:"transcode",id:g,imageData:M,config:h,ignoreSupportedFormats:false},[M.buffer])}),(D=>{H(D)}))}))},r=(D,h)=>{var o;let H=null===(o=h._gl)||void 0===o?void 0:o.TEXTURE_2D;var g;D.isCube&&(H=null===(g=h._gl)||void 0===g?void 0:g.TEXTURE_CUBE_MAP);h._bindTextureDirectly(H,D,!0)},B=(D,h)=>{const o=D.getEngine();for(let R=0;R<h.fileInfo.images.length;R++){const t=h.fileInfo.images[R].levels[0];if(D._invertVScale=D.invertY,-1===h.format||h.format===H.cTFRGB565)if(D.type=10,D.format=4,!o._features.basisNeedsPOT||Math.log2(t.width)%1===0&&Math.log2(t.height)%1===0)D._invertVScale=!D.invertY,D.width=t.width+3&-4,D.height=t.height+3&-4,D.samplingMode=2,r(D,o),o._uploadDataToTextureDirectly(D,new Uint16Array(t.transcodedPixels.buffer),R,0,4,!0);else{const h=new M.c(o,2);D._invertVScale=D.invertY,h.type=10,h.format=4,h.width=t.width+3&-4,h.height=t.height+3&-4,r(h,o),o._uploadDataToTextureDirectly(h,new Uint16Array(t.transcodedPixels.buffer),R,0,4,!0),o._rescaleTexture(h,D,o.scenes[0],o._getInternalFormat(4),(()=>{o._releaseTexture(h),r(D,o)}))}else{D.width=t.width,D.height=t.height,D.generateMipMaps=h.fileInfo.images[R].levels.length>1;const H=s.GetInternalFormatFromBasisFormat(h.format,o);D.format=H,r(D,o);const M=h.fileInfo.images[R].levels;for(let h=0;h<M.length;h++){const g=M[h];o._uploadCompressedDataToTextureDirectly(D,H,g.width,g.height,g.transcodedPixels,R,h)}!o._features.basisNeedsPOT||Math.log2(D.width)%1===0&&Math.log2(D.height)%1===0||(g.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),D._cachedWrapU=j.b.CLAMP_ADDRESSMODE,D._cachedWrapV=j.b.CLAMP_ADDRESSMODE)}}},s={JSModuleURL:t.JSModuleURL,WasmModuleURL:t.WasmModuleURL,GetInternalFormatFromBasisFormat:(D,h)=>{let o;switch(D){case H.cTFETC1:o=36196;break;case H.cTFBC1:o=33776;break;case H.cTFBC4:o=33779;break;case H.cTFASTC_4x4:o=37808;break;case H.cTFETC2:o=37496;break;case H.cTFBC7:o=36492}if(void 0===o)throw"The chosen Basis transcoder format is not currently supported";return o},TranscodeAsync:v,LoadTextureFromTranscodeResult:B};Object.defineProperty(s,"JSModuleURL",{get:function(){return t.JSModuleURL},set:function(D){t.JSModuleURL=D}}),Object.defineProperty(s,"WasmModuleURL",{get:function(){return t.WasmModuleURL},set:function(D){t.WasmModuleURL=D}});class U{constructor(){this.supportCascades=!1}loadCubeData(D,h,o,H,j){if(Array.isArray(D))return;const M=h.getEngine().getCaps(),R={supportedCompressionFormats:{etc1:!!M.etc1,s3tc:!!M.s3tc,pvrtc:!!M.pvrtc,etc2:!!M.etc2,astc:!!M.astc,bc7:!!M.bptc}};v(D,R).then((D=>{const o=D.fileInfo.images[0].levels.length>1&&h.generateMipMaps;B(h,D),h.getEngine()._setCubeMapTextureParams(h,o),h.isReady=!0,h.onLoadedObservable.notifyObservers(h),h.onLoadedObservable.clear(),H&&H()})).catch((D=>{g.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),h.isReady=!0,j&&j(D)}))}loadData(D,h,o){const H=h.getEngine().getCaps(),j={supportedCompressionFormats:{etc1:!!H.etc1,s3tc:!!H.s3tc,pvrtc:!!H.pvrtc,etc2:!!H.etc2,astc:!!H.astc,bc7:!!H.bptc}};v(D,j).then((D=>{const H=D.fileInfo.images[0].levels[0],g=D.fileInfo.images[0].levels.length>1&&h.generateMipMaps;o(H.width,H.height,g,-1!==D.format,(()=>{B(h,D)}))})).catch((D=>{g.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),g.Tools.Warn(`Failed to transcode Basis file: ${D}`),o(0,0,!1,!1,(()=>{}),!0)}))}}}}]);