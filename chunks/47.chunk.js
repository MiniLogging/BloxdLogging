"use strict";(self.hwpa2z1pqte=self.hwpa2z1pqte||[]).push([[47],{15369:(h,R,l)=>{l.r(R),l.d(R,{_BasisTextureLoader:()=>t});var j,a=l(12689),D=l(12874),U=l(12835);function F(){const h=0,R=1,l=2,j=3,a=6,D=8,U=9,F=10,w=14;let mh=null;function u(h,R,l,j,a){const D=h.getImageTranscodedSizeInBytes(R,l,j);let U=new Uint8Array(D);if(!h.transcodeImage(U,R,l,j,1,0))return null;if(a){U=function(h,R,l,j){const a=new Uint16Array(4),D=new Uint16Array(l*j),U=l/4,F=j/4;for(let w=0;w<F;w++)for(let j=0;j<U;j++){const F=R+8*(w*U+j);a[0]=h[F]|h[F+1]<<8,a[1]=h[F+2]|h[F+3]<<8,a[2]=(2*(31&a[0])+1*(31&a[1]))/3|(2*(2016&a[0])+1*(2016&a[1]))/3&2016|(2*(63488&a[0])+1*(63488&a[1]))/3&63488,a[3]=(2*(31&a[1])+1*(31&a[0]))/3|(2*(2016&a[1])+1*(2016&a[0]))/3&2016|(2*(63488&a[1])+1*(63488&a[0]))/3&63488;for(let R=0;R<4;R++){const U=h[F+4+R];let mh=(4*w+R)*l+4*j;D[mh++]=a[3&U],D[mh++]=a[U>>2&3],D[mh++]=a[U>>4&3],D[mh++]=a[U>>6&3]}}return D}(U,0,h.getImageWidth(R,l)+3&-4,h.getImageHeight(R,l)+3&-4)}return U}onmessage=c=>{if("init"===c.data.action){if(c.data.url)try{importScripts(c.data.url)}catch(J){postMessage({action:"error",error:J})}mh||(mh=BASIS({wasmBinary:c.data.wasmBinary})),null!==mh&&mh.then((h=>{BASIS=h,h.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===c.data.action){const mh=c.data.config,J=c.data.imageData,q=new BASIS.BasisFile(J),Q=function(h){const R=h.getHasAlpha(),l=h.getNumImages(),j=[];for(let a=0;a<l;a++){const R={levels:[]},l=h.getNumLevels(a);for(let j=0;j<l;j++){const l={width:h.getImageWidth(a,j),height:h.getImageHeight(a,j)};R.levels.push(l)}j.push(R)}return{tF:R,images:j}}(q);let Y=c.data.ignoreSupportedFormats?null:function(mh,u){let c=null;mh.supportedCompressionFormats&&(c=mh.supportedCompressionFormats.astc?F:mh.supportedCompressionFormats.bc7?a:mh.supportedCompressionFormats.s3tc?u.tF?j:l:mh.supportedCompressionFormats.pvrtc?u.tF?U:D:mh.supportedCompressionFormats.etc2?R:mh.supportedCompressionFormats.etc1?h:w);return c}(c.data.config,Q),s=!1;null===Y&&(s=!0,Y=Q.tF?j:l);let t=!0;q.startTranscoding()||(t=!1);const f=[];for(let h=0;h<Q.images.length&&t;h++){const R=Q.images[h];if(void 0===mh.loadSingleImage||mh.loadSingleImage===h){let l=R.levels.length;!1===mh.loadMipmapLevels&&(l=1);for(let j=0;j<l;j++){const l=R.levels[j],a=u(q,h,j,Y,s);if(!a){t=!1;break}l.transcodedPixels=a,f.push(l.transcodedPixels.buffer)}}}q.close(),q.delete(),s&&(Y=-1),t?postMessage({action:"transcode",success:t,id:c.data.id,fileInfo:Q,format:Y},f):postMessage({action:"transcode",success:t,id:c.data.id})}}}!function(h){h[h.cTFETC1=0]="cTFETC1",h[h.cTFETC2=1]="cTFETC2",h[h.cTFBC1=2]="cTFBC1",h[h.cTFBC3=3]="cTFBC3",h[h.cTFBC4=4]="cTFBC4",h[h.cTFBC5=5]="cTFBC5",h[h.cTFBC7=6]="cTFBC7",h[h.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",h[h.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",h[h.cTFASTC_4x4=10]="cTFASTC_4x4",h[h.cTFATC_RGB=11]="cTFATC_RGB",h[h.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",h[h.cTFRGBA32=13]="cTFRGBA32",h[h.cTFRGB565=14]="cTFRGB565",h[h.cTFBGR565=15]="cTFBGR565",h[h.cTFRGBA4444=16]="cTFRGBA4444",h[h.cTFFXT1_RGB=17]="cTFFXT1_RGB",h[h.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",h[h.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",h[h.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",h[h.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(j||(j={}));const w={JSModuleURL:`${a.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${a.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let mh=null,u=null,c=0;const J=async()=>(mh||(mh=new Promise(((h,R)=>{u?h(u):a.Tools.LoadFileAsync(a.Tools.GetBabylonScriptURL(w.WasmModuleURL)).then((l=>{if("function"!==typeof URL)return R("Basis transcoder requires an environment with a URL constructor");const j=URL.createObjectURL(new Blob([`(${F})()`],{type:"application/javascript"}));u=new Worker(j),async function(h,R,l){return await new Promise(((j,D)=>{const U=R=>{"init"===R.data.action?(h.removeEventListener("message",U),j(h)):"error"===R.data.action&&D(R.data.error||"error initializing worker")};h.addEventListener("message",U),h.postMessage({action:"init",url:l?a.Tools.GetBabylonScriptURL(l):void 0,wasmBinary:R},[R])}))}(u,l,w.JSModuleURL).then(h,R)})).catch(R)}))),await mh),q=async(h,R)=>{const l=h instanceof ArrayBuffer?new Uint8Array(h):h;return await new Promise(((h,j)=>{J().then((()=>{const a=c++,D=R=>{"transcode"===R.data.action&&R.data.id===a&&(u.removeEventListener("message",D),R.data.success?h(R.data):j("Transcode is not supported on this device"))};u.addEventListener("message",D);const U=new Uint8Array(l.byteLength);U.set(new Uint8Array(l.buffer,l.byteOffset,l.byteLength)),u.postMessage({action:"transcode",id:a,imageData:U,config:R,ignoreSupportedFormats:false},[U.buffer])}),(h=>{j(h)}))}))},Q=(h,R)=>{var l;let j=null===(l=R._gl)||void 0===l?void 0:l.TEXTURE_2D;var a;h.isCube&&(j=null===(a=R._gl)||void 0===a?void 0:a.TEXTURE_CUBE_MAP);R._bindTextureDirectly(j,h,!0)},Y=(h,R)=>{const l=h.getEngine();for(let F=0;F<R.fileInfo.images.length;F++){const w=R.fileInfo.images[F].levels[0];if(h._invertVScale=h.invertY,-1===R.format||R.format===j.cTFRGB565)if(h.type=10,h.format=4,!l._features.basisNeedsPOT||Math.log2(w.width)%1===0&&Math.log2(w.height)%1===0)h._invertVScale=!h.invertY,h.width=w.width+3&-4,h.height=w.height+3&-4,h.samplingMode=2,Q(h,l),l._uploadDataToTextureDirectly(h,new Uint16Array(w.transcodedPixels.buffer),F,0,4,!0);else{const R=new U.e(l,2);h._invertVScale=h.invertY,R.type=10,R.format=4,R.width=w.width+3&-4,R.height=w.height+3&-4,Q(R,l),l._uploadDataToTextureDirectly(R,new Uint16Array(w.transcodedPixels.buffer),F,0,4,!0),l._rescaleTexture(R,h,l.scenes[0],l._getInternalFormat(4),(()=>{l._releaseTexture(R),Q(h,l)}))}else{h.width=w.width,h.height=w.height,h.generateMipMaps=R.fileInfo.images[F].levels.length>1;const j=s.GetInternalFormatFromBasisFormat(R.format,l);h.format=j,Q(h,l);const U=R.fileInfo.images[F].levels;for(let R=0;R<U.length;R++){const a=U[R];l._uploadCompressedDataToTextureDirectly(h,j,a.width,a.height,a.transcodedPixels,F,R)}!l._features.basisNeedsPOT||Math.log2(h.width)%1===0&&Math.log2(h.height)%1===0||(a.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),h._cachedWrapU=D.b.CLAMP_ADDRESSMODE,h._cachedWrapV=D.b.CLAMP_ADDRESSMODE)}}},s={JSModuleURL:w.JSModuleURL,WasmModuleURL:w.WasmModuleURL,GetInternalFormatFromBasisFormat:(h,R)=>{let l;switch(h){case j.cTFETC1:l=36196;break;case j.cTFBC1:l=33776;break;case j.cTFBC4:l=33779;break;case j.cTFASTC_4x4:l=37808;break;case j.cTFETC2:l=37496;break;case j.cTFBC7:l=36492}if(void 0===l)throw"The chosen Basis transcoder format is not currently supported";return l},TranscodeAsync:q,LoadTextureFromTranscodeResult:Y};Object.defineProperty(s,"JSModuleURL",{get:function(){return w.JSModuleURL},set:function(h){w.JSModuleURL=h}}),Object.defineProperty(s,"WasmModuleURL",{get:function(){return w.WasmModuleURL},set:function(h){w.WasmModuleURL=h}});class t{constructor(){this.supportCascades=!1}loadCubeData(h,R,l,j,D){if(Array.isArray(h))return;const U=R.getEngine().getCaps(),F={supportedCompressionFormats:{etc1:!!U.etc1,s3tc:!!U.s3tc,pvrtc:!!U.pvrtc,etc2:!!U.etc2,astc:!!U.astc,bc7:!!U.bptc}};q(h,F).then((h=>{const l=h.fileInfo.images[0].levels.length>1&&R.generateMipMaps;Y(R,h),R.getEngine()._setCubeMapTextureParams(R,l),R.isReady=!0,R.onLoadedObservable.notifyObservers(R),R.onLoadedObservable.clear(),j&&j()})).catch((h=>{a.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),R.isReady=!0,D&&D(h)}))}loadData(h,R,l){const j=R.getEngine().getCaps(),D={supportedCompressionFormats:{etc1:!!j.etc1,s3tc:!!j.s3tc,pvrtc:!!j.pvrtc,etc2:!!j.etc2,astc:!!j.astc,bc7:!!j.bptc}};q(h,D).then((h=>{const j=h.fileInfo.images[0].levels[0],a=h.fileInfo.images[0].levels.length>1&&R.generateMipMaps;l(j.width,j.height,a,-1!==h.format,(()=>{Y(R,h)}))})).catch((h=>{a.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),a.Tools.Warn(`Failed to transcode Basis file: ${h}`),l(0,0,!1,!1,(()=>{}),!0)}))}}}}]);