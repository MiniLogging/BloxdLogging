"use strict";(self["1xyrlsr8vb9"]=self["1xyrlsr8vb9"]||[]).push([[47],{14622:(I,O,C)=>{C.r(O),C.d(O,{_BasisTextureLoader:()=>h});var j,K=C(12083),i=C(12245),y=C(12201);function S(){const I=0,O=1,C=2,j=3,K=6,i=8,y=9,S=10,U=14;let p=null;function N(I,O,C,j,K){const i=I.getImageTranscodedSizeInBytes(O,C,j);let y=new Uint8Array(i);if(!I.transcodeImage(y,O,C,j,1,0))return null;if(K){y=function(I,O,C,j){const K=new Uint16Array(4),i=new Uint16Array(C*j),y=C/4,S=j/4;for(let U=0;U<S;U++)for(let j=0;j<y;j++){const S=O+8*(U*y+j);K[0]=I[S]|I[S+1]<<8,K[1]=I[S+2]|I[S+3]<<8,K[2]=(2*(31&K[0])+1*(31&K[1]))/3|(2*(2016&K[0])+1*(2016&K[1]))/3&2016|(2*(63488&K[0])+1*(63488&K[1]))/3&63488,K[3]=(2*(31&K[1])+1*(31&K[0]))/3|(2*(2016&K[1])+1*(2016&K[0]))/3&2016|(2*(63488&K[1])+1*(63488&K[0]))/3&63488;for(let O=0;O<4;O++){const y=I[S+4+O];let p=(4*U+O)*C+4*j;i[p++]=K[3&y],i[p++]=K[y>>2&3],i[p++]=K[y>>4&3],i[p++]=K[y>>6&3]}}return i}(y,0,I.getImageWidth(O,C)+3&-4,I.getImageHeight(O,C)+3&-4)}return y}onmessage=Q=>{if("init"===Q.data.action){if(Q.data.url)try{importScripts(Q.data.url)}catch(s){postMessage({action:"error",error:s})}p||(p=BASIS({wasmBinary:Q.data.wasmBinary})),null!==p&&p.then((I=>{BASIS=I,I.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===Q.data.action){const p=Q.data.config,s=Q.data.imageData,Z=new BASIS.BasisFile(s),q=function(I){const O=I.getHasAlpha(),C=I.getNumImages(),j=[];for(let K=0;K<C;K++){const O={levels:[]},C=I.getNumLevels(K);for(let j=0;j<C;j++){const C={width:I.getImageWidth(K,j),height:I.getImageHeight(K,j)};O.levels.push(C)}j.push(O)}return{mU:O,images:j}}(Z);let mI=Q.data.ignoreSupportedFormats?null:function(p,N){let Q=null;p.supportedCompressionFormats&&(Q=p.supportedCompressionFormats.astc?S:p.supportedCompressionFormats.bc7?K:p.supportedCompressionFormats.s3tc?N.mU?j:C:p.supportedCompressionFormats.pvrtc?N.mU?y:i:p.supportedCompressionFormats.etc2?O:p.supportedCompressionFormats.etc1?I:U);return Q}(Q.data.config,q),E=!1;null===mI&&(E=!0,mI=q.mU?j:C);let h=!0;Z.startTranscoding()||(h=!1);const r=[];for(let I=0;I<q.images.length&&h;I++){const O=q.images[I];if(void 0===p.loadSingleImage||p.loadSingleImage===I){let C=O.levels.length;!1===p.loadMipmapLevels&&(C=1);for(let j=0;j<C;j++){const C=O.levels[j],K=N(Z,I,j,mI,E);if(!K){h=!1;break}C.transcodedPixels=K,r.push(C.transcodedPixels.buffer)}}}Z.close(),Z.delete(),E&&(mI=-1),h?postMessage({action:"transcode",success:h,id:Q.data.id,fileInfo:q,format:mI},r):postMessage({action:"transcode",success:h,id:Q.data.id})}}}!function(I){I[I.cTFETC1=0]="cTFETC1",I[I.cTFETC2=1]="cTFETC2",I[I.cTFBC1=2]="cTFBC1",I[I.cTFBC3=3]="cTFBC3",I[I.cTFBC4=4]="cTFBC4",I[I.cTFBC5=5]="cTFBC5",I[I.cTFBC7=6]="cTFBC7",I[I.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",I[I.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",I[I.cTFASTC_4x4=10]="cTFASTC_4x4",I[I.cTFATC_RGB=11]="cTFATC_RGB",I[I.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",I[I.cTFRGBA32=13]="cTFRGBA32",I[I.cTFRGB565=14]="cTFRGB565",I[I.cTFBGR565=15]="cTFBGR565",I[I.cTFRGBA4444=16]="cTFRGBA4444",I[I.cTFFXT1_RGB=17]="cTFFXT1_RGB",I[I.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",I[I.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",I[I.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",I[I.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(j||(j={}));const U={JSModuleURL:`${K.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${K.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let p=null,N=null,Q=0;const s=async()=>(p||(p=new Promise(((I,O)=>{N?I(N):K.Tools.LoadFileAsync(K.Tools.GetBabylonScriptURL(U.WasmModuleURL)).then((C=>{if("function"!==typeof URL)return O("Basis transcoder requires an environment with a URL constructor");const j=URL.createObjectURL(new Blob([`(${S})()`],{type:"application/javascript"}));N=new Worker(j),async function(I,O,C){return await new Promise(((j,i)=>{const y=O=>{"init"===O.data.action?(I.removeEventListener("message",y),j(I)):"error"===O.data.action&&i(O.data.error||"error initializing worker")};I.addEventListener("message",y),I.postMessage({action:"init",url:C?K.Tools.GetBabylonScriptURL(C):void 0,wasmBinary:O},[O])}))}(N,C,U.JSModuleURL).then(I,O)})).catch(O)}))),await p),Z=async(I,O)=>{const C=I instanceof ArrayBuffer?new Uint8Array(I):I;return await new Promise(((I,j)=>{s().then((()=>{const K=Q++,i=O=>{"transcode"===O.data.action&&O.data.id===K&&(N.removeEventListener("message",i),O.data.success?I(O.data):j("Transcode is not supported on this device"))};N.addEventListener("message",i);const y=new Uint8Array(C.byteLength);y.set(new Uint8Array(C.buffer,C.byteOffset,C.byteLength)),N.postMessage({action:"transcode",id:K,imageData:y,config:O,ignoreSupportedFormats:false},[y.buffer])}),(I=>{j(I)}))}))},q=(I,O)=>{var C;let j=null===(C=O._gl)||void 0===C?void 0:C.TEXTURE_2D;var K;I.isCube&&(j=null===(K=O._gl)||void 0===K?void 0:K.TEXTURE_CUBE_MAP);O._bindTextureDirectly(j,I,!0)},mI=(I,O)=>{const C=I.getEngine();for(let S=0;S<O.fileInfo.images.length;S++){const U=O.fileInfo.images[S].levels[0];if(I._invertVScale=I.invertY,-1===O.format||O.format===j.cTFRGB565)if(I.type=10,I.format=4,!C._features.basisNeedsPOT||Math.log2(U.width)%1===0&&Math.log2(U.height)%1===0)I._invertVScale=!I.invertY,I.width=U.width+3&-4,I.height=U.height+3&-4,I.samplingMode=2,q(I,C),C._uploadDataToTextureDirectly(I,new Uint16Array(U.transcodedPixels.buffer),S,0,4,!0);else{const O=new y.c(C,2);I._invertVScale=I.invertY,O.type=10,O.format=4,O.width=U.width+3&-4,O.height=U.height+3&-4,q(O,C),C._uploadDataToTextureDirectly(O,new Uint16Array(U.transcodedPixels.buffer),S,0,4,!0),C._rescaleTexture(O,I,C.scenes[0],C._getInternalFormat(4),(()=>{C._releaseTexture(O),q(I,C)}))}else{I.width=U.width,I.height=U.height,I.generateMipMaps=O.fileInfo.images[S].levels.length>1;const j=E.GetInternalFormatFromBasisFormat(O.format,C);I.format=j,q(I,C);const y=O.fileInfo.images[S].levels;for(let O=0;O<y.length;O++){const K=y[O];C._uploadCompressedDataToTextureDirectly(I,j,K.width,K.height,K.transcodedPixels,S,O)}!C._features.basisNeedsPOT||Math.log2(I.width)%1===0&&Math.log2(I.height)%1===0||(K.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),I._cachedWrapU=i.e.CLAMP_ADDRESSMODE,I._cachedWrapV=i.e.CLAMP_ADDRESSMODE)}}},E={JSModuleURL:U.JSModuleURL,WasmModuleURL:U.WasmModuleURL,GetInternalFormatFromBasisFormat:(I,O)=>{let C;switch(I){case j.cTFETC1:C=36196;break;case j.cTFBC1:C=33776;break;case j.cTFBC4:C=33779;break;case j.cTFASTC_4x4:C=37808;break;case j.cTFETC2:C=37496;break;case j.cTFBC7:C=36492}if(void 0===C)throw"The chosen Basis transcoder format is not currently supported";return C},TranscodeAsync:Z,LoadTextureFromTranscodeResult:mI};Object.defineProperty(E,"JSModuleURL",{get:function(){return U.JSModuleURL},set:function(I){U.JSModuleURL=I}}),Object.defineProperty(E,"WasmModuleURL",{get:function(){return U.WasmModuleURL},set:function(I){U.WasmModuleURL=I}});class h{constructor(){this.supportCascades=!1}loadCubeData(I,O,C,j,i){if(Array.isArray(I))return;const y=O.getEngine().getCaps(),S={supportedCompressionFormats:{etc1:!!y.etc1,s3tc:!!y.s3tc,pvrtc:!!y.pvrtc,etc2:!!y.etc2,astc:!!y.astc,bc7:!!y.bptc}};Z(I,S).then((I=>{const C=I.fileInfo.images[0].levels.length>1&&O.generateMipMaps;mI(O,I),O.getEngine()._setCubeMapTextureParams(O,C),O.isReady=!0,O.onLoadedObservable.notifyObservers(O),O.onLoadedObservable.clear(),j&&j()})).catch((I=>{K.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),O.isReady=!0,i&&i(I)}))}loadData(I,O,C){const j=O.getEngine().getCaps(),i={supportedCompressionFormats:{etc1:!!j.etc1,s3tc:!!j.s3tc,pvrtc:!!j.pvrtc,etc2:!!j.etc2,astc:!!j.astc,bc7:!!j.bptc}};Z(I,i).then((I=>{const j=I.fileInfo.images[0].levels[0],K=I.fileInfo.images[0].levels.length>1&&O.generateMipMaps;C(j.width,j.height,K,-1!==I.format,(()=>{mI(O,I)}))})).catch((I=>{K.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),K.Tools.Warn(`Failed to transcode Basis file: ${I}`),C(0,0,!1,!1,(()=>{}),!0)}))}}}}]);