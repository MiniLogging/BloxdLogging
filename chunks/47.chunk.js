"use strict";(self["9s4i8ue3jq"]=self["9s4i8ue3jq"]||[]).push([[47],{15221:(a,c,o)=>{o.r(c),o.d(c,{_BasisTextureLoader:()=>y});var s,q=o(12637),t=o(12796),i=o(12757);function p(){const a=0,c=1,o=2,s=3,q=6,t=8,i=9,p=10,G=14;let T=null;function C(a,c,o,s,q){const t=a.getImageTranscodedSizeInBytes(c,o,s);let i=new Uint8Array(t);if(!a.transcodeImage(i,c,o,s,1,0))return null;if(q){i=function(a,c,o,s){const q=new Uint16Array(4),t=new Uint16Array(o*s),i=o/4,p=s/4;for(let G=0;G<p;G++)for(let s=0;s<i;s++){const p=c+8*(G*i+s);q[0]=a[p]|a[p+1]<<8,q[1]=a[p+2]|a[p+3]<<8,q[2]=(2*(31&q[0])+1*(31&q[1]))/3|(2*(2016&q[0])+1*(2016&q[1]))/3&2016|(2*(63488&q[0])+1*(63488&q[1]))/3&63488,q[3]=(2*(31&q[1])+1*(31&q[0]))/3|(2*(2016&q[1])+1*(2016&q[0]))/3&2016|(2*(63488&q[1])+1*(63488&q[0]))/3&63488;for(let c=0;c<4;c++){const i=a[p+4+c];let T=(4*G+c)*o+4*s;t[T++]=q[3&i],t[T++]=q[i>>2&3],t[T++]=q[i>>4&3],t[T++]=q[i>>6&3]}}return t}(i,0,a.getImageWidth(c,o)+3&-4,a.getImageHeight(c,o)+3&-4)}return i}onmessage=j=>{if("init"===j.data.action){if(j.data.url)try{importScripts(j.data.url)}catch(L){postMessage({action:"error",error:L})}T||(T=BASIS({wasmBinary:j.data.wasmBinary})),null!==T&&T.then((a=>{BASIS=a,a.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===j.data.action){const T=j.data.config,L=j.data.imageData,e=new BASIS.BasisFile(L),g=function(a){const c=a.getHasAlpha(),o=a.getNumImages(),s=[];for(let q=0;q<o;q++){const c={levels:[]},o=a.getNumLevels(q);for(let s=0;s<o;s++){const o={width:a.getImageWidth(q,s),height:a.getImageHeight(q,s)};c.levels.push(o)}s.push(c)}return{Uc:c,images:s}}(e);let M=j.data.ignoreSupportedFormats?null:function(T,C){let j=null;T.supportedCompressionFormats&&(j=T.supportedCompressionFormats.astc?p:T.supportedCompressionFormats.bc7?q:T.supportedCompressionFormats.s3tc?C.Uc?s:o:T.supportedCompressionFormats.pvrtc?C.Uc?i:t:T.supportedCompressionFormats.etc2?c:T.supportedCompressionFormats.etc1?a:G);return j}(j.data.config,g),N=!1;null===M&&(N=!0,M=g.Uc?s:o);let y=!0;e.startTranscoding()||(y=!1);const k=[];for(let a=0;a<g.images.length&&y;a++){const c=g.images[a];if(void 0===T.loadSingleImage||T.loadSingleImage===a){let o=c.levels.length;!1===T.loadMipmapLevels&&(o=1);for(let s=0;s<o;s++){const o=c.levels[s],q=C(e,a,s,M,N);if(!q){y=!1;break}o.transcodedPixels=q,k.push(o.transcodedPixels.buffer)}}}e.close(),e.delete(),N&&(M=-1),y?postMessage({action:"transcode",success:y,id:j.data.id,fileInfo:g,format:M},k):postMessage({action:"transcode",success:y,id:j.data.id})}}}!function(a){a[a.cTFETC1=0]="cTFETC1",a[a.cTFETC2=1]="cTFETC2",a[a.cTFBC1=2]="cTFBC1",a[a.cTFBC3=3]="cTFBC3",a[a.cTFBC4=4]="cTFBC4",a[a.cTFBC5=5]="cTFBC5",a[a.cTFBC7=6]="cTFBC7",a[a.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",a[a.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",a[a.cTFASTC_4x4=10]="cTFASTC_4x4",a[a.cTFATC_RGB=11]="cTFATC_RGB",a[a.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",a[a.cTFRGBA32=13]="cTFRGBA32",a[a.cTFRGB565=14]="cTFRGB565",a[a.cTFBGR565=15]="cTFBGR565",a[a.cTFRGBA4444=16]="cTFRGBA4444",a[a.cTFFXT1_RGB=17]="cTFFXT1_RGB",a[a.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",a[a.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",a[a.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",a[a.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(s||(s={}));const G={JSModuleURL:`${q.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${q.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let T=null,C=null,j=0;const L=async()=>(T||(T=new Promise(((a,c)=>{C?a(C):q.Tools.LoadFileAsync(q.Tools.GetBabylonScriptURL(G.WasmModuleURL)).then((o=>{if("function"!==typeof URL)return c("Basis transcoder requires an environment with a URL constructor");const s=URL.createObjectURL(new Blob([`(${p})()`],{type:"application/javascript"}));C=new Worker(s),async function(a,c,o){return await new Promise(((s,t)=>{const i=c=>{"init"===c.data.action?(a.removeEventListener("message",i),s(a)):"error"===c.data.action&&t(c.data.error||"error initializing worker")};a.addEventListener("message",i),a.postMessage({action:"init",url:o?q.Tools.GetBabylonScriptURL(o):void 0,wasmBinary:c},[c])}))}(C,o,G.JSModuleURL).then(a,c)})).catch(c)}))),await T),e=async(a,c)=>{const o=a instanceof ArrayBuffer?new Uint8Array(a):a;return await new Promise(((a,s)=>{L().then((()=>{const q=j++,t=c=>{"transcode"===c.data.action&&c.data.id===q&&(C.removeEventListener("message",t),c.data.success?a(c.data):s("Transcode is not supported on this device"))};C.addEventListener("message",t);const i=new Uint8Array(o.byteLength);i.set(new Uint8Array(o.buffer,o.byteOffset,o.byteLength)),C.postMessage({action:"transcode",id:q,imageData:i,config:c,ignoreSupportedFormats:false},[i.buffer])}),(a=>{s(a)}))}))},g=(a,c)=>{var o;let s=null===(o=c._gl)||void 0===o?void 0:o.TEXTURE_2D;var q;a.isCube&&(s=null===(q=c._gl)||void 0===q?void 0:q.TEXTURE_CUBE_MAP);c._bindTextureDirectly(s,a,!0)},M=(a,c)=>{const o=a.getEngine();for(let p=0;p<c.fileInfo.images.length;p++){const G=c.fileInfo.images[p].levels[0];if(a._invertVScale=a.invertY,-1===c.format||c.format===s.cTFRGB565)if(a.type=10,a.format=4,!o._features.basisNeedsPOT||Math.log2(G.width)%1===0&&Math.log2(G.height)%1===0)a._invertVScale=!a.invertY,a.width=G.width+3&-4,a.height=G.height+3&-4,a.samplingMode=2,g(a,o),o._uploadDataToTextureDirectly(a,new Uint16Array(G.transcodedPixels.buffer),p,0,4,!0);else{const c=new i.b(o,2);a._invertVScale=a.invertY,c.type=10,c.format=4,c.width=G.width+3&-4,c.height=G.height+3&-4,g(c,o),o._uploadDataToTextureDirectly(c,new Uint16Array(G.transcodedPixels.buffer),p,0,4,!0),o._rescaleTexture(c,a,o.scenes[0],o._getInternalFormat(4),(()=>{o._releaseTexture(c),g(a,o)}))}else{a.width=G.width,a.height=G.height,a.generateMipMaps=c.fileInfo.images[p].levels.length>1;const s=N.GetInternalFormatFromBasisFormat(c.format,o);a.format=s,g(a,o);const i=c.fileInfo.images[p].levels;for(let c=0;c<i.length;c++){const q=i[c];o._uploadCompressedDataToTextureDirectly(a,s,q.width,q.height,q.transcodedPixels,p,c)}!o._features.basisNeedsPOT||Math.log2(a.width)%1===0&&Math.log2(a.height)%1===0||(q.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),a._cachedWrapU=t.e.CLAMP_ADDRESSMODE,a._cachedWrapV=t.e.CLAMP_ADDRESSMODE)}}},N={JSModuleURL:G.JSModuleURL,WasmModuleURL:G.WasmModuleURL,GetInternalFormatFromBasisFormat:(a,c)=>{let o;switch(a){case s.cTFETC1:o=36196;break;case s.cTFBC1:o=33776;break;case s.cTFBC4:o=33779;break;case s.cTFASTC_4x4:o=37808;break;case s.cTFETC2:o=37496;break;case s.cTFBC7:o=36492}if(void 0===o)throw"The chosen Basis transcoder format is not currently supported";return o},TranscodeAsync:e,LoadTextureFromTranscodeResult:M};Object.defineProperty(N,"JSModuleURL",{get:function(){return G.JSModuleURL},set:function(a){G.JSModuleURL=a}}),Object.defineProperty(N,"WasmModuleURL",{get:function(){return G.WasmModuleURL},set:function(a){G.WasmModuleURL=a}});class y{constructor(){this.supportCascades=!1}loadCubeData(a,c,o,s,t){if(Array.isArray(a))return;const i=c.getEngine().getCaps(),p={supportedCompressionFormats:{etc1:!!i.etc1,s3tc:!!i.s3tc,pvrtc:!!i.pvrtc,etc2:!!i.etc2,astc:!!i.astc,bc7:!!i.bptc}};e(a,p).then((a=>{const o=a.fileInfo.images[0].levels.length>1&&c.generateMipMaps;M(c,a),c.getEngine()._setCubeMapTextureParams(c,o),c.isReady=!0,c.onLoadedObservable.notifyObservers(c),c.onLoadedObservable.clear(),s&&s()})).catch((a=>{q.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),c.isReady=!0,t&&t(a)}))}loadData(a,c,o){const s=c.getEngine().getCaps(),t={supportedCompressionFormats:{etc1:!!s.etc1,s3tc:!!s.s3tc,pvrtc:!!s.pvrtc,etc2:!!s.etc2,astc:!!s.astc,bc7:!!s.bptc}};e(a,t).then((a=>{const s=a.fileInfo.images[0].levels[0],q=a.fileInfo.images[0].levels.length>1&&c.generateMipMaps;o(s.width,s.height,q,-1!==a.format,(()=>{M(c,a)}))})).catch((a=>{q.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),q.Tools.Warn(`Failed to transcode Basis file: ${a}`),o(0,0,!1,!1,(()=>{}),!0)}))}}}}]);