"use strict";(self.vfdo5lmva5i=self.vfdo5lmva5i||[]).push([[47],{14247:(w,o,H)=>{H.r(o),H.d(o,{_BasisTextureLoader:()=>s});var h,E=H(11531),e=H(11690),D=H(11640);function t(){const w=0,o=1,H=2,h=3,E=6,e=8,D=9,t=10,X=14;let L=null;function A(w,o,H,h,E){const e=w.getImageTranscodedSizeInBytes(o,H,h);let D=new Uint8Array(e);if(!w.transcodeImage(D,o,H,h,1,0))return null;if(E){D=function(w,o,H,h){const E=new Uint16Array(4),e=new Uint16Array(H*h),D=H/4,t=h/4;for(let X=0;X<t;X++)for(let h=0;h<D;h++){const t=o+8*(X*D+h);E[0]=w[t]|w[t+1]<<8,E[1]=w[t+2]|w[t+3]<<8,E[2]=(2*(31&E[0])+1*(31&E[1]))/3|(2*(2016&E[0])+1*(2016&E[1]))/3&2016|(2*(63488&E[0])+1*(63488&E[1]))/3&63488,E[3]=(2*(31&E[1])+1*(31&E[0]))/3|(2*(2016&E[1])+1*(2016&E[0]))/3&2016|(2*(63488&E[1])+1*(63488&E[0]))/3&63488;for(let o=0;o<4;o++){const D=w[t+4+o];let L=(4*X+o)*H+4*h;e[L++]=E[3&D],e[L++]=E[D>>2&3],e[L++]=E[D>>4&3],e[L++]=E[D>>6&3]}}return e}(D,0,w.getImageWidth(o,H)+3&-4,w.getImageHeight(o,H)+3&-4)}return D}onmessage=y=>{if("init"===y.data.action){if(y.data.url)try{importScripts(y.data.url)}catch(z){postMessage({action:"error",error:z})}L||(L=BASIS({wasmBinary:y.data.wasmBinary})),null!==L&&L.then((w=>{BASIS=w,w.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===y.data.action){const L=y.data.config,z=y.data.imageData,C=new BASIS.BasisFile(z),Q=function(w){const o=w.getHasAlpha(),H=w.getNumImages(),h=[];for(let E=0;E<H;E++){const o={levels:[]},H=w.getNumLevels(E);for(let h=0;h<H;h++){const H={width:w.getImageWidth(E,h),height:w.getImageHeight(E,h)};o.levels.push(H)}h.push(o)}return{ze:o,images:h}}(C);let M=y.data.ignoreSupportedFormats?null:function(L,A){let y=null;L.supportedCompressionFormats&&(y=L.supportedCompressionFormats.astc?t:L.supportedCompressionFormats.bc7?E:L.supportedCompressionFormats.s3tc?A.ze?h:H:L.supportedCompressionFormats.pvrtc?A.ze?D:e:L.supportedCompressionFormats.etc2?o:L.supportedCompressionFormats.etc1?w:X);return y}(y.data.config,Q),i=!1;null===M&&(i=!0,M=Q.ze?h:H);let s=!0;C.startTranscoding()||(s=!1);const V=[];for(let w=0;w<Q.images.length&&s;w++){const o=Q.images[w];if(void 0===L.loadSingleImage||L.loadSingleImage===w){let H=o.levels.length;!1===L.loadMipmapLevels&&(H=1);for(let h=0;h<H;h++){const H=o.levels[h],E=A(C,w,h,M,i);if(!E){s=!1;break}H.transcodedPixels=E,V.push(H.transcodedPixels.buffer)}}}C.close(),C.delete(),i&&(M=-1),s?postMessage({action:"transcode",success:s,id:y.data.id,fileInfo:Q,format:M},V):postMessage({action:"transcode",success:s,id:y.data.id})}}}!function(w){w[w.cTFETC1=0]="cTFETC1",w[w.cTFETC2=1]="cTFETC2",w[w.cTFBC1=2]="cTFBC1",w[w.cTFBC3=3]="cTFBC3",w[w.cTFBC4=4]="cTFBC4",w[w.cTFBC5=5]="cTFBC5",w[w.cTFBC7=6]="cTFBC7",w[w.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",w[w.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",w[w.cTFASTC_4x4=10]="cTFASTC_4x4",w[w.cTFATC_RGB=11]="cTFATC_RGB",w[w.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",w[w.cTFRGBA32=13]="cTFRGBA32",w[w.cTFRGB565=14]="cTFRGB565",w[w.cTFBGR565=15]="cTFBGR565",w[w.cTFRGBA4444=16]="cTFRGBA4444",w[w.cTFFXT1_RGB=17]="cTFFXT1_RGB",w[w.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",w[w.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",w[w.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",w[w.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(h||(h={}));const X={JSModuleURL:`${E.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${E.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let L=null,A=null,y=0;const z=async()=>(L||(L=new Promise(((w,o)=>{A?w(A):E.Tools.LoadFileAsync(E.Tools.GetBabylonScriptURL(X.WasmModuleURL)).then((H=>{if("function"!==typeof URL)return o("Basis transcoder requires an environment with a URL constructor");const h=URL.createObjectURL(new Blob([`(${t})()`],{type:"application/javascript"}));A=new Worker(h),async function(w,o,H){return await new Promise(((h,e)=>{const D=o=>{"init"===o.data.action?(w.removeEventListener("message",D),h(w)):"error"===o.data.action&&e(o.data.error||"error initializing worker")};w.addEventListener("message",D),w.postMessage({action:"init",url:H?E.Tools.GetBabylonScriptURL(H):void 0,wasmBinary:o},[o])}))}(A,H,X.JSModuleURL).then(w,o)})).catch(o)}))),await L),C=async(w,o)=>{const H=w instanceof ArrayBuffer?new Uint8Array(w):w;return await new Promise(((w,h)=>{z().then((()=>{const E=y++,e=o=>{"transcode"===o.data.action&&o.data.id===E&&(A.removeEventListener("message",e),o.data.success?w(o.data):h("Transcode is not supported on this device"))};A.addEventListener("message",e);const D=new Uint8Array(H.byteLength);D.set(new Uint8Array(H.buffer,H.byteOffset,H.byteLength)),A.postMessage({action:"transcode",id:E,imageData:D,config:o,ignoreSupportedFormats:false},[D.buffer])}),(w=>{h(w)}))}))},Q=(w,o)=>{var H;let h=null===(H=o._gl)||void 0===H?void 0:H.TEXTURE_2D;var E;w.isCube&&(h=null===(E=o._gl)||void 0===E?void 0:E.TEXTURE_CUBE_MAP);o._bindTextureDirectly(h,w,!0)},M=(w,o)=>{const H=w.getEngine();for(let t=0;t<o.fileInfo.images.length;t++){const X=o.fileInfo.images[t].levels[0];if(w._invertVScale=w.invertY,-1===o.format||o.format===h.cTFRGB565)if(w.type=10,w.format=4,!H._features.basisNeedsPOT||Math.log2(X.width)%1===0&&Math.log2(X.height)%1===0)w._invertVScale=!w.invertY,w.width=X.width+3&-4,w.height=X.height+3&-4,w.samplingMode=2,Q(w,H),H._uploadDataToTextureDirectly(w,new Uint16Array(X.transcodedPixels.buffer),t,0,4,!0);else{const o=new D.c(H,2);w._invertVScale=w.invertY,o.type=10,o.format=4,o.width=X.width+3&-4,o.height=X.height+3&-4,Q(o,H),H._uploadDataToTextureDirectly(o,new Uint16Array(X.transcodedPixels.buffer),t,0,4,!0),H._rescaleTexture(o,w,H.scenes[0],H._getInternalFormat(4),(()=>{H._releaseTexture(o),Q(w,H)}))}else{w.width=X.width,w.height=X.height,w.generateMipMaps=o.fileInfo.images[t].levels.length>1;const h=i.GetInternalFormatFromBasisFormat(o.format,H);w.format=h,Q(w,H);const D=o.fileInfo.images[t].levels;for(let o=0;o<D.length;o++){const E=D[o];H._uploadCompressedDataToTextureDirectly(w,h,E.width,E.height,E.transcodedPixels,t,o)}!H._features.basisNeedsPOT||Math.log2(w.width)%1===0&&Math.log2(w.height)%1===0||(E.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),w._cachedWrapU=e.d.CLAMP_ADDRESSMODE,w._cachedWrapV=e.d.CLAMP_ADDRESSMODE)}}},i={JSModuleURL:X.JSModuleURL,WasmModuleURL:X.WasmModuleURL,GetInternalFormatFromBasisFormat:(w,o)=>{let H;switch(w){case h.cTFETC1:H=36196;break;case h.cTFBC1:H=33776;break;case h.cTFBC4:H=33779;break;case h.cTFASTC_4x4:H=37808;break;case h.cTFETC2:H=37496;break;case h.cTFBC7:H=36492}if(void 0===H)throw"The chosen Basis transcoder format is not currently supported";return H},TranscodeAsync:C,LoadTextureFromTranscodeResult:M};Object.defineProperty(i,"JSModuleURL",{get:function(){return X.JSModuleURL},set:function(w){X.JSModuleURL=w}}),Object.defineProperty(i,"WasmModuleURL",{get:function(){return X.WasmModuleURL},set:function(w){X.WasmModuleURL=w}});class s{constructor(){this.supportCascades=!1}loadCubeData(w,o,H,h,e){if(Array.isArray(w))return;const D=o.getEngine().getCaps(),t={supportedCompressionFormats:{etc1:!!D.etc1,s3tc:!!D.s3tc,pvrtc:!!D.pvrtc,etc2:!!D.etc2,astc:!!D.astc,bc7:!!D.bptc}};C(w,t).then((w=>{const H=w.fileInfo.images[0].levels.length>1&&o.generateMipMaps;M(o,w),o.getEngine()._setCubeMapTextureParams(o,H),o.isReady=!0,o.onLoadedObservable.notifyObservers(o),o.onLoadedObservable.clear(),h&&h()})).catch((w=>{E.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),o.isReady=!0,e&&e(w)}))}loadData(w,o,H){const h=o.getEngine().getCaps(),e={supportedCompressionFormats:{etc1:!!h.etc1,s3tc:!!h.s3tc,pvrtc:!!h.pvrtc,etc2:!!h.etc2,astc:!!h.astc,bc7:!!h.bptc}};C(w,e).then((w=>{const h=w.fileInfo.images[0].levels[0],E=w.fileInfo.images[0].levels.length>1&&o.generateMipMaps;H(h.width,h.height,E,-1!==w.format,(()=>{M(o,w)}))})).catch((w=>{E.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),E.Tools.Warn(`Failed to transcode Basis file: ${w}`),H(0,0,!1,!1,(()=>{}),!0)}))}}}}]);