"use strict";(self["9x1utqq1axc"]=self["9x1utqq1axc"]||[]).push([[47],{14769:(y,c,A)=>{A.r(c),A.d(c,{_BasisTextureLoader:()=>D});var l,w=A(12144),N=A(12303),p=A(12255);function W(){const y=0,c=1,A=2,l=3,w=6,N=8,p=9,W=10,h=14;let I=null;function q(y,c,A,l,w){const N=y.getImageTranscodedSizeInBytes(c,A,l);let p=new Uint8Array(N);if(!y.transcodeImage(p,c,A,l,1,0))return null;if(w){p=function(y,c,A,l){const w=new Uint16Array(4),N=new Uint16Array(A*l),p=A/4,W=l/4;for(let h=0;h<W;h++)for(let l=0;l<p;l++){const W=c+8*(h*p+l);w[0]=y[W]|y[W+1]<<8,w[1]=y[W+2]|y[W+3]<<8,w[2]=(2*(31&w[0])+1*(31&w[1]))/3|(2*(2016&w[0])+1*(2016&w[1]))/3&2016|(2*(63488&w[0])+1*(63488&w[1]))/3&63488,w[3]=(2*(31&w[1])+1*(31&w[0]))/3|(2*(2016&w[1])+1*(2016&w[0]))/3&2016|(2*(63488&w[1])+1*(63488&w[0]))/3&63488;for(let c=0;c<4;c++){const p=y[W+4+c];let I=(4*h+c)*A+4*l;N[I++]=w[3&p],N[I++]=w[p>>2&3],N[I++]=w[p>>4&3],N[I++]=w[p>>6&3]}}return N}(p,0,y.getImageWidth(c,A)+3&-4,y.getImageHeight(c,A)+3&-4)}return p}onmessage=o=>{if("init"===o.data.action){if(o.data.url)try{importScripts(o.data.url)}catch(O){postMessage({action:"error",error:O})}I||(I=BASIS({wasmBinary:o.data.wasmBinary})),null!==I&&I.then((y=>{BASIS=y,y.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===o.data.action){const I=o.data.config,O=o.data.imageData,L=new BASIS.BasisFile(O),i=function(y){const c=y.getHasAlpha(),A=y.getNumImages(),l=[];for(let w=0;w<A;w++){const c={levels:[]},A=y.getNumLevels(w);for(let l=0;l<A;l++){const A={width:y.getImageWidth(w,l),height:y.getImageHeight(w,l)};c.levels.push(A)}l.push(c)}return{Vc:c,images:l}}(L);let H=o.data.ignoreSupportedFormats?null:function(I,q){let o=null;I.supportedCompressionFormats&&(o=I.supportedCompressionFormats.astc?W:I.supportedCompressionFormats.bc7?w:I.supportedCompressionFormats.s3tc?q.Vc?l:A:I.supportedCompressionFormats.pvrtc?q.Vc?p:N:I.supportedCompressionFormats.etc2?c:I.supportedCompressionFormats.etc1?y:h);return o}(o.data.config,i),P=!1;null===H&&(P=!0,H=i.Vc?l:A);let D=!0;L.startTranscoding()||(D=!1);const t=[];for(let y=0;y<i.images.length&&D;y++){const c=i.images[y];if(void 0===I.loadSingleImage||I.loadSingleImage===y){let A=c.levels.length;!1===I.loadMipmapLevels&&(A=1);for(let l=0;l<A;l++){const A=c.levels[l],w=q(L,y,l,H,P);if(!w){D=!1;break}A.transcodedPixels=w,t.push(A.transcodedPixels.buffer)}}}L.close(),L.delete(),P&&(H=-1),D?postMessage({action:"transcode",success:D,id:o.data.id,fileInfo:i,format:H},t):postMessage({action:"transcode",success:D,id:o.data.id})}}}!function(y){y[y.cTFETC1=0]="cTFETC1",y[y.cTFETC2=1]="cTFETC2",y[y.cTFBC1=2]="cTFBC1",y[y.cTFBC3=3]="cTFBC3",y[y.cTFBC4=4]="cTFBC4",y[y.cTFBC5=5]="cTFBC5",y[y.cTFBC7=6]="cTFBC7",y[y.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",y[y.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",y[y.cTFASTC_4x4=10]="cTFASTC_4x4",y[y.cTFATC_RGB=11]="cTFATC_RGB",y[y.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",y[y.cTFRGBA32=13]="cTFRGBA32",y[y.cTFRGB565=14]="cTFRGB565",y[y.cTFBGR565=15]="cTFBGR565",y[y.cTFRGBA4444=16]="cTFRGBA4444",y[y.cTFFXT1_RGB=17]="cTFFXT1_RGB",y[y.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",y[y.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",y[y.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",y[y.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(l||(l={}));const h={JSModuleURL:`${w.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${w.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let I=null,q=null,o=0;const O=async()=>(I||(I=new Promise(((y,c)=>{q?y(q):w.Tools.LoadFileAsync(w.Tools.GetBabylonScriptURL(h.WasmModuleURL)).then((A=>{if("function"!==typeof URL)return c("Basis transcoder requires an environment with a URL constructor");const l=URL.createObjectURL(new Blob([`(${W})()`],{type:"application/javascript"}));q=new Worker(l),async function(y,c,A){return await new Promise(((l,N)=>{const p=c=>{"init"===c.data.action?(y.removeEventListener("message",p),l(y)):"error"===c.data.action&&N(c.data.error||"error initializing worker")};y.addEventListener("message",p),y.postMessage({action:"init",url:A?w.Tools.GetBabylonScriptURL(A):void 0,wasmBinary:c},[c])}))}(q,A,h.JSModuleURL).then(y,c)})).catch(c)}))),await I),L=async(y,c)=>{const A=y instanceof ArrayBuffer?new Uint8Array(y):y;return await new Promise(((y,l)=>{O().then((()=>{const w=o++,N=c=>{"transcode"===c.data.action&&c.data.id===w&&(q.removeEventListener("message",N),c.data.success?y(c.data):l("Transcode is not supported on this device"))};q.addEventListener("message",N);const p=new Uint8Array(A.byteLength);p.set(new Uint8Array(A.buffer,A.byteOffset,A.byteLength)),q.postMessage({action:"transcode",id:w,imageData:p,config:c,ignoreSupportedFormats:false},[p.buffer])}),(y=>{l(y)}))}))},i=(y,c)=>{var A;let l=null===(A=c._gl)||void 0===A?void 0:A.TEXTURE_2D;var w;y.isCube&&(l=null===(w=c._gl)||void 0===w?void 0:w.TEXTURE_CUBE_MAP);c._bindTextureDirectly(l,y,!0)},H=(y,c)=>{const A=y.getEngine();for(let W=0;W<c.fileInfo.images.length;W++){const h=c.fileInfo.images[W].levels[0];if(y._invertVScale=y.invertY,-1===c.format||c.format===l.cTFRGB565)if(y.type=10,y.format=4,!A._features.basisNeedsPOT||Math.log2(h.width)%1===0&&Math.log2(h.height)%1===0)y._invertVScale=!y.invertY,y.width=h.width+3&-4,y.height=h.height+3&-4,y.samplingMode=2,i(y,A),A._uploadDataToTextureDirectly(y,new Uint16Array(h.transcodedPixels.buffer),W,0,4,!0);else{const c=new p.c(A,2);y._invertVScale=y.invertY,c.type=10,c.format=4,c.width=h.width+3&-4,c.height=h.height+3&-4,i(c,A),A._uploadDataToTextureDirectly(c,new Uint16Array(h.transcodedPixels.buffer),W,0,4,!0),A._rescaleTexture(c,y,A.scenes[0],A._getInternalFormat(4),(()=>{A._releaseTexture(c),i(y,A)}))}else{y.width=h.width,y.height=h.height,y.generateMipMaps=c.fileInfo.images[W].levels.length>1;const l=P.GetInternalFormatFromBasisFormat(c.format,A);y.format=l,i(y,A);const p=c.fileInfo.images[W].levels;for(let c=0;c<p.length;c++){const w=p[c];A._uploadCompressedDataToTextureDirectly(y,l,w.width,w.height,w.transcodedPixels,W,c)}!A._features.basisNeedsPOT||Math.log2(y.width)%1===0&&Math.log2(y.height)%1===0||(w.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),y._cachedWrapU=N.d.CLAMP_ADDRESSMODE,y._cachedWrapV=N.d.CLAMP_ADDRESSMODE)}}},P={JSModuleURL:h.JSModuleURL,WasmModuleURL:h.WasmModuleURL,GetInternalFormatFromBasisFormat:(y,c)=>{let A;switch(y){case l.cTFETC1:A=36196;break;case l.cTFBC1:A=33776;break;case l.cTFBC4:A=33779;break;case l.cTFASTC_4x4:A=37808;break;case l.cTFETC2:A=37496;break;case l.cTFBC7:A=36492}if(void 0===A)throw"The chosen Basis transcoder format is not currently supported";return A},TranscodeAsync:L,LoadTextureFromTranscodeResult:H};Object.defineProperty(P,"JSModuleURL",{get:function(){return h.JSModuleURL},set:function(y){h.JSModuleURL=y}}),Object.defineProperty(P,"WasmModuleURL",{get:function(){return h.WasmModuleURL},set:function(y){h.WasmModuleURL=y}});class D{constructor(){this.supportCascades=!1}loadCubeData(y,c,A,l,N){if(Array.isArray(y))return;const p=c.getEngine().getCaps(),W={supportedCompressionFormats:{etc1:!!p.etc1,s3tc:!!p.s3tc,pvrtc:!!p.pvrtc,etc2:!!p.etc2,astc:!!p.astc,bc7:!!p.bptc}};L(y,W).then((y=>{const A=y.fileInfo.images[0].levels.length>1&&c.generateMipMaps;H(c,y),c.getEngine()._setCubeMapTextureParams(c,A),c.isReady=!0,c.onLoadedObservable.notifyObservers(c),c.onLoadedObservable.clear(),l&&l()})).catch((y=>{w.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),c.isReady=!0,N&&N(y)}))}loadData(y,c,A){const l=c.getEngine().getCaps(),N={supportedCompressionFormats:{etc1:!!l.etc1,s3tc:!!l.s3tc,pvrtc:!!l.pvrtc,etc2:!!l.etc2,astc:!!l.astc,bc7:!!l.bptc}};L(y,N).then((y=>{const l=y.fileInfo.images[0].levels[0],w=y.fileInfo.images[0].levels.length>1&&c.generateMipMaps;A(l.width,l.height,w,-1!==y.format,(()=>{H(c,y)}))})).catch((y=>{w.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),w.Tools.Warn(`Failed to transcode Basis file: ${y}`),A(0,0,!1,!1,(()=>{}),!0)}))}}}}]);