"use strict";(self["269hv5nclphh"]=self["269hv5nclphh"]||[]).push([[47],{14842:(E,H,d)=>{d.r(H),d.d(H,{_BasisTextureLoader:()=>L});var n,Z=d(12228),I=d(12366),g=d(12323);function l(){const E=0,H=1,d=2,n=3,Z=6,I=8,g=9,l=10,r=14;let t=null;function S(E,H,d,n,Z){const I=E.getImageTranscodedSizeInBytes(H,d,n);let g=new Uint8Array(I);if(!E.transcodeImage(g,H,d,n,1,0))return null;if(Z){g=function(E,H,d,n){const Z=new Uint16Array(4),I=new Uint16Array(d*n),g=d/4,l=n/4;for(let r=0;r<l;r++)for(let n=0;n<g;n++){const l=H+8*(r*g+n);Z[0]=E[l]|E[l+1]<<8,Z[1]=E[l+2]|E[l+3]<<8,Z[2]=(2*(31&Z[0])+1*(31&Z[1]))/3|(2*(2016&Z[0])+1*(2016&Z[1]))/3&2016|(2*(63488&Z[0])+1*(63488&Z[1]))/3&63488,Z[3]=(2*(31&Z[1])+1*(31&Z[0]))/3|(2*(2016&Z[1])+1*(2016&Z[0]))/3&2016|(2*(63488&Z[1])+1*(63488&Z[0]))/3&63488;for(let H=0;H<4;H++){const g=E[l+4+H];let t=(4*r+H)*d+4*n;I[t++]=Z[3&g],I[t++]=Z[g>>2&3],I[t++]=Z[g>>4&3],I[t++]=Z[g>>6&3]}}return I}(g,0,E.getImageWidth(H,d)+3&-4,E.getImageHeight(H,d)+3&-4)}return g}onmessage=M=>{if("init"===M.data.action){if(M.data.url)try{importScripts(M.data.url)}catch(V){postMessage({action:"error",error:V})}t||(t=BASIS({wasmBinary:M.data.wasmBinary})),null!==t&&t.then((E=>{BASIS=E,E.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===M.data.action){const t=M.data.config,V=M.data.imageData,C=new BASIS.BasisFile(V),w=function(E){const H=E.getHasAlpha(),d=E.getNumImages(),n=[];for(let Z=0;Z<d;Z++){const H={levels:[]},d=E.getNumLevels(Z);for(let n=0;n<d;n++){const d={width:E.getImageWidth(Z,n),height:E.getImageHeight(Z,n)};H.levels.push(d)}n.push(H)}return{Od:H,images:n}}(C);let R=M.data.ignoreSupportedFormats?null:function(t,S){let M=null;t.supportedCompressionFormats&&(M=t.supportedCompressionFormats.astc?l:t.supportedCompressionFormats.bc7?Z:t.supportedCompressionFormats.s3tc?S.Od?n:d:t.supportedCompressionFormats.pvrtc?S.Od?g:I:t.supportedCompressionFormats.etc2?H:t.supportedCompressionFormats.etc1?E:r);return M}(M.data.config,w),Q=!1;null===R&&(Q=!0,R=w.Od?n:d);let L=!0;C.startTranscoding()||(L=!1);const D=[];for(let E=0;E<w.images.length&&L;E++){const H=w.images[E];if(void 0===t.loadSingleImage||t.loadSingleImage===E){let d=H.levels.length;!1===t.loadMipmapLevels&&(d=1);for(let n=0;n<d;n++){const d=H.levels[n],Z=S(C,E,n,R,Q);if(!Z){L=!1;break}d.transcodedPixels=Z,D.push(d.transcodedPixels.buffer)}}}C.close(),C.delete(),Q&&(R=-1),L?postMessage({action:"transcode",success:L,id:M.data.id,fileInfo:w,format:R},D):postMessage({action:"transcode",success:L,id:M.data.id})}}}!function(E){E[E.cTFETC1=0]="cTFETC1",E[E.cTFETC2=1]="cTFETC2",E[E.cTFBC1=2]="cTFBC1",E[E.cTFBC3=3]="cTFBC3",E[E.cTFBC4=4]="cTFBC4",E[E.cTFBC5=5]="cTFBC5",E[E.cTFBC7=6]="cTFBC7",E[E.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",E[E.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",E[E.cTFASTC_4x4=10]="cTFASTC_4x4",E[E.cTFATC_RGB=11]="cTFATC_RGB",E[E.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",E[E.cTFRGBA32=13]="cTFRGBA32",E[E.cTFRGB565=14]="cTFRGB565",E[E.cTFBGR565=15]="cTFBGR565",E[E.cTFRGBA4444=16]="cTFRGBA4444",E[E.cTFFXT1_RGB=17]="cTFFXT1_RGB",E[E.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",E[E.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",E[E.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",E[E.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(n||(n={}));const r={JSModuleURL:`${Z.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${Z.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let t=null,S=null,M=0;const V=async()=>(t||(t=new Promise(((E,H)=>{S?E(S):Z.Tools.LoadFileAsync(Z.Tools.GetBabylonScriptURL(r.WasmModuleURL)).then((d=>{if("function"!==typeof URL)return H("Basis transcoder requires an environment with a URL constructor");const n=URL.createObjectURL(new Blob([`(${l})()`],{type:"application/javascript"}));S=new Worker(n),async function(E,H,d){return await new Promise(((n,I)=>{const g=H=>{"init"===H.data.action?(E.removeEventListener("message",g),n(E)):"error"===H.data.action&&I(H.data.error||"error initializing worker")};E.addEventListener("message",g),E.postMessage({action:"init",url:d?Z.Tools.GetBabylonScriptURL(d):void 0,wasmBinary:H},[H])}))}(S,d,r.JSModuleURL).then(E,H)})).catch(H)}))),await t),C=async(E,H)=>{const d=E instanceof ArrayBuffer?new Uint8Array(E):E;return await new Promise(((E,n)=>{V().then((()=>{const Z=M++,I=H=>{"transcode"===H.data.action&&H.data.id===Z&&(S.removeEventListener("message",I),H.data.success?E(H.data):n("Transcode is not supported on this device"))};S.addEventListener("message",I);const g=new Uint8Array(d.byteLength);g.set(new Uint8Array(d.buffer,d.byteOffset,d.byteLength)),S.postMessage({action:"transcode",id:Z,imageData:g,config:H,ignoreSupportedFormats:false},[g.buffer])}),(E=>{n(E)}))}))},w=(E,H)=>{var d;let n=null===(d=H._gl)||void 0===d?void 0:d.TEXTURE_2D;var Z;E.isCube&&(n=null===(Z=H._gl)||void 0===Z?void 0:Z.TEXTURE_CUBE_MAP);H._bindTextureDirectly(n,E,!0)},R=(E,H)=>{const d=E.getEngine();for(let l=0;l<H.fileInfo.images.length;l++){const r=H.fileInfo.images[l].levels[0];if(E._invertVScale=E.invertY,-1===H.format||H.format===n.cTFRGB565)if(E.type=10,E.format=4,!d._features.basisNeedsPOT||Math.log2(r.width)%1===0&&Math.log2(r.height)%1===0)E._invertVScale=!E.invertY,E.width=r.width+3&-4,E.height=r.height+3&-4,E.samplingMode=2,w(E,d),d._uploadDataToTextureDirectly(E,new Uint16Array(r.transcodedPixels.buffer),l,0,4,!0);else{const H=new g.d(d,2);E._invertVScale=E.invertY,H.type=10,H.format=4,H.width=r.width+3&-4,H.height=r.height+3&-4,w(H,d),d._uploadDataToTextureDirectly(H,new Uint16Array(r.transcodedPixels.buffer),l,0,4,!0),d._rescaleTexture(H,E,d.scenes[0],d._getInternalFormat(4),(()=>{d._releaseTexture(H),w(E,d)}))}else{E.width=r.width,E.height=r.height,E.generateMipMaps=H.fileInfo.images[l].levels.length>1;const n=Q.GetInternalFormatFromBasisFormat(H.format,d);E.format=n,w(E,d);const g=H.fileInfo.images[l].levels;for(let H=0;H<g.length;H++){const Z=g[H];d._uploadCompressedDataToTextureDirectly(E,n,Z.width,Z.height,Z.transcodedPixels,l,H)}!d._features.basisNeedsPOT||Math.log2(E.width)%1===0&&Math.log2(E.height)%1===0||(Z.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),E._cachedWrapU=I.c.CLAMP_ADDRESSMODE,E._cachedWrapV=I.c.CLAMP_ADDRESSMODE)}}},Q={JSModuleURL:r.JSModuleURL,WasmModuleURL:r.WasmModuleURL,GetInternalFormatFromBasisFormat:(E,H)=>{let d;switch(E){case n.cTFETC1:d=36196;break;case n.cTFBC1:d=33776;break;case n.cTFBC4:d=33779;break;case n.cTFASTC_4x4:d=37808;break;case n.cTFETC2:d=37496;break;case n.cTFBC7:d=36492}if(void 0===d)throw"The chosen Basis transcoder format is not currently supported";return d},TranscodeAsync:C,LoadTextureFromTranscodeResult:R};Object.defineProperty(Q,"JSModuleURL",{get:function(){return r.JSModuleURL},set:function(E){r.JSModuleURL=E}}),Object.defineProperty(Q,"WasmModuleURL",{get:function(){return r.WasmModuleURL},set:function(E){r.WasmModuleURL=E}});class L{constructor(){this.supportCascades=!1}loadCubeData(E,H,d,n,I){if(Array.isArray(E))return;const g=H.getEngine().getCaps(),l={supportedCompressionFormats:{etc1:!!g.etc1,s3tc:!!g.s3tc,pvrtc:!!g.pvrtc,etc2:!!g.etc2,astc:!!g.astc,bc7:!!g.bptc}};C(E,l).then((E=>{const d=E.fileInfo.images[0].levels.length>1&&H.generateMipMaps;R(H,E),H.getEngine()._setCubeMapTextureParams(H,d),H.isReady=!0,H.onLoadedObservable.notifyObservers(H),H.onLoadedObservable.clear(),n&&n()})).catch((E=>{Z.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),H.isReady=!0,I&&I(E)}))}loadData(E,H,d){const n=H.getEngine().getCaps(),I={supportedCompressionFormats:{etc1:!!n.etc1,s3tc:!!n.s3tc,pvrtc:!!n.pvrtc,etc2:!!n.etc2,astc:!!n.astc,bc7:!!n.bptc}};C(E,I).then((E=>{const n=E.fileInfo.images[0].levels[0],Z=E.fileInfo.images[0].levels.length>1&&H.generateMipMaps;d(n.width,n.height,Z,-1!==E.format,(()=>{R(H,E)}))})).catch((E=>{Z.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),Z.Tools.Warn(`Failed to transcode Basis file: ${E}`),d(0,0,!1,!1,(()=>{}),!0)}))}}}}]);