"use strict";(self.u4k1rqylno=self.u4k1rqylno||[]).push([[47],{14137:(e,E,H)=>{H.r(E),H.d(E,{_BasisTextureLoader:()=>S});var N,u=H(11532),z=H(11712),P=H(11660);function M(){const e=0,E=1,H=2,N=3,u=6,z=8,P=9,M=10,D=14;let A=null;function C(e,E,H,N,u){const z=e.getImageTranscodedSizeInBytes(E,H,N);let P=new Uint8Array(z);if(!e.transcodeImage(P,E,H,N,1,0))return null;if(u){P=function(e,E,H,N){const u=new Uint16Array(4),z=new Uint16Array(H*N),P=H/4,M=N/4;for(let D=0;D<M;D++)for(let N=0;N<P;N++){const M=E+8*(D*P+N);u[0]=e[M]|e[M+1]<<8,u[1]=e[M+2]|e[M+3]<<8,u[2]=(2*(31&u[0])+1*(31&u[1]))/3|(2*(2016&u[0])+1*(2016&u[1]))/3&2016|(2*(63488&u[0])+1*(63488&u[1]))/3&63488,u[3]=(2*(31&u[1])+1*(31&u[0]))/3|(2*(2016&u[1])+1*(2016&u[0]))/3&2016|(2*(63488&u[1])+1*(63488&u[0]))/3&63488;for(let E=0;E<4;E++){const P=e[M+4+E];let A=(4*D+E)*H+4*N;z[A++]=u[3&P],z[A++]=u[P>>2&3],z[A++]=u[P>>4&3],z[A++]=u[P>>6&3]}}return z}(P,0,e.getImageWidth(E,H)+3&-4,e.getImageHeight(E,H)+3&-4)}return P}onmessage=i=>{if("init"===i.data.action){if(i.data.url)try{importScripts(i.data.url)}catch(V){postMessage({action:"error",error:V})}A||(A=BASIS({wasmBinary:i.data.wasmBinary})),null!==A&&A.then((e=>{BASIS=e,e.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===i.data.action){const A=i.data.config,V=i.data.imageData,U=new BASIS.BasisFile(V),j=function(e){const E=e.getHasAlpha(),H=e.getNumImages(),N=[];for(let u=0;u<H;u++){const E={levels:[]},H=e.getNumLevels(u);for(let N=0;N<H;N++){const H={width:e.getImageWidth(u,N),height:e.getImageHeight(u,N)};E.levels.push(H)}N.push(E)}return{zM:E,images:N}}(U);let F=i.data.ignoreSupportedFormats?null:function(A,C){let i=null;A.supportedCompressionFormats&&(i=A.supportedCompressionFormats.astc?M:A.supportedCompressionFormats.bc7?u:A.supportedCompressionFormats.s3tc?C.zM?N:H:A.supportedCompressionFormats.pvrtc?C.zM?P:z:A.supportedCompressionFormats.etc2?E:A.supportedCompressionFormats.etc1?e:D);return i}(i.data.config,j),h=!1;null===F&&(h=!0,F=j.zM?N:H);let S=!0;U.startTranscoding()||(S=!1);const X=[];for(let e=0;e<j.images.length&&S;e++){const E=j.images[e];if(void 0===A.loadSingleImage||A.loadSingleImage===e){let H=E.levels.length;!1===A.loadMipmapLevels&&(H=1);for(let N=0;N<H;N++){const H=E.levels[N],u=C(U,e,N,F,h);if(!u){S=!1;break}H.transcodedPixels=u,X.push(H.transcodedPixels.buffer)}}}U.close(),U.delete(),h&&(F=-1),S?postMessage({action:"transcode",success:S,id:i.data.id,fileInfo:j,format:F},X):postMessage({action:"transcode",success:S,id:i.data.id})}}}!function(e){e[e.cTFETC1=0]="cTFETC1",e[e.cTFETC2=1]="cTFETC2",e[e.cTFBC1=2]="cTFBC1",e[e.cTFBC3=3]="cTFBC3",e[e.cTFBC4=4]="cTFBC4",e[e.cTFBC5=5]="cTFBC5",e[e.cTFBC7=6]="cTFBC7",e[e.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",e[e.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",e[e.cTFASTC_4x4=10]="cTFASTC_4x4",e[e.cTFATC_RGB=11]="cTFATC_RGB",e[e.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",e[e.cTFRGBA32=13]="cTFRGBA32",e[e.cTFRGB565=14]="cTFRGB565",e[e.cTFBGR565=15]="cTFBGR565",e[e.cTFRGBA4444=16]="cTFRGBA4444",e[e.cTFFXT1_RGB=17]="cTFFXT1_RGB",e[e.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",e[e.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",e[e.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",e[e.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(N||(N={}));const D={JSModuleURL:`${u.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${u.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let A=null,C=null,i=0;const V=async()=>(A||(A=new Promise(((e,E)=>{C?e(C):u.Tools.LoadFileAsync(u.Tools.GetBabylonScriptURL(D.WasmModuleURL)).then((H=>{if("function"!==typeof URL)return E("Basis transcoder requires an environment with a URL constructor");const N=URL.createObjectURL(new Blob([`(${M})()`],{type:"application/javascript"}));C=new Worker(N),async function(e,E,H){return await new Promise(((N,z)=>{const P=E=>{"init"===E.data.action?(e.removeEventListener("message",P),N(e)):"error"===E.data.action&&z(E.data.error||"error initializing worker")};e.addEventListener("message",P),e.postMessage({action:"init",url:H?u.Tools.GetBabylonScriptURL(H):void 0,wasmBinary:E},[E])}))}(C,H,D.JSModuleURL).then(e,E)})).catch(E)}))),await A),U=async(e,E)=>{const H=e instanceof ArrayBuffer?new Uint8Array(e):e;return await new Promise(((e,N)=>{V().then((()=>{const u=i++,z=E=>{"transcode"===E.data.action&&E.data.id===u&&(C.removeEventListener("message",z),E.data.success?e(E.data):N("Transcode is not supported on this device"))};C.addEventListener("message",z);const P=new Uint8Array(H.byteLength);P.set(new Uint8Array(H.buffer,H.byteOffset,H.byteLength)),C.postMessage({action:"transcode",id:u,imageData:P,config:E,ignoreSupportedFormats:false},[P.buffer])}),(e=>{N(e)}))}))},j=(e,E)=>{var H;let N=null===(H=E._gl)||void 0===H?void 0:H.TEXTURE_2D;var u;e.isCube&&(N=null===(u=E._gl)||void 0===u?void 0:u.TEXTURE_CUBE_MAP);E._bindTextureDirectly(N,e,!0)},F=(e,E)=>{const H=e.getEngine();for(let M=0;M<E.fileInfo.images.length;M++){const D=E.fileInfo.images[M].levels[0];if(e._invertVScale=e.invertY,-1===E.format||E.format===N.cTFRGB565)if(e.type=10,e.format=4,!H._features.basisNeedsPOT||Math.log2(D.width)%1===0&&Math.log2(D.height)%1===0)e._invertVScale=!e.invertY,e.width=D.width+3&-4,e.height=D.height+3&-4,e.samplingMode=2,j(e,H),H._uploadDataToTextureDirectly(e,new Uint16Array(D.transcodedPixels.buffer),M,0,4,!0);else{const E=new P.e(H,2);e._invertVScale=e.invertY,E.type=10,E.format=4,E.width=D.width+3&-4,E.height=D.height+3&-4,j(E,H),H._uploadDataToTextureDirectly(E,new Uint16Array(D.transcodedPixels.buffer),M,0,4,!0),H._rescaleTexture(E,e,H.scenes[0],H._getInternalFormat(4),(()=>{H._releaseTexture(E),j(e,H)}))}else{e.width=D.width,e.height=D.height,e.generateMipMaps=E.fileInfo.images[M].levels.length>1;const N=h.GetInternalFormatFromBasisFormat(E.format,H);e.format=N,j(e,H);const P=E.fileInfo.images[M].levels;for(let E=0;E<P.length;E++){const u=P[E];H._uploadCompressedDataToTextureDirectly(e,N,u.width,u.height,u.transcodedPixels,M,E)}!H._features.basisNeedsPOT||Math.log2(e.width)%1===0&&Math.log2(e.height)%1===0||(u.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),e._cachedWrapU=z.b.CLAMP_ADDRESSMODE,e._cachedWrapV=z.b.CLAMP_ADDRESSMODE)}}},h={JSModuleURL:D.JSModuleURL,WasmModuleURL:D.WasmModuleURL,GetInternalFormatFromBasisFormat:(e,E)=>{let H;switch(e){case N.cTFETC1:H=36196;break;case N.cTFBC1:H=33776;break;case N.cTFBC4:H=33779;break;case N.cTFASTC_4x4:H=37808;break;case N.cTFETC2:H=37496;break;case N.cTFBC7:H=36492}if(void 0===H)throw"The chosen Basis transcoder format is not currently supported";return H},TranscodeAsync:U,LoadTextureFromTranscodeResult:F};Object.defineProperty(h,"JSModuleURL",{get:function(){return D.JSModuleURL},set:function(e){D.JSModuleURL=e}}),Object.defineProperty(h,"WasmModuleURL",{get:function(){return D.WasmModuleURL},set:function(e){D.WasmModuleURL=e}});class S{constructor(){this.supportCascades=!1}loadCubeData(e,E,H,N,z){if(Array.isArray(e))return;const P=E.getEngine().getCaps(),M={supportedCompressionFormats:{etc1:!!P.etc1,s3tc:!!P.s3tc,pvrtc:!!P.pvrtc,etc2:!!P.etc2,astc:!!P.astc,bc7:!!P.bptc}};U(e,M).then((e=>{const H=e.fileInfo.images[0].levels.length>1&&E.generateMipMaps;F(E,e),E.getEngine()._setCubeMapTextureParams(E,H),E.isReady=!0,E.onLoadedObservable.notifyObservers(E),E.onLoadedObservable.clear(),N&&N()})).catch((e=>{u.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),E.isReady=!0,z&&z(e)}))}loadData(e,E,H){const N=E.getEngine().getCaps(),z={supportedCompressionFormats:{etc1:!!N.etc1,s3tc:!!N.s3tc,pvrtc:!!N.pvrtc,etc2:!!N.etc2,astc:!!N.astc,bc7:!!N.bptc}};U(e,z).then((e=>{const N=e.fileInfo.images[0].levels[0],u=e.fileInfo.images[0].levels.length>1&&E.generateMipMaps;H(N.width,N.height,u,-1!==e.format,(()=>{F(E,e)}))})).catch((e=>{u.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),u.Tools.Warn(`Failed to transcode Basis file: ${e}`),H(0,0,!1,!1,(()=>{}),!0)}))}}}}]);