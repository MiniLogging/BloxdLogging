"use strict";(self.ex92n20nlz8=self.ex92n20nlz8||[]).push([[47],{15001:(I,g,b)=>{b.r(g),b.d(g,{_BasisTextureLoader:()=>f});var e,c=b(12409),z=b(12572),M=b(12529);function J(){const I=0,g=1,b=2,e=3,c=6,z=8,M=9,J=10,o=14;let n=null;function G(I,g,b,e,c){const z=I.getImageTranscodedSizeInBytes(g,b,e);let M=new Uint8Array(z);if(!I.transcodeImage(M,g,b,e,1,0))return null;if(c){M=function(I,g,b,e){const c=new Uint16Array(4),z=new Uint16Array(b*e),M=b/4,J=e/4;for(let o=0;o<J;o++)for(let e=0;e<M;e++){const J=g+8*(o*M+e);c[0]=I[J]|I[J+1]<<8,c[1]=I[J+2]|I[J+3]<<8,c[2]=(2*(31&c[0])+1*(31&c[1]))/3|(2*(2016&c[0])+1*(2016&c[1]))/3&2016|(2*(63488&c[0])+1*(63488&c[1]))/3&63488,c[3]=(2*(31&c[1])+1*(31&c[0]))/3|(2*(2016&c[1])+1*(2016&c[0]))/3&2016|(2*(63488&c[1])+1*(63488&c[0]))/3&63488;for(let g=0;g<4;g++){const M=I[J+4+g];let n=(4*o+g)*b+4*e;z[n++]=c[3&M],z[n++]=c[M>>2&3],z[n++]=c[M>>4&3],z[n++]=c[M>>6&3]}}return z}(M,0,I.getImageWidth(g,b)+3&-4,I.getImageHeight(g,b)+3&-4)}return M}onmessage=D=>{if("init"===D.data.action){if(D.data.url)try{importScripts(D.data.url)}catch(p){postMessage({action:"error",error:p})}n||(n=BASIS({wasmBinary:D.data.wasmBinary})),null!==n&&n.then((I=>{BASIS=I,I.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===D.data.action){const n=D.data.config,p=D.data.imageData,x=new BASIS.BasisFile(p),Z=function(I){const g=I.getHasAlpha(),b=I.getNumImages(),e=[];for(let c=0;c<b;c++){const g={levels:[]},b=I.getNumLevels(c);for(let e=0;e<b;e++){const b={width:I.getImageWidth(c,e),height:I.getImageHeight(c,e)};g.levels.push(b)}e.push(g)}return{eb:g,images:e}}(x);let k=D.data.ignoreSupportedFormats?null:function(n,G){let D=null;n.supportedCompressionFormats&&(D=n.supportedCompressionFormats.astc?J:n.supportedCompressionFormats.bc7?c:n.supportedCompressionFormats.s3tc?G.eb?e:b:n.supportedCompressionFormats.pvrtc?G.eb?M:z:n.supportedCompressionFormats.etc2?g:n.supportedCompressionFormats.etc1?I:o);return D}(D.data.config,Z),S=!1;null===k&&(S=!0,k=Z.eb?e:b);let f=!0;x.startTranscoding()||(f=!1);const V=[];for(let I=0;I<Z.images.length&&f;I++){const g=Z.images[I];if(void 0===n.loadSingleImage||n.loadSingleImage===I){let b=g.levels.length;!1===n.loadMipmapLevels&&(b=1);for(let e=0;e<b;e++){const b=g.levels[e],c=G(x,I,e,k,S);if(!c){f=!1;break}b.transcodedPixels=c,V.push(b.transcodedPixels.buffer)}}}x.close(),x.delete(),S&&(k=-1),f?postMessage({action:"transcode",success:f,id:D.data.id,fileInfo:Z,format:k},V):postMessage({action:"transcode",success:f,id:D.data.id})}}}!function(I){I[I.cTFETC1=0]="cTFETC1",I[I.cTFETC2=1]="cTFETC2",I[I.cTFBC1=2]="cTFBC1",I[I.cTFBC3=3]="cTFBC3",I[I.cTFBC4=4]="cTFBC4",I[I.cTFBC5=5]="cTFBC5",I[I.cTFBC7=6]="cTFBC7",I[I.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",I[I.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",I[I.cTFASTC_4x4=10]="cTFASTC_4x4",I[I.cTFATC_RGB=11]="cTFATC_RGB",I[I.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",I[I.cTFRGBA32=13]="cTFRGBA32",I[I.cTFRGB565=14]="cTFRGB565",I[I.cTFBGR565=15]="cTFBGR565",I[I.cTFRGBA4444=16]="cTFRGBA4444",I[I.cTFFXT1_RGB=17]="cTFFXT1_RGB",I[I.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",I[I.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",I[I.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",I[I.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(e||(e={}));const o={JSModuleURL:`${c.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${c.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let n=null,G=null,D=0;const p=async()=>(n||(n=new Promise(((I,g)=>{G?I(G):c.Tools.LoadFileAsync(c.Tools.GetBabylonScriptURL(o.WasmModuleURL)).then((b=>{if("function"!==typeof URL)return g("Basis transcoder requires an environment with a URL constructor");const e=URL.createObjectURL(new Blob([`(${J})()`],{type:"application/javascript"}));G=new Worker(e),async function(I,g,b){return await new Promise(((e,z)=>{const M=g=>{"init"===g.data.action?(I.removeEventListener("message",M),e(I)):"error"===g.data.action&&z(g.data.error||"error initializing worker")};I.addEventListener("message",M),I.postMessage({action:"init",url:b?c.Tools.GetBabylonScriptURL(b):void 0,wasmBinary:g},[g])}))}(G,b,o.JSModuleURL).then(I,g)})).catch(g)}))),await n),x=async(I,g)=>{const b=I instanceof ArrayBuffer?new Uint8Array(I):I;return await new Promise(((I,e)=>{p().then((()=>{const c=D++,z=g=>{"transcode"===g.data.action&&g.data.id===c&&(G.removeEventListener("message",z),g.data.success?I(g.data):e("Transcode is not supported on this device"))};G.addEventListener("message",z);const M=new Uint8Array(b.byteLength);M.set(new Uint8Array(b.buffer,b.byteOffset,b.byteLength)),G.postMessage({action:"transcode",id:c,imageData:M,config:g,ignoreSupportedFormats:false},[M.buffer])}),(I=>{e(I)}))}))},Z=(I,g)=>{var b;let e=null===(b=g._gl)||void 0===b?void 0:b.TEXTURE_2D;var c;I.isCube&&(e=null===(c=g._gl)||void 0===c?void 0:c.TEXTURE_CUBE_MAP);g._bindTextureDirectly(e,I,!0)},k=(I,g)=>{const b=I.getEngine();for(let J=0;J<g.fileInfo.images.length;J++){const o=g.fileInfo.images[J].levels[0];if(I._invertVScale=I.invertY,-1===g.format||g.format===e.cTFRGB565)if(I.type=10,I.format=4,!b._features.basisNeedsPOT||Math.log2(o.width)%1===0&&Math.log2(o.height)%1===0)I._invertVScale=!I.invertY,I.width=o.width+3&-4,I.height=o.height+3&-4,I.samplingMode=2,Z(I,b),b._uploadDataToTextureDirectly(I,new Uint16Array(o.transcodedPixels.buffer),J,0,4,!0);else{const g=new M.e(b,2);I._invertVScale=I.invertY,g.type=10,g.format=4,g.width=o.width+3&-4,g.height=o.height+3&-4,Z(g,b),b._uploadDataToTextureDirectly(g,new Uint16Array(o.transcodedPixels.buffer),J,0,4,!0),b._rescaleTexture(g,I,b.scenes[0],b._getInternalFormat(4),(()=>{b._releaseTexture(g),Z(I,b)}))}else{I.width=o.width,I.height=o.height,I.generateMipMaps=g.fileInfo.images[J].levels.length>1;const e=S.GetInternalFormatFromBasisFormat(g.format,b);I.format=e,Z(I,b);const M=g.fileInfo.images[J].levels;for(let g=0;g<M.length;g++){const c=M[g];b._uploadCompressedDataToTextureDirectly(I,e,c.width,c.height,c.transcodedPixels,J,g)}!b._features.basisNeedsPOT||Math.log2(I.width)%1===0&&Math.log2(I.height)%1===0||(c.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),I._cachedWrapU=z.b.CLAMP_ADDRESSMODE,I._cachedWrapV=z.b.CLAMP_ADDRESSMODE)}}},S={JSModuleURL:o.JSModuleURL,WasmModuleURL:o.WasmModuleURL,GetInternalFormatFromBasisFormat:(I,g)=>{let b;switch(I){case e.cTFETC1:b=36196;break;case e.cTFBC1:b=33776;break;case e.cTFBC4:b=33779;break;case e.cTFASTC_4x4:b=37808;break;case e.cTFETC2:b=37496;break;case e.cTFBC7:b=36492}if(void 0===b)throw"The chosen Basis transcoder format is not currently supported";return b},TranscodeAsync:x,LoadTextureFromTranscodeResult:k};Object.defineProperty(S,"JSModuleURL",{get:function(){return o.JSModuleURL},set:function(I){o.JSModuleURL=I}}),Object.defineProperty(S,"WasmModuleURL",{get:function(){return o.WasmModuleURL},set:function(I){o.WasmModuleURL=I}});class f{constructor(){this.supportCascades=!1}loadCubeData(I,g,b,e,z){if(Array.isArray(I))return;const M=g.getEngine().getCaps(),J={supportedCompressionFormats:{etc1:!!M.etc1,s3tc:!!M.s3tc,pvrtc:!!M.pvrtc,etc2:!!M.etc2,astc:!!M.astc,bc7:!!M.bptc}};x(I,J).then((I=>{const b=I.fileInfo.images[0].levels.length>1&&g.generateMipMaps;k(g,I),g.getEngine()._setCubeMapTextureParams(g,b),g.isReady=!0,g.onLoadedObservable.notifyObservers(g),g.onLoadedObservable.clear(),e&&e()})).catch((I=>{c.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),g.isReady=!0,z&&z(I)}))}loadData(I,g,b){const e=g.getEngine().getCaps(),z={supportedCompressionFormats:{etc1:!!e.etc1,s3tc:!!e.s3tc,pvrtc:!!e.pvrtc,etc2:!!e.etc2,astc:!!e.astc,bc7:!!e.bptc}};x(I,z).then((I=>{const e=I.fileInfo.images[0].levels[0],c=I.fileInfo.images[0].levels.length>1&&g.generateMipMaps;b(e.width,e.height,c,-1!==I.format,(()=>{k(g,I)}))})).catch((I=>{c.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),c.Tools.Warn(`Failed to transcode Basis file: ${I}`),b(0,0,!1,!1,(()=>{}),!0)}))}}}}]);