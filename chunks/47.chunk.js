"use strict";(self["3nlrbof8msu"]=self["3nlrbof8msu"]||[]).push([[47],{15171:(t,b,Z)=>{Z.r(b),Z.d(b,{_BasisTextureLoader:()=>u});var J,S=Z(12549),P=Z(12716),v=Z(12663);function h(){const t=0,b=1,Z=2,J=3,S=6,P=8,v=9,h=10,C=14;let Y=null;function g(t,b,Z,J,S){const P=t.getImageTranscodedSizeInBytes(b,Z,J);let v=new Uint8Array(P);if(!t.transcodeImage(v,b,Z,J,1,0))return null;if(S){v=function(t,b,Z,J){const S=new Uint16Array(4),P=new Uint16Array(Z*J),v=Z/4,h=J/4;for(let C=0;C<h;C++)for(let J=0;J<v;J++){const h=b+8*(C*v+J);S[0]=t[h]|t[h+1]<<8,S[1]=t[h+2]|t[h+3]<<8,S[2]=(2*(31&S[0])+1*(31&S[1]))/3|(2*(2016&S[0])+1*(2016&S[1]))/3&2016|(2*(63488&S[0])+1*(63488&S[1]))/3&63488,S[3]=(2*(31&S[1])+1*(31&S[0]))/3|(2*(2016&S[1])+1*(2016&S[0]))/3&2016|(2*(63488&S[1])+1*(63488&S[0]))/3&63488;for(let b=0;b<4;b++){const v=t[h+4+b];let Y=(4*C+b)*Z+4*J;P[Y++]=S[3&v],P[Y++]=S[v>>2&3],P[Y++]=S[v>>4&3],P[Y++]=S[v>>6&3]}}return P}(v,0,t.getImageWidth(b,Z)+3&-4,t.getImageHeight(b,Z)+3&-4)}return v}onmessage=I=>{if("init"===I.data.action){if(I.data.url)try{importScripts(I.data.url)}catch(r){postMessage({action:"error",error:r})}Y||(Y=BASIS({wasmBinary:I.data.wasmBinary})),null!==Y&&Y.then((t=>{BASIS=t,t.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===I.data.action){const Y=I.data.config,r=I.data.imageData,M=new BASIS.BasisFile(r),T=function(t){const b=t.getHasAlpha(),Z=t.getNumImages(),J=[];for(let S=0;S<Z;S++){const b={levels:[]},Z=t.getNumLevels(S);for(let J=0;J<Z;J++){const Z={width:t.getImageWidth(S,J),height:t.getImageHeight(S,J)};b.levels.push(Z)}J.push(b)}return{Vb:b,images:J}}(M);let a=I.data.ignoreSupportedFormats?null:function(Y,g){let I=null;Y.supportedCompressionFormats&&(I=Y.supportedCompressionFormats.astc?h:Y.supportedCompressionFormats.bc7?S:Y.supportedCompressionFormats.s3tc?g.Vb?J:Z:Y.supportedCompressionFormats.pvrtc?g.Vb?v:P:Y.supportedCompressionFormats.etc2?b:Y.supportedCompressionFormats.etc1?t:C);return I}(I.data.config,T),k=!1;null===a&&(k=!0,a=T.Vb?J:Z);let u=!0;M.startTranscoding()||(u=!1);const l=[];for(let t=0;t<T.images.length&&u;t++){const b=T.images[t];if(void 0===Y.loadSingleImage||Y.loadSingleImage===t){let Z=b.levels.length;!1===Y.loadMipmapLevels&&(Z=1);for(let J=0;J<Z;J++){const Z=b.levels[J],S=g(M,t,J,a,k);if(!S){u=!1;break}Z.transcodedPixels=S,l.push(Z.transcodedPixels.buffer)}}}M.close(),M.delete(),k&&(a=-1),u?postMessage({action:"transcode",success:u,id:I.data.id,fileInfo:T,format:a},l):postMessage({action:"transcode",success:u,id:I.data.id})}}}!function(t){t[t.cTFETC1=0]="cTFETC1",t[t.cTFETC2=1]="cTFETC2",t[t.cTFBC1=2]="cTFBC1",t[t.cTFBC3=3]="cTFBC3",t[t.cTFBC4=4]="cTFBC4",t[t.cTFBC5=5]="cTFBC5",t[t.cTFBC7=6]="cTFBC7",t[t.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",t[t.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",t[t.cTFASTC_4x4=10]="cTFASTC_4x4",t[t.cTFATC_RGB=11]="cTFATC_RGB",t[t.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",t[t.cTFRGBA32=13]="cTFRGBA32",t[t.cTFRGB565=14]="cTFRGB565",t[t.cTFBGR565=15]="cTFBGR565",t[t.cTFRGBA4444=16]="cTFRGBA4444",t[t.cTFFXT1_RGB=17]="cTFFXT1_RGB",t[t.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",t[t.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",t[t.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",t[t.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(J||(J={}));const C={JSModuleURL:`${S.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${S.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let Y=null,g=null,I=0;const r=async()=>(Y||(Y=new Promise(((t,b)=>{g?t(g):S.Tools.LoadFileAsync(S.Tools.GetBabylonScriptURL(C.WasmModuleURL)).then((Z=>{if("function"!==typeof URL)return b("Basis transcoder requires an environment with a URL constructor");const J=URL.createObjectURL(new Blob([`(${h})()`],{type:"application/javascript"}));g=new Worker(J),async function(t,b,Z){return await new Promise(((J,P)=>{const v=b=>{"init"===b.data.action?(t.removeEventListener("message",v),J(t)):"error"===b.data.action&&P(b.data.error||"error initializing worker")};t.addEventListener("message",v),t.postMessage({action:"init",url:Z?S.Tools.GetBabylonScriptURL(Z):void 0,wasmBinary:b},[b])}))}(g,Z,C.JSModuleURL).then(t,b)})).catch(b)}))),await Y),M=async(t,b)=>{const Z=t instanceof ArrayBuffer?new Uint8Array(t):t;return await new Promise(((t,J)=>{r().then((()=>{const S=I++,P=b=>{"transcode"===b.data.action&&b.data.id===S&&(g.removeEventListener("message",P),b.data.success?t(b.data):J("Transcode is not supported on this device"))};g.addEventListener("message",P);const v=new Uint8Array(Z.byteLength);v.set(new Uint8Array(Z.buffer,Z.byteOffset,Z.byteLength)),g.postMessage({action:"transcode",id:S,imageData:v,config:b,ignoreSupportedFormats:false},[v.buffer])}),(t=>{J(t)}))}))},T=(t,b)=>{var Z;let J=null===(Z=b._gl)||void 0===Z?void 0:Z.TEXTURE_2D;var S;t.isCube&&(J=null===(S=b._gl)||void 0===S?void 0:S.TEXTURE_CUBE_MAP);b._bindTextureDirectly(J,t,!0)},a=(t,b)=>{const Z=t.getEngine();for(let h=0;h<b.fileInfo.images.length;h++){const C=b.fileInfo.images[h].levels[0];if(t._invertVScale=t.invertY,-1===b.format||b.format===J.cTFRGB565)if(t.type=10,t.format=4,!Z._features.basisNeedsPOT||Math.log2(C.width)%1===0&&Math.log2(C.height)%1===0)t._invertVScale=!t.invertY,t.width=C.width+3&-4,t.height=C.height+3&-4,t.samplingMode=2,T(t,Z),Z._uploadDataToTextureDirectly(t,new Uint16Array(C.transcodedPixels.buffer),h,0,4,!0);else{const b=new v.d(Z,2);t._invertVScale=t.invertY,b.type=10,b.format=4,b.width=C.width+3&-4,b.height=C.height+3&-4,T(b,Z),Z._uploadDataToTextureDirectly(b,new Uint16Array(C.transcodedPixels.buffer),h,0,4,!0),Z._rescaleTexture(b,t,Z.scenes[0],Z._getInternalFormat(4),(()=>{Z._releaseTexture(b),T(t,Z)}))}else{t.width=C.width,t.height=C.height,t.generateMipMaps=b.fileInfo.images[h].levels.length>1;const J=k.GetInternalFormatFromBasisFormat(b.format,Z);t.format=J,T(t,Z);const v=b.fileInfo.images[h].levels;for(let b=0;b<v.length;b++){const S=v[b];Z._uploadCompressedDataToTextureDirectly(t,J,S.width,S.height,S.transcodedPixels,h,b)}!Z._features.basisNeedsPOT||Math.log2(t.width)%1===0&&Math.log2(t.height)%1===0||(S.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),t._cachedWrapU=P.c.CLAMP_ADDRESSMODE,t._cachedWrapV=P.c.CLAMP_ADDRESSMODE)}}},k={JSModuleURL:C.JSModuleURL,WasmModuleURL:C.WasmModuleURL,GetInternalFormatFromBasisFormat:(t,b)=>{let Z;switch(t){case J.cTFETC1:Z=36196;break;case J.cTFBC1:Z=33776;break;case J.cTFBC4:Z=33779;break;case J.cTFASTC_4x4:Z=37808;break;case J.cTFETC2:Z=37496;break;case J.cTFBC7:Z=36492}if(void 0===Z)throw"The chosen Basis transcoder format is not currently supported";return Z},TranscodeAsync:M,LoadTextureFromTranscodeResult:a};Object.defineProperty(k,"JSModuleURL",{get:function(){return C.JSModuleURL},set:function(t){C.JSModuleURL=t}}),Object.defineProperty(k,"WasmModuleURL",{get:function(){return C.WasmModuleURL},set:function(t){C.WasmModuleURL=t}});class u{constructor(){this.supportCascades=!1}loadCubeData(t,b,Z,J,P){if(Array.isArray(t))return;const v=b.getEngine().getCaps(),h={supportedCompressionFormats:{etc1:!!v.etc1,s3tc:!!v.s3tc,pvrtc:!!v.pvrtc,etc2:!!v.etc2,astc:!!v.astc,bc7:!!v.bptc}};M(t,h).then((t=>{const Z=t.fileInfo.images[0].levels.length>1&&b.generateMipMaps;a(b,t),b.getEngine()._setCubeMapTextureParams(b,Z),b.isReady=!0,b.onLoadedObservable.notifyObservers(b),b.onLoadedObservable.clear(),J&&J()})).catch((t=>{S.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),b.isReady=!0,P&&P(t)}))}loadData(t,b,Z){const J=b.getEngine().getCaps(),P={supportedCompressionFormats:{etc1:!!J.etc1,s3tc:!!J.s3tc,pvrtc:!!J.pvrtc,etc2:!!J.etc2,astc:!!J.astc,bc7:!!J.bptc}};M(t,P).then((t=>{const J=t.fileInfo.images[0].levels[0],S=t.fileInfo.images[0].levels.length>1&&b.generateMipMaps;Z(J.width,J.height,S,-1!==t.format,(()=>{a(b,t)}))})).catch((t=>{S.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),S.Tools.Warn(`Failed to transcode Basis file: ${t}`),Z(0,0,!1,!1,(()=>{}),!0)}))}}}}]);