"use strict";(self.fjf2z1c8il8=self.fjf2z1c8il8||[]).push([[47],{14990:(g,i,a)=>{a.r(i),a.d(i,{_BasisTextureLoader:()=>p});var n,L=a(12277),d=a(12436),b=a(12392);function k(){const g=0,i=1,a=2,n=3,L=6,d=8,b=9,k=10,e=14;let N=null;function F(g,i,a,n,L){const d=g.getImageTranscodedSizeInBytes(i,a,n);let b=new Uint8Array(d);if(!g.transcodeImage(b,i,a,n,1,0))return null;if(L){b=function(g,i,a,n){const L=new Uint16Array(4),d=new Uint16Array(a*n),b=a/4,k=n/4;for(let e=0;e<k;e++)for(let n=0;n<b;n++){const k=i+8*(e*b+n);L[0]=g[k]|g[k+1]<<8,L[1]=g[k+2]|g[k+3]<<8,L[2]=(2*(31&L[0])+1*(31&L[1]))/3|(2*(2016&L[0])+1*(2016&L[1]))/3&2016|(2*(63488&L[0])+1*(63488&L[1]))/3&63488,L[3]=(2*(31&L[1])+1*(31&L[0]))/3|(2*(2016&L[1])+1*(2016&L[0]))/3&2016|(2*(63488&L[1])+1*(63488&L[0]))/3&63488;for(let i=0;i<4;i++){const b=g[k+4+i];let N=(4*e+i)*a+4*n;d[N++]=L[3&b],d[N++]=L[b>>2&3],d[N++]=L[b>>4&3],d[N++]=L[b>>6&3]}}return d}(b,0,g.getImageWidth(i,a)+3&-4,g.getImageHeight(i,a)+3&-4)}return b}onmessage=I=>{if("init"===I.data.action){if(I.data.url)try{importScripts(I.data.url)}catch(j){postMessage({action:"error",error:j})}N||(N=BASIS({wasmBinary:I.data.wasmBinary})),null!==N&&N.then((g=>{BASIS=g,g.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===I.data.action){const N=I.data.config,j=I.data.imageData,y=new BASIS.BasisFile(j),B=function(g){const i=g.getHasAlpha(),a=g.getNumImages(),n=[];for(let L=0;L<a;L++){const i={levels:[]},a=g.getNumLevels(L);for(let n=0;n<a;n++){const a={width:g.getImageWidth(L,n),height:g.getImageHeight(L,n)};i.levels.push(a)}n.push(i)}return{Ud:i,images:n}}(y);let c=I.data.ignoreSupportedFormats?null:function(N,F){let I=null;N.supportedCompressionFormats&&(I=N.supportedCompressionFormats.astc?k:N.supportedCompressionFormats.bc7?L:N.supportedCompressionFormats.s3tc?F.Ud?n:a:N.supportedCompressionFormats.pvrtc?F.Ud?b:d:N.supportedCompressionFormats.etc2?i:N.supportedCompressionFormats.etc1?g:e);return I}(I.data.config,B),D=!1;null===c&&(D=!0,c=B.Ud?n:a);let p=!0;y.startTranscoding()||(p=!1);const R=[];for(let g=0;g<B.images.length&&p;g++){const i=B.images[g];if(void 0===N.loadSingleImage||N.loadSingleImage===g){let a=i.levels.length;!1===N.loadMipmapLevels&&(a=1);for(let n=0;n<a;n++){const a=i.levels[n],L=F(y,g,n,c,D);if(!L){p=!1;break}a.transcodedPixels=L,R.push(a.transcodedPixels.buffer)}}}y.close(),y.delete(),D&&(c=-1),p?postMessage({action:"transcode",success:p,id:I.data.id,fileInfo:B,format:c},R):postMessage({action:"transcode",success:p,id:I.data.id})}}}!function(g){g[g.cTFETC1=0]="cTFETC1",g[g.cTFETC2=1]="cTFETC2",g[g.cTFBC1=2]="cTFBC1",g[g.cTFBC3=3]="cTFBC3",g[g.cTFBC4=4]="cTFBC4",g[g.cTFBC5=5]="cTFBC5",g[g.cTFBC7=6]="cTFBC7",g[g.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",g[g.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",g[g.cTFASTC_4x4=10]="cTFASTC_4x4",g[g.cTFATC_RGB=11]="cTFATC_RGB",g[g.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",g[g.cTFRGBA32=13]="cTFRGBA32",g[g.cTFRGB565=14]="cTFRGB565",g[g.cTFBGR565=15]="cTFBGR565",g[g.cTFRGBA4444=16]="cTFRGBA4444",g[g.cTFFXT1_RGB=17]="cTFFXT1_RGB",g[g.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",g[g.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",g[g.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",g[g.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(n||(n={}));const e={JSModuleURL:`${L.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${L.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let N=null,F=null,I=0;const j=async()=>(N||(N=new Promise(((g,i)=>{F?g(F):L.Tools.LoadFileAsync(L.Tools.GetBabylonScriptURL(e.WasmModuleURL)).then((a=>{if("function"!==typeof URL)return i("Basis transcoder requires an environment with a URL constructor");const n=URL.createObjectURL(new Blob([`(${k})()`],{type:"application/javascript"}));F=new Worker(n),async function(g,i,a){return await new Promise(((n,d)=>{const b=i=>{"init"===i.data.action?(g.removeEventListener("message",b),n(g)):"error"===i.data.action&&d(i.data.error||"error initializing worker")};g.addEventListener("message",b),g.postMessage({action:"init",url:a?L.Tools.GetBabylonScriptURL(a):void 0,wasmBinary:i},[i])}))}(F,a,e.JSModuleURL).then(g,i)})).catch(i)}))),await N),y=async(g,i)=>{const a=g instanceof ArrayBuffer?new Uint8Array(g):g;return await new Promise(((g,n)=>{j().then((()=>{const L=I++,d=i=>{"transcode"===i.data.action&&i.data.id===L&&(F.removeEventListener("message",d),i.data.success?g(i.data):n("Transcode is not supported on this device"))};F.addEventListener("message",d);const b=new Uint8Array(a.byteLength);b.set(new Uint8Array(a.buffer,a.byteOffset,a.byteLength)),F.postMessage({action:"transcode",id:L,imageData:b,config:i,ignoreSupportedFormats:false},[b.buffer])}),(g=>{n(g)}))}))},B=(g,i)=>{var a;let n=null===(a=i._gl)||void 0===a?void 0:a.TEXTURE_2D;var L;g.isCube&&(n=null===(L=i._gl)||void 0===L?void 0:L.TEXTURE_CUBE_MAP);i._bindTextureDirectly(n,g,!0)},c=(g,i)=>{const a=g.getEngine();for(let k=0;k<i.fileInfo.images.length;k++){const e=i.fileInfo.images[k].levels[0];if(g._invertVScale=g.invertY,-1===i.format||i.format===n.cTFRGB565)if(g.type=10,g.format=4,!a._features.basisNeedsPOT||Math.log2(e.width)%1===0&&Math.log2(e.height)%1===0)g._invertVScale=!g.invertY,g.width=e.width+3&-4,g.height=e.height+3&-4,g.samplingMode=2,B(g,a),a._uploadDataToTextureDirectly(g,new Uint16Array(e.transcodedPixels.buffer),k,0,4,!0);else{const i=new b.d(a,2);g._invertVScale=g.invertY,i.type=10,i.format=4,i.width=e.width+3&-4,i.height=e.height+3&-4,B(i,a),a._uploadDataToTextureDirectly(i,new Uint16Array(e.transcodedPixels.buffer),k,0,4,!0),a._rescaleTexture(i,g,a.scenes[0],a._getInternalFormat(4),(()=>{a._releaseTexture(i),B(g,a)}))}else{g.width=e.width,g.height=e.height,g.generateMipMaps=i.fileInfo.images[k].levels.length>1;const n=D.GetInternalFormatFromBasisFormat(i.format,a);g.format=n,B(g,a);const b=i.fileInfo.images[k].levels;for(let i=0;i<b.length;i++){const L=b[i];a._uploadCompressedDataToTextureDirectly(g,n,L.width,L.height,L.transcodedPixels,k,i)}!a._features.basisNeedsPOT||Math.log2(g.width)%1===0&&Math.log2(g.height)%1===0||(L.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),g._cachedWrapU=d.c.CLAMP_ADDRESSMODE,g._cachedWrapV=d.c.CLAMP_ADDRESSMODE)}}},D={JSModuleURL:e.JSModuleURL,WasmModuleURL:e.WasmModuleURL,GetInternalFormatFromBasisFormat:(g,i)=>{let a;switch(g){case n.cTFETC1:a=36196;break;case n.cTFBC1:a=33776;break;case n.cTFBC4:a=33779;break;case n.cTFASTC_4x4:a=37808;break;case n.cTFETC2:a=37496;break;case n.cTFBC7:a=36492}if(void 0===a)throw"The chosen Basis transcoder format is not currently supported";return a},TranscodeAsync:y,LoadTextureFromTranscodeResult:c};Object.defineProperty(D,"JSModuleURL",{get:function(){return e.JSModuleURL},set:function(g){e.JSModuleURL=g}}),Object.defineProperty(D,"WasmModuleURL",{get:function(){return e.WasmModuleURL},set:function(g){e.WasmModuleURL=g}});class p{constructor(){this.supportCascades=!1}loadCubeData(g,i,a,n,d){if(Array.isArray(g))return;const b=i.getEngine().getCaps(),k={supportedCompressionFormats:{etc1:!!b.etc1,s3tc:!!b.s3tc,pvrtc:!!b.pvrtc,etc2:!!b.etc2,astc:!!b.astc,bc7:!!b.bptc}};y(g,k).then((g=>{const a=g.fileInfo.images[0].levels.length>1&&i.generateMipMaps;c(i,g),i.getEngine()._setCubeMapTextureParams(i,a),i.isReady=!0,i.onLoadedObservable.notifyObservers(i),i.onLoadedObservable.clear(),n&&n()})).catch((g=>{L.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),i.isReady=!0,d&&d(g)}))}loadData(g,i,a){const n=i.getEngine().getCaps(),d={supportedCompressionFormats:{etc1:!!n.etc1,s3tc:!!n.s3tc,pvrtc:!!n.pvrtc,etc2:!!n.etc2,astc:!!n.astc,bc7:!!n.bptc}};y(g,d).then((g=>{const n=g.fileInfo.images[0].levels[0],L=g.fileInfo.images[0].levels.length>1&&i.generateMipMaps;a(n.width,n.height,L,-1!==g.format,(()=>{c(i,g)}))})).catch((g=>{L.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),L.Tools.Warn(`Failed to transcode Basis file: ${g}`),a(0,0,!1,!1,(()=>{}),!0)}))}}}}]);