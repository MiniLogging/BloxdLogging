"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[47],{13570:(g,w,q)=>{q.r(w),q.d(w,{_BasisTextureLoader:()=>J});var R,o=q(10991),r=q(11152),S=q(11103);function i(){const g=0,w=1,q=2,R=3,o=6,r=8,S=9,i=10,T=14;let z=null;function t(g,w,q,R,o){const r=g.getImageTranscodedSizeInBytes(w,q,R);let S=new Uint8Array(r);if(!g.transcodeImage(S,w,q,R,1,0))return null;if(o){S=function(g,w,q,R){const o=new Uint16Array(4),r=new Uint16Array(q*R),S=q/4,i=R/4;for(let T=0;T<i;T++)for(let R=0;R<S;R++){const i=w+8*(T*S+R);o[0]=g[i]|g[i+1]<<8,o[1]=g[i+2]|g[i+3]<<8,o[2]=(2*(31&o[0])+1*(31&o[1]))/3|(2*(2016&o[0])+1*(2016&o[1]))/3&2016|(2*(63488&o[0])+1*(63488&o[1]))/3&63488,o[3]=(2*(31&o[1])+1*(31&o[0]))/3|(2*(2016&o[1])+1*(2016&o[0]))/3&2016|(2*(63488&o[1])+1*(63488&o[0]))/3&63488;for(let w=0;w<4;w++){const S=g[i+4+w];let z=(4*T+w)*q+4*R;r[z++]=o[3&S],r[z++]=o[S>>2&3],r[z++]=o[S>>4&3],r[z++]=o[S>>6&3]}}return r}(S,0,g.getImageWidth(w,q)+3&-4,g.getImageHeight(w,q)+3&-4)}return S}onmessage=m=>{if("init"===m.data.action){if(m.data.url)try{importScripts(m.data.url)}catch(e){postMessage({action:"error",error:e})}z||(z=BASIS({wasmBinary:m.data.wasmBinary})),null!==z&&z.then((g=>{BASIS=g,g.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===m.data.action){const z=m.data.config,e=m.data.imageData,y=new BASIS.BasisFile(e),L=function(g){const w=g.getHasAlpha(),q=g.getNumImages(),R=[];for(let o=0;o<q;o++){const w={levels:[]},q=g.getNumLevels(o);for(let R=0;R<q;R++){const q={width:g.getImageWidth(o,R),height:g.getImageHeight(o,R)};w.levels.push(q)}R.push(w)}return{oi:w,images:R}}(y);let A=m.data.ignoreSupportedFormats?null:function(z,t){let m=null;z.supportedCompressionFormats&&(m=z.supportedCompressionFormats.astc?i:z.supportedCompressionFormats.bc7?o:z.supportedCompressionFormats.s3tc?t.oi?R:q:z.supportedCompressionFormats.pvrtc?t.oi?S:r:z.supportedCompressionFormats.etc2?w:z.supportedCompressionFormats.etc1?g:T);return m}(m.data.config,L),l=!1;null===A&&(l=!0,A=L.oi?R:q);let J=!0;y.startTranscoding()||(J=!1);const x=[];for(let g=0;g<L.images.length&&J;g++){const w=L.images[g];if(void 0===z.loadSingleImage||z.loadSingleImage===g){let q=w.levels.length;!1===z.loadMipmapLevels&&(q=1);for(let R=0;R<q;R++){const q=w.levels[R],o=t(y,g,R,A,l);if(!o){J=!1;break}q.transcodedPixels=o,x.push(q.transcodedPixels.buffer)}}}y.close(),y.delete(),l&&(A=-1),J?postMessage({action:"transcode",success:J,id:m.data.id,fileInfo:L,format:A},x):postMessage({action:"transcode",success:J,id:m.data.id})}}}!function(g){g[g.cTFETC1=0]="cTFETC1",g[g.cTFETC2=1]="cTFETC2",g[g.cTFBC1=2]="cTFBC1",g[g.cTFBC3=3]="cTFBC3",g[g.cTFBC4=4]="cTFBC4",g[g.cTFBC5=5]="cTFBC5",g[g.cTFBC7=6]="cTFBC7",g[g.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",g[g.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",g[g.cTFASTC_4x4=10]="cTFASTC_4x4",g[g.cTFATC_RGB=11]="cTFATC_RGB",g[g.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",g[g.cTFRGBA32=13]="cTFRGBA32",g[g.cTFRGB565=14]="cTFRGB565",g[g.cTFBGR565=15]="cTFBGR565",g[g.cTFRGBA4444=16]="cTFRGBA4444",g[g.cTFFXT1_RGB=17]="cTFFXT1_RGB",g[g.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",g[g.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",g[g.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",g[g.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(R||(R={}));const T={JSModuleURL:`${o.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${o.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let z=null,t=null,m=0;const e=async()=>(z||(z=new Promise(((g,w)=>{t?g(t):o.Tools.LoadFileAsync(o.Tools.GetBabylonScriptURL(T.WasmModuleURL)).then((q=>{if("function"!==typeof URL)return w("Basis transcoder requires an environment with a URL constructor");const R=URL.createObjectURL(new Blob([`(${i})()`],{type:"application/javascript"}));t=new Worker(R),async function(g,w,q){return await new Promise(((R,r)=>{const S=w=>{"init"===w.data.action?(g.removeEventListener("message",S),R(g)):"error"===w.data.action&&r(w.data.error||"error initializing worker")};g.addEventListener("message",S),g.postMessage({action:"init",url:q?o.Tools.GetBabylonScriptURL(q):void 0,wasmBinary:w},[w])}))}(t,q,T.JSModuleURL).then(g,w)})).catch(w)}))),await z),y=async(g,w)=>{const q=g instanceof ArrayBuffer?new Uint8Array(g):g;return await new Promise(((g,R)=>{e().then((()=>{const o=m++,r=w=>{"transcode"===w.data.action&&w.data.id===o&&(t.removeEventListener("message",r),w.data.success?g(w.data):R("Transcode is not supported on this device"))};t.addEventListener("message",r);const S=new Uint8Array(q.byteLength);S.set(new Uint8Array(q.buffer,q.byteOffset,q.byteLength)),t.postMessage({action:"transcode",id:o,imageData:S,config:w,ignoreSupportedFormats:false},[S.buffer])}),(g=>{R(g)}))}))},L=(g,w)=>{var q;let R=null===(q=w._gl)||void 0===q?void 0:q.TEXTURE_2D;var o;g.isCube&&(R=null===(o=w._gl)||void 0===o?void 0:o.TEXTURE_CUBE_MAP);w._bindTextureDirectly(R,g,!0)},A=(g,w)=>{const q=g.getEngine();for(let i=0;i<w.fileInfo.images.length;i++){const T=w.fileInfo.images[i].levels[0];if(g._invertVScale=g.invertY,-1===w.format||w.format===R.cTFRGB565)if(g.type=10,g.format=4,!q._features.basisNeedsPOT||Math.log2(T.width)%1===0&&Math.log2(T.height)%1===0)g._invertVScale=!g.invertY,g.width=T.width+3&-4,g.height=T.height+3&-4,g.samplingMode=2,L(g,q),q._uploadDataToTextureDirectly(g,new Uint16Array(T.transcodedPixels.buffer),i,0,4,!0);else{const w=new S.d(q,2);g._invertVScale=g.invertY,w.type=10,w.format=4,w.width=T.width+3&-4,w.height=T.height+3&-4,L(w,q),q._uploadDataToTextureDirectly(w,new Uint16Array(T.transcodedPixels.buffer),i,0,4,!0),q._rescaleTexture(w,g,q.scenes[0],q._getInternalFormat(4),(()=>{q._releaseTexture(w),L(g,q)}))}else{g.width=T.width,g.height=T.height,g.generateMipMaps=w.fileInfo.images[i].levels.length>1;const R=l.GetInternalFormatFromBasisFormat(w.format,q);g.format=R,L(g,q);const S=w.fileInfo.images[i].levels;for(let w=0;w<S.length;w++){const o=S[w];q._uploadCompressedDataToTextureDirectly(g,R,o.width,o.height,o.transcodedPixels,i,w)}!q._features.basisNeedsPOT||Math.log2(g.width)%1===0&&Math.log2(g.height)%1===0||(o.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),g._cachedWrapU=r.e.CLAMP_ADDRESSMODE,g._cachedWrapV=r.e.CLAMP_ADDRESSMODE)}}},l={JSModuleURL:T.JSModuleURL,WasmModuleURL:T.WasmModuleURL,GetInternalFormatFromBasisFormat:(g,w)=>{let q;switch(g){case R.cTFETC1:q=36196;break;case R.cTFBC1:q=33776;break;case R.cTFBC4:q=33779;break;case R.cTFASTC_4x4:q=37808;break;case R.cTFETC2:q=37496;break;case R.cTFBC7:q=36492}if(void 0===q)throw"The chosen Basis transcoder format is not currently supported";return q},TranscodeAsync:y,LoadTextureFromTranscodeResult:A};Object.defineProperty(l,"JSModuleURL",{get:function(){return T.JSModuleURL},set:function(g){T.JSModuleURL=g}}),Object.defineProperty(l,"WasmModuleURL",{get:function(){return T.WasmModuleURL},set:function(g){T.WasmModuleURL=g}});class J{constructor(){this.supportCascades=!1}loadCubeData(g,w,q,R,r){if(Array.isArray(g))return;const S=w.getEngine().getCaps(),i={supportedCompressionFormats:{etc1:!!S.etc1,s3tc:!!S.s3tc,pvrtc:!!S.pvrtc,etc2:!!S.etc2,astc:!!S.astc,bc7:!!S.bptc}};y(g,i).then((g=>{const q=g.fileInfo.images[0].levels.length>1&&w.generateMipMaps;A(w,g),w.getEngine()._setCubeMapTextureParams(w,q),w.isReady=!0,w.onLoadedObservable.notifyObservers(w),w.onLoadedObservable.clear(),R&&R()})).catch((g=>{o.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),w.isReady=!0,r&&r(g)}))}loadData(g,w,q){const R=w.getEngine().getCaps(),r={supportedCompressionFormats:{etc1:!!R.etc1,s3tc:!!R.s3tc,pvrtc:!!R.pvrtc,etc2:!!R.etc2,astc:!!R.astc,bc7:!!R.bptc}};y(g,r).then((g=>{const R=g.fileInfo.images[0].levels[0],o=g.fileInfo.images[0].levels.length>1&&w.generateMipMaps;q(R.width,R.height,o,-1!==g.format,(()=>{A(w,g)}))})).catch((g=>{o.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),o.Tools.Warn(`Failed to transcode Basis file: ${g}`),q(0,0,!1,!1,(()=>{}),!0)}))}}}}]);