"use strict";(self.vb3rpbgyozo=self.vb3rpbgyozo||[]).push([[47],{15197:(q,I,l)=>{l.r(I),l.d(I,{_BasisTextureLoader:()=>U});var w,t=l(12564),O=l(12733),c=l(12687);function a(){const q=0,I=1,l=2,w=3,t=6,O=8,c=9,a=10,F=14;let s=null;function Z(q,I,l,w,t){const O=q.getImageTranscodedSizeInBytes(I,l,w);let c=new Uint8Array(O);if(!q.transcodeImage(c,I,l,w,1,0))return null;if(t){c=function(q,I,l,w){const t=new Uint16Array(4),O=new Uint16Array(l*w),c=l/4,a=w/4;for(let F=0;F<a;F++)for(let w=0;w<c;w++){const a=I+8*(F*c+w);t[0]=q[a]|q[a+1]<<8,t[1]=q[a+2]|q[a+3]<<8,t[2]=(2*(31&t[0])+1*(31&t[1]))/3|(2*(2016&t[0])+1*(2016&t[1]))/3&2016|(2*(63488&t[0])+1*(63488&t[1]))/3&63488,t[3]=(2*(31&t[1])+1*(31&t[0]))/3|(2*(2016&t[1])+1*(2016&t[0]))/3&2016|(2*(63488&t[1])+1*(63488&t[0]))/3&63488;for(let I=0;I<4;I++){const c=q[a+4+I];let s=(4*F+I)*l+4*w;O[s++]=t[3&c],O[s++]=t[c>>2&3],O[s++]=t[c>>4&3],O[s++]=t[c>>6&3]}}return O}(c,0,q.getImageWidth(I,l)+3&-4,q.getImageHeight(I,l)+3&-4)}return c}onmessage=r=>{if("init"===r.data.action){if(r.data.url)try{importScripts(r.data.url)}catch(x){postMessage({action:"error",error:x})}s||(s=BASIS({wasmBinary:r.data.wasmBinary})),null!==s&&s.then((q=>{BASIS=q,q.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===r.data.action){const s=r.data.config,x=r.data.imageData,o=new BASIS.BasisFile(x),d=function(q){const I=q.getHasAlpha(),l=q.getNumImages(),w=[];for(let t=0;t<l;t++){const I={levels:[]},l=q.getNumLevels(t);for(let w=0;w<l;w++){const l={width:q.getImageWidth(t,w),height:q.getImageHeight(t,w)};I.levels.push(l)}w.push(I)}return{Bc:I,images:w}}(o);let T=r.data.ignoreSupportedFormats?null:function(s,Z){let r=null;s.supportedCompressionFormats&&(r=s.supportedCompressionFormats.astc?a:s.supportedCompressionFormats.bc7?t:s.supportedCompressionFormats.s3tc?Z.Bc?w:l:s.supportedCompressionFormats.pvrtc?Z.Bc?c:O:s.supportedCompressionFormats.etc2?I:s.supportedCompressionFormats.etc1?q:F);return r}(r.data.config,d),V=!1;null===T&&(V=!0,T=d.Bc?w:l);let U=!0;o.startTranscoding()||(U=!1);const B=[];for(let q=0;q<d.images.length&&U;q++){const I=d.images[q];if(void 0===s.loadSingleImage||s.loadSingleImage===q){let l=I.levels.length;!1===s.loadMipmapLevels&&(l=1);for(let w=0;w<l;w++){const l=I.levels[w],t=Z(o,q,w,T,V);if(!t){U=!1;break}l.transcodedPixels=t,B.push(l.transcodedPixels.buffer)}}}o.close(),o.delete(),V&&(T=-1),U?postMessage({action:"transcode",success:U,id:r.data.id,fileInfo:d,format:T},B):postMessage({action:"transcode",success:U,id:r.data.id})}}}!function(q){q[q.cTFETC1=0]="cTFETC1",q[q.cTFETC2=1]="cTFETC2",q[q.cTFBC1=2]="cTFBC1",q[q.cTFBC3=3]="cTFBC3",q[q.cTFBC4=4]="cTFBC4",q[q.cTFBC5=5]="cTFBC5",q[q.cTFBC7=6]="cTFBC7",q[q.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",q[q.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",q[q.cTFASTC_4x4=10]="cTFASTC_4x4",q[q.cTFATC_RGB=11]="cTFATC_RGB",q[q.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",q[q.cTFRGBA32=13]="cTFRGBA32",q[q.cTFRGB565=14]="cTFRGB565",q[q.cTFBGR565=15]="cTFBGR565",q[q.cTFRGBA4444=16]="cTFRGBA4444",q[q.cTFFXT1_RGB=17]="cTFFXT1_RGB",q[q.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",q[q.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",q[q.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",q[q.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(w||(w={}));const F={JSModuleURL:`${t.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${t.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let s=null,Z=null,r=0;const x=async()=>(s||(s=new Promise(((q,I)=>{Z?q(Z):t.Tools.LoadFileAsync(t.Tools.GetBabylonScriptURL(F.WasmModuleURL)).then((l=>{if("function"!==typeof URL)return I("Basis transcoder requires an environment with a URL constructor");const w=URL.createObjectURL(new Blob([`(${a})()`],{type:"application/javascript"}));Z=new Worker(w),async function(q,I,l){return await new Promise(((w,O)=>{const c=I=>{"init"===I.data.action?(q.removeEventListener("message",c),w(q)):"error"===I.data.action&&O(I.data.error||"error initializing worker")};q.addEventListener("message",c),q.postMessage({action:"init",url:l?t.Tools.GetBabylonScriptURL(l):void 0,wasmBinary:I},[I])}))}(Z,l,F.JSModuleURL).then(q,I)})).catch(I)}))),await s),o=async(q,I)=>{const l=q instanceof ArrayBuffer?new Uint8Array(q):q;return await new Promise(((q,w)=>{x().then((()=>{const t=r++,O=I=>{"transcode"===I.data.action&&I.data.id===t&&(Z.removeEventListener("message",O),I.data.success?q(I.data):w("Transcode is not supported on this device"))};Z.addEventListener("message",O);const c=new Uint8Array(l.byteLength);c.set(new Uint8Array(l.buffer,l.byteOffset,l.byteLength)),Z.postMessage({action:"transcode",id:t,imageData:c,config:I,ignoreSupportedFormats:false},[c.buffer])}),(q=>{w(q)}))}))},d=(q,I)=>{var l;let w=null===(l=I._gl)||void 0===l?void 0:l.TEXTURE_2D;var t;q.isCube&&(w=null===(t=I._gl)||void 0===t?void 0:t.TEXTURE_CUBE_MAP);I._bindTextureDirectly(w,q,!0)},T=(q,I)=>{const l=q.getEngine();for(let a=0;a<I.fileInfo.images.length;a++){const F=I.fileInfo.images[a].levels[0];if(q._invertVScale=q.invertY,-1===I.format||I.format===w.cTFRGB565)if(q.type=10,q.format=4,!l._features.basisNeedsPOT||Math.log2(F.width)%1===0&&Math.log2(F.height)%1===0)q._invertVScale=!q.invertY,q.width=F.width+3&-4,q.height=F.height+3&-4,q.samplingMode=2,d(q,l),l._uploadDataToTextureDirectly(q,new Uint16Array(F.transcodedPixels.buffer),a,0,4,!0);else{const I=new c.b(l,2);q._invertVScale=q.invertY,I.type=10,I.format=4,I.width=F.width+3&-4,I.height=F.height+3&-4,d(I,l),l._uploadDataToTextureDirectly(I,new Uint16Array(F.transcodedPixels.buffer),a,0,4,!0),l._rescaleTexture(I,q,l.scenes[0],l._getInternalFormat(4),(()=>{l._releaseTexture(I),d(q,l)}))}else{q.width=F.width,q.height=F.height,q.generateMipMaps=I.fileInfo.images[a].levels.length>1;const w=V.GetInternalFormatFromBasisFormat(I.format,l);q.format=w,d(q,l);const c=I.fileInfo.images[a].levels;for(let I=0;I<c.length;I++){const t=c[I];l._uploadCompressedDataToTextureDirectly(q,w,t.width,t.height,t.transcodedPixels,a,I)}!l._features.basisNeedsPOT||Math.log2(q.width)%1===0&&Math.log2(q.height)%1===0||(t.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),q._cachedWrapU=O.d.CLAMP_ADDRESSMODE,q._cachedWrapV=O.d.CLAMP_ADDRESSMODE)}}},V={JSModuleURL:F.JSModuleURL,WasmModuleURL:F.WasmModuleURL,GetInternalFormatFromBasisFormat:(q,I)=>{let l;switch(q){case w.cTFETC1:l=36196;break;case w.cTFBC1:l=33776;break;case w.cTFBC4:l=33779;break;case w.cTFASTC_4x4:l=37808;break;case w.cTFETC2:l=37496;break;case w.cTFBC7:l=36492}if(void 0===l)throw"The chosen Basis transcoder format is not currently supported";return l},TranscodeAsync:o,LoadTextureFromTranscodeResult:T};Object.defineProperty(V,"JSModuleURL",{get:function(){return F.JSModuleURL},set:function(q){F.JSModuleURL=q}}),Object.defineProperty(V,"WasmModuleURL",{get:function(){return F.WasmModuleURL},set:function(q){F.WasmModuleURL=q}});class U{constructor(){this.supportCascades=!1}loadCubeData(q,I,l,w,O){if(Array.isArray(q))return;const c=I.getEngine().getCaps(),a={supportedCompressionFormats:{etc1:!!c.etc1,s3tc:!!c.s3tc,pvrtc:!!c.pvrtc,etc2:!!c.etc2,astc:!!c.astc,bc7:!!c.bptc}};o(q,a).then((q=>{const l=q.fileInfo.images[0].levels.length>1&&I.generateMipMaps;T(I,q),I.getEngine()._setCubeMapTextureParams(I,l),I.isReady=!0,I.onLoadedObservable.notifyObservers(I),I.onLoadedObservable.clear(),w&&w()})).catch((q=>{t.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),I.isReady=!0,O&&O(q)}))}loadData(q,I,l){const w=I.getEngine().getCaps(),O={supportedCompressionFormats:{etc1:!!w.etc1,s3tc:!!w.s3tc,pvrtc:!!w.pvrtc,etc2:!!w.etc2,astc:!!w.astc,bc7:!!w.bptc}};o(q,O).then((q=>{const w=q.fileInfo.images[0].levels[0],t=q.fileInfo.images[0].levels.length>1&&I.generateMipMaps;l(w.width,w.height,t,-1!==q.format,(()=>{T(I,q)}))})).catch((q=>{t.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),t.Tools.Warn(`Failed to transcode Basis file: ${q}`),l(0,0,!1,!1,(()=>{}),!0)}))}}}}]);