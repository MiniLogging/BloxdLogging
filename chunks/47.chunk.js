"use strict";(self.mo7o6813fhb=self.mo7o6813fhb||[]).push([[47],{14609:(t,U,y)=>{y.r(U),y.d(U,{_BasisTextureLoader:()=>D});var I,r=y(12198),Y=y(12361),mt=y(12320);function X(){const t=0,U=1,y=2,I=3,r=6,Y=8,mt=9,X=10,P=14;let G=null;function M(t,U,y,I,r){const Y=t.getImageTranscodedSizeInBytes(U,y,I);let mt=new Uint8Array(Y);if(!t.transcodeImage(mt,U,y,I,1,0))return null;if(r){mt=function(t,U,y,I){const r=new Uint16Array(4),Y=new Uint16Array(y*I),mt=y/4,X=I/4;for(let P=0;P<X;P++)for(let I=0;I<mt;I++){const X=U+8*(P*mt+I);r[0]=t[X]|t[X+1]<<8,r[1]=t[X+2]|t[X+3]<<8,r[2]=(2*(31&r[0])+1*(31&r[1]))/3|(2*(2016&r[0])+1*(2016&r[1]))/3&2016|(2*(63488&r[0])+1*(63488&r[1]))/3&63488,r[3]=(2*(31&r[1])+1*(31&r[0]))/3|(2*(2016&r[1])+1*(2016&r[0]))/3&2016|(2*(63488&r[1])+1*(63488&r[0]))/3&63488;for(let U=0;U<4;U++){const mt=t[X+4+U];let G=(4*P+U)*y+4*I;Y[G++]=r[3&mt],Y[G++]=r[mt>>2&3],Y[G++]=r[mt>>4&3],Y[G++]=r[mt>>6&3]}}return Y}(mt,0,t.getImageWidth(U,y)+3&-4,t.getImageHeight(U,y)+3&-4)}return mt}onmessage=L=>{if("init"===L.data.action){if(L.data.url)try{importScripts(L.data.url)}catch(h){postMessage({action:"error",error:h})}G||(G=BASIS({wasmBinary:L.data.wasmBinary})),null!==G&&G.then((t=>{BASIS=t,t.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===L.data.action){const G=L.data.config,h=L.data.imageData,Q=new BASIS.BasisFile(h),F=function(t){const U=t.getHasAlpha(),y=t.getNumImages(),I=[];for(let r=0;r<y;r++){const U={levels:[]},y=t.getNumLevels(r);for(let I=0;I<y;I++){const y={width:t.getImageWidth(r,I),height:t.getImageHeight(r,I)};U.levels.push(y)}I.push(U)}return{pX:U,images:I}}(Q);let E=L.data.ignoreSupportedFormats?null:function(G,M){let L=null;G.supportedCompressionFormats&&(L=G.supportedCompressionFormats.astc?X:G.supportedCompressionFormats.bc7?r:G.supportedCompressionFormats.s3tc?M.pX?I:y:G.supportedCompressionFormats.pvrtc?M.pX?mt:Y:G.supportedCompressionFormats.etc2?U:G.supportedCompressionFormats.etc1?t:P);return L}(L.data.config,F),w=!1;null===E&&(w=!0,E=F.pX?I:y);let D=!0;Q.startTranscoding()||(D=!1);const l=[];for(let t=0;t<F.images.length&&D;t++){const U=F.images[t];if(void 0===G.loadSingleImage||G.loadSingleImage===t){let y=U.levels.length;!1===G.loadMipmapLevels&&(y=1);for(let I=0;I<y;I++){const y=U.levels[I],r=M(Q,t,I,E,w);if(!r){D=!1;break}y.transcodedPixels=r,l.push(y.transcodedPixels.buffer)}}}Q.close(),Q.delete(),w&&(E=-1),D?postMessage({action:"transcode",success:D,id:L.data.id,fileInfo:F,format:E},l):postMessage({action:"transcode",success:D,id:L.data.id})}}}!function(t){t[t.cTFETC1=0]="cTFETC1",t[t.cTFETC2=1]="cTFETC2",t[t.cTFBC1=2]="cTFBC1",t[t.cTFBC3=3]="cTFBC3",t[t.cTFBC4=4]="cTFBC4",t[t.cTFBC5=5]="cTFBC5",t[t.cTFBC7=6]="cTFBC7",t[t.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",t[t.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",t[t.cTFASTC_4x4=10]="cTFASTC_4x4",t[t.cTFATC_RGB=11]="cTFATC_RGB",t[t.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",t[t.cTFRGBA32=13]="cTFRGBA32",t[t.cTFRGB565=14]="cTFRGB565",t[t.cTFBGR565=15]="cTFBGR565",t[t.cTFRGBA4444=16]="cTFRGBA4444",t[t.cTFFXT1_RGB=17]="cTFFXT1_RGB",t[t.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",t[t.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",t[t.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",t[t.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(I||(I={}));const P={JSModuleURL:`${r.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${r.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let G=null,M=null,L=0;const h=async()=>(G||(G=new Promise(((t,U)=>{M?t(M):r.Tools.LoadFileAsync(r.Tools.GetBabylonScriptURL(P.WasmModuleURL)).then((y=>{if("function"!==typeof URL)return U("Basis transcoder requires an environment with a URL constructor");const I=URL.createObjectURL(new Blob([`(${X})()`],{type:"application/javascript"}));M=new Worker(I),async function(t,U,y){return await new Promise(((I,Y)=>{const mt=U=>{"init"===U.data.action?(t.removeEventListener("message",mt),I(t)):"error"===U.data.action&&Y(U.data.error||"error initializing worker")};t.addEventListener("message",mt),t.postMessage({action:"init",url:y?r.Tools.GetBabylonScriptURL(y):void 0,wasmBinary:U},[U])}))}(M,y,P.JSModuleURL).then(t,U)})).catch(U)}))),await G),Q=async(t,U)=>{const y=t instanceof ArrayBuffer?new Uint8Array(t):t;return await new Promise(((t,I)=>{h().then((()=>{const r=L++,Y=U=>{"transcode"===U.data.action&&U.data.id===r&&(M.removeEventListener("message",Y),U.data.success?t(U.data):I("Transcode is not supported on this device"))};M.addEventListener("message",Y);const mt=new Uint8Array(y.byteLength);mt.set(new Uint8Array(y.buffer,y.byteOffset,y.byteLength)),M.postMessage({action:"transcode",id:r,imageData:mt,config:U,ignoreSupportedFormats:false},[mt.buffer])}),(t=>{I(t)}))}))},F=(t,U)=>{var y;let I=null===(y=U._gl)||void 0===y?void 0:y.TEXTURE_2D;var r;t.isCube&&(I=null===(r=U._gl)||void 0===r?void 0:r.TEXTURE_CUBE_MAP);U._bindTextureDirectly(I,t,!0)},E=(t,U)=>{const y=t.getEngine();for(let X=0;X<U.fileInfo.images.length;X++){const P=U.fileInfo.images[X].levels[0];if(t._invertVScale=t.invertY,-1===U.format||U.format===I.cTFRGB565)if(t.type=10,t.format=4,!y._features.basisNeedsPOT||Math.log2(P.width)%1===0&&Math.log2(P.height)%1===0)t._invertVScale=!t.invertY,t.width=P.width+3&-4,t.height=P.height+3&-4,t.samplingMode=2,F(t,y),y._uploadDataToTextureDirectly(t,new Uint16Array(P.transcodedPixels.buffer),X,0,4,!0);else{const U=new mt.e(y,2);t._invertVScale=t.invertY,U.type=10,U.format=4,U.width=P.width+3&-4,U.height=P.height+3&-4,F(U,y),y._uploadDataToTextureDirectly(U,new Uint16Array(P.transcodedPixels.buffer),X,0,4,!0),y._rescaleTexture(U,t,y.scenes[0],y._getInternalFormat(4),(()=>{y._releaseTexture(U),F(t,y)}))}else{t.width=P.width,t.height=P.height,t.generateMipMaps=U.fileInfo.images[X].levels.length>1;const I=w.GetInternalFormatFromBasisFormat(U.format,y);t.format=I,F(t,y);const mt=U.fileInfo.images[X].levels;for(let U=0;U<mt.length;U++){const r=mt[U];y._uploadCompressedDataToTextureDirectly(t,I,r.width,r.height,r.transcodedPixels,X,U)}!y._features.basisNeedsPOT||Math.log2(t.width)%1===0&&Math.log2(t.height)%1===0||(r.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),t._cachedWrapU=Y.d.CLAMP_ADDRESSMODE,t._cachedWrapV=Y.d.CLAMP_ADDRESSMODE)}}},w={JSModuleURL:P.JSModuleURL,WasmModuleURL:P.WasmModuleURL,GetInternalFormatFromBasisFormat:(t,U)=>{let y;switch(t){case I.cTFETC1:y=36196;break;case I.cTFBC1:y=33776;break;case I.cTFBC4:y=33779;break;case I.cTFASTC_4x4:y=37808;break;case I.cTFETC2:y=37496;break;case I.cTFBC7:y=36492}if(void 0===y)throw"The chosen Basis transcoder format is not currently supported";return y},TranscodeAsync:Q,LoadTextureFromTranscodeResult:E};Object.defineProperty(w,"JSModuleURL",{get:function(){return P.JSModuleURL},set:function(t){P.JSModuleURL=t}}),Object.defineProperty(w,"WasmModuleURL",{get:function(){return P.WasmModuleURL},set:function(t){P.WasmModuleURL=t}});class D{constructor(){this.supportCascades=!1}loadCubeData(t,U,y,I,Y){if(Array.isArray(t))return;const mt=U.getEngine().getCaps(),X={supportedCompressionFormats:{etc1:!!mt.etc1,s3tc:!!mt.s3tc,pvrtc:!!mt.pvrtc,etc2:!!mt.etc2,astc:!!mt.astc,bc7:!!mt.bptc}};Q(t,X).then((t=>{const y=t.fileInfo.images[0].levels.length>1&&U.generateMipMaps;E(U,t),U.getEngine()._setCubeMapTextureParams(U,y),U.isReady=!0,U.onLoadedObservable.notifyObservers(U),U.onLoadedObservable.clear(),I&&I()})).catch((t=>{r.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),U.isReady=!0,Y&&Y(t)}))}loadData(t,U,y){const I=U.getEngine().getCaps(),Y={supportedCompressionFormats:{etc1:!!I.etc1,s3tc:!!I.s3tc,pvrtc:!!I.pvrtc,etc2:!!I.etc2,astc:!!I.astc,bc7:!!I.bptc}};Q(t,Y).then((t=>{const I=t.fileInfo.images[0].levels[0],r=t.fileInfo.images[0].levels.length>1&&U.generateMipMaps;y(I.width,I.height,r,-1!==t.format,(()=>{E(U,t)}))})).catch((t=>{r.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),r.Tools.Warn(`Failed to transcode Basis file: ${t}`),y(0,0,!1,!1,(()=>{}),!0)}))}}}}]);