"use strict";(self.zy41qorie9=self.zy41qorie9||[]).push([[47],{14572:(Z,l,C)=>{C.r(l),C.d(l,{_BasisTextureLoader:()=>P});var B,x=C(12248),b=C(12423),K=C(12382);function f(){const Z=0,l=1,C=2,B=3,x=6,b=8,K=9,f=10,W=14;let J=null;function d(Z,l,C,B,x){const b=Z.getImageTranscodedSizeInBytes(l,C,B);let K=new Uint8Array(b);if(!Z.transcodeImage(K,l,C,B,1,0))return null;if(x){K=function(Z,l,C,B){const x=new Uint16Array(4),b=new Uint16Array(C*B),K=C/4,f=B/4;for(let W=0;W<f;W++)for(let B=0;B<K;B++){const f=l+8*(W*K+B);x[0]=Z[f]|Z[f+1]<<8,x[1]=Z[f+2]|Z[f+3]<<8,x[2]=(2*(31&x[0])+1*(31&x[1]))/3|(2*(2016&x[0])+1*(2016&x[1]))/3&2016|(2*(63488&x[0])+1*(63488&x[1]))/3&63488,x[3]=(2*(31&x[1])+1*(31&x[0]))/3|(2*(2016&x[1])+1*(2016&x[0]))/3&2016|(2*(63488&x[1])+1*(63488&x[0]))/3&63488;for(let l=0;l<4;l++){const K=Z[f+4+l];let J=(4*W+l)*C+4*B;b[J++]=x[3&K],b[J++]=x[K>>2&3],b[J++]=x[K>>4&3],b[J++]=x[K>>6&3]}}return b}(K,0,Z.getImageWidth(l,C)+3&-4,Z.getImageHeight(l,C)+3&-4)}return K}onmessage=E=>{if("init"===E.data.action){if(E.data.url)try{importScripts(E.data.url)}catch(G){postMessage({action:"error",error:G})}J||(J=BASIS({wasmBinary:E.data.wasmBinary})),null!==J&&J.then((Z=>{BASIS=Z,Z.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===E.data.action){const J=E.data.config,G=E.data.imageData,a=new BASIS.BasisFile(G),q=function(Z){const l=Z.getHasAlpha(),C=Z.getNumImages(),B=[];for(let x=0;x<C;x++){const l={levels:[]},C=Z.getNumLevels(x);for(let B=0;B<C;B++){const C={width:Z.getImageWidth(x,B),height:Z.getImageHeight(x,B)};l.levels.push(C)}B.push(l)}return{Pb:l,images:B}}(a);let z=E.data.ignoreSupportedFormats?null:function(J,d){let E=null;J.supportedCompressionFormats&&(E=J.supportedCompressionFormats.astc?f:J.supportedCompressionFormats.bc7?x:J.supportedCompressionFormats.s3tc?d.Pb?B:C:J.supportedCompressionFormats.pvrtc?d.Pb?K:b:J.supportedCompressionFormats.etc2?l:J.supportedCompressionFormats.etc1?Z:W);return E}(E.data.config,q),Y=!1;null===z&&(Y=!0,z=q.Pb?B:C);let P=!0;a.startTranscoding()||(P=!1);const S=[];for(let Z=0;Z<q.images.length&&P;Z++){const l=q.images[Z];if(void 0===J.loadSingleImage||J.loadSingleImage===Z){let C=l.levels.length;!1===J.loadMipmapLevels&&(C=1);for(let B=0;B<C;B++){const C=l.levels[B],x=d(a,Z,B,z,Y);if(!x){P=!1;break}C.transcodedPixels=x,S.push(C.transcodedPixels.buffer)}}}a.close(),a.delete(),Y&&(z=-1),P?postMessage({action:"transcode",success:P,id:E.data.id,fileInfo:q,format:z},S):postMessage({action:"transcode",success:P,id:E.data.id})}}}!function(Z){Z[Z.cTFETC1=0]="cTFETC1",Z[Z.cTFETC2=1]="cTFETC2",Z[Z.cTFBC1=2]="cTFBC1",Z[Z.cTFBC3=3]="cTFBC3",Z[Z.cTFBC4=4]="cTFBC4",Z[Z.cTFBC5=5]="cTFBC5",Z[Z.cTFBC7=6]="cTFBC7",Z[Z.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",Z[Z.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",Z[Z.cTFASTC_4x4=10]="cTFASTC_4x4",Z[Z.cTFATC_RGB=11]="cTFATC_RGB",Z[Z.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",Z[Z.cTFRGBA32=13]="cTFRGBA32",Z[Z.cTFRGB565=14]="cTFRGB565",Z[Z.cTFBGR565=15]="cTFBGR565",Z[Z.cTFRGBA4444=16]="cTFRGBA4444",Z[Z.cTFFXT1_RGB=17]="cTFFXT1_RGB",Z[Z.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",Z[Z.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",Z[Z.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",Z[Z.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(B||(B={}));const W={JSModuleURL:`${x.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${x.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let J=null,d=null,E=0;const G=async()=>(J||(J=new Promise(((Z,l)=>{d?Z(d):x.Tools.LoadFileAsync(x.Tools.GetBabylonScriptURL(W.WasmModuleURL)).then((C=>{if("function"!==typeof URL)return l("Basis transcoder requires an environment with a URL constructor");const B=URL.createObjectURL(new Blob([`(${f})()`],{type:"application/javascript"}));d=new Worker(B),async function(Z,l,C){return await new Promise(((B,b)=>{const K=l=>{"init"===l.data.action?(Z.removeEventListener("message",K),B(Z)):"error"===l.data.action&&b(l.data.error||"error initializing worker")};Z.addEventListener("message",K),Z.postMessage({action:"init",url:C?x.Tools.GetBabylonScriptURL(C):void 0,wasmBinary:l},[l])}))}(d,C,W.JSModuleURL).then(Z,l)})).catch(l)}))),await J),a=async(Z,l)=>{const C=Z instanceof ArrayBuffer?new Uint8Array(Z):Z;return await new Promise(((Z,B)=>{G().then((()=>{const x=E++,b=l=>{"transcode"===l.data.action&&l.data.id===x&&(d.removeEventListener("message",b),l.data.success?Z(l.data):B("Transcode is not supported on this device"))};d.addEventListener("message",b);const K=new Uint8Array(C.byteLength);K.set(new Uint8Array(C.buffer,C.byteOffset,C.byteLength)),d.postMessage({action:"transcode",id:x,imageData:K,config:l,ignoreSupportedFormats:false},[K.buffer])}),(Z=>{B(Z)}))}))},q=(Z,l)=>{var C;let B=null===(C=l._gl)||void 0===C?void 0:C.TEXTURE_2D;var x;Z.isCube&&(B=null===(x=l._gl)||void 0===x?void 0:x.TEXTURE_CUBE_MAP);l._bindTextureDirectly(B,Z,!0)},z=(Z,l)=>{const C=Z.getEngine();for(let f=0;f<l.fileInfo.images.length;f++){const W=l.fileInfo.images[f].levels[0];if(Z._invertVScale=Z.invertY,-1===l.format||l.format===B.cTFRGB565)if(Z.type=10,Z.format=4,!C._features.basisNeedsPOT||Math.log2(W.width)%1===0&&Math.log2(W.height)%1===0)Z._invertVScale=!Z.invertY,Z.width=W.width+3&-4,Z.height=W.height+3&-4,Z.samplingMode=2,q(Z,C),C._uploadDataToTextureDirectly(Z,new Uint16Array(W.transcodedPixels.buffer),f,0,4,!0);else{const l=new K.c(C,2);Z._invertVScale=Z.invertY,l.type=10,l.format=4,l.width=W.width+3&-4,l.height=W.height+3&-4,q(l,C),C._uploadDataToTextureDirectly(l,new Uint16Array(W.transcodedPixels.buffer),f,0,4,!0),C._rescaleTexture(l,Z,C.scenes[0],C._getInternalFormat(4),(()=>{C._releaseTexture(l),q(Z,C)}))}else{Z.width=W.width,Z.height=W.height,Z.generateMipMaps=l.fileInfo.images[f].levels.length>1;const B=Y.GetInternalFormatFromBasisFormat(l.format,C);Z.format=B,q(Z,C);const K=l.fileInfo.images[f].levels;for(let l=0;l<K.length;l++){const x=K[l];C._uploadCompressedDataToTextureDirectly(Z,B,x.width,x.height,x.transcodedPixels,f,l)}!C._features.basisNeedsPOT||Math.log2(Z.width)%1===0&&Math.log2(Z.height)%1===0||(x.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),Z._cachedWrapU=b.c.CLAMP_ADDRESSMODE,Z._cachedWrapV=b.c.CLAMP_ADDRESSMODE)}}},Y={JSModuleURL:W.JSModuleURL,WasmModuleURL:W.WasmModuleURL,GetInternalFormatFromBasisFormat:(Z,l)=>{let C;switch(Z){case B.cTFETC1:C=36196;break;case B.cTFBC1:C=33776;break;case B.cTFBC4:C=33779;break;case B.cTFASTC_4x4:C=37808;break;case B.cTFETC2:C=37496;break;case B.cTFBC7:C=36492}if(void 0===C)throw"The chosen Basis transcoder format is not currently supported";return C},TranscodeAsync:a,LoadTextureFromTranscodeResult:z};Object.defineProperty(Y,"JSModuleURL",{get:function(){return W.JSModuleURL},set:function(Z){W.JSModuleURL=Z}}),Object.defineProperty(Y,"WasmModuleURL",{get:function(){return W.WasmModuleURL},set:function(Z){W.WasmModuleURL=Z}});class P{constructor(){this.supportCascades=!1}loadCubeData(Z,l,C,B,b){if(Array.isArray(Z))return;const K=l.getEngine().getCaps(),f={supportedCompressionFormats:{etc1:!!K.etc1,s3tc:!!K.s3tc,pvrtc:!!K.pvrtc,etc2:!!K.etc2,astc:!!K.astc,bc7:!!K.bptc}};a(Z,f).then((Z=>{const C=Z.fileInfo.images[0].levels.length>1&&l.generateMipMaps;z(l,Z),l.getEngine()._setCubeMapTextureParams(l,C),l.isReady=!0,l.onLoadedObservable.notifyObservers(l),l.onLoadedObservable.clear(),B&&B()})).catch((Z=>{x.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),l.isReady=!0,b&&b(Z)}))}loadData(Z,l,C){const B=l.getEngine().getCaps(),b={supportedCompressionFormats:{etc1:!!B.etc1,s3tc:!!B.s3tc,pvrtc:!!B.pvrtc,etc2:!!B.etc2,astc:!!B.astc,bc7:!!B.bptc}};a(Z,b).then((Z=>{const B=Z.fileInfo.images[0].levels[0],x=Z.fileInfo.images[0].levels.length>1&&l.generateMipMaps;C(B.width,B.height,x,-1!==Z.format,(()=>{z(l,Z)}))})).catch((Z=>{x.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),x.Tools.Warn(`Failed to transcode Basis file: ${Z}`),C(0,0,!1,!1,(()=>{}),!0)}))}}}}]);