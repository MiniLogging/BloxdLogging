"use strict";(self.ra6kpa9z1sg=self.ra6kpa9z1sg||[]).push([[47],{15217:(p,b,M)=>{M.r(b),M.d(b,{_BasisTextureLoader:()=>f});var h,Q=M(12608),mp=M(12753),y=M(12711);function P(){const p=0,b=1,M=2,h=3,Q=6,mp=8,y=9,P=10,w=14;let t=null;function z(p,b,M,h,Q){const mp=p.getImageTranscodedSizeInBytes(b,M,h);let y=new Uint8Array(mp);if(!p.transcodeImage(y,b,M,h,1,0))return null;if(Q){y=function(p,b,M,h){const Q=new Uint16Array(4),mp=new Uint16Array(M*h),y=M/4,P=h/4;for(let w=0;w<P;w++)for(let h=0;h<y;h++){const P=b+8*(w*y+h);Q[0]=p[P]|p[P+1]<<8,Q[1]=p[P+2]|p[P+3]<<8,Q[2]=(2*(31&Q[0])+1*(31&Q[1]))/3|(2*(2016&Q[0])+1*(2016&Q[1]))/3&2016|(2*(63488&Q[0])+1*(63488&Q[1]))/3&63488,Q[3]=(2*(31&Q[1])+1*(31&Q[0]))/3|(2*(2016&Q[1])+1*(2016&Q[0]))/3&2016|(2*(63488&Q[1])+1*(63488&Q[0]))/3&63488;for(let b=0;b<4;b++){const y=p[P+4+b];let t=(4*w+b)*M+4*h;mp[t++]=Q[3&y],mp[t++]=Q[y>>2&3],mp[t++]=Q[y>>4&3],mp[t++]=Q[y>>6&3]}}return mp}(y,0,p.getImageWidth(b,M)+3&-4,p.getImageHeight(b,M)+3&-4)}return y}onmessage=x=>{if("init"===x.data.action){if(x.data.url)try{importScripts(x.data.url)}catch(S){postMessage({action:"error",error:S})}t||(t=BASIS({wasmBinary:x.data.wasmBinary})),null!==t&&t.then((p=>{BASIS=p,p.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===x.data.action){const t=x.data.config,S=x.data.imageData,X=new BASIS.BasisFile(S),c=function(p){const b=p.getHasAlpha(),M=p.getNumImages(),h=[];for(let Q=0;Q<M;Q++){const b={levels:[]},M=p.getNumLevels(Q);for(let h=0;h<M;h++){const M={width:p.getImageWidth(Q,h),height:p.getImageHeight(Q,h)};b.levels.push(M)}h.push(b)}return{lb:b,images:h}}(X);let J=x.data.ignoreSupportedFormats?null:function(t,z){let x=null;t.supportedCompressionFormats&&(x=t.supportedCompressionFormats.astc?P:t.supportedCompressionFormats.bc7?Q:t.supportedCompressionFormats.s3tc?z.lb?h:M:t.supportedCompressionFormats.pvrtc?z.lb?y:mp:t.supportedCompressionFormats.etc2?b:t.supportedCompressionFormats.etc1?p:w);return x}(x.data.config,c),g=!1;null===J&&(g=!0,J=c.lb?h:M);let f=!0;X.startTranscoding()||(f=!1);const Y=[];for(let p=0;p<c.images.length&&f;p++){const b=c.images[p];if(void 0===t.loadSingleImage||t.loadSingleImage===p){let M=b.levels.length;!1===t.loadMipmapLevels&&(M=1);for(let h=0;h<M;h++){const M=b.levels[h],Q=z(X,p,h,J,g);if(!Q){f=!1;break}M.transcodedPixels=Q,Y.push(M.transcodedPixels.buffer)}}}X.close(),X.delete(),g&&(J=-1),f?postMessage({action:"transcode",success:f,id:x.data.id,fileInfo:c,format:J},Y):postMessage({action:"transcode",success:f,id:x.data.id})}}}!function(p){p[p.cTFETC1=0]="cTFETC1",p[p.cTFETC2=1]="cTFETC2",p[p.cTFBC1=2]="cTFBC1",p[p.cTFBC3=3]="cTFBC3",p[p.cTFBC4=4]="cTFBC4",p[p.cTFBC5=5]="cTFBC5",p[p.cTFBC7=6]="cTFBC7",p[p.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",p[p.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",p[p.cTFASTC_4x4=10]="cTFASTC_4x4",p[p.cTFATC_RGB=11]="cTFATC_RGB",p[p.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",p[p.cTFRGBA32=13]="cTFRGBA32",p[p.cTFRGB565=14]="cTFRGB565",p[p.cTFBGR565=15]="cTFBGR565",p[p.cTFRGBA4444=16]="cTFRGBA4444",p[p.cTFFXT1_RGB=17]="cTFFXT1_RGB",p[p.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",p[p.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",p[p.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",p[p.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(h||(h={}));const w={JSModuleURL:`${Q.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${Q.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let t=null,z=null,x=0;const S=async()=>(t||(t=new Promise(((p,b)=>{z?p(z):Q.Tools.LoadFileAsync(Q.Tools.GetBabylonScriptURL(w.WasmModuleURL)).then((M=>{if("function"!==typeof URL)return b("Basis transcoder requires an environment with a URL constructor");const h=URL.createObjectURL(new Blob([`(${P})()`],{type:"application/javascript"}));z=new Worker(h),async function(p,b,M){return await new Promise(((h,mp)=>{const y=b=>{"init"===b.data.action?(p.removeEventListener("message",y),h(p)):"error"===b.data.action&&mp(b.data.error||"error initializing worker")};p.addEventListener("message",y),p.postMessage({action:"init",url:M?Q.Tools.GetBabylonScriptURL(M):void 0,wasmBinary:b},[b])}))}(z,M,w.JSModuleURL).then(p,b)})).catch(b)}))),await t),X=async(p,b)=>{const M=p instanceof ArrayBuffer?new Uint8Array(p):p;return await new Promise(((p,h)=>{S().then((()=>{const Q=x++,mp=b=>{"transcode"===b.data.action&&b.data.id===Q&&(z.removeEventListener("message",mp),b.data.success?p(b.data):h("Transcode is not supported on this device"))};z.addEventListener("message",mp);const y=new Uint8Array(M.byteLength);y.set(new Uint8Array(M.buffer,M.byteOffset,M.byteLength)),z.postMessage({action:"transcode",id:Q,imageData:y,config:b,ignoreSupportedFormats:false},[y.buffer])}),(p=>{h(p)}))}))},c=(p,b)=>{var M;let h=null===(M=b._gl)||void 0===M?void 0:M.TEXTURE_2D;var Q;p.isCube&&(h=null===(Q=b._gl)||void 0===Q?void 0:Q.TEXTURE_CUBE_MAP);b._bindTextureDirectly(h,p,!0)},J=(p,b)=>{const M=p.getEngine();for(let P=0;P<b.fileInfo.images.length;P++){const w=b.fileInfo.images[P].levels[0];if(p._invertVScale=p.invertY,-1===b.format||b.format===h.cTFRGB565)if(p.type=10,p.format=4,!M._features.basisNeedsPOT||Math.log2(w.width)%1===0&&Math.log2(w.height)%1===0)p._invertVScale=!p.invertY,p.width=w.width+3&-4,p.height=w.height+3&-4,p.samplingMode=2,c(p,M),M._uploadDataToTextureDirectly(p,new Uint16Array(w.transcodedPixels.buffer),P,0,4,!0);else{const b=new y.e(M,2);p._invertVScale=p.invertY,b.type=10,b.format=4,b.width=w.width+3&-4,b.height=w.height+3&-4,c(b,M),M._uploadDataToTextureDirectly(b,new Uint16Array(w.transcodedPixels.buffer),P,0,4,!0),M._rescaleTexture(b,p,M.scenes[0],M._getInternalFormat(4),(()=>{M._releaseTexture(b),c(p,M)}))}else{p.width=w.width,p.height=w.height,p.generateMipMaps=b.fileInfo.images[P].levels.length>1;const h=g.GetInternalFormatFromBasisFormat(b.format,M);p.format=h,c(p,M);const y=b.fileInfo.images[P].levels;for(let b=0;b<y.length;b++){const Q=y[b];M._uploadCompressedDataToTextureDirectly(p,h,Q.width,Q.height,Q.transcodedPixels,P,b)}!M._features.basisNeedsPOT||Math.log2(p.width)%1===0&&Math.log2(p.height)%1===0||(Q.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),p._cachedWrapU=mp.c.CLAMP_ADDRESSMODE,p._cachedWrapV=mp.c.CLAMP_ADDRESSMODE)}}},g={JSModuleURL:w.JSModuleURL,WasmModuleURL:w.WasmModuleURL,GetInternalFormatFromBasisFormat:(p,b)=>{let M;switch(p){case h.cTFETC1:M=36196;break;case h.cTFBC1:M=33776;break;case h.cTFBC4:M=33779;break;case h.cTFASTC_4x4:M=37808;break;case h.cTFETC2:M=37496;break;case h.cTFBC7:M=36492}if(void 0===M)throw"The chosen Basis transcoder format is not currently supported";return M},TranscodeAsync:X,LoadTextureFromTranscodeResult:J};Object.defineProperty(g,"JSModuleURL",{get:function(){return w.JSModuleURL},set:function(p){w.JSModuleURL=p}}),Object.defineProperty(g,"WasmModuleURL",{get:function(){return w.WasmModuleURL},set:function(p){w.WasmModuleURL=p}});class f{constructor(){this.supportCascades=!1}loadCubeData(p,b,M,h,mp){if(Array.isArray(p))return;const y=b.getEngine().getCaps(),P={supportedCompressionFormats:{etc1:!!y.etc1,s3tc:!!y.s3tc,pvrtc:!!y.pvrtc,etc2:!!y.etc2,astc:!!y.astc,bc7:!!y.bptc}};X(p,P).then((p=>{const M=p.fileInfo.images[0].levels.length>1&&b.generateMipMaps;J(b,p),b.getEngine()._setCubeMapTextureParams(b,M),b.isReady=!0,b.onLoadedObservable.notifyObservers(b),b.onLoadedObservable.clear(),h&&h()})).catch((p=>{Q.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),b.isReady=!0,mp&&mp(p)}))}loadData(p,b,M){const h=b.getEngine().getCaps(),mp={supportedCompressionFormats:{etc1:!!h.etc1,s3tc:!!h.s3tc,pvrtc:!!h.pvrtc,etc2:!!h.etc2,astc:!!h.astc,bc7:!!h.bptc}};X(p,mp).then((p=>{const h=p.fileInfo.images[0].levels[0],Q=p.fileInfo.images[0].levels.length>1&&b.generateMipMaps;M(h.width,h.height,Q,-1!==p.format,(()=>{J(b,p)}))})).catch((p=>{Q.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),Q.Tools.Warn(`Failed to transcode Basis file: ${p}`),M(0,0,!1,!1,(()=>{}),!0)}))}}}}]);