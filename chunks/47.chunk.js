"use strict";(self.ynu1yiqvs98=self.ynu1yiqvs98||[]).push([[47],{13563:(I,E,j)=>{j.r(E),j.d(E,{_BasisTextureLoader:()=>C});var e,w=j(10953),z=j(11097),h=j(11056);function t(){const I=0,E=1,j=2,e=3,w=6,z=8,h=9,t=10,U=14;let R=null;function P(I,E,j,e,w){const z=I.getImageTranscodedSizeInBytes(E,j,e);let h=new Uint8Array(z);if(!I.transcodeImage(h,E,j,e,1,0))return null;if(w){h=function(I,E,j,e){const w=new Uint16Array(4),z=new Uint16Array(j*e),h=j/4,t=e/4;for(let U=0;U<t;U++)for(let e=0;e<h;e++){const t=E+8*(U*h+e);w[0]=I[t]|I[t+1]<<8,w[1]=I[t+2]|I[t+3]<<8,w[2]=(2*(31&w[0])+1*(31&w[1]))/3|(2*(2016&w[0])+1*(2016&w[1]))/3&2016|(2*(63488&w[0])+1*(63488&w[1]))/3&63488,w[3]=(2*(31&w[1])+1*(31&w[0]))/3|(2*(2016&w[1])+1*(2016&w[0]))/3&2016|(2*(63488&w[1])+1*(63488&w[0]))/3&63488;for(let E=0;E<4;E++){const h=I[t+4+E];let R=(4*U+E)*j+4*e;z[R++]=w[3&h],z[R++]=w[h>>2&3],z[R++]=w[h>>4&3],z[R++]=w[h>>6&3]}}return z}(h,0,I.getImageWidth(E,j)+3&-4,I.getImageHeight(E,j)+3&-4)}return h}onmessage=o=>{if("init"===o.data.action){if(o.data.url)try{importScripts(o.data.url)}catch(Z){postMessage({action:"error",error:Z})}R||(R=BASIS({wasmBinary:o.data.wasmBinary})),null!==R&&R.then((I=>{BASIS=I,I.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===o.data.action){const R=o.data.config,Z=o.data.imageData,c=new BASIS.BasisFile(Z),K=function(I){const E=I.getHasAlpha(),j=I.getNumImages(),e=[];for(let w=0;w<j;w++){const E={levels:[]},j=I.getNumLevels(w);for(let e=0;e<j;e++){const j={width:I.getImageWidth(w,e),height:I.getImageHeight(w,e)};E.levels.push(j)}e.push(E)}return{ne:E,images:e}}(c);let L=o.data.ignoreSupportedFormats?null:function(R,P){let o=null;R.supportedCompressionFormats&&(o=R.supportedCompressionFormats.astc?t:R.supportedCompressionFormats.bc7?w:R.supportedCompressionFormats.s3tc?P.ne?e:j:R.supportedCompressionFormats.pvrtc?P.ne?h:z:R.supportedCompressionFormats.etc2?E:R.supportedCompressionFormats.etc1?I:U);return o}(o.data.config,K),F=!1;null===L&&(F=!0,L=K.ne?e:j);let C=!0;c.startTranscoding()||(C=!1);const X=[];for(let I=0;I<K.images.length&&C;I++){const E=K.images[I];if(void 0===R.loadSingleImage||R.loadSingleImage===I){let j=E.levels.length;!1===R.loadMipmapLevels&&(j=1);for(let e=0;e<j;e++){const j=E.levels[e],w=P(c,I,e,L,F);if(!w){C=!1;break}j.transcodedPixels=w,X.push(j.transcodedPixels.buffer)}}}c.close(),c.delete(),F&&(L=-1),C?postMessage({action:"transcode",success:C,id:o.data.id,fileInfo:K,format:L},X):postMessage({action:"transcode",success:C,id:o.data.id})}}}!function(I){I[I.cTFETC1=0]="cTFETC1",I[I.cTFETC2=1]="cTFETC2",I[I.cTFBC1=2]="cTFBC1",I[I.cTFBC3=3]="cTFBC3",I[I.cTFBC4=4]="cTFBC4",I[I.cTFBC5=5]="cTFBC5",I[I.cTFBC7=6]="cTFBC7",I[I.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",I[I.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",I[I.cTFASTC_4x4=10]="cTFASTC_4x4",I[I.cTFATC_RGB=11]="cTFATC_RGB",I[I.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",I[I.cTFRGBA32=13]="cTFRGBA32",I[I.cTFRGB565=14]="cTFRGB565",I[I.cTFBGR565=15]="cTFBGR565",I[I.cTFRGBA4444=16]="cTFRGBA4444",I[I.cTFFXT1_RGB=17]="cTFFXT1_RGB",I[I.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",I[I.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",I[I.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",I[I.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(e||(e={}));const U={JSModuleURL:`${w.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${w.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let R=null,P=null,o=0;const Z=async()=>(R||(R=new Promise(((I,E)=>{P?I(P):w.Tools.LoadFileAsync(w.Tools.GetBabylonScriptURL(U.WasmModuleURL)).then((j=>{if("function"!==typeof URL)return E("Basis transcoder requires an environment with a URL constructor");const e=URL.createObjectURL(new Blob([`(${t})()`],{type:"application/javascript"}));P=new Worker(e),async function(I,E,j){return await new Promise(((e,z)=>{const h=E=>{"init"===E.data.action?(I.removeEventListener("message",h),e(I)):"error"===E.data.action&&z(E.data.error||"error initializing worker")};I.addEventListener("message",h),I.postMessage({action:"init",url:j?w.Tools.GetBabylonScriptURL(j):void 0,wasmBinary:E},[E])}))}(P,j,U.JSModuleURL).then(I,E)})).catch(E)}))),await R),c=async(I,E)=>{const j=I instanceof ArrayBuffer?new Uint8Array(I):I;return await new Promise(((I,e)=>{Z().then((()=>{const w=o++,z=E=>{"transcode"===E.data.action&&E.data.id===w&&(P.removeEventListener("message",z),E.data.success?I(E.data):e("Transcode is not supported on this device"))};P.addEventListener("message",z);const h=new Uint8Array(j.byteLength);h.set(new Uint8Array(j.buffer,j.byteOffset,j.byteLength)),P.postMessage({action:"transcode",id:w,imageData:h,config:E,ignoreSupportedFormats:false},[h.buffer])}),(I=>{e(I)}))}))},K=(I,E)=>{var j;let e=null===(j=E._gl)||void 0===j?void 0:j.TEXTURE_2D;var w;I.isCube&&(e=null===(w=E._gl)||void 0===w?void 0:w.TEXTURE_CUBE_MAP);E._bindTextureDirectly(e,I,!0)},L=(I,E)=>{const j=I.getEngine();for(let t=0;t<E.fileInfo.images.length;t++){const U=E.fileInfo.images[t].levels[0];if(I._invertVScale=I.invertY,-1===E.format||E.format===e.cTFRGB565)if(I.type=10,I.format=4,!j._features.basisNeedsPOT||Math.log2(U.width)%1===0&&Math.log2(U.height)%1===0)I._invertVScale=!I.invertY,I.width=U.width+3&-4,I.height=U.height+3&-4,I.samplingMode=2,K(I,j),j._uploadDataToTextureDirectly(I,new Uint16Array(U.transcodedPixels.buffer),t,0,4,!0);else{const E=new h.e(j,2);I._invertVScale=I.invertY,E.type=10,E.format=4,E.width=U.width+3&-4,E.height=U.height+3&-4,K(E,j),j._uploadDataToTextureDirectly(E,new Uint16Array(U.transcodedPixels.buffer),t,0,4,!0),j._rescaleTexture(E,I,j.scenes[0],j._getInternalFormat(4),(()=>{j._releaseTexture(E),K(I,j)}))}else{I.width=U.width,I.height=U.height,I.generateMipMaps=E.fileInfo.images[t].levels.length>1;const e=F.GetInternalFormatFromBasisFormat(E.format,j);I.format=e,K(I,j);const h=E.fileInfo.images[t].levels;for(let E=0;E<h.length;E++){const w=h[E];j._uploadCompressedDataToTextureDirectly(I,e,w.width,w.height,w.transcodedPixels,t,E)}!j._features.basisNeedsPOT||Math.log2(I.width)%1===0&&Math.log2(I.height)%1===0||(w.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),I._cachedWrapU=z.d.CLAMP_ADDRESSMODE,I._cachedWrapV=z.d.CLAMP_ADDRESSMODE)}}},F={JSModuleURL:U.JSModuleURL,WasmModuleURL:U.WasmModuleURL,GetInternalFormatFromBasisFormat:(I,E)=>{let j;switch(I){case e.cTFETC1:j=36196;break;case e.cTFBC1:j=33776;break;case e.cTFBC4:j=33779;break;case e.cTFASTC_4x4:j=37808;break;case e.cTFETC2:j=37496;break;case e.cTFBC7:j=36492}if(void 0===j)throw"The chosen Basis transcoder format is not currently supported";return j},TranscodeAsync:c,LoadTextureFromTranscodeResult:L};Object.defineProperty(F,"JSModuleURL",{get:function(){return U.JSModuleURL},set:function(I){U.JSModuleURL=I}}),Object.defineProperty(F,"WasmModuleURL",{get:function(){return U.WasmModuleURL},set:function(I){U.WasmModuleURL=I}});class C{constructor(){this.supportCascades=!1}loadCubeData(I,E,j,e,z){if(Array.isArray(I))return;const h=E.getEngine().getCaps(),t={supportedCompressionFormats:{etc1:!!h.etc1,s3tc:!!h.s3tc,pvrtc:!!h.pvrtc,etc2:!!h.etc2,astc:!!h.astc,bc7:!!h.bptc}};c(I,t).then((I=>{const j=I.fileInfo.images[0].levels.length>1&&E.generateMipMaps;L(E,I),E.getEngine()._setCubeMapTextureParams(E,j),E.isReady=!0,E.onLoadedObservable.notifyObservers(E),E.onLoadedObservable.clear(),e&&e()})).catch((I=>{w.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),E.isReady=!0,z&&z(I)}))}loadData(I,E,j){const e=E.getEngine().getCaps(),z={supportedCompressionFormats:{etc1:!!e.etc1,s3tc:!!e.s3tc,pvrtc:!!e.pvrtc,etc2:!!e.etc2,astc:!!e.astc,bc7:!!e.bptc}};c(I,z).then((I=>{const e=I.fileInfo.images[0].levels[0],w=I.fileInfo.images[0].levels.length>1&&E.generateMipMaps;j(e.width,e.height,w,-1!==I.format,(()=>{L(E,I)}))})).catch((I=>{w.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),w.Tools.Warn(`Failed to transcode Basis file: ${I}`),j(0,0,!1,!1,(()=>{}),!0)}))}}}}]);