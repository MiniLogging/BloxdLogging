"use strict";(self.wj3aziuz228=self.wj3aziuz228||[]).push([[47],{14911:(u,R,I)=>{I.r(R),I.d(R,{_BasisTextureLoader:()=>z});var B,U=I(12294),K=I(12460),C=I(12415);function D(){const u=0,R=1,I=2,B=3,U=6,K=8,C=9,D=10,s=14;let t=null;function G(u,R,I,B,U){const K=u.getImageTranscodedSizeInBytes(R,I,B);let C=new Uint8Array(K);if(!u.transcodeImage(C,R,I,B,1,0))return null;if(U){C=function(u,R,I,B){const U=new Uint16Array(4),K=new Uint16Array(I*B),C=I/4,D=B/4;for(let s=0;s<D;s++)for(let B=0;B<C;B++){const D=R+8*(s*C+B);U[0]=u[D]|u[D+1]<<8,U[1]=u[D+2]|u[D+3]<<8,U[2]=(2*(31&U[0])+1*(31&U[1]))/3|(2*(2016&U[0])+1*(2016&U[1]))/3&2016|(2*(63488&U[0])+1*(63488&U[1]))/3&63488,U[3]=(2*(31&U[1])+1*(31&U[0]))/3|(2*(2016&U[1])+1*(2016&U[0]))/3&2016|(2*(63488&U[1])+1*(63488&U[0]))/3&63488;for(let R=0;R<4;R++){const C=u[D+4+R];let t=(4*s+R)*I+4*B;K[t++]=U[3&C],K[t++]=U[C>>2&3],K[t++]=U[C>>4&3],K[t++]=U[C>>6&3]}}return K}(C,0,u.getImageWidth(R,I)+3&-4,u.getImageHeight(R,I)+3&-4)}return C}onmessage=S=>{if("init"===S.data.action){if(S.data.url)try{importScripts(S.data.url)}catch(b){postMessage({action:"error",error:b})}t||(t=BASIS({wasmBinary:S.data.wasmBinary})),null!==t&&t.then((u=>{BASIS=u,u.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===S.data.action){const t=S.data.config,b=S.data.imageData,r=new BASIS.BasisFile(b),P=function(u){const R=u.getHasAlpha(),I=u.getNumImages(),B=[];for(let U=0;U<I;U++){const R={levels:[]},I=u.getNumLevels(U);for(let B=0;B<I;B++){const I={width:u.getImageWidth(U,B),height:u.getImageHeight(U,B)};R.levels.push(I)}B.push(R)}return{tD:R,images:B}}(r);let X=S.data.ignoreSupportedFormats?null:function(t,G){let S=null;t.supportedCompressionFormats&&(S=t.supportedCompressionFormats.astc?D:t.supportedCompressionFormats.bc7?U:t.supportedCompressionFormats.s3tc?G.tD?B:I:t.supportedCompressionFormats.pvrtc?G.tD?C:K:t.supportedCompressionFormats.etc2?R:t.supportedCompressionFormats.etc1?u:s);return S}(S.data.config,P),E=!1;null===X&&(E=!0,X=P.tD?B:I);let z=!0;r.startTranscoding()||(z=!1);const f=[];for(let u=0;u<P.images.length&&z;u++){const R=P.images[u];if(void 0===t.loadSingleImage||t.loadSingleImage===u){let I=R.levels.length;!1===t.loadMipmapLevels&&(I=1);for(let B=0;B<I;B++){const I=R.levels[B],U=G(r,u,B,X,E);if(!U){z=!1;break}I.transcodedPixels=U,f.push(I.transcodedPixels.buffer)}}}r.close(),r.delete(),E&&(X=-1),z?postMessage({action:"transcode",success:z,id:S.data.id,fileInfo:P,format:X},f):postMessage({action:"transcode",success:z,id:S.data.id})}}}!function(u){u[u.cTFETC1=0]="cTFETC1",u[u.cTFETC2=1]="cTFETC2",u[u.cTFBC1=2]="cTFBC1",u[u.cTFBC3=3]="cTFBC3",u[u.cTFBC4=4]="cTFBC4",u[u.cTFBC5=5]="cTFBC5",u[u.cTFBC7=6]="cTFBC7",u[u.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",u[u.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",u[u.cTFASTC_4x4=10]="cTFASTC_4x4",u[u.cTFATC_RGB=11]="cTFATC_RGB",u[u.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",u[u.cTFRGBA32=13]="cTFRGBA32",u[u.cTFRGB565=14]="cTFRGB565",u[u.cTFBGR565=15]="cTFBGR565",u[u.cTFRGBA4444=16]="cTFRGBA4444",u[u.cTFFXT1_RGB=17]="cTFFXT1_RGB",u[u.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",u[u.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",u[u.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",u[u.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(B||(B={}));const s={JSModuleURL:`${U.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${U.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let t=null,G=null,S=0;const b=async()=>(t||(t=new Promise(((u,R)=>{G?u(G):U.Tools.LoadFileAsync(U.Tools.GetBabylonScriptURL(s.WasmModuleURL)).then((I=>{if("function"!==typeof URL)return R("Basis transcoder requires an environment with a URL constructor");const B=URL.createObjectURL(new Blob([`(${D})()`],{type:"application/javascript"}));G=new Worker(B),async function(u,R,I){return await new Promise(((B,K)=>{const C=R=>{"init"===R.data.action?(u.removeEventListener("message",C),B(u)):"error"===R.data.action&&K(R.data.error||"error initializing worker")};u.addEventListener("message",C),u.postMessage({action:"init",url:I?U.Tools.GetBabylonScriptURL(I):void 0,wasmBinary:R},[R])}))}(G,I,s.JSModuleURL).then(u,R)})).catch(R)}))),await t),r=async(u,R)=>{const I=u instanceof ArrayBuffer?new Uint8Array(u):u;return await new Promise(((u,B)=>{b().then((()=>{const U=S++,K=R=>{"transcode"===R.data.action&&R.data.id===U&&(G.removeEventListener("message",K),R.data.success?u(R.data):B("Transcode is not supported on this device"))};G.addEventListener("message",K);const C=new Uint8Array(I.byteLength);C.set(new Uint8Array(I.buffer,I.byteOffset,I.byteLength)),G.postMessage({action:"transcode",id:U,imageData:C,config:R,ignoreSupportedFormats:false},[C.buffer])}),(u=>{B(u)}))}))},P=(u,R)=>{var I;let B=null===(I=R._gl)||void 0===I?void 0:I.TEXTURE_2D;var U;u.isCube&&(B=null===(U=R._gl)||void 0===U?void 0:U.TEXTURE_CUBE_MAP);R._bindTextureDirectly(B,u,!0)},X=(u,R)=>{const I=u.getEngine();for(let D=0;D<R.fileInfo.images.length;D++){const s=R.fileInfo.images[D].levels[0];if(u._invertVScale=u.invertY,-1===R.format||R.format===B.cTFRGB565)if(u.type=10,u.format=4,!I._features.basisNeedsPOT||Math.log2(s.width)%1===0&&Math.log2(s.height)%1===0)u._invertVScale=!u.invertY,u.width=s.width+3&-4,u.height=s.height+3&-4,u.samplingMode=2,P(u,I),I._uploadDataToTextureDirectly(u,new Uint16Array(s.transcodedPixels.buffer),D,0,4,!0);else{const R=new C.d(I,2);u._invertVScale=u.invertY,R.type=10,R.format=4,R.width=s.width+3&-4,R.height=s.height+3&-4,P(R,I),I._uploadDataToTextureDirectly(R,new Uint16Array(s.transcodedPixels.buffer),D,0,4,!0),I._rescaleTexture(R,u,I.scenes[0],I._getInternalFormat(4),(()=>{I._releaseTexture(R),P(u,I)}))}else{u.width=s.width,u.height=s.height,u.generateMipMaps=R.fileInfo.images[D].levels.length>1;const B=E.GetInternalFormatFromBasisFormat(R.format,I);u.format=B,P(u,I);const C=R.fileInfo.images[D].levels;for(let R=0;R<C.length;R++){const U=C[R];I._uploadCompressedDataToTextureDirectly(u,B,U.width,U.height,U.transcodedPixels,D,R)}!I._features.basisNeedsPOT||Math.log2(u.width)%1===0&&Math.log2(u.height)%1===0||(U.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),u._cachedWrapU=K.b.CLAMP_ADDRESSMODE,u._cachedWrapV=K.b.CLAMP_ADDRESSMODE)}}},E={JSModuleURL:s.JSModuleURL,WasmModuleURL:s.WasmModuleURL,GetInternalFormatFromBasisFormat:(u,R)=>{let I;switch(u){case B.cTFETC1:I=36196;break;case B.cTFBC1:I=33776;break;case B.cTFBC4:I=33779;break;case B.cTFASTC_4x4:I=37808;break;case B.cTFETC2:I=37496;break;case B.cTFBC7:I=36492}if(void 0===I)throw"The chosen Basis transcoder format is not currently supported";return I},TranscodeAsync:r,LoadTextureFromTranscodeResult:X};Object.defineProperty(E,"JSModuleURL",{get:function(){return s.JSModuleURL},set:function(u){s.JSModuleURL=u}}),Object.defineProperty(E,"WasmModuleURL",{get:function(){return s.WasmModuleURL},set:function(u){s.WasmModuleURL=u}});class z{constructor(){this.supportCascades=!1}loadCubeData(u,R,I,B,K){if(Array.isArray(u))return;const C=R.getEngine().getCaps(),D={supportedCompressionFormats:{etc1:!!C.etc1,s3tc:!!C.s3tc,pvrtc:!!C.pvrtc,etc2:!!C.etc2,astc:!!C.astc,bc7:!!C.bptc}};r(u,D).then((u=>{const I=u.fileInfo.images[0].levels.length>1&&R.generateMipMaps;X(R,u),R.getEngine()._setCubeMapTextureParams(R,I),R.isReady=!0,R.onLoadedObservable.notifyObservers(R),R.onLoadedObservable.clear(),B&&B()})).catch((u=>{U.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),R.isReady=!0,K&&K(u)}))}loadData(u,R,I){const B=R.getEngine().getCaps(),K={supportedCompressionFormats:{etc1:!!B.etc1,s3tc:!!B.s3tc,pvrtc:!!B.pvrtc,etc2:!!B.etc2,astc:!!B.astc,bc7:!!B.bptc}};r(u,K).then((u=>{const B=u.fileInfo.images[0].levels[0],U=u.fileInfo.images[0].levels.length>1&&R.generateMipMaps;I(B.width,B.height,U,-1!==u.format,(()=>{X(R,u)}))})).catch((u=>{U.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),U.Tools.Warn(`Failed to transcode Basis file: ${u}`),I(0,0,!1,!1,(()=>{}),!0)}))}}}}]);