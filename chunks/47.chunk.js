"use strict";(self.b15p7b72fr8=self.b15p7b72fr8||[]).push([[47],{15041:(s,k,h)=>{h.r(k),h.d(k,{_BasisTextureLoader:()=>P});var A,g=h(12402),ms=h(12567),i=h(12515);function K(){const s=0,k=1,h=2,A=3,g=6,ms=8,i=9,K=10,H=14;let O=null;function c(s,k,h,A,g){const ms=s.getImageTranscodedSizeInBytes(k,h,A);let i=new Uint8Array(ms);if(!s.transcodeImage(i,k,h,A,1,0))return null;if(g){i=function(s,k,h,A){const g=new Uint16Array(4),ms=new Uint16Array(h*A),i=h/4,K=A/4;for(let H=0;H<K;H++)for(let A=0;A<i;A++){const K=k+8*(H*i+A);g[0]=s[K]|s[K+1]<<8,g[1]=s[K+2]|s[K+3]<<8,g[2]=(2*(31&g[0])+1*(31&g[1]))/3|(2*(2016&g[0])+1*(2016&g[1]))/3&2016|(2*(63488&g[0])+1*(63488&g[1]))/3&63488,g[3]=(2*(31&g[1])+1*(31&g[0]))/3|(2*(2016&g[1])+1*(2016&g[0]))/3&2016|(2*(63488&g[1])+1*(63488&g[0]))/3&63488;for(let k=0;k<4;k++){const i=s[K+4+k];let O=(4*H+k)*h+4*A;ms[O++]=g[3&i],ms[O++]=g[i>>2&3],ms[O++]=g[i>>4&3],ms[O++]=g[i>>6&3]}}return ms}(i,0,s.getImageWidth(k,h)+3&-4,s.getImageHeight(k,h)+3&-4)}return i}onmessage=S=>{if("init"===S.data.action){if(S.data.url)try{importScripts(S.data.url)}catch(a){postMessage({action:"error",error:a})}O||(O=BASIS({wasmBinary:S.data.wasmBinary})),null!==O&&O.then((s=>{BASIS=s,s.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===S.data.action){const O=S.data.config,a=S.data.imageData,r=new BASIS.BasisFile(a),d=function(s){const k=s.getHasAlpha(),h=s.getNumImages(),A=[];for(let g=0;g<h;g++){const k={levels:[]},h=s.getNumLevels(g);for(let A=0;A<h;A++){const h={width:s.getImageWidth(g,A),height:s.getImageHeight(g,A)};k.levels.push(h)}A.push(k)}return{Wh:k,images:A}}(r);let E=S.data.ignoreSupportedFormats?null:function(O,c){let S=null;O.supportedCompressionFormats&&(S=O.supportedCompressionFormats.astc?K:O.supportedCompressionFormats.bc7?g:O.supportedCompressionFormats.s3tc?c.Wh?A:h:O.supportedCompressionFormats.pvrtc?c.Wh?i:ms:O.supportedCompressionFormats.etc2?k:O.supportedCompressionFormats.etc1?s:H);return S}(S.data.config,d),j=!1;null===E&&(j=!0,E=d.Wh?A:h);let P=!0;r.startTranscoding()||(P=!1);const R=[];for(let s=0;s<d.images.length&&P;s++){const k=d.images[s];if(void 0===O.loadSingleImage||O.loadSingleImage===s){let h=k.levels.length;!1===O.loadMipmapLevels&&(h=1);for(let A=0;A<h;A++){const h=k.levels[A],g=c(r,s,A,E,j);if(!g){P=!1;break}h.transcodedPixels=g,R.push(h.transcodedPixels.buffer)}}}r.close(),r.delete(),j&&(E=-1),P?postMessage({action:"transcode",success:P,id:S.data.id,fileInfo:d,format:E},R):postMessage({action:"transcode",success:P,id:S.data.id})}}}!function(s){s[s.cTFETC1=0]="cTFETC1",s[s.cTFETC2=1]="cTFETC2",s[s.cTFBC1=2]="cTFBC1",s[s.cTFBC3=3]="cTFBC3",s[s.cTFBC4=4]="cTFBC4",s[s.cTFBC5=5]="cTFBC5",s[s.cTFBC7=6]="cTFBC7",s[s.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",s[s.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",s[s.cTFASTC_4x4=10]="cTFASTC_4x4",s[s.cTFATC_RGB=11]="cTFATC_RGB",s[s.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",s[s.cTFRGBA32=13]="cTFRGBA32",s[s.cTFRGB565=14]="cTFRGB565",s[s.cTFBGR565=15]="cTFBGR565",s[s.cTFRGBA4444=16]="cTFRGBA4444",s[s.cTFFXT1_RGB=17]="cTFFXT1_RGB",s[s.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",s[s.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",s[s.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",s[s.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(A||(A={}));const H={JSModuleURL:`${g.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${g.Tools._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let O=null,c=null,S=0;const a=async()=>(O||(O=new Promise(((s,k)=>{c?s(c):g.Tools.LoadFileAsync(g.Tools.GetBabylonScriptURL(H.WasmModuleURL)).then((h=>{if("function"!==typeof URL)return k("Basis transcoder requires an environment with a URL constructor");const A=URL.createObjectURL(new Blob([`(${K})()`],{type:"application/javascript"}));c=new Worker(A),async function(s,k,h){return await new Promise(((A,ms)=>{const i=k=>{"init"===k.data.action?(s.removeEventListener("message",i),A(s)):"error"===k.data.action&&ms(k.data.error||"error initializing worker")};s.addEventListener("message",i),s.postMessage({action:"init",url:h?g.Tools.GetBabylonScriptURL(h):void 0,wasmBinary:k},[k])}))}(c,h,H.JSModuleURL).then(s,k)})).catch(k)}))),await O),r=async(s,k)=>{const h=s instanceof ArrayBuffer?new Uint8Array(s):s;return await new Promise(((s,A)=>{a().then((()=>{const g=S++,ms=k=>{"transcode"===k.data.action&&k.data.id===g&&(c.removeEventListener("message",ms),k.data.success?s(k.data):A("Transcode is not supported on this device"))};c.addEventListener("message",ms);const i=new Uint8Array(h.byteLength);i.set(new Uint8Array(h.buffer,h.byteOffset,h.byteLength)),c.postMessage({action:"transcode",id:g,imageData:i,config:k,ignoreSupportedFormats:false},[i.buffer])}),(s=>{A(s)}))}))},d=(s,k)=>{var h;let A=null===(h=k._gl)||void 0===h?void 0:h.TEXTURE_2D;var g;s.isCube&&(A=null===(g=k._gl)||void 0===g?void 0:g.TEXTURE_CUBE_MAP);k._bindTextureDirectly(A,s,!0)},E=(s,k)=>{const h=s.getEngine();for(let K=0;K<k.fileInfo.images.length;K++){const H=k.fileInfo.images[K].levels[0];if(s._invertVScale=s.invertY,-1===k.format||k.format===A.cTFRGB565)if(s.type=10,s.format=4,!h._features.basisNeedsPOT||Math.log2(H.width)%1===0&&Math.log2(H.height)%1===0)s._invertVScale=!s.invertY,s.width=H.width+3&-4,s.height=H.height+3&-4,s.samplingMode=2,d(s,h),h._uploadDataToTextureDirectly(s,new Uint16Array(H.transcodedPixels.buffer),K,0,4,!0);else{const k=new i.c(h,2);s._invertVScale=s.invertY,k.type=10,k.format=4,k.width=H.width+3&-4,k.height=H.height+3&-4,d(k,h),h._uploadDataToTextureDirectly(k,new Uint16Array(H.transcodedPixels.buffer),K,0,4,!0),h._rescaleTexture(k,s,h.scenes[0],h._getInternalFormat(4),(()=>{h._releaseTexture(k),d(s,h)}))}else{s.width=H.width,s.height=H.height,s.generateMipMaps=k.fileInfo.images[K].levels.length>1;const A=j.GetInternalFormatFromBasisFormat(k.format,h);s.format=A,d(s,h);const i=k.fileInfo.images[K].levels;for(let k=0;k<i.length;k++){const g=i[k];h._uploadCompressedDataToTextureDirectly(s,A,g.width,g.height,g.transcodedPixels,K,k)}!h._features.basisNeedsPOT||Math.log2(s.width)%1===0&&Math.log2(s.height)%1===0||(g.Tools.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),s._cachedWrapU=ms.b.CLAMP_ADDRESSMODE,s._cachedWrapV=ms.b.CLAMP_ADDRESSMODE)}}},j={JSModuleURL:H.JSModuleURL,WasmModuleURL:H.WasmModuleURL,GetInternalFormatFromBasisFormat:(s,k)=>{let h;switch(s){case A.cTFETC1:h=36196;break;case A.cTFBC1:h=33776;break;case A.cTFBC4:h=33779;break;case A.cTFASTC_4x4:h=37808;break;case A.cTFETC2:h=37496;break;case A.cTFBC7:h=36492}if(void 0===h)throw"The chosen Basis transcoder format is not currently supported";return h},TranscodeAsync:r,LoadTextureFromTranscodeResult:E};Object.defineProperty(j,"JSModuleURL",{get:function(){return H.JSModuleURL},set:function(s){H.JSModuleURL=s}}),Object.defineProperty(j,"WasmModuleURL",{get:function(){return H.WasmModuleURL},set:function(s){H.WasmModuleURL=s}});class P{constructor(){this.supportCascades=!1}loadCubeData(s,k,h,A,ms){if(Array.isArray(s))return;const i=k.getEngine().getCaps(),K={supportedCompressionFormats:{etc1:!!i.etc1,s3tc:!!i.s3tc,pvrtc:!!i.pvrtc,etc2:!!i.etc2,astc:!!i.astc,bc7:!!i.bptc}};r(s,K).then((s=>{const h=s.fileInfo.images[0].levels.length>1&&k.generateMipMaps;E(k,s),k.getEngine()._setCubeMapTextureParams(k,h),k.isReady=!0,k.onLoadedObservable.notifyObservers(k),k.onLoadedObservable.clear(),A&&A()})).catch((s=>{g.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),k.isReady=!0,ms&&ms(s)}))}loadData(s,k,h){const A=k.getEngine().getCaps(),ms={supportedCompressionFormats:{etc1:!!A.etc1,s3tc:!!A.s3tc,pvrtc:!!A.pvrtc,etc2:!!A.etc2,astc:!!A.astc,bc7:!!A.bptc}};r(s,ms).then((s=>{const A=s.fileInfo.images[0].levels[0],g=s.fileInfo.images[0].levels.length>1&&k.generateMipMaps;h(A.width,A.height,g,-1!==s.format,(()=>{E(k,s)}))})).catch((s=>{g.Tools.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),g.Tools.Warn(`Failed to transcode Basis file: ${s}`),h(0,0,!1,!1,(()=>{}),!0)}))}}}}]);