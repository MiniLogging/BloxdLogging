"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[8],{2413:(t,q,S)=>{S.r(q),S.d(q,{_BasisTextureLoader:()=>a});var o,B=S(490),z=S(2306),L=S(599);function r(){const t=0,q=1,S=2,o=3,B=6,z=8,L=9,r=10,e=14;let C=null;function Z(t,q,S,o,B){const z=t.getImageTranscodedSizeInBytes(q,S,o);let L=new Uint8Array(z);if(!t.transcodeImage(L,q,S,o,1,0))return null;if(B){L=function(t,q,S,o){const B=new Uint16Array(4),z=new Uint16Array(S*o),L=S/4,r=o/4;for(let e=0;e<r;e++)for(let o=0;o<L;o++){const r=q+8*(e*L+o);B[0]=t[r]|t[r+1]<<8,B[1]=t[r+2]|t[r+3]<<8,B[2]=(2*(31&B[0])+1*(31&B[1]))/3|(2*(2016&B[0])+1*(2016&B[1]))/3&2016|(2*(63488&B[0])+1*(63488&B[1]))/3&63488,B[3]=(2*(31&B[1])+1*(31&B[0]))/3|(2*(2016&B[1])+1*(2016&B[0]))/3&2016|(2*(63488&B[1])+1*(63488&B[0]))/3&63488;for(let q=0;q<4;q++){const L=t[r+4+q];let C=(4*e+q)*S+4*o;z[C++]=B[3&L],z[C++]=B[L>>2&3],z[C++]=B[L>>4&3],z[C++]=B[L>>6&3]}}return z}(L,0,t.getImageWidth(q,S)+3&-4,t.getImageHeight(q,S)+3&-4)}return L}onmessage=b=>{if("init"===b.data.action){if(b.data.url)try{importScripts(b.data.url)}catch(O){postMessage({action:"error",error:O})}C||(C=BASIS({wasmBinary:b.data.wasmBinary})),null!==C&&C.then((t=>{BASIS=t,t.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===b.data.action){const C=b.data.config,O=b.data.imageData,i=new BASIS.BasisFile(O),h=function(t){const q=t.getHasAlpha(),S=t.getNumImages(),o=[];for(let B=0;B<S;B++){const q={levels:[]},S=t.getNumLevels(B);for(let o=0;o<S;o++){const S={width:t.getImageWidth(B,o),height:t.getImageHeight(B,o)};q.levels.push(S)}o.push(q)}return{Lj:q,images:o}}(i);let l=b.data.ignoreSupportedFormats?null:function(C,Z){let b=null;C.supportedCompressionFormats&&(b=C.supportedCompressionFormats.astc?r:C.supportedCompressionFormats.bc7?B:C.supportedCompressionFormats.s3tc?Z.Lj?o:S:C.supportedCompressionFormats.pvrtc?Z.Lj?L:z:C.supportedCompressionFormats.etc2?q:C.supportedCompressionFormats.etc1?t:e);return b}(b.data.config,h),I=!1;null===l&&(I=!0,l=h.Lj?o:S);let a=!0;i.startTranscoding()||(a=!1);const v=[];for(let t=0;t<h.images.length&&a;t++){const q=h.images[t];if(void 0===C.loadSingleImage||C.loadSingleImage===t){let S=q.levels.length;!1===C.loadMipmapLevels&&(S=1);for(let o=0;o<S;o++){const S=q.levels[o],B=Z(i,t,o,l,I);if(!B){a=!1;break}S.transcodedPixels=B,v.push(S.transcodedPixels.buffer)}}}i.close(),i.delete(),I&&(l=-1),a?postMessage({action:"transcode",success:a,id:b.data.id,fileInfo:h,format:l},v):postMessage({action:"transcode",success:a,id:b.data.id})}}}!function(t){t[t.cTFETC1=0]="cTFETC1",t[t.cTFETC2=1]="cTFETC2",t[t.cTFBC1=2]="cTFBC1",t[t.cTFBC3=3]="cTFBC3",t[t.cTFBC4=4]="cTFBC4",t[t.cTFBC5=5]="cTFBC5",t[t.cTFBC7=6]="cTFBC7",t[t.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",t[t.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",t[t.cTFASTC_4x4=10]="cTFASTC_4x4",t[t.cTFATC_RGB=11]="cTFATC_RGB",t[t.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",t[t.cTFRGBA32=13]="cTFRGBA32",t[t.cTFRGB565=14]="cTFRGB565",t[t.cTFBGR565=15]="cTFBGR565",t[t.cTFRGBA4444=16]="cTFRGBA4444",t[t.cTFFXT1_RGB=17]="cTFFXT1_RGB",t[t.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",t[t.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",t[t.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",t[t.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(o||(o={}));const e={JSModuleURL:`${B.f._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${B.f._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let C=null,Z=null,b=0;const O=async()=>(C||(C=new Promise(((t,q)=>{Z?t(Z):B.f.LoadFileAsync(B.f.GetBabylonScriptURL(e.WasmModuleURL)).then((S=>{if("function"!==typeof URL)return q("Basis transcoder requires an environment with a URL constructor");const o=URL.createObjectURL(new Blob([`(${r})()`],{type:"application/javascript"}));Z=new Worker(o),async function(t,q,S){return await new Promise(((o,z)=>{const L=q=>{"init"===q.data.action?(t.removeEventListener("message",L),o(t)):"error"===q.data.action&&z(q.data.error||"error initializing worker")};t.addEventListener("message",L),t.postMessage({action:"init",url:S?B.f.GetBabylonScriptURL(S):void 0,wasmBinary:q},[q])}))}(Z,S,e.JSModuleURL).then(t,q)})).catch(q)}))),await C),i=async(t,q)=>{const S=t instanceof ArrayBuffer?new Uint8Array(t):t;return await new Promise(((t,o)=>{O().then((()=>{const B=b++,z=q=>{"transcode"===q.data.action&&q.data.id===B&&(Z.removeEventListener("message",z),q.data.success?t(q.data):o("Transcode is not supported on this device"))};Z.addEventListener("message",z);const L=new Uint8Array(S.byteLength);L.set(new Uint8Array(S.buffer,S.byteOffset,S.byteLength)),Z.postMessage({action:"transcode",id:B,imageData:L,config:q,ignoreSupportedFormats:false},[L.buffer])}),(t=>{o(t)}))}))},h=(t,q)=>{var S;let o=null===(S=q._gl)||void 0===S?void 0:S.TEXTURE_2D;var B;t.isCube&&(o=null===(B=q._gl)||void 0===B?void 0:B.TEXTURE_CUBE_MAP);q._bindTextureDirectly(o,t,!0)},l=(t,q)=>{const S=t.getEngine();for(let r=0;r<q.fileInfo.images.length;r++){const e=q.fileInfo.images[r].levels[0];if(t._invertVScale=t.invertY,-1===q.format||q.format===o.cTFRGB565)if(t.type=10,t.format=4,!S._features.basisNeedsPOT||Math.log2(e.width)%1===0&&Math.log2(e.height)%1===0)t._invertVScale=!t.invertY,t.width=e.width+3&-4,t.height=e.height+3&-4,t.samplingMode=2,h(t,S),S._uploadDataToTextureDirectly(t,new Uint16Array(e.transcodedPixels.buffer),r,0,4,!0);else{const q=new L.b(S,2);t._invertVScale=t.invertY,q.type=10,q.format=4,q.width=e.width+3&-4,q.height=e.height+3&-4,h(q,S),S._uploadDataToTextureDirectly(q,new Uint16Array(e.transcodedPixels.buffer),r,0,4,!0),S._rescaleTexture(q,t,S.scenes[0],S._getInternalFormat(4),(()=>{S._releaseTexture(q),h(t,S)}))}else{t.width=e.width,t.height=e.height,t.generateMipMaps=q.fileInfo.images[r].levels.length>1;const o=I.GetInternalFormatFromBasisFormat(q.format,S);t.format=o,h(t,S);const L=q.fileInfo.images[r].levels;for(let q=0;q<L.length;q++){const B=L[q];S._uploadCompressedDataToTextureDirectly(t,o,B.width,B.height,B.transcodedPixels,r,q)}!S._features.basisNeedsPOT||Math.log2(t.width)%1===0&&Math.log2(t.height)%1===0||(B.f.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),t._cachedWrapU=z.b.CLAMP_ADDRESSMODE,t._cachedWrapV=z.b.CLAMP_ADDRESSMODE)}}},I={JSModuleURL:e.JSModuleURL,WasmModuleURL:e.WasmModuleURL,GetInternalFormatFromBasisFormat:(t,q)=>{let S;switch(t){case o.cTFETC1:S=36196;break;case o.cTFBC1:S=33776;break;case o.cTFBC4:S=33779;break;case o.cTFASTC_4x4:S=37808;break;case o.cTFETC2:S=37496;break;case o.cTFBC7:S=36492}if(void 0===S)throw"The chosen Basis transcoder format is not currently supported";return S},TranscodeAsync:i,LoadTextureFromTranscodeResult:l};Object.defineProperty(I,"JSModuleURL",{get:function(){return e.JSModuleURL},set:function(t){e.JSModuleURL=t}}),Object.defineProperty(I,"WasmModuleURL",{get:function(){return e.WasmModuleURL},set:function(t){e.WasmModuleURL=t}});class a{constructor(){this.supportCascades=!1}loadCubeData(t,q,S,o,z){if(Array.isArray(t))return;const L=q.getEngine().getCaps(),r={supportedCompressionFormats:{etc1:!!L.etc1,s3tc:!!L.s3tc,pvrtc:!!L.pvrtc,etc2:!!L.etc2,astc:!!L.astc,bc7:!!L.bptc}};i(t,r).then((t=>{const S=t.fileInfo.images[0].levels.length>1&&q.generateMipMaps;l(q,t),q.getEngine()._setCubeMapTextureParams(q,S),q.isReady=!0,q.onLoadedObservable.notifyObservers(q),q.onLoadedObservable.clear(),o&&o()})).catch((t=>{B.f.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),q.isReady=!0,z&&z(t)}))}loadData(t,q,S){const o=q.getEngine().getCaps(),z={supportedCompressionFormats:{etc1:!!o.etc1,s3tc:!!o.s3tc,pvrtc:!!o.pvrtc,etc2:!!o.etc2,astc:!!o.astc,bc7:!!o.bptc}};i(t,z).then((t=>{const o=t.fileInfo.images[0].levels[0],B=t.fileInfo.images[0].levels.length>1&&q.generateMipMaps;S(o.width,o.height,B,-1!==t.format,(()=>{l(q,t)}))})).catch((t=>{B.f.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),B.f.Warn(`Failed to transcode Basis file: ${t}`),S(0,0,!1,!1,(()=>{}),!0)}))}}}}]);