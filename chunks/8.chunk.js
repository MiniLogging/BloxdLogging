"use strict";(self.webpackChunkbloxd=self.webpackChunkbloxd||[]).push([[8],{2169:(c,b,A)=>{A.r(b),A.d(b,{_BasisTextureLoader:()=>y});var o,t=A(525),n=A(2070),h=A(615);function s(){const c=0,b=1,A=2,o=3,t=6,n=8,h=9,s=10,L=14;let C=null;function J(c,b,A,o,t){const n=c.getImageTranscodedSizeInBytes(b,A,o);let h=new Uint8Array(n);if(!c.transcodeImage(h,b,A,o,1,0))return null;if(t){h=function(c,b,A,o){const t=new Uint16Array(4),n=new Uint16Array(A*o),h=A/4,s=o/4;for(let L=0;L<s;L++)for(let o=0;o<h;o++){const s=b+8*(L*h+o);t[0]=c[s]|c[s+1]<<8,t[1]=c[s+2]|c[s+3]<<8,t[2]=(2*(31&t[0])+1*(31&t[1]))/3|(2*(2016&t[0])+1*(2016&t[1]))/3&2016|(2*(63488&t[0])+1*(63488&t[1]))/3&63488,t[3]=(2*(31&t[1])+1*(31&t[0]))/3|(2*(2016&t[1])+1*(2016&t[0]))/3&2016|(2*(63488&t[1])+1*(63488&t[0]))/3&63488;for(let b=0;b<4;b++){const h=c[s+4+b];let C=(4*L+b)*A+4*o;n[C++]=t[3&h],n[C++]=t[h>>2&3],n[C++]=t[h>>4&3],n[C++]=t[h>>6&3]}}return n}(h,0,c.getImageWidth(b,A)+3&-4,c.getImageHeight(b,A)+3&-4)}return h}onmessage=X=>{if("init"===X.data.action){if(X.data.url)try{importScripts(X.data.url)}catch(R){postMessage({action:"error",error:R})}C||(C=BASIS({wasmBinary:X.data.wasmBinary})),null!==C&&C.then((c=>{BASIS=c,c.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===X.data.action){const C=X.data.config,R=X.data.imageData,N=new BASIS.BasisFile(R),k=function(c){const b=c.getHasAlpha(),A=c.getNumImages(),o=[];for(let t=0;t<A;t++){const b={levels:[]},A=c.getNumLevels(t);for(let o=0;o<A;o++){const A={width:c.getImageWidth(t,o),height:c.getImageHeight(t,o)};b.levels.push(A)}o.push(b)}return{pi:b,images:o}}(N);let E=X.data.ignoreSupportedFormats?null:function(C,J){let X=null;C.supportedCompressionFormats&&(X=C.supportedCompressionFormats.astc?s:C.supportedCompressionFormats.bc7?t:C.supportedCompressionFormats.s3tc?J.pi?o:A:C.supportedCompressionFormats.pvrtc?J.pi?h:n:C.supportedCompressionFormats.etc2?b:C.supportedCompressionFormats.etc1?c:L);return X}(X.data.config,k),V=!1;null===E&&(V=!0,E=k.pi?o:A);let y=!0;N.startTranscoding()||(y=!1);const j=[];for(let c=0;c<k.images.length&&y;c++){const b=k.images[c];if(void 0===C.loadSingleImage||C.loadSingleImage===c){let A=b.levels.length;!1===C.loadMipmapLevels&&(A=1);for(let o=0;o<A;o++){const A=b.levels[o],t=J(N,c,o,E,V);if(!t){y=!1;break}A.transcodedPixels=t,j.push(A.transcodedPixels.buffer)}}}N.close(),N.delete(),V&&(E=-1),y?postMessage({action:"transcode",success:y,id:X.data.id,fileInfo:k,format:E},j):postMessage({action:"transcode",success:y,id:X.data.id})}}}!function(c){c[c.cTFETC1=0]="cTFETC1",c[c.cTFETC2=1]="cTFETC2",c[c.cTFBC1=2]="cTFBC1",c[c.cTFBC3=3]="cTFBC3",c[c.cTFBC4=4]="cTFBC4",c[c.cTFBC5=5]="cTFBC5",c[c.cTFBC7=6]="cTFBC7",c[c.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",c[c.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",c[c.cTFASTC_4x4=10]="cTFASTC_4x4",c[c.cTFATC_RGB=11]="cTFATC_RGB",c[c.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",c[c.cTFRGBA32=13]="cTFRGBA32",c[c.cTFRGB565=14]="cTFRGB565",c[c.cTFBGR565=15]="cTFBGR565",c[c.cTFRGBA4444=16]="cTFRGBA4444",c[c.cTFFXT1_RGB=17]="cTFFXT1_RGB",c[c.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",c[c.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",c[c.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",c[c.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(o||(o={}));const L={JSModuleURL:`${t.d._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${t.d._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let C=null,J=null,X=0;const R=async()=>(C||(C=new Promise(((c,b)=>{J?c(J):t.d.LoadFileAsync(t.d.GetBabylonScriptURL(L.WasmModuleURL)).then((A=>{if("function"!==typeof URL)return b("Basis transcoder requires an environment with a URL constructor");const o=URL.createObjectURL(new Blob([`(${s})()`],{type:"application/javascript"}));J=new Worker(o),async function(c,b,A){return await new Promise(((o,n)=>{const h=b=>{"init"===b.data.action?(c.removeEventListener("message",h),o(c)):"error"===b.data.action&&n(b.data.error||"error initializing worker")};c.addEventListener("message",h),c.postMessage({action:"init",url:A?t.d.GetBabylonScriptURL(A):void 0,wasmBinary:b},[b])}))}(J,A,L.JSModuleURL).then(c,b)})).catch(b)}))),await C),N=async(c,b)=>{const A=c instanceof ArrayBuffer?new Uint8Array(c):c;return await new Promise(((c,o)=>{R().then((()=>{const t=X++,n=b=>{"transcode"===b.data.action&&b.data.id===t&&(J.removeEventListener("message",n),b.data.success?c(b.data):o("Transcode is not supported on this device"))};J.addEventListener("message",n);const h=new Uint8Array(A.byteLength);h.set(new Uint8Array(A.buffer,A.byteOffset,A.byteLength)),J.postMessage({action:"transcode",id:t,imageData:h,config:b,ignoreSupportedFormats:false},[h.buffer])}),(c=>{o(c)}))}))},k=(c,b)=>{var A;let o=null===(A=b._gl)||void 0===A?void 0:A.TEXTURE_2D;var t;c.isCube&&(o=null===(t=b._gl)||void 0===t?void 0:t.TEXTURE_CUBE_MAP);b._bindTextureDirectly(o,c,!0)},E=(c,b)=>{const A=c.getEngine();for(let s=0;s<b.fileInfo.images.length;s++){const L=b.fileInfo.images[s].levels[0];if(c._invertVScale=c.invertY,-1===b.format||b.format===o.cTFRGB565)if(c.type=10,c.format=4,!A._features.basisNeedsPOT||Math.log2(L.width)%1===0&&Math.log2(L.height)%1===0)c._invertVScale=!c.invertY,c.width=L.width+3&-4,c.height=L.height+3&-4,c.samplingMode=2,k(c,A),A._uploadDataToTextureDirectly(c,new Uint16Array(L.transcodedPixels.buffer),s,0,4,!0);else{const b=new h.c(A,2);c._invertVScale=c.invertY,b.type=10,b.format=4,b.width=L.width+3&-4,b.height=L.height+3&-4,k(b,A),A._uploadDataToTextureDirectly(b,new Uint16Array(L.transcodedPixels.buffer),s,0,4,!0),A._rescaleTexture(b,c,A.scenes[0],A._getInternalFormat(4),(()=>{A._releaseTexture(b),k(c,A)}))}else{c.width=L.width,c.height=L.height,c.generateMipMaps=b.fileInfo.images[s].levels.length>1;const o=V.GetInternalFormatFromBasisFormat(b.format,A);c.format=o,k(c,A);const h=b.fileInfo.images[s].levels;for(let b=0;b<h.length;b++){const t=h[b];A._uploadCompressedDataToTextureDirectly(c,o,t.width,t.height,t.transcodedPixels,s,b)}!A._features.basisNeedsPOT||Math.log2(c.width)%1===0&&Math.log2(c.height)%1===0||(t.d.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),c._cachedWrapU=n.d.CLAMP_ADDRESSMODE,c._cachedWrapV=n.d.CLAMP_ADDRESSMODE)}}},V={JSModuleURL:L.JSModuleURL,WasmModuleURL:L.WasmModuleURL,GetInternalFormatFromBasisFormat:(c,b)=>{let A;switch(c){case o.cTFETC1:A=36196;break;case o.cTFBC1:A=33776;break;case o.cTFBC4:A=33779;break;case o.cTFASTC_4x4:A=37808;break;case o.cTFETC2:A=37496;break;case o.cTFBC7:A=36492}if(void 0===A)throw"The chosen Basis transcoder format is not currently supported";return A},TranscodeAsync:N,LoadTextureFromTranscodeResult:E};Object.defineProperty(V,"JSModuleURL",{get:function(){return L.JSModuleURL},set:function(c){L.JSModuleURL=c}}),Object.defineProperty(V,"WasmModuleURL",{get:function(){return L.WasmModuleURL},set:function(c){L.WasmModuleURL=c}});class y{constructor(){this.supportCascades=!1}loadCubeData(c,b,A,o,n){if(Array.isArray(c))return;const h=b.getEngine().getCaps(),s={supportedCompressionFormats:{etc1:!!h.etc1,s3tc:!!h.s3tc,pvrtc:!!h.pvrtc,etc2:!!h.etc2,astc:!!h.astc,bc7:!!h.bptc}};N(c,s).then((c=>{const A=c.fileInfo.images[0].levels.length>1&&b.generateMipMaps;E(b,c),b.getEngine()._setCubeMapTextureParams(b,A),b.isReady=!0,b.onLoadedObservable.notifyObservers(b),b.onLoadedObservable.clear(),o&&o()})).catch((c=>{t.d.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),b.isReady=!0,n&&n(c)}))}loadData(c,b,A){const o=b.getEngine().getCaps(),n={supportedCompressionFormats:{etc1:!!o.etc1,s3tc:!!o.s3tc,pvrtc:!!o.pvrtc,etc2:!!o.etc2,astc:!!o.astc,bc7:!!o.bptc}};N(c,n).then((c=>{const o=c.fileInfo.images[0].levels[0],t=c.fileInfo.images[0].levels.length>1&&b.generateMipMaps;A(o.width,o.height,t,-1!==c.format,(()=>{E(b,c)}))})).catch((c=>{t.d.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),t.d.Warn(`Failed to transcode Basis file: ${c}`),A(0,0,!1,!1,(()=>{}),!0)}))}}}}]);